(lp0
((dp1
S'text'
p2
(lp3
VAdd a new class to your project and paste the code shown below
p4
aVCompile
p5
aVDrop the new control from the top of the toolbox onto your form
p6
aVIt's not quite perfect but ought to work for you
p7
as(dp8
S'author'
p9
V17034
p10
stp11
a((dp12
g2
(lp13
VSome sample code:
p14
as(dp15
g9
V17034
p16
stp17
a((dp18
g2
(lp19
VThe MenuStrip class has a Renderer property
p20
aVYou can assign your own ToolStripRenderer derived class to customize the painting
p21
aVIt's a fair amount of work
p22
as(dp23
g9
V17034
p24
stp25
a((dp26
g2
(lp27
VDid you deploy the CRT libraries on the target machine
p28
aVLong shot: since you have a dependency on 32-bit code, you should set Target Platform in the Build property tab to x86
p29
aVEDIT: trouble-shoot side-by-side resolving problems with the Sxstrace
p30
aVexe utility, available on Vista
p31
as(dp32
g9
V17034
p33
stp34
a((dp35
g2
(lp36
VYou can do this with a standard ListView control by implementing drag-and-drop
p37
aVHere's a sample control that does this:
p38
as(dp39
g9
V17034
p40
stp41
a((dp42
g2
(lp43
VYou forgot to start a message loop, calling Application
p44
aVRun() is required
p45
aVWithout a message loop, the BackgroundWorker events cannot work
p46
aVTo fix:
p47
aVCall DoSomeWork() in the form's constructor or it's Load event
p48
as(dp49
g9
V17034
p50
stp51
a((dp52
g2
(lp53
VDeclaring the array argument with "ref" is required
p54
aVYour 2nd attempt should have worked just fine, perhaps you forgot to regenerate the
p55
aVtlb
p56
aVTested code:
p57
as(dp58
g9
V17034
p59
stp60
a((dp61
g2
(lp62
VMessageBox uses a plain window that can be messed with like any other window
p63
aVThis has been possible in Windows for a very long time, well over 20 years already
p64
aVThe techniques are getting obscure though, too many friendly class wrappers that hide the native winapi and don't expose everything you can do with it
p65
aVSo much so that programmers now automatically assume that this isn't possible, as you can tell from the upvoted answers
p66
aVIt is the kind of programming that Petzold taught us in his seminal "Programming Windows" book
p67
aVReplacing MessageBox with a custom Form or Window is actually fairly hard to do, it does non-trivial automatic layout to fit the text and supports localization without help
p68
aVAlthough that's exactly what you don't seem to like :)
p69
aVAnyhoo, the message box window is easy to find back
p70
aVIt is owned by the UI thread and has a special class name that makes it unique
p71
aVEnumThreadWindows() enumerates the windows owned by a thread, GetClassName() lets you check the kind of window
p72
aVThen just poke the text into the button with SetWindowText()
p73
aVAdd a new class to your project and paste the code shown below
p74
aVInvoke it with code like this:
p75
aVHere's the code:
p76
as(dp77
g9
V17034
p78
stp79
a((dp80
g2
(lp81
VReflection can break the accessibility rulez
p82
aVYou will void the warranty, a
p83
aVNET update can easily break your code
p84
aVTry this:
p85
as(dp86
g9
V17034
p87
stp88
a((dp89
g2
(lp90
VUnless you're doing something very special, it doesn't make sense to force the WB to repaint itself
p91
aVSince it is its own control and has its own Handle, it is quite capable of repainting itself whenever it deems necessary
p92
aVSince you are forcing it to repaint at a moment that's completely out of sync with its ReadyState, getting an "old" url is to be expected
p93
as(dp94
g9
V17034
p95
stp96
a((dp97
g2
(lp98
VSadly, that toxic bit of syntactic sugar was added to VB8 (VS2005)
p99
aVNow fatally confusing VB
p100
aVNET programmers when they can't comprehend that each thread has a separate instance of "Form1"
p101
aVThe good news: now you definitely don't need DefInstance anymore
p102
as(dp103
g9
V17034
p104
stp105
a((dp106
g2
(lp107
VOh, it's easy to see
p108
aVCopy and paste 50 buttons in a form both in WF and in VB6 and compare their paint speed side by side
p109
aVIt is not
p110
aVNET being slow, it is WF being slow
p111
aVI never really nailed it down but contributing factors:
p112
aVThe Button class paints really slow
p113
aVIt asks the container to paint the background for transparency it doesn't have
p114
aVVB6 has several windowless controls, like Label
p115
aVIn WF every control is a window
p116
aVVisual Styles don't come for free
p117
aVThey worked really hard on making VB1 work well on a 386SUX
p118
as(dp119
g9
V17034
p120
stp121
a((dp122
g2
(lp123
VHmya, this is not a
p124
aVNET framework problem
p125
aVThe linked KB article could have been a bit more explicit: "you're using a loaded gun, this is what happens when you aim it at your foot"
p126
aVThe bullets in that gun are
p127
aVNET giving you the ability to start as many asynchronous I/O requests as you dare
p128
aVIt will do what you ask it to do, until you hit some kind of resource limit
p129
aVIn this case, probably, having too many pinned receive buffers in the generation 0 heap
p130
aVResource management is still very much our job, not
p131
aVNET's
p132
aVIt is no different from allocating memory without bound
p133
aVSolving this particular problem requires you to put a limit on the number of uncompleted BeginGetResponse() requests
p134
aVHaving hundreds of them make little sense, every one of them has to squeeze through the Intertube one at a time
p135
aVAdding another request will just cause it to take longer to complete
p136
aVOr crash your program
p137
as(dp138
g9
V17034
p139
stp140
a((dp141
g2
(lp142
VIt doesn't really matter much
p143
aVNET 2
p144
aV0, 3
p145
aV0 and 3
p146
aV5 all use the exact same CLR and base classes
p147
aVEach version just adds a set of new assemblies
p148
aVFor GUI development, you're fine with 2
p149
aV0 if you use Windows Forms, you'll need 3
p150
aV0 for WPF
p151
aVSince they are otherwise essentially identical, there is no good reason to not just install 3
p152
aV5 SP1
p153
as(dp154
g9
V17034
p155
stp156
a((dp157
g2
(lp158
VThe essential difference between
p159
aVNET Generics and C++ Templates is that generics are specialized at runtime
p160
aVTemplates are expanded at compile time
p161
aVThe dynamic behavior of generics makes things like Linq, expression trees, Type
p162
aVMakeGenericType(), language independence and code re-use possible
p163
aVBut there is a price, you can't for example use operators on values of the generic type argument
p164
aVYou can't write a std::complex class in C#
p165
aVAnd no compile-time metaprogramming
p166
as(dp167
g9
V17034
p168
stp169
a((dp170
g2
(lp171
VWell, it should hit the if() statement 6 times, the comboBox1
p172
aVItems
p173
aVAdd() statement 3 times
p174
aVThe logical explanation is that the real problem is located in the code that writes the registry keys
p175
aVRun Regedit
p176
aVexe to find out what is really stored in these registry key values
p177
as(dp178
g9
V17034
p179
stp180
a((dp181
g2
(lp182
VIt is protected because DGV inherits the property from Control
p183
aVAnd Control
p184
aVDoubleBuffered is protected
p185
aVWhich makes sense because each derived control should decide for itself to turn that on
p186
aVAnd it doesn't make sense for the control user to arbitrarily turn it on or off
p187
aVThe DGV designers decided for off
p188
aVOne reason they might have decided that is that double buffering actually makes painting slower
p189
aVThe extra step to render the buffer bitmap costs time
p190
aVIt just looks faster to the human eye, you observe the bitmap suddenly appearing
p191
aVYou can't see the time it takes to draw into the bitmap
p192
aVUnless other controls need to be painted and they get their turn after the DGV, then it is quite visible
p193
aVWhat you see is the form getting drawn first, with holes where the controls go
p194
aVThose holes have a white background
p195
aVBlack when you use the TransparencyKey or Opacity property
p196
aVEach control then gets the Paint event and the holes are filled one-by-one
p197
aVThat effect is perceived as flicker too by the user, although it is a different kind of flicker from the one that DoubleBuffered solves
p198
aVIt is especially noticeable when the background is black
p199
aVWhat's needed to solve this problem is that the entire form, with all its controls, is double-buffered
p200
aVThat's not available in Windows Forms
p201
aVHowever, Windows XP and later actually support this
p202
aVCheck this thread to see how that's done
p203
aVBeware that it can have side-effects as documented in that thread
p204
as(dp205
g9
V17034
p206
stp207
a((dp208
g2
(lp209
VIt's easy
p210
aVJust add a MenuStrip to the parent but leave it empty
p211
aVThe built-in support for menu merging ensures that the active child's menu appears in the empty parent strip
p212
as(dp213
g9
V17034
p214
stp215
a((dp216
g2
(lp217
VI can repro this partially
p218
aVDon't call the child's Show() method in the constructor, do it in the parent's Load event handler
p219
aVNot so sure about the off-kilter min/max/close icons
p220
as(dp221
g9
V17034
p222
stp223
a((dp224
g2
(lp225
VThis stuff is easy to find out by yourself
p226
aVRun Perfmon
p227
aVexe and add a counter for
p228
aVNET Memory + Gen 0 Collections
p229
aVRun the test code a million times
p230
aVYou'll see that option #1 requires half of the number of collections option #2 needs
p231
as(dp232
g9
V17034
p233
stp234
a((dp235
g2
(lp236
VRepeatedly trying TryParse() doesn't make sense, you have a field already declared
p237
aVYou can't change your mind unless you make that field of type Object
p238
aVNot a good idea
p239
aVWhatever data the field represents has a physical meaning
p240
aVIt's an age, a size, a count, etc
p241
aVPhysical quantities have realistic restraints on their range
p242
aVPick the int type that can store that range
p243
aVDon't try to fix an overflow, it would be a bug
p244
as(dp245
g9
V17034
p246
stp247
a((dp248
g2
(lp249
VThe standard approach is to inject a DLL into the process with SetWindowsHookEx, hooking WH_CALLWNDPROC to monitor the WM_NCPAINT message
p250
aVThat used to work pretty well but no more
p251
aVVisual Styles and Vista UAC will make you grow a pretty long beard
p252
aVCommon in the Windows 3
p253
aVx days, I haven't seen this done in quite a while
p254
as(dp255
g9
V17034
p256
stp257
a((dp258
g2
(lp259
VYou get info like this from WMI
p260
aVDownload WMICodeCreator to find the query as well as the code you need to write
p261
aVBeware that hardware queries like this tend to rely heavily on providers supplied by the hardware or BIOS manufacturer
p262
as(dp263
g9
V17034
p264
stp265
a((dp266
g2
(lp267
VYou can't
p268
aVIt isn't hard to get the window handle for the system tray, GetClassName() returns "ToolbarWindow32", the class name of the standard TOOLBAR common control
p269
aVBeware that a 64-bit OS has two of them
p270
aVThen you can send messages to it like TB_GETBUTTONINFO
p271
aVChief hang-ups are that you won't know what button ID to choose and the returned info does not include the button position
p272
aVWhich is for the better, buttons move around without you being able to lock them
p273
as(dp274
g9
V17034
p275
stp276
a((dp277
g2
(lp278
VNET 3
p279
aV5 SP1 gets its improved startup perf by no longer verifying the strong name of assemblies that come from trusted locations
p280
aVA bit controversial in my book but somewhat defensible
p281
aVI did check if the 64-bit version of the CLR also bypasses that time-consuming step
p282
aVSigned a DLL, put it in the GAC, then patched a byte
p283
aVNo complaints when loading the assembly
p284
aVSo it is not the SP1 startup pref improvement that explains the difference
p285
aVOther factors in the startup time are:
p286
aV- Loading the CLR from disk (coldstart only)
p287
aV- Groveling for the dependent assemblies
p288
aV- JIT compiling the startup code
p289
aVColdstart could well be a factor, you probably don't have other processes running that have the 64-bit version of the CLR loaded
p290
aVEasy to eliminate by running a dummy
p291
aVNET app while you do the test
p292
aVGroveling assemblies could take longer for the same reason
p293
aVIt is unlikely that the 64-bit ngen-ed images of the
p294
aVNET assemblies are in the file system cache
p295
aVAgain, easy to eliminate with the dummy app having a dependency on the same assemblies
p296
aVThe 64-bit JITter is a tougher nut to crack
p297
aVAn arbitrary call is to assume that MSFT didn't spend as much time making that one performant as the 32-bit JITter
p298
aVNothing backed-up by any evidence though
p299
aVDifficult to measure too, you'd have load an assembly with Assembly
p300
aVLoad, then time Activator
p301
aVCreateInstance() where the class constructor calls as much code as possible
p302
as(dp303
g9
V17034
p304
stp305
a((dp306
g2
(lp307
VI really liked Ascend
p308
aVNET
p309
aVWell documented, excellent designer support, source code included
p310
as(dp311
g9
V17034
p312
stp313
a((dp314
g2
(lp315
VGDI+ doesn't support OpenType, only TrueType
p316
as(dp317
g9
V17034
p318
stp319
a((dp320
g2
(lp321
VI think it is a threading problem too
p322
aVAre you using Control
p323
aVInvoke() in your event handler
p324
aVNET usually catches violations when you debug the app but there are cases it can't
p325
aVNotifyIcon is one of them, there is no window handle to check thread affinity
p326
aVEdit after OP changed question:
p327
aVA classic VB
p328
aVNET trap is to reference a Form instance by its type name
p329
aVLike Form1
p330
aVNotifyIcon1
p331
aVSomething
p332
aVThat doesn't work as expected when you use threading
p333
aVIt will create a new instance of the Form1 class, not use the existing instance
p334
aVThat instance isn't visible (Show() was never called) and is otherwise dead as a doornail since it is running on thread that doesn't pump a message loop
p335
aVSeeing a second icon appear is a dead give-away
p336
aVSo is getting InvokeRequired = False when you know you are using it from a thread
p337
aVYou must use a reference to the existing form instance
p338
aVIf that is hard to come by (you usually pass "Me" as an argument to the class constructor), you can use Application
p339
aVOpenForms:
p340
as(dp341
g9
V17034
p342
stp343
a((dp344
g2
(lp345
VCheck this thread
p346
aVRepeating the core of that answer, you can turn on the WS_EX_COMPOSITED style flag on the window to get both the form and all of its controls double-buffered
p347
aVThe style flag is available since XP
p348
aVIt doesn't make painting faster but the entire window is drawn in an off-screen buffer and blitted to the screen in one whack
p349
aVMaking it look instant to the user's eyes without visible painting artifacts
p350
aVIt is not entirely trouble-free, some visual styles renderers can glitch on it, particularly TabControl when its has too many tabs
p351
aVYMMV
p352
aVPaste this code into your form class:
p353
aVThe big difference between this technique and Winform's double-buffering support is that Winform's version only works on one control at at time
p354
aVYou will still see each individual control paint itself
p355
aVWhich can look like a flicker effect as well, particularly if the unpainted control rectangle contrasts badly with the window's background
p356
as(dp357
g9
V17034
p358
stp359
a((dp360
g2
(lp361
VThey are plumbing for the Windows Forms designer
p362
aVYou rarely have to implement them yourself, just derive your component class from Component
p363
aVStart worrying about them when you want to implement your own designer
p364
aVDoing so is even less documented
p365
as(dp366
g9
V17034
p367
stp368
a((dp369
g2
(lp370
VTry this:
p371
aVGetPixel() is slow, you can speed it up with an unsafe byte*
p372
as(dp373
g9
V17034
p374
stp375
a((dp376
g2
(lp377
VDepends on your definition of a leak
p378
aVUnbound memory increase is a leak in my book, a singleton isn't unbound
p379
aVIf you don't provide reference counting, you intentionally keep the instance alive
p380
aVNot an accident, not a leak
p381
aVYour singleton wrapper's destructor should delete the instance, it is not automatic
p382
aVIf it just allocates memory and no OS resources, there's no point
p383
as(dp384
g9
V17034
p385
stp386
a((dp387
g2
(lp388
VYou'll need to P/Invoke SetWindowsHookEx()
p389
aVThe only hook that will work in a
p390
aVNET app is WH_KEYBOARD_LL
p391
aVYou should get loads of hits on example code when you Google these keywords
p392
as(dp393
g9
V17034
p394
stp395
a((dp396
g2
(lp397
VTuff one
p398
aVThere's a snippet about it in the documentation for the ILockBytes interface
p399
aVIt says that the default implementations of IStorage and IStream implement IMarshal
p400
aVWhich would make them thread-safe, provided you follow COM threading rules
p401
aVThat's easy to forget when the interface pointers are in-proc
p402
aVYou'd have to use something like CoMarshalInterThreadInterfaceInStream() or IGlobalInterfaceTable
p403
aVYou'll get away with not marshaling by locking yourself
p404
as(dp405
g9
V17034
p406
stp407
a((dp408
g2
(lp409
VStream
p410
aVNo, Excel files are a complicated mess
p411
aVQuickbooks, yeah
p412
aVI found this ODBC driver, it should support OdbcDataAdapter
p413
as(dp414
g9
V17034
p415
stp416
a((dp417
g2
(lp418
VOh yeah, it's fat
p419
aVIt can be much more efficient than List<> though
p420
aVIt creates an index so lookups can be O(1)
p421
aVRows are stored in a red-black tree so inserts and deletes can be O(log n)
p422
aVAll these operations are O(n) for List<>
p423
aVTo get this kind of perf, you'll have to choose your columns and queries wisely though
p424
aVSame kind of considerations as a regular database table
p425
as(dp426
g9
V17034
p427
stp428
a((dp429
g2
(lp430
VFSW cannot work reliably, it is asynchronous
p431
aVAssuming you don't get an exception, StreamReader
p432
aVReadLine() will return null when the file got truncated
p433
aVThen check if the size changed
p434
aVBeware of the unavoidable race condition, you'll need to verify assumptions about timing
p435
as(dp436
g9
V17034
p437
stp438
a((dp439
g2
(lp440
V"Bunch of properties" and locking at the property getter and setter level looks wrong
p441
aVYour locking is much too fine-grained
p442
aVIn most typical object usage, you'd want to make sure that you acquired a lock to access more than one property at the same time
p443
aVYour specific case might be different but I kinda doubt it
p444
aVAnyway, acquiring the lock when you access the object instead of the property will significantly cut down on the amount of locking code you'll have to write
p445
as(dp446
g9
V17034
p447
stp448
a((dp449
g2
(lp450
VThe property getter and setter of an explicitly implemented interface property has an unusual attribute
p451
aVIt's IsFinal property is True, even when it is not a member of a sealed class
p452
aVTry this code to verify my assertion:
p453
as(dp454
g9
V17034
p455
stp456
a((dp457
g2
(lp458
VIs it really your intention to send that message back to the originator
p459
aVSending it back to yourself is very dangerous, you'll just bomb again, over and over
p460
as(dp461
g9
V17034
p462
stp463
a((dp464
g2
(lp465
VThe only reliable way I know of is a timer
p466
aVHere's sample code that tweaks the opacity on a roll-over:
p467
as(dp468
g9
V17034
p469
stp470
a((dp471
g2
(lp472
VThe best counter I know is Taskmgr
p473
aVexe
p474
aVView + Select Columns and check "User objects",  "Handle count" and "GDI Objects"
p475
aVThe generic diagnostic is that you're leaking handles and consumed 10,000 of them
p476
aVBeware of a handle leak bug in
p477
aVNET 2
p478
aV0 SP1 and
p479
aVNET 3
p480
aV5's Graphics
p481
aVCopyFromScreen(), fixed in 3
p482
aV5 SP1
p483
as(dp484
g9
V17034
p485
stp486
a((dp487
g2
(lp488
VDo it like this:
p489
as(dp490
g9
V17034
p491
stp492
a((dp493
g2
(lp494
VTool + Options, Project and Solutions, Build and Run, set "MSBuild project build output verbosity" to Detailed
p495
aVYou'll get a ton of diagnostics in the Output window
p496
aVFWIW, the error message you get is a simple "class not registered" error
p497
aVFix with Regsvr32
p498
aVexe
p499
as(dp500
g9
V17034
p501
stp502
a((dp503
g2
(lp504
VDo keep in mind that you don't need a stable sort if you compare all members
p505
aVThe 2
p506
aV0 solution, as requested, can look like this:
p507
aVDo note that this 2
p508
aV0 solution is still preferable over the popular 3
p509
aV5 Linq solution, it performs an in-place sort and does not have the O(n) storage requirement of the Linq approach
p510
aVUnless you prefer the original List object to be untouched of course
p511
as(dp512
g9
V17034
p513
stp514
a((dp515
g2
(lp516
VSeeing %InstallDir% in the error message might be a lead
p517
aVDo you have a Setup and Deployment project in your solution
p518
aVDoes it get build before your FooPDA project
p519
aVSeeing it looking in obj is fishy too
p520
aVOP Edit:  You were on the right track, so I'll credit you with the answer
p521
aVTurns out that when you do a rebuild, the Visual Studio 2005 compiler is pretty stupid in that it doesn't stop when it hits a project that it can't compile
p522
aVIt just keeps on compiling and throwing errors
p523
aVThis particular solution contains three projects
p524
aVWe'll call them FooPDA, PDAComponents and Setup
p525
aVI changed the icon on project FooPDA and the solution would no longer compile
p526
aVThe error I was concentrating on had nothing to do with the actual problem
p527
aVI should have concentrated on the error I saw when I did the initial build , which was:
p528
aVCVTRES: fatal error CVT1103: cannot read file
p529
aVI basically blew this off and immediately did a rebuild
p530
aVThat's when the error I posted came to the top of the error list and I was fixated upon it
p531
aVI should not have been
p532
aVThe error I originally posted was due to the fact that FooPDA was not compiling, so FooPDA
p533
aVexe was not available when it came time to compile the setup project
p534
aVThe reason FooPDA failed to compile when I changed the icon was due to the fact that the
p535
aVico file I was trying to add contained incompatible icon sizes and/or color depths
p536
aVApparently the compact framework (or the target platform, PocketPC 2003
p537
aVonly understands certain of these
p538
aVThe
p539
aVico file that I was trying to add had all sorts of sizes and color depths embedded within it (all the way up to 256x256 @32 bit)
p540
aVI looked at the
p541
aVico file that was originally there and it had just two 48x48 icons
p542
aVOne 24 bit color and one 8 bit
p543
aVI opened up my new
p544
aVico file in an icon editor and modified it to contain the same size and color depths as the original and all was right with the world again
p545
aVThe solution now compiles with the new icon, no problem
p546
aVOn the one hand, I feel kind of foolish for not figuring this out (I finally asked a coworker who had encountered this before)
p547
aVOn the other hand, what the f**k does "CVTRES: fatal error CVT1103: cannot read file" tell me
p548
aVNothing
p549
aVWhat's wrong with "Error: incompatible icon"
p550
as(dp551
g9
V17034
p552
stp553
a((dp554
g2
(lp555
VYou derived your class from Control
p556
aVA bit unusual, but if the control is actually hosted on a form, you can use Me
p557
aVInvoke() to marshal the call
p558
aVFor example:
p559
aVIf this class object is not actually hosted on a form, you'll need to pass a reference to the form so it can call Invoke():
p560
aVand use mHost
p561
aVInvoke()
p562
aVOr BeginInvoke()
p563
aVThe last trick in the book is to use your main startup form as the synchronization object
p564
aVThat's not completely safe but works in 99% of the case:
p565
aVBeware that there's a bug in WF that prevents OpenForms() from accurately tracking open forms when they get dynamically recreated
p566
as(dp567
g9
V17034
p568
stp569
a((dp570
g2
(lp571
VYeah, it's technically possible
p572
aVReflection is required because many of the members are private and internal
p573
aVStart a new Windows Forms project and add two buttons
p574
aVThen:
p575
aVIf this convinces you that Microsoft tried really hard to prevent your from doing this, you understood the code
p576
as(dp577
g9
V17034
p578
stp579
a((dp580
g2
(lp581
VUse Type
p582
aVGetGenericArguments()
p583
aVFor example:
p584
aVOutput:
p585
aVInt32
p586
as(dp587
g9
V17034
p588
stp589
a((dp590
g2
(lp591
VI can't think of any program that implements keyboard shortcuts on the KeyUp event
p592
aVThat standard was set a long time ago, with the Windows TranslateAccelerator() API function
p593
aVIt translates WM_KEYDOWN
p594
aVWindows Forms implements the same behavior with ProcessCmdKey()
p595
aVSounds like you found a doozy
p596
aVDoes it handle Alt+F4 correctly
p597
as(dp598
g9
V17034
p599
stp600
a((dp601
g2
(lp602
VI had to pull some pretty crazy stunts to make this work
p603
aVUnfortunately, MSFT didn't update the VisualStyleElement
p604
aVProgressBar class to add the parts that Vista added
p605
aVAnd the constructor is private
p606
aVAnd I had to guess a bit at the parts that produce the animation
p607
aVI got fairly close with this code, it should give you something to experiment with:
p608
as(dp609
g9
V17034
p610
stp611
a((dp612
g2
(lp613
VYes, the current time zone is cached
p614
aVFor a good reason, it avoids trouble with broken code that uses DateTime
p615
aVNow to implement elapsed time measurement
p616
aVSuch code tends to suffer a heart-attack when the time suddenly changes by an hour or more
p617
aVYou will have to call System
p618
aVGlobalization
p619
aVCultureInfo
p620
aVClearCachedData() to reset the cached value
p621
aVThe next call to DateTime
p622
aVNow will now give the new local time
p623
aVIf you use the
p624
aVNET 3
p625
aV5 TimeZoneInfo class at all then you'll also need to call its ClearCachedData() method
p626
aVYou can use the SystemEvents
p627
aVTimeChanged event as a trigger
p628
as(dp629
g9
V17034
p630
stp631
a((dp632
g2
(lp633
VNot so sure this is a good approach
p634
aVThis only works if the child process is created with the CREATE_NEW_PROCESS_GROUP flag for CreateProcess()
p635
aVThe System
p636
aVDiagnostics
p637
aVProcess class doesn't support this
p638
aVConsider using the return value from the Main() method
p639
aVThere is already a unique value defined in the Windows SDK for Ctrl+C aborts, STATUS_CONTROL_C_EXIT or 0xC000013A
p640
aVThe parent process can get that return code with Process
p641
aVExitCode
p642
as(dp643
g9
V17034
p644
stp645
a((dp646
g2
(lp647
VYes, it uses the font returned by GetStockObject(DEFAULT_GUI_FONT)
p648
aVWhich is MS Sans Serif
p649
aVAn old font, long gone from most machines
p650
aVThe font mapper translate it to, no surprise, Microsoft Sans Serif
p651
aVThere is no documented procedure I know of to change that default font, the SDK docs mention MS Sans Serif explicitly
p652
aVIf you want Segoe, you'll have to ask for it
p653
aVWhich isn't that safe to do, there are still a lot of XP machines out there without Office 2007
p654
aVThe font mapper will translate it on a machine that doesn't have Segoe available
p655
aVNot sure what pops out, I don't have such a machine left anymore
p656
as(dp657
g9
V17034
p658
stp659
a((dp660
g2
(lp661
VAdd a new class to your project and paste the code shown below
p662
aVBuild
p663
aVDrop the new control from the top of the toolbox onto your form
p664
aVVisual styles of the child controls are preserved
p665
as(dp666
g9
V17034
p667
stp668
a((dp669
g2
(lp670
VYou could use the Tag property
p671
aVThese little helper functions take care of it:
p672
as(dp673
g9
V17034
p674
stp675
a((dp676
g2
(lp677
VWindows sends the window that contains the mouse cursor the WM_SETCURSOR message, giving it an opportunity to change the cursor shape
p678
aVA control like TextBox takes advantage of that, changing the cursor into a I-bar
p679
aVThe Control
p680
aVCursor property determines what shape will be used
p681
aVThe Cursor
p682
aVCurrent property changes the shape directly, without waiting for a WM_SETCURSOR response
p683
aVIn most cases, that shape is unlikely to survive for long
p684
aVAs soon as the user moves the mouse, WM_SETCURSOR changes it back to Control
p685
aVCursor
p686
aVThe UseWaitCursor property was added in
p687
aVNET 2
p688
aV0 to make it easier to display an hourglass
p689
aVUnfortunately, it doesn't work very well
p690
aVIt requires a WM_SETCURSOR message to change the shape and that won't happen when you set the property to true and then do something that takes a while
p691
aVTry this code for example:
p692
aVThe cursor never changes
p693
aVTo whack that into shape, you'll need to use Cursor
p694
aVCurrent as well
p695
aVHere is a little helper class to make it easy:
p696
aVAnd use it like this:
p697
as(dp698
g9
V17034
p699
stp700
a((dp701
g2
(lp702
VBe sure you made your column type nchar, nvarchar or ntext
p703
aVSo you can store Unicode
p704
aVIt is all rather well described here
p705
as(dp706
g9
V17034
p707
stp708
a((dp709
g2
(lp710
VDo it the other way around
p711
aVChange the font size, the controls will automatically scale to accommodate the larger font
p712
aVFor example:
p713
as(dp714
g9
V17034
p715
stp716
a((dp717
g2
(lp718
VThere's little point in testing the strong name after the assembly got loaded
p719
aVAn attacker could simply inject a module constructor in the assembly and execute any code desired
p720
aVThe
p721
aVNET 3
p722
aV5 SP1 version of the framework followed suit and is no longer verifying the strong name of assemblies that get loaded from trusted locations
p723
aVStartup times improve by about 40%
p724
aVThe key point is: once an attacker compromises the machine to a point where he is able to inject an assembly in the probing path of your application, he won't bother doing it the hard way
p725
aVHe'd just replace your EXE file
p726
as(dp727
g9
V17034
p728
stp729
a((dp730
g2
(lp731
VClick on the lightning bolt icon in the Properties window
p732
aVDouble-click the event you want to implement
p733
as(dp734
g9
V17034
p735
stp736
a((dp737
g2
(lp738
VYou'll have to give up on using the Form
p739
aVTransparencyKey property if you want to avoid the ugly uninitialized black video overlay flicker
p740
aVIt doesn't do anything useful in your sample program
p741
as(dp742
g9
V17034
p743
stp744
a((dp745
g2
(lp746
VThat's what ISupportInitialize is for
p747
aVJust inherit this interface, the designer will automatically call your control's BeginInit() and EndInit() methods
p748
aVDon't use the assigned property values until EndInit()
p749
as(dp750
g9
V17034
p751
stp752
a((dp753
g2
(lp754
VYes, the ListBox has its own window handle and Paint event
p755
aVYou cannot paint on top of the LB
p756
aVNor would you want to, normally, it will obscure whatever information is shown in the LB
p757
aVExplain why you're trying to do this
p758
as(dp759
g9
V17034
p760
stp761
a((dp762
g2
(lp763
VYou could use the IndexOfKey property to find the ToolStripMenuItem back
p764
aVThat requires setting the Name property when you add them:
p765
as(dp766
g9
V17034
p767
stp768
a((dp769
g2
(lp770
VYes, that would do it
p771
aVChanging the FormBorderStyle requires Windows Forms to recreate the window from scratch, now using different style flags in the CreateWindowEx() call
p772
aVThat would make it completely forget about the parent you set with the SetParent() P/Invoke
p773
aVThere are lots of other properties that causes this to happen
p774
aVAvoid the kind of trouble you got into by making these calls in an override of the OnHandleCreated() method
p775
aVBetter yet, avoid troublesome APIs like SetParent() completely by putting all your controls and logic in a UserControl
p776
as(dp777
g9
V17034
p778
stp779
a((dp780
g2
(lp781
VYou can detect users copying files into a folder with a service that uses FileSystemWatcher
p782
aVAltering the contents of a file when an app reads the file requires viral techniques that patch the operating system
p783
aVLike a rootkit or a file system filter driver
p784
aVNot something I'd recommend considering, alter the file after it was written
p785
aVc:\u005cwindows\u005cassembly contains the GAC
p786
aVNET installs a shell extension handler that hides the contents of the folder
p787
aVThe folder is otherwise quite accessible, the shell extension handler only works when you look at the folder with Windows Explorer
p788
aVWriting shell extension handlers with
p789
aVNET is strongly discouraged by Microsoft, the framework also completely lacks support
p790
as(dp791
g9
V17034
p792
stp793
a((dp794
g2
(lp795
VYou can hide the tabs, very convenient in the designer
p796
aVAdd a new class to your project and paste this code:
p797
as(dp798
g9
V17034
p799
stp800
a((dp801
g2
(lp802
VAll three classes have a Dispose() method
p803
aVMandatory is too strong, but definitely highly recommended you use the using keyword so Dispose() is automatically called
p804
aVFailing to do so makes your program run "heavy", using more system resources than necessary
p805
aVAnd outright failure when you don't use the "new" keyword enough to trigger the garbage collector
p806
as(dp807
g9
V17034
p808
stp809
a((dp810
g2
(lp811
VFontDialog was designed to only show TrueType fonts to stay compatible with GDI+
p812
aVGetting it to show the device fonts takes a bit of Reflection hacking:
p813
aVI don't know whether this also enables Adobe's OpenType fonts, I don't have any
p814
aVLet us know
p815
as(dp816
g9
V17034
p817
stp818
a((dp819
g2
(lp820
VYes, I repro if I use a button to change the selected tab
p821
aVTabControl forces the focus onto itself before it changes SelectedIndex
p822
aVThis appears to have been done to avoid problems with the Validating event
p823
aVThe focus change produces the first Enter event, for the active tab, the tab change then produces the second Enter event
p824
aVKnowing this, you could set a helper boolean member, indicating that the first Enter event should be ignored
p825
aVBe careful to check that the current tab isn't already the one you want to select
p826
aVIn a perfect world, this behavior shouldn't matter
p827
aVThe focus really did move to the active tab first
p828
as(dp829
g9
V17034
p830
stp831
a((dp832
g2
(lp833
VI don't have compelling proof for this, but it is standard MSFT practice to use memory mapped files
p834
aVThere's plenty of CreateFileMapping() calls in Rotor
p835
aVVery efficient for read-only files like assemblies, the memory pages don't have to be backed by the paging file
p836
aVBut, it hits the fan when the Windows memory manager needs to swap pages back in and the file became inaccessible
p837
aVIt fits your observation very well
p838
aVThere's no workaround for this, other than your boss committing to his preference and purchasing more reliable networking hardware
p839
aVA MTBF of hours is pretty poor
p840
as(dp841
g9
V17034
p842
stp843
a((dp844
g2
(lp845
VThe convenience of Control
p846
aVBeginInvoke() is hard to pass up
p847
aVYou don't have to
p848
aVAdd a new class to your project and paste this code:
p849
aVHere's some sample code to test it:
p850
as(dp851
g9
V17034
p852
stp853
a((dp854
g2
(lp855
VThe RunWorkerCompleted event is marshaled from the BGW thread to the UI thread by the WF plumbing that makes Control
p856
aVInvoke() work
p857
aVEssentially, there's a queue with delegates that is emptied by the message loop
p858
aVThe code that does this, Control
p859
aVInvokeMarshaledCallbacks(), you'll see it on the call stack, has a catch (Exception) clause to catch unhandled exceptions
p860
aVThat clause calls Application
p861
aVOnThreadException, passing the value of Exception
p862
aVGetBaseException()
p863
aVWell, that explains why you only see the inner exception
p864
aVWhy it is done this way is a bit unclear
p865
aVPossibly to slice off the stack frames of the code in the UI thread that are otherwise pretty confusing since the real exception came from the background thread
p866
as(dp867
g9
V17034
p868
stp869
a((dp870
g2
(lp871
VThe BMP encoder doesn't support 48bpp formats
p872
aVYou can get a crack at the pixels with the Bitmap
p873
aVLockBits() method
p874
aVAlthough the MSDN Library article for PixelFormat says that 48bpp is treated like 24bpp images, I do in fact see 6 byte pixels with this code:
p875
as(dp876
g9
V17034
p877
stp878
a((dp879
g2
(lp880
VThe compilers that shipped with
p881
aVNET 2
p882
aV0 SP1 turn on the NXCOMPAT flag in the executable file header
p883
aVYou can turn that flag off in a Post Build step by running EditBin
p884
aVexe with the /NXCOMPAT:NO option
p885
as(dp886
g9
V17034
p887
stp888
a((dp889
g2
(lp890
VWindows Forms doesn't support windows like that well, it is pretty fundamentally incompatible with the designer
p891
aVHere's some code to get you started
p892
aVYou can't use this control in the designer, it must be created at run-time
p893
aVYou also must call its Dispose() method yourself
p894
as(dp895
g9
V17034
p896
stp897
a((dp898
g2
(lp899
VThe assembly version number is set by the type library version number, not the VERSIONINFO resource in the DLL
p900
aVBe sure to set the "version" attribute for the library correctly in the IDL file:
p901
as(dp902
g9
V17034
p903
stp904
a((dp905
g2
(lp906
VGDI+ is pretty flaky
p907
aVYou'll need to use 16L for the value or cast to (long)
p908
as(dp909
g9
V17034
p910
stp911
a((dp912
g2
(lp913
VThis list of NP complete problems should keep you busy for a while
p914
as(dp915
g9
V17034
p916
stp917
a((dp918
g2
(lp919
VThe Form
p920
aVLoad event behaves the same way as most other events in Windows Forms
p921
aVIt is dispatched by the message loop, in this case when Windows sends the WM_SHOWWINDOW message
p922
aVThere is an exception handler in the message loop that prevents an uncaught exception from terminating the message loop
p923
aVThat exception handler raises the Application
p924
aVThreadEvent event
p925
aVThe default event handler displays the unhandled exception dialog
p926
aVLong story short, you cannot catch an exception raised in the Load event in your button Click handler
p927
aVOther than catching and handling exceptions in the Load event handler itself, very hard to do right, I'd recommend you add a public method to the form
p928
aVSomething like Initialize()
p929
aVMove the code from your Load event into that method
p930
aVCall Initialize() after calling the Show() method, exceptions are now yours to catch
p931
as(dp932
g9
V17034
p933
stp934
a((dp935
g2
(lp936
VIt is possible with some elbow grease
p937
aVPaste this code in the form that you show on the touch screen:
p938
aVThat makes sure that the form won't steal the focus from the main form
p939
aVMake it look like this:
p940
as(dp941
g9
V17034
p942
stp943
a((dp944
g2
(lp945
VGetting bad results with ClearType but good looking Consolas is pretty strange
p946
aVTry out the ClearType tuner
p947
as(dp948
g9
V17034
p949
stp950
a((dp951
g2
(lp952
VThe
p953
aVNET framework has excellent built-in support for splash screens
p954
aVStart a new WF project, Project + Add Reference, select Microsoft
p955
aVVisualBasic
p956
aVAdd a new form, call it frmSplash
p957
aVOpen Project
p958
aVcs and make it look like this:
p959
as(dp960
g9
V17034
p961
stp962
a((dp963
g2
(lp964
VYou ought to take a look at this KB article and consider its matching hotfix
p965
aVEDIT: the hotfix does solve these kind of debugging problems
p966
aVUnfortunately, the source code changes for the hotfix didn't make it back into the main branch and VS2010 shipped with the exact same problems
p967
aVThis got corrected again by its Service Pack 1
p968
as(dp969
g9
V17034
p970
stp971
a((dp972
g2
(lp973
VSame question, same answer:
p974
aVThe
p975
aVNET framework has excellent built-in support for splash screens
p976
aVStart a new WF project, Project + Add Reference, select Microsoft
p977
aVVisualBasic
p978
aVAdd a new form, call it frmSplash
p979
aVOpen Project
p980
aVcs and make it look like this:
p981
as(dp982
g9
V17034
p983
stp984
a((dp985
g2
(lp986
VThe internal layout of a managed struct is undocumented and undiscoverable
p987
aVImplementation details like member order and packing are intentionally hidden
p988
aVWith the [StructLayout] attribute, you force the P/Invoke marshaller to impose a specific layout and packing
p989
aVThat the default just happens to match what you need to get your code to work is merely an accident
p990
aVAlthough not an uncommon one
p991
aVNote the Type
p992
aVStructLayoutAttribute property
p993
as(dp994
g9
V17034
p995
stp996
a((dp997
g2
(lp998
VAvoid using MessageBox
p999
aVShow() to debug this
p1000
aVIt pumps a message loop, disturbing the normal flow of events
p1001
aVThe Load event is triggered by Windows sending the WM_SHOWWINDOW message, just before the window becomes visible
p1002
aVThere is no Windows notification for "your window is now fully shown", so the WF designers came up with a trick to generate the Shown event
p1003
aVThey use Control
p1004
aVBeginInvoke(), ensuring the OnShown() method gets called as soon as the program goes idle again and re-enters the message loop
p1005
aVThis trick has lots of other uses, particularly when you have to delay the execution of code started by an event
p1006
aVHowever, in your case it falls apart because you use MessageBox
p1007
aVShow()
p1008
aVIts message loop dispatches the delegate registered with BeginInvoke(), causing the Shown event to run before the window is shown
p1009
aVThere are lots of other ways to get diagnostics beyond MessageBox
p1010
aVDebug
p1011
aVPrint() and Console
p1012
aVWriteLine() are handy, their output goes to the Visual Studio Output Window without having any detrimental effects on the normal event firing sequence
p1013
aVA simple breakpoint can do wonders too
p1014
as(dp1015
g9
V17034
p1016
stp1017
a((dp1018
g2
(lp1019
VDisplay the language selection form as a dialog
p1020
aVMake your Program
p1021
aVcs file look like this:
p1022
aVAdd this line to your _btnOK click handler:
p1023
as(dp1024
g9
V17034
p1025
stp1026
a((dp1027
g2
(lp1028
VIt worked just fine when I tried this code:
p1029
as(dp1030
g9
V17034
p1031
stp1032
a((dp1033
g2
(lp1034
VIt's kind of ironic, but everybody's favorite answer (use BeginInvoke) is not in fact correct
p1035
aVThe delegate target method will execute on a threadpool thread
p1036
aVYou are not allowed to touch controls on a thread other than the thread that created them, almost always the program's main thread
p1037
aVIf you try it using the
p1038
aVNET framework version 2
p1039
aV0 and up in the debugger, the loop will immediately terminate with an IllegalOperationException
p1040
aVTo correct that, you'll have to use Control
p1041
aVBeginInvoke()
p1042
aVA completely different animal from the delegate's BeginInvoke() method btw
p1043
aVNow here's the irony, your loop will now dispatch 10,000 delegate invocation requests to the UI thread
p1044
aVIt will spend several seconds executing them, not getting around to doing any real work
p1045
aVLike dispatch the TextBox's Paint event
p1046
aVOr respond to any user input
p1047
aVYou are in fact much worse off than before
p1048
aVI doubt this helps much explaining delegates
p1049
aVMaybe you can pick a better example, something that doesn't try to update controls
p1050
as(dp1051
g9
V17034
p1052
stp1053
a((dp1054
g2
(lp1055
VHere's a way to do it:
p1056
as(dp1057
g9
V17034
p1058
stp1059
a((dp1060
g2
(lp1061
VIt is pretty easy to replace the lost functionality:
p1062
aVYou'll need to do a bit more work if you need to tile the image
p1063
as(dp1064
g9
V17034
p1065
stp1066
a((dp1067
g2
(lp1068
VTake a good look at any project's References node
p1069
aVYou'll never find mscorlib
p1070
aVdll listed there
p1071
aVIt is special, any compiler needs it because it contains types that are required to make the language syntax work
p1072
aVSystem
p1073
aVArray, System
p1074
aVInt32, System
p1075
aVString, System
p1076
aVException, etc
p1077
aVYou can write a program that doesn't have a dependency on System
p1078
aVdll (although it would be hard) but you can't write one that doesn't depend on mscorlib
p1079
aVdll
p1080
as(dp1081
g9
V17034
p1082
stp1083
a((dp1084
g2
(lp1085
VYes, you'd get that from the #pragma pack directive in config/abi/msvc_prefix
p1086
aVhpp
p1087
aVIt indicates that your project's default packing is not 8
p1088
aVThat's pretty unusual, is this intentional
p1089
aVBugs due to packing differences can be a bit tricky to diagnose
p1090
as(dp1091
g9
V17034
p1092
stp1093
a((dp1094
g2
(lp1095
VYou'll also get CS0136 from code like this:
p1096
aVThe scope of the 2nd declaration of "i" is unambiguous, languages like C++ don't have any beef with it
p1097
aVBut the C# language designers decided to forbid it
p1098
aVGiven the above snippet, do you think still think that was a bad idea
p1099
aVThrow in a bunch of extra code and you could stare at this code for a while and not see the bug
p1100
aVThe workaround is trivial and painless, just come up with a different variable name
p1101
as(dp1102
g9
V17034
p1103
stp1104
a((dp1105
g2
(lp1106
VKeep in mind that the assignment
p1107
aValready has lots of syntactic sugar
p1108
aVThe compiler actually generates code for this statement:
p1109
aVThe corresponding method call compiles without problem:
p1110
aVFwiw, so does helping the compiler to deduce the type argument:
p1111
aVSo it boils down to the question, why the sugar in the assignment statement but not in the method call
p1112
aVI'd have to guess that it's because the sugar is unambiguous in the assignment, there is only one possible substitution
p1113
aVBut in the case of method calls, the compiler writers already had to deal with the overload resolution problem
p1114
aVThe rules of which are quite elaborate
p1115
aVThey probably just didn't get around to it
p1116
as(dp1117
g9
V17034
p1118
stp1119
a((dp1120
g2
(lp1121
VDid you install the hotfix
p1122
as(dp1123
g9
V17034
p1124
stp1125
a((dp1126
g2
(lp1127
VOne reason I can think of is that range checking is easier
p1128
aVGiven that most enumerations start at 0, you'd only have to check the upper bound
p1129
as(dp1130
g9
V17034
p1131
stp1132
a((dp1133
g2
(lp1134
VNo, that makes no difference
p1135
aVPutting the literal at the left hand side was an old C/C++ programming trick, avoiding pain when you accidentally typed = instead of ==
p1136
aVSince the literal isn't an lvalue, you'd get a compile error when you got it wrong
p1137
as(dp1138
g9
V17034
p1139
stp1140
a((dp1141
g2
(lp1142
VGiven that enough contributors are mystified about the notion of nested solutions, I'll just work from the assumption you meant "solution with multiple projects"
p1143
aVYou give them common settings by using a project property sheet
p1144
aVStart with View + Other Windows + Property Manager
p1145
aVOpen one of the nodes, right-click a configuration and choose Add New
p1146
aVChoose a location that makes sense for the solution, the solution directory for example
p1147
aVConfigure the settings the way you want them
p1148
aVRepeat this procedure for all other projects in your solution, now using Add Existing
p1149
aVEvery project will inherit the settings you configured in the sheet, unless it overrides them explicitly
p1150
aVYou may have to go back to the project properties and change an override back to "inherit"
p1151
aVIDE support for project property sheets is a bit flaky, be sure to save them explicitly when you make a change
p1152
as(dp1153
g9
V17034
p1154
stp1155
a((dp1156
g2
(lp1157
VC# makes a stronger guarantee for "private" than C++ does
p1158
aVIn C++, you can indeed override a private virtual method
p1159
aVBut that means that code in a base class can execute code in a derived class
p1160
aVBreaking the promise that the private method is truly private and can only be called by methods in the same class
p1161
aVSomething that doesn't help here is that C++ doesn't require repeating the virtual keyword
p1162
aVLeading up to hard to reverse-engineer mysteries like this one:
p1163
aVI agree there's a possible role for private inheritance
p1164
aVThe C# language designers said No
p1165
aVthough
p1166
as(dp1167
g9
V17034
p1168
stp1169
a((dp1170
g2
(lp1171
VThe TabPage class doesn't have an Enable property
p1172
aVYou can get a similar effect simply by setting the Enable property of the controls on that page
p1173
aVThat also avoids the problem of dealing with a TabControl that has only one page
p1174
aVFor example:
p1175
as(dp1176
g9
V17034
p1177
stp1178
a((dp1179
g2
(lp1180
VHooking all the controls MouseEnter and MouseLeave events, then figuring out if it is still inside the form is pretty painful
p1181
aVA simple timer can get the job done too:
p1182
as(dp1183
g9
V17034
p1184
stp1185
a((dp1186
g2
(lp1187
VOne of the goodies of WF is that you can easily make your own
p1188
aVAdd a new class to your project and paste the code below
p1189
aVCompile
p1190
aVDrop the new control from the top of the toolbox onto your form
p1191
aVImplement the BeforeUpdate event
p1192
as(dp1193
g9
V17034
p1194
stp1195
a((dp1196
g2
(lp1197
VTechnically, it is possible
p1198
aVThe shell dialog used by FolderBrowseDialog has the ability to return both files and folders
p1199
aVUnfortunately, that capability isn't exposed in
p1200
aVNET
p1201
aVNot even reflection can poke the required option flag
p1202
aVTo make it work, you'd have to P/Invoke SHBrowseForFolder() with the BIF_BROWSEINCLUDEFILES flag turned on in BROWSEINFO
p1203
aVulFlags (value = 0x4000)
p1204
aVThe P/Invoke is gritty, it is best to copy and paste the code from another source or the FolderBrowseDialog class itself with Reflector's help
p1205
as(dp1206
g9
V17034
p1207
stp1208
a((dp1209
g2
(lp1210
VYou are re-inventing COM
p1211
aVYour RefCounted class is IUnknown
p1212
aVYour abstract class is an interface
p1213
aVA COM server in a DLL has an entrypoint named DllGetClassObject(), it is a class factory
p1214
aVThere is lots of documentation available from Microsoft on COM, poke around a bit to see how they did it
p1215
as(dp1216
g9
V17034
p1217
stp1218
a((dp1219
g2
(lp1220
VGuessing the resource name can be difficult
p1221
aVTo find out, run Ildasm
p1222
aVexe on your program
p1223
aVDouble-click "Manifest" and look for the
p1224
aVmresource
p1225
aVAnother way to do it that avoids guessing:  Project + Properties, Resource tab
p1226
aVClick the arrow on the "Add Resource" button, Add Existing File and select your
p1227
aVcur file
p1228
aVMake your code look like this:
p1229
as(dp1230
g9
V17034
p1231
stp1232
a((dp1233
g2
(lp1234
VDid you add the database to your solution
p1235
aVSelect it and check the Copy Local (aka Copy to Output Directory) setting in the Properties window
p1236
aVMake sure it isn't set to Copy Always,
p1237
as(dp1238
g9
V17034
p1239
stp1240
a((dp1241
g2
(lp1242
VThe value 3435973836 is significant
p1243
aVIn hex, that's 0xcccccccc
p1244
aVThat's the value assigned to local variables in Debug mode by the stack frame initialization code
p1245
aVWhen you see it back while debugging, you'd say "ah, variable not initialized"
p1246
aVMaybe that gets you a bit closer to solving this
p1247
aVYou mention DLL
p1248
aVThat's relevant too
p1249
aVIterator debugging might get you into trouble, you cannot mix code that has it turned off with code that doesn't
p1250
aVSince the DLL is probably compiled without it, try #define _HAS_ITERATOR_DEBUGGING 0
p1251
as(dp1252
g9
V17034
p1253
stp1254
a((dp1255
g2
(lp1256
VMehrdad is right, no need to do this
p1257
aVThe mouse is captured so you can never move it too quickly
p1258
aVSample code:
p1259
as(dp1260
g9
V17034
p1261
stp1262
a((dp1263
g2
(lp1264
VYou can implement assignment by providing a conversion operator
p1265
aVGiven the nature of your class, you should also override the Object methods:
p1266
as(dp1267
g9
V17034
p1268
stp1269
a((dp1270
g2
(lp1271
VYour code has problems
p1272
aVLet's work from sample code rather than a lesson
p1273
aVI'll create a Panel first, nice if you want to remove the checkboxes you created
p1274
aVYou'd probably be interested in the user clicking a checkbox so lets add an event for that
p1275
aVStart a new WF project and drop a button on the form
p1276
aVDouble click it, then paste this code:
p1277
as(dp1278
g9
V17034
p1279
stp1280
a((dp1281
g2
(lp1282
VBecause the native Windows Edit control, the base for TextBox, has WM_UNDO but not WM_REDO
p1283
aVIt has lots of quirks, dating back from Windows 1
p1284
aV0 and a gazillion app compat patches
p1285
as(dp1286
g9
V17034
p1287
stp1288
a((dp1289
g2
(lp1290
VYour 2nd example is slightly more efficient because the "method" delegate instance doesn't have to be captured in the closure
p1291
aVI doubt you'd ever notice
p1292
as(dp1293
g9
V17034
p1294
stp1295
a((dp1296
g2
(lp1297
VYour question is awfully short on details, I can only provide a generic answer
p1298
aVDo it mathematically is the fastest way
p1299
aVRotation can make that difficult
p1300
aVYou can solve it slowly but easily by using a hit-test bitmap
p1301
aVRender the shapes to a Bitmap, using the same code you now use to render it to the screen
p1302
aVBut now using a color that encodes the shape number
p1303
aVHit testing is now simple and quick with GetPixel()
p1304
aVBe careful to turn off image enhancement settings, like anti-aliasing
p1305
aVRender it to the screen first and take a good look at the pixels with ZoomIt
p1306
as(dp1307
g9
V17034
p1308
stp1309
a((dp1310
g2
(lp1311
VIt is still the same, 64k and 4k on Vista x64
p1312
aVNot so sure if that isn't going to change some day, the small page size is putting serious pressure on the TLB cache, degrading perf considerably for programs that allocate multi-gigabyte chunks
p1313
aVI've also seen several problem reports about not being able to allocate large pages anymore at some inscrutable point during program execution
p1314
aVBut that's just crystal-ball staring for now
p1315
as(dp1316
g9
V17034
p1317
stp1318
a((dp1319
g2
(lp1320
VLet's keep it VB-centric:
p1321
as(dp1322
g9
V17034
p1323
stp1324
a((dp1325
g2
(lp1326
VI've never heard of editing localized forms causing problems, after answering questions for 3 years in the MSDN Windows Forms forum
p1327
aVMicrosoft isn't Borland
p1328
as(dp1329
g9
V17034
p1330
stp1331
a((dp1332
g2
(lp1333
VYes, not unlikely
p1334
aVEdit the short-cut to Visual Studio and give it the /SafeMode option
p1335
aVThat ensures Add-Ons don't get loaded
p1336
aVIf that doesn't help, start disabling shrink-wrapped malware like virus scanners
p1337
as(dp1338
g9
V17034
p1339
stp1340
a((dp1341
g2
(lp1342
VConcurrency and scaling is not an issue but in the most extreme circumstances
p1343
aVYou are just using the network share as a drive to supply the assemblies
p1344
aVThe app still runs on the work station, consuming operating system resources and CPU cycles from that machine only
p1345
aVUnlike a ASP
p1346
aVNET app
p1347
aVIf the app itself uses some kind of shared resource, not untypically a dbase server, concurrency and scaling definitely play a role
p1348
aVBut that will be the case whether or not the app runs from a network share
p1349
aVOne consideration: deploying an update can be tough
p1350
aVYou'll have to get all users to exit the app so there's no lock left on any assemblies
p1351
aVBuilding that into the app would be wise
p1352
aVSomething as simple as a FileSystemWatcher looking for a specific file name will get the job done
p1353
as(dp1354
g9
V17034
p1355
stp1356
a((dp1357
g2
(lp1358
VCreate a SecurityIdentifier with the constructor that takes WellknownSidType
p1359
aVWorldSid
p1360
aVThe Domain SID doesn't matter
p1361
as(dp1362
g9
V17034
p1363
stp1364
a((dp1365
g2
(lp1366
VYou do critically depend on the v-table layout being compatible between VC and GCC
p1367
aVThat is somewhat likely to be okay
p1368
aVEnsuring that the calling convention matches is something you should check (COM: __stdcall, you: __thiscall)
p1369
aVSignificantly, you are getting a AV on writing
p1370
aVNothing is being written when you make the method call itself, so it is likely that operator<< is doing the bombing
p1371
aVDoes std::cout get probably initialized by the GCC runtime when a DLL is loaded with LoadLibrary()
p1372
aVThe debugger should tell
p1373
as(dp1374
g9
V17034
p1375
stp1376
a((dp1377
g2
(lp1378
VIt bombs due to an unhandled exception
p1379
aVThat gives you a chance to make the debugger stop on the first chance exception, right at the point where it is raised
p1380
aVOpen your project, make iexplorer
p1381
aVexe the startup program
p1382
aVDebug + Exceptions, check the Thrown flag on the unmanaged exceptions
p1383
aVMake it crash to get the breakpoint
p1384
as(dp1385
g9
V17034
p1386
stp1387
a((dp1388
g2
(lp1389
VDo observe that something very naughty is going on
p1390
aVThe properties of a private field of the base class are changing (the Location property), completely violating
p1391
aVNET accessibility rulez
p1392
aVThat works up to a point, but runs out of gas once you run your project
p1393
aVThe fix is easy, change the Modifiers property of your button from Private to Protected
p1394
as(dp1395
g9
V17034
p1396
stp1397
a((dp1398
g2
(lp1399
VTools + Options, Debugging + Edit and Continue
p1400
aVTurn off the Enable checkbox
p1401
aVYou can now edit the source code
p1402
aVYou will get a warning when you continue to debug after you've made a change
p1403
as(dp1404
g9
V17034
p1405
stp1406
a((dp1407
g2
(lp1408
VIt's possible
p1409
aVDetect the keystroke in a separate thread, a hidden window and WM_HOTKEY for example
p1410
aVCall SuspendThread() to freeze the interpreter thread
p1411
aVNow use GetThreadContext() to get the CPU registers of the interpreter thread
p1412
aVModify CONTEXT
p1413
aVEip to the address of a function and call SetThreadContext()
p1414
aVHave that function call RaiseException() or throw a C++ exception
p1415
aVResumeThread() and boom
p1416
as(dp1417
g9
V17034
p1418
stp1419
a((dp1420
g2
(lp1421
VYou're aware of the Y2K38 problem
p1422
aVI assume you checked the sign of
p1423
aVtimezone
p1424
aVAvoid the cleverness of using dateTime
p1425
aVMillisecond, that just confuses the next guy
p1426
aVLooks good otherwise
p1427
as(dp1428
g9
V17034
p1429
stp1430
a((dp1431
g2
(lp1432
VThe ApplicationSettings class doesn't support saving settings to the app
p1433
aVconfig file
p1434
aVThat's very much by design, apps that run with a properly secured user account (think Vista UAC) do not have write access to the program's installation folder
p1435
aVYou can fight the system with the ConfigurationManager class
p1436
aVBut the trivial workaround is to go into the Settings designer and change the setting's scope to User
p1437
aVIf that causes hardships (say, the setting is relevant to every user), you should put your Options feature in a separate program so you can ask for the privilege elevation prompt
p1438
aVOr forego using a setting
p1439
as(dp1440
g9
V17034
p1441
stp1442
a((dp1443
g2
(lp1444
V1) Don't catch any exceptions
p1445
aVThe vast majority of them tell you about a bug in your code, you'll want to know about them right away
p1446
aVIf during testing and deployment, you find error conditions that you think you can handle (there aren't many of them), you can always add the try/catch block
p1447
aVIf you plan on handling exceptions, be sure to liberally sprinkle try/finally blocks in your code so the state of your classes is preserved even if there's an exception that prevents cleanup code from running
p1448
aVThere is no notable cost to using try without catch
p1449
aV2) Satellite assemblies are not bulky
p1450
aVJust a small DLL in a subdirectory of your deployment folder
p1451
aVNo special code is required, everything is automatic
p1452
aVMost of all, it is a standard solution
p1453
aVYou can send your
p1454
aVresx files to a localization service and they'll use standard tools (like Winres
p1455
aVexe) to provide you with the translations
p1456
aVAsking them to deal with something custom is going to be expensive and potentially troublesome
p1457
aV3) Alternatives are SQL Server CE (same approach as SQLite) and SQL Server Express
p1458
aVThe latter gives you the most bang for the buck, but must be installed
p1459
aVThat isn't hard
p1460
aV4) It depends on your target audience, but if look-and-feel is at a factor in a buying decision at all, hire a UI designer
p1461
aVS/he'll catch UI bloopers and make it look spiffy
p1462
as(dp1463
g9
V17034
p1464
stp1465
a((dp1466
g2
(lp1467
VTry this:
p1468
as(dp1469
g9
V17034
p1470
stp1471
a((dp1472
g2
(lp1473
VThe number one job of an exception, well before any consideration to allowing code to handle the exception, is to be able to report to the user and/or dev exactly what went wrong
p1474
aVAn exception class that cannot report OOM but just crashes the program without providing any clue to why it crashed is not worth much
p1475
aVOOM is getting pretty common these days, 32-bit virtual memory is running out of gas
p1476
aVThe trouble with adding a lot of helper methods to an exception class is that it will force you into a class hierarchy that you don't necessarily want or need
p1477
aVDeriving from std::exception is now required so you can do something with std::bad_alloc
p1478
aVYou'll run into trouble when you use a library that has exception classes that don't derive from std::exception
p1479
as(dp1480
g9
V17034
p1481
stp1482
a((dp1483
g2
(lp1484
VYou have to use the virtual keyword
p1485
aVThis compiled as expected:
p1486
aVWhere ClassLibrary1 was the namespace in which the C# interface declaration was made
p1487
as(dp1488
g9
V17034
p1489
stp1490
a((dp1491
g2
(lp1492
VYou can request the hotfix through this link
p1493
as(dp1494
g9
V17034
p1495
stp1496
a((dp1497
g2
(lp1498
VFollowing up on the comments to Waves' post, you can elegantly handle the missing "sender" argument with a lambda expression:
p1499
as(dp1500
g9
V17034
p1501
stp1502
a((dp1503
g2
(lp1504
VI'm not so sure it is going to be useful to you, but the source code for a managed version of Tlbimp
p1505
aVexe has been released on CodePlex
p1506
aVVS2010 will definitely solve your problem
p1507
as(dp1508
g9
V17034
p1509
stp1510
a((dp1511
g2
(lp1512
VThis is very unlikely to be a real problem when you restrict yourself to the fonts that ship with Windows and Internet Explorer
p1513
aVThe user will have a version of those fonts installed that is capable of rendering glyphs in her local language
p1514
as(dp1515
g9
V17034
p1516
stp1517
a((dp1518
g2
(lp1519
VThe 'C' language dates from an era where (void*)0 could actually be a valid pointer
p1520
aVIt is not that long ago, the 8080 and Z80 microprocessors had an interrupt vector at address 0
p1521
aVFaced with such architecture choices, it couldn't do anything but let a header file declare the value of NULL
p1522
aVThere were some compilers out there, now long forgotten, where NULL was not equal to (void*)0 (0xffff was the next alternative), thus giving your if() statement undefined behavior
p1523
aVC++ mercifully put an end to this, a null pointer is assignable from and testable against 0
p1524
as(dp1525
g9
V17034
p1526
stp1527
a((dp1528
g2
(lp1529
VNo need at all for BeginWrite
p1530
aVYou only send 3 bytes, they'll easily fit in the transmit buffer, and you're always sure that the buffer is empty when you send the next set
p1531
aVKeep in mind that serial ports are much slower than TCP/IP connections
p1532
aVIt is pretty likely that you end up calling BeginRead() for every single byte that you receive
p1533
aVThat gives the thread pool a good workout, you'd definitely see a lot of context switches
p1534
aVNot so sure about handle consumption
p1535
aVBe sure to test that without the debugger attached
p1536
aVTrying DataReceived instead of BeginRead() is definitely something you should try
p1537
aVPull instead of push, you'll use a threadpool thread when there's something happening instead of always having one active
p1538
as(dp1539
g9
V17034
p1540
stp1541
a((dp1542
g2
(lp1543
VAbusing Application
p1544
aVDoEvents() is another way to get into this kind of trouble
p1545
aVIf you cannot kill the
p1546
aVexe from TaskMgr, your app is stuck waiting for a driver to finish an I/O request
p1547
as(dp1548
g9
V17034
p1549
stp1550
a((dp1551
g2
(lp1552
VIt's a bit sad that C++/CLI allows this syntax
p1553
aVThe int type is a value type, the hat is used for reference types
p1554
aVYour "y" variable does not store an int, it stores System::Object
p1555
aVThe compiler automatically generates a boxing instruction when you assign it
p1556
aVConsole::WriteLine() has otherwise no problem displaying the value of an object that's a boxed int
p1557
aVThe rule of thumb: use the hat when it is a class object, omit it for simple value types
p1558
aVAvoid the stack semantics of a reference type (omitting the hat so it automatically calls the destructor when the scope ends) until you really grok the difference between value and reference types and why Dispose() is important
p1559
as(dp1560
g9
V17034
p1561
stp1562
a((dp1563
g2
(lp1564
VYup, the same
p1565
aVThe 2nd statement is one to avoid, few would guess that it actually creates an array with 21 elements
p1566
aVNot that it is that obvious from the 1st statement either
p1567
as(dp1568
g9
V17034
p1569
stp1570
a((dp1571
g2
(lp1572
VUsing a thread is the standard solution to this
p1573
aVHave your data collection code write data to a thread-safe queue and use a semaphore to signal the writing thread
p1574
aVHowever, before you go there, double-check your assertion that fflush() would be slow
p1575
aVMost operating systems have a file system cache
p1576
aVIt makes writes very fast, as simple memory-to-memory block copy
p1577
aVThe data gets written to disk lazily, your crash won't affect it
p1578
as(dp1579
g9
V17034
p1580
stp1581
a((dp1582
g2
(lp1583
VIt is largely solved through the
p1584
aVNET 2
p1585
aV0 DynamicMethod
p1586
aVHowever, there's still a failure mode if you don't use the [XmlRoot] attribute
p1587
aVReview this article for details
p1588
as(dp1589
g9
V17034
p1590
stp1591
a((dp1592
g2
(lp1593
VThe code with this MSDN magazine article provided a slick way to troubleshoot GDI handle leaks
p1594
aVUnfortunately, the source code no longer seems to be available
p1595
as(dp1596
g9
V17034
p1597
stp1598
a((dp1599
g2
(lp1600
VStart with some simple analysis to consider feasibility
p1601
aVOne digit has 8 possible values
p1602
aVTwo digits have 8 x 8
p1603
aVEtc
p1604
aVNow grab your calculator and compute 8 ^ 32
p1605
as(dp1606
g9
V17034
p1607
stp1608
a((dp1609
g2
(lp1610
VThe key issue is that a glyph in a string takes 32 bits (16 bits for a character code) but a byte only has 8 bits to spare
p1611
aVA one-to-one mapping doesn't exist unless you restrict yourself to strings that only contain ASCII characters
p1612
aVSystem
p1613
aVText
p1614
aVEncoding has lots of ways to map a string to byte[], you need to pick one that avoids loss of information and that is easy to use by your client when she needs to map the byte[] back to a string
p1615
aVUtf8 is a popular encoding, it is compact and not lossy
p1616
as(dp1617
g9
V17034
p1618
stp1619
a((dp1620
g2
(lp1621
VYour math is seriously flawed
p1622
aV5 bits x 6 letters = 30 bits, 2 shy of what you need
p1623
aVPlus, 5 bits requires 2 ^ 5 = 32 codes, you've only got 26 (A-Z)
p1624
aVGiven that you want A-Z, you can only encode 4 bits
p1625
aVWhich requires 32 / 4 = 8 letters
p1626
aVExactly as many as you'd get if you encode in hex
p1627
aVUse the Hex() function and String*8
p1628
as(dp1629
g9
V17034
p1630
stp1631
a((dp1632
g2
(lp1633
VCasting like this is fundamentally unsafe and not permitted in a managed language
p1634
aVThat's also why C# doesn't support unions
p1635
aVYes, the workaround is to use the Marshal class
p1636
as(dp1637
g9
V17034
p1638
stp1639
a((dp1640
g2
(lp1641
VThe String class has only two, they have CLS compliant names: op_Equality and op_Inequality
p1642
aVThe compiler has lots of built-in knowledge of the System
p1643
aVString class
p1644
aVNecessary in order to be able to use the Ldstr opcode for one
p1645
aVLikewise, it translates the + operator into String
p1646
aVConcat()
p1647
aVPretty much the story for Int32, there are direct matches between operators and IL opcodes
p1648
as(dp1649
g9
V17034
p1650
stp1651
a((dp1652
g2
(lp1653
VFirst of all, there's an important difference between reference assemblies and assemblies in the GAC
p1654
aVTo compile code, you need a reference assembly
p1655
aVTo run code, you need either a copy of the assembly in the same folder as your
p1656
aVexe or the assembly in the GAC
p1657
aVNormally, when you install a
p1658
aVNET application, its installer will copy the assemblies it uses in the GAC
p1659
aVThose assemblies are not usable as reference assemblies, you can't find out in what folder it is stored so you can't tell the compiler the proper value of its /reference command line argument
p1660
aVWell, you can find out but Microsoft tried to make it as hard as possible with a shell add-in
p1661
aVSomething different happens when you install a
p1662
aVNET application that allows you to use its assemblies in your own program
p1663
aVLike the
p1664
aVNET framework
p1665
aVIt will make two copies of every assembly
p1666
aVOne goes in the GAC, the other goes in a "well-known" location
p1667
aVFor the
p1668
aVNET framework, these well-known locations are c:\u005cwindows\u005cmicrosoft
p1669
aVnet\u005c and c:\u005cprogram files\u005creference assemblies
p1670
aVThe latter folder started getting used by
p1671
aVNET 3
p1672
aV0 and up
p1673
aVVisual Studio's Add Reference dialog uses a registry key that lists these well-known locations
p1674
aVThere are a couple, but the important one is
p1675
aVLong story short: you could use that registry key to produce the same list that the Add Reference dialog produces
p1676
aVBut it is not 100% reliable, you might miss reference assemblies that some product copied somewhere else
p1677
aVYou'd have to use the Browse tab in VS to add references to those
p1678
aVAnd search the entire disk to find them yourself
p1679
as(dp1680
g9
V17034
p1681
stp1682
a((dp1683
g2
(lp1684
VThe compiler generates a hidden class to implement this code
p1685
aVIt has a super-secret name: "d__0`2"
p1686
aVYour seenKeys and source variables become fields of that class, ensuring that they can't get garbage collected unless the class object is collected
p1687
aVThe class implements the IEnumerator<> interface, the client code that uses the iterator uses that interface to call the MoveNext() method
p1688
aVIt is that interface reference that keeps the class object alive
p1689
aVWhich keeps its fields alive
p1690
aVAs soon as the client code completes the foreach loop, the interface reference disappears, allowing the GC to clean everything up
p1691
aVUse Ildasm
p1692
aVexe or Reflector to see this for yourself
p1693
aVIt will give you some insight in the hidden cost of syntactic sugar as well
p1694
aVIterators aren't cheap
p1695
as(dp1696
g9
V17034
p1697
stp1698
a((dp1699
g2
(lp1700
VThere's a fundamental problem with your request
p1701
aVSuppose there were a IsLockHeld() method and you'd use it like this:
p1702
aVThis cannot work by design
p1703
aVYour thread could be pre-empted between the if() statement and the method call
p1704
aVAllowing another thread to run and lock the object
p1705
aVNow DoSomething() will run, even though the lock is held
p1706
aVThe only way to avoid this is to try to take the lock and see if it worked
p1707
aVMonitor
p1708
aVTryEnter()
p1709
aVYou see the exact same pattern at work in Windows
p1710
aVThere is no way to check if a file is locked by another process, other than trying to open the file
p1711
aVFor the exact same reason
p1712
as(dp1713
g9
V17034
p1714
stp1715
a((dp1716
g2
(lp1717
VThe scrollbar makes the layout of the items bi-stable
p1718
aVYou can get the scrollbar to disappear by whacking it on the head:
p1719
aVThat forces WF to recreate the control handle, the flicker might be barely noticeable
p1720
aVYes, a vertical scrollbar is possible but you'll have to give up on MultiColumn
p1721
as(dp1722
g9
V17034
p1723
stp1724
a((dp1725
g2
(lp1726
VThe CLR supports module initializers
p1727
aVYou'd have to hack C++/CLI code or ilasm
p1728
aVexe to use them
p1729
as(dp1730
g9
V17034
p1731
stp1732
a((dp1733
g2
(lp1734
VYou can use either the CRT function _beginthreadex() or the Windows API function CreateThread()
p1735
aV_beginthreadex() is required for early versions of VC++ that had a CRT that didn't lazily initialize thread-local storage
p1736
aVCreateThread() is fine in at least VS2005 and up
p1737
as(dp1738
g9
V17034
p1739
stp1740
a((dp1741
g2
(lp1742
VConcurrent programming would be pretty easy if your approach could work
p1743
aVBut it doesn't, the iceberg that sinks that Titanic is, for example, the client of your class doing this:
p1744
aVobjectRef
p1745
aVMyProperty += 1;
p1746
aVThe read-modify-write race is pretty obvious, there are worse ones
p1747
aVThere is absolutely nothing you can do to make your property thread-safe, other than making it immutable
p1748
aVIt is your client that needs to deal with the headache
p1749
aVNot being able to delegate that kind of responsibility is the Achilles-heel of concurrent programming
p1750
as(dp1751
g9
V17034
p1752
stp1753
a((dp1754
g2
(lp1755
VThe GAC is your first resource, allowing different versions of the assembly to co-exist side-by-side
p1756
aVBut that doesn't really solve anything unless your app is version tolerant too
p1757
aVBinary serialization has several features to handle version tolerant serialization
p1758
aVRead about it in this MSDN library article
p1759
as(dp1760
g9
V17034
p1761
stp1762
a((dp1763
g2
(lp1764
VIf this is a real driver (kernel mode), you're SOL
p1765
aVVista x64 doesn't allow installing unsigned drivers
p1766
aVIt this is just a user-mode DLL, you can get a fix by using any of the standard IPC mechanisms
p1767
aVPipes, sockets, out-of-proc COM, roughly in that order
p1768
aVIt all operates on bus speeds so as long as you can buffer enough data, the context switch overhead shouldn't hurt too much
p1769
as(dp1770
g9
V17034
p1771
stp1772
a((dp1773
g2
(lp1774
VWhy eliminate them
p1775
aVSounds like you've created a realistic benchmark
p1776
aVThat code would have the same kind of variability when used in the wild as well
p1777
aVProbably worse since you're likely to have eliminated disk and CPU cache latencies
p1778
aVUsing Jon Skeet's approach, creating conditions that gives you the best possible result, will only leave you with a result that makes you feel good but is never achievable
p1779
aVIf an absolute number is important, calculate the median, not the average
p1780
as(dp1781
g9
V17034
p1782
stp1783
a((dp1784
g2
(lp1785
VYour resource type, 11, is wrong
p1786
aVThat means RT_MESSAGETABLE, the resource compiler tries to load an
p1787
aVmc file
p1788
aVPick something else, like 99 or MYCUSTOMRESOURCE
p1789
as(dp1790
g9
V17034
p1791
stp1792
a((dp1793
g2
(lp1794
VI'll assume that the native code is in a separately compiled unit, like a
p1795
aVdll
p1796
aVFirst thing the worry about is the native code using a different allocator (new/delete), you'll get that when it is compiled with /MT or linked to another version of the CRT
p1797
aVNext thing to worry about is STL iterator debugging
p1798
aVYou should make sure both modules were compiled with the same setting for _HAS_ITERATOR_DEBUGGING
p1799
aVThey won't be the same if the native code was built with an old version of the CRT of is the Release mode build
p1800
as(dp1801
g9
V17034
p1802
stp1803
a((dp1804
g2
(lp1805
VAdd a new class to your project and paste the code shown below
p1806
aVBuild
p1807
aVDrop the new control from the top of your toolbox onto your form
p1808
aVThe flicker might be noticeable, no fix
p1809
as(dp1810
g9
V17034
p1811
stp1812
a((dp1813
g2
(lp1814
VFirst Google hit: http://en
p1815
aVwikibooks
p1816
aVorg/wiki/6502_Assembly#Branch
p1817
as(dp1818
g9
V17034
p1819
stp1820
a((dp1821
g2
(lp1822
VInterface methods always have public accessibility
p1823
aVYou can't fix that by explicit interface implementation, that will only hide the class method
p1824
aVSimply casting the object to the interface type gives unfettered access again
p1825
aVEDIT: actually, the problem is easy to solve
p1826
aVJust declare the property ReadOnly in the interface declaration :)
p1827
aVFor example:
p1828
as(dp1829
g9
V17034
p1830
stp1831
a((dp1832
g2
(lp1833
VThis is the code generated by 0
p1834
aV= (value & (1 << index)) to test a bit:
p1835
aVAnd this by values[index] to test a bool[]:
p1836
aVCan't figure out how to put a loop around it that doesn't get optimized away, I'll vote bool[]
p1837
as(dp1838
g9
V17034
p1839
stp1840
a((dp1841
g2
(lp1842
VEcma 335 specifies (but does not demand) that compilers use the get_/set_ prefixes (chapter 22
p1843
aV28)
p1844
aVI don't know any language that breaks that recommendation
p1845
aVMaking it easy:
p1846
as(dp1847
g9
V17034
p1848
stp1849
a((dp1850
g2
(lp1851
s(dp1852
g9
V17034
p1853
stp1854
a((dp1855
g2
(lp1856
VThe MSDN docs for that Bitmap constructor leave no doubt whatsoever:
p1857
aVRemarks
p1858
aVThe caller is responsible for allocating and freeing the block of memory specified by the scan0 parameter, however, the memory should not be released until the related Bitmap is released
p1859
as(dp1860
g9
V17034
p1861
stp1862
a((dp1863
g2
(lp1864
VThere's a bug in your remove_flag() method, it should be flags |= i;
p1865
aVBut, do it O(1) like this:
p1866
as(dp1867
g9
V17034
p1868
stp1869
a((dp1870
g2
(lp1871
VThe EULA that you agreed to when you installed Visual Studio is quite explicit
p1872
aVNot only do you own the rights to the code you develop using VS, you are required to explicitly claim copyright on your code
p1873
aVOne file you should review is redist
p1874
aVtxt, it is copied to the installation directory
p1875
aVIt lists the files that are owned by Microsoft that you are allowed to redistribute freely
p1876
aVAll the essentials are there, like the
p1877
aVNET framework
p1878
aVAnything that is not in that list is not yours to use
p1879
aVThere is one specific exclusion in the EULA, you are not allowed to develop a product that can be used to allow your customers to access Internet resources for a fee
p1880
aVA bit of an odd-ball exclusion, I assume it is meant to suppress competition for a business segment that MSFT doesn't control
p1881
aVFinally, as others have alluded, an "understanding" with your employer means squat when it is crunch time
p1882
aVCarefully review the employee contract you signed
p1883
aVIt's been quite a while since I last saw one that didn't claim ownership of after-hours work
p1884
aVAs well as "related" works produced after the end of the agreement for a certain period
p1885
aVIP is big, your brain is pwned
p1886
as(dp1887
g9
V17034
p1888
stp1889
a((dp1890
g2
(lp1891
VReflector doesn't let you see unmanaged resources
p1892
aVYou don't need a special tool, just use Visual Studio's File + Open + File and select your
p1893
aVexe to browse the resources
p1894
aVThe manifest is accessible through the RT_MANIFEST node
p1895
aVThe viewer is not very friendly, you'll get a hex dump
p1896
aVYou can use the context menu to export it to a text file
p1897
aVThe C# and VB
p1898
aVNET compilers automatically generate a Vista compatible manifest
p1899
aVYou can override this with the /win32manifest command line option
p1900
aVWhich is what the IDE will do automatically when you use Project + Add New Item + Application Manifest File
p1901
as(dp1902
g9
V17034
p1903
stp1904
a((dp1905
g2
(lp1906
VYou'll have to use SetWindowsHookEx()
p1907
aVThere are only two types of hooks that you can implement in a managed language, WH_KEYBOARD_LL and WH_MOUSE_LL
p1908
aVAll other hooks require a DLL that can be injected into another process
p1909
aVManaged DLLs cannot be injected, the CLR cannot be initialized
p1910
aVThis blog post has a functional example
p1911
as(dp1912
g9
V17034
p1913
stp1914
a((dp1915
g2
(lp1916
VYou can't add any controls that cover the MDI client window (dark-gray background)
p1917
aVMDI clients are shown with the client window as the parent so they'll have a Z-order lower than the control
p1918
aVWF does support docked controls, it automatically adjusts the client area to the remaining space in the parent form
p1919
aVBut that's about it, SplitContainer can't work
p1920
aVDo note that you can show a forms on the panels of a SplitContainer
p1921
aVSet their TopLevel property to False so they turn into controls
p1922
aVFor example:
p1923
as(dp1924
g9
V17034
p1925
stp1926
a((dp1927
g2
(lp1928
VUser level app settings are isolated in a subdirectory of AppData
p1929
aVOne app cannot find the settings of another app
p1930
aVJust use a plain file
p1931
as(dp1932
g9
V17034
p1933
stp1934
a((dp1935
g2
(lp1936
VThe Implements keyword in VB
p1937
aVNET makes this easy:
p1938
as(dp1939
g9
V17034
p1940
stp1941
a((dp1942
g2
(lp1943
VThis KB article might be interesting for those that find this thread back
p1944
as(dp1945
g9
V17034
p1946
stp1947
a((dp1948
g2
(lp1949
VIt is a system setting
p1950
aVYou could change it by P/Invoking SystemParametersInfo with the SPI_SETLISTBOXSMOOTHSCROLLING argument
p1951
aVDoing so is not recommended
p1952
as(dp1953
g9
V17034
p1954
stp1955
a((dp1956
g2
(lp1957
VYou're probably doing it backwards
p1958
aVYou shouldn't really care much about fonts, colors, placement and look-and-feel until after you're done making it work
p1959
aVThat saves lots of time tweaking controls that you might ultimately throw away
p1960
aVEven if you have a good mock-up of the UI, still do it afterwards
p1961
aVOr when the code ain't flowing
p1962
aVWhich btw might be another explanation
p1963
as(dp1964
g9
V17034
p1965
stp1966
a((dp1967
g2
(lp1968
VNo
p1969
aVMethods take up memory but that's very little
p1970
aVThe method table as well as the code generated for the method is shared by every instance of the object
p1971
as(dp1972
g9
V17034
p1973
stp1974
a((dp1975
g2
(lp1976
VWhat exactly do you mean by "light weight"
p1977
aVIf the absolute minimum amount of system resources is important, you should code it Petzold style using 'C' and the raw Win32 API
p1978
aVIt will take you a couple of days, give or take
p1979
aVIf "light weight" means, "I want to do this in an hour and be done with it" (possibly quicker than waiting for an answer at SO), you should code it with a RAD tool like Windows Forms
p1980
aVIt will definitely use a lot more resources than the 'C' version
p1981
aVIt is however very unlikely that you'd ever notice
p1982
as(dp1983
g9
V17034
p1984
stp1985
a((dp1986
g2
(lp1987
VIt's supported
p1988
aVFor example:
p1989
aVProduces:
p1990
aVwarning CS0649: Field 'ConsoleApplication1
p1991
aVTest
p1992
aVnotAssigned' is never assigned to, and will always have its default value 0
p1993
aVTo turn it into an error, use Project + Properties, Build tab, Treat warnings as errors
p1994
as(dp1995
g9
V17034
p1996
stp1997
a((dp1998
g2
(lp1999
VHere you go:
p2000
aVI'll gladly pass the buck on figuring out where to put it
p2001
as(dp2002
g9
V17034
p2003
stp2004
a((dp2005
g2
(lp2006
VListView doesn't support this
p2007
aVOnly the 1st column can have a checkbox
p2008
aVYou could fake it with custom drawing and mouse hit testing but that's a lot of work
p2009
aVConsider using a DataGridView instead
p2010
aVYou can change the column type to DataGridViewCheckBoxColumn
p2011
as(dp2012
g9
V17034
p2013
stp2014
a((dp2015
g2
(lp2016
VYou don't need generic to do this:
p2017
aVSample usage:
p2018
as(dp2019
g9
V17034
p2020
stp2021
a((dp2022
g2
(lp2023
VYes, tedious
p2024
aVYou can find color settings in the MFC Feature Pack files, included with VS2008 SP1
p2025
aVThere are 4 Office themes, they each have a style
p2026
aVxml file in a subdirectory of vc/atlmfc/include
p2027
aVBlack, Blue, Silver and Aqua
p2028
as(dp2029
g9
V17034
p2030
stp2031
a((dp2032
g2
(lp2033
VGoing down the list of IPC options:
p2034
aVMemory mapped files
p2035
aVEasy in C++, tough in C# without pointers, awkward handshaking
p2036
aVWM_COPYDATA
p2037
aVEasy in both, tricky to find the window handle you'll need
p2038
aVClipboard
p2039
aVEasy in both, very awkward handshaking
p2040
aVCOM
p2041
aVOut-of-proc is a beast, forget about it
p2042
aVMailslots
p2043
aVNot suitable for one-to-one communication
p2044
aVPipes
p2045
aVEasy in
p2046
aVNET 3
p2047
aV5, do-able in C++ but a bit tricky to get right
p2048
aVSockets
p2049
aVEasy in both, hard to pass up
p2050
as(dp2051
g9
V17034
p2052
stp2053
a((dp2054
g2
(lp2055
VData binding makes very little sense here
p2056
aVJust make your code look like this:
p2057
as(dp2058
g9
V17034
p2059
stp2060
a((dp2061
g2
(lp2062
VYour program is probably leaking kernel resources
p2063
aVStart diagnosing this problem with Taskmgr
p2064
aVexe
p2065
aVView + Select Columns, check User objects, GDI objects and Handle count
p2066
aVRun your program and observe if any of these is increasing steadily
p2067
aVOnce one of them reaches 10,000 your program will die
p2068
aVWith a way to quickly see the leak in action, you can start commenting code to see where the leak occurs
p2069
aVIt probably has something to do with your "hook"
p2070
as(dp2071
g9
V17034
p2072
stp2073
a((dp2074
g2
(lp2075
VLocate a machine that has Office 2000 and
p2076
aVNET installed
p2077
aVRun this command on it:
p2078
aVTlbimp "c:
p2079
aV\u005cmsword
p2080
aVolb" /out:Word
p2081
aVdll
p2082
aVwhere
p2083
aVis the Office installation directory
p2084
aVCopy Word
p2085
aVdll to your dev machines
p2086
aVAdd a reference to it in your project, make sure Copy Local is set to Yes (it is by default)
p2087
aVYou can now use "using Word" for any version of Office
p2088
aVThe Word
p2089
aVdll file must be deployed to the target machine in the same directory as your
p2090
aVexe
p2091
as(dp2092
g9
V17034
p2093
stp2094
a((dp2095
g2
(lp2096
VHard to tell from your snippet, the problem could be the type of the Amount column or the way you display the result
p2097
aVConsider this equivalent code that doesn't have the problem:
p2098
as(dp2099
g9
V17034
p2100
stp2101
a((dp2102
g2
(lp2103
VYou stepped in a pretty big pile of doodoo, having an installation aborted without a rollback is Bad
p2104
aVTry to recover your registry with a System Restore
p2105
aVBefore you do anything, get your machine stable first
p2106
as(dp2107
g9
V17034
p2108
stp2109
a((dp2110
g2
(lp2111
VWrite it like this:
p2112
as(dp2113
g9
V17034
p2114
stp2115
a((dp2116
g2
(lp2117
VThis is reproducible behavior
p2118
aVWhen you create a new form, it starts out with a skeleton that includes the this
p2119
aVcomponents constructor call
p2120
aVWhen you then add a component (say a Timer) and remove it again, the designer regenerates the code, now without the constructor call
p2121
aVThat isn't a bug
p2122
aVFwiw, the skeleton code is generated by
p2123
aVSeeing the base
p2124
aVDispose() call inside the if() statement is a bug
p2125
aVThat might be self-induced
p2126
aVOr it might be a beta version of the skeleton code
p2127
aVVS2005 does it right
p2128
aVDo check the ItemsTemplatesCache folder
p2129
as(dp2130
g9
V17034
p2131
stp2132
a((dp2133
g2
(lp2134
VThe critical part is initializing m_Popup correctly
p2135
aVYou haven't said anything about that
p2136
aVSome sample code:
p2137
aVForm2:
p2138
aVForm1:
p2139
aVThe mPopup = f2 statement in this code is key
p2140
as(dp2141
g9
V17034
p2142
stp2143
a((dp2144
g2
(lp2145
VThe GAC has no awareness of the source of an assembly
p2146
aVThe most likely explanation is that you simply got the DLL rebuilt by the IDE
p2147
as(dp2148
g9
V17034
p2149
stp2150
a((dp2151
g2
(lp2152
VVC6 is too old and too broken to know "long long"
p2153
aVIt will compile __int64
p2154
aVVS200x doesn't have a problem with it
p2155
as(dp2156
g9
V17034
p2157
stp2158
a((dp2159
g2
(lp2160
VYour code as posted doesn't require anything additional
p2161
aVHowever, it will only work properly if no other code will access the token member while the thread is running
p2162
aVShared read/write access to a variable needs to be protected by a lock
p2163
aVBut that's not all, you'll also have to ensure that the threads are synchronized properly, the thread that reads "token" should probably wait until the worker thread updated the value
p2164
aVGoogle for "producer consumer pattern" and you'll find plenty of literature on the subject
p2165
aVAssuming in this case you need some kind of code in the UI thread to wait for RequestImage() to complete, then use its result, the easiest way to handle the synchronization is to let RequestImage() call Control
p2166
aVBeginInvoke() when it completes the job
p2167
aVNote that you'll also need to handle the case where the UI thread terminates before the worker thread is completed
p2168
aVNot doing this is likely to produce an ObjectDisposed exception
p2169
aVThe Q&D; solution for that is to set the thread's IsBackground property to True
p2170
aVDo make sure that nothing nasty happens when the thread gets aborted
p2171
as(dp2172
g9
V17034
p2173
stp2174
a((dp2175
g2
(lp2176
VTreeView steals the focus back after the event returns
p2177
aVVery annoying
p2178
aVYou can use a trick: delay the action of the event with Control
p2179
aVBeginInvoke:
p2180
aVThe delayedClick method runs as soon as all the events for the TreeView have finished running and your program goes idle and re-enters the message loop
p2181
as(dp2182
g9
V17034
p2183
stp2184
a((dp2185
g2
(lp2186
VYou're on the wrong end of the Intertube
p2187
aVIt is the server that can have only one particular port open
p2188
aVSome code:
p2189
aVMessage: Only one usage of each socket address (protocol/network address/port) is normally permitted
p2190
as(dp2191
g9
V17034
p2192
stp2193
a((dp2194
g2
(lp2195
VUse DateTime
p2196
aVFromOADate()
p2197
as(dp2198
g9
V17034
p2199
stp2200
a((dp2201
g2
(lp2202
VYou can use _statusfp2() to retrieve the floating point status
p2203
aVBeware that 32-bit uses both FPU and SSE instructions
p2204
aVSome sample code:
p2205
as(dp2206
g9
V17034
p2207
stp2208
a((dp2209
g2
(lp2210
VYou don't need the Form double-buffered, you need the PB to be
p2211
aVThat's not so easy to come by in CF
p2212
aVHowever, you could create your own control, PB is pretty simple
p2213
aVFor example:
p2214
aVHopefully, I didn't use stuff that isn't available in CF
p2215
as(dp2216
g9
V17034
p2217
stp2218
a((dp2219
g2
(lp2220
VActually, it is a bug in the property setter for the Text property
p2221
aVThe P/Invoke declaration for NOTIFYICONDATA inside Windows Forms uses the 128 char limit
p2222
aVYou can hack around it with Reflection:
p2223
as(dp2224
g9
V17034
p2225
stp2226
a((dp2227
g2
(lp2228
VIt is a Vista specific bug
p2229
aVIt goes bonkers when you scroll past 65536 + number of visible items
p2230
aVThe bug did not get fixed in SP1
p2231
aVNo problems in XP
p2232
aVBut yes, that's a bug that rarely gets put to the test
p2233
as(dp2234
g9
V17034
p2235
stp2236
a((dp2237
g2
(lp2238
VYou can't override Add(), it is not a virtual method
p2239
aVDerive from IList instead and use a private Queue member for the implementation
p2240
as(dp2241
g9
V17034
p2242
stp2243
a((dp2244
g2
(lp2245
VIf you know the conversion can't be invalid then just use static_cast
p2246
as(dp2247
g9
V17034
p2248
stp2249
a((dp2250
g2
(lp2251
VThere's only one kind, that should help narrow it down
p2252
aVStart by studying the CPU architecture manuals, Intel's are available for free
p2253
aVGetting documentation for the BIOS is going to be the hard part
p2254
as(dp2255
g9
V17034
p2256
stp2257
a((dp2258
g2
(lp2259
VBeware of the effects that incremental linking and Edit+Continue will have on function addresses, including v-table entries
p2260
aVIt works by making method calls indirectly through a jump table
p2261
aVThat allows the linker to patch the jump table when it needs to relocate the method without having the relink the entire image
p2262
aVThe addresses in that jump table are 5 bytes apart
p2263
aVThey won't appear in the
p2264
aVmap file
p2265
aVIt is really easy to see when you switch to Assembly view and trace execution of the call
p2266
aVWhich is also the technique you should use to diagnose the RTC failure
p2267
aVFind out what method is actually getting called
p2268
aVThe most likely reason for this is that you've added virtual methods to a class but a client of that class wasn't recompiled
p2269
aVUsing the wrong slot in the v-table
p2270
aVClassically also a COM problem when changing interfaces but not IIDs
p2271
as(dp2272
g9
V17034
p2273
stp2274
a((dp2275
g2
(lp2276
VSingle-instance apps are well supported by the
p2277
aVNET framework
p2278
aVCheck this thread for an example that does exactly what you need
p2279
as(dp2280
g9
V17034
p2281
stp2282
a((dp2283
g2
(lp2284
VShowDialog() does two important things
p2285
aVIt starts pumping a message loop so it acts modally to the calling code
p2286
aVAnd it disables any other windows in the application with a EnableWindow(false) API call
p2287
aVThe latter is what is not happening in your case
p2288
aVNot entirely surprising, considering that the window that needs to be disabled is not a WF window
p2289
aVYou may need to call EnableWindow() yourself
p2290
aVBe sure to re-enable it in before the dialog closes or Windows will go hunting for another app's window to give the focus to
p2291
as(dp2292
g9
V17034
p2293
stp2294
a((dp2295
g2
(lp2296
VWith a garbage collection heap, you should always favor small, right-sized buffers that have a short life-time
p2297
aVThe
p2298
aVNET heap allocator is very fast, generation #0 collections are very cheap
p2299
aVWhen you keep a static buffer around, you'll use up system resources for the life of the program
p2300
aVThe worst case scenario is when it gets big enough to get moved in the Large Object Heap where it will be a permanent obstacle that cannot be moved
p2301
as(dp2302
g9
V17034
p2303
stp2304
a((dp2305
g2
(lp2306
VA TabControl is a very convenient control in the designer
p2307
aVChanging tab pages at runtime is easy too, just set the SelectedIndex or SelectedTab property
p2308
aVYou just need to get rid of the tabs
p2309
aVLuckily, that's easy
p2310
aVAdd a new class to your project and paste the code shown below
p2311
aVBuild
p2312
aVDrop the new control from the top of the toolbox onto your form
p2313
as(dp2314
g9
V17034
p2315
stp2316
a((dp2317
g2
(lp2318
VThere's a bit of bias in the MSFT docs about the disposable pattern
p2319
aVThere are two reasons you should implement IDisposable:
p2320
aVYou've got fields of a type that implements IDisposable
p2321
aVYou've got a finalizer
p2322
aVCase 1 is pretty common in most code
p2323
aVCase 2 is pretty common in code that Microsoft writes, they were the ones that wrote the managed wrappers around the unmanaged resources, the ones that need finalization
p2324
aVBut should be very uncommon in your code
p2325
aVAfter all, you've got all those nice
p2326
aVNET classes to do the dirty work for you
p2327
aVYou just have to call their Dispose() methods
p2328
aVOnly case 2 requires the disposable pattern
p2329
aVMicrosoft needs to use it a lot
p2330
aVYou'll just need the simple Dispose() most of the time
p2331
as(dp2332
g9
V17034
p2333
stp2334
a((dp2335
g2
(lp2336
VThis code doesn't make a lot of sense, but it does avoid traversing the Controls collections:
p2337
as(dp2338
g9
V17034
p2339
stp2340
a((dp2341
g2
(lp2342
V"some COM" is relevant
p2343
aVYou'll hit COM's apartment threading rulez
p2344
aVA COM object like Word must be created on an STA thread
p2345
aVYour main UI thread qualifies, it starts at Main() and it has the [STAThread] attribute
p2346
aVAny method calls you make on another thread are automatically marshaled by COM to the STA thread
p2347
aVGumming up your animation
p2348
aVThis isn't easy to fix
p2349
aVYou'd need a background thread that must be an STA thread as well, use Thread
p2350
aVSetApartmentState()
p2351
aVAnd pump a message loop, use Application
p2352
aVRun()
p2353
aVGetting your code started and exiting the loop is awkward, try using a form that overrides SetVisibleCore() so you can avoid making it visible
p2354
as(dp2355
g9
V17034
p2356
stp2357
a((dp2358
g2
(lp2359
VOdd question, the usual problem is hiding a property
p2360
aVMake it look something like this:
p2361
as(dp2362
g9
V17034
p2363
stp2364
a((dp2365
g2
(lp2366
VCheck if this feedback article matches your problem
p2367
as(dp2368
g9
V17034
p2369
stp2370
a((dp2371
g2
(lp2372
VRam-disks went the way of the dodo with the file system cache
p2373
aVIt can make much better decisions than a static cache, having awareness of RAM usage by other programs and the position of the disk write head
p2374
aVThe lazy write-back is for free
p2375
as(dp2376
g9
V17034
p2377
stp2378
a((dp2379
g2
(lp2380
VThis worked pretty well, works on multiple monitors, observes the taskbar:
p2381
as(dp2382
g9
V17034
p2383
stp2384
a((dp2385
g2
(lp2386
VThis ought to do the trick:
p2387
as(dp2388
g9
V17034
p2389
stp2390
a((dp2391
g2
(lp2392
VHmm, same question
p2393
aVI'll repeat my post:
p2394
as(dp2395
g9
V17034
p2396
stp2397
a((dp2398
g2
(lp2399
VIt is actually visible
p2400
aVDebug + Other Windows + Registers
p2401
aVLook at the value of EAX (RAX in x64)
p2402
aVThe value of simple integral types are returned in the EAX register
p2403
aVLong in EDX:EAX
p2404
aVFloating point in STx (XMM00 in x64)
p2405
aVThis has been hard to implement, the jitter determines how methods return a value and different jitters will make different choices
p2406
aVParticularly so when the return value type isn't simple, like a struct
p2407
aVIf it is large then the jitter will reserve stack space on the calling method and pass a pointer to that space so the called method can copy the return value there
p2408
aVNevertheless, VS2013 finally made it available, currently available in preview
p2409
aVVisible in the Autos window and by using the  intrinsic variable in the Immediate window and watch expressions
p2410
as(dp2411
g9
V17034
p2412
stp2413
a((dp2414
g2
(lp2415
VThere is a mapping of a managed exception to an HRESULT
p2416
aVConsult the table in this MSDN article
p2417
aVNET retrieves error info from a COM object with IErrorInfo
p2418
aVThat might well work the other way around too
p2419
aVWorth a shot
p2420
as(dp2421
g9
V17034
p2422
stp2423
a((dp2424
g2
(lp2425
VThere is no loading context when you use GenerateInMemory, the assembly gets loaded by the Assembly
p2426
aVLoad(Byte[]) overload
p2427
aVOne workaround is to temporarily hook the AppDomain
p2428
aVAssemblyResolve event so you can load "other_dll" yourself
p2429
as(dp2430
g9
V17034
p2431
stp2432
a((dp2433
g2
(lp2434
VThere's nothing special about MM_ISOTROPIC, it just makes sure that the X- and Y-scaling is identical, even if you give it conflicting values with SetViewportExt() and SetWindowExt()
p2435
aVWhich you don't
p2436
aVI don't think there's any hardware left that doesn't have square pixels
p2437
aVAnyhoo, just make sure you pass equal values to Graphics
p2438
aVScaleTransform()
p2439
as(dp2440
g9
V17034
p2441
stp2442
a((dp2443
g2
(lp2444
VMicrosoft has released a chart control for
p2445
aVNET 3
p2446
aV5
p2447
aVYou can get support at this forum
p2448
as(dp2449
g9
V17034
p2450
stp2451
a((dp2452
g2
(lp2453
VYou don't have a choice, WH_KEYBOARD_LL is the only one you can write in C#
p2454
aVWH_KEYBOARD requires writing a DLL that can be injected in another process
p2455
aVNot possible with managed code, the CLR cannot be initialized properly
p2456
aVAlso consider RegisterHotKey()
p2457
aVSample code is there, you'll find C# further down the page
p2458
as(dp2459
g9
V17034
p2460
stp2461
a((dp2462
g2
(lp2463
VA sequential read is always faster than one that requires a head seek (not position seek)
p2464
aVTypical hard drive perf for sequential read is 50-60 MB/sec, seeking drops that down to a worst-case ~0
p2465
aV4 MB/sec
p2466
aVOnce the drive heads are positioned, you essentially get the data in the cylinder for free
p2467
aVThe file system cache takes advantage of that by pre-reading sectors from a cylinder
p2468
aVHowever, you have no control over the placement of your data on disk cylinders
p2469
aVNor can you guess the drive geometry
p2470
aVNote that throughput can get significantly worse over time when the volume gets fragmented
p2471
aVYou'll need to look for perf by caching data in memory
p2472
aVAt that point, you worry about locality of reference
p2473
as(dp2474
g9
V17034
p2475
stp2476
a((dp2477
g2
(lp2478
VTell the designer to serialize the object itself:
p2479
as(dp2480
g9
V17034
p2481
stp2482
a((dp2483
g2
(lp2484
VThere is no property on a form that gives you access to the MDI client window
p2485
aVBut you can find it back like this:
p2486
aVFrom there, just use its Size property
p2487
as(dp2488
g9
V17034
p2489
stp2490
a((dp2491
g2
(lp2492
VSample C/C++ implementation:
p2493
aVSample C# usage:
p2494
as(dp2495
g9
V17034
p2496
stp2497
a((dp2498
g2
(lp2499
VAdd a new class to your project and post the code shown below
p2500
aVBuild
p2501
aVDrop the new control from the top of the toolbox onto your form
p2502
as(dp2503
g9
V17034
p2504
stp2505
a((dp2506
g2
(lp2507
VThe ToolBox has a nasty habit of collecting garbage
p2508
aVIt was pretty bad in VS2005
p2509
aVBut recently discovered that VS2008 suffers from it too
p2510
aVOn Vista, navigate to c:\u005cusers\u005cyourname\u005cappdata\u005clocal\u005cmicrosoft\u005cvisualstudio\u005c9
p2511
aV0
p2512
aVThere are some hidden files there
p2513
aVThe  and  files seem to be backup files to get out real trouble, there to copy over the hidden toolbox
p2514
aVtbd and toolboxIndex
p2515
aVtbd files
p2516
aVTake a look at the ProjectAssemblies folder
p2517
as(dp2518
g9
V17034
p2519
stp2520
a((dp2521
g2
(lp2522
VYou are stepping into the shoes of Raymond Chen
p2523
aVHe did the exact same thing, writing a Chinese dictionary in unmanaged C++
p2524
aVRico Mariani did too, writing it in C#
p2525
aVMr
p2526
aVMariani made one version
p2527
aVMr
p2528
aVChen wrote 6 versions, trying to match the perf of Mariani's version
p2529
aVHe pretty much rewrote significant chunks of the C/C++ runtime library to get there
p2530
aVManaged code got a lot more respect after that
p2531
aVThe GC allocator is impossible to beat
p2532
aVCheck this blog post for the links
p2533
aVThis blog post might interest you too, instructive to see how the STL value semantics are part of the problem
p2534
as(dp2535
g9
V17034
p2536
stp2537
a((dp2538
g2
(lp2539
VIt's important to see that GC
p2540
aVKeepAlive() cannot solve your problem
p2541
aVThat just extends the lifetime of your object to the statement
p2542
aVYou would have to loop or block for as long as the timer needs to stay alive
p2543
aVAlso beware that the life time of references in local variables is different in the Debug build
p2544
aVThe JIT keeps them life until the end of the method to allow watches to work
p2545
aVProducing tricky "works in debug, doesn't work in release mode" problems
p2546
aVYou'll have to keep a life reference to the timer object
p2547
aVThat's most typically done with a field in a class
p2548
aVLifetime requirements now pass to the class object, it needs to stay alive for as long as the timer is needed
p2549
aVNot usually a problem
p2550
aVIf it is, you'll have to make the reference static
p2551
as(dp2552
g9
V17034
p2553
stp2554
a((dp2555
g2
(lp2556
VSynchronization is very easy in Windows Forms
p2557
aVYou can call Control
p2558
aVInvoke() in the background thread
p2559
aVThe thread will stall until the delegate has finished running on the UI thread
p2560
aVNo sync required at all
p2561
aVIf stalling the thread is a problem, use Control
p2562
aVBeginInvoke()
p2563
aVYou'll have to protect the object(s) you pass to the delegate with a lock if the thread might alter them while it continues running
p2564
aVThat's rarely the case in a producer-consumer scenario, the thread can simply create new objects
p2565
aVDo make sure that you don't Invoke() too often
p2566
aVDo it more frequently than about 1000 times per second and the UI thread will stop pumping Windows messages, being bogged down by handling the invoke requests
p2567
aVSince it is human eyes you're trying to please, invoking more than about 25 times per second is just wasted effort
p2568
aVPool intermediate results in a collection object
p2569
as(dp2570
g9
V17034
p2571
stp2572
a((dp2573
g2
(lp2574
VYou are modifying properties that have a rather large impact on a form
p2575
aVTransparencyKey and FormBorderStyle require changing the window style bits
p2576
aVWindows doesn't allow those style bits to be changed
p2577
aVWindows Forms implements them by completely destroying the window and re-creating it from scratch
p2578
aVNeat trick, but that takes time and the form will be repainted each time you change the style
p2579
aVCausing the unpleasant visual effect you see
p2580
aVTry this:
p2581
aV1
p2582
aVSet Opacity to 0 so the form becomes invisible
p2583
aV2
p2584
aVChange BackColor, no problem
p2585
aV3
p2586
aVChange FormBorderStyle, window gets recreated
p2587
aV4
p2588
aVChange TransparencyKey, window gets recreated
p2589
ag2447
aVChange Opacity to 1, window gets recreated, then visible
p2590
aVFor example:
p2591
as(dp2592
g9
V17034
p2593
stp2594
a((dp2595
g2
(lp2596
VIt is rather odd that the devs with the x64 machine willingly run the 64-bit version
p2597
aVVisual Studio doesn't support Edit+Continue in x64 mode, that's quite a loss
p2598
aVThe workaround for that is simple, set the Platform Target to x86
p2599
aVAutomagically also solving your unmanaged DLL problem
p2600
as(dp2601
g9
V17034
p2602
stp2603
a((dp2604
g2
(lp2605
VCompare the DateTime
p2606
aVDate properties
p2607
as(dp2608
g9
V17034
p2609
stp2610
a((dp2611
g2
(lp2612
VBeware that MSIL was designed to be parsed by a JIT compiler
p2613
aVIt is not very suitable for an interpreter
p2614
aVA good example is perhaps the ADD instruction
p2615
aVIt is used to add a wide variety of value type values: byte, short, int32, int64, ushort, uint32, uint64
p2616
aVYour compiler knows what kind of add is required but you'll lose that type info when generating the MSIL
p2617
aVNow you need to find it back at runtime and that requires checking the types of the values on the evaluation stack
p2618
aVVery slow
p2619
aVAn easily interpreted IL has dedicated ADD instructions like ADD8, ADD16, etc
p2620
as(dp2621
g9
V17034
p2622
stp2623
a((dp2624
g2
(lp2625
VIt is an optimization to make your project compile faster
p2626
aVIt avoids having the compiler load metadata that will never be used
p2627
aVIt's a minor one though, I'd guess at about 50 msec, depending on the speed of your hard drive and the file system cache state
p2628
aVThe C# compiler is smart enough to only emit
p2629
aVassembly references in the metadata of your compiled assembly for assemblies that are actually used
p2630
aVSo you won't generate native images for assemblies you don't use when you run Ngen
p2631
aVexe
p2632
aVThe JIT compiler won't be affected either way, it only loads assemblies as needed to translate the IL
p2633
as(dp2634
g9
V17034
p2635
stp2636
a((dp2637
g2
(lp2638
VYes, the dropdown of a ComboBox is a special window, a LISTBOX
p2639
aVNET doesn't provide a built-in way to get the handle for it, you can P/Invoke SendMessage and send the CB_GETCOMBOBOXINFO message
p2640
aVCOMBOBOXINFO
p2641
aVhwndList contains the handle
p2642
aVNote that there are other controls that behave that way, DateTimePicker for example
p2643
aVAlso note that the window can extend beyond the bounds of your form
p2644
aVThe code in this thread should be helpful to get the P/Invoke right
p2645
as(dp2646
g9
V17034
p2647
stp2648
a((dp2649
g2
(lp2650
VNot sure what's ailing you, neither Click event should run when you set e
p2651
aVCancel in a Validating event handler
p2652
aVBut there's a better way to do this
p2653
aVSet the buttons' CausesValidation property to False
p2654
as(dp2655
g9
V17034
p2656
stp2657
a((dp2658
g2
(lp2659
VThere's something wrong with your message loop
p2660
aVTranslateMessage() is the likely candidate, that's the one that generates WM_CHAR messages from a WM_KEYDOWN message
p2661
as(dp2662
g9
V17034
p2663
stp2664
a((dp2665
g2
(lp2666
VOh, there are plenty of traps
p2667
aVBGW doesn't do much to protect you from the usual hazards of threaded programming
p2668
aVAnd adds some of its own:
p2669
aVVariables that are accessed from both the BGW and the UI thread must be protected by a lock
p2670
aVDo not update a bound data source in a BGW
p2671
aVThe control updates will be done on the BGW thread but will not generate an exception
p2672
aVDon't call ReportProgress() too often
p2673
aVDoing it more than about 1000 times per second will freeze the UI thread
p2674
aVAbout 25 times/sec is enough
p2675
aVCareful with the userstate argument you can pass to ReportProgress()
p2676
aVIt must not be modified by the BGW after the call
p2677
aVDon't loop on the IsBusy property in the UI thread, it will deadlock
p2678
aVThe BGW thread will be aborted when the main form closes
p2679
aVWatch out for necessary cleanup
p2680
aVBe sure to inspect the Error property in the RunWorkerCompleted event, it tells you when something went wrong
p2681
as(dp2682
g9
V17034
p2683
stp2684
a((dp2685
g2
(lp2686
VI don't see how you have to do any calculation:
p2687
as(dp2688
g9
V17034
p2689
stp2690
a((dp2691
g2
(lp2692
VA Control has all the plumbing required to act as a window
p2693
aVThe ability to respond to Window messages (WndProc) and having a Handle being foremost
p2694
aVComponent is missing all that
p2695
aVIt is really rather simple, it has design time support and it can be disposed, that's about it
p2696
aVComponents still can have a runtime representation, OpenFileDialog being the best example
p2697
aVBut that is actually a dialog built into Windows, not Windows Forms
p2698
as(dp2699
g9
V17034
p2700
stp2701
a((dp2702
g2
(lp2703
VThe Font property is an ambient property
p2704
aVIf it was never assigned, it automatically matches the Font property of the container control
p2705
aVYou never assigned it
p2706
aVDo it like this:
p2707
as(dp2708
g9
V17034
p2709
stp2710
a((dp2711
g2
(lp2712
VIMessageFilter
p2713
aVPreFilterMessage() is only called for messages in the message queue
p2714
aVMessages like WM_CLOSE are sent directly to WndProc() with SendMessage(), they bypass the queue
p2715
aVYou also won't get messages like WM_ACTIVATE, WM_GETTEXT, etc
p2716
aVInput events, that's about it
p2717
as(dp2718
g9
V17034
p2719
stp2720
a((dp2721
g2
(lp2722
VEasy:
p2723
aVUniversal:
p2724
as(dp2725
g9
V17034
p2726
stp2727
a((dp2728
g2
(lp2729
VI'll keep it brief, it is already marked answered
p2730
aVC# has the great advantage of having a well defined floating point model
p2731
aVThat just happens to match the native operation mode of the FPU and SSE instruction set on x86 and x64 processors
p2732
aVNo coincidence there
p2733
aVThe JITter compiles Math
p2734
aVSqrt() to a few inline instructions
p2735
aVNative C/C++ is saddled with years of backwards compatibility
p2736
aVThe /fp:precise, /fp:fast and /fp:strict compile options are the most visible
p2737
aVAccordingly, it must call a CRT function that implements sqrt() and checks the selected floating point options to adjust the result
p2738
aVThat's slow
p2739
as(dp2740
g9
V17034
p2741
stp2742
a((dp2743
g2
(lp2744
VJust create your own panel derived control
p2745
aVFake the border by drawing it the way you want it
p2746
aVFor example:
p2747
aVAdd a new class to your project and paste the code show above
p2748
aVCompile
p2749
aVDrop the new control from the top of your toolbox onto your form
p2750
as(dp2751
g9
V17034
p2752
stp2753
a((dp2754
g2
(lp2755
VYou would usually get the advice to use the BackgroundWorker component to implement threading
p2756
aVHere's an example of causing it to deadlock:
p2757
aVThe deadlock occurs because the BGW has to invoke the RunWorkerCompleted event before it finishes
p2758
aVThat cannot happen until the UI thread goes idle
p2759
aVWhich doesn't happen here, it is stuck in the loop waiting for the BGW to complete
p2760
aVJust an example, there are endless ways to get into trouble like this
p2761
as(dp2762
g9
V17034
p2763
stp2764
a((dp2765
g2
(lp2766
VYou don't have to use P/Invoke to do this
p2767
aVThe Form
p2768
aVRegion property was designed for this
p2769
aVA simple example:
p2770
as(dp2771
g9
V17034
p2772
stp2773
a((dp2774
g2
(lp2775
VJust close the modal dialog
p2776
aVIt doesn't get disposed like normal Form instances do so you simply bring it back alive by calling ShowDialog() again
p2777
aVNote that calling Hide() on a modal dialog also closes it
p2778
as(dp2779
g9
V17034
p2780
stp2781
a((dp2782
g2
(lp2783
VThe
p2784
aVNET framework offers a very good generic solution for this
p2785
aVCheck the bottom of this MSDN magazine article
p2786
aVUse the StartupNextInstanceHandler() event handler to pass arbitrary commands to the running instance, like "quit"
p2787
as(dp2788
g9
V17034
p2789
stp2790
a((dp2791
g2
(lp2792
VFound your thread languishing here, thought I'd respond
p2793
aVFor starters, aggregation compares to encapsulation in OOP, but with some significant differences
p2794
aVWhat is nice is that little work is needed in the outer interface to expose an aggregated interface
p2795
aVWhat is not nice is that an interface needs to be designed to be aggregatable from the get-go, a requirement that OOP encapsulation doesn't have
p2796
aVThat limits the odds where you have a COM class laying on the shelf, ready to be borged
p2797
aVFrom my own work, when facing the question whether or not to support aggregation, I've yet to answer "yes, might be useful some day"
p2798
aVThe headaches from implementing the delegating and non-delegating IUnknowns have led me to "no"
p2799
aVYour question about inner interfaces creating objects is easy to answer
p2800
aVAn inner interface is not supposed to know that it got aggregated
p2801
aVMore to the point, it cannot know who aggregated it
p2802
aVIt can thus not know whether or not the outer is at all useful to the object or if it will properly delegate QI
p2803
aVNot a real problem, it can simply hand it an interface pointer to one of its own interfaces
p2804
aVBeing aggregated does not forbid it
p2805
aVOnly unknown interfaces need to be forwarded
p2806
aVBut yes, aggregation isn't very practical
p2807
as(dp2808
g9
V17034
p2809
stp2810
a((dp2811
g2
(lp2812
VDoDragDrop() has a return value
p2813
aVIf it returns DragDropEffects
p2814
aVNone, you'll want to keep your form alive
p2815
as(dp2816
g9
V17034
p2817
stp2818
a((dp2819
g2
(lp2820
VIt is the delegate type for the SystemEvents
p2821
aVUserPreferenceChanged event
p2822
aVThis event fires when Windows broadcasts the WM_SETTINGCHANGE message
p2823
aVWhich typically happens when the user uses a control panel applet and changes a system setting
p2824
aVSeveral controls register an event handler for this event, DataGridView, DateTimePicker, MonthCalendar, ProgressBar, PropertyGrid, RichTextBox, ToolStrip, NumericUpDown
p2825
aVThey typically are interested in font or cue changes and anything that would affect the layout
p2826
aVSystemEvents
p2827
aVUserPreferenceChanged is a static event
p2828
aVRegistering a handler and forgetting to unregister it causes a memory leak, it prevents the control from being garbage collected
p2829
aVThe listed controls ensure this doesn't happen, they unregister the event handler in either the OnHandleDestroyed() or the Dispose() method
p2830
aVYou'll get in trouble when neither of those two methods run
p2831
aVThat will happen when you remove the control from the container's Controls collection and forget to Dispose() it
p2832
aVWhile forgetting to call Dispose() is not normally a problem, it is a hard requirement for controls
p2833
aVIt is easy to forget too, controls are normally automatically disposed by the Form
p2834
aVBut that only happens for controls in the Controls collection
p2835
aVAlso be sure to call Dispose() on forms that you display with the ShowDialog() method, after you obtained the dialog results
p2836
aVThe using statement is the best way to handle that
p2837
as(dp2838
g9
V17034
p2839
stp2840
a((dp2841
g2
(lp2842
VThat's a pretty simple trick, it just replaces the system color that's used for window backgrounds
p2843
aVYou'd change it by P/Invoking the SetSysColor() API function
p2844
aVHere's a sample Windows Forms app that demonstrates the technique
p2845
aVStart a new WF app and drop a button on the form
p2846
aVThen paste this code:
p2847
as(dp2848
g9
V17034
p2849
stp2850
a((dp2851
g2
(lp2852
VIt isn't exactly clear to me why it would crash
p2853
aVUse Debug + Exception, Thrown flag to find out where the ThreadAbort exception is coming from
p2854
aVOne thing is definitely wrong, you should detach the handle when the window is destroyed
p2855
aVYou could do this by watching for the WM_NCDESTROY message:
p2856
as(dp2857
g9
V17034
p2858
stp2859
a((dp2860
g2
(lp2861
VThe painting code for a button is locked up tight in internal classes, you can't override it nor re-use it
p2862
aVThe public ButtonRenderer class doesn't handle disabled buttons
p2863
aVOne thing that could work is playing games with the BackgroundImage property
p2864
aVAdd a new class to your project and paste the code shown below
p2865
aVDrop the new control from the top of the toolbar onto your form
p2866
as(dp2867
g9
V17034
p2868
stp2869
a((dp2870
g2
(lp2871
VThe private keyword means something else than you think
p2872
aVI limits visibility of the ref class beyond the assembly
p2873
aVSince your Main() method is in the same assembly, it has no trouble referencing the type name
p2874
aVNote that the C# language's "internal" keyword means the same thing
p2875
aVI assume that you really intend for these classes to be in a separate assembly someday
p2876
aVAs such, using private is certainly good enough
p2877
aVUsing nested private classes can make a class inaccessible to code in the same assembly
p2878
as(dp2879
g9
V17034
p2880
stp2881
a((dp2882
g2
(lp2883
VThis is a side effect of the way native windows work in Windows
p2884
aVMany of the window options are specified by style flags in the CreateWindowEx() call
p2885
aVBasic stuff, like what the border looks like on a form
p2886
aVWhat kind of View a ListView should have
p2887
aVWhether a TreeView should display checkboxes
p2888
aVThese styles are exposed as properties on a control
p2889
aVBut there's a problem
p2890
aVChanging such a property requires the window to be recreated from scratch so that new style flags can be specified in the CreateWindowEx() call
p2891
aVThat has side effects, the window gets completely recreated so it loses all previous state
p2892
aVWindows Forms does a pretty good job of making this look smooth, restoring the previous state after recreating the window
p2893
aVBut it there are leaks here and there
p2894
aVAnd a few outright bugs
p2895
aVOne leak in TreeView is the exact state of which nodes are collapsed and which are not
p2896
aVKeeping track of this is just not practical
p2897
aVDiagnose this by putting the Handle property of the TreeView in a watch window
p2898
aVIf you see it change, you've found the property
p2899
aVThe list of style flags is available here, you can probably map their names to their corresponding property
p2900
aVPerhaps it is clear that there is no great workaround for this problem, other than avoiding changing that property
p2901
aVTrouble like this is what begat WPF
p2902
as(dp2903
g9
V17034
p2904
stp2905
a((dp2906
g2
(lp2907
VAn MSDN magazine article went into it in detail
p2908
as(dp2909
g9
V17034
p2910
stp2911
a((dp2912
g2
(lp2913
VThe Size property should definitely work
p2914
aVBeware that the form may be rescaled due to differences in the system font or the video adapter DPI setting between the design machine and the production machine
p2915
aVThe real size won't be available until the Load event
p2916
as(dp2917
g9
V17034
p2918
stp2919
a((dp2920
g2
(lp2921
VIt is not a good idea, assuming my machine's GDI+ performance is comparable
p2922
aVThe Form class already supports double buffering through the DoubleBuffered property
p2923
aVIt does a better job than you can do, assuming you don't dip into P/Invoke like it does
p2924
aVMy measurements:
p2925
aV100 random lines, no double
p2926
aVbuffering: 68 msec
p2927
aV100 random lines, double buffering:
p2928
ag2584
aV6 msec
p2929
aVGraphics
p2930
aVDrawImage 800x800x32PArgb,
p2931
aVno double buffering, empty
p2932
aVOnPaintBackground: 9
p2933
aV8 msec
p2934
aVThis will of course change when you draw more than 400 lines
p2935
aVTo get the perf that WF's double buffering gives you you'd have to use the BufferedGraphics class
p2936
aVIt is very unfriendly
p2937
as(dp2938
g9
V17034
p2939
stp2940
a((dp2941
g2
(lp2942
VThe apartment is selected by a call to CoInitializeEx()
p2943
aVA thread in the thread pool has already made that call, changing the apartment after that call is not possible
p2944
aVThat a thread pool would choose MTA makes sense, it is after all intended as a worker thread and shouldn't be blocked by method calls that need to be marshaled
p2945
aVSelecting a single-threaded apartment has the additional requirement of pumping a message loop
p2946
aVSomething you'd never expect a threadpool thread to do
p2947
aVThe message loop is necessary because that's the vehicle that COM uses to marshal a call made on another thread
p2948
aVThat call has to be "injected" in the STA thread, that's only possible if the thread is in a known quiescent state
p2949
aVIf it isn't, such a call would cause major re-entrancy problems
p2950
aVWhich it sometimes does even if the thread is pumping the loop
p2951
aVYou didn't need to pump a message loop yourself with Application
p2952
aVRun() because ShowDialog() starts its own message loop
p2953
aVThat's how it gains modality
p2954
aVThat nested loop exits as soon as the dialog closes
p2955
as(dp2956
g9
V17034
p2957
stp2958
a((dp2959
g2
(lp2960
VYou also need to change Graphics
p2961
aVPixelOffsetMode
p2962
aVIt defaults to None, which is okay for interpolation but not when you blow up the pixels to blocks
p2963
aVChange it to Half
p2964
aVFor example:
p2965
as(dp2966
g9
V17034
p2967
stp2968
a((dp2969
g2
(lp2970
VThe default implementation of Control
p2971
aVDispose (inherited by TabPage) is quite sufficient
p2972
aVIt iterates the child controls as stored in the Controls collection member and calls their Dispose() method
p2973
aVYou don't have to help
p2974
aVThere are only two cases where you should call Dispose() explicitly:
p2975
aVWhen you remove a control from the Controls collection
p2976
aVCalling Dispose() here is a hard requirement
p2977
aVNot doing so will keep the window handle alive for the life of the program, it is just not visible
p2978
aVYou'll have a leak if you don't dispose it
p2979
aVWhen you show a form with ShowDialog()
p2980
aVThis bypasses the normal automatic disposal of a form and its child controls, necessarily so that you can read back the dialog result without risking an ObjectDisposed exception
p2981
aVThe using statement is the proper way to do this
p2982
aVThe latter case is not in fact a leak, the Control class' finalizer ensures that the window handle for the dialog eventually is released, assuming there are no live references left to the dialog object
p2983
aVControl is one of the very few classes where forgetting to call Dispose() can in fact cause an uncontrollable resource leak
p2984
aVYou are correct in that you have to call Dispose() explicitly on your TabPage derived object to dispose it when you remove the page
p2985
aVBut you don't have to worry about its child controls
p2986
as(dp2987
g9
V17034
p2988
stp2989
a((dp2990
g2
(lp2991
VThe SHGetFileInfo() shell function can provide you with the icon you are looking for
p2992
aVThis code worked well, it generated appropriate icons for drives, folders and files:
p2993
as(dp2994
g9
V17034
p2995
stp2996
a((dp2997
g2
(lp2998
VI think you are talking about the /reference:alias=filename option accepted by the C# compiler
p2999
aVThat allows you to rename the root namespace of the assembly
p3000
aVVery handy when you need to reference both an old and a new version of an assembly that otherwise contain classes with the same namespace and class names
p3001
aVWithout that option, you'd always get an ambiguous identifier compile error
p3002
aVThe namespace alias feature can't fix that
p3003
aVNo, VB
p3004
aVNET doesn't have that
p3005
aVWhy
p3006
aVAsk at connect
p3007
aVmicrosoft
p3008
aVcom
p3009
as(dp3010
g9
V17034
p3011
stp3012
a((dp3013
g2
(lp3014
VThere's little reason left to get stuck on a question like this
p3015
aVThe source code is available, titled "Reference Source"
p3016
aVThe best way to get it is with the
p3017
aVNET Mass Downloader
p3018
aVNot every
p3019
aVNET assembly has its source code published, your backup is the venerable Reflector
p3020
aVAnyhoo, the source code looks roughly like this:
p3021
aVSo the answer to your question is: Yes
p3022
as(dp3023
g9
V17034
p3024
stp3025
a((dp3026
g2
(lp3027
VFollowing the standard event generating pattern used in Windows Forms:
p3028
as(dp3029
g9
V17034
p3030
stp3031
a((dp3032
g2
(lp3033
VThere is a possible quick fix for your problem
p3034
aVPaste this code into your form:
p3035
aVThe style flag works on XP SP1 and up
p3036
aVIt double-buffers your entire form, not just each individual control, and should eliminate the ghosting effect you see
p3037
as(dp3038
g9
V17034
p3039
stp3040
a((dp3041
g2
(lp3042
VGetting this right is trickier than it sounds
p3043
aVNo doubt one of the reasons that custom button painting isn't overridable
p3044
aVThis worked as expected:
p3045
as(dp3046
g9
V17034
p3047
stp3048
a((dp3049
g2
(lp3050
VHave you tried this
p3051
aVAll strings parse without a problem in this sample code:
p3052
aVOutput:
p3053
as(dp3054
g9
V17034
p3055
stp3056
a((dp3057
g2
(lp3058
VNot possible
p3059
aVThe expression parser behind the Expression property is simple and not extensible
p3060
aVMaking arbitrary function calls is not one of its capabilities
p3061
aVThere are several ways to work around this, especially ones that don't require an expensive reflection lookup
p3062
aVConsider the DataTable
p3063
aVRowChanged event for example
p3064
as(dp3065
g9
V17034
p3066
stp3067
a((dp3068
g2
(lp3069
VYou can see this with Reflector, the key property is CreateParams and the internal OwnerDraw property
p3070
aVGroupBox normally operates with OwnerDraw = true, except when you set FlatStyle = System
p3071
aVThen you get an old-fashioned Windows group box, a window whose class name is BUTTON with the BS_GROUPBOX style bit turned on
p3072
aVIf you take a look with Spy++, you'll see that the control doesn't get any mouse messages at all
p3073
aVNot sure why this is so, the SDK docs don't mention it
p3074
aVI'd guess this dates back to Windows 2
p3075
aVx where every cycle counted
p3076
aVBut it does explain why the MouseMove event is hidden, it cannot fire when the System style is selected
p3077
aVSame for Click and Up/Down
p3078
aVThe FlatStyle property setter really nails it down by also turning off the Control
p3079
aVUserMouse control style
p3080
aVAnyhoo, if you want mouse messages, you'll need to avoid the System style
p3081
as(dp3082
g9
V17034
p3083
stp3084
a((dp3085
g2
(lp3086
VYes, mouse capture is your problem
p3087
aVYou can fix it by explicitly setting the Control
p3088
aVCapture property to false
p3089
aVFor example:
p3090
as(dp3091
g9
V17034
p3092
stp3093
a((dp3094
g2
(lp3095
VIt works fine if you do this the Windows Forms' way
p3096
aVPaste this code into your form:
p3097
as(dp3098
g9
V17034
p3099
stp3100
a((dp3101
g2
(lp3102
VGetting the progress window consistently displayed on top of the (dead) form is the difficult requirement
p3103
aVThis is normally handled by using the Form
p3104
aVShow(owner) overload
p3105
aVIt causes trouble in your case, WF isn't going to appreciate the owner form belonging to another thread
p3106
aVThat can be worked around by P/Invoking SetWindowLong() to set the owner
p3107
aVBut now a new problem emerges, the progress window goes belly-up as soon as it tries to send a message to its owner
p3108
aVSomewhat surprisingly, this problem kinda disappears when you use Invoke() instead of BeginInvoke() to update progress
p3109
aVKinda, you can still trip the problem by moving the mouse over the border of the disabled owner
p3110
aVRealistically, you'll have to use TopMost to nail down the Z-order
p3111
aVMore realistically, Windows just doesn't support what you are trying to do
p3112
aVYou know the real fix, it is at the top of your question
p3113
aVHere's some code to experiment with
p3114
aVIt assumes you progress form is called dlgProgress:
p3115
aVSample usage:
p3116
as(dp3117
g9
V17034
p3118
stp3119
a((dp3120
g2
(lp3121
VYou don't want a check, it doesn't make sense to have more than one language checked
p3122
aVYou need a radio button
p3123
aVYou can get one by overriding the renderer for the menu strip
p3124
aVYou'll also need to handle the CheckedChanged event of the menu items so only one can be selected
p3125
aVThis code will do the trick:
p3126
as(dp3127
g9
V17034
p3128
stp3129
a((dp3130
g2
(lp3131
VThe right way to do this is to prevent the form from getting visible in the first place
p3132
aVThat requires overriding SetVisibleCore()
p3133
aVLet's assume a context menu for the NotifyIcon with a Show and Exit command
p3134
aVYou can implement it like this:
p3135
aVNote a wrinkle with the Load event, it won't fire until the main form is first shown
p3136
aVSo be sure to do initialization in the form's constructor, not the Load event handler
p3137
as(dp3138
g9
V17034
p3139
stp3140
a((dp3141
g2
(lp3142
VThe only deadlock-safe and exception-safe way to do this that I know is to actually cancel the FormClosing event
p3143
aVSet e
p3144
aVCancel = true if the BGW is still running and set a flag to indicate that the user requested a close
p3145
aVThen check that flag in the BGW's RunWorkerCompleted event handler and call Close() if it is set
p3146
as(dp3147
g9
V17034
p3148
stp3149
a((dp3150
g2
(lp3151
VThere isn't anything really wrong with your code and you followed the correct install procedure, by the sound of it
p3152
aVThe error code you get however clearly indicates that the script interpreter has trouble locating or loading the assembly
p3153
aVThe best way to troubleshoot this is with SysInternals' ProcMon utility
p3154
aVI ran your code without trouble, these were the most relevant entries in the ProcMon log:
p3155
as(dp3156
g9
V17034
p3157
stp3158
a((dp3159
g2
(lp3160
VIt is mentioned in the C# Language Specification, chapter 10
p3161
ag2582
aV5:
p3162
aVThe list of constraints given in a where clause can include any of the following components, in this order : a single primary constraint, one or more secondary constraints, and the constructor constraint, new()
p3163
aVA primary constraint can be a class type or the reference type constraint class or the value type constraint struct
p3164
aVA secondary constraint can be a type-parameter or interface-type
p3165
aVI bolded the relevant phrase
p3166
as(dp3167
g9
V17034
p3168
stp3169
a((dp3170
g2
(lp3171
VHere's some code to experiment with:
p3172
aVOutput on my machine (Win7 32-bit):
p3173
aVA 32-bit operating system provides a process with close to 2 gigabytes of virtual memory
p3174
aVAs you can see, the sample program dies well short of this, consuming only 25% of it
p3175
aVThe problem is virtual memory address space fragmentation
p3176
aVThe available 2 gigabytes needs to store both code and data
p3177
aVYou can get an insight into how the VM is carved up with SysInternal's VMMap utility
p3178
aVThere's something you can do about it with some insight in how StringBuilder works
p3179
aVIt uses an internal array to store the string
p3180
aVThis array is reallocated as needed to store the growing string, doubling the size each time
p3181
aVThe Capacity property tells you the size of that array
p3182
aVThis causes another kind of fragmentation, heap fragmentation
p3183
aVAfter the array is doubled in size, the old array can be collected but produces a "free block" that can't be merged back to become available for a large contiguous allocation
p3184
aVThat's an implementation detail of the Large Object Heap and the Windows heap manager, Google "look-aside cache" to find out more about it
p3185
aVOne workaround is to quickly gobble up virtual memory space before it can get fragmented
p3186
aVRemove the comment to see this at work
p3187
aVOn my machine:
p3188
aVI fine-tuned the Capacity value by experimentation, you may have to do the same to make it work on your machine
p3189
aVThe difference is pretty dramatic, almost 3 times as much
p3190
aVBeware that this is very unlikely to reproduce well in a real program, timing is critical
p3191
aVOr on another machine for that matter, be sure to stay well below the cut-off point
p3192
aVRealistically, you are risking OOM once the buffer you use gets past 134 million characters
p3193
as(dp3194
g9
V17034
p3195
stp3196
a((dp3197
g2
(lp3198
VThere is no "AllowDrag" property, you actively start the D+D with the DoDragDrop() method
p3199
aVAnd the event handlers need to be on the D+D target, not the source
p3200
aVA sample form, it needs a label and a text box:
p3201
as(dp3202
g9
V17034
p3203
stp3204
a((dp3205
g2
(lp3206
VThis problem is caused because you filter the mouse down message but not the mouse up message
p3207
aVYou can fix it like this:
p3208
aVConsider implementing IMessageFilter instead
p3209
as(dp3210
g9
V17034
p3211
stp3212
a((dp3213
g2
(lp3214
VFiltering keys hardly guarantees that the user will input a valid number
p3215
aVA time interval of 0 is probably no good
p3216
aVYou won't be filtering input when the user pressed Ctrl+V
p3217
aVAnd as a programmer, I'm partial to programs that accept 2E3 as valid input
p3218
aVThe Validating event was made to solve this
p3219
aVDrop a couple of text boxes on a form and an ErrorProvider:
p3220
as(dp3221
g9
V17034
p3222
stp3223
a((dp3224
g2
(lp3225
VThis is a classic issue when you use threading
p3226
aVThe form instance variable has the > attribute
p3227
aVWhich causes it to create a new instance of the form when your code runs in a different thread
p3228
aVThis can be hard to detect, the form isn't visible since you didn't call its Show() method
p3229
aVNot that it would work anyway, the thread isn't pumping a message loop
p3230
aVYour workaround has problems of its own
p3231
aVThere's a nasty bug in the Application
p3232
aVOpenForms implementation, it loses track of forms when their window gets recreated
p3233
aVTry this code for example:
p3234
aVThere are many possible fixes for your problem
p3235
aVYou could marshal the call to the UI thread with Control
p3236
aVBegin/Invoke()
p3237
aVAlthough that requires access to a form or control instance, a bit of a chicken-and-egg problem
p3238
aVBest thing to do is to simply pass the form instance to the helper's class constructor:
p3239
aVNow you have the instance you need
p3240
as(dp3241
g9
V17034
p3242
stp3243
a((dp3244
g2
(lp3245
VYou can make it work by detecting clicks on dates and then add or remove the clicked date from the bolded dates
p3246
aVImplement the MonthCalendar's MouseDown event:
p3247
aVJust one problem with this, it flickers like a cheap motel
p3248
aVNo fix for that
p3249
as(dp3250
g9
V17034
p3251
stp3252
a((dp3253
g2
(lp3254
VYou hide your form too soon
p3255
aVFor a brief moment, your app has no window that can contain the focus
p3256
aVThat forces Windows to go hunting for another window to give the focus to, it will pick one from another application
p3257
aVThat window will now be the foreground window, your second form will not get the focus and appear lower in the Z-order
p3258
aVThe fix is simple:
p3259
as(dp3260
g9
V17034
p3261
stp3262
a((dp3263
g2
(lp3264
VSurely you are compiling with UNICODE defined
p3265
aVThen you Log() formatting string is wrong
p3266
aVFix:
p3267
as(dp3268
g9
V17034
p3269
stp3270
a((dp3271
g2
(lp3272
VThe dialog is defined in System
p3273
aVDesign
p3274
aVdll, named "MaskDesignerDialog"
p3275
aVIt is internal so you can't use it directly
p3276
aVReflection can bypass that
p3277
aVTry it out with a sample form, drop a Button and a MaskedTextBox on the form
p3278
aVMake the form's code look like this:
p3279
as(dp3280
g9
V17034
p3281
stp3282
a((dp3283
g2
(lp3284
VI think Explorer puts the tooltip under the cursor's hotspot so you don't have to correct the X-position
p3285
aVThis looked good:
p3286
as(dp3287
g9
V17034
p3288
stp3289
a((dp3290
g2
(lp3291
VYour P/Invoke declarations are wrong, you are using int where IntPtr is required and mixing up idHook and hHook
p3292
aVAfter editing your code, this worked:
p3293
as(dp3294
g9
V17034
p3295
stp3296
a((dp3297
g2
(lp3298
VIt is an odd omission but easily fixed
p3299
aVPaste this in your startup form:
p3300
as(dp3301
g9
V17034
p3302
stp3303
a((dp3304
g2
(lp3305
VThat's a very odd request
p3306
aVThe rub is in the "all" stipulation
p3307
aVSimple enumeration through the HKCR\u005cTypelib key and LoadTypeLib() isn't enough, a COM server is not required to publish a type library
p3308
aVYou would actually have to CoCreateInstance() the coclass and QueryInterface for IDispatch
p3309
aVNot only is this slow, it is also risky
p3310
aVYou might get a better answer if you explain why you would actually contemplate doing something like this
p3311
aVCalling IDispatch::Invoke() without having some kind of idea what the arguments mean or what the side-effects might be is a recipe for disaster
p3312
aVStay away from method names like "ReformatDrive"
p3313
as(dp3314
g9
V17034
p3315
stp3316
a((dp3317
g2
(lp3318
VThere's an excellent blog post available here that discusses the reasons you can get this HRESULT
p3319
as(dp3320
g9
V17034
p3321
stp3322
a((dp3323
g2
(lp3324
VI don't see it but can imagine it's a problem
p3325
aVOverride the renderer so it uses the same background renderer for both menu items and toolstrip items:
p3326
as(dp3327
g9
V17034
p3328
stp3329
a((dp3330
g2
(lp3331
VA Windows Forms control also knows how to render itself, you don't have to jump through the screen capture hoop
p3332
aVMake it look like this:
p3333
as(dp3334
g9
V17034
p3335
stp3336
a((dp3337
g2
(lp3338
VIt is a horrible function signature, there's no way to guess how the string was allocated
p3339
aVNor can you deallocate the memory for the string
p3340
aVIf you declare the return type as "string" in the declaration then the P/Invoke marshaller will call CoTaskMemFree() on the pointer
p3341
aVThat is very unlikely to be appropriate
p3342
aVIt will silently fail in XP but crash your program in Vista and Win7
p3343
aVYou can't even reliably call the function in an unmanaged program
p3344
aVThe odds that you'd use the correct version of free() are pretty slim
p3345
aVAll you can do is declare it as IntPtr and marshal the return value yourself with Marshal
p3346
aVPtrToStringAnsi()
p3347
aVBe sure to write a test program that does so a million times while you observe it in Taskmgr
p3348
aVexe
p3349
aVIf the VM size for the program grows without bound, you have a memory leak you cannot plug
p3350
as(dp3351
g9
V17034
p3352
stp3353
a((dp3354
g2
(lp3355
VYour sledge-hammer approach is the one I've seen used to get this done
p3356
aVAn oops in your code though, the "Shell Icon Size" value is a , not a
p3357
aVAlways VERIFY() the API function return values
p3358
as(dp3359
g9
V17034
p3360
stp3361
a((dp3362
g2
(lp3363
VUsing the Graphics
p3364
aVSetClip() method is the best way
p3365
aVFor example:
p3366
as(dp3367
g9
V17034
p3368
stp3369
a((dp3370
g2
(lp3371
VDon't forget to actually URL-encode the data, like you promised in the ContentType
p3372
aVIt's a one-liner:
p3373
as(dp3374
g9
V17034
p3375
stp3376
a((dp3377
g2
(lp3378
VThere's a strange problem with the string resources in the Resources
p3379
aVresx file
p3380
aVThere's no obvious way that I ever discovered how to create a new resource table for another language with the IDE
p3381
aVIt can be done by hand though
p3382
aVFollow these steps:
p3383
aVProject + Properties, Resource tab,
p3384
aVadd the strings you want to use in
p3385
aVyour program
p3386
aVStart Windows Explorer and navigate
p3387
aVto your project's Properties folder
p3388
aVCopy and paste the Resources
p3389
aVresx
p3390
aVfile
p3391
aVRename it to the culture you want to
p3392
aVuse
p3393
aVFor example:
p3394
aVResources
p3395
aVfr-FR
p3396
aVresx
p3397
aVBack to VS, click the Show All Files
p3398
aVicon in the Solution Explorer window
p3399
aVExpand the Properties node, the new
p3400
aVresource file should be visible
p3401
aVRight-click it and select "Include
p3402
aVin project"
p3403
aVSelect it, in the Properties window
p3404
aVset Custom Tool =
p3405
aVResXFileCodeGenerator"
p3406
aVVerify that Build Action is set to
p3407
aVEmbedded Resource"
p3408
aVBuild your program
p3409
aVYou should get a new folder in your project's bin\u005cDebug directory with the satellite assembly, named projectname
p3410
aVresources
p3411
aVdll
p3412
aVThis satellite assembly contains both the localized strings and any localized resource from the forms
p3413
aVTest that it works with code like this:
p3414
as(dp3415
g9
V17034
p3416
stp3417
a((dp3418
g2
(lp3419
VThere was plenty of agony over this decision, as evident in the comments on this feedback article
p3420
as(dp3421
g9
V17034
p3422
stp3423
a((dp3424
g2
(lp3425
VYou've got an event order problem, the DataGridView
p3426
aVEnter event fires too soon
p3427
aVThis can be cleanly solved by delaying event actions with the Control
p3428
aVBeginInvoke() method
p3429
aVIts delegate target fires as soon as your program re-enters the message loop
p3430
aVIn other words, after all pending events have fired
p3431
aVMake it look similar to this:
p3432
as(dp3433
g9
V17034
p3434
stp3435
a((dp3436
g2
(lp3437
VThe declaration makes no sense
p3438
aVIt would make sense if the function takes a pointer to an array of doubles, but then the declaration would be
p3439
aVWhere size would give the size of the array allocated by the client and the function's return value indicates how many doubles were actually copied into the array
p3440
aVThe equivalent P/Invoke declaration would be:
p3441
aVYou have to allocate the array with new to the size you promised before calling the function
p3442
aVBut the double** argument is a hangup
p3443
aVIt could mean that the function returns a pointer to an array of doubles but then the size argument makes little sense
p3444
aVSince it is the function that owns the array and controls its size
p3445
aVOr it could mean that the client passes a two-dimensional array, but then having only one size argument makes no sense
p3446
aVPlease update your question with the correct interpretation of what the function does
p3447
as(dp3448
g9
V17034
p3449
stp3450
a((dp3451
g2
(lp3452
VDeclare an event in the user control and have the button's Click event raise it:
p3453
aVNow the form that hosts the user control can subscribe to the event and update the text box as needed:
p3454
as(dp3455
g9
V17034
p3456
stp3457
a((dp3458
g2
(lp3459
s(dp3460
g9
V17034
p3461
stp3462
a((dp3463
g2
(lp3464
VThis will work well for almost any native C++ code
p3465
aVIt will get translated to IL, just like managed code, and get JIT compiled at runtime
p3466
aVYou can freely call managed code, thanks to C++ interop
p3467
aVThe only unmanaged code construct I know that can't be compiled is the __fastcall keyword
p3468
aVThere's an issue with the const keyword, it is imperfectly simulated with attributes, but that's only an issue when you import metadata
p3469
aVJust keep using header files like you do now
p3470
aVA
p3471
aVNET assembly is capable of storing machine code as well as IL
p3472
aVYou can take advantage of this by selectively turning off IL generation for cases where the compiler has trouble or when you suspect generated code isn't optimal
p3473
aVWrap your code with a #pragma:
p3474
aVYou will also need to use this #pragma when you #include headers for
p3475
aVlibs that were compiled separately without the /clr compile option
p3476
as(dp3477
g9
V17034
p3478
stp3479
a((dp3480
g2
(lp3481
VAny of the IPC mechanisms qualify to get this done
p3482
aVIf your needs a simple, just message passing, consider either a named pipe (NamedPipeServerStream) or a socket
p3483
aVIf they are elaborate, consider Remoting over an IPC channel or WCF
p3484
aVPersonally, I like named pipes for this
p3485
aVJust make sure the pipe name is prefixed by "Global\u005c" so it is visible from the interactive desktop session
p3486
aVEncrypt the messages if security is a concern
p3487
aVSpin up a background thread in your service that makes a blocking call on the pipe stream to implement the message handling
p3488
as(dp3489
g9
V17034
p3490
stp3491
a((dp3492
g2
(lp3493
VYes, this is by design and is closely associated with the way Windows Forms works
p3494
aVIn a Winforms app, code runs in response to messages posted to the active window by Windows
p3495
aVEvery native Windows app contains a message loop to detect these messages
p3496
aVThe Winforms plumbing ensures one of your event handlers runs in response; button1_Click in your example code
p3497
aVMost Winforms controls implement their own event handlers
p3498
aVA PictureBox for example has a Paint event handler that ensures its Image is drawn to the screen
p3499
aVThis is all done automatically, you don't have to write any code yourself to make this work
p3500
aVThere is however a problem when this code throws an exception, there is no way for you to catch such an exception since none of your own code was involved
p3501
aVIn other words, there is no place for you to inject your own try block
p3502
aVThe very last bit of your own program's code that was involved is the code that got the message loop started
p3503
aVThe Application
p3504
aVRun() method call, normally in Program
p3505
aVcs
p3506
aVOr the Form
p3507
aVShowDialog() call if you display a dialog
p3508
aVEither of those methods start a message loop
p3509
aVPutting a try block around the Application
p3510
aVRun() call isn't useful, the app will terminate after catching an exception
p3511
aVTo combat this problem, the Winforms message loop code contains a try block around the code that dispatches an event
p3512
aVIts catch clause displays the dialog you mentioned, it is implemented by the ThreadExceptionDialog class
p3513
aVGetting to the point of your question: this catch clause really gets in the way of troubleshooting problems with your code when you debug
p3514
aVThe debugger will only stop on an exception when there is no catch block that handles the exception
p3515
aVBut when your code throws an exception, you'll want to know about it when you debug
p3516
aVThe previously mentioned code in the message loop is aware whether or not a debugger is attached
p3517
aVIf it is, it dispatches events without the try/catch block
p3518
aVNow, when your code throws an exception, there is no catch clause to handle it and the debugger will stop the program, giving you a chance to find out what went wrong
p3519
aVPerhaps you see now why your program behaves the way it does
p3520
aVWhen you debug, the catch clause in the message loop is disabled, giving the catch clause in the Form1 code a chance to catch the exception
p3521
aVWhen you don't, the message loop catch clause handles the exception (by displaying the dialog) and prevents the exception from unwinding to the Form1 code
p3522
aVYou can prevent the message loop catch clause from being used at all by calling the Application
p3523
aVSetUnhandledExceptionMode() method, passing UnhandledExceptionMode
p3524
aVThrowException
p3525
aVDo so in the Main() method, before the Application
p3526
aVRun() call
p3527
aVNow your program will behave the same either way
p3528
aVThis is in general not a bad idea, giving the user the option to Continue in the exception dialog is a questionable feature
p3529
aVDo implement an event handler for AppDomain
p3530
aVUnhandledException event in that case so there's at least some diagnostic to the user
p3531
as(dp3532
g9
V17034
p3533
stp3534
a((dp3535
g2
(lp3536
VTo get notifications for all windows, not just Windows Forms ones, you'll need to use a hook set by the SetWindowsHookEx() API function
p3537
aVYou'll need a  hook so you can see the WM_MOVE message that Windows sends to the window
p3538
aVUnfortunately, that's a global hook
p3539
aVThe code that implements the hook callback needs to be packaged into a DLL so that it can be injected into all target processes
p3540
aVThat shoots a hole into your plans to use C# for this, you can't inject the CLR
p3541
aVThe DLL must be written in unmanaged code
p3542
aVThis code project offers an approach, including the unmanaged injectable DLL you'll need
p3543
as(dp3544
g9
V17034
p3545
stp3546
a((dp3547
g2
(lp3548
VYes, you'll need the KeyPress event
p3549
aVOr rather, override OnKeyPress
p3550
aVMapping virtual key codes in the KeyDown event to key strokes is quite difficult, you'd have to be aware of the current keyboard layout
p3551
aVTake a look at the MSDN docs for ToUnicodeEx() to see what you are up against
p3552
aVYou don't have to worry about keystroke combinations like Alt+L
p3553
aVThey don't generate a KeyPress event
p3554
aVHere's an example
p3555
aVStart a new Windows Forms project and make the code look like this:
p3556
as(dp3557
g9
V17034
p3558
stp3559
a((dp3560
g2
(lp3561
VChild controls have a Parent property
p3562
aVIf you delete their parent, Windows Forms automatically calls Dispose() on the children as well
p3563
aVWhich is one reason you never have to explicitly call Dispose() yourself on the child controls when you close a form
p3564
aVGetting what you want is easy enough, add the children to the form with the this
p3565
aVControls
p3566
aVAdd() method
p3567
aVWF automatically removes them from the groupbox since a child control can have only one Parent
p3568
aVSome sample code:
p3569
as(dp3570
g9
V17034
p3571
stp3572
a((dp3573
g2
(lp3574
VI can't repro this problem with a simple test form that uses your layout and property settings
p3575
aVThe form's client area is shrunk at start-up and grows as needed to make the group box visible when I set its Visible property to true
p3576
aVYou can ask for an explicit layout recalculation with the PerformLayout() method
p3577
as(dp3578
g9
V17034
p3579
stp3580
a((dp3581
g2
(lp3582
VNET latches the active time zone the very first time you retrieve the time
p3583
aVIt does this to prevent code that depends on a steadily increasing value for DateTime
p3584
aVNow from getting a heart-attack
p3585
aVUpdating the latched value requires calling System
p3586
aVGlobalization
p3587
aVCultureInfo
p3588
aVClearCachedData() and System
p3589
aVTimeZoneInfo
p3590
aVClearCachedData()
p3591
as(dp3592
g9
V17034
p3593
stp3594
a((dp3595
g2
(lp3596
VThis fine print in the SDK docs for LowLevelKeyboardProc is crucial:
p3597
aVThis hook is called in the context of the thread that installed it
p3598
aVThe call is made by sending a message to the thread that installed the hook
p3599
aVTherefore, the thread that installed the hook must have a message loop
p3600
aVIn other words, you must keep the thread alive and the thread must pump a message loop
p3601
aVThe behavior you see now is entirely by design
p3602
as(dp3603
g9
V17034
p3604
stp3605
a((dp3606
g2
(lp3607
VThis could be a debugger side-effect
p3608
aVThe ReaderWriterLockSlim class is very sensitive to the current thread ID (Thread
p3609
aVManagedThreadId)
p3610
aVI can't state for a fact that the debugger will always use the current active thread to evaluate the watch expressions
p3611
aVIt usually does, but there might be different behavior, say, if you entered the debugger with a hard break
p3612
aVTrust what the code does first of all, your Debug
p3613
aVAssert proves the point
p3614
as(dp3615
g9
V17034
p3616
stp3617
a((dp3618
g2
(lp3619
VIf the date format in your input data is fixed to month/day/year and does not depend on the current culture, you should use DateTime
p3620
aVTryParseExact:
p3621
as(dp3622
g9
V17034
p3623
stp3624
a((dp3625
g2
(lp3626
VWhy
p3627
aVYou are asking the server to do work, it's doing the work
p3628
aVMaking it twice as slow doesn't make sense
p3629
aVLeave it up to SQL Server to schedule its jobs, you can't do it yourself since you don't know what kind of jobs are active
p3630
as(dp3631
g9
V17034
p3632
stp3633
a((dp3634
g2
(lp3635
VYour code snippet as posted cannot work
p3636
aVIf this was compiled with a C++ compiler then the function name would be
p3637
aVFoo@@YA_NXZ and your C# code could never find it
p3638
aVThe calling convention is important too, it is not the default (CallingConvention
p3639
aVStdCall) unless you tell the compiler
p3640
aVAnd somewhere you should have told the linker to export the function
p3641
aVStart by declaring the exported function so it is compatible with default P/Invoke attributes:
p3642
aVNext problem is that the C++ compiler uses only one byte to store a bool
p3643
aVThe machine code generated for your return statement is:
p3644
aVThe P/Invoke marshaller will however assume it is a 32-bit integer and check the value of the eax register
p3645
aVEither declare the return type of the function as int or BOOL or use a [return: MarshalAs(UnmanagedType
p3646
aVU1)] attribute in the C# declaration
p3647
as(dp3648
g9
V17034
p3649
stp3650
a((dp3651
g2
(lp3652
VThis sample control works like that:
p3653
as(dp3654
g9
V17034
p3655
stp3656
a((dp3657
g2
(lp3658
VYou can do it through the designer
p3659
aVAdd an ImageList to your form and set its TransparentColor property
p3660
aVAdd the image
p3661
aVSet the button's ImageList and ImageIndex properties
p3662
as(dp3663
g9
V17034
p3664
stp3665
a((dp3666
g2
(lp3667
VNo, a "full case mapping" is a casing where one codepoint needs to be replaced by more than one new codepoints
p3668
aVA simple case mapping is a single codepoint substitution
p3669
aVIf you want to implement this yourself then the Unicode CaseFolding
p3670
aVtxt file is crucial to get this right
p3671
aVNote the status field code "T", specifically there to handle the Turkish I problem
p3672
as(dp3673
g9
V17034
p3674
stp3675
a((dp3676
g2
(lp3677
VThe ToolTip control already supports this
p3678
aVThe key is that the control for which you display the tip has a right-to-left layout
p3679
aVThis example form demonstrates this:
p3680
as(dp3681
g9
V17034
p3682
stp3683
a((dp3684
g2
(lp3685
VThis is a
p3686
aVNET exception message
p3687
aVHmm, you definitely tagged it as C++
p3688
aVI'd guess you found a bug in your IDE or whatever tool you use to build your project
p3689
as(dp3690
g9
V17034
p3691
stp3692
a((dp3693
g2
(lp3694
VDid you try Win32_LogicalDisk
p3695
aVMediaType
p3696
aVIt has specific enumerations for floppy disks
p3697
aVMake sure you try it when there's no disk in the drive
p3698
as(dp3699
g9
V17034
p3700
stp3701
a((dp3702
g2
(lp3703
VVS2010 converts project and solution files, doesn't it
p3704
aVThen you don't have a problem since you can't use the project file with VS2008 anyway
p3705
aVJust change the linker's Output File setting
p3706
aVOtherwise, you probably should just consider adding another configuration to your solution
p3707
as(dp3708
g9
V17034
p3709
stp3710
a((dp3711
g2
(lp3712
VThe documented supported OS list is not accurate, this works fine on Win7 when I try it
p3713
aVI can't think of any reason it wouldn't be supported on any other OS, it is easy to find out with the Win32 API (GetTimeZoneInformation)
p3714
aVYou can use WmiCodeCreator for a quick check
p3715
as(dp3716
g9
V17034
p3717
stp3718
a((dp3719
g2
(lp3720
VReadIntervalTimeout = max time between two bytes
p3721
aVReadTotalTimeoutConstant = max time for a multi-byte read to complete
p3722
aVReadTotalTimeoutMultiplier = extra time allowed for each byte in a multi-byte read
p3723
aVSince you specified a strict limit on the inter-character delay, you'll want to only set ReadIntervalTimeout
p3724
aVOdd btw, the usual limit is a time-out on a message
p3725
as(dp3726
g9
V17034
p3727
stp3728
a((dp3729
g2
(lp3730
VIt is jumping because the act of scrolling the panel will throw off the mouse position by the scroll amount
p3731
aVYou can get the "real" mouse position (relative from the upper left corner of the panel) like this:
p3732
aVassuming the picture box' Location property is (0, 0)
p3733
aVThe best way to scroll the panel is to set its AutoScrollPosition property
p3734
as(dp3735
g9
V17034
p3736
stp3737
a((dp3738
g2
(lp3739
VYou can't take the address of a managed object
p3740
aVThe garbage collector can move it around in memory, invalidating the pointer value at any time
p3741
aVAt a minimum you would have to pin the object first
p3742
aVShort from me not being able to come up with a valid syntax, pinning just to make a method call cannot be desirable
p3743
aVYou'll need to declare the argument as a tracking handle:
p3744
as(dp3745
g9
V17034
p3746
stp3747
a((dp3748
g2
(lp3749
VThe code you linked assumes the members are declared as properties
p3750
aVYou didn't declare properties
p3751
aVYou can make it work with Reflection:
p3752
as(dp3753
g9
V17034
p3754
stp3755
a((dp3756
g2
(lp3757
VUse bit fields to do this
p3758
aVIt avoids having to use the macros, nice in the debugger too:
p3759
as(dp3760
g9
V17034
p3761
stp3762
a((dp3763
g2
(lp3764
VYou forgot to use a backing field for the properties
p3765
aVThe property setter uses the property itself, recursing endlessly
p3766
aVFix it like this:
p3767
aVOr use the automatic property syntax:
p3768
as(dp3769
g9
V17034
p3770
stp3771
a((dp3772
g2
(lp3773
VI'll re-emphasize the fact that your C++ code is invalid
p3774
aVYou are returning a pointer to a local variable on a stack frame that is no longer valid when the function returns
p3775
aVThat it works now is merely an accident
p3776
aVAs soon as you call another function, the stack space will be reused, corrupting the buffer content
p3777
aVThis is guaranteed to happen when you call this code from C#, the P/Invoke marshaller implementation will overwrite the stack frame and corrupt the buffer
p3778
aVTo make matters worse, the P/Invoke marshaller will try to free the buffer
p3779
aVIt will assume that the buffer was allocated by CoTaskMemAlloc() and call CoTaskMemFree() to release the buffer
p3780
aVThat will silently fail on Windows XP and earlier but crash your program on Vista and up
p3781
aVWhich is one solution to your issue, use CoTaskMemAlloc() to allocate the buffer instead of using a local variable
p3782
aVThe all-around better solution is to let the caller of the function pass the buffer, to be filled with the string
p3783
aVThat way, the caller can decide how to allocate the buffer and clean it up as necessary
p3784
aVThe function signature should look like this:
p3785
aVUse strcpy_s() to safely fill the buffer and avoid any buffer overflow
p3786
aVThe corresponding C# declaration would then be:
p3787
aVand called like this:
p3788
as(dp3789
g9
V17034
p3790
stp3791
a((dp3792
g2
(lp3793
VYou'll need to P/Invoke GetWindow() in a loop, using GW_HWNDNEXT
p3794
aVKeep looping until you find a window whose GetWindowRect() contains the cursor position or you hit the desktop window
p3795
aVWatch out for Aero lying about window rectangles
p3796
as(dp3797
g9
V17034
p3798
stp3799
a((dp3800
g2
(lp3801
VThis code in the app constructor worked well:
p3802
as(dp3803
g9
V17034
p3804
stp3805
a((dp3806
g2
(lp3807
VYes, that can happen
p3808
aVIt is probably a ContainerControl that's messing up your focus, Form is derived from it
p3809
aVA ContainerControl goes hunting for a control to focus when it gets an activation event
p3810
aVIt likes nested child controls, it will definitely skip your Panel if it has any controls
p3811
aVThe logic involved in WF to handle focus is very complicated, most of all due to validation
p3812
aVYou'd be best off by staying out of trouble and avoid ever giving a Panel the focus
p3813
aVIt isn't designed to be a focusable control, it has no way to indicate focus to the user
p3814
aVThis is enforced by it having the ControlStyles
p3815
aVSelectable style turned off and the TabStop property set to false so the user can never focus it by tabbing or clicking
p3816
aVThe Enter event won't help, the Panel gets Enter both when it gets the focus or when one of its child controls get the focus
p3817
aVEither by the user tabbing or when you use the Focus() method
p3818
aVYou'd have to wait until all focus events are done firing, something you can do with Control
p3819
aVBeginInvoke() or a Timer
p3820
aVWell, I'm sure that doesn't help much but your problem description is fuzzy
p3821
aVBest way to proceed is to post a sample project that exhibits this behavior to a file sharing service or, as indicated, avoid ever trying to give a parent control the focus
p3822
as(dp3823
g9
V17034
p3824
stp3825
a((dp3826
g2
(lp3827
VThis is really, really ancient
p3828
aVODBC dates from the stone age, back when Windows starting taking over from MS-DOS
p3829
aVBack then, lots of text was still encoded in the original IBM-PC character set, named the "OEM Character Set" by Microsoft
p3830
aVThe standard IBM-PC set had some accented characters and pseudo graphics glyphs in the upper half, codes 0x80-0xff
p3831
aVToo limited for text output in non-English languages, Microsoft started using code pages, ranges of character glyphs suitable for a certain language group
p3832
aVThe American English set of characters were standardized by ANSI, that label is now attached (incorrectly) to any non-OEM code page
p3833
aVNobody encodes text in the OEM character set anymore, it went the way of the dodo at least 10 years ago
p3834
aVThe proper setting here is ANSI
p3835
aVAnd keeping your fingers crossed behind your back that the code page used to encode the text matches your system's default code page
p3836
aVThat's dodo too, Unicode solved it
p3837
as(dp3838
g9
V17034
p3839
stp3840
a((dp3841
g2
(lp3842
VCOM is threading aware and will honor the threading model requested by the coclass
p3843
aVIt publishes its threading requirements with the ThreadingModel value in the registry
p3844
aVIf it is set to "Apartment" (or is missing), COM will make sure all method calls are made from a single threaded apartment by returning a proxy for the interfaces you QI
p3845
aVThe proxy ensures the call is marshaled to the correct thread
p3846
aVYou could cheat and use the interface pointer that you got when you created the coclass in an STA thread and make calls without marshaling
p3847
aVGiven that the coclass already said it isn't capable of multi-threading, this is very unlikely to work correctly
p3848
aVYou'll just randomly corrupt internal state
p3849
as(dp3850
g9
V17034
p3851
stp3852
a((dp3853
g2
(lp3854
VI don't have Express handy to check this
p3855
aVBut it is not a build option in the retail edition, you add a manifest with Project + Add New Item, Application Manifest File
p3856
aVIf you don't see it in the list of item templates, you can add it by hand after building with the mt
p3857
aVexe tool from the Windows SDK
p3858
aVGet basic command line syntax help with mt
p3859
aVexe /
p3860
aVYou'll need to use resource ID #1 for a
p3861
aVexe
p3862
aVBeware that VS2008 already adds a manifest to keep the
p3863
aVexe compatible with Vista UAC
p3864
aVYour replacement manifest should contain the  element
p3865
as(dp3866
g9
V17034
p3867
stp3868
a((dp3869
g2
(lp3870
VNo, you don't have to worry about it
p3871
aVThe handle returned by, say, OpenProcess, ShellExecuteEx() or CreateProcess keeps the process object alive
p3872
aVThat's how it is possible to call GetExitCodeProcess() to retrieve the exit code after the process is terminated
p3873
aVThe object doesn't get released until the last handle on it is closed
p3874
aVOpposite of earlier advice given in this thread, it is very important that you call CloseHandle() or you'll have a leak
p3875
as(dp3876
g9
V17034
p3877
stp3878
a((dp3879
g2
(lp3880
VGiven that you want to convert from the sealed String type, you can ignore possible nullable, boxing, reference and explicit conversions
p3881
aVOnly  qualifies
p3882
aVA more generic approach is provided by the System
p3883
aVLinq
p3884
aVExpressions
p3885
aVExpression class:
p3886
aVBeware the cost of Reflection
p3887
as(dp3888
g9
V17034
p3889
stp3890
a((dp3891
g2
(lp3892
VSPI_GETSCREENSAVESECURE is 0x76, not 76
p3893
as(dp3894
g9
V17034
p3895
stp3896
a((dp3897
g2
(lp3898
VWell, there are no attractive options here
p3899
aVThere is no documented way to retrieve the file handle you need from the process
p3900
aVAlthough there are undocumented ones, go there (via DuplicateHandle) only with careful consideration
p3901
aVYes, calling FlushFileBuffers on a volume handle is the documented way
p3902
aVYou can avoid the privilege problem by letting a service make the call
p3903
aVTalk to it from your app with one of the standard process interop mechanisms
p3904
aVA named pipe whose name is prefixed with Global\u005c is probably the easiest way to get that going
p3905
as(dp3906
g9
V17034
p3907
stp3908
a((dp3909
g2
(lp3910
VListen for the  message in your main window
p3911
aVIt is sent to all top-level windows when a monitor is added or removed
p3912
aVYou'll get  when the resolution is changed
p3913
as(dp3914
g9
V17034
p3915
stp3916
a((dp3917
g2
(lp3918
VIt is a horrible hack, as wicked as the C# one, but it does work:
p3919
aVNote that the BlankLinesBetweenMembers option is crucial to make the hack work
p3920
aVOutput:
p3921
as(dp3922
g9
V17034
p3923
stp3924
a((dp3925
g2
(lp3926
VGoogle "System
p3927
aVNet
p3928
aVPeerToPeer", a namespace available in the
p3929
aVNET 3
p3930
aV5 framework
p3931
aVYou'll have no trouble finding docs and sample code
p3932
as(dp3933
g9
V17034
p3934
stp3935
a((dp3936
g2
(lp3937
VHere's a sample form
p3938
aVGet started with a new WF project and drop two list boxes on the form
p3939
aVMake the code look like this:
p3940
as(dp3941
g9
V17034
p3942
stp3943
a((dp3944
g2
(lp3945
VThe cursor will change to WaitCursor but that will survive only a fraction of a second
p3946
aVThe problem is that hiding your main form makes the cursor overlap the window that's behind your main form
p3947
aVOr the desktop
p3948
aVThe revealed window gets a WM_SETCURSOR message from Windows and it will change the cursor to its preferred shape
p3949
aVBut there's a bigger problem with your approach
p3950
aVAfter the dialog closes, there's a fraction of a second where no window in your app is visible
p3951
aVWindows is forced to find another window to give the focus to, it won't be a window in your app
p3952
aVWhen your main form again becomes visible, it may well end up behind the window that got the focus
p3953
aVThis behavior tends to be a bit flaky, you might not yet have found it
p3954
aVYou can solve both problems by hiding the window a different way:
p3955
as(dp3956
g9
V17034
p3957
stp3958
a((dp3959
g2
(lp3960
VConvert -842150450 to hex to find back one of the magic values used in the CRT in the debug build
p3961
aVThat helps finding the bug in your code:
p3962
aVThere are plenty other bugz btw, good luck fixing them
p3963
as(dp3964
g9
V17034
p3965
stp3966
a((dp3967
g2
(lp3968
VThe problem is that you ignoring how the text is aligned inside the control
p3969
aVDefault alignment is roughly equal to StringFormat
p3970
aVAlignment = StringAlignment
p3971
aVCenter, it can be changed for buttons and check boxes with their TextAlign property
p3972
aVYou'll need to use the DrawString() overload that takes a Rectangle and a StringFormat
p3973
aVNote that TextBox is tricky, you might still be off by a few pixels
p3974
aVTake a look at Control
p3975
aVDrawToBitmap() for a completely different approach
p3976
as(dp3977
g9
V17034
p3978
stp3979
a((dp3980
g2
(lp3981
VYes, that's possible:
p3982
as(dp3983
g9
V17034
p3984
stp3985
a((dp3986
g2
(lp3987
VOverriding InitializeLifetimeServices and returning null would be the normal approach
p3988
aVI doubt that's possible in your case
p3989
aVIncluding the  element in the app
p3990
aVconfig file is another approach
p3991
as(dp3992
g9
V17034
p3993
stp3994
a((dp3995
g2
(lp3996
VI'll assume you wrote your ActiveX control in unmanaged C++ code
p3997
aVYou'll need to either create a 64-bit version of this control or you need to force the
p3998
aVNET program that uses it to run in 32-bit mode
p3999
aVThe latter is the quicker fix, Project + Properties, Build tab, Platform Target = x86
p4000
as(dp4001
g9
V17034
p4002
stp4003
a((dp4004
g2
(lp4005
VYes, this is possible
p4006
aVAdd a new class to your project and paste the code shown below
p4007
aVCompile
p4008
aVDrop the new control from the top of the toolbox onto your form
p4009
as(dp4010
g9
V17034
p4011
stp4012
a((dp4013
g2
(lp4014
VYou'll have to pass GetType(DerivedClass) to the serializer constructor, it must match the type of the object you serialize
p4015
aVYou can use the  attribute to rename to the root element
p4016
aVThis example code worked as intended:
p4017
as(dp4018
g9
V17034
p4019
stp4020
a((dp4021
g2
(lp4022
VYou should have no trouble finding possible live references in your code, they will be fields in your class(es)
p4023
aVOr local variables in the cleanup method, that's unlikely
p4024
aVThe list provided in the link are just objects that you most likely will store in a field
p4025
aVThere could be others, they'll keep Excel just as alive as the Application object
p4026
aVI don't think I'd recommend the jackhammer approach as advocated in the link, it just hides a potential life reference to an RCW that wraps a dead COM interface
p4027
aVA best you'll have a possibly permanent leak to the RCW object, at worst it crashes your program with an exception when it accidentally references the object
p4028
aVBugz, to be sure, just not ones you'll easily discover
p4029
aVAll you have to do is set your references to null, order doesn't matter, then collect
p4030
as(dp4031
g9
V17034
p4032
stp4033
a((dp4034
g2
(lp4035
VI think the fix mentioned in the article that Jason linked to has something to do with your code working on later releases
p4036
aVI don't have access to the pre-SP1 version of Enumerable
p4037
aVCast so it is a bit hard to guess
p4038
aVOne thing's for sure: once the code makes it into Enumerable
p4039
aVCastIterator() then it is guaranteed not to work in your case
p4040
aVThat sets up an iterator to convert IEnumerable to IEnumerable<> and that iterator calls GetEnumerator() to initialize the iterator block
p4041
aVThat can only call Dictionary
p4042
aVGetEnumerator(), not yours
p4043
aVCasting the KeyValuePair that this IEnumerable returns to Data will of course fail, as the exception tells you
p4044
aVThe current version of Enumerable
p4045
aVCast() first tries to cast IEnumerable to IEnumerable<>
p4046
aVAnd that works
p4047
aVCastIterator() isn't used
p4048
as(dp4049
g9
V17034
p4050
stp4051
a((dp4052
g2
(lp4053
VThat's not possible
p4054
aVIf you already know where the header is stored when you write the code then you should include the path in the #include directive
p4055
as(dp4056
g9
V17034
p4057
stp4058
a((dp4059
g2
(lp4060
V"cwick" is quite right, Windows posts the WM_MOUSWHEEL notification to the window that has the focus
p4061
aVIt works when you put a button in the panel because it can get the focus
p4062
aVThe next thing that happens is that Windows keeps looking for a Parent control to take the message
p4063
aVButton won't care for it, it's Parent is the panel and it will happily scroll and consume the message
p4064
aVOther than doctoring with the child controls' ability to take focus (you'll have to override them and call SetStyle(ControlStyles
p4065
aVSelectable)), you could consider changing the way this message gets handled
p4066
aVMany commercial apps seemingly don't have this problem (browsers, Office apps) because they have only a few windows
p4067
aVWF apps usually have a lot, one for each control
p4068
aVDo so by processing the message early, before it gets sent to the focused control
p4069
aVThe IMessageFilter interface allows this
p4070
aVThis sample code scrolls the control under the mouse instead of the control that has the focus:
p4071
aVBeware that this code is active for any window in your app
p4072
aVMake sure you try it and verify that it won't confuse the user too much
p4073
as(dp4074
g9
V17034
p4075
stp4076
a((dp4077
g2
(lp4078
VUse the culture explicitly in the ToString() method
p4079
aVFor example:
p4080
aVUse CultureInfo
p4081
aVNumberFormat to format numbers
p4082
as(dp4083
g9
V17034
p4084
stp4085
a((dp4086
g2
(lp4087
VCopy your project to another directory and start another instance of Visual Studio
p4088
aVCopy the
p4089
aVresx file back when you're done
p4090
aVYou could also consider using WinRes
p4091
aVexe, the stand-alone localizer
p4092
aVIt's available in the Windows SDK's bin directory
p4093
as(dp4094
g9
V17034
p4095
stp4096
a((dp4097
g2
(lp4098
VMeasureText adds padding, the amount is fairly unpredictable although it roughly scales linearly with the font size
p4099
aVThe trick is to subtract two measurements to get rid of the padding
p4100
aVThis code generated very happy numbers:
p4101
aVOutput:
p4102
aVThat gets you the 7 pixels you're looking for
p4103
aVBeware that you'll have to accommodate TrueType hinting, it can adjust the shape of the digit so that its main stems fall on pixel boundaries
p4104
aVAdd at least one pixel
p4105
as(dp4106
g9
V17034
p4107
stp4108
a((dp4109
g2
(lp4110
VYes, by the "x" and "y" arguments
p4111
aVUse EnumDisplayMonitors (pass two nulls) to enumerate the monitors
p4112
aVYour MonitorEnumProc callback gets a RECT* to the monitor's display rectangle
p4113
aVYou'd get a negative RECT
p4114
aVright if a monitor is located at the left of your main one
p4115
as(dp4116
g9
V17034
p4117
stp4118
a((dp4119
g2
(lp4120
VThe "not supported" clause in the linked article is telling you that you can't call Microsoft Support and complain because you used Regedit
p4121
aVexe incorrectly and messed up the machine
p4122
aVIt doesn't say that font linking isn't supported
p4123
aVYou can't really affect another program negatively by doing this
p4124
aVFont linking doesn't replace glyphs, only substitute missing ones
p4125
aVSuch a program would previously not render text correctly
p4126
aVIt will show readable text after you're done
p4127
aVThey'll buy you a very nice dinner and some dancing girls
p4128
as(dp4129
g9
V17034
p4130
stp4131
a((dp4132
g2
(lp4133
VYour use of the  and  members to index the array is not okay
p4134
aVYou can use the return value of InterlockedXxxx() to get a safe index
p4135
aVYou'll need to lose IsEmpty(), it can never be accurate in a multi-threading scenario
p4136
aVSame problem with the empty check in PopXxx
p4137
aVI don't see how you could make that work without a mutex
p4138
as(dp4139
g9
V17034
p4140
stp4141
a((dp4142
g2
(lp4143
VYour description is too vague to give a good diagnostic
p4144
aVBut the ThreadPool was designed to carefully throttle the number of active threads
p4145
aVIt will avoid running more threads than you have CPU cores
p4146
aVOnly when a thread gets "stuck" will it schedule an extra thread
p4147
aVThat explains why you see the number of threads not increase wildly
p4148
aVAnd, indirectly, why the handle count stays stable because the machine is doing less work
p4149
as(dp4150
g9
V17034
p4151
stp4152
a((dp4153
g2
(lp4154
VNET does in fact support the moral equivalent of a static
p4155
aVlibrary
p4156
aVIt's called a netmodule (file extension is usually
p4157
aVnetmodule)
p4158
aVRead more about it in this blog post
p4159
aVBeware that it isn't well supported by the Visual Studio
p4160
aVbuild tool chain
p4161
aVI think extension methods are a
p4162
aVproblem as well
p4163
aVILMerge is the better tool to get this
p4164
aVdone
p4165
as(dp4166
g9
V17034
p4167
stp4168
a((dp4169
g2
(lp4170
VYou'll need to get the bootstrapper installed
p4171
aVThe recommended procedure for doing so it pretty idiotic
p4172
as(dp4173
g9
V17034
p4174
stp4175
a((dp4176
g2
(lp4177
VTableLayoutPanel
p4178
as(dp4179
g9
V17034
p4180
stp4181
a((dp4182
g2
(lp4183
VI can't think of a clean solution to your problem
p4184
aVYou'd have to write fugly code like this:
p4185
aVYuck
p4186
aVYou really ought to have an individual callback method for each delegate type
p4187
aVA generic method cannot help here, the constraint cannot be a delegate type
p4188
aVA lambda in the BeginInvoke method call doesn't look that much better:
p4189
aVNah
p4190
aVI'd tackle this by using only one delegate type
p4191
aVThe WaitCallback type is suitable, although mis-named, you should write little helper classes that store the arguments for the delegate target so you can pass it through the WaitCallback
p4192
aVstate argument
p4193
aVYour second problem is induced because you are creating the ImageViewer instance in the callback method
p4194
aVThe callback executes on a threadpool thread, not the UI thread
p4195
aVInvokeRequired returns false because the PictureBox control was created on the threadpool thread
p4196
aVThis threadpool thread is however not suitable to display UI components, it doesn't pump a message loop
p4197
aVAnd has the wrong apartment state
p4198
aVAnd it terminates too soon
p4199
aVInvokeRequired will return the proper value (true) when you use a Control that was created on the UI thread
p4200
aVYour main startup form for example
p4201
aVOr Application
p4202
aVOpenForms[0]
p4203
aVThere's little point in using InvokeRequired however, you know for a fact that the callback executes on the wrong thread
p4204
aVJust use BeginInvoke directly
p4205
aVThe invoked method should create the ImageViewer instance
p4206
aVYou are well on your way re-inventing the BackgroundWorker class
p4207
aVIt does exactly what you are trying to do
p4208
aVBut takes care of the gritty details of getting the RunWorkerCompleted event fired on the correct thread
p4209
aVYou ought to consider it
p4210
as(dp4211
g9
V17034
p4212
stp4213
a((dp4214
g2
(lp4215
VRight, the metadata that's used to initialize the attribute is immutable
p4216
aVBut you can add properties and methods to an attribute class that can run code and return relevant info after the attribute object is constructed
p4217
aVThe data they rely on doesn't have to be stored in metadata, it can be persisted anywhere
p4218
aVOf course, such code wouldn't have to be part of the attribute class implementation, it could just as well be part of the code that instantiates the attribute
p4219
aVWhich is where it belongs
p4220
as(dp4221
g9
V17034
p4222
stp4223
a((dp4224
g2
(lp4225
VYou can remove inherited properties from the Properties window with the [Browsable] attribute:
p4226
aVNote the difference between the two, you have to use the "new" keyword if the property isn't virtual
p4227
aVYou can use the [EditorBrowsable(false)] attribute to also hide the property from IntelliSense
p4228
as(dp4229
g9
V17034
p4230
stp4231
a((dp4232
g2
(lp4233
VThe Size attribute you gave in the [StructLayout] attribute is a good hint
p4234
aVVerify that with this snippet:
p4235
aVThe only way you are going to get passed this assertion is when you replace "bool" with "byte" (So TBool = 1 byte) and use a packing of 1:
p4236
aVIf that still doesn't work then you'll really have to debug the unmanaged code
p4237
as(dp4238
g9
V17034
p4239
stp4240
a((dp4241
g2
(lp4242
VMicrosoft Word is required to load the
p4243
aVdoc and generate the preview image of document
p4244
aVEmbedding Word in your own window used to be possible but support for this is rapidly disappearing
p4245
aVThe old DsoFramer control used to be the standard solution but you can no longer download it
p4246
aVIt got removed when the Office 2010 beta became available, an ominous sign
p4247
aVEmbedding it in a WebBrowser might still be possible, not sure
p4248
aVThe long term solution is to use Word itself to generate the preview
p4249
aVUse the Document
p4250
aVPrintPreview() method
p4251
as(dp4252
g9
V17034
p4253
stp4254
a((dp4255
g2
(lp4256
VIt is automatic in the C# IDE
p4257
aVSetting Copy Local = True on the assembly reference ensures that the satellite assemblies get copied as well
p4258
aVIn the C++ IDE it is a setting: Framework + References, Build properties category, "Copy Local Satellite Assemblies"
p4259
aVThere's not enough info in your question to narrow down which IDE you use or why it wouldn't work for you
p4260
aVMaybe that 3rd party is doing something non-standard
p4261
aVGive them a call
p4262
as(dp4263
g9
V17034
p4264
stp4265
a((dp4266
g2
(lp4267
VI don't think there's a way for the service to get its hands on the WindowsIdentity
p4268
aVToken handle it would need to call the CreateProcessAsUser() API function
p4269
aVUnless the app itself provides it
p4270
aVThere's a better way, you don't have to terminate the app to replace its executable files
p4271
aVAll you have to do is rename them
p4272
aVYou can then put the updates in place and signal the app to restart itself
p4273
aVAnother nice advantage of this approach is that the app voluntarily shuts down (including notifying the user) instead of getting rudely aborted
p4274
aVClean up the renamed files when you see the process terminated
p4275
as(dp4276
g9
V17034
p4277
stp4278
a((dp4279
g2
(lp4280
VIt's possible by watching the ValueChanged event and override the value
p4281
aVThis sample form worked well:
p4282
as(dp4283
g9
V17034
p4284
stp4285
a((dp4286
g2
(lp4287
VBy far the most common mistake is forgetting to turn on the hardware handshake signals
p4288
aVThe device won't send anything if it thinks the host is turned off
p4289
aVMake sure you set the SerialPort
p4290
aVDtrEnable and RtsEnable properties to true
p4291
aVAs mentioned before, fix the array size
p4292
aVAlthough it probably won't help, the STX character ensures that junk is thrown away
p4293
aVCheck if basic hardware is okay with the Windows Hyperterminal applet
p4294
aVYou can send the message you are trying to transmit by typing Ctrl+B, ABC, Ctrl+D
p4295
as(dp4296
g9
V17034
p4297
stp4298
a((dp4299
g2
(lp4300
VIn all likelihood, your client's machines are already updated to
p4301
aVNET 3
p4302
aV5 SP1
p4303
aVWindows Update automatically updates any machine with
p4304
aVNET 2
p4305
aV0 through 3
p4306
ag2447
aVIf that didn't happen then your client's IT staff is blocking updates
p4307
aVIn which case you should leave it up to them to deploy it, you can't reasonably deploy updates yourself that the IT staff intentionally blocked
p4308
aVMore background info in this blog post
p4309
as(dp4310
g9
V17034
p4311
stp4312
a((dp4313
g2
(lp4314
VThe problem is that the C/C++ languages do not give you a way to see whether the function produces or consumes data and whether an argument pointer points to a single value or an array of values
p4315
aVLearning the languages or studying P/Invoke don't really help with this, although it gives you a better shot at guessing it right
p4316
aVYou can only resolve this is by learning more about the specific native code for which you are writing a P/Invoke declaration
p4317
aVThat requires its source code and some familiarity with the language
p4318
aVOr a good working relationship with the code's original author or owner
p4319
aVAdam Nathan's book is the standard reference
p4320
as(dp4321
g9
V17034
p4322
stp4323
a((dp4324
g2
(lp4325
VUsing pinned memory in this case is not a good idea, given that the memory for the struct needs to be valid for a long time
p4326
aVGCHandle
p4327
aVAlloc() will box the structure and store it on the heap
p4328
aVWith it being pinned, it will be a long term burden to the garbage collector as it needs to constantly find a way around the rock in the road
p4329
aVThe simple solution is to allocate memory for the struct in unmanaged memory
p4330
aVUse Marshal
p4331
aVSizeOf() to get the size of the structure and Marshal
p4332
aVAllocCoTaskMem() to allocate the memory
p4333
aVThat gets you the pointer you need to pass to the unmanaged code
p4334
aVInitialize the memory with Marshal
p4335
aVStructureToPtr()
p4336
aVAnd read updates to the structure written by the unmanaged code with PtrToStructure()
p4337
aVIf you do this frequently, you'll be constantly copying the structure
p4338
aVThat could be expensive, depending on the size of the structure
p4339
aVTo avoid that, use an unsafe pointer to access the unmanaged memory directly
p4340
aVSome basic syntax:
p4341
as(dp4342
g9
V17034
p4343
stp4344
a((dp4345
g2
(lp4346
VHmya, you are getting a picture painted here that's a bit too rosy
p4347
aVFinalizers are not guaranteed to run in
p4348
aVNET either
p4349
aVTypical mishaps are a finalizer that throws an exception or a time-out on the finalizer thread (2 seconds)
p4350
aVThat was a problem when Microsoft decided to provide
p4351
aVNET hosting support in SQL Server
p4352
aVThe kind of application where restarting the app to solve resource leaks isn't considered a viable workaround
p4353
aVNET 2
p4354
aV0 acquired critical finalizers, enabled by deriving from the CriticalFinalizerObject class
p4355
aVThe finalizer of such a class must adhere to the rulez of constrained execution regions (CERs), essentially a region of code where exceptions are suppressed
p4356
aVThe kind of things you can do in a CER are very limited
p4357
aVBack to your original question, finalizers are necessary to release operating system resources other than memory
p4358
aVThe garbage collector manages memory very well but doesn't do anything to release pens, brushes, files, sockets, windows, pipes, etc
p4359
aVWhen an object uses such a resource, it must make sure to release the resource after it is done with it
p4360
aVFinalizers ensure that happens, even when the program forgot to do so
p4361
aVYou almost never write a class with a finalizer yourself, operating resources are wrapped by classes in the framework
p4362
aVThe
p4363
aVNET framework also has a programming pattern to ensure such a resource is released early so the resource doesn't linger around until the finalizer runs
p4364
aVAll classes that have finalizers also implement the IDisposable
p4365
aVDispose() method, allowing your code to release a resource explicitly
p4366
aVThis is often forgotten by a
p4367
aVNET programmer but that doesn't typically cause problems because the finalizer ensures it will eventually be done
p4368
aVMany
p4369
aVNET programmers have lost hours of sleep worrying whether or not all Dispose() calls are taken care of and massive numbers of threads have been started about it on forums
p4370
aVJava folks must be a happier lot
p4371
aVFollowing up on your comment: exceptions and timeouts in the finalizer thread is something that you don't have to worry about
p4372
aVFirstly, if you find yourself writing a finalizer, take a deep breath and ask yourself if you're on the Right Path
p4373
aVFinalizers are for framework classes, you should be using such a class to use an operating resource, you'll get the finalizer built into that class for free
p4374
aVAll the way down to the SafeHandle classes, they have a critical finalizer
p4375
aVSecondly, finalizer thread failures are gross program failures
p4376
aVSimilar to getting an OutOfMemory exception or tripping over the power cord and unplugging the machine
p4377
aVThere isn't anything you can do about them, other than fixing the bug in your code or re-route the cable
p4378
aVIt was important for Microsoft to design critical finalizers, they can't rely on all programmers that write
p4379
aVNET code for SQL Server to get that code right
p4380
aVIf you fumble a finalizer yourself then there is no such liability, it will be you that gets the call from the customer, not Microsoft
p4381
as(dp4382
g9
V17034
p4383
stp4384
a((dp4385
g2
(lp4386
VThere's a "trustinfo" dangling in your snippet
p4387
aVMake it look like this:
p4388
as(dp4389
g9
V17034
p4390
stp4391
a((dp4392
g2
(lp4393
VJust mix up the keywords a bit to arrive at the correct syntax
p4394
aVabstract goes in the front in C# but at the end in C++/CLI
p4395
aVSame as the override keyword, also recognized today by C++11 compliant compilers which expect it at the end of the function declaration
p4396
aVLike  does in traditional C++ to mark a function abstract:
p4397
as(dp4398
g9
V17034
p4399
stp4400
a((dp4401
g2
(lp4402
VWell, it is technically easy to do by iterating the tab pages' Control collection and multiply the Point and Size properties by the scaling factor
p4403
aVBut that gets to be awfully tricky once you start to account for the Dock and Anchor properties
p4404
aVBy far the simplest approach is to let the Form class scaling machinery do the job for you
p4405
aVYou'll need to add the controls to the tab pages before the Load event runs
p4406
aVDo this in the constructor
p4407
aVQuick tip to avoid the pain of switching the DPI setting to test your code: add this to your form constructor to invoke the rescaling logic:
p4408
as(dp4409
g9
V17034
p4410
stp4411
a((dp4412
g2
(lp4413
VNot sure what ComboBox
p4414
aVSelectedValue means, it has a SelectedItem property
p4415
aVThat would not be set when you add an item, only when the user makes a selection
p4416
aVThe Items property is a collection of System
p4417
aVObject
p4418
aVThat allows a combo box to store and display any kind of class object
p4419
aVBut you'll have to cast it from object to your class type to use the selected object in your code
p4420
aVThat can't work in your case, you added an object of an anonymous type
p4421
aVYou'll need to declare a small helper class to store the Value and Text properties
p4422
aVSome sample code:
p4423
as(dp4424
g9
V17034
p4425
stp4426
a((dp4427
g2
(lp4428
VThere's a lock inside GDI+ that prevents two threads from accessing a bitmap at the same time
p4429
aVThis is not a blocking kind of lock, it is a "programmer did something wrong, I'll throw an exception" kind of lock
p4430
aVYour threads are bombing because you are cloning the image (== accessing a bitmap) in all threads
p4431
aVYour UI thread is bombing because it is trying to draw the bitmap (== accessing a bitmap) at the same time a thread is cloning it
p4432
aVYou'll need to restrict access to the bitmap to only one thread
p4433
aVClone the images in the UI thread before you start the BGWs, each BGW needs its own copy of the image
p4434
aVUpdate the PB's Image property in the RunWorkerCompleted event
p4435
aVYou'll lose some concurrency this way but that's unavoidable
p4436
as(dp4437
g9
V17034
p4438
stp4439
a((dp4440
g2
(lp4441
VYou'll have to add support to the ListView class so you can be notified about scroll events
p4442
aVAdd a new class to your project and paste the code below
p4443
aVCompile
p4444
aVDrop the new listview control from the top of the toolbox onto your form
p4445
aVImplement a handler for the new Scroll event
p4446
aVBeware that the scroll position (ScrollEventArgs
p4447
aVNewValue) isn't meaningful, it depends on the number of items in the ListView
p4448
aVI forced it to 0
p4449
aVFollowing your requirements, you want to watch for the ScrollEventType
p4450
aVEndScroll notification to know when the user stopped scrolling
p4451
aVAnything else helps you detect that the user started scrolling
p4452
aVFor example:
p4453
as(dp4454
g9
V17034
p4455
stp4456
a((dp4457
g2
(lp4458
VJust implement the panel's Paint event and draw a border
p4459
aVFor example:
p4460
aVPlay around with the arguments to find something you like
p4461
aVYou ought to add code to fallback to ControlPaint
p4462
aVDrawBorder if visual styles aren't enabled
p4463
aVMeh
p4464
as(dp4465
g9
V17034
p4466
stp4467
a((dp4468
g2
(lp4469
VYou are using the wrong event, you should be using KeyPressed
p4470
aVThat fires when the user presses actual typing keys
p4471
aVKeyDown is useless here, the virtual key gets translated to a typing key according to the keyboard layout
p4472
aVHard to guess what that might be unless you translate the keystroke yourself
p4473
aVThat's hard
p4474
aVSome code:
p4475
aVThe \u005cb is required to allow the user to backspace
p4476
as(dp4477
g9
V17034
p4478
stp4479
a((dp4480
g2
(lp4481
VThe Enter key has strictly defined use in UI design, it executes the "accept" action of a dialog
p4482
aVIn the designer, select the form and set the AcceptButton to your button
p4483
aVNo code is required
p4484
aVNote that the CancelButton has a similar usage, it is hard-wired to the Escape key
p4485
as(dp4486
g9
V17034
p4487
stp4488
a((dp4489
g2
(lp4490
VWriteableBitmap has explicit support for threading
p4491
aVBut you have to follow the protocol, use the Lock() method in the thread to gain access to the BackBuffer
p4492
as(dp4493
g9
V17034
p4494
stp4495
a((dp4496
g2
(lp4497
VYou can do it without modifying the source code
p4498
aVOpen the auto-started project in Visual Studio and set a breakpoint
p4499
aVStart Regedit
p4500
aVexe and add a key to "HKLM\u005cSoftware\u005cMicrosoft\u005cWindows NT\u005cCurrentVersion\u005cImage File Execution Options" with the exact same name as your
p4501
aVexe
p4502
aVAdd a new string value named "Debugger", set it to "c:\u005cWindows\u005csystem32\u005cvsjitdebugger
p4503
aVexe"
p4504
aVAn example
p4505
aVreg file:
p4506
aVNow, when your app starts the process, the JIT debugger prompt shows up
p4507
aVSelect the Visual Studio instance that has the auto-started project loaded
p4508
aVExecution will stop at the breakpoint
p4509
aVNote that you usually have to change the focus back to VS yourself
p4510
aVMike Stall has warned that this trick doesn't work for managed only debugging
p4511
aVI cannot reproduce that, it works fine in VS2008 SP1
p4512
as(dp4513
g9
V17034
p4514
stp4515
a((dp4516
g2
(lp4517
VYou can do this with a Panel
p4518
aVSet AutoScroll = true and AutoScrollMinSize
p4519
aVHeight = pages x control
p4520
aVHeight
p4521
aVImplement the Scroll event handler and look at the -AutoScrollPosition
p4522
aVY property to find out what the user is looking at
p4523
aVChange the Location property of the 3 controls and their Page property as necessary
p4524
as(dp4525
g9
V17034
p4526
stp4527
a((dp4528
g2
(lp4529
VThe article you linked gives you all the info you need to properly host a Form in an unmanaged app
p4530
aVYou should look for the source of the AV elsewhere
p4531
aVGet that started by using the debugger
p4532
aVYou can force it to stop on the exception with the Debug + Exceptions dialog, Thrown checkbox
p4533
aVThe STA requirement is almost always sufficient to keep an ActiveX control operating properly in a multi-threaded application
p4534
aVIt provides the guarantee that all method calls are made on the exact same thread in which the coclass was created
p4535
aVIn other words, any instance variables inside the coclass implementation are guaranteed to be used in a thread-safe manner
p4536
aVOne guarantee you don't have here though is whether the control properly handles global state
p4537
aVInstance variables are safe, global variables are not when you use the control in different threads
p4538
aVA possible workaround for that is to use only one thread instead of one STA thread for each form instance
p4539
aVThat's a bit tricky, you'll need an invisible helper form that manages the thread
p4540
aVKeeping it alive and creating new form instances through its Invoke() method
p4541
aVBefore you go there, find out what's crashing first
p4542
as(dp4543
g9
V17034
p4544
stp4545
a((dp4546
g2
(lp4547
VThere are two sources of exception message text
p4548
aVFirst are string resources in mscorlib
p4549
aVdll, the second is text generated by Windows itself with the FormatMessage() API
p4550
aVThe error code for your example is 183,
p4551
aVMscorlib
p4552
aVdll does contain a dedicated string resource for that error:
p4553
aVNo linefeed in that message
p4554
aVThe code that generates the exception message (System
p4555
aVIO
p4556
aVWinIOError) first checks if there's a meaningful file name to generate for the {0} composite formatting argument
p4557
aVApparently that fails in your program, that's a bit odd
p4558
aVThe fallback is the Windows error message produced by FormatMessage() and it's not quite formatted the same way as the resource strings as you found it
p4559
aVIt could be argued that this is a bug, you could report it at connect
p4560
aVmicrosoft
p4561
aVcom
p4562
aVThe odds that this will get fixed are zero though
p4563
aVThere's some soul out there that is parsing the Message property, especially since this is an IOException
p4564
aVTrimming like you did is a good workaround
p4565
as(dp4566
g9
V17034
p4567
stp4568
a((dp4569
g2
(lp4570
VIt is specifically mentioned in the Visual Basic Language Specification, chapter 2
p4571
ag2588
aV2:
p4572
aVAnnotation
p4573
aV> There isn\u2019t a type
p4574
aVcharacter for Byte because the most
p4575
aVnatural character would be B, which is
p4576
aVa legal character in a hexadecimal
p4577
aVliteral
p4578
aVWell, that's true I guess
p4579
aV"Octet" got voted down too, no doubt
p4580
aVUse Return CByte(
p4581
aV, it is cheaper than ToByte()
p4582
as(dp4583
g9
V17034
p4584
stp4585
a((dp4586
g2
(lp4587
VYou have to tell the designer that it should also serialize the properties of the button:
p4588
aVThe default is Hidden so none of the button properties would be written to the Designer
p4589
aVcs file
p4590
aVSetting, say, the Text property works in the designer but the property value is lost after you start the app or reload the form
p4591
as(dp4592
g9
V17034
p4593
stp4594
a((dp4595
g2
(lp4596
VIt is not just a mouse capture, that would be easy to work around
p4597
aVThere's an internal class named "ModalMenuFilter" that is activated when a toolstrip dropdown is displayed that filters various messages
p4598
aVIncluding WM_MOUSEMOVE
p4599
aVIt does this by using SetWindowsHookEx()
p4600
aVIt works when your app isn't active because this hook is only installed when your form is active
p4601
aVNone of this is accessible from your code, you'd have to use Reflection
p4602
aVLooks to me that you can use ModalMenuFilter
p4603
aVRemoveActiveToolStrip() to disable the filter
p4604
aVHave a look-see with Reflector
p4605
aVThis more than likely causes other problems however
p4606
as(dp4607
g9
V17034
p4608
stp4609
a((dp4610
g2
(lp4611
VThis is not a
p4612
aVNET problem, it is a consequence of the way COM works
p4613
aVIt doesn't support inheritance
p4614
aVYou would fix this at the client side, it needs to call QueryInterface() with the IID for IBaseClass to get an interface pointer to the IBaseClass interface so it can call GetA()
p4615
aVNET interop automatically provides a QI implementation that makes this work
p4616
aVHowever, it is not very user-friendly in this case, design your C# side code to make it easy for the client to use your class instead of the other way around
p4617
aVYou'd typically need a one-liner override method that delegates to the base C# class implementation
p4618
aVNote that there's a problem with your method signatures and the use of the [PreserveSig] attribute
p4619
aVThey are not callable through IDispatch nor can they be auto-marshaled
p4620
aVThat requires a method with a HRESULT as the return value type
p4621
aVIt is automatic when you remove the attribute
p4622
as(dp4623
g9
V17034
p4624
stp4625
a((dp4626
g2
(lp4627
VYou are getting this exception because your thread is accessing controls
p4628
aVThat's not legal, control properties must only ever be accessed from the UI thread
p4629
aVYou're okay on the TextBox
p4630
aVText property, that one happens to be cached
p4631
aVBut not ComboBox
p4632
aVSelectedIndex
p4633
aVAnd closing the form from another thread is going to bomb too
p4634
aVYour mutex has nothing to do with it, but keep it if you want to prevent threads from overlapping
p4635
aVUsing a delegate's Invoke method isn't going to solve it, that just starts a thread as well
p4636
aVYou'll need to collect the info that the thread is going to need in a little helper class and pass that as the argument to the Thread
p4637
aVStart() method
p4638
aVClosing the form is a bit tricky too, the user might well have already closed it while the thread was running
p4639
aVThat's going to cause an ObjectDisposed exception
p4640
aVA quick fix is to set the form's Enabled property to false so the user can't close it
p4641
aVYou'll need to use the form's Invoke() method to ensure the closing is done on the UI thread
p4642
aVLast but not least, if these threads don't take a lot of time (a second or so), consider not using threads at all and display a wait cursor instead
p4643
as(dp4644
g9
V17034
p4645
stp4646
a((dp4647
g2
(lp4648
VThe API function that causes the exception is ReadConsoleOutput()
p4649
aVThe SDK doc has some relevant small print:
p4650
aVlpBuffer:
p4651
aVA pointer to a destination buffer that
p4652
aVreceives the data read from the
p4653
aVconsole screen buffer
p4654
aVThis pointer is
p4655
aVtreated as the origin of a
p4656
aVtwo-dimensional array of CHAR_INFO
p4657
aVstructures whose size is specified by
p4658
aVthe dwBufferSize parameter
p4659
aVThe total
p4660
aVsize of the array must be less than
p4661
aV64K
p4662
aVI bolded the relevant phrase
p4663
aVYour program will bomb when it tries to scroll more than 200 lines (201 x 80 x 4 = 64320 bytes, oddly off a bit from 65536)
p4664
aVIt is arguably a bug in the Console
p4665
aVMoveBufferArea(), it doesn't check for this limitation nor tries to work around it which would be easy to do
p4666
aVYou can report the bug at connect
p4667
aVmicrosoft
p4668
aVcom
p4669
aVFor now, you'll have to limit the number of lines so the buffer size doesn't exceed the limit
p4670
as(dp4671
g9
V17034
p4672
stp4673
a((dp4674
g2
(lp4675
VAutomatic disposal is available as an option
p4676
aVThe form must be an "owned" form
p4677
aVThe easiest way to do this is to use the Form
p4678
aVShow(owner) overload:
p4679
aVOr you can do it afterwards with the Form
p4680
aVAddOwnedForm() method
p4681
aVBeware that this has side-effects, an owned form is always shown in front of the owner
p4682
aVAnd it will get minimized and restored along with the owner
p4683
aVIf you don't want this, you can keep explicit track of the lifetime of the form and dispose it yourself:
p4684
as(dp4685
g9
V17034
p4686
stp4687
a((dp4688
g2
(lp4689
VThis is a remarkably persistent complaint
p4690
aVThe source of the leak was ToolStrip installing an event handler for the SystemEvents
p4691
aVUserPreferenceChanged event
p4692
aVSo that it can respond to the user changing the theme or color scheme and redraw itself
p4693
aVThis is a static event, forgetting to unregister the event handler will permanently leak the ToolStrip instance
p4694
aVThe bug has definitely been fixed in
p4695
aVNET 3
p4696
aV5 SP1
p4697
aVThe ToolStrip
p4698
aVDispose() method unregisters the event handler
p4699
aVIf that's the version you are running, make sure that the Dispose() method indeed runs
p4700
aVA common mistake is to use Controls
p4701
aVRemove() to remove a control from a form but then forgetting to call Dispose() on the removed control
p4702
as(dp4703
g9
V17034
p4704
stp4705
a((dp4706
g2
(lp4707
VHere's a textbox control that supports a RightMargin property
p4708
aVTested on Win7:
p4709
as(dp4710
g9
V17034
p4711
stp4712
a((dp4713
g2
(lp4714
VWell, you can
p4715
aVYou'll need to obtain a Graphics context for the parent form or container
p4716
aVIt is easy to get one with Control
p4717
aVCreateGraphics()
p4718
aVBut it won't work well, especially when you run on XP or with Aero disabled
p4719
aVThe parent will draw its background without regard for your pixels, wiping them out when it is told to repaint itself
p4720
aVVery visibly if you move another window across your form
p4721
aVYou could work around this by letting the parent notify the control that it did so, passing the e
p4722
aVGraphics object in the OnPaintBackground and OnPaint overrides to the control
p4723
aVNot pretty
p4724
aVHaving a control draw itself on the background of a container was common back in the ActiveX control days
p4725
aVThey were known as "windowless controls", common in VB6 for example
p4726
aVBack then, that was necessary to keep programs performant
p4727
aVIt made a bit of a comeback in
p4728
aVNET 2
p4729
aV0 with the ToolStripItem class
p4730
aVAnd WPF of course
p4731
aVCommon in browsers too
p4732
aVWriting such controls is however not easy, it takes a lot of code to replace the functionality provided by a window and the Control class
p4733
aVToolStripXxx is notable for the large number of bugz in its code
p4734
as(dp4735
g9
V17034
p4736
stp4737
a((dp4738
g2
(lp4739
VDid you add the database file to your project
p4740
aVSelect it and in the Properties window change its Copy property from Always to If Newer
p4741
as(dp4742
g9
V17034
p4743
stp4744
a((dp4745
g2
(lp4746
VTabControl has fairly unusual processing to handle the Tab key
p4747
aVIt overrides the ProcessKeyPreview() method to detect Ctrl/Shift/Tab, then implements the tab selection in its OnKeyDown() method
p4748
aVIt does this so it can detect the keystroke both when it has the focus itself as well as any child control
p4749
aVAnd to avoid stepping on custom Tab key processing by one of its child controls
p4750
aVYou can make it work by overriding ProcessCmdKey() but then you'll break child controls that want to respond to tabs
p4751
aVBest thing to do is to override its OnKeyDown() method
p4752
aVAdd a new class to your project and paste the code shown below
p4753
aVCompile
p4754
aVDrop the new tab control from the top of the toolbox onto your form
p4755
aVBeware that you also ought to consider Ctrl+PageUp and Ctrl+PageDown
p4756
as(dp4757
g9
V17034
p4758
stp4759
a((dp4760
g2
(lp4761
VThere are implicit race conditions in your code
p4762
aVThe control can be disposed between your IsDisposed test and the InvokeRequired test
p4763
aVThere's another one between InvokeRequired and Invoke()
p4764
aVYou can't fix this without ensuring the control outlives the life of the thread
p4765
aVGiven that your thread is generating data for a list view, it ought to stop running before the list view disappears
p4766
aVDo so by setting e
p4767
aVCancel in the FormClosing event and signaling the thread to stop with a ManualResetEvent
p4768
aVWhen the thread completes, call Form
p4769
aVClose() again
p4770
aVThread
p4771
aVAbort() is a distant second choice but much easier to implement
p4772
aVUsing BackgroundWorker makes it easy to implement the thread completion logic
p4773
as(dp4774
g9
V17034
p4775
stp4776
a((dp4777
g2
(lp4778
VCalling EndInvoke on the returned IAsyncResult reference is very important
p4779
aVIt is the only way to find out if the delegate target finished executing without any exceptions
p4780
aVIf you don't, such an exception will fall into the bit-bucket and your program will silently fail to execute properly
p4781
aVYou can call EndInvoke either on the same thread that called BeginInvoke() or you can do it in a callback
p4782
aVCalling it on the same thread rarely is useful, you'd almost always lose the benefits of asynchronous execution
p4783
aVSome sample code that demonstrates both and emphasizes the exception handling:
p4784
aVYou should not use a try block in the completion callback if you don't expect the code to throw exceptions
p4785
aVThis ensures your program terminates when it does
p4786
as(dp4787
g9
V17034
p4788
stp4789
a((dp4790
g2
(lp4791
VIn general, there are no standard values to pass as the dwIoControlCode
p4792
aVIt depends on the device driver implementation, it determines what it will accept and what action it takes
p4793
aVHowever, many control codes are documented in the MSDN library for drivers written by Microsoft
p4794
aVLook through the MSDN Library index for keywords that start with IOCTL
p4795
aVThe first one that is HID device related is
p4796
as(dp4797
g9
V17034
p4798
stp4799
a((dp4800
g2
(lp4801
VYour example code doesn't use explicit interface implementation
p4802
aVThe client of your code is going to need both since s/he can invoke the method either through a class object or interface reference
p4803
aVWith explicit interface implementation you can omit the class method comment since the client can never see it
p4804
aVThis is assuming you are using XML documentation to generate IntelliSense info
p4805
as(dp4806
g9
V17034
p4807
stp4808
a((dp4809
g2
(lp4810
VNot sure if E_POINTER makes sense or why it would work in C#
p4811
aVIt can't work, your MyList property doesn't have a property setter
p4812
aVIt doesn't really need one, you don't have to change the array, only the array contents
p4813
aVUse the SafeArrayXxxx() functions, using the ATL CComSafeArray or MFC COleSafeArray wrappers makes it easier
p4814
as(dp4815
g9
V17034
p4816
stp4817
a((dp4818
g2
(lp4819
VAdd this line to your BeginPrint event handler:
p4820
aVIf you now see a new form pop up, with an empty grid, you are using the wrong form reference to get the printing going
p4821
aVIf that new form is unresponsive then you've also got a threading problem
p4822
as(dp4823
g9
V17034
p4824
stp4825
a((dp4826
g2
(lp4827
VThe lambda captured the value of "this" and captured null since the object wasn't constructed yet
p4828
aVThis strikes me as a compiler bug, it should have generated an error for this
p4829
aVCode like this normally generates a CS0027 (keyword 'this' is not available in the current context) or CS0120 (an object reference is required)
p4830
aVI bet that isn't easy to implement
p4831
aVAnyhoo, the code cannot work
p4832
aVThe NameRenderer class needs a constructor with a string argument so it can initialize the base class
p4833
as(dp4834
g9
V17034
p4835
stp4836
a((dp4837
g2
(lp4838
VThe Control class supports a BackColor with an alpha < 255, it is automatic
p4839
aVIt asks the Parent to draw itself to produce the background of the control, then draws itself on top of that
p4840
aVHowever, you'll want a top-level window for a balloon
p4841
aVThat's a window type that can arbitrarily overlap another window and isn't confined by the client area of an underlying window
p4842
aVIt has no Parent
p4843
aVA ToolTip is such a window
p4844
aVThe only control available in Windows Forms that can be an top-level window is a Form
p4845
aVProblem is: the transparency trick no longer works
p4846
aVSince a top-level window doesn't have a Parent, there isn't any obvious window to ask to draw the background
p4847
aVIt could be many windows, belonging to other processes
p4848
aVYou can get transparency in a Form with its TransparencyKey property
p4849
aVBut that's a "hard" transparency, equivalent to an alpha of 0
p4850
aVYou probably want a soft one
p4851
aVAnother nasty problem is that drawing anti-aliased (ClearType) text no longer works since there is no reliable background pixel color anymore
p4852
aVLong story short: you can't make this work well unless you confine the balloon to the client area of a form
p4853
aVA control, not a form
p4854
as(dp4855
g9
V17034
p4856
stp4857
a((dp4858
g2
(lp4859
VUnless I'm really missing something fundamental, you can't select a subitem
p4860
aVYou can select the subitem in the first column or you can set the FullRowSelect property to True
p4861
aVNeither helps you to determine what subitem the user might be interested in, there's no way to guess what to copy to the clipboard
p4862
aVUse DataGridView to work around that
p4863
as(dp4864
g9
V17034
p4865
stp4866
a((dp4867
g2
(lp4868
VIt is not an error, it is a warning
p4869
aVProduced by a Managed Debugging Assistant (MDA), an extension to the debugger for managed code, that thinks it is seeing something going wrong in your code
p4870
aVThe shoe fits
p4871
aVYou are using an RCW, WebBrowser is an COM control
p4872
aVYou are killing off the RCW, you are closing your form
p4873
aVThe MDA steps in because it thinks it is seeing the web browser in use and it getting killed before the request is completed
p4874
aVThat would normally only make sense if you are using a thread in your code
p4875
aVAre you
p4876
aVIf not, don't lose any sleep over it
p4877
aVCOM uses reference counting, notorious for not being able to resolve circular references
p4878
aVOkay, I got a repro for this, enabled by the comments
p4879
aVYes, this is triggered by the form's CancelButton property or the button's DialogResult property
p4880
aVThis happens when the WB has the focus, it sees the Escape key press
p4881
aVPart of the ActiveX plumbing is to tell the container about it so it can respond to keystrokes that should have a side-effect
p4882
aVShortcut keystrokes, Tab, Enter
p4883
aVAnd Escape
p4884
aVIf the button then closes the form, the debugger sees the WB getting disposed while there are active stack frames from the RCW code on the stack
p4885
aVThe danger is that this might cause a crash when the called code returns since the COM component got released, it isn't uncommon
p4886
aVSeeing this crash is pretty unlikely, but I can imagine that this could bomb when the finalizer thread runs just before the button's Click event returns
p4887
aVThe workaround for the MDA and the potential crash is to delay closing the form until after the ActiveX code stops running
p4888
aVElegantly done with Control
p4889
aVBeginInvoke()
p4890
aVLike this:
p4891
as(dp4892
g9
V17034
p4893
stp4894
a((dp4895
g2
(lp4896
VThis doesn't work as far as I can tell
p4897
aVMacros in the Command Line arguments box do not get expanded
p4898
aVNot even environment variables
p4899
aVBummer
p4900
aVA workaround is to create a custom tool
p4901
aVTools + External Tools, Add
p4902
aVTitle = Run tests, Command = nunit
p4903
aVexe, Arguments = $(TargetPath), Initial Directory = $(TargetDir)
p4904
aVTweak as needed
p4905
aVYou could assign a keystroke to this new tool command, even F5
p4906
as(dp4907
g9
V17034
p4908
stp4909
a((dp4910
g2
(lp4911
VGumpy comments, not accurate
p4912
aVAdd a new class to your project and paste the code shown below
p4913
aVCompile
p4914
aVDrop the new control from the top of your toolbar onto your form
p4915
aVThe other border styles work too, check out WinUser
p4916
aVh in the SDK
p4917
as(dp4918
g9
V17034
p4919
stp4920
a((dp4921
g2
(lp4922
VFor a control you can override either OnControlCreated or OnHandleCreated
p4923
aVThe latter one can fire multiple times if it is necessary to recreate the control window
p4924
aVBe sure to use it if your code affects the window itself
p4925
aVIn other words, if you do anything that requires the Handle property
p4926
aVFew suitable choices for a ToolStripItem derived control
p4927
aVI'd recommend overriding SetVisibleCore() or OnAvailableChanged() or the AvailableChanged event
p4928
aVThey run when the Visible property of the ToolStripItem changes
p4929
aVBeware that it may fire multiple times, keep a bool field that tracks that your initialization code has already run
p4930
aVLast but not least, be sure to only do any of this if your code actually requires the control to be created
p4931
aVThe vast majority of init code can go in the constructor
p4932
aVYou only need a Load event if your code depends on the actual Location and Size of the control
p4933
aVWhich might be different from the designer value if the form rescales itself due to a different system font or video DPI setting on the target machine
p4934
as(dp4935
g9
V17034
p4936
stp4937
a((dp4938
g2
(lp4939
VYou can use Process
p4940
aVBeginOutputReadLine() and BeginErrorReadLine() to keep your UI updated while the program is executing
p4941
aVThere is a good example in the MSDN library topic for these methods
p4942
aVBeware that the callback runs on a thread, you have to use the form's BeginInvoke method to marshal a call to the UI thread and update the control
p4943
aVUse the Process
p4944
aVExited event instead of WaitForExit() to detect completion of the program
p4945
aVThis approach also avoids a deadlock you'll get when the program is writing too much output to fit in the console output buffer, usually around 2K
p4946
as(dp4947
g9
V17034
p4948
stp4949
a((dp4950
g2
(lp4951
VThe diagnostics you provided matches the behavior
p4952
aVThe form's Load event would be the last bit of your code running before the form paints itself
p4953
aVThe Shown event would be next
p4954
aVThe debugger would indeed stop on the Application
p4955
aVRun() call, that's the last bit of code that you wrote for which the debugger has source code info
p4956
aVThe key is to carefully examine the Call Stack window, there ought to be additional stack frames above the Application
p4957
aVRun one
p4958
aVThe top one is the trouble maker if the code that causes the hang is managed code
p4959
aVYou won't have source code for it, getting setup with the Microsoft Reference Source server is important if you need that code
p4960
aVBut it isn't very likely to be managed code, the vast majority of Paint event handlers are unmanaged code, either in Windows or some kind of ActiveX control
p4961
aVTo get insight into that kind of code you'll need to enable unmanaged debugging
p4962
aVProject + Properties, Debug tab
p4963
aVAlso, Tools + Options, Debugger, turn off "Just my code"
p4964
aVGetting setup to debugging symbols from Microsoft's symbol server can be important to make sense of the stack trace, do so if you only get hex addresses in the stack trace
p4965
aVNext, you ought to be able to see what particular control is causing this problem by observing what is getting painted and what is not
p4966
aVControls get painted in Z-order, the one you don't see, or only see partially, ought to be the trouble maker
p4967
aVPainting hangs in Windows or
p4968
aVNET controls are unheard of, suspect any kind of ActiveX control on your form
p4969
as(dp4970
g9
V17034
p4971
stp4972
a((dp4973
g2
(lp4974
VNo happy answers here, DrawToBitmap can only draw what would be visible to the user
p4975
aVTricks like changing the Location and Size of the panel beforehand usually quickly run out of gas due to the restriction on the control size imposed by the parent
p4976
aVThe form itself can never get larger than the screen, now you'll also depend on the resolution of the video adapter on the target machine
p4977
aVOne ugly hack is to run DrawToBitmap multiple times, changing the Panel's AutoScrollPosition property between each call
p4978
aVYou'd have to stitch the resulting images together
p4979
aVPaying special attention to the last one of course since it won't be as large as the other ones
p4980
aVOnce you start considering code like this, you really ought to think about PrintDocument or a report generator instead
p4981
aVOne benefit to that is that the printout will look a heckofalot cleaner
p4982
aVPrinted screen-shots are invariably ugly due to the huge difference in video and printer resolution
p4983
as(dp4984
g9
V17034
p4985
stp4986
a((dp4987
g2
(lp4988
VYes, it is possible
p4989
aVAn asynchronous operation can complete synchronously, that's why the IAsyncResult interface has the CompletedSynchronously property
p4990
aVWhether that would ever cause a problem in your program is a bit hard to guess, there isn't enough context in your snippet
p4991
aVOne thing you don't have to worry about is memory, you're not consuming any more if it completely synchronously
p4992
aVThe worry would be if you have enough stack space
p4993
aVYour ReadCompleted call back will be called again while your BeginAsyncRead() method is still executing
p4994
aVAll I can say is that it is extremely unlikely you'll get a StackOverflowException
p4995
aVI never heard of anybody suffering from this problem
p4996
aVWhatever device you are reading from will run out of data in its buffers before you run out of stack space
p4997
aVThere are few devices that can do this in the first place, I only know of sockets
p4998
aVMaybe the file system, but you'd rarely use async I/O on that
p4999
as(dp5000
g9
V17034
p5001
stp5002
a((dp5003
g2
(lp5004
VI realize you are not interested in an answer anymore, I'll post a solution anyway
p5005
aVYou want to handle the WM_MOVING message and override the target position
p5006
aVBeware that it has side-effects on Win7 and is inadvisable if the user has more than one monitor
p5007
aVMouse position handling isn't great either
p5008
aVThe code:
p5009
as(dp5010
g9
V17034
p5011
stp5012
a((dp5013
g2
(lp5014
VIf you see a lot of DLLs loaded then it is likely that you are running the debugger in native mode
p5015
aVIt is an option in the Tools + Attach to Process dialog, be sure to pick Managed
p5016
aVBy far the easiest way to avoid trouble like this is to load the source code file and set the breakpoint by clicking in the left rail of the editor window
p5017
aVAlso, don't use Attach to Process
p5018
aVUse Project + Properties, Debug tab, select "Start external program" and select the
p5019
aVexe that loads your assembly
p5020
aVYou can now start debugging by simply pressing F5
p5021
aVBeware that this option is not available in the Express edition
p5022
as(dp5023
g9
V17034
p5024
stp5025
a((dp5026
g2
(lp5027
VA Windows program always has at least two heaps in which unmanaged memory is allocated
p5028
aVFirst is the default process heap, used by Windows when it needs to allocate memory on behalf of the program
p5029
aVThe second is a heap used by the COM infrastructure to allocate
p5030
aVThe
p5031
aVNET P/Invoke marshaller assumes this heap was used by any unmanaged code whose function signature requires de-allocating memory
p5032
aVAllocHGlobal allocates from the process heap, AllocCoTaskMem allocates from the COM heap
p5033
aVWhenever you write unmanaged interop code, you should always avoid a situation where code that allocates unmanaged memory is not the same as the code that frees it
p5034
aVThere would be a good chance that the wrong de-allocator is used
p5035
aVThis is especially true for any code that interops with a C/C++ program
p5036
aVSuch programs have their own allocator that uses its own heap, created by the CRT at startup
p5037
aVDe-allocating such memory in other code is impossible, you can't reliably get the heap handle
p5038
aVThis is a very common source of P/Invoke trouble, especially because the HeapFree() function in XP and earlier silently ignore requests to free memory that wasn't allocated in the right heap (leaking the allocated memory) but Vista and Win7 crash the program with an exception
p5039
aVNo need to worry about this in your case, the mmsystem API functions you are using are clean
p5040
aVThey were designed to ensure the same code that allocates also deallocates
p5041
aVThis is one reason you have to call waveInPrepareHeader(), it allocates buffers with the same code that ultimately deallocates them
p5042
aVProbably with the default process heap
p5043
aVYou only need to allocate the WAVEHDR structure
p5044
aVAnd you are responsible for releasing it when you're done with it
p5045
aVThe mmsystem APIs don't do it for you, most of all because they cannot do so reliably
p5046
aVAccordingly, you can use either allocator, you just need to make sure to call the corresponding free method
p5047
aVAll Windows APIs work this way
p5048
aVI use CoTaskMemAlloc() but there really isn't a preference
p5049
aVJust that if I'm calling badly designed code, it is slightly likelier to use the COM heap
p5050
aVYou should never use sizeof() in an interop scenario
p5051
aVIt returns the managed size of value type
p5052
aVThat might not be the same after the P/Invoke marshaller has translated a structure type according to the [StructLayout] and [MarshalAs] directives
p5053
aVOnly Marshal
p5054
aVSizeOf() gives you a guaranteed correct value
p5055
aVUPDATE: there was a big change in VS2012
p5056
aVThe C runtime library included with it now allocates from the default process heap instead of using its own heap
p5057
aVLong term, that makes AllocHGlobal the most likely avenue for success
p5058
as(dp5059
g9
V17034
p5060
stp5061
a((dp5062
g2
(lp5063
VYou will have to provide an alternative to the "interact with desktop" option
p5064
aVIt is no longer supported in Vista and Win7
p5065
aVGiving a restricted user access to an UI that runs on a highly privileged account was considered too great a security risk
p5066
aVGoogle "session 0 isolation" to find details on this
p5067
aVYou'll need to use one of the process interop mechanisms supported by
p5068
aVNET to setup interaction between your service and a UI app
p5069
aVFor simple message passing use either a socket or named pipe
p5070
aVThe pipe name needs to have the "Global\u005c" prefix to be visible to all sessions
p5071
aVFor more intricate interactions you can use Remoting or WCF
p5072
aVBe sure to deal with the possibility that the user decides to not run or kill off the desktop app
p5073
aVYou should log any error with the EventLog class
p5074
as(dp5075
g9
V17034
p5076
stp5077
a((dp5078
g2
(lp5079
VThat's not possible, the assembly format hasn't changed between 2
p5080
aV0 and 3
p5081
ag2447
aVNET 3
p5082
aV5 uses the exact same CLR version and assembly metadata format
p5083
aVThe only difference between the versions is a new set of assemblies, notably those that support WPF, WCF and Linq
p5084
aVTrying to load a 3
p5085
aV5 assembly that references types from those new assemblies produces a very different error message
p5086
aVIt will complain that it can't find the 3
p5087
aV5 assembly
p5088
aVYou would get an exception like this when you are actually running the
p5089
aVNET 1
p5090
aVx version of the CLR, the 2
p5091
aV0 assembly format did change
p5092
aVAlso, although it isn't a good match for the exception message, you'll get an exception complaining about the assembly format if your code is running on the 64-bit version of the framework and you're trying to load an assembly that contains 32-bit native code
p5093
aVOr the other way around
p5094
as(dp5095
g9
V17034
p5096
stp5097
a((dp5098
g2
(lp5099
VYou cannot rely on gacutil
p5100
aVexe, it will not be available on the target machine
p5101
aVOnly machines that have the Windows SDK installed have it
p5102
aVThe Visual Studio Setup project supports registering assemblies in the GAC without any custom tool
p5103
aVRight-click "File System on Target Machine" and select "Global Assembly Cache Folder"
p5104
as(dp5105
g9
V17034
p5106
stp5107
a((dp5108
g2
(lp5109
VWindows 7 comes with
p5110
aVNET 3
p5111
aV5 SP1 pre-installed
p5112
aVOne possible source of the problem is having Visual Studio 2010 Beta 1 installed before you did the Win7 upgrade
p5113
aVThe upgrade will destroy the
p5114
aVNET 4
p5115
aV0 configuration, all programs that use the default version of the CLR will no longer work correctly
p5116
aVI found a workaround for it but I strongly recommend you reinstall Win7, now selecting a clean install rather than an upgrade
p5117
aVStrike that
p5118
aVThe info we were missing is that you copied it into the system32 folder
p5119
aVThat folder is virtualized in a 64-bit version of Windows
p5120
aVA 32-bit app will see the syswow64 folder instead
p5121
aVThat is an issue with Reflector, it has config flags (visible with corflags
p5122
aVexe) that forces it to run in 32-bit mode
p5123
aVAccordingly, it can't find its
p5124
aVexe
p5125
aVconfig file
p5126
as(dp5127
g9
V17034
p5128
stp5129
a((dp5130
g2
(lp5131
VRunning on a 64-bit operating system has a number of side effects that will be noticeable to some extent
p5132
aVThe most common issues:
p5133
aVEdit and Continue in Visual Studio won't work
p5134
aVYou can fix this by forcing your
p5135
aVNET app to run in 32-bit mode
p5136
aVProject + Properties, Build tab, Platform Target = x86
p5137
aVIf you use any ActiveX controls or COM components in your
p5138
aVNET app you may find your program no longer works since your machine doesn't have a corresponding 64-bit version of the COM server
p5139
aVYou'll get error 0x80040154, REGDB_E_CLASSNOTREG, "Class not registered"
p5140
aVSame fix as above
p5141
aVThe 64-bit debugger doesn't support mixed-mode debugging, you'll have to commit to either Managed only or Native only debugging
p5142
aVSame fix as above, as long as you don't have 64-bit specific issues
p5143
aVThis issue was resolved in VS2010
p5144
aVPoorly written P/Invoke declarations that declare an uint or int where an IntPtr is required will stop working in 64-bit mode
p5145
aVYou'll generally get an AccessViolation exception or a failure return code
p5146
aVOr a PInvokeStackImbalance MDA warning
p5147
aVYou should not have any trouble locating the mistake, just fix the declaration
p5148
aVSeveral legacy end-of-life Microsoft libraries are not available in a 64-bit version
p5149
aVThat's most commonly a problem with Microsoft Access databases
p5150
aVSame fix as above
p5151
aVYou must use the correct version of Regasm
p5152
aVexe to register [ComVisible] assemblies
p5153
aVSelect the one from either Framework or Framework64, depending on whether the client program is going to run in 64-bit or 32-bit mode
p5154
aVOr both if you want the server to be available in either
p5155
aVA few COM type libraries contain bit-ness dependent arguments in their method declarations
p5156
aVADO 2
p5157
aV8 is a notable one
p5158
aVBe sure to use the correct bitness of Tlbimp
p5159
aVexe to generate the correct COM interop assembly, Visual Studio won't do this right
p5160
aVSame approach as Regasm
p5161
aVexe
p5162
aVA 32-bit program has a different view of the registry from a 64-bit program
p5163
aVSpecifically the HKCR and HKLM\u005cSoftware hives are virtualized
p5164
aVIn Regedit
p5165
aVexe, the 32-bit visible keys are seen under the Wow6432Node key
p5166
aVThis can cause many subtle problems with programs that use the registry
p5167
aVAgain for COM, you'll have the use the correct bitness of Regsvr32
p5168
aVexe to register a COM server
p5169
aVUse the one in c:\u005cwindows\u005csystem32 for 64-bit servers, c:\u005cwindows\u005csyswow64 for 32-bit servers
p5170
aVFolders in the file system are virtualized, specifically c:\u005cwindows\u005csystem32 and c:\u005cprogram files
p5171
aVA 32-bit program will see c:\u005cwindows\u005csyswow64 and c:\u005cprogram files (x86)
p5172
aVInstallers need to take all the above issues in consideration
p5173
as(dp5174
g9
V17034
p5175
stp5176
a((dp5177
g2
(lp5178
VThis phrase in the small print sounds relevant:
p5179
aVIf SendMode is used in the auto-execute section (top part of the script), it affects all remappings
p5180
aVHowever, since remapping uses Send {Blind} and since the SendPlay mode does not fully support {Blind}, some remappings might not function properly in SendPlay mode (especially Control, Shift, Alt, and Win)
p5181
aVTo work around this, avoid SendPlay in auto-execute section when you have remappings; then use the command SendPlay vs
p5182
aVSend in other places throughout the script
p5183
aVAlternatively, you could translate your remappings into hotkeys (as described below) that explicitly call SendEvent vs
p5184
aVSend
p5185
as(dp5186
g9
V17034
p5187
stp5188
a((dp5189
g2
(lp5190
VAnnoying
p5191
aVYou can whack them by implementing a handler for the FileOk event so the user can never select one:
p5192
as(dp5193
g9
V17034
p5194
stp5195
a((dp5196
g2
(lp5197
VThe typical problem with exposing the private List as an IEnumerable is that the client of your class can mess with it by casting
p5198
aVThis code would work:
p5199
aVYou can avoid this by implementing an iterator:
p5200
as(dp5201
g9
V17034
p5202
stp5203
a((dp5204
g2
(lp5205
VYour filter is a specialization of the Finite Impulse Response filter
p5206
aVYou're using the moving average method to select the coefficients, using N = 1
p5207
aVIt already is a low-pass filter
p5208
aVCalculating the coefficient and order for the filter to tune it to a specific frequency response involves tricky math
p5209
aVBest thing to do is to use a software package to calculate the coefficients if moving average doesn't fit your bill
p5210
aVMatlab is the usual choice, GNU Octave is an open source option
p5211
as(dp5212
g9
V17034
p5213
stp5214
a((dp5215
g2
(lp5216
VThe C# compiler supports this with the /pdb command line option
p5217
aVThat option is however not exposed in the IDE's Build tab
p5218
aVThe IDE build process already asks the C# compiler to put the
p5219
aVpdb file in the obj\u005cDebug directory
p5220
aVA copy of it ends up in the bin\u005cDebug by a MSBuild task named CopyFilesToOutputDirectory
p5221
aVThis task is configured in Microsoft
p5222
aVCommon
p5223
aVtargets, a file located in the c:\u005cwindows\u005cmicrosoft
p5224
aVnet\u005cframework\u005cv3
p5225
aV5 directory for VS2008
p5226
aVYou could technically edit this file and remove the  element that copies the
p5227
aVpdb
p5228
aVHeed the warning at the top of file, be sure to make a backup copy before you modify it
p5229
aVI think the basic problem you'll encounter doing this is that this affects all builds of all projects
p5230
aVAnd that the debugger now no longer can find the
p5231
aVpdb file
p5232
aVThat would be the ultimate show-stopper
p5233
as(dp5234
g9
V17034
p5235
stp5236
a((dp5237
g2
(lp5238
VIt is not a great error message, Windows produces it
p5239
aVWhat it really means is that you are calling ReleaseMutex on a mutex that you don't own
p5240
aVYou'll get past the first exception with
p5241
aVBut then it will die inside the thread when it calls ReleaseMutex on mut1, which it doesn't own
p5242
aVNot sure what you're trying to do, the code doesn't make much sense to me
p5243
as(dp5244
g9
V17034
p5245
stp5246
a((dp5247
g2
(lp5248
VI don't get this
p5249
aVGiven is that the client of your code is running a profiler
p5250
aVThat's not a voluntary act, they do this because they got a problem
p5251
aVWhat kind of feedback do you prefer
p5252
aVChoose one of:
p5253
aVI've got a serious perf problem with your code
p5254
aVNo idea why
p5255
aVI'm seeing a problem with your Xyz
p5256
aVEatDinnerWashDishes() method, it is too slow to be usable
p5257
aVI've seen the names of your methods
p5258
aVI hope you don't mind if I start my own company and create a product that uses the same method names
p5259
aVPlease don't sue me
p5260
as(dp5261
g9
V17034
p5262
stp5263
a((dp5264
g2
(lp5265
VDon't use controls for your rectangles, they are horribly expensive and can't overlap
p5266
aVYou can't make it reliable with just the OnMouseMove() method, you'll miss the mouse moving outside of the panel when the user is moving the mouse fast and/or an edge of a rectangle is close to the panel border
p5267
aVIt is easily solved with the Control
p5268
aVCapture property
p5269
aVSome sample code:
p5270
as(dp5271
g9
V17034
p5272
stp5273
a((dp5274
g2
(lp5275
VIf you don't want to see the ThreadExceptionDialog, you'll need to catch the exception in your code
p5276
aVFor example:
p5277
aVThe burden is now on the code that uses ConnectToDbase() to do something meaningful when it returns False
p5278
as(dp5279
g9
V17034
p5280
stp5281
a((dp5282
g2
(lp5283
VThreads can improve program perf only if the program is starved for CPU resources
p5284
aVThat's not the case for your program, it should be readily visible from the Taskmgr
p5285
aVexe Performance tab
p5286
aVThe slow resource here is your hard disk, or the network card
p5287
aVThe ReadToEnd() call is glacially slow, waiting for the disk to retrieve the file data
p5288
aVAnything else you do with the file data is easily 3 orders of magnitude faster than that
p5289
aVThe threads will just wait in turn for the disk data
p5290
aVIn fact, there's a good chance that the threads actually make your program run a lot slower
p5291
aVThey will cause the disk drive head to jump back-and-forth between disjoints tracks on the disk since each thread is working with a different file
p5292
aVThe one thing that is really slow is causing the head to seek to another track
p5293
aVTypically around 10 msec for a fast disk
p5294
aVEquivalent to about half a million CPU instructions
p5295
aVYou can't make your program run faster unless you get a faster disk
p5296
aVSSDs are nice
p5297
aVBeware of effects of the file system cache, the second time you run your program it will run very fast when the file data is retrieved from the cache instead of the disk
p5298
aVThis will rarely happen in a production environment
p5299
as(dp5300
g9
V17034
p5301
stp5302
a((dp5303
g2
(lp5304
VNo, you are doing it right
p5305
aVIt is the correct way the bubble an event out of a nested control that isn't directly accessible from a container control
p5306
aVYou'd normally use the PerformClick() method to fire the Click event but this doesn't appear to be available in CF
p5307
aVPerf is not an issue, calling a delegate target is very fast, a dozen nanoseconds or so on a desktop machine
p5308
aVClick is a "human-time" event, anything less than 20 milliseconds is perceived as "instant"
p5309
as(dp5310
g9
V17034
p5311
stp5312
a((dp5313
g2
(lp5314
VYour snippet is not complete
p5315
aVBut nothing good will happen when you start with "Microsoft
p5316
aVWin32
p5317
aVBegin with Project + Add Reference, Browse tab and select c:\u005cwindows\u005csystem32\u005cwmp
p5318
aVdll
p5319
aVThat adds a com interop wrapper with the namespace name "WMPLib"
p5320
aVIntelliSense will now spring to life and show you the classes in that namespace
p5321
aVMake it resemble this:
p5322
as(dp5323
g9
V17034
p5324
stp5325
a((dp5326
g2
(lp5327
VYou'll need to find the clicked picture box back in the Click event handler
p5328
aVYou can use the sender argument for that
p5329
aVTrivially:
p5330
aVBut you'll need to implement your game logic as well, which will require you know the box's location on the game board
p5331
aVYou could use the PictureBox
p5332
aVTag property for that
p5333
aVIt could store a Point for example:
p5334
aVBut you probably want to use a helper class that stores more info than just the row and column number
p5335
as(dp5336
g9
V17034
p5337
stp5338
a((dp5339
g2
(lp5340
VI haven't tried your code, it isn't easy to run without the P/Invoke declarations
p5341
aVAlthough your SendMessage's LPARAM argument declaration looks wrong, it should be IntPtr
p5342
aVPassing 0 for WPARAM shouldn't compile either, not sure what you did
p5343
aVBe sure to check the return value of SendMessage(), it returns IntPtr
p5344
aVZero if RichEdit isn't happy with your arguments
p5345
aVPassing 0 for the device context handle isn't mentioned in the SDK docs as an acceptable value, you may need to pass an HDC for the screen
p5346
aVEasy to get from Control
p5347
aVCreateGraphics()
p5348
aVI'm also unclear why you wouldn't want a horizontal scrollbar to appear
p5349
aVI would expect you'd see one when you switch to printer WYSIWYG mode
p5350
as(dp5351
g9
V17034
p5352
stp5353
a((dp5354
g2
(lp5355
VUse SystemInformation
p5356
aVIconSpacingSize to discover the size of the grid square used to arrange icons in LargeIcon mode
p5357
as(dp5358
g9
V17034
p5359
stp5360
a((dp5361
g2
(lp5362
VYour assembly code defines a function whose decorated name decodes to
p5363
aVAs obtained through the undname
p5364
aVexe utility
p5365
aVFoo::InitializeCurrentCpu() won't be a match for Foo::Initialize(), the name doesn't match
p5366
aVNor does the calling convention
p5367
aVWrite this code in C++ first and look at the
p5368
aVmap file for the correct decorated name
p5369
aVOr declare the function with extern "C" to suppress C++ decoration
p5370
as(dp5371
g9
V17034
p5372
stp5373
a((dp5374
g2
(lp5375
VReflector does, it is free and excellent
p5376
aVSearch for the interface name and expand the "Derived Types" node
p5377
as(dp5378
g9
V17034
p5379
stp5380
a((dp5381
g2
(lp5382
VThe standard way to do is to throw an InvalidOperationException, signaling the client of your code that your class object is not yet in a state to be usable
p5383
as(dp5384
g9
V17034
p5385
stp5386
a((dp5387
g2
(lp5388
VYes, you can make this work:
p5389
aVOutput:
p5390
as(dp5391
g9
V17034
p5392
stp5393
a((dp5394
g2
(lp5395
VYou are measuring the cost of explicit memory management
p5396
aVMore statistics are available here
p5397
aVThis is relevant too
p5398
aVAnd Chris Sells' attempt to add deterministic finalization to the CLR is notable
p5399
as(dp5400
g9
V17034
p5401
stp5402
a((dp5403
g2
(lp5404
VThere is another consideration here, you are possibly solving a problem you should not solve
p5405
aVI can't see the rest of your code but I can guess from you seeing value in this pattern
p5406
aVYour approach solves a problem only if the code that reads or writes the shared resource throws an exception
p5407
aVImplicit is that you don't handle the exception in the method that does the reading/writing
p5408
aVIf you did, you could simply release the lock in the exception handling code
p5409
aVIf you don't handle the exception at all, the thread will die from the unhandled exception and your program will terminate
p5410
aVNo point in releasing a lock then
p5411
aVSo there's a catch clause somewhere lower in the call stack that catches the exception and handles it
p5412
aVThis code has to restore the state of the program so that it can meaningful continue without generating bad data or otherwise die due to exceptions caused by altered state
p5413
aVThat code has a difficult job to do
p5414
aVIt needs to somehow guess how much data was read or written without having any context
p5415
aVGetting it wrong, or only partly right, is potentially very destabilizing to the entire program
p5416
aVAfter all, it was a shared resource, other threads are reading/writing from it
p5417
aVIf you know how to do this, then by all means use this pattern
p5418
aVYou better test the heck out of though
p5419
aVIf you're not sure then avoid wasting system resources on a problem you can't reliably fix
p5420
as(dp5421
g9
V17034
p5422
stp5423
a((dp5424
g2
(lp5425
VAny decent memory profiler will show you the control instances
p5426
aVThey won't be garbage collected, their Handle property keeps them alive
p5427
aVThere will be close to 10,000 of them
p5428
aVA code review ought to go a long way too, there are not that many possible ways to leak a window
p5429
aVLook for code that calls Controls
p5430
aVRemove() but don't explicitly dispose the control
p5431
aVOr a form displayed with ShowDialog() that doesn't get disposed and forgets to unregister a static event handler (SystemEvents e
p5432
aVg
p5433
aVFinding the handles yourself at runtime is technically possible with Reflection
p5434
aVThe handles are stored in System
p5435
aVInternal
p5436
aVHandleCollector
p5437
aVhandleTypes[]
p5438
aVWell, technically
p5439
as(dp5440
g9
V17034
p5441
stp5442
a((dp5443
g2
(lp5444
VYou should strongly favor using resources at the form level (set the form's Localizable property to True in the designer)
p5445
aVThe designer has very good support for it and the WinRes
p5446
aVexe utility is available to localize strings off-line
p5447
aVNo code is required
p5448
aVLocalizing project resource strings is possible but not well supported by the IDE
p5449
aVCheck my answer in this thread for an approach
p5450
as(dp5451
g9
V17034
p5452
stp5453
a((dp5454
g2
(lp5455
VYou are getting garbage values from the database
p5456
aVThe maximum date representable in DateTime is Dec 31 of the year 9999
p5457
aVThe corresponding FILETIME value is 2650467743999999999
p5458
aVNegative FILETIME values cannot convert, you'll get an exception when you try to use DateTime
p5459
aVFromFileTime()
p5460
aVTackle this problem at the root, there's a bug in the program that generates the dbase data
p5461
aVProbably a mistake when sign-extending FILETIME
p5462
aVdwLowDateTime
p5463
aVYou already saw this in the MSDN forum thread
p5464
as(dp5465
g9
V17034
p5466
stp5467
a((dp5468
g2
(lp5469
VThe solution is simple: have one BGW execute all of the commands, not just one BGW for each command
p5470
aVYou'll need a  to store the commands so you can easily pass them to RunWorkerAsync()
p5471
aVDoWork() can simply iterate the list with foreach
p5472
as(dp5473
g9
V17034
p5474
stp5475
a((dp5476
g2
(lp5477
VThere is no problem here, there can be only one event triggered when the user moves the mouse
p5478
aVThat takes roughly a dozen nanoseconds
p5479
aVMoreover, these events happen in "human-time", triggered by the user moving the mouse
p5480
aVS/he'll perceive anything that takes less than 20 milliseconds as "instant"
p5481
aVYou've got a margin of 1:166,666 of having a problem
p5482
as(dp5483
g9
V17034
p5484
stp5485
a((dp5486
g2
(lp5487
VIt doesn't work is because you CreateMutex declaration is not in the Win32Calls namespace
p5488
aVYour next problem is that it still won't work because you forgot to set the SetLastError property in the [DllImport] attribute
p5489
aVRequired to make Marshal
p5490
aVGetLastWin32Error() return the error
p5491
aVRewinding a bit, using the Mutex class in Win7 should work without a problem
p5492
aVThe only failure mode I can think of is not prefixing the mutex name with "Global\u005c" so the mutex is visible in all sessions
p5493
aVThat's a bit remote
p5494
aVMore to the point, you are trying to do something that is already very well supported in the
p5495
aVNET framework
p5496
aVProject + Add Reference, select Microsoft
p5497
aVVisualBasic
p5498
aVMake your Program
p5499
aVcs code look like this:
p5500
aVBonus goodies with this approach is that it automatically sets the focus to the running instance of your program when the user starts it again
p5501
aVAnd you can override the OnStartupNextInstance method to know what command line arguments were used and respond accordingly
p5502
as(dp5503
g9
V17034
p5504
stp5505
a((dp5506
g2
(lp5507
VEric Lippert has explained it well in one of his blog posts
p5508
as(dp5509
g9
V17034
p5510
stp5511
a((dp5512
g2
(lp5513
VThe better way to debug this is to add a FormClosing event handler to your form and set a breakpoint on it
p5514
aVWhen it breaks, the callstack reveals what code is calling the Close() method
p5515
aVOne classic failure mode with the SystemEvents
p5516
aVUserPreferenceChanged event you are using is forgetting to unregister your event handler when a form closes
p5517
aVIt is a static event, it will prevent the form that wires the event from getting garbage collected
p5518
aVWhen the event fires, you're very likely to get an ObjectDisposedException
p5519
aVBut that's just a guess
p5520
as(dp5521
g9
V17034
p5522
stp5523
a((dp5524
g2
(lp5525
VHere's a sample implementation:
p5526
aVYou should use a stronger hash if you put thousands of arrays in the hash table
p5527
aVCheck this post for an example
p5528
as(dp5529
g9
V17034
p5530
stp5531
a((dp5532
g2
(lp5533
VYou have to override the HitTest() method as well
p5534
aVThe base implementation still assumes it is a straight line
p5535
as(dp5536
g9
V17034
p5537
stp5538
a((dp5539
g2
(lp5540
VControl
p5541
aVDrawToBitmap() is implemented by sending WM_PRINT to the control to let it draw itself in a memory device context
p5542
aVIf you are using non-standard controls, the odds are great that the programmer did not implement this message
p5543
aVI don't think it is implemented by the standard Windows Mobile controls either
p5544
aVYour only other recourse then is to copy the pixels off the screen
p5545
aVGraphics
p5546
aVCopyFromScreen() is a no-go, you'll have to P/Invoke the BitBlt() API function
p5547
aVPossibly useful sample code is available in this thread
p5548
aVand at pinvoke
p5549
aVnet
p5550
as(dp5551
g9
V17034
p5552
stp5553
a((dp5554
g2
(lp5555
VIt is the same kind of problem as this:
p5556
aVwhich is the same kind of problem as:
p5557
aVObjects cannot be casted from one type to an unrelated other type, even though the types are otherwise completely compatible
p5558
aVFor lack of a better term: an object has type identity that it carries along at runtime
p5559
aVThat identity cannot be changed after the object is created
p5560
aVThe visible manifestation of this identity is Object
p5561
aVGetType()
p5562
as(dp5563
g9
V17034
p5564
stp5565
a((dp5566
g2
(lp5567
VMsgBox() pumps a message loop
p5568
aVThat can get all kind of code unstuck
p5569
aVWindows get a chance to paint themselves
p5570
aVCOM deadlocks due the main thread getting stuck in a loop are solved, always an issue when IE is involved
p5571
aVCalling DoEvents() is the very imperfect alternative to MsgBox()
p5572
as(dp5573
g9
V17034
p5574
stp5575
a((dp5576
g2
(lp5577
VNo, they can't run side-by-side
p5578
aVWhatever plug-in loads first will determine what version of the CLR will be loaded
p5579
aVProbably causing other plug-ins to fail
p5580
aVThis is fixed in
p5581
aVNET 4
p5582
ag2512
as(dp5583
g9
V17034
p5584
stp5585
a((dp5586
g2
(lp5587
VNo, you cannot overload SendMessage and make the wparam argument an int
p5588
aVThat will make your program fail on a 64-bit version of the operating system
p5589
aVIt has to be a pointer, either IntPtr, a blittable reference or an out or ref value type
p5590
aVOverloading the out/ref type is otherwise fine
p5591
aVEDIT: As the OP pointed out, this is not actually a problem
p5592
aVThe 64-bit function calling convention passes the first 4 arguments through registers, not the stack
p5593
aVThere is thus no danger of stack mis-alignment for the wparam and lparam arguments
p5594
as(dp5595
g9
V17034
p5596
stp5597
a((dp5598
g2
(lp5599
VI measured memory bandwidth on several recent desktop models some time ago, testing with bursty transfers, and came up with a consistent number: roughly 5 gigabytes per second
p5600
aVWhich matches very well with Niko's number, 0
p5601
aV205 seconds for a gig
p5602
aVThe 0
p5603
aV845 seconds of system time is burned on making the memory available
p5604
aVWhich has much more to do with the speed of your hard drive, the state of your paging file and how many pages of other programs are loaded in RAM than memory bandwidth
p5605
aVIn other words, anything you measure is likely to be off by 400% or more
p5606
aVSometimes much more
p5607
as(dp5608
g9
V17034
p5609
stp5610
a((dp5611
g2
(lp5612
VThere are several performance counters that give you basic numbers on throughput on the network interface card
p5613
aVStart by taking a look at them with Perfmon
p5614
aVexe, you'll see their category, name and instance name
p5615
aVThose same numbers are available with the
p5616
aVNET PerformanceCounter class
p5617
aVUsing them to measure bandwidth is a rather tricky, you are more likely to measure the bandwidth of the server you are talking to, combined with the dozen or so routers that pipe the IP message to your machine
p5618
as(dp5619
g9
V17034
p5620
stp5621
a((dp5622
g2
(lp5623
VYou cannot loop like this in the UI thread, it will not be able to perform basic duties like paint windows and respond to input
p5624
aVDon't use DoEvents(), that will leave your code running without any user interface when the user closes the main form
p5625
aVYou'll get an ObjectDisposedException if you're lucky
p5626
aVThe solution is to let the thread notify the UI thread that it is having trouble making the connection
p5627
aVYou can cleanly do so with a BackgroundWorker's ReportProgress event
p5628
as(dp5629
g9
V17034
p5630
stp5631
a((dp5632
g2
(lp5633
VFirst break up the statement:
p5634
aVThe p argument is of type , you can only read or write 1 byte at a time through that pointer
p5635
aVThe cast to  creates a pointer through which you can read or write 4 bytes at a time from/to the same address
p5636
aVThe assignment writes the bytes 0x00, 0x00, 0x00, 0x0A
p5637
aVThe same thing as:
p5638
aVDepending on byte order
p5639
aVAfter the assignment, p needs to be incremented by 4 because 4 bytes were written
p5640
aVThis trick is pretty common with buffers of bytes that contain non-byte data
p5641
as(dp5642
g9
V17034
p5643
stp5644
a((dp5645
g2
(lp5646
VBest way to think of it is: relative vs absolution coordinates
p5647
aVWhere the relative coordinate is relative from the upper left corner of the client area of a window
p5648
aVThe client area of a window is a window minus its border
p5649
aVRelative coordinates are useful because they don't change when the user moves a window and don't depend on the border and caption size of the window
p5650
aVMost coordinates in Winforms are relative coordinates, MouseEventArgs
p5651
aVLocation for example
p5652
aVSome are absolute, Cursor
p5653
aVPosition for example
p5654
aVIf you pass a relative coordinate to PointToClient you'll get garbage, as you saw in your debug session
p5655
aVIt must be an absolute coordinate
p5656
aVSome coordinate properties can seemingly be both, Control
p5657
aVLocation for example
p5658
aVOn a child control it represents the control's location relative from its container
p5659
aVA form's Location is absolute
p5660
aVThat seeming contradiction disappears when you think a Control
p5661
aVLocation as relative from a control's Parent
p5662
aVThe Parent of a form is the desktop
p5663
aVA common usage is to map a coordinate relative to one control to another control
p5664
aVFirst map to absolute screen coordinates with , then map the result to the other control with
p5665
aVThe Point value changes by the offset between the controls, regardless of who their parents are
p5666
aVDoing it any other way is very painful
p5667
aVKeep out of trouble by only ever passing an absolute coordinate to PointToClient and a relative coordinate to PointToScreen
p5668
as(dp5669
g9
V17034
p5670
stp5671
a((dp5672
g2
(lp5673
VThat's not possible, a double only has 15 significant digits
p5674
aVLook for an implementation of a BigInt class
p5675
aVC specific is discussed here
p5676
as(dp5677
g9
V17034
p5678
stp5679
a((dp5680
g2
(lp5681
VA waitable timer was designed to activate code through an APC
p5682
aVThat's pretty hard to get right due to re-entrancy issues and should only be considered if you need to run code on a thread that is otherwise occupied but blocks often enough to allow an APC to run
p5683
aVTimer queues are very light-weight objects, their callback runs on a (cheap) thread from the thread pool
p5684
aVAlmost always good for a periodic service
p5685
aVA third way is to start a thread when the service is started and have it block with WaitForSingleObject() whose timeout sets the period
p5686
aVYou'd wait on an event that signals that the service should stop
p5687
aVVery easy to get going, not as lean as a timer queue
p5688
as(dp5689
g9
V17034
p5690
stp5691
a((dp5692
g2
(lp5693
VThe PID you need for OpenProcess() is not normally easy to get a hold of
p5694
aVIf all you got is a process name then you need to iterate the running processes on the machine
p5695
aVDo so with CreateToolhelp32Snapshot, followed by Process32First and loop with Process32Next
p5696
aVThe PROCESSENTRY32
p5697
aVszExeFile gives you the process name (not path
p5698
aV, th32ProcessID gives you the PID
p5699
aVThe next consideration is that the process may appear more than once
p5700
aVAnd there's a chance that the same process name is used for very different programs
p5701
aVLike "Setup"
p5702
aVIf you don't just want to kill them all, you'll need to try to obtain some runtime info from them
p5703
aVWindow caption bar text, perhaps
p5704
aVGetProcessImageFileName() can give you the path to the
p5705
aVexe
p5706
aVIt uses the native kernel format, you'd need QueryDosDevice to map a disk drive device name to a drive letter
p5707
aVThe next consideration is the rights you ask for in OpenProcess()
p5708
aVYou are unlikely to get , all you need is
p5709
aVAlthough that's privileged as well
p5710
aVEnsure the account you use to run your program can obtain that right
p5711
as(dp5712
g9
V17034
p5713
stp5714
a((dp5715
g2
(lp5716
VA bitmap is guaranteed to be a multiple of 4 bytes
p5717
aVSo int[] will work:
p5718
aVThat doesn't make it easy for the receiver though, I'd suggest you use PixelFormat
p5719
aVFormat32bppRgb so one pixel is exactly the size of an int
p5720
as(dp5721
g9
V17034
p5722
stp5723
a((dp5724
g2
(lp5725
VIt uses the metadata from the reference assemblies
p5726
aVThat contains a full type declaration, same thing as you'd find in a header file
p5727
aVIt being a two-pass compiler accomplishes something else: you can use a type in one source file before it is declared in another source code file
p5728
as(dp5729
g9
V17034
p5730
stp5731
a((dp5732
g2
(lp5733
VThe info you get from the Marshal class is only relevant if the type actually gets marshaled
p5734
aVThe internal memory layout of a managed structure is not discoverable through any documented means, other than peeking at the assembly code perhaps
p5735
aVWhich means the CLR is free to reorganize the layout of the structure and optimize the packing
p5736
aVSwapping the D and V fields makes your structure smaller due the alignment requirements of a double
p5737
aVIt saves 6 bytes on your 64-bit machine
p5738
aVNot sure why this would be an issue for you, it shouldn't be
p5739
aVConsider Marshal
p5740
aVStructureToPtr() to get the structure laid-out the way you want it
p5741
as(dp5742
g9
V17034
p5743
stp5744
a((dp5745
g2
(lp5746
VBecause there is no way for the class to know when the client code is done using the iterator
p5747
aVWhich is one reason that the MSDN Library docs on the System
p5748
aVCollection classes always warn that iterating a collection isn't thread-safe
p5749
aVAlthough they appeared to have forgotten to mention that in the article for SynchronizedCollection
p5750
aVThe irony
p5751
as(dp5752
g9
V17034
p5753
stp5754
a((dp5755
g2
(lp5756
VYes, this is a classic deadlock scenario
p5757
aVThe StatusEvent cannot proceed because it needs the UI thread to update the controls
p5758
aVThe UI thread is however stuck, trying to acquire the driverLock
p5759
aVHeld by the code that calls StatusEvent
p5760
aVNeither thread can proceed
p5761
aVTwo ways to break the lock:
p5762
aVthe StatusEvent code might not necessarily need to run synchronously
p5763
aVUse BeginInvoke instead of Invoke
p5764
aVthe UI thread might not necessarily need to wait for the thread to stop
p5765
aVYour thread could notify it later
p5766
aVThere is not enough context in your snippets to decide which one is better
p5767
aVNote that you might have a potential race on the timer too, it isn't visible in your snippet
p5768
aVBut the callback might run a microsecond after the timer was stopped
p5769
aVAvoid this kind of headache by using a real thread instead of a timer callback
p5770
aVIt can do things periodically by calling WaitOne() on a ManualResetEvent, passing a timeout value
p5771
aVThat ManualResetEvent is good to signal the thread to stop
p5772
as(dp5773
g9
V17034
p5774
stp5775
a((dp5776
g2
(lp5777
VYes, VirtualLock()
p5778
aVThere's a limit on how many pages you can lock, you can't hog RAM
p5779
aVDetails are in the MSDN article
p5780
as(dp5781
g9
V17034
p5782
stp5783
a((dp5784
g2
(lp5785
VThe linker plays an essential role in C/C++ building to resolve external dependencies
p5786
aVNET languages don't use a linker
p5787
aVThere are two kinds of external dependencies, those whose implementation is available at link time in another
p5788
aVobj or
p5789
aVlib file offered as input to the linker
p5790
aVAnd those that are available in another executable module
p5791
aVA DLL in Windows
p5792
aVThe linker resolves the first ones at link time, nothing complicated happens since the linker will know the address of the dependency
p5793
aVThe latter step is highly platform dependent
p5794
aVOn Windows, the linker must be provided with an import library
p5795
aVA pretty simple file that merely declares the name of the DLL and a list of the exported definitions in the DLL
p5796
aVThe linker resolves the dependency by entering a jump in the code and adding a record to the external dependency table that indicates the jump location so that it can be patched at runtime
p5797
aVThe loading of the DLL and setting up the import table is done at runtime by the Windows loader
p5798
aVThis is a bird's-eye view of the process, there are many boring details to make this happen as quickly as possible
p5799
aVIn managed code all of this is done at runtime, driven by the JIT compiler
p5800
aVIt translates IL into machine code, driven by program execution
p5801
aVWhenever code executes that references another type, the JIT compiler springs into action, loads the type and translates the called method of the type
p5802
aVA side-effect of loading the type is loading the assembly that contains the type, if it wasn't loaded before
p5803
aVNotable too is the difference for external dependencies that are available at build time
p5804
aVA C/C++ compiler compiles one source file at a time, the dependencies are resolved by the linker
p5805
aVA managed compiler normally takes all source files that create an assembly as input instead of compiling them one at a time
p5806
aVSeparate compilation and linking is in fact supported (
p5807
aVnetmodule and al
p5808
aVexe) but is not well supported by available tools and thus rarely done
p5809
aVAlso, it cannot support features like extension methods and partial classes
p5810
aVAccordingly, a managed compiler needs many more system resources to get the job done
p5811
aVReadily available on modern hardware
p5812
aVThe build process for C/C++ was established in an era where those resources were not available
p5813
as(dp5814
g9
V17034
p5815
stp5816
a((dp5817
g2
(lp5818
VGood tools cost more money that lousy ones
p5819
aVFrom everything I've heard, seen and personally observed, RedGate produces good tools
p5820
aVUsing lousy tools takes more of your time
p5821
aVHow much that time is worth to you or your employer is something we cannot judge from the information you provided
p5822
aVIn the Western world, a good tool pays itself back in only a few hours
p5823
aVThat's an ROI that's hard to beat
p5824
aVDo make sure you adjust that ROI by the amount of time you'll need to learn how to use the tool
p5825
aVYou'll get a quick insight in that from spending an hour on the trial version
p5826
as(dp5827
g9
V17034
p5828
stp5829
a((dp5830
g2
(lp5831
VJust call the socket's Close() method
p5832
aVThe callback method will run pretty quickly after that, you'll get an ObjectDisposedException when you call the EndReceive() method
p5833
aVBe prepared to catch that exception
p5834
aVYou probably don't want to block the thread that called BeginReceive, you'll need a System
p5835
aVThreading
p5836
aVTimer or System
p5837
aVTimers
p5838
aVTimer to detect the timeout
p5839
aVIts callback should call Close()
p5840
aVBeware of the inevitable race-condition this causes, the timer's callback will run if the response was received a microsecond before the timer expired
p5841
aVYou'll close the socket, even though you got a good response
p5842
aVThe next call to BeginReceive() will fail immediately
p5843
as(dp5844
g9
V17034
p5845
stp5846
a((dp5847
g2
(lp5848
VThat's not how ngen
p5849
aVexe works
p5850
aVIt merely runs the JIT compiler up front to generate the
p5851
aVni
p5852
aVexe or
p5853
aVni
p5854
aVdll module
p5855
aVThat binary file does not contain metadata, only the machine code generated from the IL for the method bodies
p5856
aVThe CLR still must find the original assembly
p5857
aVOnly then can it determine that there is an ngen-ed image available so that it can use the machine code from it rather than generate it from the assembly's IL
p5858
aVNgen
p5859
aVexe speeds up the warm startup time of your app, that's all
p5860
aVMy usual advice to anybody that might be interested in disassembling my assemblies is to point them to sourceforge
p5861
aVnet
p5862
aVIt has terabytes of source code, written and maintained by programmers that are usually better than me
p5863
aVSometimes even with good comments
p5864
aVIf your obfuscator doesn't work well then shop around for a better one
p5865
aVThere are many
p5866
as(dp5867
g9
V17034
p5868
stp5869
a((dp5870
g2
(lp5871
VThe 1st argument is wrong
p5872
aVBut, there is already a ResourceManager created for you
p5873
aVYou can see its code: in the Solution Explorer window open the Properties node, open the Resources
p5874
aVresx node and double-click the Resources
p5875
aVDesigner
p5876
aVcs file
p5877
aVYou'll get its instance with "Properties
p5878
aVResources
p5879
aVResourceManager"
p5880
aVIf you added the bitmaps with Project + Properties, Resources tab (strongly recommended), you can just refer to the property by the name you gave it
p5881
aVLike Properties
p5882
aVResources
p5883
aVcircleGreen
p5884
as(dp5885
g9
V17034
p5886
stp5887
a((dp5888
g2
(lp5889
VAppDomain
p5890
aVCreateDomain has overloads that accepts a AppDomainSetup
p5891
aVMany of the properties of this class match a corresponding entry in a
p5892
aVconfig file
p5893
aVIncluding PrivateBinPath
p5894
aVApplicationBase set the "home" directory where the CLR starts searching
p5895
as(dp5896
g9
V17034
p5897
stp5898
a((dp5899
g2
(lp5900
VChange the default printer to a local printer instead of a network printer
p5901
aVPop the network cable, to be sure
p5902
aVThen ask your LAN admin to post to serverfault
p5903
aVcom
p5904
as(dp5905
g9
V17034
p5906
stp5907
a((dp5908
g2
(lp5909
VSource code appears to be available here
p5910
aVNot sure of course, but it certainly matches your problem description
p5911
aVWhomever wrote this code was quite clueless about how exceptions work
p5912
aVThe callbacks are the problem, when something goes wrong they throw an ApplicationException
p5913
aVThose exceptions are uncatchable, the callbacks are made on a threadpool thread
p5914
aVThis might have worked somewhat back in the
p5915
aVNET 1
p5916
aVx days, it would simply stop working properly instead of aborting your program
p5917
aVAt least you're ahead, you now know it isn't working properly
p5918
aVGiven that the code does very little and that the way it works is basically unfixable, I'd have to strongly recommend you just forget about using this
p5919
aVCheck out nsoftware
p5920
aVcom for a company that sells a real library
p5921
as(dp5922
g9
V17034
p5923
stp5924
a((dp5925
g2
(lp5926
VWow, there are a lot of Red Flags here
p5927
aVWhy on Earth would you name something "bYRTDICD1"
p5928
aVWhy would you put a description in a TextBox
p5929
aVDo you want the user to edit the description
p5930
aVWhy would you use the MouseDown event
p5931
aVCan't the user use the keyboard
p5932
aVRandom advice:
p5933
aVUse the Enter event, not MouseDown
p5934
aVPut a description in a label, not a text box
p5935
aVUse the TextBox
p5936
aVTag property to store the description
p5937
aVUse a ComboBox to let the user select stuff instead of a list view
p5938
aVDesign your UI so that descriptions are unnecessary
p5939
as(dp5940
g9
V17034
p5941
stp5942
a((dp5943
g2
(lp5944
VThe project template you use is missing the code generator that puts the My namespace together
p5945
aVYou can still use it if you code it like this:
p5946
as(dp5947
g9
V17034
p5948
stp5949
a((dp5950
g2
(lp5951
VWindows Forms has very poor support for icons
p5952
aVThat starts with the Icon class itself, it has no way to enumerate the images in the icon or way to select which image is used in its ToBitmap() method
p5953
aVFixing this got to be difficult with Vista, it expanded the icon file format to also support large images in the PNG format
p5954
aVAlso not supported by Icon
p5955
aVPunt this problem and convert the icon to a bitmap yourself
p5956
aVVisual Studio supports this, File + Open File, select your icon
p5957
aVImage + Current Icon Images Types, select the one you want to convert
p5958
aVEdit + Copy, that puts a bitmap of the icon on the clipboard
p5959
aVPaste into a new bitmap
p5960
aVSaving as a
p5961
aVpng is best so that it can still support background transparency
p5962
as(dp5963
g9
V17034
p5964
stp5965
a((dp5966
g2
(lp5967
VI can make some guesses, not familiar enough with StructureMap to make the call
p5968
aVYou are very late with calling BootstrapStructureMap() in your main() method
p5969
aVBe sure to call it before you call ServiceBase
p5970
aVRun()
p5971
aVAlso, be careful with thread-affinity for the object factory
p5972
aVIt is common for code in a service to run on a threadpool thread, a different thread from the one that executes the main() method
p5973
aVIf StructureMap stores the singleton in a [ThreadStatic] member, you'll get a different instance for each thread
p5974
aVBrowsing through the StructureMap source code, this is unlikely to be the cause
p5975
as(dp5976
g9
V17034
p5977
stp5978
a((dp5979
g2
(lp5980
VBehavior of this code is defined in section 3
p5981
aV10 of the C# Language Specification:
p5982
aVExecution of a C# program proceeds such that the side effects of each executing thread are preserved at critical execution points
p5983
aVA side effect is defined as a read or write of a volatile field, a write to a non-volatile variable, a write to an external resource, and the throwing of an exception
p5984
aVThe critical execution points at which the order of these side effects must be preserved are references to volatile fields (10
p5985
ag2447
aV3), lock statements (8
p5986
aV12), and thread creation and termination
p5987
aVIn other words, the lock statement is sufficient guarantee to avoid the need to declare the stopped field volatile
p5988
aVHow this rule is implemented by the JIT compiler is an interesting question, given that the lock statement merely calls the Monitor
p5989
aVEnter() and Exit() methods
p5990
aVI don't think it has special knowledge of those methods, I think it is a side-effect of entering the try block which starts after the Enter() call
p5991
aVBut that's just a guess
p5992
as(dp5993
g9
V17034
p5994
stp5995
a((dp5996
g2
(lp5997
VCurrent syntax coloring options are based on what can be easily recognized by the kind of rules a lexer uses
p5998
aVColoring functional identifiers requires much more, the editor would actually have to parse the statements
p5999
aVThat's an iffy proposition while you are entering code into the editor, especially when that code contains bad syntax or typing mistakes
p6000
aVSome of this is actually done by the IntelliSense parser but that's a feature that is disjoint from the basic editor implementation
p6001
aVChanges are coming in VS2010, its extensibility model adds support for custom syntax highlighting through MEF plug-ins
p6002
aVTo what degree this will be used for default coloring of a specific language isn't that clear to me
p6003
aVI don't see any hard promises yet
p6004
as(dp6005
g9
V17034
p6006
stp6007
a((dp6008
g2
(lp6009
VYes, it is a bug in the visual styles renderer for the tab control
p6010
aVLooks like you already found a replacement
p6011
aVAnother low-impact approach is to selectively disable visual styles for the control
p6012
aVIt will revert back to battle-ship gray, correctly drawing vertical tabs
p6013
aVTab page content will still render properly
p6014
as(dp6015
g9
V17034
p6016
stp6017
a((dp6018
g2
(lp6019
VBeware of the way collection classes and streams like MemoryStream work in
p6020
aVNET
p6021
aVThey have an underlying buffer, a simple array
p6022
aVWhenever the collection or stream buffer grows beyond the allocated size of the array, the array gets re-allocated, now at double the previous size
p6023
aVThis can cause many copies of the array in the LOH
p6024
aVYour 14MB dataset will start using the LOH at 128KB, then take another 256KB, then another 512KB, etcetera
p6025
aVThe last one, the one actually used, will be around 16MB
p6026
aVThe LOH contains the sum of these, around 30MB, only one of which is in actual use
p6027
aVDo this three times without a gen2 collection and your LOH has grown to 90MB
p6028
aVAvoid this by pre-allocating the buffer to the expected size
p6029
aVMemoryStream has a constructor that takes an initial capacity
p6030
aVSo do all collection classes
p6031
aVCalling GC
p6032
aVCollect() after you've nulled all references can help unclog the LOH and purge those intermediate buffers, at the cost of clogging the gen1 and gen2 heaps too soon
p6033
as(dp6034
g9
V17034
p6035
stp6036
a((dp6037
g2
(lp6038
VThe P/Invoke marshaller will assume that memory for the return type was allocated with CoTaskMemAlloc() and will call CoTaskMemFree() to release it
p6039
aVIf this was not done, the program will fail with an exception on Vista and Win7 but silently leak memory on XP
p6040
aVUsing SysAllocString() can be made to work but you have to annotate the return type in the [DllImport] attribute
p6041
aVNot doing so will still cause a leak, without a diagnostic on Win7
p6042
aVA BSTR is not a pointer to a memory block allocated by CoTaskMemAlloc, there are 4 bytes in front of the pointed-to address that store the string size
p6043
aVEither of the following combinations will work properly:
p6044
aVOr:
p6045
aVYou should consider allowing the client code to pass a buffer so there are no memory management issues
p6046
aVThat ought to look similar to this:
p6047
as(dp6048
g9
V17034
p6049
stp6050
a((dp6051
g2
(lp6052
VI don't really understand how this is supposed to work
p6053
aVHowever, deleting a file that's opened by another process is possible
p6054
aVThe process that creates the file has to use the FILE_SHARE_DELETE flag for the dwShareMode argument of CreateProcess()
p6055
aVA subsequent DeleteFile() call will succeed
p6056
aVThe file doesn't actually get removed from the file system until the last handle on it is closed
p6057
as(dp6058
g9
V17034
p6059
stp6060
a((dp6061
g2
(lp6062
VYes, C++/CLI has a very specific target usage, the language (and its compiler, most of all) makes it very easy to write code that needs to interop with unmanaged code
p6063
aVIt has built-in support for marshaling between managed and unmanaged types
p6064
aVIt used to be called IJW (It Just Works), nowadays called C++ Interop
p6065
aVOther languages need to use the P/Invoke marshaller which can be inefficient and has limited capabilities compared to what C++/CLI can do
p6066
aVThe
p6067
aVNET framework contains code that was written in C++/CLI, notably in System
p6068
aVData and WPF's PresentationCore
p6069
aVIf you don't have unmanaged interop needs or don't have to work with a legacy code base then there are few reasons to select C++/CLI
p6070
aVC# or VB
p6071
aVNET are the better choices
p6072
aVC++/CLI's feature set got frozen around 2005, it has no support for more recent additions like lambdas or Linq syntax
p6073
aVNor does the IDE support many of the bells and whistles available in the C# and VB
p6074
aVNET IDEs
p6075
aVNotable is that VS2010 will initially ship without IntelliSense support for C++/CLI
p6076
aVA bit of a kiss-of-death there
p6077
aVUPDATE: revived in VS2012, IntelliSense support is back
p6078
aVNot in the least thanks to C++/CX, a language extension that simplifies writing WinRT apps in C++
p6079
aVIts syntax is very similar to C++/CLI
p6080
as(dp6081
g9
V17034
p6082
stp6083
a((dp6084
g2
(lp6085
Vnetmodules are intermediate files
p6086
aVA collection of them creates an assembly
p6087
aVOnly an assembly can store executable code
p6088
as(dp6089
g9
V17034
p6090
stp6091
a((dp6092
g2
(lp6093
VThere is no obvious correlation between lines of C# code and the IL that's generated for them
p6094
aVEspecially anonymous methods, lambdas, iterators and Linq queries can be very compact in C# but generate a lot of IL
p6095
aVYou'd have to use ildasm
p6096
aVexe to get to the bottom of it
p6097
aVIf you'd really want to find out
p6098
as(dp6099
g9
V17034
p6100
stp6101
a((dp6102
g2
(lp6103
VYou should not use the KeyDown event to recognize typing keys like @
p6104
aVThe translation from virtual key code (KeyEventArgs
p6105
aVKeyData) to a typing key is dependent on the keyboard layout
p6106
aVWhich is probably different in the UK from the one in the USA, you've got a pound to squeeze in somewhere
p6107
aVAnd surely different on a keyboard in a far East location
p6108
aVUse the KeyPressed event instead
p6109
as(dp6110
g9
V17034
p6111
stp6112
a((dp6113
g2
(lp6114
VYou should avoid the architecture you are contemplating
p6115
aVGetting two separate processes to work together is complicated
p6116
aVThe operating system puts up a big wall between processes to make sure that one misbehaving process cannot destabilize another
p6117
aVProcesses each have their own view of memory, Windows (and
p6118
aVNET especially) makes it very difficult for processes to share memory
p6119
aVYou'd have to establish a communication channel between processes to get them to work together
p6120
aVA pipe or a socket is the usual choice, the mental model here is of machines talking to each other over a network
p6121
aVThis can be very awkward, you'd have all of the disadvantages of a web application, none of the advantages of a WinForms client or console mode app
p6122
aVIt is also very unreliable, failure of one process is hard to diagnose, report and recover from by the other app
p6123
aVI'm sure you've seen what can go wrong from using your Internet browser
p6124
aVYou can get what you want from one application
p6125
aVThe System
p6126
aVThreading
p6127
aVThread class gives you the moral equivalent of your console mode app
p6128
aVGetting the UI to display messages from the brain thread is fairly simple with the BackgroundWorker class or the Control
p6129
aVBegin/Invoke() method
p6130
aVOnly "fairly" btw, getting thread interop right is still an effort
p6131
aVThere are two ways to get the stock ticker update implemented
p6132
aVThe push vs the pull approach
p6133
aVThe push approach is letting the background thread actively notify the UI thread that an update is available
p6134
aVBackgroundWorker
p6135
aVReportProgress or Control
p6136
aVBegin/Invoke to do that
p6137
aVAt 200 msec updates, this is not a problem
p6138
aVAt rates like this, the pull model will work just as well
p6139
aVYou'd use a Timer in the UI to get a method to run periodically
p6140
aVIt could read the value from a shared property in the timer's Tick method
p6141
aVYou'll need to use the lock statement in both the background thread and the Tick method to ensure that the value cannot change just as the UI thread is reading the value
p6142
aVYou should favor the pull model when the value can change very rapidly, pushing at a rate that will bring the UI thread to its knees when the time needed to update the UI is longer than the period between updates from the background thread
p6143
aVThe UI thread will fall behind and doesn't get around to its normal duties
p6144
aVA frozen UI is the diagnostic, OOM is the end result
p6145
aV200 msec should not be a problem unless you get very fancy or sloppy with your UI updates, push should work
p6146
aVI'll have to join the league of friends you consulted about telnet servers
p6147
aVNot sure what problem they solve, they are the 1990 equivalent of a web server when everybody was using a green screen terminal to talk to a computer
p6148
aVIt perhaps applies to the need of connecting a separate console mode app to a UI app
p6149
aVYou wouldn't use telnet to do that, a socket is a generic channel
p6150
aVNET Remoting or, better, WCF is the layer that sits on top of that channel to avoid having to deal with the complications of squeezing data or method parameters through a pipe of bytes
p6151
aVPursue that if you are completely boxed into a multi-process solution already
p6152
aVYou shouldn't be for a stock ticker app, nobody cares which way they tick if there isn't anybody there to look at them
p6153
aVFalling tree in the forest, perhaps
p6154
as(dp6155
g9
V17034
p6156
stp6157
a((dp6158
g2
(lp6159
VWith your function signature as posted you don't have to worry about byte order
p6160
aVIt accepts a char*, that can only handle 8-bit characters
p6161
aVWith one byte per character, you cannot have a byte order problem
p6162
aVYou'd only run into a byte order problem if you send Unicode, either in UTF16 or UTF32 encoding
p6163
aVAnd the endian-ness of the sending machine doesn't match the one of the receiving machine
p6164
aVThe simple solution for that is to use UTF8 encoding
p6165
aVWhich is what most text is sent as across networks
p6166
aVBeing byte oriented, it doesn't have a byte order issue either
p6167
aVOr you could send a BOM
p6168
as(dp6169
g9
V17034
p6170
stp6171
a((dp6172
g2
(lp6173
VThe IDE looks in the IntelliSense database for the symbol and reports this message if it can't find it
p6174
aVThe usual advice is to delete the hidden
p6175
aVncb file in the project directory so the IDE is forced to re-scan the code to rebuild the database
p6176
aVThat usually worked in VS6, not so much in later editions
p6177
aVFinding the line of code where the IntelliSense parser choked on your code isn't easy
p6178
aVVS2010 will contain a completely redone IntelliSense parser, hopefully much improved
p6179
as(dp6180
g9
V17034
p6181
stp6182
a((dp6183
g2
(lp6184
VSQL Server puts a hard lock on the database files when it is running
p6185
aVStop it first with the service manager
p6186
as(dp6187
g9
V17034
p6188
stp6189
a((dp6190
g2
(lp6191
VOn MSVC you can use _atoflt(), defined in stdlib
p6192
aVh
p6193
as(dp6194
g9
V17034
p6195
stp6196
a((dp6197
g2
(lp6198
VThere isn't anything wrong with using the P/Invoke marshaller, it is not unsafe and you don't have to use the unsafe keyword
p6199
aVGetting it wrong will just produce bad data
p6200
aVIt can be a lot easier to use than explicitly writing the deserialization code, especially when the file contains strings
p6201
aVYou can't use BinaryReader
p6202
aVReadString(), it assumes that the string was written by BinaryWriter
p6203
aVMake sure however that you declare the structure of the data with a struct declaration, this
p6204
aVGetType() is not likely to work out well
p6205
aVHere's a generic class that will make it work for any structure declaration:
p6206
aVA sample declaration for the structure of the data in the file:
p6207
aVYou'll need to tweak the structure declaration and the attributes to get a match with the data in the file
p6208
aVSample code that reads a file:
p6209
as(dp6210
g9
V17034
p6211
stp6212
a((dp6213
g2
(lp6214
VThe differences are very minor in the
p6215
aVNET world
p6216
ag3471
aVexe is simply an assembly that was compiled with the /target:winexe compiler option and contains a static Main() method in one of its types
p6217
aVAs opposed to a DLL type of assembly, compiled with the /target:library option
p6218
aVHaving an entry-point is very important for a
p6219
aVexe, that's where the program starts executing
p6220
aVEvery Windows program gets started that way
p6221
aVYou just don't see it in a ASP
p6222
aVNET app, the
p6223
aVexe that runs your code is iis
p6224
aVexe
p6225
aVTo confuse you more, an assembly that is compiled to a
p6226
aVexe in
p6227
aVNET works just as well as a
p6228
aVdll
p6229
aVYou only have to use Assembly
p6230
aVLoadFrom() in your code and you'll have access to all the types in the
p6231
aVexe module, just like you'd have in a
p6232
aVdll module
p6233
aVKey point is that if the CLR isn't hosted by some other executable process, like ASP
p6234
aVNET or SQL server or MMC or the myriad of programs that leverage CorBindToRuntimeEx(), you'll need to tell
p6235
aVNET where your code starts executing
p6236
aVMain point that it starts at Main()
p6237
as(dp6238
g9
V17034
p6239
stp6240
a((dp6241
g2
(lp6242
VThe dialog filters fonts that won't work in GDI+
p6243
aVDevice fonts and OpenType fonts won't show up, only TrueType fonts are supported
p6244
aVThe Helvetica font is published by Adobe, that would make it highly likely to be an OpenType font
p6245
aVYou would have to switch to WPF to be able to use this font
p6246
as(dp6247
g9
V17034
p6248
stp6249
a((dp6250
g2
(lp6251
VMost vertical scrolling in a DGV happens because the user is entering rows of data or pressing the up/down arrow keys on the keyboard
p6252
aVThere is no "end-scroll" action for that
p6253
aVIf that's not an issue, you can detect the user operating the scrollbar directly with this code:
p6254
aVPaste this in a new class
p6255
aVCompile
p6256
aVDrop the new control from the top of the toolbox onto your form
p6257
as(dp6258
g9
V17034
p6259
stp6260
a((dp6261
g2
(lp6262
VThe generic diagnostic is that there is something wrong with the message pump
p6263
aVYou are not complaining that the controls do not paint themselves at all so it seems unlikely that this is completely broken
p6264
aVIf this is an occasional painting problem then the diagnostic is that you've got a threading problem
p6265
aVIn other words, you are updating the control properties, or calling Invalidate/Update, from the wrong thread
p6266
aVWindows Forms has built-in diagnostics for this, active when a debugger is attached
p6267
aVMake sure you don't set the Control
p6268
aVCheckForIllegalCrossThreadCalls to false
p6269
aVNext place to look is the message pump itself
p6270
aVWhen you display the forms with their Show() method instead of ShowDialog() then your unmanaged message pump will be dispatching messages
p6271
aVThat has some undesirable side-effects by itself, keyboard accelerators won't work anymore, nor does tabbing
p6272
aVCheck if the problem disappears if you use ShowDialog()
p6273
aVYour comment provides another hint at what might the problem
p6274
aVIf you get False from InvokeRequired when you know that you're calling from another thread and you don't see any visible sign of your update then you are using the wrong Form object reference
p6275
aVPossibly one you created with the new operator
p6276
aVMake sure you use the existing one, Application
p6277
aVOpenForms[] can give you a reference if you have trouble getting one
p6278
as(dp6279
g9
V17034
p6280
stp6281
a((dp6282
g2
(lp6283
VA properly declared exported function would look like this:
p6284
aVThe declarators, in order, do this:
p6285
aVsuppresses C++ name decoration
p6286
aVOn a 32-bit machine, the exported name will be _Foo@0, the P/Invoke marshaller has no trouble finding such a name
p6287
aVWithout it, the exported name will be
p6288
aVFoo@@YGXXZ
p6289
aVThe marshaller cannot find such a name, you'd have to use the EntryPoint property in the [DllImport] attribute to help it
p6290
aVC++ decorates names like this to support method overloading and type-safe linking
p6291
aVis a hint to the linker to place the function in the DLL export table
p6292
aVIt does the same thing as a
p6293
aVDEF file, without the hassle of maintaining such a file
p6294
aVsets the calling convention, the way the arguments are passed to the function
p6295
aV32-bit code has 5 possible calling conventions ()
p6296
aVAlmost all external software assumes  as the default, including the P/Invoke marshaller
p6297
aVThe default for C/C++ code is however
p6298
aVDllImportAttribute
p6299
aVCallingConvention is available to override the default on the managed side
p6300
aVYour principal tool to troubleshoot this kind of stuff is Dumpbin
p6301
aVexe
p6302
aVRun it from the Visual Studio command prompt on your DLL with the /exports option
p6303
aVIt lists the names of the functions found in the export table of the DLL
p6304
aVYou mentioned COM, that's a completely different story
p6305
aVA COM server doesn't export its functions, it uses a "class factory" [sic]
p6306
aVAn in-process server exports only 4 functions:
p6307
aVDllRegisterServer
p6308
aVUsed by Regsvr32
p6309
aVexe to register the server in the registry
p6310
aVDllUnregisterServer
p6311
aVAs above, used to remove registration
p6312
aVDllCanUnloadNow
p6313
aVCalled by the COM plumbing periodically to check if the server is no longer need and can be unloaded from memory
p6314
aVDllGetClassObject
p6315
aVThat's the important one, it is called by COM when the client calls CoCreateObject()
p6316
aVThe COM server implements it by creating the COM coclass and returning an interface pointer to the requested interface
p6317
aVWhich the COM client then uses to call the methods on the interface
p6318
aVThe interface pointer points to a list of function addresses implemented by the interface, much like an interface works in
p6319
aVNET
p6320
aVCreating these 4 exported function is very commonly the job of whatever class library you use to implement the COM server
p6321
aVThe weapon of choice in C++ is ATL
p6322
as(dp6323
g9
V17034
p6324
stp6325
a((dp6326
g2
(lp6327
VAssuming you follow the common practice of putting one class in one source code file: select the classes you don't want to include in Solution Explorer and set their Build Action property to None
p6328
as(dp6329
g9
V17034
p6330
stp6331
a((dp6332
g2
(lp6333
VThose controls really ought to be somewhere else than on a TabPage
p6334
aVBut you can get what you want by implementing the SelectedIndexChanged event and change the Parent of the control
p6335
aVThis sample code keeps the text box on the selected tab:
p6336
as(dp6337
g9
V17034
p6338
stp6339
a((dp6340
g2
(lp6341
VWhy don't you just add a property to the class of the serialized object that tells you what it is
p6342
aVI'd propose IsXml
p6343
as(dp6344
g9
V17034
p6345
stp6346
a((dp6347
g2
(lp6348
VI assume you are talking about hooking a window in another application
p6349
aVThat's a non-trivial problem, the wparam and lparam arguments may contain pointers instead of simple values
p6350
aVThose pointers are however only valid in the virtual memory space of the process who's window you hooked
p6351
aVIgnoring this will buy you an AccessViolation exception
p6352
aVYou have to P/Invoke ReadProcessMemory() to read the pointed-to structure
p6353
aVThat needs to be done for each individual message, you can't count on a generic implementation
p6354
aVThat can get quite hairy when you hook a non-trivial window like a ListView or TreeView
p6355
as(dp6356
g9
V17034
p6357
stp6358
a((dp6359
g2
(lp6360
VIt is not an issue, the event getting Set before you WaitOne is fully supported
p6361
aVAutoResetEvent would be quite unusable if this wasn't the case
p6362
as(dp6363
g9
V17034
p6364
stp6365
a((dp6366
g2
(lp6367
VTools hard-coding for code page 1252 on Windows is very unlikely
p6368
aVMuch more likely is that it happens to be the default code page on your machine
p6369
aV1252 is used in Western Europe and the Americas
p6370
aVIt is configured in Control Panel, Regional and Language options
p6371
aVThey've been using different names for it, on Win7 it is in the Administrative tab, Change System Locale
p6372
aVYes, many tools use the default code page unless they have a good reason to chose another encoding
p6373
aVThe BOM is such a good reason
p6374
aVNotable examples are Notepad (unless you change the Encoding in the File + Open dialog to something else than Ansi) and C/C++ compilers
p6375
aVThere typically isn't anything special you need to do to use the default code page
p6376
aVGuessing the correct code page for a text file when you don't have a BOM is impossible to do accurately
p6377
aVGoogle "bush hid the facts" for a very amusing war story
p6378
as(dp6379
g9
V17034
p6380
stp6381
a((dp6382
g2
(lp6383
VImplement a handler for the AppDomain
p6384
aVAssemblyResolve event
p6385
aVIt tells you which assembly it is looking for with ResolveEventArgs
p6386
aVName
p6387
aVIf this is just an effort to troubleshoot this particular assembly then use Fuslogvw
p6388
aVexe
p6389
aVIf the hangup is an unmanaged assembly then DependencyWalker's Profile option can show you what LoadLibrary() call is failing
p6390
aVSysInternals' ProcMon will work too but is a lot noisier
p6391
as(dp6392
g9
V17034
p6393
stp6394
a((dp6395
g2
(lp6396
VThis kind of feat can only be accomplished if you create a window that's allowed to extend past the boundaries of the form
p6397
aVWindows supports this, the dropdown list of a combo box would be an example
p6398
aVWindows Forms however doesn't care much for it
p6399
aVCheck my code in this thread to see how it's done
p6400
as(dp6401
g9
V17034
p6402
stp6403
a((dp6404
g2
(lp6405
VYou won't get meaningful results until you configure the debugger
p6406
aVTools + Options, Debugging, General, turn off "Suppress JIT optimization on module load"
p6407
aVSwitch to the Release mode configuration
p6408
aVA sample snippet:
p6409
aVYou are doing it right if the disassembly looks like this:
p6410
aVYou'll have to fool the JIT optimizer to force the expression to be evaluated
p6411
aVUsing Console
p6412
aVWriteLine(variable) can help
p6413
aVThen you ought to see something like this:
p6414
aVYup, it evaluated the result at compile time
p6415
aVWorks pretty well, doesn't it
p6416
as(dp6417
g9
V17034
p6418
stp6419
a((dp6420
g2
(lp6421
VManaged code doesn't use a linker
p6422
aVThe C/C++ equivalent of a reference assembly is the #include directive, you need that in C/C++ to allow the compiler to generate code for an external type
p6423
aVExact same thing in C#, you can't use an external type unless the compiler has a definition for it
p6424
aVThe reference assembly supplies that
p6425
aVThe equivalent of C/C++ linking is done at runtime in a managed program
p6426
aVThe JIT compiler loads assemblies as needed to generate machine code
p6427
aVOne thing you can do in a C# program that you can't do in a C/C++ program is using Reflection
p6428
aVIt allows you to invoke a constructor and call a type's methods with type and method names as strings
p6429
aVStart that ball rolling with Assembly
p6430
aVGetType() and the methods of the Type class
p6431
aVHowever, consider a plug-in model with, say, the System
p6432
aVAddIn namespace first
p6433
as(dp6434
g9
V17034
p6435
stp6436
a((dp6437
g2
(lp6438
VThe System
p6439
aVDiagnostics
p6440
aVStopwatch class uses QueryPerformanceCounter(), saves you from having to P/Invoke it
p6441
as(dp6442
g9
V17034
p6443
stp6444
a((dp6445
g2
(lp6446
VYou can do this by trapping the WM_NCRBUTTONDOWN notification that Windows sends when the user right-clicks the title bar
p6447
aVThe control class does not have an event for it, you'll need to override WndProc()
p6448
aVHere's an example form, you'll need to add a ContextMenuStrip:
p6449
as(dp6450
g9
V17034
p6451
stp6452
a((dp6453
g2
(lp6454
VGDI+ does not generate very good exception messages
p6455
aVThe exception you got is flaky, this one will generate it reliably on my machine:
p6456
aVWhat's really going on is that this bitmap requires too much contiguous unmanaged memory to store the bitmap bits, more than is available in your process
p6457
aVOn a 32-bit operating system, you can only ever hope to allocate a chunk of memory around 550 megabytes
p6458
aVThat goes quickly down-hill from there
p6459
aVThe issue is address space fragmentation, the virtual memory of your program stores a mix of code and data at various addresses
p6460
aVTotal memory space is around 2 gigabytes but the biggest hole is much smaller than that
p6461
aVYou can only consume all memory with lots of small allocations, big ones fail much quicker
p6462
aVLong story short: it is trying to tell you that the size you requested cannot be supported
p6463
aVA 64-bit operating system doesn't have this problem
p6464
aVAlso, WPF relies on WIC, an imaging library that's a lot smarter about allocating buffers for bitmaps
p6465
as(dp6466
g9
V17034
p6467
stp6468
a((dp6469
g2
(lp6470
VIt doesn't make sense to validate a string, these are numbers
p6471
aVConvert to a number first:
p6472
as(dp6473
g9
V17034
p6474
stp6475
a((dp6476
g2
(lp6477
VYou'll need to call CoCreateInstance()
p6478
aVYou can find a P/Invoke declaration for it here
p6479
aVIf you only have a ProgID then you need to call CLSIDFromProgID() first
p6480
aVMake sure you've exhausted all possibilities of finding a type library for the COM server (Tlbimp
p6481
aVexe), this kind of code isn't easy to get right
p6482
as(dp6483
g9
V17034
p6484
stp6485
a((dp6486
g2
(lp6487
VInteresting look in the gears that run the machine
p6488
aVI have a bit of a problem explaining why there are multiple distinct values (I got 4) when a double can be aligned only two ways
p6489
aVI think alignment to the CPU cache line plays a role as well, although that only adds up to 3 possible timings
p6490
aVWell, nothing you can do about it, the CLR only promises alignment for 4 byte values so that atomic updates on 32-bit machines are guaranteed
p6491
aVThis is not just an issue with managed code, C/C++ has this problem too
p6492
aVLooks like the chip makers need to solve this one
p6493
aVIf it is critical then you could allocate unmanaged memory with Marshal
p6494
aVAllocCoTaskMem() and use an unsafe pointer that you can align just right
p6495
aVSame kind of thing you'd have to do if you allocate memory for code that uses SIMD instructions, they require a 16 byte alignment
p6496
aVConsider it a desperation-move though
p6497
as(dp6498
g9
V17034
p6499
stp6500
a((dp6501
g2
(lp6502
VYes, you can use WebBrowser and use its Document property to modify the DOM
p6503
aVThis example code runs a google query with the I Feel Lucky button:
p6504
aVKnowing the DOM structure of the web page is essential to make this work
p6505
aVI use Firebug, there are many others
p6506
as(dp6507
g9
V17034
p6508
stp6509
a((dp6510
g2
(lp6511
VThere's no way tell, unless the other process explicitly forbids access to the file
p6512
aVIn MSVC, you'd do so with , specifying  for the shflag argument
p6513
aVThe notion of being interested whether a file is opened that isn't otherwise locked is deeply flawed on a multitasking operating system
p6514
aVIt might be opened a microsecond after you'd have found it wasn't
p6515
aVThat's also the reason that Windows doesn't have a IsFileLocked() function
p6516
aVIf you need synchronized access to files, you'll need to add this with a named mutex, use CreateMutex()
p6517
as(dp6518
g9
V17034
p6519
stp6520
a((dp6521
g2
(lp6522
VThe details of ExecutionContext are very obscure, buried deep inside features like
p6523
aVNET Remoting and WCF
p6524
aVWhat is part of it is:
p6525
aVHostExecutionContext
p6526
aVIllogicalCallContext, a repository of thread specific data used by Remoting
p6527
aVLogicalContext, as above
p6528
aVSecurityContext
p6529
aVSynchronizationContext
p6530
aVCultureInfo is not part of it, which can be a considerable problem if you change your main thread's default culture
p6531
aVThere is no good way to ensure other threads run with that culture unless you explicitly write the code to switch them
p6532
aVThat's not always practical, given that
p6533
aVNET is apt to run async callbacks on threadpool threads
p6534
aVThey will be initialized to the system default culture
p6535
aVEdit: this problem got fixed in
p6536
aVNET 4
p6537
aV5 with the CultureInfo
p6538
aVDefaultThreadCurrentCulture property
p6539
as(dp6540
g9
V17034
p6541
stp6542
a((dp6543
g2
(lp6544
VAn event is an accessor for a delegate object, just like a property is an accessor for a field
p6545
aVThe accessors are named "add" and "remove" instead of "get" and "set"
p6546
aVOne difference is that the compiler automatically generates accessors if you don't provide your own
p6547
aVYou can't understand what an event really does until you understand what a delegate does
p6548
aVGoogle away on that keyword
p6549
as(dp6550
g9
V17034
p6551
stp6552
a((dp6553
g2
(lp6554
VI don't get the "swap files" angle, swap with what
p6555
aVBut, no, a setup project can't compile code
p6556
aVYou'd need separate build projects or leverage #ifdef
p6557
as(dp6558
g9
V17034
p6559
stp6560
a((dp6561
g2
(lp6562
VThat's not an error, it is just a diagnostic from the debugger
p6563
aVIt is telling you that it can't give you debug info on whatever you put in the watch window
p6564
aVThat's common with code that is compiled in the Release configuration, the JIT compiler optimizes the machine code and commonly puts local variables in CPU registers
p6565
aVMaking their value unavailable to the debugger, it isn't smart enough to figure out what register was used
p6566
aVIt occasionally happens in the Debug release as well when there's unmanaged code on the call stack
p6567
aVWhich is not uncommon for WebBrowser, there's a very large chunk of unmanaged code that makes it work
p6568
aVWFIW, just switching the thread's apartment state to STA is not enough
p6569
aVThe thread must also pump a Windows message loop to make a single-threaded apartment operate properly
p6570
aVIf you don't, you'll see that operations on STA objects like WebBrowser will deadlock
p6571
aVFor example, you'll never get the DocumentCompleted event when you navigate to a site
p6572
aVRunning a message loop requires calling Application
p6573
aVRun() or Form
p6574
aVShowDialog() in a WF app
p6575
as(dp6576
g9
V17034
p6577
stp6578
a((dp6579
g2
(lp6580
VMaking events static is a great way to shoot the foot
p6581
aVA static event has an unlimited life-time
p6582
aVWhich makes any event handlers you register for the event live forever too
p6583
aVWhich makes any form that contains such an event handler live forever too
p6584
aVA leak
p6585
aVRegistering an event handler for a static event requires code in, say, the FormClosing event handler that explicitly unregisters the handler
p6586
aVYou can see this explicitly documented in the MSDN Library article for the SystemEvents class, one of the few examples of a class in the
p6587
aVNET framework that has static events
p6588
aVThe better approach is to keep track of the form instance whose button's Click event should be activated
p6589
aVSomething like this:
p6590
aVWhich allows client code to do this:
p6591
as(dp6592
g9
V17034
p6593
stp6594
a((dp6595
g2
(lp6596
VI don't really understand why you would be able to make it work in one but not the other
p6597
aVPreventing a form from getting visible when its Show() method is called requires overriding the SetVisibleCore method
p6598
aVPerhaps you can leverage this code:
p6599
as(dp6600
g9
V17034
p6601
stp6602
a((dp6603
g2
(lp6604
V has unusual keyboard shortcut processing, they are reflected to the  method
p6605
aVThis was done to avoid it disturbing the keyboard handling for the controls on a tab page
p6606
aVYou'll have to override the method
p6607
aVAdd a new class to your project and paste the code shown below
p6608
aVCompile
p6609
aVDrop the new control from the top of the toolbox onto your
p6610
as(dp6611
g9
V17034
p6612
stp6613
a((dp6614
g2
(lp6615
VYour question is much too vague to allow a good answer
p6616
aVThere are many variants and versions of PCL
p6617
aVBest thing to do is to install the printer driver of a HP device that's similar to the whatever device is going to use the
p6618
aVpcl
p6619
aVIf that's unspecified, pick a HP laser printer that as old as possible
p6620
aVGenerate the file by using the PrintDocument class
p6621
aVYou'll need to set the PrinterSettings
p6622
aVPrintToFile property to True and assign PrinterSettings
p6623
aVPrintFileName
p6624
as(dp6625
g9
V17034
p6626
stp6627
a((dp6628
g2
(lp6629
VYour P/Invoke declaration is wrong, it dates back to the VB6 era
p6630
aVUse pinvoke
p6631
aVnet to find the VB
p6632
aVNET equivalents
p6633
aVBut first take a look at the MSDN Library,
p6634
aVNET has vastly improved beyond what VB6 provided
p6635
aVYou don't have to resort to these kind of tricks anymore:
p6636
as(dp6637
g9
V17034
p6638
stp6639
a((dp6640
g2
(lp6641
VThat's Yes and Yes
p6642
aVYou'll have to use the 2003 PIA, Office versions beyond this are backwards compatible with older COM interface specifications
p6643
aVBut of course you won't be able to use 2007 specific features
p6644
aVYou can't do anything with Project if it isn't installed on the machine
p6645
aVProject 2003 isn't likely to be able to read Project 2007 files unless the file was saved in 2003 format
p6646
aVNo problem the other way around
p6647
as(dp6648
g9
V17034
p6649
stp6650
a((dp6651
g2
(lp6652
VThere isn't any difference between de/serializing small or large files
p6653
aVYou would just have to make sure that you don't deserialize very large files to memory, that's going to buy you OOM
p6654
aVAnd large files are going to take more time of course
p6655
aVIf that makes your user interface unresponsive then you'll want to do this processing in a background thread
p6656
aVBackgroundWorker is a typical solution for that
p6657
aVRandom shots in the dark here btw, your question is far too vague
p6658
as(dp6659
g9
V17034
p6660
stp6661
a((dp6662
g2
(lp6663
VToolTip registers event handlers on the control on which it is shown
p6664
aVIt's Hide() method is automatically called when the form's Deactivate event fires
p6665
aVWhich will happen when the form is closed
p6666
aVThat in turn ensures that its Windows handle is destroyed and event handlers are unregistered
p6667
aVAfter that there are no disposable objects left
p6668
aVYou can verify this for yourself with Reflector or the Reference Source
p6669
aVRelevant methods are, in order, BaseFormDeactivate, HideAllToolTips, Hide, ClearTopLevelControlEvents
p6670
aVYou don't have to call Dispose(), you don't have a leak
p6671
as(dp6672
g9
V17034
p6673
stp6674
a((dp6675
g2
(lp6676
VIt is automatic when you declare the external function with the Declare keyword
p6677
aVAll you have to do is declare the argument with ByRef
p6678
aVThat forces the P/Invoke marshaller to pass a pointer to the native code
p6679
aVSame thing as VarPtr
p6680
aVOnly if you pass ByVal do you have to explicitly convert the passed argument to a pointer
p6681
as(dp6682
g9
V17034
p6683
stp6684
a((dp6685
g2
(lp6686
VI would encourage you to get this started with the binaries and sample VS2008 solution available from this website
p6687
aVIt has the exact same sample code you are trying to run (minus the typos) and it worked well on my machine
p6688
aVIf it still doesn't work, you'll need help from the Lua community
p6689
aVA minidump is probably required to help them diagnose this, just the exception message isn't enough
p6690
as(dp6691
g9
V17034
p6692
stp6693
a((dp6694
g2
(lp6695
VWell, it is technically possible, you just need to adjust the control position when the panel scrolls
p6696
aVFor example:
p6697
aVHowever, you'll see that the control will start doing the pogo when you scroll the panel
p6698
aVThe problem here is that Windows is being too helpful
p6699
aVIt scrolls the content of the window itself with a fast bitblt, then sends a paint request for only the parts of the window that needs to be repainted
p6700
aVIt does this directed by a system option named "Show window contents while dragging", available in Appearance + Effects dialog of the Display applet in Control Panel
p6701
aVYou cannot reasonably turn this option off, it has system-wide effects
p6702
aVOn Win7 it isn't even exposed anymore
p6703
aVThere is no good workaround for this, other than a simple one: don't put the control in the panel
p6704
aVJust make sure it is located on top of the panel
p6705
aVThat can be a bit tricky in the designer, put it next to the panel (Bring To Front if necessary) and edit the Location property by hand
p6706
as(dp6707
g9
V17034
p6708
stp6709
a((dp6710
g2
(lp6711
VYes, this is possible, you don't need the source code
p6712
aVDebug + New Breakpoint + Break at Function
p6713
aVSet the location to the name of the function
p6714
aVFor example: "Microsoft
p6715
aVVisualStudio
p6716
aVHostingProcess
p6717
aVHostProc
p6718
aVRunUsersAssembly"
p6719
aVTurn the "Use Intellisense" checkbox off, you won't have any
p6720
aVLanguage is a guess if you don't know what it was written in, choose "Unknown" if you're not sure
p6721
aVYou'll want to keep an eye on the Debug + Windows + Breakpoints window to verify that the debugger could resolve the breakpoint
p6722
aVIt won't be able to until the assembly gets loaded and the method gets JIT compiled
p6723
aVThis is of course not the greatest debugging experience
p6724
aVOnce the breakpoint hits, you don't have anything to look at but the machine code generated by the JIT compiler
p6725
aVAnd the Call Stack window, your ultimate resource to see method names btw
p6726
as(dp6727
g9
V17034
p6728
stp6729
a((dp6730
g2
(lp6731
VYour assumption that the Pulse() call invokes a thread switch is not correct
p6732
aVIt merely moves a thread from the wait queue to the ready queue
p6733
aVThe Exit() call makes the switch, to the thread that's first in the ready queue
p6734
as(dp6735
g9
V17034
p6736
stp6737
a((dp6738
g2
(lp6739
VThe threadpool already does a reasonably good job at this
p6740
aVIt tries to limit the number of running threads to the number of CPU cores in your machine
p6741
aVWhen one thread ends, it immediately schedules another eligible thread for execution
p6742
aVEvery 0
p6743
aV5 seconds, it evaluates what is going on with the running threads
p6744
aVWhen the threads have been running too long, it assumes they are stalled and allows another thread to start executing
p6745
aVYou'll now have more threads running than you have CPU cores
p6746
aVThis can go up to the maximum number of allowed thread, as set by ThreadPool
p6747
aVSetMaxThreads()
p6748
aVStarting around
p6749
aVNET 2
p6750
aV0 SP1, the default maximum number of threads was increased considerably to 250 times the number of cores
p6751
aVYou should never ever get there
p6752
aVIf you do, you would have wasted about 2 minutes of time where a possibly non-optimal number of threads were running
p6753
aVThose threads however would all have to be blocking for that long, not exactly a typical execution pattern for a thread
p6754
aVOn the other hand, if these threads are all waiting on the same kind of resource they are likely to just take turns, adding more threads cannot improve throughput
p6755
aVLong story short, the thread pool will work well if you run threads that execute quickly (seconds at most) and don't block for a long time
p6756
aVYou probably ought to consider creating your own Thread objects when your code doesn't match that pattern
p6757
as(dp6758
g9
V17034
p6759
stp6760
a((dp6761
g2
(lp6762
VBest explained with an example:
p6763
aVType an expression in the breakpoint dialog that evaluates to a simple bool or integral value
p6764
aVFor example: "ix / 2"
p6765
aVWhen you run it, execution will break on the first pass through the loop and only whenever ix is an even value
p6766
aVThis is not a data breakpoint btw, alluded to in another post
p6767
aVThose are not supported in managed code
p6768
aVThe debugger actually breaks program execution temporarily and evaluates the expression every time
p6769
aVOnly to stop execution when the expression value has changed
p6770
aVThis can make your code run a lot slower as a side-effect
p6771
as(dp6772
g9
V17034
p6773
stp6774
a((dp6775
g2
(lp6776
VThis is not correct, you should not automatically update [AssemblyVersion]
p6777
aVThat attribute plays a very important role in the assembly resolution process when the CLR is looking for the correct version of an assembly to load
p6778
aVAlbeit that this is only checked when the assembly is stored in the GAC
p6779
aVIt should only be changed when a developer makes a breaking change in the public interface of the assembly, one that would make it unusable in an app that isn't otherwise recompiled with an updated reference assembly
p6780
aVYou should update [AssemblyFileVersion]
p6781
aVThat's also the version that's visible in Explorer when you look at the Version property tab
p6782
aVNow you also no longer care that much that the file gets checked-in
p6783
aVThe same thing was done with the
p6784
aVNET assemblies from
p6785
aVNET 2
p6786
aV0 through
p6787
aVNET 3
p6788
aV5 SP1
p6789
aVAll the standard assemblies stayed at assembly version 2
p6790
ag2512
ag2512
aV0, the file version has been changed thousands of times
p6791
as(dp6792
g9
V17034
p6793
stp6794
a((dp6795
g2
(lp6796
VYou are supposed to pass a pointer for that argument
p6797
aVThe IStream::Read() function will write the number of bytes that were actually read to the pointed-to location
p6798
aVThis requires unsafe code in C#, for example:
p6799
aVDoing it without the unsafe keyword is possible too:
p6800
aVIf you use this method only occasionally you ought to use Marshal
p6801
aVCoTaskMemFree() to release the memory
p6802
as(dp6803
g9
V17034
p6804
stp6805
a((dp6806
g2
(lp6807
Vor:
p6808
as(dp6809
g9
V17034
p6810
stp6811
a((dp6812
g2
(lp6813
VMessage strings are a UI implementation detail
p6814
aVConsider an enum first
p6815
aVNext, leverage Project + Properties, Resources tab to enter resource strings
p6816
as(dp6817
g9
V17034
p6818
stp6819
a((dp6820
g2
(lp6821
VLimit your word length to 6 letters or less and you might be able to make it work
p6822
aVNot very practical
p6823
as(dp6824
g9
V17034
p6825
stp6826
a((dp6827
g2
(lp6828
VYou will also have to deny FileSystemRights
p6829
aVRead if you want to prevent that
p6830
aVAnd technically you have to make sure that the files inherited their rights from the folder
p6831
as(dp6832
g9
V17034
p6833
stp6834
a((dp6835
g2
(lp6836
VThe scope of declarations inside main() is not the entire program
p6837
aVIt behaves just like any normal function
p6838
aVSo, yes, destructors of local class objects execute as expected
p6839
aVUnless the program terminates abnormally
p6840
as(dp6841
g9
V17034
p6842
stp6843
a((dp6844
g2
(lp6845
VJust before you call SmtpClient
p6846
aVSendAsync(), set the ProgressBar
p6847
aVVisible property to True
p6848
aVSet it to False in an event handler for the SmtpClient
p6849
aVSendCompleted event
p6850
aVThe PB must have its Style property set to Marquee
p6851
aVYou cannot otherwise give accurate progress info, neither the StmpClient nor the MailMessage class has an event that tells you how much of the job got done
p6852
as(dp6853
g9
V17034
p6854
stp6855
a((dp6856
g2
(lp6857
VYou can't make this work in the general case, just a server name isn't enough
p6858
aVThe days that SMTP servers accepted an email message without any authentication are long gone
p6859
aVYou will need to use the SmtpClient
p6860
aVCredentials property to proof to the server that the user is legit
p6861
aVPerhaps more to the point, you only need one SMTP server
p6862
aVAs long as the user can authenticate, s/he can use the server to distribute email to any recipient
p6863
aVAdd a configuration feature to your app so the user can provide the server address, port number and required credentials
p6864
as(dp6865
g9
V17034
p6866
stp6867
a((dp6868
g2
(lp6869
VUse GDI+, it has a JPEG decoder
p6870
aVStart that ball rolling with #include  and a small tutorial to know how to use the Image class and GdiplusStartup properly
p6871
as(dp6872
g9
V17034
p6873
stp6874
a((dp6875
g2
(lp6876
VIt is reading the key from the wrong hive
p6877
aVIt should use HKLM, not HKCU
p6878
aVThe most likely reason for this is registry virtualization
p6879
as(dp6880
g9
V17034
p6881
stp6882
a((dp6883
g2
(lp6884
VThe behavior is defined in chapter 10
p6885
aV3, paragraph 2 of the C++ language specification:
p6886
aVIf a virtual member function vf is
p6887
aVdeclared in a class Base and in a
p6888
aVclass Derived, derived directly or
p6889
aVindirectly from Base, a member
p6890
aVfunction vf with the same name and
p6891
aVsame parameter list as Base::vf is
p6892
aVdeclared, then Derived::vf is also
p6893
aVvirtual ( whether or not it is so
p6894
aVdeclared ) and it overrides Base::vf
p6895
aVA italicized the relevant phrase
p6896
aVThus, if your compiler creates v-tables in the usual sense then all classes will have a v-table since all their f() methods are virtual
p6897
as(dp6898
g9
V17034
p6899
stp6900
a((dp6901
g2
(lp6902
VThere is no relationship
p6903
aVUse the "volatile" keyword
p6904
as(dp6905
g9
V17034
p6906
stp6907
a((dp6908
g2
(lp6909
VThis produced the output you are looking for:
p6910
aVStandards are great, there are so many to choose from
p6911
aVISO never disappoints, there are no less than 3 ISO-2022-JP encodings
p6912
aVIf you have trouble then also try encodings 50221 and 50222
p6913
as(dp6914
g9
V17034
p6915
stp6916
a((dp6917
g2
(lp6918
VPutting a try/catch block in main() is okay, it doesn't cause any problems
p6919
aVThe program is dead on an unhandled exception anyway
p6920
aVIt isn't going to be helpful at all in your quest to get the all-important stack trace though
p6921
aVThat info is gonzo when the catch block traps the exception
p6922
aVCatching a C++ exception won't be very helpful either
p6923
aVThe odds that the program dies on a an exception derived from std::exception are pretty slim
p6924
aVAlthough it could happen
p6925
aVMuch more likely in a C/C++ app is death due to hardware exceptions, AccessViolation being numero uno
p6926
aVTrapping those requires the __try and __except keywords in your main() method
p6927
aVAgain, very little context is available, you've basically only got an exception code
p6928
aVAn AV also tells you which exact memory location caused the exception
p6929
aVThis is not just a cross-platform issue btw, you can't get a good stack trace on any platform
p6930
aVThere is no reliable way to walk the stack, there are too many optimizations (like framepointer omission) that make this a perilous journey
p6931
aVIt is the C/C++ way: make it as fast as possible, leave no clue what happened when it blows up
p6932
aVWhat you need to do is debug these kind of problems the C/C++ way
p6933
aVYou need to create a minidump
p6934
aVIt is roughly analogous to the "core dump" of old, a snapshot of the process image at the time the exception happens
p6935
aVBack then, you actually got a complete dump of the core
p6936
aVThere's been progress, nowadays it is "mini", somewhat necessary because a complete core dump would take close to 2 gigabytes
p6937
aVIt actually works pretty well to diagnose the program state
p6938
aVOn Windows, that starts by calling SetUnhandledExceptionFilter(), you provide a callback function pointer to a function that will run when your program dies on an unhandled exception
p6939
aVAny exception, C++ as well as SEH
p6940
aVYour next resource is dbghelp
p6941
aVdll, available in the Debugging Tools for Windows download
p6942
aVIt has an entrypoint called MiniDumpWriteDump(), it creates a minidump
p6943
aVOnce you get the file created by MiniDumpWriteDump(), you're pretty golden
p6944
aVYou can load the
p6945
aVdmp file in Visual Studio, almost like it's a project
p6946
aVPress F5 and VS grinds away for a while trying to load
p6947
aVpdb files for the DLLs loaded in the process
p6948
aVYou'll want to setup the symbol server, that's very important to get good stack traces
p6949
aVIf everything works, you'll get a "debug break" at the exact location where the exception was thrown"
p6950
aVWith a stack trace
p6951
aVThings you need to do to make this work smoothly:
p6952
aVUse a build server to create the binaries
p6953
aVIt needs to push the debugging symbols (
p6954
aVpdb files) to a symbol server so they are readily available when you debug the minidump
p6955
aVConfigure the debugger so it can find the debugging symbols for all modules
p6956
aVYou can get the debugging symbols for Windows from Microsoft, the symbols for your code needs to come from the symbol server mentioned above
p6957
aVWrite the code to trap the unhandled exception and create the minidump
p6958
aVI mentioned SetUnhandledExceptionFilter() but the code that creates the minidump should not be in the program that crashed
p6959
aVThe odds that it can write the minidump successfully are fairly slim, the state of the program is undetermined
p6960
aVBest thing to do is to run a "guard" process that keeps an eye on a named Mutex
p6961
aVYour exception filter can set the mutex, the guard can create the minidump
p6962
aVCreate a way for the minidump to get transferred from the client's machine to yours
p6963
aVWe use Amazon's S3 service for that, terabytes at a reasonable rate
p6964
aVWire the minidump handler into your debug database
p6965
aVWe use Jira, it has a web-service that allows us to verify the crash bucket against a database of earlier crashes with the same "signature"
p6966
aVWhen it is unique, or doesn't have enough hits, we ask the crash manager code to upload the minidump to Amazon and create the bug database entry
p6967
aVWell, that's what I did for the company I work for
p6968
aVWorked out very well, it reduced crash bucket frequency from thousands to dozens
p6969
aVPersonal message to the creators of the open source ffdshow component: I hate you with a passion
p6970
aVBut you're no longer crashing our app anymore
p6971
aVBuggers
p6972
as(dp6973
g9
V17034
p6974
stp6975
a((dp6976
g2
(lp6977
VFirst check the Output window, it will show whether or not it could find debugging symbols for the DLL when it got loaded
p6978
aVNext, switch to Debug + Windows + Modules, right-click your DLL and choose "Symbol load information"
p6979
aVThat shows where the debugger looked for
p6980
aVpdb files for the DLL
p6981
aVEnsure the
p6982
aVpdb is located in one of these paths
p6983
aVIf the problem is not getting source code for the DLL instead of missing
p6984
aVpdb files, first delete the hidden
p6985
aVsuo file in the solution directory
p6986
aVThe next time you debug into the DLL, Visual Studio will again prompt you to provide the path to the source code file
p6987
aVDon't press Escape, enter the path
p6988
aVAnother thing you can do is right-click the solution in the Solution Explorer window, Properties, Common Properties, Debug Source Files
p6989
aVAdd the path to the DLL source code directory
p6990
as(dp6991
g9
V17034
p6992
stp6993
a((dp6994
g2
(lp6995
VCheck out the CountdownLatch class in this magazine article
p6996
as(dp6997
g9
V17034
p6998
stp6999
a((dp7000
g2
(lp7001
VYour link points to a 6 year old blog post
p7002
aVIt has a disclaimer on the top: "Alert
p7003
aVThis ancient trifle retrieved from the Joel on Software archive is well-paft its expiration date
p7004
aVProceed with care
p7005
aVWell, that's accurate
p7006
aVThe
p7007
aVNET framework is nowadays installed everywhere
p7008
aVIf not through Windows Update then preloaded on Vista and Win7
p7009
aVThese days, getting a non-trivial native C/C++ app installed is considerably harder
p7010
aVGetting the right versions of the side-by-side DLLs deployed can be quite a headache
p7011
aVNET clearly meets the "everything else" requirement
p7012
aVOh, and it has excellent support for writing services
p7013
as(dp7014
g9
V17034
p7015
stp7016
a((dp7017
g2
(lp7018
VUse the VB
p7019
aVNET Declare statement to redeclare the API function in your code
p7020
aVThis will not work if the header file contains classes, you'll need to write a wrapper to make those usable
p7021
as(dp7022
g9
V17034
p7023
stp7024
a((dp7025
g2
(lp7026
VTextBox doesn't have an event that tells you that the user moved the caret
p7027
aVYou'll have to synthesize one, possible with the Application
p7028
aVOnIdle event
p7029
aVIt runs after all input events (mouse, keyboard) are processed
p7030
aVYou'll do a bit of extra unnecessary work but you'll never notice since this code runs in "human-time"
p7031
aVFor example:
p7032
aVIf the extra work bothers you then check if the text box has the focus and keep track of its last SelectionStart value
p7033
as(dp7034
g9
V17034
p7035
stp7036
a((dp7037
g2
(lp7038
VI'm seeing a pretty silly bug in the ComboBox
p7039
aVUpdateDropDownHeight() method
p7040
aVWhen the DropDownHeight property matches the default value, it calculates a custom height to fit the dropdown to the number of items
p7041
aVIt does this even when you changed the DrawMode, that's plain wrong
p7042
aVThe workaround:
p7043
aVYou'll get a one pixel gap, you should be able to hide that in your OnDrawItem() overload
p7044
as(dp7045
g9
V17034
p7046
stp7047
a((dp7048
g2
(lp7049
VBoth Object
p7050
aVcpp files will be compiled to Object
p7051
aVobj
p7052
aVInto the same directory
p7053
aVIn other words, the last one that is compiled will overwrite the Object
p7054
aVobj of the first one
p7055
aVYes, the linker isn't going to be thrilled by that, you'll get multiply defined symbols since it links the same Object
p7056
aVobj file twice
p7057
aVThe fix is easy, right-click one of the Object
p7058
aVcpp files, Properties, C/C++, Output Files
p7059
aVChange the Object File Name from $(IntDir)\u005c to, say, $(IntDir)\u005c$(InputName)2
p7060
aVobj
p7061
as(dp7062
g9
V17034
p7063
stp7064
a((dp7065
g2
(lp7066
VThis blog post by our esteemed benefactor is relevant
p7067
aVGDI+ indeed does things the Apple way, it uses true resolution independent rendering
p7068
aVIt was pretty widely panned for this, so much so that it was replaced in
p7069
aVNET 2
p7070
aV0 with the TextRenderer class
p7071
aVWhich uses the GDI DrawTextEx() function to draw text
p7072
aVTo give an example of how GDI+ can suck, try running this sample Windows Forms form:
p7073
aVYMMV, but I haven't yet had a machine where that didn't look completely awful
p7074
aVTextRenderer saved the day
p7075
aVUntil
p7076
aVNET 3
p7077
aV0 when WPF was introduced
p7078
aVBack to resolution independent rendering
p7079
aVThe amount of hate that generated was stunning
p7080
aVLong story short, the majority of users like GDI text rendering
p7081
aVOr at least they get very vocal when they don't get it
p7082
aVVisual Studio and Chrome no doubt use GDI for text output
p7083
aVThis is not something you can easily change yourself, although Chrome is open source afaik
p7084
aVJust wait for the next version
p7085
aVVisual Studio 2010 will use WPF
p7086
aVBeta 1 generated a lot of hate for blurry text
p7087
aVBut WPF has been tweaked to limit the fuzzies so it might not fit your taste anymore
p7088
as(dp7089
g9
V17034
p7090
stp7091
a((dp7092
g2
(lp7093
VIn my phone book, John O'Leary sorts between Ole Tractors and Dennis Oleck
p7094
aVYou'll have to use a non-culture dependent sort:
p7095
as(dp7096
g9
V17034
p7097
stp7098
a((dp7099
g2
(lp7100
VThis is the implementation of the operator:
p7101
aVDon't lose any sleep over this
p7102
as(dp7103
g9
V17034
p7104
stp7105
a((dp7106
g2
(lp7107
VIt is sorta possible, you could use P/Invoke to call the SendMessage() method and generate the WM_COMMAND messages for the Edit + Select-All and Edit + Copy menu commands
p7108
aVThat puts all text on the clip board, readily accessible to your program
p7109
aVYou'll need to use the Spy++ utility to find out what the command identifiers are
p7110
aVLooks like 25 and 769 when I look at it on Win7
p7111
aVThere's a more direct way to discover the commands
p7112
aVIn Visual Studio choose File + Open + File and select c:\u005cwindows\u005cnotepad
p7113
aVexe
p7114
aVOpen the Menu node and double-click the "1" resource
p7115
aVThat opens the menu editor, select Edit + Select-All and look at the Properties window for the ID
p7116
aVOf course, this technique is specific to Notepad
p7117
aVThe command IDs will be different for another program
p7118
aVAs will be the code you need to find the proper window handle
p7119
aVUsing Process
p7120
aVMainWindowHandle is treacherous at best, you don't know what specific instance of the process you need to select
p7121
as(dp7122
g9
V17034
p7123
stp7124
a((dp7125
g2
(lp7126
VAsking for modifications like this is pointless, the Windows Forms team has been disbanded quite a while ago
p7127
aVIt is in maintenance mode, only security issues and OS incompatibilities are considered
p7128
aVIt is otherwise simple enough to create your own method to do this:
p7129
aVNow you can write:
p7130
as(dp7131
g9
V17034
p7132
stp7133
a((dp7134
g2
(lp7135
VFix the calling convention mismatch like this:
p7136
aVA typedef can make this more readable:
p7137
aVBut,  already has a typedef for this, you might as well use it:
p7138
as(dp7139
g9
V17034
p7140
stp7141
a((dp7142
g2
(lp7143
VChanging the control designer requires a new control class so you can apply the [Designer] attribute
p7144
aVOnce you go there, the cheap solution is to veto the selection in an override for the Dock property:
p7145
aVIf that's too crude, you can write a UITypeEditor so only the allowed dock styles can be selected and apply it to the overridden Dock property with the [Editor] attribute
p7146
as(dp7147
g9
V17034
p7148
stp7149
a((dp7150
g2
(lp7151
VAdd a class to your project and type these using statements
p7152
aVFile + Export Template
p7153
aVSelect Item template, Next
p7154
aVTick your class, Next
p7155
aVTick System and System
p7156
aVCore, Next
p7157
aVPick good values here, to your taste
p7158
aVFinish
p7159
aVYou can now start a new source code file from this template with Project + Add New Item
p7160
as(dp7161
g9
V17034
p7162
stp7163
a((dp7164
g2
(lp7165
VYou can't do this reliably
p7166
aVFor example, start a new project from the Windows Forms Application project template
p7167
aVProject + Properties, change Output Type to "Console Application"
p7168
aVPress F5 to see what that looks like
p7169
aVWhile every reasonable test will say it is a console mode application, it is very much a WF app
p7170
aVThe opposite is true as well, merely the presence of System
p7171
aVWindows
p7172
aVForms
p7173
aVdll doesn't make it a WF app
p7174
aVA console app might use it to display a MessageBox for example
p7175
aVFurthermore, it could be neither
p7176
aVYour code might be called by a service
p7177
aVPunt this problem, the author of the app never has a problem telling you what your code should do
p7178
aVAdd a property to your class to allow her to do so
p7179
as(dp7180
g9
V17034
p7181
stp7182
a((dp7183
g2
(lp7184
VThe Windows painting model is a good match for your requirements
p7185
aVIt separates drawing the background (OnPaintBackground) from the foreground (OnPaint)
p7186
aVThat however doesn't mean that you can only paint the background once and be done with it
p7187
aVWindow surface invalidation invokes both
p7188
aVThis is above all required to make anti-aliasing effects work properly, they can only look good against a known background color
p7189
aVPunt this and draw the Image in the OnPaintBackground() override
p7190
aVYou can let Control do this automatically for you by assigning the BackgroundImage property
p7191
aVYou'll probably need to set the DoubleBuffer property to true to avoid the flicker you'll see when the background is drawn, temporarily wiping out the foreground pixels
p7192
aVCall Invalidate() if you need to update the foreground
p7193
aVTo be complete, your fantasy is in fact possible
p7194
aVYou'd need to overlay the image with a toplevel layered window
p7195
aVThat is easy to get with a Form whose TransparencyKey property is set
p7196
aVHere is a sample implementation:
p7197
aVOne interesting artifact: minimizing the form and restoring it again looks, erm, special
p7198
as(dp7199
g9
V17034
p7200
stp7201
a((dp7202
g2
(lp7203
VYou have to tell the designer that it should not serialize the value of the BackgroundImage property
p7204
aVYou do this by using the  attribute:
p7205
aVI also used the  attribute, it no longer makes sense for the user to change the image since changes won't be persisted anymore
p7206
as(dp7207
g9
V17034
p7208
stp7209
a((dp7210
g2
(lp7211
VI think I see this too
p7212
aVThe size of the calendar is calculated by a private method named GetMinReqRect()
p7213
aVIt returns a size too large when ShowToday is off
p7214
aVThe comment this method has in the Reference Source is:
p7215
aV*Used internally to get the minimum size needed to display the MonthCalendar
p7216
aVThis is needed because NativeMethods
p7217
aVMCM_GETMINREQRECT returns an incorrect value if showToday is set to false
p7218
aV*
p7219
aVLooks to me somebody in the Windows group fixed the bug and forgot to the tell the WF group about it
p7220
aVUnsurprising, the WF group is very hard to find
p7221
aVI don't see an obvious workaround, the method is private
p7222
aVSetBoundsCore() applies the size, there is no way to bypass it
p7223
aVYou can post the bug to connect
p7224
aVmicrosoft
p7225
aVcom but you'll get the "post to a forum to get help" brush-off
p7226
as(dp7227
g9
V17034
p7228
stp7229
a((dp7230
g2
(lp7231
VThe compiler uses reference assemblies only to load type information
p7232
aVThat comes from the assembly's metadata
p7233
aVThe metadata for x64 specific assemblies is identical to that for x86 assemblies
p7234
aVSo, it doesn't matter
p7235
aVThe compiler does generate a warning for it, you can freely ignore it if you know the 64-bit version of the assembly is installed in the GAC
p7236
aVIt will be when you've got the 64-bit version of the framework installed
p7237
aVOne thing you probably should not do is select x64 as the Platform Target for your project
p7238
aVThis is only required if you must use unmanaged code that is only available in 64-bit machine code
p7239
aVCOM servers, usually
p7240
aVThat is very rare, the typical problem is only having the 32-bit version available
p7241
aVLeaving the target set to Any CPU is the better choice, your binary will run on either platform
p7242
aVAnd the compiler warning will disappear
p7243
as(dp7244
g9
V17034
p7245
stp7246
a((dp7247
g2
(lp7248
VBeware of the small print for the BindingFlags
p7249
aVFlattenHierarchy option:
p7250
aVSpecifies that public and protected
p7251
aVstatic members up the hierarchy should
p7252
aVbe returned
p7253
aVPrivate static members
p7254
aVin inherited classes are not
p7255
aVreturned
p7256
aVStatic members include
p7257
aVfields, methods, events, and
p7258
aVproperties
p7259
aVNested types are not
p7260
aVreturned
p7261
aVThe "static" word in the bolded phrase is an oops, no private members are returned
p7262
aVTo work around this you'll need to move up the inheritance chain through Type
p7263
aVBaseType
p7264
as(dp7265
g9
V17034
p7266
stp7267
a((dp7268
g2
(lp7269
VIt is not a great solution, Application
p7270
aVOpenForms is a bit unreliable, but easy:
p7271
as(dp7272
g9
V17034
p7273
stp7274
a((dp7275
g2
(lp7276
VThe CLR supports module initializers, that's probably what you are looking for
p7277
aVRather academic given your tags though, this feature is not available in the C# language, only the C++/CLI language
p7278
aVThe workaround is entirely painless, call a static method (Initialize
p7279
aVexplicitly
p7280
as(dp7281
g9
V17034
p7282
stp7283
a((dp7284
g2
(lp7285
VCompiler and library validation test suites are readily available
p7286
aVIIRC, Rogue Wave was in that business
p7287
aVBut they cost money, companies that use them tend to have deep pockets
p7288
aVThe GNU folks have them too, this looks like a good place to start
p7289
aVYou'll have to do some digging to isolate the string
p7290
aVh tests
p7291
aVBut, don't hesitate to write these tests yourself
p7292
aVIt strikes me as a better way to learn what the string function should and should not do than reimplementing the functions
p7293
as(dp7294
g9
V17034
p7295
stp7296
a((dp7297
g2
(lp7298
VThere is no sign of a ServiceInstaller in your code snippet, nor an install method that is marked with the [RunInstaller(true)] attribute
p7299
aVWhich would explain why it doesn't work
p7300
aVThere's a good example in the MSDN Library article for the ServiceInstaller class
p7301
as(dp7302
g9
V17034
p7303
stp7304
a((dp7305
g2
(lp7306
VYeah, QueueUserAPC is not the solution here
p7307
aVIts callback will only run when the thread blocks and the programmer has explicitly allowed the wait to be alertable
p7308
aVThat's unlikely
p7309
aVI hesitate to post the solution because it is going to get you into enormous trouble
p7310
aVYou can implement a thread interrupt with SuspendThread(), GetThreadContext(), SetThreadContext() and ResumeThread()
p7311
aVThe key is to save the CONTEXT
p7312
aVEip value on the thread's call stack and replace it with the address of the interrupt function
p7313
aVThe reason you cannot make this work is because you'll have horrible re-entrancy problems
p7314
aVThere is no way you can guess at which point of execution you'll interrupt the thread
p7315
aVIt may well be right in the middle of it mutating state, the state that you need so badly that you are contemplating doing this
p7316
aVThere is no way to not fall into this trap, you can't block it with a mutex or whatnot
p7317
aVIt is also extremely hard to diagnose because it will work so well for so long, then randomly fail when the interrupt timing just happens to be unlucky
p7318
aVA thread must be in a well known state before it can safely run injected code
p7319
aVThe traditional one has been mentioned many times before: when a thread is pumping a message loop is is implicitly idle and not doing anything dangerous
p7320
aVQueueUserAPC has the same approach, a thread explicitly signals the operating system that it is a state where the callback can be safely executed
p7321
aVBoth by blocking (not executing dangerous code) and setting the bAlertable flag
p7322
aVA thread has to explicitly signal that it is in a safe state
p7323
aVThere is no safe push model, only pull
p7324
as(dp7325
g9
V17034
p7326
stp7327
a((dp7328
g2
(lp7329
VJust repeatedly call ListBox
p7330
aVFindString() until you found them all
p7331
aVFor example:
p7332
aVIf you need to find a match on any part of the list box item string then you can search the items like this:
p7333
as(dp7334
g9
V17034
p7335
stp7336
a((dp7337
g2
(lp7338
VYou don't have to make it a reference assembly to get it copied into the client project
p7339
aVProject + Add Existing Item, select the DLL
p7340
aVSet its Build Action to "None", Copy to Output to "Copy if newer"
p7341
as(dp7342
g9
V17034
p7343
stp7344
a((dp7345
g2
(lp7346
VSkip the "load into an Image" step, it's a one-liner:
p7347
aVBitmap is derived from Image, you can use it where-ever an Image object is required
p7348
as(dp7349
g9
V17034
p7350
stp7351
a((dp7352
g2
(lp7353
VYou are already blocking on the event handle, there is no need to use the Overlapped class and the callback
p7354
aVAll you have to do is to set the NativeOverlapped
p7355
aVEventHandle member to the DangerousGetHandle() return value
p7356
aVThe DLL will set the event
p7357
aVAlso, declare the argument for NotifyStateChange as ref instead of a pointer, saves you from having to use the unsafe keyword
p7358
as(dp7359
g9
V17034
p7360
stp7361
a((dp7362
g2
(lp7363
VThere's a more "correct" fix, one that works regardless of how many controls you have and follows the Windows Forms design model
p7364
aVPaste this code into your form:
p7365
as(dp7366
g9
V17034
p7367
stp7368
a((dp7369
g2
(lp7370
VYou'll need to create a shell context menu handler to take full control over the context menu content
p7371
aVYou should not write this in C# until
p7372
aVNET 4
p7373
aV0 becomes widely available
p7374
aVFor now you can use C++, this web page has an example
p7375
aVA wrapper is described here, no idea if it is any good
p7376
as(dp7377
g9
V17034
p7378
stp7379
a((dp7380
g2
(lp7381
VYou need a class that's capable of storing a value of different types
p7382
aVShort from a union, Boost's variant class would be the proper choice
p7383
as(dp7384
g9
V17034
p7385
stp7386
a((dp7387
g2
(lp7388
VUse a little helper method that retries the upload several times before throwing in the towel
p7389
aVFor example:
p7390
aVTweak the exception handling code as needed
p7391
as(dp7392
g9
V17034
p7393
stp7394
a((dp7395
g2
(lp7396
VThe equivalent of a condition variable in
p7397
aVNET is the abstract WaitHandle class
p7398
aVPractical implementations of it are the ManualResetEvent, AutoResetEvent, Mutex and Semaphore classes
p7399
aVSystem
p7400
aVThreading
p7401
aVMonitor is the direct equivalent of a monitor
p7402
aVThe lock statement makes it very easy to use, it ensures the monitor is always exited without explicitly programming the Exit() call
p7403
as(dp7404
g9
V17034
p7405
stp7406
a((dp7407
g2
(lp7408
VWMI provides a way to track processes starting and terminating with the Win32_ProcessTrace classes
p7409
aVBest shown with an example
p7410
aVStart a new Console application, Project + Add Reference, select System
p7411
aVManagement
p7412
aVPaste this code:
p7413
aVRun this and start some programs to see it at work
p7414
aVBeware that it is not especially quick
p7415
as(dp7416
g9
V17034
p7417
stp7418
a((dp7419
g2
(lp7420
VSet a breakpoint on the destructor and it will become clear what is happening
p7421
aVYup, you are passing a temporary instance of Action<> to the Button constructor
p7422
aVIt is destroyed after the button construct runs
p7423
aVWrite it like this and the problem disappears:
p7424
aVWell, that's not a practical solution, event is not going to be in scope for a real mouseDown invocation
p7425
aVThe Button constructor is going to have to create a copy of the "event" argument or it is going to have to manage a pointer to the delegate
p7426
as(dp7427
g9
V17034
p7428
stp7429
a((dp7430
g2
(lp7431
VYou've got a serious bootstrap problem
p7432
aVCompiled VB
p7433
aVNET code cannot run without the services of the CLR and the JIT compiler
p7434
aVExisting implementations of it (mscorwks
p7435
aVdll and mscorjit
p7436
aVdll for example) have a heavy dependency on services provided by an operating system
p7437
aVYou'll have to write your own, that's non-trivial to put it mildly
p7438
aVIn addition, many classes in the framework rely on P/Invoke to directly call a Windows API function
p7439
aVVery basic classes like Console, Control, FileStream, Socket
p7440
aVYou'll have to replace those too
p7441
aVThat's where Singularity was stuck last time I saw a video of it
p7442
aVThe "starter kit" for any project like this is Rotor
p7443
aVThat's how Mono got started
p7444
aVTake a look at what your in for, focus on the Platform Adaption Layer (PAL)
p7445
aVNeeds to be written in unmanaged C/C++ in its current form though
p7446
as(dp7447
g9
V17034
p7448
stp7449
a((dp7450
g2
(lp7451
VThe best way is WMI,
p7452
aVNET supports it well with the System
p7453
aVManagement namespace
p7454
aVYou'll want to use the Win32_SystemDriver WMI class
p7455
aVI copied and pasted this code from WMICodeCreator, a great tool to experiment and auto-generate the code you need:
p7456
aVCheck out the links I left in this post, Win32_SystemDriver has many other properties beyond "Caption"
p7457
as(dp7458
g9
V17034
p7459
stp7460
a((dp7461
g2
(lp7462
VBrowing through the doxygen docs for ACE_Mutex, I don't understand how your code could possibly compile
p7463
aVThe time-out value (tv) is passed either by reference or a pointer so that acquire() can update the absolute time at which the mutex was acquired
p7464
aVYou cannot pass an expression
p7465
aVTry it like this:
p7466
as(dp7467
g9
V17034
p7468
stp7469
a((dp7470
g2
(lp7471
VCanceling a thread without any cooperation from the thread itself is not possible
p7472
aVThe TerminateThread() API function is only suitable during process shutdown
p7473
aVYes, you could make QueueUserAPC() work too but that still requires the thread's cooperation
p7474
aVIt has to block on a wait handle and explicitly signal that it's alertable (the bAlertable argument to, say, WaitForSingleObjectEx)
p7475
aVMaking it alertable requires lots of effort in your code due the asynchronous nature of the QUA callback
p7476
aVYou have to make sure that you don't leak any resources used by the thread when the rug is suddenly pulled out from under it
p7477
aVPretty hard to do, the callback has little context available to guess correctly what needs to be cleaned up
p7478
aVUnless you make the thread alertable in only a few places
p7479
aVBut, as long as the thread has to make a blocking call and can only be alertable in a few places, you might as well use WaitForMultipleObjects()
p7480
aVAdding an event that signals the thread to stop
p7481
aVThe cancellation will now by synchronous, clean-up is much easier
p7482
aVYou can use a wait call with a zero timeout inside a thread's main loop if it never blocks
p7483
aVThat's fairly expensive due to the cache flush
p7484
aVUse a volatile bool if you don't care too much about response time
p7485
aVYou shouldn't, it isn't very deterministic anyway
p7486
as(dp7487
g9
V17034
p7488
stp7489
a((dp7490
g2
(lp7491
VAs long as you program in Windows, avoid reimplementing the behavior of its Mutex
p7492
aVIt being re-entrant by the same thread is absolutely essential for its defined behavior
p7493
aVA sync object without thread affinity is a semaphore that counts to 1
p7494
aVUse CreateSemaphore()
p7495
aVFwiw, it is very curious that you need this kind of behavior
p7496
aVIt sounds like you are trying to use the same sync object in multiple places inappropriately
p7497
aVYou can use the semaphore but you'll lose concurrency potential
p7498
aVConsider using more than one mutex instead
p7499
as(dp7500
g9
V17034
p7501
stp7502
a((dp7503
g2
(lp7504
VPassing in the handle is definitely wrong, the 1st argument to EAI is a module handle, not an icon handle
p7505
aVThis worked well:
p7506
aVNo need for StringBuilder if the module handle is null
p7507
aVDon't use this code if you don't the "index" argument
p7508
aVIcon
p7509
aVExtractAssocationIcon will work just as well
p7510
as(dp7511
g9
V17034
p7512
stp7513
a((dp7514
g2
(lp7515
VGetting a unique 32-bit ID is intuitively simple: the next one
p7516
aVWorks 4 billion times
p7517
aVUnique for 136 years if you need one a second
p7518
aVThe devil is in the detail: what was the previous one
p7519
aVYou need a reliable way to persist the last used value and an atomic way to update it
p7520
aVHow hard that will be depends on the scope of the ID
p7521
aVIf it is one thread in one process then you only need a file
p7522
aVIf it is multiple threads in one process then you need a file and a mutex
p7523
aVIf is multiple processes on one machine then you need a file and a named mutex
p7524
aVIf it is multiple processes on multiple machines then you need to assign a authoritative ID provider, a single server that all machines talk to
p7525
aVA database engine is a common provider like that, they have this built-in as a feature, an auto-increment column
p7526
aVThe expense of getting the ID goes progressively up as the scope widens
p7527
aVWhen it becomes impractical, scope is Internet or provider too slow or unavailable then you need to give up on a 32-bit value
p7528
aVSwitch to a random value
p7529
aVOne that's random enough to make the likelihood that the machine is struck by a meteor is at least a million times more likely than repeating the same ID
p7530
aVA goo-ID
p7531
aVIt is only 4 times as large
p7532
as(dp7533
g9
V17034
p7534
stp7535
a((dp7536
g2
(lp7537
VYou are trying to implement Dekker's algorithm
p7538
aVUnfortunately, he lived in simpler times, back when hardware designers and software engineers were still talking to each other
p7539
aVThe cut-throat competition between vendors in the PC business, emphasizing speed and cores, spelled doom to Mr
p7540
aVDekker's ingenuity
p7541
aVKinda glad, I must have reviewed that algorithm dozens of times and never not got a headache
p7542
aVWell, that's kinda meta
p7543
aVReview the "Note" in that Wikipedia article to see why the algorithm doesn't work anymore
p7544
aVYou got plenty of alternatives offered that do work
p7545
aVKey point is that what ever literature you find about concurrency that's over 5 years old is no longer relevant
p7546
as(dp7547
g9
V17034
p7548
stp7549
a((dp7550
g2
(lp7551
VIt is possible, just not very cleanly
p7552
aVThis code uses another RTB to load the file and the clipboard to get the formatted RTF
p7553
aVBeware that it destroys the clipboard content
p7554
as(dp7555
g9
V17034
p7556
stp7557
a((dp7558
g2
(lp7559
VGiven that this is a programmer's web site, perhaps it is interesting to list the "real names", the names that the Microsoft programmers used when they worked on the projects
p7560
aVThese names tend to show up, like archeological records, in the source code for the CLR (Rotor), SDK header files and the Reference Source
p7561
aVC# started out as COOL (C-like Object Oriented Language)
p7562
aVThe Rotor makefiles show that early C# code might have been written in files with the
p7563
aVcool filename extension
p7564
aVHowever, there are also several places where it is named COOLC
p7565
aVThe CLR had several names
p7566
aVIt started out as a project inside the group that worked on Windows 2000's COM+, there are many references to "ComPlus" in the CLR source code
p7567
aVThe exception code for a managed exception is 0xe0434f4e, 0xe0 + "COM"+1
p7568
aVIn the WinError
p7569
aVh file, CLR error codes use "URT", "Universal Run Time"
p7570
aVThe contraction "Cor" appears in many places in the hosting interfaces, "COM Object Runtime"
p7571
aVCLR source code very commonly uses the EE acronym, distinct from COR
p7572
aVNot sure what it means
p7573
aVInternal project names I've seen:
p7574
aVRainier: Visual Studio 2002
p7575
aVEverett: Visual Studio 2003
p7576
aVWhidbey: Visual Studio 2005
p7577
aVOrcas: Visual Studio 2008
p7578
aVHawaii: Visual Studio 2010 (very early)
p7579
aVRotor: Shared Source version of the CLR
p7580
aVAvalon: WPF
p7581
aVIndigo: WCF
p7582
aVYukon: SQL Server 2005
p7583
aVKatmai: SQL Server 2008
p7584
as(dp7585
g9
V17034
p7586
stp7587
a((dp7588
g2
(lp7589
VHeader files don't solve linker errors, they create them
p7590
aVYou'll have to add rpcrt4
p7591
aVlib to the linker's Input + Additional Dependencies setting
p7592
aVOr paste this in your source code file:
p7593
as(dp7594
g9
V17034
p7595
stp7596
a((dp7597
g2
(lp7598
VOverride the ServiceBase
p7599
aVOnPowerEvent() method
p7600
as(dp7601
g9
V17034
p7602
stp7603
a((dp7604
g2
(lp7605
VIt makes no sense to do this on modern operating systems with a virtual memory manager
p7606
aVYou'll create a blob of bytes that are not useful for anything, taking space in your virtual memory address space for no good reason
p7607
aVThe memory manager won't leave it in RAM for very long, it will notice that the pages occupied by the blob are not being accessed and swap it out to the paging file
p7608
aVIn addition, you'll have to translate the data if it contains pointers
p7609
aVThe odds that you'll be able to decompress the data at the exact same virtual memory address, so that the pointers are still valid, are very close to zero
p7610
aVAfter all, you did this to free up virtual memory space, the hole previously used by the data will be occupied by something else
p7611
aVThis translation will probably not be trivial and it will take lots of additional memory
p7612
aVIf you are doing this to avoid OOM, look at operating system support for memory mapped files and consider switching to 64-bit code
p7613
as(dp7614
g9
V17034
p7615
stp7616
a((dp7617
g2
(lp7618
VInstead of using null, use the built-in Empty enumerable:
p7619
aVThe Contains() method now always returns false and you don't have to check for null in the query
p7620
as(dp7621
g9
V17034
p7622
stp7623
a((dp7624
g2
(lp7625
VThat Unicode codepoint is encoded in UTF32
p7626
aVNET and Windows encode Unicode in UTF16, you'll have to translate
p7627
aVUTF16 uses "surrogate pairs" to handle codepoints above 0xffff, a similar kind of approach as UTF8
p7628
aVThe first code of the pair is 0xd800
p7629
aVdbff, the second code is 0xdc00
p7630
aVdfff
p7631
aVTry this sample code to see that at work:
p7632
as(dp7633
g9
V17034
p7634
stp7635
a((dp7636
g2
(lp7637
VThe BOM is generated by, say, File
p7638
aVWriteAllText() or StreamWriter when you don't specify an Encoding
p7639
aVThe default is to use the UTF8 encoding and generate a BOM
p7640
aVYou can tell the java compiler about this with its -encoding command line option
p7641
aVThe path of least resistance is to avoid generating the BOM
p7642
aVDo so by specifying System
p7643
aVText
p7644
aVEncoding
p7645
aVDefault, that will write the file with the characters in the default code page of your operating system and doesn't write a BOM
p7646
aVUse the File
p7647
aVWriteAllText(String, String, Encoding) overload or the StreamWriter(String, Boolean, Encoding) constructor
p7648
aVJust make sure that the file you create doesn't get compiled by a machine in another corner of the world
p7649
aVIt will produce mojibake
p7650
as(dp7651
g9
V17034
p7652
stp7653
a((dp7654
g2
(lp7655
VYou got very good answers here
p7656
aVJust some emphasis
p7657
aVAn enumerator keeps state, it keeps track of the current object in the collection being enumerated
p7658
aVAvailable through IEnumerator
p7659
aVCurrent
p7660
aVAnd it knows how to change that state, IEnumerator
p7661
aVMoveNext()
p7662
aVKeeping state requires a separate object that stores the state
p7663
aVThat state can't be stored inside the collection object easily because there's only one collection object but there can be more than one enumerator
p7664
aVI used the phrase "easily" because it is actually possible for a collection to keep track of its enumerators
p7665
aVAfter all, it was a call to the collection class' GetEnumerator() method that returned the iterator
p7666
aVThere's one collection class in the
p7667
aVNET framework that does this, Microsoft
p7668
aVVisualBasic
p7669
aVCollection
p7670
aVIt needed to implement a VB6 contract for its Collection class and that contract specifies that changing a collection while it is being enumerated is legal
p7671
aVWhich means that when the Collection is modified, it needs to some reasonable with all of the iterator objects that were created
p7672
aVThey came up with a pretty good trick, WeakReference might have been inspired by this
p7673
aVHave a look-see at the code shown by Reflector
p7674
aVInspiring stuff
p7675
aVDig some more and find "version" in the collection classes
p7676
aVAwesome trick
p7677
as(dp7678
g9
V17034
p7679
stp7680
a((dp7681
g2
(lp7682
VIt is a classic trap in VB
p7683
aVNET, everyone falls into it at least once when they start using threads:
p7684
aVNow we can't see what exactly "frmMain" means
p7685
aVBut the fact that you posted this question suggests that frmMain is the name of your main form class
p7686
aVNot the name of a field in your class that stores a reference to the main form
p7687
aVThat doesn't work
p7688
aVThe variable that the VB
p7689
aVNET compiler generates to allow you to reference as class as though it is a variable has  semantics
p7690
aVIn other words, every thread will create its own instance of a the form
p7691
aVYou can sorta see it when you write it like this:
p7692
aVBut you'll see a "ghost" of the window, it is otherwise dead as a doornail since the thread it was created on is not pumping a message loop
p7693
aVYou'll need a real reference to the form
p7694
aVThat could be "Me" if Updater is a method of the form class
p7695
aVIf it isn't, Application
p7696
aVOpenForms could provide it
p7697
aVBest thing to do is the give the class that contains Updater a reference to the form through its constructor
p7698
as(dp7699
g9
V17034
p7700
stp7701
a((dp7702
g2
(lp7703
VIt is pretty simple, really
p7704
aVWhen you make a change in your source code, do you want to wait 10 minutes for it to build or 20 seconds
p7705
aVTwenty seconds is all I can put up with
p7706
aVBeyond that, I either get our the sword or start thinking about how I can use separate compilation to bring it back into the comfort zone
p7707
as(dp7708
g9
V17034
p7709
stp7710
a((dp7711
g2
(lp7712
VThis is a trick question
p7713
aVYou should never start writing a program without at least a minimum functional specification
p7714
aVYou don't have to explain how the program works, it merely does what it is described to do in the spec
p7715
aVWriting a spec after you wrote the program is the wrong way around and leads to the kind of problems you are quoting
p7716
as(dp7717
g9
V17034
p7718
stp7719
a((dp7720
g2
(lp7721
VThe event keyword creates an accessor for a private delegate object
p7722
aVThe exact same thing a property does, it restricts access to a private field
p7723
aVYour code snippet fails with a similar kind of error when you use a property instead of an event:
p7724
aVIt is easier to see now, there is no way for the compiler to ensure that the setValue() method uses the property setter
p7725
aVNor could it know that the "value" argument is a property with a setter or a plain field
p7726
aVIt is less clear for an event because there is so much syntax sugar at work
p7727
aVThis declaration
p7728
aVactually generates this code:
p7729
aVThe add and remove accessors are equivalent to the get and set accessors of a property, they prevent code from messing with the private _SomeEvent field
p7730
aVBy convention, the add accessor is invoked when you use +=, remove is invoked with -=
p7731
aVCompare this with the earlier example I gave for a property
p7732
aVSame problem, you can't use the ref keyword and ClassC
p7733
aVaddListener() would have no way to know that the handler is actually an event instead of a delegate object
p7734
aVIf the compiler would pass _SomeEvent instead, the point of using the accessors is lost
p7735
aVYou can restructure the code to solve this problem:
p7736
aVOne final note: the symmetry between an event and a property is a bit lost, the C# compiler automatically generates the add/remove accessors if you don't write them explicitly
p7737
aVIt doesn't do this for a property
p7738
aVIt would have made automatic properties a lot easier:
p7739
aVBut that would have required adding a new keyword to the language, something the C# team really dislikes
p7740
aVOther languages like VB
p7741
aVNET and C++/CLI do have that keyword
p7742
as(dp7743
g9
V17034
p7744
stp7745
a((dp7746
g2
(lp7747
VThese are not names in any of the Microsoft SDK libraries
p7748
aVThe appear to come from this code project
p7749
aVIt could also be this one
p7750
aVYou'll have to build it to create the DLL and add the
p7751
aVlib it produces to your project's linker input
p7752
as(dp7753
g9
V17034
p7754
stp7755
a((dp7756
g2
(lp7757
VDefine the resource ID, add this to the
p7758
aVrc file:
p7759
aVRead it at runtime with code like this:
p7760
as(dp7761
g9
V17034
p7762
stp7763
a((dp7764
g2
(lp7765
V and/or
p7766
aVGetScrollInfo() to find out how far you can go
p7767
as(dp7768
g9
V17034
p7769
stp7770
a((dp7771
g2
(lp7772
VAny decent CRT implementation does something about this problem
p7773
aVReview the  header file for the workaround it provides
p7774
aVMSVC has  for example
p7775
aVA CRT also common exposes a strtod() version that takes a locale argument,  in MSVC
p7776
as(dp7777
g9
V17034
p7778
stp7779
a((dp7780
g2
(lp7781
VUsers have very expectations for the user interface for such a program
p7782
aVIt both needs to look good and be flexible
p7783
aVDoing this yourself isn't advisable, it is a major work item and a never-ending maintenance headache
p7784
aVBefore you dismiss a commercial solution, be sure to take a look at their automation interface
p7785
aVThe one for Visio is in the Microsoft
p7786
aVOffice
p7787
aVInterop
p7788
aVVisio namespace
p7789
aVStoring data to a dbase is certainly possible with it
p7790
as(dp7791
g9
V17034
p7792
stp7793
a((dp7794
g2
(lp7795
VYes, a static class named Program with a static Main() function
p7796
aVIt is hard to miss when you look at the code auto-generated by a project template
p7797
aVOpen Program
p7798
aVcs
p7799
as(dp7800
g9
V17034
p7801
stp7802
a((dp7803
g2
(lp7804
VI got a repro pretty easily
p7805
aVThis looks like a basic bug in WaveChannel32
p7806
aVRead(), it doesn't handle
p7807
aVwav files with multiple channels properly
p7808
aVThe numBytes argument looks like the size of the file, not the stream
p7809
aVLet the project owner know
p7810
aVYou'll add your issue to a rather long list though
p7811
as(dp7812
g9
V17034
p7813
stp7814
a((dp7815
g2
(lp7816
VThere's a subtle flaw in your code:
p7817
aVThe base class'  method is not declared
p7818
aVpoint::area is therefore not a virtual method
p7819
aVEither declare   as well or remove const from  and it will work as expected
p7820
as(dp7821
g9
V17034
p7822
stp7823
a((dp7824
g2
(lp7825
VWindows simply doesn't support it, you can't force it to do otherwise
p7826
aVFwiw, it isn't your job to force a window style on a netbook machine
p7827
aVThe user does this through the Control Panel Display + Appearance tab
p7828
aVIt is best to avoid pushing your personal preference on your UI when the user can easily do so herself
p7829
aVAnd make it consistent for all apps
p7830
aVAnd keep the min/max buttons
p7831
as(dp7832
g9
V17034
p7833
stp7834
a((dp7835
g2
(lp7836
VWebBrowser, like many ActiveX controls, has strict threading requirements
p7837
aVThe thread that creates it must be initialized with Thread
p7838
aVSetApartmentState() to switch it to STA
p7839
aVAnd the thread must pump a message loop, you get one from Application
p7840
aVRun()
p7841
aVThat makes talking to the browser pretty tricky
p7842
aVHere's code to get you started
p7843
aVBeware that the Completed callback runs on a background thread
p7844
aVDon't forget to call Dispose() to shut down the thread
p7845
as(dp7846
g9
V17034
p7847
stp7848
a((dp7849
g2
(lp7850
VA leading underscore is reserved to the compiler/library vendor to avoid creating symbols in the global namespace that collide with symbols created by their customers
p7851
aVUnfortunately, customers have been using this too for their own "system level" declarations, as do 3rd party library vendors, forcing the vendors to start using two underscores
p7852
aVSymbols with 3 underscores have been found in the wild but are not yet wide-spread
p7853
as(dp7854
g9
V17034
p7855
stp7856
a((dp7857
g2
(lp7858
VThose values are perfectly normal
p7859
aVThey are 32bpp pixels with the alpha channel at 0xff, the usual value
p7860
aVIn other words: -8682109 == 0xff7b8583
p7861
aVAny alpha value >= 128 will make the value negative because it sets the sign bit
p7862
aVUsing uint[] instead of int[] can make that easier to see
p7863
as(dp7864
g9
V17034
p7865
stp7866
a((dp7867
g2
(lp7868
VThe real trouble is finding out that you are running on a 64-bit version of Windows
p7869
aVUsing IntPtr
p7870
aVSize isn't good enough, your program might have been forced to run in 32-bit mode
p7871
aVYou'll have to P/Invoke GetNativeSystemInfo() to get SYSTEM_INFO
p7872
aVwProcessorArchitecture
p7873
aVWatch out for exceptions from these P/Invokes, the API functions are not available in XP and earlier
p7874
aVWhen you get one from IsWow64Process then you'll know it is a 32-bit OS
p7875
aVYou can avoid the exception with LoadLibrary and GetProcAddress
p7876
as(dp7877
g9
V17034
p7878
stp7879
a((dp7880
g2
(lp7881
VYes, calling RRIG will increment the reference count
p7882
aVYou can't use FinalRelease, you'll have to revoke it when the reference count drops down to 1
p7883
aVI don't see an obvious way to do this in ATL, other than deriving from CComObjectRootBase so you can write your own InternalRelease()
p7884
aVYou might be better off making this explicit with, say, a Publish and Revoke method
p7885
as(dp7886
g9
V17034
p7887
stp7888
a((dp7889
g2
(lp7890
VYou'll have to find the process that is hijacking the COM port
p7891
aVSysInternals' Handle utility should help you find it
p7892
aVOther than that, I've seen the Telephony service grab a COM port on one of my machines
p7893
as(dp7894
g9
V17034
p7895
stp7896
a((dp7897
g2
(lp7898
VThe implementation of the standard collection enumerators makes it a law
p7899
aVWhen they are created, it copies a private "version" integer from the collection object
p7900
aVModifying the collection increments that version
p7901
aVThe iterator methods compare the version and when there's a mismatch it throws
p7902
aVNo way to get around that
p7903
aVHowever, there's one collection class that permits modifying the collection while they are enumerated: Microsoft
p7904
aVVisualBasic
p7905
aVCollection
p7906
aVIt needed to do so to stay compatible with the VB6 Collection class
p7907
aVYou might want to take a look at it to see how it is done
p7908
aVIIRC, it keeps a WeakReference on all iterators, then update the iterators when the collection is modified
p7909
aVThis is not fool proof of course, removing an element and adding it back in can enumerate the same object twice
p7910
aVNor is it cheap
p7911
as(dp7912
g9
V17034
p7913
stp7914
a((dp7915
g2
(lp7916
VTake a look at how it was done in boost,
p7917
aVNo magic here,  is needed
p7918
as(dp7919
g9
V17034
p7920
stp7921
a((dp7922
g2
(lp7923
VThat cannot work in a service, the thread that calls your Main() method was already started by the service manager
p7924
aVYou'll need to create a separate thread that is initialized with Thread
p7925
aVSetApartmentState() and pumps a message loop
p7926
as(dp7927
g9
V17034
p7928
stp7929
a((dp7930
g2
(lp7931
VCreate a base form with the menu
p7932
aVThen the individual forms can inherit this base form, automatically getting the same menu
p7933
aVTo refactor the existing forms, edit the form
p7934
aVcs and change
p7935
aVto
p7936
as(dp7937
g9
V17034
p7938
stp7939
a((dp7940
g2
(lp7941
VYes, using /debug:pdbonly is enough to convince the compiler that its okay to inline methods
p7942
aVIt generates a different [DebuggableAttribute] into the assembly:
p7943
aVcustom instance void [mscorlib]System
p7944
aVDiagnostics
p7945
aVDebuggableAttribute::
p7946
aVctor(valuetype [mscorlib]System
p7947
aVDiagnostics
p7948
aVDebuggableAttribute/DebuggingModes) = ( 01 00 06 01 00 00 00 00 )
p7949
aVWhere /debug:full produces:
p7950
aVcustom instance void [mscorlib]System
p7951
aVDiagnostics
p7952
aVDebuggableAttribute::
p7953
aVctor(valuetype [mscorlib]System
p7954
aVDiagnostics
p7955
aVDebuggableAttribute/DebuggingModes) = ( 01 00 07 01 00 00 00 00 )
p7956
aVIf this is a problem, you'll need to explicitly disable inlining like this:
p7957
as(dp7958
g9
V17034
p7959
stp7960
a((dp7961
g2
(lp7962
VCOM requires a proxy/stub to marshal the call from the thread to the thread that created the object
p7963
aVQI will fail if it cannot find it in the HKCR\u005cInterface registry key
p7964
as(dp7965
g9
V17034
p7966
stp7967
a((dp7968
g2
(lp7969
VComponent could have a constructor with one argument that initializes m_address
p7970
as(dp7971
g9
V17034
p7972
stp7973
a((dp7974
g2
(lp7975
VVB6 created the
p7976
aVexe in the same directory as the project, VB
p7977
aVNET doesn't
p7978
aVVB6's App
p7979
aVPath really does do the same thing as Application
p7980
aVExecutablePath, it is just that the
p7981
aVexe is written to a different directory
p7982
aVWhen you deploy the program, ExecutablePath will still point to the
p7983
aVexe, there is no "project directory" for a deployed program
p7984
aVI assume you need this because your program is accessing files in the same directory as the
p7985
aVexe and those files are now stored in your project directory
p7986
aVAll you have to do is copy them, the IDE makes it easy
p7987
aVProject + Add Existing Item, select the file
p7988
aVIn the Properties window, set Build Action = None and Copy to Output Directory = Copy if newer
p7989
aVAnother way is Project + Properties, Compile tab, erase the Build output path setting
p7990
aVNow it will work the same as VB6
p7991
aVBut won't be so nice for Release vs Debug builds or your SSCS
p7992
aVDon't ship the Debug build, it leaks without a debugger
p7993
as(dp7994
g9
V17034
p7995
stp7996
a((dp7997
g2
(lp7998
VRight now,
p7999
aVNET doesn't support sections (aka Memory Mapped Files)
p8000
aVIt will soon, the 4
p8001
aV0 version has the System
p8002
aVIO
p8003
aVMemoryMappedFiles namespace
p8004
aVThere is a good reason it took so long and also the reason you are not going to be happy with this addition
p8005
aVUsing pointers is mandatory in MMFs, the shared memory is made available at a specific address
p8006
aVTo share a value, you'll have to write it to a specific address
p8007
aVPointers are however fundamentally incompatible with the managed memory model
p8008
aVObjects are created in a garbage collected heap, the collector moves them around as needed to keep the heap compacted
p8009
aVIn a managed language, you have a reference to such an object, also knows as a "tracking handle"
p8010
aVThe C/C++ equivalent is a pointer, but it is one with bells on, the garbage collector can always find it back and update its value
p8011
aVThe CLR does support the notion of "pinning", it converts a reference to a pointer
p8012
aVIt implements this by marking the object as unmoveable
p8013
aVThat however doesn't help implement shared memory through an MMF, the object is pinned in the GC heap instead of the virtual memory address where the MMF view is located
p8014
aVTo make an MMF work, the object needs to be copied from the GC heap to the shared memory
p8015
aVThat requires serialization
p8016
aVThe
p8017
aVNET 4
p8018
aV0 class is named MemoryMappedViewStream
p8019
aVYou probably can see where this is going, this is indistinguishable from using a named pipe or a socket
p8020
aVGetting data in and out of an MMF takes the same amount of effort
p8021
aVAn MMF is merely slightly more efficient because the underlying buffer is not in the kernel memory pool
p8022
aVYou can break the rulez and do so today
p8023
aVYou can P/Invoke the CreateFileMapping, OpenFileMapping and MapViewOfFile you need to create an MMF
p8024
aVAnd use the unsafe keyword so you can create pointers
p8025
aVYou'll need to use value types (like struct) for the shared memory elements or use the Marshal class
p8026
as(dp8027
g9
V17034
p8028
stp8029
a((dp8030
g2
(lp8031
VI think you are talking about the Microsoft
p8032
aVOffice
p8033
aVCore
p8034
aVTextRange2
p8035
aVRuns() property
p8036
aVIt is a property that takes two arguments, start and length
p8037
aVSuch a property is not directly accessible in the C# language, at least not until C# 4
p8038
ag2512
aVOnly Visual Basic supports indexed properties right now
p8039
aVThe workaround is to use get_Runs() instead
p8040
as(dp8041
g9
V17034
p8042
stp8043
a((dp8044
g2
(lp8045
VYou cannot set the compiler explicitly, VS simply runs cl
p8046
aVexe
p8047
aVWindows tries to find a file named cl
p8048
aVexe to start, it searches the directories listed in the PATH environment variable
p8049
aVYou do explicitly set which directories are in the PATH
p8050
aVNot sure about VS2003, 2005 and up uses Tools + Options, Projects and Solutions, VC++ Directories, Executable files
p8051
aVRemove the Intel compiler directory from that list
p8052
as(dp8053
g9
V17034
p8054
stp8055
a((dp8056
g2
(lp8057
VSetting the list box' Enabled property to False works fine:
p8058
as(dp8059
g9
V17034
p8060
stp8061
a((dp8062
g2
(lp8063
VIt is a hint to the code optimizer
p8064
aVUsing restrict ensures it that it can store a pointer variable in a CPU register and not have to flush an update of the pointer value to memory so that an alias is updated as well
p8065
aVWhether or not it takes advantage of it depends heavily on implementation details of the optimizer and the CPU
p8066
aVCode optimizers already are heavily invested in detecting non-aliasing since it is such an important optimization
p8067
aVIt should have no trouble detecting that in your code
p8068
as(dp8069
g9
V17034
p8070
stp8071
a((dp8072
g2
(lp8073
VWH_MOUSE_LL is a different kind of hook from most other ones
p8074
aVIt is implemented by calling the hook procedure directly rather than injecting a DLL
p8075
aVThat requires a message loop to be actively pumping
p8076
aVThe odds that there isn't one anymore after you close a window are high
p8077
aVBe sure to unhook in the WM_CLOSE message handler
p8078
as(dp8079
g9
V17034
p8080
stp8081
a((dp8082
g2
(lp8083
VCallbacks are already made on a thread pool thread, it is the default for
p8084
aVNET
p8085
aVMaking one on a Thread you created yourself would be awkward
p8086
aVThe worker thread for a BackgroundWorker also comes from the thread pool
p8087
aVThere is no fundamental upper limit on the number of BGWs you can use beyond available Windows resources
p8088
aVThe thread pool manager is however not going to let them all run at the same time, it tries to make sure there are never as many active threads as there are cores in your CPU
p8089
aVOnly when a thread doesn't complete in a reasonable amount of time does it allow more threads to run, up to the limit set by ThreadPool
p8090
aVSetMaxThreads()
p8091
aVThe odds that you'll shoot your foot somehow goes up roughly quadratically with the number of threads you created
p8092
as(dp8093
g9
V17034
p8094
stp8095
a((dp8096
g2
(lp8097
VNamespace names used in your VB
p8098
aVNET code are not visible to a COM client
p8099
aVJust omit the wsutils:: prefix
p8100
aVWhenever you are in doubt what the #imported names look like, open the automatically generated
p8101
aVtlh and
p8102
aVtli files with your editor
p8103
as(dp8104
g9
V17034
p8105
stp8106
a((dp8107
g2
(lp8108
VIt's available in the SystemInformation
p8109
aVKeyboardDelay and KeyboardSpeed properties on all your listed operating systems
p8110
as(dp8111
g9
V17034
p8112
stp8113
a((dp8114
g2
(lp8115
VNo
p8116
aVThe delegate target in the Broadcast event references the Listener object
p8117
aVThat will keep the Listener object alive
p8118
aVThe Listener object doesn't have any reference back to the Broadcast object
p8119
aVWatch out for terminology
p8120
aVDisposing the Broadcast object does nothing
p8121
aVIt has to be garbage collected which can only happen when there's no references left to the object
p8122
aVWhen that happens, the delegate object will automatically be collected as well since the only reference to it is the internal list of delegate targets maintained by private event delegate object
p8123
aVThat also removes the reference the delegate has to the listener
p8124
aVIf there are no other references to the listener, it will be collected as well
p8125
aVIf it still is, it will just no longer get event notifications
p8126
aVLong story short: you don't have to explicitly set the event to null in the Broadcast class
p8127
aVNot quite the same in the listener, it is referenced by the event it subscribed to
p8128
aVIf it is declared unfit for business (disposed) but the broadcaster is still live then it should remove its event subscription explicitly
p8129
aVThe SystemEvents class is an extreme version of that, its events are static
p8130
aVFiring events on a delegate that references a disposed listener is something you tend to notice
p8131
aVMost practical object models try to ensure listener objects disappear when the parent goes
p8132
aVWindows Forms would be a good example
p8133
aVNo need to explicitly unsubscribe events then
p8134
as(dp8135
g9
V17034
p8136
stp8137
a((dp8138
g2
(lp8139
VYou'll get several nasty symbol name collisions when you #include windows
p8140
aVh in a C++/CLI Windows Forms app
p8141
aVBut this is self-induced
p8142
aVPumping your own message loop in a WF app is not appropriate
p8143
aVIt already has one, Application::Run()
p8144
aVYou can't write your own, you won't be able to preprocess the message appropriately to make stuff like keyboard shortcuts work
p8145
aVWork through some C++/CLI programming tutorials before you try this
p8146
as(dp8147
g9
V17034
p8148
stp8149
a((dp8150
g2
(lp8151
VIt is very much the True Path, a 32-bit app will always access the registry key in that subkey
p8152
aVGetting the value that a 64-bit app would see is technically possible, just not with
p8153
aVNET
p8154
aVYou'll have to P/Invoke RegOpenKeyEx() et al so you can specify the KEY_WOW64_64KEY flag
p8155
as(dp8156
g9
V17034
p8157
stp8158
a((dp8159
g2
(lp8160
VIt can be done by using the DrawMode property so you can paint your own check box with ControlPaint
p8161
aVDrawCheckBox()
p8162
aVYou'll also have to implement the MouseDown event and use the HitTest method to detect clicks on the fake checkbox
p8163
aVNo great joy, but it's possible
p8164
as(dp8165
g9
V17034
p8166
stp8167
a((dp8168
g2
(lp8169
VAdd some real data to the XDoc
p8170
aVAnd be sure to use the Save() method to see the entire content:
p8171
as(dp8172
g9
V17034
p8173
stp8174
a((dp8175
g2
(lp8176
VI'm not going to comment on XOR encryption, that's too silly
p8177
aVLets focus on practical guidance to implement your custom stream
p8178
aVYou should derive it from Stream so it has a familiar interface to the user
p8179
aVRight-click "Stream", Implement Abstract Class
p8180
aVYou can leave most of the NotImplementedException throws in place, streams are commonly crippled like this
p8181
aVAdd a private FileStream member, it will do the hard work
p8182
aVThen add:
p8183
aVA contructor that takes a string argument, the path to the file
p8184
aVConstruct the FileStream with it
p8185
aVImplement CanWrite, return true
p8186
aVImplement the Write() method
p8187
aVDo whatever you need to do to the byte[] that the client passed
p8188
aVYou typically need your own byte[] buffer, call Flush() if it is getting too large
p8189
aVOr FileStream
p8190
aVWrite() directly if you don't need a buffer
p8191
aVImplement the Flush method
p8192
aVCall FileStream
p8193
aVWrite() for your buffer, then its Flush()
p8194
aVImplement Close and Dispose(), call the corresponding FileStream method
p8195
as(dp8196
g9
V17034
p8197
stp8198
a((dp8199
g2
(lp8200
VThere is a huge difference between Component and Control
p8201
aVComponent is a very simple class, it has 3 members for design time support, 6 members for runtime support, that's all
p8202
aVYou can drop one on a form so that its properties can be edited
p8203
aVAnything useful it does at runtime must be implemented by the component itself, there is no help from Windows Forms
p8204
aVControl extends Component by adding members that allows it to have a well defined runtime behavior as well, most notably by wrapping a native Windows window
p8205
aVYou can see it and click it
p8206
aVBig job, that takes hundreds of members, although most of them are not visible in the designer
p8207
aVTurning a Control into a Component but still retaining Control characteristics is possible
p8208
aVThe ToolStripItem does that
p8209
aVHowever, it requires an enormous amount of code since you have to replace every feature that a Windows window provides
p8210
aVThat's hard, even for Microsoft, the ToolStripItem classes have a lot of bugz
p8211
aVThe only benefit you get from this is that you can avoid allocating a window handle
p8212
aVWhich can be compelling at times, windows are expensive objects and can make your code run slow
p8213
aVAnd you're stuck with the way a window works, poor transparency support for example
p8214
aVSupporting transparency with a Component is not an issue, it is just multiple layers of paint on top of each other
p8215
aVYou have however have to provide everything else a Control does
p8216
aVGetting to the point, this has already been done
p8217
aVIt is the exact model for WPF
p8218
aVA WPF app (usually) has only one native window handle
p8219
aVEverything else is drawn inside of it by the WPF rendering engine
p8220
aVIt therefore has no trouble supporting transparency effects
p8221
aVAny many other bells and whistles, like rotated controls, that you can't get a native window to do
p8222
aVOr a browser
p8223
aVIf you want to stick with WF, explain in detail what kind of transparency effect you need
p8224
aVThere are many ways to get one, it just depends on what you're trying to do
p8225
aVFwiw, a good question at StackOverflow is about as long as a good answer
p8226
as(dp8227
g9
V17034
p8228
stp8229
a((dp8230
g2
(lp8231
VNo, that's not possible
p8232
aVNot having array bound checking in C/C++ is how Microsoft got into such deep trouble with malware
p8233
aVIt is a no-no in managed code
p8234
aVFor and For Each loops will run without bound checking if the JIT compiler can detect that the begin- and end-indices are within bounds
p8235
aVThis is one of the reasons that the For loop "TO" value is only evaluated once
p8236
as(dp8237
g9
V17034
p8238
stp8239
a((dp8240
g2
(lp8241
VIt makes no sense to use SecureZeroMemory to initialize an icon info structure
p8242
aVIt can only overwrite bytes on the stack frame that should have been securely erased elsewhere
p8243
aVThat horse already escaped the barn
p8244
aVIt doesn't even make sense to initialize it at all, the return value of GetIconInfo() tells you that it got initialized
p8245
aVSecureZeroMemory() only makes sense after memory was filled with secure data
p8246
as(dp8247
g9
V17034
p8248
stp8249
a((dp8250
g2
(lp8251
VYou are battling built-in behavior of both the Form and the UserControl class
p8252
aVThey were written to never accept the focus if they contain any child controls, they automatically move the focus to a child instead
p8253
aVBuilt-in behavior for the ContainerControl class, the base class for both
p8254
aVGroupBox is another one
p8255
aVThat makes a lot of sense if you think about it: neither is capable of showing that they have the focus nor is there anything useful that would happen when the user starts typing
p8256
aVDon't fix this, it will just deeply confuse the user
p8257
as(dp8258
g9
V17034
p8259
stp8260
a((dp8261
g2
(lp8262
VYou would have to write a driver, that's how Com0Com works
p8263
aVIf these components run in-process, you could hijack the Windows API functions, Microsoft's Detours for example
p8264
aVEither solution requires C/C++, you can't write this code in a managed language
p8265
aVAlthough detouring could be technically possible, just very hard to get right
p8266
aVYou can buy a solution though, your requirements are not uncommon, albeit it dated
p8267
aVDated enough that finding one might be a bit tricky
p8268
as(dp8269
g9
V17034
p8270
stp8271
a((dp8272
g2
(lp8273
VIt only matters if you use an expression instead of entering the address directly
p8274
aVParsing rules for 'C' expressions are different from those for C++
p8275
aVCan't think of a great example beyond a C++ member expression like "&this-;>member"
p8276
aVThe debugger can't figure it out for itself, mixing 'C' and C++ code in one process is quite permissible
p8277
as(dp8278
g9
V17034
p8279
stp8280
a((dp8281
g2
(lp8282
VIt does get initialized to null
p8283
aVThe compiler just did you a favor by not having to debug the inevitable NullReferenceException you'll get
p8284
as(dp8285
g9
V17034
p8286
stp8287
a((dp8288
g2
(lp8289
VYou are getting this exception because your GetWindowText() call corrupted the garbage collected heap
p8290
aVEasy to do when you pass a string instead of a StringBuilder or forget to initialize the StringBuilder
p8291
aVThe Right Way:
p8292
as(dp8293
g9
V17034
p8294
stp8295
a((dp8296
g2
(lp8297
VEverybody is forgetting a very important detail: you have to Dispose() the control or it will leak forever:
p8298
as(dp8299
g9
V17034
p8300
stp8301
a((dp8302
g2
(lp8303
VYou'll have to assign the Renderer property to a class that renders the CMS or tool strip the way you want it
p8304
aVUse this code as a template to get started:
p8305
as(dp8306
g9
V17034
p8307
stp8308
a((dp8309
g2
(lp8310
VA fundamental capability that Remoting has is to be able to create a stack frame in another execution context and make a method call
p8311
aVExactly what is needed to marshal a method call from one thread to another
p8312
aVThis is quite non-trivial btw but very well hidden
p8313
as(dp8314
g9
V17034
p8315
stp8316
a((dp8317
g2
(lp8318
VAdd a message handler for WM_SETTINGCHANGE, SystemEvents
p8319
aVUserPreferenceChanged in
p8320
aVNET
p8321
aVCheck if the wallpaper is still the same
p8322
as(dp8323
g9
V17034
p8324
stp8325
a((dp8326
g2
(lp8327
VApplication
p8328
aVThreadException is specific to Windows Forms
p8329
aVWinforms runs event handlers in response to messages sent to it by Windows
p8330
aVThe Click event for example, I'm sure you know them
p8331
aVIf such an event handler throws an exception then there's a back-stop inside the Winforms message loop that catches that exception
p8332
aVThat backstop fires the Application
p8333
aVThreadException event
p8334
aVIf you don't override it, the user will get a ThreadExceptionDialog
p8335
aVWhich allows him to ignore the exception and keep running your program
p8336
aVNot a great idea btw
p8337
aVYou can disable this behavior by calling Application
p8338
aVSetUnhandledExceptionMode() in the Main() method in Program
p8339
aVcs
p8340
aVWithout that backstop in place, the usual thing happens when a thread dies from an unhandled exception: AppDomain
p8341
aVUnhandledException fires and the program terminates
p8342
aVFwiw: "ThreadException" was a very poor name choice
p8343
aVIt has nothing to do with threads
p8344
as(dp8345
g9
V17034
p8346
stp8347
a((dp8348
g2
(lp8349
VThat's not how it works, you have to write COM code in C++ to use it
p8350
aVTake a good look at the #import directive and the smart pointers it creates
p8351
as(dp8352
g9
V17034
p8353
stp8354
a((dp8355
g2
(lp8356
VThere is no good way to make MouseLeave reliable for a container control
p8357
aVPunt this problem with a timer:
p8358
as(dp8359
g9
V17034
p8360
stp8361
a((dp8362
g2
(lp8363
VSet its ContextMenuStrip property
p8364
aVChoosing Details does require you to add Columns
p8365
as(dp8366
g9
V17034
p8367
stp8368
a((dp8369
g2
(lp8370
VIt is entirely dependent on the app's implementation
p8371
aVThe far more common approach would be for it to create a new window from scratch instead of showing a hidden one
p8372
aVIt gets its tray icon notifications through a private callback function, you can't fake that yourself
p8373
aVFaking a mouse click is very hard to get right because you can't find out where the icon is located
p8374
aVI think you're stuck
p8375
as(dp8376
g9
V17034
p8377
stp8378
a((dp8379
g2
(lp8380
VDid you actually try this
p8381
aVIt is non-optimal, it generates garbage results
p8382
aVThis ought to work better:
p8383
as(dp8384
g9
V17034
p8385
stp8386
a((dp8387
g2
(lp8388
VKeep your eyes on the ball: you sort to help humans find back a string in a list
p8389
aVYou'll need a skilled linguist to know the sorting rules for English, German and Japanese at the same time
p8390
aVWhat are the odds of one laying eyes on your list
p8391
aVAlways make sure the list is sorted according to the local culture rules and that sorting is localized
p8392
as(dp8393
g9
V17034
p8394
stp8395
a((dp8396
g2
(lp8397
VSloppy, not uncommon for GDI+
p8398
aVThis fixes it:
p8399
as(dp8400
g9
V17034
p8401
stp8402
a((dp8403
g2
(lp8404
VIs this actually bombing after an exception
p8405
aVFar more likely from your snippet is that you just have bad synchronization in place
p8406
aVThat starts with the name of your mutex: "writeMutex"
p8407
aVThis is not going to work if there is also a "readMutex"
p8408
aVAll reading, peeking and writing operations need to be locked by the same mutex
p8409
as(dp8410
g9
V17034
p8411
stp8412
a((dp8413
g2
(lp8414
VThe $0
p8415
aV25 solution is Project + Properties, Application tab, Output type = Console Application
p8416
aVNow you've got a console window as well as your regular UI
p8417
aVAnything you write with Console
p8418
aVWriteLine() will end up on that console window
p8419
as(dp8420
g9
V17034
p8421
stp8422
a((dp8423
g2
(lp8424
VThese functions interact with the operating system's file system cache
p8425
aVIn many cases it is a simple memory-to-memory copy
p8426
aVWrite could indeed be marginally faster if you run your program repeatedly
p8427
aVIt just needs to find a hole in the cache to dump its data
p8428
aVFlushing that data to the disk happens at a time you can't see or measure
p8429
aVMore work is usually needed to read
p8430
aVAt a minimum it needs to traverse the cache structure to discover if the disk data is already cached
p8431
aVIf not, it is going to have to block on a disk driver request to retrieve the data from the disk, that takes many milliseconds
p8432
aVThe standard trap with profiling this behavior is taking measurements from repeated runs of your program
p8433
aVThey are not at all representative for the way your program is going to behave in the wild
p8434
aVThe odds that the disk data is already cached are very good on the second run of your program
p8435
aVThey are very poor in real life, reads are likely to be very slow, especially the first one
p8436
aVAn extra special trap exists for a write, at some point (depending on the behavior of other programs too), the cache is not going to be able to buffer the write request
p8437
aVWrite performance is then going to fall of a cliff as your program gets blocked until enough data is flushed to the disk
p8438
aVLong story short: don't ever assume disk read/write performance measurements are representative for how your program will behave in production
p8439
aVAnd perhaps more to the point: there isn't anything you can do to solve disk I/O perf problems in your code
p8440
as(dp8441
g9
V17034
p8442
stp8443
a((dp8444
g2
(lp8445
VChange your Main() method in Program
p8446
aVcs to display the login dialog
p8447
aVDon't start the message loop unless a valid login was entered
p8448
aVFor example:
p8449
aVYour LoginForm should set its DialogResult property to OK if it detected a proper login
p8450
as(dp8451
g9
V17034
p8452
stp8453
a((dp8454
g2
(lp8455
VHmya, that method is marked "internal"
p8456
aVUnfit for public consumption
p8457
aVChristoph Wille got something going, check his monologue in this thread for links to his blog articles and code
p8458
as(dp8459
g9
V17034
p8460
stp8461
a((dp8462
g2
(lp8463
VThe C# compiler usually has no trouble figuring out what part of a declaration the attribute applies to
p8464
aVField should never be an issue
p8465
aVI can think of two cases where you always have to use it:
p8466
aVAttributes that apply to the assembly
p8467
aVVery visible in AssemblyInfo
p8468
aVcs
p8469
aVAn attribute applied to the return value of a P/Invoke declaration, [return:MarshalAs]
p8470
as(dp8471
g9
V17034
p8472
stp8473
a((dp8474
g2
(lp8475
VYou need to scale your model, not the device context
p8476
as(dp8477
g9
V17034
p8478
stp8479
a((dp8480
g2
(lp8481
VLostFocus is a troublesome event, this is the fine print from the SDK docs for WM_KILLFOCUS, the underlying Windows message:
p8482
aVWhile processing this message, do not make any function calls that display or activate a window
p8483
aVThis causes the thread to yield control and can cause the application to stop responding to messages
p8484
aVFor more information, see Message Deadlocks
p8485
aVUse the Leave event instead
p8486
as(dp8487
g9
V17034
p8488
stp8489
a((dp8490
g2
(lp8491
s(dp8492
g9
V17034
p8493
stp8494
a((dp8495
g2
(lp8496
VFire up Spy++ and select the Treeview window
p8497
aVMove the mouse on the scrollbar
p8498
aVPlenty of activity there, WM_NCMOUSEMOVE looks like a good one to me
p8499
aVCatch it in a WndProc() override
p8500
as(dp8501
g9
V17034
p8502
stp8503
a((dp8504
g2
(lp8505
VThis is not a warning that you should ignore, longjmp() and C++ objects don't get along with each other
p8506
aVThe problem is that the compiler automatically emits a destructor call for your foo object
p8507
aVA longjmp() can bypass the destructor call
p8508
aVC++ exceptions unwind stack frames too but they guarantee that destructors of local objects will be called
p8509
aVNo such guarantee from longjmp()
p8510
aVFinding out if longjmp() is going to byte you requires carefully analyzing the local variables in each function which might be terminated early due to the longjmp()
p8511
aVThat's not easy
p8512
as(dp8513
g9
V17034
p8514
stp8515
a((dp8516
g2
(lp8517
VUsing an array of Button is the superior solution
p8518
aVBut you can do it cheap by choosing the button names carefully:
p8519
aVNote that I used 6
p8520
aVarrButtons(5) contains 6 elements at indices 0 through 5
p8521
as(dp8522
g9
V17034
p8523
stp8524
a((dp8525
g2
(lp8526
VTake a close look at the actual pointer value for pB and pD
p8527
aVGetting that pointer adjustment correct is hard, it takes a compiler
p8528
as(dp8529
g9
V17034
p8530
stp8531
a((dp8532
g2
(lp8533
VThe inline function is placed in a COMDAT section
p8534
aVThat's a signal to the linker that it is free to pick any one of the multiple definitions it encounters
p8535
aVYou'll get another output message when you reverse the link order
p8536
aVAnother way to place definitions in a COMDAT section (compiler allowing) is:
p8537
aVWhich is handy to avoid the "extern" song and dance
p8538
aVClearly, this mechanism was designed to allow multiple definitions introduced by one header file getting #included by multiple source files to be resolved by the linker
p8539
aVFwiw, MSVC has the exact same behavior
p8540
as(dp8541
g9
V17034
p8542
stp8543
a((dp8544
g2
(lp8545
VA named object is just like it sounds:
p8546
aVAs opposed to:
p8547
aVThe latter case is simple to optimize
p8548
as(dp8549
g9
V17034
p8550
stp8551
a((dp8552
g2
(lp8553
VCreateProcess can return the process handle
p8554
aVAll you have to do is WaitForSinbleObject on it, it will be signaled when the
p8555
aVNET process exits
p8556
as(dp8557
g9
V17034
p8558
stp8559
a((dp8560
g2
(lp8561
VMapped drives are a per-user setting
p8562
aVWhen you run the app from the other machine, it probably uses a different user account
p8563
as(dp8564
g9
V17034
p8565
stp8566
a((dp8567
g2
(lp8568
VThere is something else going on
p8569
aVAn ExecutionEngineException is thrown by the CLR when it discovers that the garbage collected heap is corrupted
p8570
aVThat's not hard to do when you run unmanaged code in a managed program
p8571
aVA simple buffer overrun is enough
p8572
aVFinding the bug is however not easy
p8573
as(dp8574
g9
V17034
p8575
stp8576
a((dp8577
g2
(lp8578
VI don't see this actually implemented anywhere when peeking with Reflector
p8579
aVThere is only one print dialog ever used, both by WF and WPF, the native Windows print dialog
p8580
aVIt doesn't have a restricted version
p8581
aVPrinting support in
p8582
aVNET has been a bit cumbersome, it took a while before the System
p8583
aVPrinting namespace became available
p8584
aVThere might well have been early plans to implement a "better" print dialog, plans that didn't pan out
p8585
aVI would guess that the exam question was more focused on testing understanding of CAS rather than very obscure details about the actual meaning of a specific CAS attribute
p8586
as(dp8587
g9
V17034
p8588
stp8589
a((dp8590
g2
(lp8591
VThere is no difference in the serial port support for x64 Win7
p8592
aVThe COM port is however very likely to be either missing or at another port number
p8593
aVYour customer will need to use Device Manager to find the correct port number
p8594
as(dp8595
g9
V17034
p8596
stp8597
a((dp8598
g2
(lp8599
VUse  at the top of your source code file to catch problems like this
p8600
aVYou'll get a compile time error instead of a runtime error:
p8601
as(dp8602
g9
V17034
p8603
stp8604
a((dp8605
g2
(lp8606
VYou are guaranteed not to have a race in the RunWorkerCompleted event handler since it runs on the UI thread
p8607
aVThis should always work:
p8608
as(dp8609
g9
V17034
p8610
stp8611
a((dp8612
g2
(lp8613
VI think you've got bigger problems than just making sure that the derived class types are the same
p8614
aVYou are also saddling the derived class with the responsibility to generate a unique ID
p8615
aVThat requires the derived class to be aware what other IDs were assigned previously
p8616
aVRealistically, that requires a class factory
p8617
aVYou'll need to enforce that by making the constructor of your abstract class protected
p8618
aVNot very practical
p8619
aVIf the ID is just an opaque number that establishes object identity then consider assigning the ID yourself
p8620
aVUse a static member to keep track of the last assigned one
p8621
aVNow it becomes simple, and you don't have to worry about derived class types anymore
p8622
as(dp8623
g9
V17034
p8624
stp8625
a((dp8626
g2
(lp8627
VThere's another way to get timed execution, the WaitHandle
p8628
aVWaitOne() method provides a timeout argument
p8629
aVThat works very nicely in a service as it lets you implement the need to stop the service and periodic execution in a single method call
p8630
aVThe template looks like this:
p8631
as(dp8632
g9
V17034
p8633
stp8634
a((dp8635
g2
(lp8636
VYou can see what's going on by using TaskMgr
p8637
aVexe, Processes tab
p8638
aVView + Select Columns and tick "USER objects"
p8639
aVThis columns tracks window handles
p8640
aVNote that this column's value keeps increasing as you click the button
p8641
aVCalling GC
p8642
aVCollect() doesn't make it go down
p8643
aVYour program will crash and burn once it reaches 10,000
p8644
aVThe Control class is the only class in the
p8645
aVNET framework I know that requires calling Dispose()
p8646
aVThe finalizer is not enough to ensure that the window handle is released
p8647
aVCalling Dispose() is normally completely automatic, the parent of a control does it when it gets disposed
p8648
aVThe ultimate parent is the Form object, it automatically disposes itself (and its child controls) when it is closed
p8649
aVBut this doesn't happen when you remove controls from the Controls collection yourself
p8650
aVYou cannot use the Clear() method, you have to do it like this:
p8651
aVThe reason it works this way is that the lifetime of a window is managed by Windows, not your program
p8652
aVAs long as the window is alive, the control wrapper should not be garbage collected
p8653
aVWindows Forms keeps track of window handles in an internal table
p8654
aVAs long as Handle is valid, the table ensures that the Control class wrapper can't be garbage collected
p8655
aVIn other words, there is always at least one reference to the Control object
p8656
aVThat reference is not removed from that internal table until the window gets the WM_NCDESTROY message, the last message a window procedure receives before the window handle is destroyed
p8657
aVRemoving the control from a Controls collection is not enough to destroy the window
p8658
aVIf you don't explicitly call Dispose(), it will turn into a "zombie", an invisible window whose Control wrapper reference you can't obtain
p8659
as(dp8660
g9
V17034
p8661
stp8662
a((dp8663
g2
(lp8664
VI would say no
p8665
aVThere is no way to guess up front if the deriver would even consider changing the default value
p8666
aVYou will add code to your class that might never be used
p8667
aVGiven that the deriver can change the default value (even though it is a pita), you should avoid adding unnecessary code
p8668
aVGuidance for this is available from the WF implementation
p8669
aVIt rarely does this
p8670
as(dp8671
g9
V17034
p8672
stp8673
a((dp8674
g2
(lp8675
VOnce you redirect output, the output stream switches from "flush after every write" to "flush only when buffer full" mode
p8676
aVYour stderr output is now going be completely out of sync with the stdout output
p8677
aVYou'd have to explicitly call  yourself
p8678
aVMaybe your CRT has a function to change the mode
p8679
aVAlso consider not fixing this
p8680
aVNobody ever redirects progress chatter to a file, only stderr output matters
p8681
as(dp8682
g9
V17034
p8683
stp8684
a((dp8685
g2
(lp8686
VThe marked answer is not correct
p8687
aVApplication
p8688
aVExit() is a graceful shutdown, it can be blocked by a form's FormClosing event handler setting e
p8689
aVCancel = true
p8690
aVThe exact equivalent to the VB End statement is Environment
p8691
aVExit(0);
p8692
as(dp8693
g9
V17034
p8694
stp8695
a((dp8696
g2
(lp8697
VI'd avoid any code that uses Thread
p8698
aVSleep()
p8699
aVUntil
p8700
aVNET 4
p8701
aV0 becomes widely available, consider using Joe Duffy's BlockingQueue class
p8702
as(dp8703
g9
V17034
p8704
stp8705
a((dp8706
g2
(lp8707
VThe 99% solution is a one-liner:
p8708
aVreturn "\u005c"" + textBox1
p8709
aVText
p8710
aVReplace("\u005c", "\u005c\u005c")
p8711
aVReplace("\u005c"", "\u005c"") + "\u005c"";
p8712
as(dp8713
g9
V17034
p8714
stp8715
a((dp8716
g2
(lp8717
VYeah, it is a bad idea
p8718
aVAn enumerator almost always keeps a reference to the collection it is enumerating
p8719
aVAssuming both are serializable, you'll serialize the entire collection as well when you cross the boundary
p8720
aVNo round-trips though
p8721
as(dp8722
g9
V17034
p8723
stp8724
a((dp8725
g2
(lp8726
VEverything you need to build your driver (including the compiler) comes from the WDK
p8727
aVEverything you need to know what to write comes from Walter Oney's books
p8728
aVBe prepared for a rough ride
p8729
as(dp8730
g9
V17034
p8731
stp8732
a((dp8733
g2
(lp8734
VUsing the ProgressChanged event is fine
p8735
aVWhat is not fine is drawing directly to the screen
p8736
aVYour image will disappear when you minimize and restore the form
p8737
aVThe workaround is simple:
p8738
as(dp8739
g9
V17034
p8740
stp8741
a((dp8742
g2
(lp8743
VThis is simply a bug, no kind of safe handle is going avoid the
p8744
aVNET wrapper class from getting garbage collected and finalized
p8745
aVIt is a pretty common trap in P/Invoke, another classic case is passing a delegate that wraps a callback and forgetting to keep a reference to the delegate object
p8746
aVWorkarounds are easy enough: don't take the Handle until the last possible moment, the garbage collector will see the FS reference on the call stack
p8747
aVOr store the FS in a field of an object that outlives the call
p8748
aVOr P/Invoke DuplicateHandle so the wrapper can be finalized without trouble
p8749
as(dp8750
g9
V17034
p8751
stp8752
a((dp8753
g2
(lp8754
VIt is important to understand how the threadpool scheduler works
p8755
aVIt was designed to fine-tune the number of running threads against the capabilities of your machine
p8756
aVYour machine probably can run only two threads at the same time, dual-core CPUs are the current standard
p8757
aVMaybe four
p8758
aVSo when you dump a bunch of threads in its lap, it starts out by activating only two threads
p8759
aVThe rest of them are in a queue, waiting for CPU cores to become available
p8760
aVAs soon as one of those two threads completes, it activates another one
p8761
aVTwice a second, it evaluates what's going on with active threads that didn't complete
p8762
aVIt makes the rough assumption that those threads are blocking and thus not making progress and allows another thread to activate
p8763
aVYou've now got three running threads
p8764
aVGetting up the 500 threads, the default max number of threads, will take 249 seconds
p8765
aVClearly, this behavior spells out what a thread should do to be suitable to run as a threadpool thread
p8766
aVIt should complete quickly and don't block often
p8767
aVNote that blocking on I/O requests is dealt with separately
p8768
aVIf this behavior doesn't suit you then you can use a regular Thread
p8769
aVIt will start running right away and compete with other threads in your program (and the operating system) for CPU time
p8770
aVCreating 30,000 of such threads is not possible, there isn't enough virtual memory available for that
p8771
aVA 32-bit operating system poops out somewhere south of 2000 threads, consuming all available virtual memory
p8772
aVYou can get about 50,000 threads on a 64-bit operating system before the paging file runs out
p8773
aVTesting these limits in a production program is not recommended
p8774
as(dp8775
g9
V17034
p8776
stp8777
a((dp8778
g2
(lp8779
VWell, it's an easy win on SortedList
p8780
aVInserting an item requires a binary search (O(log(n)) to find the insertion point, then a List
p8781
aVInsert (O(n)) to insert the item
p8782
aVThe Insert() dominates, populating the list requires O(n^2)
p8783
aVIf the input items are already sorted then the Insert collapses to O(1) but doesn't affect the search
p8784
aVPopulating is now O(nlog(n))
p8785
aVYou don't worry how big the Oh is, sorting first is always more efficient
p8786
aVAssuming you can afford the doubled storage requirement
p8787
aVSortedDictionary is different, it uses a red-black tree
p8788
aVFinding the insertion point requires O(log(n))
p8789
aVRebalancing the tree might be required afterwards, that also takes O(log(n))
p8790
aVPopulating the dictionary thus takes O(nlog(n))
p8791
aVUsing sorted input does not change the effort to find the insertion point or rebalancing, it is still O(nlog(n))
p8792
aVNow the Oh matters though, inserting sorted input requires the tree to constant rebalance itself
p8793
aVIt works better if the input is random, you don't want sorted input
p8794
aVSo populating SortedList with sorted input and populating SortedDictionary with unsorted input is both O(nlog(n))
p8795
aVIgnoring the cost of providing sorted input, the Oh of SortedList is smaller than the Oh of SortedDictionary
p8796
aVThat's an implementation detail due to the way List allocates memory
p8797
aVIt only has to do so O(log(n)) times, a red-black tree has to allocate O(n) times
p8798
aVVery small Oh btw
p8799
aVNotable is that neither one compares favorably over simply populating a List, then calling Sort()
p8800
aVThat's also O(nlog(n))
p8801
aVIn fact, if input is already accidentally sorted you can bypass the Sort() call, this collapses to O(n)
p8802
aVThe cost analysis now needs to move to the effort it takes to get the input sorted
p8803
aVIt is hard to bypass the fundamental complexity of Sort(), O(nlog(n))
p8804
aVIt might not be readily visible, you might get the input sorted by, say, a SQL query
p8805
aVIt will just take longer to complete
p8806
aVThe point of using either SortedList or SortedDictonary is to keep the collection sorted after inserts
p8807
aVIf you only worry about populating but not mutating then you shouldn't use those collections
p8808
as(dp8809
g9
V17034
p8810
stp8811
a((dp8812
g2
(lp8813
VQuote> My question is, what's the rule about the number of vptrs in inheritance
p8814
aVThere are no rulez, every compiler vendor is allowed to implement the semantics of inheritance the way he sees fit
p8815
aVclass B: public A {}, size = 12
p8816
aVThat's pretty normal, one vtable for B that has both virtual methods, vtable pointer + 2*int = 12
p8817
aVclass C :  public A, public B {}, size = 20
p8818
aVC can arbitrarily extend the vtable of either A or B
p8819
aV2*vtable pointer + 3*int = 20
p8820
aVVirtual inheritance: that's where you really hit the edges of undocumented behavior
p8821
aVFor example, in MSVC the #pragma vtordisp and /vd compile options become relevant
p8822
aVThere's some background info in this article
p8823
aVI studied this a few times and decided the compile option acronym was representative for what could happen to my code if I ever used it
p8824
as(dp8825
g9
V17034
p8826
stp8827
a((dp8828
g2
(lp8829
VYou'll hit a couple of speed-bumps if OpenMP is on your radar
p8830
aVOpenMP is a multi-threading library for unmanaged C/C++, it requires compiler support to be effective
p8831
aVNot an option in C#
p8832
aVLet's take a step back
p8833
aVWhat you've got now is as bad as you can possibly get
p8834
aVGet/SetPixel() is dreadfully slow
p8835
aVA major step would be to use Bitmap
p8836
aVLockBits(), it gives you an IntPtr to the bitmap bits
p8837
aVYou can party on those bits with an unsafe byte pointer
p8838
aVThat will be at least an order of magnitude faster
p8839
aVLet's take another step back, you are clearly writing code to convert a color image to a gray-scale image
p8840
aVColor transforms are natively supported by GDI+ through the ColorMatrix class
p8841
aVThat code could look like this:
p8842
aVCredit to Bob Powell for the above code
p8843
as(dp8844
g9
V17034
p8845
stp8846
a((dp8847
g2
(lp8848
VYou will have to assign the object's ScreenId property value before you show it in the PropertyGrid
p8849
aVIn effect, you have to run the dbase query twice
p8850
aVOnce to know what value to assign to ScreenId, again in the type converter
p8851
as(dp8852
g9
V17034
p8853
stp8854
a((dp8855
g2
(lp8856
VTinkering with the Visible property doesn't work, the Application class forces it on so the form initializes itself properly
p8857
aVYou can however override SetVisibleCore() to customize behavior
p8858
aVPaste this code into your form:
p8859
as(dp8860
g9
V17034
p8861
stp8862
a((dp8863
g2
(lp8864
VYou forgot the 3 IUnknown methods
p8865
aVIInternetProtocolRoot::Start() is the 4th method in the vtable
p8866
as(dp8867
g9
V17034
p8868
stp8869
a((dp8870
g2
(lp8871
VWIC provides support for very large image files
p8872
aVThere's a nice wrapper for it in the
p8873
aVNET framework: TiffBitmapDecoder
p8874
as(dp8875
g9
V17034
p8876
stp8877
a((dp8878
g2
(lp8879
VWhen you are debugging, you are giving the port driver lots of time to receive a byte
p8880
aVThe timeout timer doesn't start running until you step over the ReadByte() call, the driver probably already has received the byte so ReadByte() returns immediately
p8881
aVThis doesn't happen when you run at full speed
p8882
aVIncrease the value of the ReadTimeout property
p8883
aVAlso consider using the DataReceived event instead
p8884
as(dp8885
g9
V17034
p8886
stp8887
a((dp8888
g2
(lp8889
VIt is possible but not easy
p8890
aVThe ComboBox dropdown is a native ListBox that is created on-the-fly
p8891
aVTo get the handle of that list box, you have to send the CB_GETCOMBOBOXINFO message in the DropDown event
p8892
aVCheck my answer in this thread to find out how to do this
p8893
aVThe iceberg that is likely to sink that Titanic is that the dropdown automatically closes as soon as it loses focus
p8894
aVWhich will happen as soon as you display the context menu
p8895
aVNothing you can do about that
p8896
aVConsider a different approach, you could use an actual ListBox that you make visible when the user clicks a glyph that looks like an arrow next a TextBox
p8897
as(dp8898
g9
V17034
p8899
stp8900
a((dp8901
g2
(lp8902
VBeware that windows in other applications, especially Outlook, are rarely ever a Windows Forms form
p8903
aVYou'll need lots of P/Invoke to make this work
p8904
aVFirst thing you'll need is SetWindowsHookEx() to set a WH_KEYBOARD_LL hook so that you can detect the keystroke
p8905
aVThat googles well
p8906
aVNext, you need GetForegroundWindow(), that gets you the window handle of the window that has the focus
p8907
aVNext, you need GetWindowThreadProcessId(), that lets you discover the process ID of the process that owns the window
p8908
aVYou can then use Process
p8909
aVGetProcessById() to get the Process object for the program
p8910
aVLots of info there, the Name property tells you it is Outlook
p8911
aVexe
p8912
aVInfo about the window itself is harder to obtain
p8913
aVNot much there, but you can use GetWindowText() to retrieve the text displayed on the caption bar
p8914
aVIf useful at all, you could use EnumChildWindows to enumerate the child controls in the window
p8915
aVVisit pinvoke
p8916
aVnet for the required P/Invoke declarations
p8917
as(dp8918
g9
V17034
p8919
stp8920
a((dp8921
g2
(lp8922
VYou can do this with auditing
p8923
aVRun gpedit
p8924
aVmsc, Computer Configuration, Windows Settings, Security Settings, Advanced Audit Policy Configuration, System Audit Policies, Detailed Tracking, Audit Process Creation
p8925
aVAsk more questions about it at superuser
p8926
aVcom
p8927
as(dp8928
g9
V17034
p8929
stp8930
a((dp8931
g2
(lp8932
VI'd guess because it is safer
p8933
aVIf they would have used IntPtr, the constructor could be called with any garbage value
p8934
aVWith byte* there's at least a shot at the compiler verifying that the memory is valid and pinned
p8935
aVAlbeit that casting an IntPtr to byte* is pretty simple
p8936
as(dp8937
g9
V17034
p8938
stp8939
a((dp8940
g2
(lp8941
VThere was a post VS2008 SP1 hotfix released that solves a number of debugging problems
p8942
aVThe KB article is here, the hotfix download is here
p8943
aVUPDATE: the hotfix download location was retired, I don't know of an alternative download location
p8944
aVPlease edit this post if you find one
p8945
as(dp8946
g9
V17034
p8947
stp8948
a((dp8949
g2
(lp8950
VThis could be as simple as the disk on the build server going bad
p8951
aVThere's nothing in your post that suggests anything more complicated
p8952
aVAlthough it is pretty weird to see the IDL back in the DLL, type libraries are binary
p8953
as(dp8954
g9
V17034
p8955
stp8956
a((dp8957
g2
(lp8958
VThere's awkwardness in the
p8959
aVNET APIs induced by Dispose()
p8960
aVOther examples of classes that have both a Close and a Dispose method are the Stream derived classes, Socket, TcpClient, EventLog, Process, SqlConnection and many others
p8961
aVI don't know any example of such a class that doesn't simply call Dispose() in its Close() method implementation
p8962
aVIn other words, you're always fine using the "using" statement and not calling Close
p8963
aVThe API designers however preferred keeping Close() around as a more literal way of ending the use of the object
p8964
aVThat's defensible, the Dispose() method tends to be inherited from a base class, often a very obscure one
p8965
as(dp8966
g9
V17034
p8967
stp8968
a((dp8969
g2
(lp8970
VThe CLR version hasn't changed since 2005, it is still the 2
p8971
aV0 version
p8972
aVThat's about to change, 4
p8973
aV0 will be released in the spring
p8974
aVYour only other consideration is what
p8975
aVNET assemblies you take a dependency on
p8976
aVStuff like WPF, WCF and Linq isn't likely to be available if your customer got stuck at the
p8977
aVNET 2
p8978
aV0 release
p8979
aVYou can easily avoid creating such a dependency in VS2008
p8980
aVProject + Properties, Application tab, Target Framework combo
p8981
as(dp8982
g9
V17034
p8983
stp8984
a((dp8985
g2
(lp8986
VSet all the buttons' AutoCheck property to False
p8987
aVYou'll now have to write a Click handler for them to set their Checked property
p8988
aVA sample handler that takes care of two of them:
p8989
as(dp8990
g9
V17034
p8991
stp8992
a((dp8993
g2
(lp8994
VThe default minimum number of threads is the number of cores your machine has
p8995
aVThat's a good number, it doesn't generally make sense to run more threads than you have cores
p8996
aVThe default maximum number of threads is 250 times the number of cores you have on
p8997
aVNET 2
p8998
aV0 SP1 and up
p8999
aVThere is an enormous amount of breathing room here
p9000
aVOn a four core machine, it would take 499 seconds to reach that maximum if none of the threads complete in a reasonable amount of time
p9001
aVThe threadpool scheduler tries to limit the number of active threads to the minimum, by default the number of cores you have
p9002
aVTwice a second it allows one more thread to start if the active threads do not complete
p9003
aVThreads that run for a very long time or do a lot of blocking that is not caused by I/O are not good candidates for the threadpool
p9004
aVYou should use a regular Thread instead
p9005
aVGetting to the maximum isn't healthy
p9006
aVOn a four core machine, just the stacks of those threads will consume a gigabyte of virtual memory space
p9007
aVGetting OOM is very likely
p9008
aVConsider lowering the max number of threads if that's your problem
p9009
aVOr consider starting just a few regular Threads that receive packets of work from a thread-safe queue
p9010
as(dp9011
g9
V17034
p9012
stp9013
a((dp9014
g2
(lp9015
VThe code shown below does what you need
p9016
aVOverriding the user's choice is pretty unwise btw
p9017
as(dp9018
g9
V17034
p9019
stp9020
a((dp9021
g2
(lp9022
VStart the charmap
p9023
aVexe applet, check the "Advanced view" option (lower left)
p9024
aVIn the "Search for:" box type "box draw" and click Search
p9025
aVClick on one of the characters, the status bar at the bottom give you the code you need to use
p9026
aVFor example:
p9027
as(dp9028
g9
V17034
p9029
stp9030
a((dp9031
g2
(lp9032
VStart debugging, right-click source, Go To Disassembly
p9033
aVYou'd see something like this:
p9034
aVIn other words: the JIT compiler generates explicit code to check for overflows
p9035
aVThis is off by default
p9036
as(dp9037
g9
V17034
p9038
stp9039
a((dp9040
g2
(lp9041
VYes, use the  element in the
p9042
aVexe
p9043
aVconfig file
p9044
aVFor example:
p9045
as(dp9046
g9
V17034
p9047
stp9048
a((dp9049
g2
(lp9050
VNot using a key but only a value is fine
p9051
aVHowever, the tree will become immutable if you do this
p9052
aVModifying a value is no longer safe since it will imbalance the tree
p9053
aVYou will have to enforce this by providing only a property getter for the node value
p9054
as(dp9055
g9
V17034
p9056
stp9057
a((dp9058
g2
(lp9059
VThe Start() method returns a Process object
p9060
aVCall its Kill method:
p9061
as(dp9062
g9
V17034
p9063
stp9064
a((dp9065
g2
(lp9066
VSqlLite contains unmanaged code, you can't run it on a 64-bit operating system unless you deploy the 64-bit version
p9067
aVQuick fix: Project + Properties, Build tab, Platform Target = x86
p9068
as(dp9069
g9
V17034
p9070
stp9071
a((dp9072
g2
(lp9073
VThread pool threads are much cheaper than a regular Thread, they pool the system resources required for threads
p9074
aVBut they have a number of limitations that may make them unfit:
p9075
aVYou cannot abort a threadpool thread
p9076
aVThere is no easy way to detect that a threadpool completed, no Thread
p9077
aVJoin()
p9078
aVThere is no easy way to marshal exceptions from a threadpool thread
p9079
aVYou cannot display any kind of UI on a threadpool thread beyond a message box
p9080
aVA threadpool thread should not run longer than a few seconds
p9081
aVA threadpool thread should not block for a long time
p9082
aVThe latter two constraints are a side-effect of the threadpool scheduler, it tries to limit the number of active threads to the number of cores your CPU has available
p9083
aVThis can cause long delays if you schedule many long running threads that block often
p9084
aVMany other threadpool implementations have similar constraints, give or take
p9085
as(dp9086
g9
V17034
p9087
stp9088
a((dp9089
g2
(lp9090
VThat file isn't zip compressed at all
p9091
aVIt appears to be some xml that's embedded in a certificate, issued by the Czech Post Office
p9092
aVThe actual message looks to be encoded in some kind of base64 variant
p9093
aVCall your post office
p9094
as(dp9095
g9
V17034
p9096
stp9097
a((dp9098
g2
(lp9099
VThe default value of the
p9100
aVext\u005cshell\u005copen\u005ccommand key should contain the path to your
p9101
aVexe with the "%1" argument
p9102
aVExplorer substitutes that with the full path to the file
p9103
aVWhich you can read in your
p9104
aVexe through the Main() method argument or Environment
p9105
aVGetCommandLineArgs()
p9106
as(dp9107
g9
V17034
p9108
stp9109
a((dp9110
g2
(lp9111
VYou can get one out of the Graphics object returned by PrinterSettings
p9112
aVCreateMeasurementGraphics()
p9113
aVUse the Graphics
p9114
aVGetHdc() method
p9115
aVDon't forget ReleaseHdc() after printing
p9116
as(dp9117
g9
V17034
p9118
stp9119
a((dp9120
g2
(lp9121
VThis is a very slippery slope you're riding
p9122
aVHandling an exception requires the program to restore the state of the program to the state it had before the exception was thrown so it can meaningful continue
p9123
aVThat's going to be mighty difficult to do, the collection obviously contains an object that cannot be processed
p9124
aVRestoring state would require restoring the collection as well
p9125
aVMaybe that's possible
p9126
aVBut not in the code in your snippet, it doesn't has any code that appears to be responsible for entering objects in the collection
p9127
aVYou should not catch an exception if you don't know how to restore state
p9128
as(dp9129
g9
V17034
p9130
stp9131
a((dp9132
g2
(lp9133
VOpening or saving an Image puts a lock on the file
p9134
aVOverwriting this file requires you to first call Dispose() on the Image object that holds the lock
p9135
aVI don't really understand your code but you'd have to do it this way:
p9136
aVThe Using statement ensures that the img object is disposed and the file lock is released
p9137
as(dp9138
g9
V17034
p9139
stp9140
a((dp9141
g2
(lp9142
VThere's no fast in retrieving attributes
p9143
aVBut code ought to look like this (credit to Aaronaught):
p9144
aVIf you need to retrieve attribute properties then
p9145
as(dp9146
g9
V17034
p9147
stp9148
a((dp9149
g2
(lp9150
VYou'll have to set your own standards of success
p9151
aVWrite down test cases, sets of two strings and the output they should produce
p9152
aVVerify them by running the code
p9153
aVDon't forget the outliers, pass empty strings and NULL strings too
p9154
as(dp9155
g9
V17034
p9156
stp9157
a((dp9158
g2
(lp9159
VEverybody is always looking for going around the other way
p9160
aVAnyhoo, this code project should help
p9161
as(dp9162
g9
V17034
p9163
stp9164
a((dp9165
g2
(lp9166
VAnother quote from the Intel manuals, volume 1, chapter 10
p9167
ag2584
ag2586
aV3:
p9168
aVThe flush-to-zero mode is not compatible with IEEE Standard 754
p9169
aVThe IEEE mandated
p9170
aVmasked response to underflow is to deliver the denormalized result (see
p9171
aVSection 4
p9172
aV8
p9173
ag2586
aV2, \u201cNormalized and Denormalized Finite Numbers\u201d)
p9174
aVThe flush-to-zero
p9175
aVmode is provided primarily for performance reasons
p9176
aVAt the cost of a slight precision
p9177
aVloss, faster execution can be achieved for applications where underflows are common
p9178
aVand rounding the underflow result to zero can be tolerated
p9179
as(dp9180
g9
V17034
p9181
stp9182
a((dp9183
g2
(lp9184
VThe CLR already caches metadata
p9185
aVVery slow on the first call when it is dug out of the assembly, fast afterward
p9186
aVCaching yourself isn't going to make any difference
p9187
as(dp9188
g9
V17034
p9189
stp9190
a((dp9191
g2
(lp9192
VA Dictionary<> is internally organized as a list of lists
p9193
aVYou won't get close to the (2GB/8)^2 limit on a 64-bit machine
p9194
as(dp9195
g9
V17034
p9196
stp9197
a((dp9198
g2
(lp9199
VThere's little hope of your program ever finding that folder
p9200
aVWhen you deploy your app, there is no project folder
p9201
aVThe best way to organize it is to add the
p9202
aVxml files to your project with Project + Add Existing
p9203
aVSelect them in Solution Explorer and in the Properties window set Build action = None and Copy to Output Directory = Copy if Newer
p9204
aVBuild
p9205
aVThat puts the files in the same directory as your
p9206
aVexe
p9207
aVFind them back at runtime with System
p9208
aVIO
p9209
aVPath
p9210
aVGetDirectoryName(System
p9211
aVReflection
p9212
aVAssembly
p9213
aVGetEntryAssembly()
p9214
aVLocation)
p9215
as(dp9216
g9
V17034
p9217
stp9218
a((dp9219
g2
(lp9220
VYou'll need to use TextRenderer
p9221
aVDrawText()
p9222
aVThat's what TreeView uses, it renders text slightly different from Graphics
p9223
aVDrawString()
p9224
as(dp9225
g9
V17034
p9226
stp9227
a((dp9228
g2
(lp9229
VEpic tale from real life: the Big Boss of the mid-western company came to take a look at project progress
p9230
aVNot sure how it happened, but somehow a new set of orders came down from the scheduling office for a customer never seen before
p9231
aVAnd went into production around the time the Boss came to have a look
p9232
aVHis last name was O'Shaughnessy
p9233
aVUsing parameterized input is good for more than just avoiding SQL Injection
p9234
as(dp9235
g9
V17034
p9236
stp9237
a((dp9238
g2
(lp9239
VWhen you redirect the output of a program written in C/C++, the stdout stream switches to buffered mode
p9240
aVThe prompt is there, it just never got flushed from the internal buffer to the stream because the buffer didn't get filled to capacity
p9241
aVJust writing the password is likely to solve your problem
p9242
as(dp9243
g9
V17034
p9244
stp9245
a((dp9246
g2
(lp9247
VProject + Properties, Debug tab, scroll down, tick the "Enable unmanaged code debugging" checkbox
p9248
aVNow you can set a breakpoint and debug it
p9249
aVIf your IDE doesn't support mixed mode debugging, you can attach a debugger using the technique outlined in this post
p9250
as(dp9251
g9
V17034
p9252
stp9253
a((dp9254
g2
(lp9255
VSpecificVersion can't solve your problem, that only works at compile time
p9256
aVYou ought to rebuild your program for a minimum of surprises
p9257
aVOr you can use the  element in the
p9258
aVexe
p9259
aVconfig file
p9260
as(dp9261
g9
V17034
p9262
stp9263
a((dp9264
g2
(lp9265
VClearly, you are battling deadlock
p9266
aVThat's always around the corner when you use Control
p9267
aVInvoke() instead of BeginInvoke()
p9268
aVIt isn't clear to me what trips the deadlock from your post
p9269
aVOne red flag is using Hide() on a form that you displayed with ShowDialog()
p9270
aVThat normally closes the dialog
p9271
aVBest thing to do is to debug it
p9272
aVWait until the deadlock occurs, then use Debug + Break All
p9273
aVUse Debug + Windows + Threads and switch to the UI thread
p9274
aVLook at the Call Stack
p9275
aVIf it is not pumping the message loop (Application
p9276
aVRun()) but is stuck somewhere (like the wait handle you appear to be using) then deadlock is the result
p9277
as(dp9278
g9
V17034
p9279
stp9280
a((dp9281
g2
(lp9282
VHere's a generic dictionary class that knows how to serialize itself:
p9283
as(dp9284
g9
V17034
p9285
stp9286
a((dp9287
g2
(lp9288
VWell, Visual Studio supports solutions with multiple projects
p9289
aVAnd its dependency engine is capable of detecting that a changed macro value requires a project to be recompiled
p9290
aVOccam's razor says that the libs simply got rebuilt and acquired the new VERSION macro value
p9291
as(dp9292
g9
V17034
p9293
stp9294
a((dp9295
g2
(lp9296
VThat's not how it works
p9297
aVIt is a virtual method, you're supposed to override it in your own custom DataGridViewCell derived class
p9298
aVAnd the DataGridView would have to be filled with those custom cells
p9299
as(dp9300
g9
V17034
p9301
stp9302
a((dp9303
g2
(lp9304
VForget about partial, that has entirely different semantics
p9305
aVWhether the overrider of your virtual base class method should call the base class method is not automatic
p9306
aVIt needs to be part of your documentation
p9307
aVA good example are the OnXxxx() methods in the Control class, the MSDN library docs have a "Note to implementer" comment that warns that calling the base class method is usually necessary
p9308
aVIf you make the base class method abstract then it is crystal-clear to the overrider
p9309
aVIf it is not, you are dropping a strong hint that it ought to be done
p9310
aVIf you expect the override to completely replace your base implementation then you should really consider making it abstract
p9311
aVThis ambiguity, combined with the odds that the overrider breaks your base class by overriding incorrectly, is definitely one of the weak points of polymorphism
p9312
as(dp9313
g9
V17034
p9314
stp9315
a((dp9316
g2
(lp9317
VIt is easy with the Control
p9318
aVDrawToBitmap() method
p9319
aVThis worked fine:
p9320
as(dp9321
g9
V17034
p9322
stp9323
a((dp9324
g2
(lp9325
VYou'll need to give it a bigger InternalBufferSize
p9326
aVAnd repond quickly to change events
p9327
aVQueuing them, then processing the notification in another thread is best
p9328
aVThat also helps you deal with the inevitable locked file problems
p9329
as(dp9330
g9
V17034
p9331
stp9332
a((dp9333
g2
(lp9334
VIt is a JIT optimizer bug
p9335
aVIt is unrolling the inner loop but not updating the oVec
p9336
aVy value properly:
p9337
aVThe bug disappears when you let oVec
p9338
aVy increment to 4, that's too many calls to unroll
p9339
aVOne workaround is this:
p9340
aVUPDATE: re-checked in August 2012, this bug was fixed in the version 4
p9341
ag2512
aV30319 jitter
p9342
aVBut is still present in the v2
p9343
ag2512
aV50727 jitter
p9344
aVIt seems unlikely they'll fix this in the old version after this long
p9345
as(dp9346
g9
V17034
p9347
stp9348
a((dp9349
g2
(lp9350
VHow many projects do you have
p9351
aVI timed it, it takes 3 seconds in Visual Studio
p9352
aVRight-click project, Add, Resource, select "Version", New
p9353
as(dp9354
g9
V17034
p9355
stp9356
a((dp9357
g2
(lp9358
VYou found a bug in the framework
p9359
aVXDocument
p9360
aVSave(string) uses the "using" statement to ensure the output stream gets disposed
p9361
aVIt depends on the encoding you used in the processing instruction but the internal System
p9362
aVXml
p9363
aVXmlUtf8RawTextReader would be a common one to implement the text writer
p9364
aVThe bug: the Microsoft programmer that wrote that class forgot to implement the Dispose() method
p9365
aVOnly the Close() method is implemented
p9366
aVIt is rather strange that this bug wasn't yet reported at the connect
p9367
aVmicrosoft
p9368
aVcom feedback site
p9369
aVIt ought to cause trouble in general use because the file stays open until the finalizer thread runs
p9370
aVAlthough that normally doesn't take that long, a couple of seconds or so
p9371
aVExcept in your case where you exit the program right after writing and have the unfortunate luck to run out of disk space at the exact moment the buffer gets flushed
p9372
aVA workaround for this bug is to use the XDocument
p9373
aVSave(TextWriter) overload instead, passing a StreamWriter whose Encoding matches the encoding of the XML
p9374
as(dp9375
g9
V17034
p9376
stp9377
a((dp9378
g2
(lp9379
VWeifenluo's DockPanel Suite is a very popular implementation of the Visual Studio style user interface
p9380
aVIt has the right price too
p9381
as(dp9382
g9
V17034
p9383
stp9384
a((dp9385
g2
(lp9386
VYou are violating several threading rules:
p9387
aVWebBrowser is an ActiveX control with single-threaded apartment requirements
p9388
aVYou are correctly setting the thread to STA but you are violating the second requirement: an STA thread must pump a message loop
p9389
aVYou didn't get that far yet, but the DocumentCompleted event will never fire
p9390
aVWindows requires child controls to belong to the same thread as their parent
p9391
aVIn your case, there's a nasty mismatch
p9392
aVThe AxHost wrapper will be created on the UI thread due to the Controls
p9393
aVAdd() call but the native window handle that the WebBrowser uses may not
p9394
aVI think that's the source of the exception you get
p9395
aVYou can't make this work as you intended, a web browser is simply not a chunk of code that can handle multiple threads
p9396
aVEven if you do create it on the correct thread, calls made on a background thread will be marshaled by COM to implement the STA contract, there is no concurrency
p9397
aVUsing it on a separate STA thread that pumps a message loop (Application
p9398
aVRun) is fine but the form and its controls must be created on that same thread
p9399
as(dp9400
g9
V17034
p9401
stp9402
a((dp9403
g2
(lp9404
VWhenever you think "there's common functionality
p9405
aVyou should consider a method to implement it
p9406
aVIt could look like this:
p9407
as(dp9408
g9
V17034
p9409
stp9410
a((dp9411
g2
(lp9412
VThe debugger is getting in the way
p9413
aVThe Application class is aware that a debugger is attached to the program, it uses System
p9414
aVDiagnostics
p9415
aVDebugger
p9416
aVIsAttached()
p9417
aVIf that's the case, it does not use a try/catch block around the message loop and the Application
p9418
aVThreadException event will not run
p9419
aVThis is quite intentional
p9420
aVIf the catch block were active, you would have a very hard time troubleshooting exceptions in your program
p9421
aVWithout the catch block, the debugger will always stop and show you what is wrong
p9422
aVYou can reproduce the runtime behavior
p9423
aVAdd this line of code to your Main() method before the Run() call:
p9424
as(dp9425
g9
V17034
p9426
stp9427
a((dp9428
g2
(lp9429
VYou'll need a window, there's no way around that
p9430
aVHere's a sample implementation
p9431
aVImplement an event handler for the DeviceChangeNotifier
p9432
aVDeviceNotify event to get notifications
p9433
aVCall the DeviceChangeNotifier
p9434
aVStart() method at the start of your program
p9435
aVCall DeviceChangeNotifier
p9436
aVStop() at the end of your program
p9437
aVBeware that the DeviceNotify event is raised on a background thread, be sure to lock as needed to keep your code thread-safe
p9438
as(dp9439
g9
V17034
p9440
stp9441
a((dp9442
g2
(lp9443
VThe PerformanceCounter class already uses a threadsafe wrapper, an internal class named SharedPerformanceCounter
p9444
aVIt uses Interlocked
p9445
aVIncrement() to increment a counter value for example
p9446
aVThere's no need to lock yourself
p9447
as(dp9448
g9
V17034
p9449
stp9450
a((dp9451
g2
(lp9452
VYes, just tracking the old size in a class field is the simple solution
p9453
aVFor example:
p9454
as(dp9455
g9
V17034
p9456
stp9457
a((dp9458
g2
(lp9459
VThere's nothing really special about
p9460
aVNET 3
p9461
aV5, it is just a bunch of added assemblies (like Linq)
p9462
aVSame for
p9463
aVNET 3
p9464
aV0 (like WPF)
p9465
aVNET frameworks 2
p9466
aV0 through 3
p9467
aV5 SP1 still use the same version of the CLR, version 2
p9468
ag2512
aVSo it is a very conscious decision to make your program depend on
p9469
aVNET 3
p9470
aV5, it requires Project + Add Reference and selecting an assembly that has a 3
p9471
ag2447
ag2512
aV0 version number
p9472
aVOnce you do that, your client needs to have that same assembly installed on her machine
p9473
aVWhich requires the
p9474
aVNET 3
p9475
aV5 version of the framework to be installed on her machine
p9476
aVMost clients already have it, it got distributed by Windows Update
p9477
as(dp9478
g9
V17034
p9479
stp9480
a((dp9481
g2
(lp9482
VThe Guest account can change its account picture
p9483
aVI recommend the fish
p9484
aVThat's about it, don't use Guest
p9485
as(dp9486
g9
V17034
p9487
stp9488
a((dp9489
g2
(lp9490
VIt is far worse than simple data loss
p9491
aVThe Queue class can re-allocate its internal buffer when needed to accommodate a growing number of elements
p9492
aVImproper locking can access the new buffer with old values of the head and tail indices
p9493
aVYou'll only get an exception when you're lucky, more likely is that you simply get the wrong element
p9494
as(dp9495
g9
V17034
p9496
stp9497
a((dp9498
g2
(lp9499
VAre you calling InitCommonControlsEx() in your program
p9500
aVRequired
p9501
as(dp9502
g9
V17034
p9503
stp9504
a((dp9505
g2
(lp9506
VPreventing a user from selecting a tab makes for a very unintuitive user interface
p9507
aVConsider creating a "wizard", a UI gadget that takes the user from one page to the next with a Next button
p9508
aVAnd a Back button, optional
p9509
aVYou can make it clear that a step is completed by setting the Next button's Enabled property
p9510
aVCreating such a wizard can be done with a TabControl
p9511
aVAdd a new class to your project and paste the code shown below
p9512
aVCompile
p9513
aVDrop the new control from the top of the toolbox onto your form
p9514
aVAt design time it looks like a normal TC, allowing you to add the controls needed for each wizard step
p9515
aVAt runtime the tabs are hidden
p9516
aVImplementing the Next and Back buttons is simple, just change the SelectedIndex property
p9517
as(dp9518
g9
V17034
p9519
stp9520
a((dp9521
g2
(lp9522
Vdelete it
p9523
aVIt can't be used from that location
p9524
aVno, it is a horrible practice, invoking DLL Hell
p9525
aVIt doesn't work anyway
p9526
aVyes, but the manifest in a program that uses it will prevent that
p9527
aVreview the VS2005 SP1 and the July 2009 security update KB articles
p9528
as(dp9529
g9
V17034
p9530
stp9531
a((dp9532
g2
(lp9533
VIt is a moving target
p9534
aVFor example, the PrintForm component wasn't originally part of the framework install set, but it is in
p9535
aVNET 3
p9536
aV5 SP1
p9537
aVThe very best thing to do is to not ask the question, you'll get in trouble some day when you do
p9538
as(dp9539
g9
V17034
p9540
stp9541
a((dp9542
g2
(lp9543
VServices cannot create console windows, they run in their own session with their own "desktop"
p9544
aVGiven that you see one, I'd have to guess that you didn't actually create a service
p9545
aVWhat happened when you tried to install it with InstallUtil
p9546
aVexe
p9547
aVThis MSDN Library page has recommendations to debug a service's OnStart() method
p9548
as(dp9549
g9
V17034
p9550
stp9551
a((dp9552
g2
(lp9553
VThe more interesting case is this one:
p9554
aV}
p9555
aVIf you run Ildasm
p9556
aVexe on this, you'll see that it actually emits the Base
p9557
aVTest() method, but omits the base
p9558
aVTest() call
p9559
aVIn other words, [Conditional] doesn't omit methods, it omits method calls
p9560
as(dp9561
g9
V17034
p9562
stp9563
a((dp9564
g2
(lp9565
VDependency walker can only profile unmanaged programs
p9566
as(dp9567
g9
V17034
p9568
stp9569
a((dp9570
g2
(lp9571
VYou can't optimize it, it is already very efficient
p9572
aVYou can make it more readable though, Flag1 and Flag2 definitely ought to be renamed to Held and Conditional
p9573
as(dp9574
g9
V17034
p9575
stp9576
a((dp9577
g2
(lp9578
VYou must run Regsvr32
p9579
aVexe from a command prompt that's elevated to administrator (i
p9580
aVe
p9581
aVUAC disabled)
p9582
aVMake a shortcut on your desktop to "cmd
p9583
aVexe", right-click it and choose "Run as Administrator"
p9584
as(dp9585
g9
V17034
p9586
stp9587
a((dp9588
g2
(lp9589
VIt is possible to do
p9590
aVWhat is needed:
p9591
aVAn application needs to start a server itself rather than relying on COM to do it
p9592
aVYou don't need the extra indirection provided by the registry, just use CreateProcess()
p9593
aVA server should register its class factories in its main() method with CoRegisterClassObject()
p9594
aVImportant: the CLSID it uses for each factory should be altered to be unique for each service instance
p9595
aVThis ensures that the client connects to the correct server
p9596
aVI simply XOR the process ID with a class factory CLSID
p9597
aVThe client knows the process ID as well so can make the same alteration
p9598
aVThe application should call CoCreateInstance() in a loop with a Sleep() call to wait for the object factory to appear
p9599
aVDon't declare failure until at least 60 seconds have passed (that bit me)
p9600
aVBoth the application and the server need a manifest that contains a  element for each proxy/stub DLL and  elements for each interface that is remoted
p9601
as(dp9602
g9
V17034
p9603
stp9604
a((dp9605
g2
(lp9606
VIt is the CreateGraphics() call that is getting you in trouble, indirectly
p9607
aVThe problem is anti-aliasing of the text
p9608
aVA normal painting cycle erases the background before drawing something on top
p9609
aVThat doesn't happen in your case, your draw text on top of existing text
p9610
aVThe side effect is that the pixels uses to create the aliasing get darker each time your draw
p9611
aVThe end result is bold looking, and noticeably jagged text outlines
p9612
aVThe fix is easy: start with a clean slate before you draw:
p9613
aVYou'll now also get to encounter a problem in drawing known as "flicker"
p9614
aVIt might not yet be that noticeable yet, but it will when you do more drawing
p9615
aVFlicker is suppressed with double-buffering
p9616
aVA feature supported by Windows Forms, but only if you use standard drawing techniques
p9617
aVIn other words: no CreateGraphics()
p9618
as(dp9619
g9
V17034
p9620
stp9621
a((dp9622
g2
(lp9623
VSame code, now using a BackgroundWorker and an orderly shutdown that ensures the form doesn't close until the background thread has stopped running first:
p9624
aVNote that the Sleep() call is required, it isn't possible to marshal calls to the UI thread more than about a 1000 times per second
p9625
as(dp9626
g9
V17034
p9627
stp9628
a((dp9629
g2
(lp9630
VProject + Add Reference, Browse tab, select the DLL you downloaded
p9631
as(dp9632
g9
V17034
p9633
stp9634
a((dp9635
g2
(lp9636
VThis sounds pretty bizarre, does the MyConApp
p9637
aVexe do anything that affects the build process of MyWinApp
p9638
aVexe
p9639
aVIf it does, it certainly doesn't belong in the bin\u005cDebug directory, it would have to have the same affect when you build the Release version
p9640
aVIt belongs in the project directory
p9641
aVIf it doesn't affect the build then using a pre-build event is entirely inappropriate
p9642
aVYou'll then need to explain why this is at all necessary
p9643
as(dp9644
g9
V17034
p9645
stp9646
a((dp9647
g2
(lp9648
VThe MSDN library doesn't give very good info on the "hosting process"
p9649
aVThe last two features listed in Eric's link are actually problems induced by the feature
p9650
aVThere's another one that you're bound to run into sooner or later: it uses a different app
p9651
aVconfig file
p9652
aVThe active one is named yourapp
p9653
aVvshost
p9654
aVexe
p9655
aVconfig
p9656
aVWatch out for this when you make manual changes to the file
p9657
aVAnother feature it supports that's very visible when you debug your app but isn't mentioned anywhere is what happens to the output produced by Console
p9658
aVWrite()
p9659
aVIn a non-console mode app, it gets redirected to the IDE's Output window
p9660
aVVery useful
p9661
aVThe term "hosting" refers to a feature of the CLR, it can be "hosted"
p9662
aVExamples of custom CLR hosts are SQL Server and ASP
p9663
aVNET
p9664
aVHosting allows one to configure the CLR before it gets started
p9665
aVOne primary use of this is configuring the primary AppDomain and setting up custom security policies
p9666
aVWhich is exactly what the hosting process is doing
p9667
aVA good example of a custom CLR host is available in this question
p9668
aVLong story short: in debug mode you are running with a customized version of the CLR, one that improves the debugging experience
p9669
as(dp9670
g9
V17034
p9671
stp9672
a((dp9673
g2
(lp9674
VYou forgot to say what input you expected
p9675
aVSeeing question marks in the received data indicates that the SerialPort
p9676
aVEncoding property isn't set right
p9677
aVIt defaults to ASCII, any byte that has a value between 128 and 255 will be turned into a question mark
p9678
aVMaybe you don't actually want to receive characters, maybe you need bytes
p9679
aVUse Read()
p9680
aVAnother explanation for question marks is that the serial port configuration for the device doesn't match the one for the machine
p9681
aVA baudrate mismatch produces garbled data, that could turn into question marks as explained above
p9682
aVGetting a parity mismatch also produces question marks
p9683
aVLast but not least, you cannot use Sleep() to reliably synchronize your thread with the serial port
p9684
aVUse the DataReceived event instead
p9685
as(dp9686
g9
V17034
p9687
stp9688
a((dp9689
g2
(lp9690
VIt is a CATID, a component category
p9691
aVA control host can use it to, say, filter items that appears in a toolbox, only offering ones that implement an expected set of interfaces
p9692
aVYou can see a list of known component categories in the HKCR\u005cComponent Categories registry key
p9693
aVThe one that Regasm
p9694
aVexe uses means "this COM server is implemented in
p9695
aVNET"
p9696
aVWhich is kinda useful to know since a
p9697
aVNET program should not use a COM server that is implemented in a managed language, it should use the metadata in the assembly directly
p9698
aVCATIDs are not well documented
p9699
aVWhich makes them fairly useless, you'll rarely have trouble if you simply omit them
p9700
aVIf some control host vendor requires you to use a CATID to make your COM server usable in their host, they'll let you know about that explicitly
p9701
as(dp9702
g9
V17034
p9703
stp9704
a((dp9705
g2
(lp9706
VGraphics
p9707
aVDrawImage() speed is critically dependent on the pixel format
p9708
aVFormat32bppPArgb is 10 times faster than any other one on any recent machine I've tried
p9709
aVAlso make sure you the image doesn't get resized, be sure to use a DrawImage() overload that sets the destination size equal to the bitmap size
p9710
aVVery important if the video adapter's DPI setting doesn't match the resolution of the bitmap
p9711
as(dp9712
g9
V17034
p9713
stp9714
a((dp9715
g2
(lp9716
VIt depends how you call it
p9717
aVIf you use COM then you'll get a failure HRESULT
p9718
aVYou can use IErrorInfo to retrieve the exception message
p9719
aVIf you use something else then you'll lose the error context, all you can see is an SEH exception with exception code 0xe0434f4e, catchable only with the __try and __except keywords
p9720
aVUsing COM is heavily recommended
p9721
aVEDIT after you posted code
p9722
aVOkay, you are using COM
p9723
aVAnd the smart pointers derived from _com_ptr_t that are created by the #import directive
p9724
aVThese smart pointers turn failure HRESULTs into C++ exceptions
p9725
aVYou'll need to catch a _com_error exception
p9726
aVThat class also has the plumbing to get a suitable exception description, use the Description() method
p9727
as(dp9728
g9
V17034
p9729
stp9730
a((dp9731
g2
(lp9732
VWhen execution reaches XXXX, the object referenced by t1 is eligible for garbage collection
p9733
aVWhich includes the object references held by its fields, objClassOfInts and name
p9734
aVWhen it reaches YYYY, both the objects referenced by t1 and t2 are eligible
p9735
aVIn debug mode, they won't be eligible until the method exits
p9736
aVIt says nothing about when they actually get collected, it can take a while
p9737
as(dp9738
g9
V17034
p9739
stp9740
a((dp9741
g2
(lp9742
VThe Validating event was designed to do this
p9743
aVSet e
p9744
aVCancel = true if you're not happy with the input
p9745
aVThe ErrorProvider component is ideal to provide visual feedback
p9746
as(dp9747
g9
V17034
p9748
stp9749
a((dp9750
g2
(lp9751
VYou cannot use P/Invoke to call instance methods of a C++ class
p9752
aVThe primary hang-up is that you can't create an object of the class, you cannot discover the required memory allocation size
p9753
aVPassing the implicit "this" pointer to the instance method is another problem, it needs to be passed in a register
p9754
aVYou'll need to create a managed wrapper for the class, that requires using the C++/CLI language
p9755
aVGoogle "C++/CLI wrapper" for good hits
p9756
as(dp9757
g9
V17034
p9758
stp9759
a((dp9760
g2
(lp9761
VThere's only one reason it could be so slow
p9762
aVIt's an old-fashioned problem called thrashing
p9763
aVKeep an eye on your hard disk light while your program runs
p9764
aVIs it blinking furiously
p9765
aVBuy more RAM
p9766
as(dp9767
g9
V17034
p9768
stp9769
a((dp9770
g2
(lp9771
VMicrosoft forgot to implement the Begin/EndUpdate() methods for TextBox
p9772
aVYou can add them yourself, it solves the problem
p9773
aVYou can't get rid of the flicker though
p9774
aVSample code:
p9775
as(dp9776
g9
V17034
p9777
stp9778
a((dp9779
g2
(lp9780
VNET supports this with the [Flags] attribute:
p9781
aVSample usage:
p9782
as(dp9783
g9
V17034
p9784
stp9785
a((dp9786
g2
(lp9787
VAnything is possible here, you might be trying to talk to a particularly cranky SMTP server
p9788
aVYou can't handle errors in your code, your code can't change the way the server works
p9789
aVIt takes a human to figure out why the server doesn't like your message
p9790
aVThe error codes that can be returned by an SMTP server are otherwise documented, review the SmtpStatusCode enum
p9791
as(dp9792
g9
V17034
p9793
stp9794
a((dp9795
g2
(lp9796
VIt is fairly cheap to implement the atomicity guarantee on x86 and x64 cores since the CLR only promises atomicity for variables that are 32-bit or smaller
p9797
aVAll that's required is that the variable is properly aligned and doesn't straddle a cache line
p9798
aVThe JIT compiler ensures this by allocating local variables on a 4-byte aligned stack offset
p9799
aVThe GC heap manager does the same for heap allocations
p9800
aVNotable is that the CLR guarantee is not a very good one
p9801
aVThe alignment promise is not good enough to write code that's consistently performant for arrays of doubles
p9802
aVVery nicely demonstrated in this thread
p9803
aVInterop with machine code that uses SIMD instructions is also very difficult for this reason
p9804
as(dp9805
g9
V17034
p9806
stp9807
a((dp9808
g2
(lp9809
VThis code is emitted due to the /RTC compile option
p9810
aVIt initializes all local variables in your function to a bit pattern that is highly likely to generate an access violation or to cause unusual output values
p9811
aVThat helps you find out when you forgot to initialize a variable
p9812
aVThe extra space in the stack frame you see allocated is there to support the Edit + Continue feature
p9813
aVThis space will be used when you edit the function while debugging and add more local variables
p9814
aVChange the /ZI option to /Zi to disable it
p9815
as(dp9816
g9
V17034
p9817
stp9818
a((dp9819
g2
(lp9820
VYour for() loop can potentially keep a lock for a relatively long time, depending on how many elements it iterates
p9821
aVYou can get in real trouble if it "polls" the queue, constantly checking if a new element became available
p9822
aVThat makes the thread own the mutex for an unreasonably long time, giving few opportunities to the producer thread to break in and add an element
p9823
aVAnd burning lots of unnecessary CPU cycles in the process
p9824
aVYou need a "bounded blocking queue"
p9825
aVDon't write it yourself, the lock design is not trivial
p9826
aVHard to find good examples, most of it is
p9827
aVNET code
p9828
aVThis article looks promising
p9829
as(dp9830
g9
V17034
p9831
stp9832
a((dp9833
g2
(lp9834
VUsing BinaryFormatter is the easiest way to serialize an object in and out of a pipe stream
p9835
aVYou'll need to decorate the class or struct with the [Serializable] attribute
p9836
aVUsing a pipe is however a very inefficient way to "pass" data between threads
p9837
aVEvery thread in a process has access to the same garbage collected heap, no serialization is required as long as the threads run in the same AppDomain
p9838
aVYou do need to synchronize access to the object(s), use the lock statement
p9839
as(dp9840
g9
V17034
p9841
stp9842
a((dp9843
g2
(lp9844
V to solve the linker error
p9845
aVYour header file should look like this:
p9846
aVRight-click your DLL project in Solution Explorer, Properties, C/C++, Preprocessor, Preprocessor Definitions, add "BUILDING_DLL"
p9847
aVRepeat for the Release configuration
p9848
aVYou can verify that your DLL properly exports the functions with Dumpbin
p9849
aVexe /exports
p9850
aVThe __declspec(dllimport) declarator is not strictly necessary, it does however make it more efficient
p9851
aVThe __stdcall attribute is not necessary either, it does however make your DLL usuable from any language that supports calling DLL exports
p9852
as(dp9853
g9
V17034
p9854
stp9855
a((dp9856
g2
(lp9857
VA StreamReader uses FileStream to open the file
p9858
aVFileStream stores a Windows handle, returned by the CreateFile() API function
p9859
aVIt is 4 bytes on a 32-bit operating system
p9860
aVFileStream also has a byte[] buffer, it is 4096 bytes by default
p9861
aVThis buffer avoids having to call the ReadFile() API function for every single read call
p9862
aVStreamReader itself has a small buffer to make decoding the text in the file more efficient, it is 128 bytes by default
p9863
aVAnd it has some private variables to keep track of the buffer index and whether or not a BOM has been detected
p9864
aVThis all adds up to a few kilobytes
p9865
aVThe data you read with StreamReader will of course take space in your program's heap
p9866
aVThat could add up to 12 megabytes if you store every string in, say, a List
p9867
aVYou usually want to avoid that
p9868
as(dp9869
g9
V17034
p9870
stp9871
a((dp9872
g2
(lp9873
VThe implementation details are very well hidden
p9874
aVNeither Brumme's blog nor the Rotor source code give a ready answer
p9875
aVOne thing I know is that the try statement doesn't generate any code
p9876
aVThat leaves few possible approaches
p9877
aVI think it is done the same way as SEH in 64-bit Windows
p9878
aVI believe the JIT compiler generates a table of code addresses with a function pointer to an exception filter that's called when an exception is processed
p9879
aVThe throw statement invokes a stack walk that looks at the method return addresses
p9880
aVThe table maps a return address to the corresponding exception filter
p9881
aVThe exception filter decides whether the exception matches a catch clause in the method
p9882
aVAnd transfers control to the code in the catch clause
p9883
aVNotable is that the Visual Basic Catch When statement (not available in C#) is a good match with the way SEH is implemented in Windows
p9884
aVI have no proof of this nor do I know any authoritative source
p9885
aVIt is merely a likely way it could work
p9886
as(dp9887
g9
V17034
p9888
stp9889
a((dp9890
g2
(lp9891
VThe encoding (if it is actually text) is determined by the protocol
p9892
aVIf you don't have a protocol spec and you don't have the source code then, yes, you'll have to guess
p9893
as(dp9894
g9
V17034
p9895
stp9896
a((dp9897
g2
(lp9898
VI have to recommend you set the breakpoint in the source code file
p9899
aVIt is available from the Reference Source, I very strongly recommend the Mass Downloader tool to get it
p9900
aVIf you installed it to c:\u005cReferenceSource then the source code file you need will be available at c:\u005cReferenceSource\u005cdd\u005cwpf\u005csrc\u005cFrameWork\u005cSystem\u005cWindows\u005cDocuments\u005cTextEditorTyping
p9901
aVcs
p9902
aVOne of the great advantages of the reference source over decompiled source is that it contains source code comments
p9903
aVNot all of the source code is available, but very large chunks of WPF are
p9904
aVJohn Robbins' install instructions are very good
p9905
aVThe only hiccup I had was induced by previously having used the debugging symbols available from the Microsoft debug symbol server
p9906
aVI had to delete the
p9907
aVpdb files that are also available from the reference source from the symbol cache by hand
p9908
as(dp9909
g9
V17034
p9910
stp9911
a((dp9912
g2
(lp9913
VYou can always do a better job using malloc() to allocate a large chunk of memory and sub-dividing it yourself
p9914
aVMalloc() was optimized to work well in the general case and makes no assumptions whether or not you use threads or what the size of the program's allocations might be
p9915
aVWhether it is a good idea to implement your own sub-allocator is a secondary question
p9916
aVIt rarely is, explicit memory management is already hard enough
p9917
aVYou rarely need another layer of code that can screw up and crash your program without any good way to debug it
p9918
aVUnless you are writing a debug allocator
p9919
as(dp9920
g9
V17034
p9921
stp9922
a((dp9923
g2
(lp9924
VIt is only constrained by the file system
p9925
aVSeek() isn't a required function, C/C++ programmers have dealt with their fseek()'s limit of 2 gigabytes for a long time
p9926
aVLots of file access is sequential
p9927
aVThe
p9928
aVNET version is however going to work without trouble for a while though, the current Windows file system (NTFS version 6) limits the file size to 17,592,185,978,880 bytes, well south of 2^63 - 1
p9929
as(dp9930
g9
V17034
p9931
stp9932
a((dp9933
g2
(lp9934
VHmya, the fstream class is by itself already a capable wrapper class around an operating system handle for a file
p9935
aVIf you can't think of a way to add functionality to your own wrapper around fstream, take it as a hint that you don't actually need a wrapper
p9936
aVDon't wrap (or inherit) just because you can
p9937
as(dp9938
g9
V17034
p9939
stp9940
a((dp9941
g2
(lp9942
VYes, that cannot work
p9943
aVLBN_SELCHANGE is sent after the deed was done, the item is already selected
p9944
aVYou could only unselect it
p9945
aVYou can already do this without trapping the Windows message
p9946
aVHere's a silly example, it only allows selecting even numbered items:
p9947
aVAn inevitable problem is that the selection blinks when it is selected by the user and unselected by your program
p9948
aVYou should look at the CheckedListBox control if that's not desirable
p9949
as(dp9950
g9
V17034
p9951
stp9952
a((dp9953
g2
(lp9954
VJust use the SelectionColor property to change the color of the text:
p9955
aVYou can also use SelectionBackColor to change the background color
p9956
as(dp9957
g9
V17034
p9958
stp9959
a((dp9960
g2
(lp9961
VSetting the tooltip text for the icon requires Shell_NotifyIcon() with the NIM_UPDATE message, setting the NOTIFYICONDATA
p9962
aVszTip member
p9963
aVThe showstopper is that you can't find out what hWnd and uID values you need to use if you don't own the tray icon
p9964
aVWindows doesn't support enumerating tray icons
p9965
aVWhich also prevents getting the tooltip text
p9966
as(dp9967
g9
V17034
p9968
stp9969
a((dp9970
g2
(lp9971
VAgreed, this is a silly rule
p9972
aVYou could not deploy a drop-in bug fix update for a strong named assembly when you follow it
p9973
aVThere is otherwise few reasons not to make them the same if you actually have to change the [AssemblyVersion]
p9974
aVMaybe you're not supposed to use that tool when you fix bugs
p9975
aVIronic
p9976
as(dp9977
g9
V17034
p9978
stp9979
a((dp9980
g2
(lp9981
VYou could take advantage of a very obscure feature of the Decimal type
p9982
aVIts internal representation is a 96-bit number with an exponent
p9983
aVThe exponent is equal to the number of digits in the fraction, even if the fractional digits are zero
p9984
aVThus:
p9985
aVUse decimal
p9986
aVTryParse() if you need to validate the user input
p9987
as(dp9988
g9
V17034
p9989
stp9990
a((dp9991
g2
(lp9992
VThat's not possible
p9993
aVIf you need DLL exports you'll need to use the C++/CLI language
p9994
aVFor example:
p9995
aVThe class can be written in C# as well
p9996
aVThe C++/CLI compiler emits a special thunk for the export that ensures that the CLR is loaded and execution switches to managed mode
p9997
aVThis is not exactly fast
p9998
aVWriting [ComVisible(true)] code in C# is another possibility
p9999
as(dp10000
g9
V17034
p10001
stp10002
a((dp10003
g2
(lp10004
VTypeConverter
p10005
aVCreateInstance() does not change the properties of, say, the Font class
p10006
aVIt just creates a new instance of it
p10007
aVThere's no magic here, it just uses the class constructor
p10008
aVJust omit the property setter, you'll be fine
p10009
aVIf you want to prevent anybody from using Reflection to poke your private fields then you'll need to use the [ReflectionPermission] attribute
p10010
as(dp10011
g9
V17034
p10012
stp10013
a((dp10014
g2
(lp10015
VIt is visible how MSVC is getting it wrong from the debugging symbols
p10016
aVIt generates temporary names for the anonymous structs, respectively  and
p10017
aVThere is however only one vtable, it is named  and both constructors use it
p10018
aVThe different name for the vtable surely is part of the bug
p10019
aVThere are several bugs reported at connection
p10020
aVmicrosoft
p10021
aVcom that are related to anonymous types, none of which ever made it to "must-fix" status
p10022
aVNot the one you found though, afaict
p10023
aVMaybe the workaround is just too simple
p10024
as(dp10025
g9
V17034
p10026
stp10027
a((dp10028
g2
(lp10029
VYes, the default Build Action is "Resource"
p10030
aVThe
p10031
aVinf filename extension is a registered file type, it is used for plug-and-play installers
p10032
aVc:\u005cwindows\u005cinf is full of them
p10033
aVJust change the Build Action to None yourself or use a different filename extension
p10034
as(dp10035
g9
V17034
p10036
stp10037
a((dp10038
g2
(lp10039
VNo, that's not possible
p10040
aVA thread has to go idle before you can inject code into it
p10041
aVThat's done by, for example, Control
p10042
aVBeginInvoke (Windows Forms) or Dispatcher
p10043
aVBeginInvoke (WPF)
p10044
aVThese UI libraries often require code to be executed on the UI thread so they have explicit support for marshaling calls to the UI thread
p10045
aVIt is important for a thread to be in an "idle" state
p10046
aVYou would have horrible re-entrancy problems if
p10047
aVNET supported some kind of asynchronous injection method
p10048
as(dp10049
g9
V17034
p10050
stp10051
a((dp10052
g2
(lp10053
VARM Cortex cores have a flush to zero option, hard to see how you can ignore it
p10054
aVThen again, don't take business advice from a forum
p10055
aVTalk to your customers
p10056
as(dp10057
g9
V17034
p10058
stp10059
a((dp10060
g2
(lp10061
VThere are a large number of race conditions you can get with named pipes
p10062
aVYou have to deal with them in your code
p10063
aVPossibilities:
p10064
aVConnectNamedPipe() on the server side may return ERROR_PIPE_CONNECTED if the client managed to connect right after the CreateNamedPipe() call
p10065
aVJust treat it as connected
p10066
aVWaitNamedPipe on client side does not set the error if it timed out
p10067
aVAssume a timeout
p10068
aVCreateFile() on client side may return ERROR_PIPE_BUSY if another client managed to grab the pipe first, even after a successful WaitNamedPipe() call
p10069
aVGo back to WaitNamedPipe state
p10070
aVFlushFileBuffers() may return ERROR_PIPE_NOT_CONNECTED if the client already saw the message and closed the pipe
p10071
aVIgnore that
p10072
aVAn overlapped ReadFile() call may complete immediately and not return ERROR_IO_PENDING
p10073
aVConsider the read completed
p10074
aVPeekNamedPipe() may return 0 if the server has not written to the pipe yet
p10075
aVSleep(1) and repeat
p10076
as(dp10077
g9
V17034
p10078
stp10079
a((dp10080
g2
(lp10081
VThe exception you get is normal
p10082
aVOne  call can never succeed: the last one, just after the process terminates
p10083
aVYou'd normally avoid calling  again if you know the process is completed so you don't get the exception
p10084
aVHowever, you'd rarely know
p10085
aVJust catch the exception
p10086
aVOr use  instead, it will catch it for you
p10087
aVI'm guessing that you also redirect stderr and that the tool uses it to output "X"
p10088
aVThere is no way to keep output on both stderr and stdout synchronized after it is buffered and redirected
p10089
as(dp10090
g9
V17034
p10091
stp10092
a((dp10093
g2
(lp10094
VYou don't use controls for something like this
p10095
aVYou use objects in your code that represent a visible item on the screen
p10096
aVPeriodically you render an update to the screen
p10097
aVYou draw the background, then each object
p10098
aVYou add mouse hit testing to make the scene interactive to the user
p10099
aVThe main game loop calculates new object positions, implements object collision detection and game rules
p10100
as(dp10101
g9
V17034
p10102
stp10103
a((dp10104
g2
(lp10105
VYes, edit the ImageList you use for the ListView
p10106
aVLargeImageList property
p10107
aVSet its ImageSize to 250x180
p10108
as(dp10109
g9
V17034
p10110
stp10111
a((dp10112
g2
(lp10113
VBoth code snippets accomplish the same thing
p10114
aVThe big advantage of the 1st one is that there's some likelihood that you'll still be able to use it when you switch compilers
p10115
aVAnd that you don't stomp on a register that the 'C' compiler's code generator was using for another purpose
p10116
aVSomething you definitely forget to take care of in your asm snippet
p10117
as(dp10118
g9
V17034
p10119
stp10120
a((dp10121
g2
(lp10122
VAny
p10123
aVNET code, including Windows Forms, uses Unicode encoded as UTF16
p10124
aVYour problem isn't likely to be an encoding issue, that produces question marks instead of squares
p10125
aVGetting a square indicates you are using a font that is missing the required glyph to display the Japanese character
p10126
aVThe Arial Unicode MS font is available on a machine that has Office installed, it is a very complete font
p10127
aVUse the charmap
p10128
aVexe applet to find out what glyphs are supported by other fonts
p10129
aVNote that this font problem isn't likely to be an issue when your program runs on a Japanese version of Windows
p10130
aVYou can get specific language versions of Windows through an MSDN subscription
p10131
aVAt least get one for your QA staff so they can verify that everything works correctly
p10132
as(dp10133
g9
V17034
p10134
stp10135
a((dp10136
g2
(lp10137
VThis is never a real problem
p10138
aVWindows has the hard requirement that an executable is a file on disk
p10139
aVYou can't start a process otherwise
p10140
aVSince you have to write the file to disk anyway, you never have a problem extracting resources from it with an API that requires a path to a file
p10141
as(dp10142
g9
V17034
p10143
stp10144
a((dp10145
g2
(lp10146
VIt isn't a built-in feature in
p10147
aVNET
p10148
aVYou can find out from Charmap
p10149
aVexe, it displays the codepoint name in the status bar
p10150
aVIf you need that in your own program you could compile the Unicode Character Database into your app
p10151
aVBeware of copyrights
p10152
as(dp10153
g9
V17034
p10154
stp10155
a((dp10156
g2
(lp10157
VObservableCollection is not a sealed class
p10158
aVDerive your own and add a BeginUpdate and EndUpdate() method and IsUpdating property
p10159
as(dp10160
g9
V17034
p10161
stp10162
a((dp10163
g2
(lp10164
VLIBCMT is what you need for /MT, MSVCRT is what you need for /MD
p10165
aVYou are linking
p10166
aVobj and
p10167
aVlib files that were mixed, some compiled with /MT some with /MD
p10168
aVThat's not good
p10169
aVUsually it is the
p10170
aVlib files that cause the problem
p10171
aVReview their build settings and make sure their /M option is the same as your DLL project
p10172
aVAlso, beware of the trouble you can get into if the DLL was compiled with /MT
p10173
aVYou'll have major problems when the DLL returns pointers to objects that the client needs to release
p10174
aVIt can't, it doesn't use the same memory allocator
p10175
as(dp10176
g9
V17034
p10177
stp10178
a((dp10179
g2
(lp10180
VYou never mentioned the MFC Feature Pack
p10181
aVHave you taken a look at it yet
p10182
aVDownload for VS2008, included with VS2008 SP1
p10183
aVThe CDrawingManager has lots of special effects
p10184
aVIt has great support for application themes
p10185
as(dp10186
g9
V17034
p10187
stp10188
a((dp10189
g2
(lp10190
VIf it works on x86 then your P/Invoke declarations are probably wrong
p10191
aVUsing Integer where IntPtr is required, something like that
p10192
aVYou didn't post them, I can't tell
p10193
aVVisit pinvoke
p10194
aVnet to get the right ones
p10195
aVAfter seeing your edit: yes, your NMHDR declaration is wrong
p10196
aVIt must look like this:
p10197
as(dp10198
g9
V17034
p10199
stp10200
a((dp10201
g2
(lp10202
VThere's only one way to get a file into the file system cache: reading it
p10203
aVThat's a chicken-and-egg problem
p10204
aVYou can get the egg first by using a helper thread that reads files
p10205
aVIt would have to have some kind of smarts about what file is likely to be next
p10206
aVAnd not read too much
p10207
as(dp10208
g9
V17034
p10209
stp10210
a((dp10211
g2
(lp10212
VNot sure why you'd consider a TypeConverter
p10213
aVSelect the DGV in your form and click the Tasks glyph on the upper right, Edit Columns
p10214
aVSelect the column, then DefaultCellStyle on the upper right
p10215
aVClick the dots
p10216
aVSet Format to "HH:MM"
p10217
as(dp10218
g9
V17034
p10219
stp10220
a((dp10221
g2
(lp10222
VVB6 did not support exporting forms from a class library
p10223
aVThe natural mapping for converted code therefore is Friend
p10224
aVHowever, VB
p10225
aVNET has no such problems
p10226
aVUsing Public is fine, assuming any exposed types in public method arguments is Public as well
p10227
aVEasy to find, the compiler will tell you
p10228
as(dp10229
g9
V17034
p10230
stp10231
a((dp10232
g2
(lp10233
VThe
p10234
aVNET 3
p10235
aV0, 3
p10236
aV5 and 3
p10237
aV5 SP1 releases contain just additional assemblies, added to the
p10238
aVNET 2
p10239
aV0 CLR and core assemblies
p10240
aVYou can check if you have 3
p10241
aV5 dependencies by looking through the assemblies listed in the References node of your project
p10242
aVThat node is hidden in the VB
p10243
aVNET IDE, click the Show All Files icon in the Solution Explorer window to see it
p10244
aVLook at the Version property in the Properties window
p10245
aVIf it says 3
p10246
ag2512
ag2512
aV0 or 3
p10247
ag2447
ag2512
aV0 then you have a dependency on a later release of
p10248
aVNET
p10249
aVAnother trick is Project + Properties, Compile tab, scroll down, Advanced Compile Options, Target framework = 2
p10250
ag2512
aVThat will put a warning icon on references in your project that are not available in the 2
p10251
aV0 release
p10252
as(dp10253
g9
V17034
p10254
stp10255
a((dp10256
g2
(lp10257
VYou'll have to write a TypeConverter so you can override its CreateInstance() method
p10258
aVPropertyGrid is a quick solution for simple classes but gets awkward in a hurry
p10259
aVConsider that it might not be the best UI solution
p10260
aVDataGridView is well suited to editing collections
p10261
as(dp10262
g9
V17034
p10263
stp10264
a((dp10265
g2
(lp10266
VThat's really obscure, I've never seen the "threading" attribute in MIDL
p10267
aVNor have the MSDN Library authors
p10268
aVA COM coclass publishes its threading requirements in the registry, using the  key
p10269
aVThe ThreadingModel value declares the apartment it needs
p10270
aVIf it is missing or is set to "Apartment" then is announces that it needs STA
p10271
aVCoCreateObject() uses this value when it creates the object
p10272
aVIt will create a proxy if the current thread is not STA
p10273
aVWriting custom registry values is a bit awkward in
p10274
aVNET, you'd have to use the [ComRegisterFunction] attribute and take over the duties of Regasm
p10275
aVexe
p10276
as(dp10277
g9
V17034
p10278
stp10279
a((dp10280
g2
(lp10281
VKeep in mind that the string class is immutable
p10282
aVIt cannot be changed after it is created
p10283
aVThat explains why it doesn't have a parameterless constructor, it could never generate a useful string object other than an empty string
p10284
aVThat's already available in the C# language, it is ""
p10285
aVSame reasoning applies for a string(String) constructor
p10286
aVThere is no point in duplicating a string, the string you'd pass to the constructor is already a perfectly good instance of the string
p10287
aVSo fix your problem by testing for the string case:
p10288
as(dp10289
g9
V17034
p10290
stp10291
a((dp10292
g2
(lp10293
VIn C++, you'd normally explicitly call the delete operator
p10294
aVThat's not different from explicitly calling a Stop() method in C#
p10295
aVThe C++ compiler can auto-generate the delete operator call if your object is a local variable of a method
p10296
aVThat maps well to IDisposible in C# with the using statement:
p10297
aVYour thread probably doesn't stop right now because you forgot to declare the _running field as volatile
p10298
aVUsing an event can help avoid problems like that
p10299
aVYou can set the thread's IsBackground property to true to prevent the thread from hanging your program termination
p10300
aVThat's a band-aid, not a fix
p10301
as(dp10302
g9
V17034
p10303
stp10304
a((dp10305
g2
(lp10306
VThe integer division operator requires integral operands
p10307
aVTwo possible ways to do it:
p10308
aVDim x As Integer = CInt(1
p10309
aV8) \u005c 2
p10310
aVDim x As Integer = CInt(1
p10311
aV8 / 2)
p10312
as(dp10313
g9
V17034
p10314
stp10315
a((dp10316
g2
(lp10317
VIt is complaining that it has trouble locating the CRT dlls
p10318
aVFirst check that the DLL contains the required manifest
p10319
aVIn Visual Studio, File + Open + File, select the DLL and verify that it contains an RT_MANIFEST node
p10320
aVThe next problem is that you can't deploy a debug build of your DLL
p10321
aVIt will have a dependency on the debug version of the CRT, you can't get that installed on the target machine
p10322
aVEither deploy the Release build of your DLL or compile the DLL with the /MT option so the CRT is statically linked
p10323
aVProject + Properties, C/C++, Code Generation, Runtime Library
p10324
aVThis won't work if the DLL was compiled with the /clr option
p10325
as(dp10326
g9
V17034
p10327
stp10328
a((dp10329
g2
(lp10330
VIt's a classic cut-and-paste bug
p10331
aVLooks like they copied the code from ShowDialog(), it is indeed invalid to show a disabled form as a dialog
p10332
aVThe user would be stuck and can't do anything anymore
p10333
aVBut they forgot to remove the test in the Show() method
p10334
aVJust disable it after the Show() call
p10335
as(dp10336
g9
V17034
p10337
stp10338
a((dp10339
g2
(lp10340
VThis is not a managed DLL loading error, you can't see it in Fuslogvw
p10341
aVexe
p10342
aVI'd guess at an unmanaged DLL dependency for C++/CLI assembly that cannot be located
p10343
aVYou'll be able to see Windows searching for the DLL with SysInternals' ProcMon utility
p10344
as(dp10345
g9
V17034
p10346
stp10347
a((dp10348
g2
(lp10349
VIt talks to the device drivers, nobody knows better what hardware is available
p10350
aVYou can read more about in this Microsoft article
p10351
as(dp10352
g9
V17034
p10353
stp10354
a((dp10355
g2
(lp10356
VI don't think that was stated strong enough: you HAVE to lock it
p10357
aVBeware that a List is not a great collection object to do this, removing the old items costs O(n^2)
p10358
aVConsider creating a new List from the old one or using LinkedList
p10359
as(dp10360
g9
V17034
p10361
stp10362
a((dp10363
g2
(lp10364
VYou can provide your own tool strip renderer to draw the button's background the way you want them
p10365
aVThis example code gives the checked button a very visible black background:
p10366
as(dp10367
g9
V17034
p10368
stp10369
a((dp10370
g2
(lp10371
VFiles are streams, there are no shortcuts
p10372
aVYou have to read the entire file and write it back, minus the first and last line
p10373
aVHorribly inefficient of course, use a database instead
p10374
as(dp10375
g9
V17034
p10376
stp10377
a((dp10378
g2
(lp10379
VNo, the volatile keyword and the atomicity guarantee are much too weak
p10380
aVYou need a memory barrier to ensure that
p10381
aVYou can get one explicitly with the Thread
p10382
aVMemoryBarrier() method
p10383
as(dp10384
g9
V17034
p10385
stp10386
a((dp10387
g2
(lp10388
V and  was required by earlier versions of the Microsoft CRT to initialize thread-local state
p10389
aVThe  function would be an example
p10390
aVThat's been fixed, that state now gets dynamically initialized, at least since VS2005
p10391
aVUsing  no longer causes problems
p10392
as(dp10393
g9
V17034
p10394
stp10395
a((dp10396
g2
(lp10397
VDon't use LoadCursor, use LoadImage() instead
p10398
as(dp10399
g9
V17034
p10400
stp10401
a((dp10402
g2
(lp10403
VThe exception bypassed the code in MethodInfo
p10404
aVInvoke() that copies the [out] value from the stack frame back into the object array
p10405
aVThe value on the stack frame that Invoke() created behaves just like it does in your 1st snippet
p10406
aVBut that's where the similarities end
p10407
as(dp10408
g9
V17034
p10409
stp10410
a((dp10411
g2
(lp10412
VYou are re-inventing a wheel, strong naming already does this
p10413
aVTampering an assembly so that it has the right CRC32 is pretty simple
p10414
aVBreaking a strong name is not, it is cryptographically secure
p10415
as(dp10416
g9
V17034
p10417
stp10418
a((dp10419
g2
(lp10420
VLooking at the header file, the class declarations are wrapped by an #ifdef
p10421
aVTry it like this:
p10422
aVThis probably ought to be a project-level #define so other threading definitions are available as well
p10423
as(dp10424
g9
V17034
p10425
stp10426
a((dp10427
g2
(lp10428
VThere is already a protocol for the callback to abort the API call
p10429
aVFrom the docs:
p10430
aVIf an sqlite3_exec() callback returns
p10431
aVnon-zero, the sqlite3_exec() routine
p10432
aVreturns SQLITE_ABORT without invoking
p10433
aVthe callback again and without running
p10434
aVany subsequent SQL statements
p10435
aVI'd strongly recommend you use this instead of an exception
p10436
as(dp10437
g9
V17034
p10438
stp10439
a((dp10440
g2
(lp10441
VIt is a slippery slope
p10442
aVIDisposable has a contract, one that's backed-up by a finalizer
p10443
aVA finalizer is useless in your case
p10444
aVYou cannot force the client to use the using statement, only encourage him to do so
p10445
aVYou can force it with a method like this:
p10446
aVBut that tends to get a bit awkward without lamdas
p10447
aVThat said, I've used IDisposable like you did
p10448
aVThere is however a detail in your post that makes this dangerously close to an anti-pattern
p10449
aVYou mentioned that those methods can throw an exception
p10450
aVThis is not something the caller can ignore
p10451
aVHe can do three things about that:
p10452
aVDo nothing, the exception isn't recoverable
p10453
aVThe normal case
p10454
aVCalling Unlock doesn't matter
p10455
aVCatch and handle the exception
p10456
aVRestore state in his code and let the exception pass up the call chain
p10457
aVThe latter two requires the caller to explicitly write a try block
p10458
aVNow the using statement gets in the way
p10459
aVIt may well induce a client into a coma that makes him believe that your class is taking care of state and no additional work needs to be done
p10460
aVThat's almost never accurate
p10461
as(dp10462
g9
V17034
p10463
stp10464
a((dp10465
g2
(lp10466
VDo not use the GAC on your build machine, it is a deployment detail
p10467
aVVisual Studio automatically copies the DLL into build directory of your application when you reference the DLL
p10468
aVThat ensures that you'll run and debug with the expected version of the DLL
p10469
aVWhen you deploy, you've got a choice
p10470
aVYou can ship the DLL along with the application that uses it, stored in the EXE installation folder
p10471
aVNothing special is needed, the CLR can always find the DLL and you don't have to worry about strong names or versions
p10472
aVA bug fix update is deployed simply by copying the new DLL into the EXE folder
p10473
aVWhen you have several installed apps with a dependency on the DLL then deploying bug fix updates can start to get awkward
p10474
aVSince you have to copy to the DLL repeatedly, once for each app
p10475
aVAnd you can get into trouble when you update some apps but not others
p10476
aVEspecially so when there's a breaking change in the DLL interface that requires the app to be recompiled
p10477
aVThat's DLL Hell knocking, the GAC can solve that
p10478
as(dp10479
g9
V17034
p10480
stp10481
a((dp10482
g2
(lp10483
VThat's what the "sender" argument is for:
p10484
as(dp10485
g9
V17034
p10486
stp10487
a((dp10488
g2
(lp10489
VIt is not an option
p10490
aVYou'll have to P/Invoke a function in DLL that was generated by MASM or written in unmanaged C/C++, using inline assembly or intrinsics
p10491
aVOr use the C++/CLI compiler and generate mixed mode code with #pragma managed
p10492
aVBeware that you now can no longer depend on the JIT compiler generating whatever platform code is suitable for the operating system
p10493
aVUse Project + Properties, Build tab, Platform Target to force the architecture to match your unmanaged code
p10494
aVLook at CUDA for managed GPU code
p10495
as(dp10496
g9
V17034
p10497
stp10498
a((dp10499
g2
(lp10500
VYou cannot replace the window procedure of a window that is owned by another process
p10501
aVThe address of the replacement function is only valid in your process
p10502
aVIt causes an immediate bomb in the other process
p10503
aVYou would have to inject a DLL into the target process to work around this problem
p10504
aVYou can't inject DLLs written in a managed language, the CLR isn't initialized
p10505
as(dp10506
g9
V17034
p10507
stp10508
a((dp10509
g2
(lp10510
VYou are crossing a process boundary, object references are not valid in another process
p10511
aVThe DataObject class supports serializing objects to get them across the wall, it uses BinaryFormatter
p10512
aVSo, yes, you'll need to apply the [Serializable] attribute to your class and make sure your objects can de/serialize properly
p10513
as(dp10514
g9
V17034
p10515
stp10516
a((dp10517
g2
(lp10518
VThe flag only tells the shell to not display an error message
p10519
aVIt doesn't affect the UI of the process that got started
p10520
aVThe
p10521
aVNET
p10522
aVexe really did get started so ShellExecuteEx() did it's job and saw no errors
p10523
aVThat it decided to bomb afterwards and let the user know about it is not something you can easily fix
p10524
as(dp10525
g9
V17034
p10526
stp10527
a((dp10528
g2
(lp10529
VYou are on the wrong track with this
p10530
aVKeep in mind: you can't lock data, you can only block code
p10531
aVYou cannot protect the "objects" member with a locally defined mutex
p10532
aVYou need the exact same mutex in the code that alters the objects collection
p10533
aVIt must block that code when another thread is executing the call() method
p10534
aVThe mutex must be defined at least at class scope
p10535
as(dp10536
g9
V17034
p10537
stp10538
a((dp10539
g2
(lp10540
VYou can use the multimedia API in mmsystem
p10541
ag6193
aVjoyGetNumDevs() to discover joystick numbers, joyGetPos() to get the position
p10542
aVSDK docs are here
p10543
as(dp10544
g9
V17034
p10545
stp10546
a((dp10547
g2
(lp10548
VA "script" is not going to be able to do this
p10549
aVYou need a static code analyzer that traces all the method calls and detects when an object that derives from Exception is created and thrown
p10550
aVIt gets sticky when the code calls methods in the
p10551
aVNET framework, you don't have the source code for it
p10552
aVSystem
p10553
aVReflection is no help, it cannot reflect code
p10554
aVThis ultimately goes back to why exception specifications are such a bad idea
p10555
aVRedgate had a product named "Exception Hunter" to do this
p10556
aVBut they gave up on it, couldn't make it reliable enough
p10557
aVThe discontinuation announcement is here
p10558
aVDon't buy too much stock on them blaming
p10559
aVNET 4 for this
p10560
as(dp10561
g9
V17034
p10562
stp10563
a((dp10564
g2
(lp10565
VAn
p10566
aVocx contains COM coclasses that follow the OLE automation contract
p10567
aVThat contract has a well defined way to return errors to a client
p10568
aVEvery method returns an HRESULT, a code that indicates whether the method succeeded or not
p10569
aVIt is a simple integer, error codes are defined in the WinError
p10570
aVh SDK header file
p10571
aVIt also supports getting context info about the error through the IErrorInfo interface
p10572
aVThe COM interop support in the CLR ensures that a failure code is translated into a comparable Exception
p10573
aVNo such standard exists for code in C/C++ DLLs
p10574
aVIf it throws an exception at all, it is almost always something nasty like an AccessViolation
p10575
aVThe P/Invoke marshaller makes sure these exceptions are caught and translated
p10576
aVYou'll invariably get very little useful info out of such an exception beyond "it didn't work"
p10577
aVYou should let these exceptions terminate your program, you cannot meaningful recover from it
p10578
as(dp10579
g9
V17034
p10580
stp10581
a((dp10582
g2
(lp10583
VYes, you have to use KEY_WOW64_64KEY, there is no other workaround for a 32-bit process
p10584
aVCalling the Win32 API directly from Perl appears possible, judging from this web page
p10585
as(dp10586
g9
V17034
p10587
stp10588
a((dp10589
g2
(lp10590
VYes, if you compile the DLL's code with /MD (the default setting) then you have to deploy the CRT libraries to the target machine
p10591
aVIf this is just a standalone DLL without any other dependencies then it makes sense to compile with the static CRT option so you don't have to deploy the libraries
p10592
aVRight-click your DLL project, Properties, C/C++, Code Generation, Runtime Library = /MTd for the Debug configuration
p10593
aVRepeat for the Release configuration, now using /MT
p10594
aVGoogle "P/Invoke marshaling" to learn more about how unmanaged code is called from a managed program
p10595
as(dp10596
g9
V17034
p10597
stp10598
a((dp10599
g2
(lp10600
VThat's because of your (LPCWSTR) cast
p10601
aVThat just shut the compiler up, telling you that you did something wrong
p10602
aVThe string is still not a Unicode string and doesn't get converted by the cast
p10603
aVFix:
p10604
as(dp10605
g9
V17034
p10606
stp10607
a((dp10608
g2
(lp10609
VMicrosoft committed a fairly major sin when they released
p10610
aVNET 3
p10611
aV5, they changed the public interface of the WaitHandle class but did not change the [AssemblyVersion] of mscorlib
p10612
aVdll, it was left at version 2
p10613
ag2512
ag2512
ag2512
aVThe added WaitHandle method was certainly important, few programmers ever guessed the proper value for the "exitContext" argument (false)
p10614
aVBut not changing the version gave you this headache to deal with
p10615
aVThere is no good workaround, beyond avoiding using the new overload
p10616
aVOr strongly recommending your customer to re-enable Windows Update
p10617
aVTargeting a specific
p10618
aVNET framework version cannot work since they all got the same version of mscorlib
p10619
aVdll
p10620
as(dp10621
g9
V17034
p10622
stp10623
a((dp10624
g2
(lp10625
VYou are right, you must provide an object for ObjectForScripting
p10626
aVIt could be anything, as long as it has the [ComVisible(true)] attribute so it is callable from COM code
p10627
aVTo keep the script happy, you must provide a public AutoCompleteSaveForm(object) method
p10628
aVNo need to do anything
p10629
aVThe MSDN library article has a decent example
p10630
as(dp10631
g9
V17034
p10632
stp10633
a((dp10634
g2
(lp10635
VThis ought to work for you:
p10636
as(dp10637
g9
V17034
p10638
stp10639
a((dp10640
g2
(lp10641
Vfgets() can decode UTF-8 encoded files if you use Visual Studio 2005 and up
p10642
aVChange your code like this:
p10643
as(dp10644
g9
V17034
p10645
stp10646
a((dp10647
g2
(lp10648
VEric Lippert nailed it, I'll use a different way to say what he said
p10649
aVAll of the members of an interface are virtual and they all need to be overridden by a class that inherits the interface
p10650
aVYou don't explicitly write the virtual keyword in the interface declaration, nor use the override keyword in the class, they are implied
p10651
aVThe virtual keyword is implemented in
p10652
aVNET with methods and a so-called v-table, an array of method pointers
p10653
aVThe override keyword fills the v-table slot with a different method pointer, overwriting the one produced by the base class
p10654
aVProperties, events and indexers are implemented as methods under the hood
p10655
aVBut fields are not
p10656
aVInterfaces can therefore not contain fields
p10657
as(dp10658
g9
V17034
p10659
stp10660
a((dp10661
g2
(lp10662
VRespond to the WM_CTLCOLOREDIT message and use SetTextColor on the passed HDC to select the text color
p10663
as(dp10664
g9
V17034
p10665
stp10666
a((dp10667
g2
(lp10668
VIt is a very common mistake to assume that Taskmgr
p10669
aVexe is a leak detection tool
p10670
aVThe combination of the
p10671
aVNET garbage collector and the Windows heap manager is far too sophisticated to be reverse-engineered from the numbers you see in that tool
p10672
aVProof it to yourself by sending thousands of email messages
p10673
aVIf SmtpClient
p10674
aVSend() really leaks then your program will quickly crash with a OutOfMemory exception
p10675
aVGet more insight in the memory usage of a
p10676
aVNET program with Perfmon
p10677
aVexe and the performance counters in the
p10678
aVNET CLR Memory category
p10679
aVAnd a good book, like Richter's CLR via C#
p10680
as(dp10681
g9
V17034
p10682
stp10683
a((dp10684
g2
(lp10685
VThe memory layout of a struct is not discoverable in
p10686
aVNET
p10687
aVThe JIT compiler takes advantage of this, it re-orders the fields of a struct to get a more efficient layout
p10688
aVThis plays havoc with any attempt to use the struct in a way that bypasses the normal marshaling mechanisms
p10689
aVYes, Marshal
p10690
aVSiseOf() produces a size for a struct
p10691
aVBut that size is only valid after using Marshal
p10692
aVStructureToPtr()
p10693
aVA direct answer to your question: no, you can't discover the size, not even with Reflection
p10694
aVBy design
p10695
as(dp10696
g9
V17034
p10697
stp10698
a((dp10699
g2
(lp10700
VReaderWriterLock/Slim is specifically designed to help you efficiently lock in a multiple consumer/ single producer scenario
p10701
aVDoing so with the lock statement is possible, but not efficient
p10702
aVRWL/S gets the upper hand by being able to aggressively spinlock to acquire the lock
p10703
aVThat also helps you avoid lock convoys, a problem with the lock statement where a thread relinquishes its thread quantum when it cannot acquire the lock, making it fall behind because it won't be rescheduled for a while
p10704
as(dp10705
g9
V17034
p10706
stp10707
a((dp10708
g2
(lp10709
VYou will need a reference to the client's Dispatcher object so you can call Dispatcher
p10710
aVInvoke or Dispatcher
p10711
aVBeginInvoke to marshal the call to the client's UI thread
p10712
aVDo so by letting the client give you the reference you'll need either through the constructor or with a property
p10713
aVAnother way to do it is to store a reference to SynchronizationContext
p10714
aVCurrent in your class constructor
p10715
aVUse its Send or Post method
p10716
aVThat however requires the client to have WPF initialized properly (Application
p10717
aVRun must have been called) and construct your class object from its UI thread
p10718
as(dp10719
g9
V17034
p10720
stp10721
a((dp10722
g2
(lp10723
VYou are linking a
p10724
aVlib whose code was compiled with an incompatible compiler setting
p10725
aVThe problem one is Project + Properties, C/C++, Code Generation, Runtime library
p10726
aV/MD is not compatible with /MT
p10727
aVYou'll either have to rebuild the
p10728
aVlibs to match your
p10729
aVexe project setting or the other way around
p10730
as(dp10731
g9
V17034
p10732
stp10733
a((dp10734
g2
(lp10735
VThere's not enough info in the Process class to let you find out
p10736
aVYou can only get the ProcessID for the process
p10737
aVFrom there, you'd have to P/Invoke OpenProcess() to get the process handle, then IsWow64Process() to find out if it is a 32-bit process
p10738
aVCloseHandle() to close the process handle
p10739
aVNot actually sure if P/Invoke is possible in a macro
p10740
aVVisit pinvoke
p10741
aVnet to get the declarations you'll need
p10742
as(dp10743
g9
V17034
p10744
stp10745
a((dp10746
g2
(lp10747
VNo, you really did get an IEnumerable
p10748
aVIt just happens to be implemented by a class inside the System
p10749
aVLinq
p10750
aVEnumerable namespace, a private class
p10751
aVThat's unavoidable, there is no way to create an instance of an interface
p10752
aVDon't let the debugger info put you on the wrong track
p10753
as(dp10754
g9
V17034
p10755
stp10756
a((dp10757
g2
(lp10758
VA misbehaving app on the client's machine could do that
p10759
aVFindWindow() is a notoriously inaccurate API function
p10760
aVOn top of that, all VB6 windows have the same class name
p10761
aVThunder something, iirc
p10762
aVIt might be finding your window instead of the one intended, making the wrong window visible
p10763
as(dp10764
g9
V17034
p10765
stp10766
a((dp10767
g2
(lp10768
VThe kind of Windows API functions that can give you some insight in this are VirtualQueryEx() to enumerate the virtual memory sections and discover unused space, GetProcessHeaps() to find what heaps are created inside the process and HeapWalk() to discover how blocks in each heap are used
p10769
aVThis is not going to be easy, particularly HeapWalk() is a troublesome function in a running program
p10770
aVYou ought to take a look at the SysInternals' VMMap utility, it provides excellent virtual memory diagnostics
p10771
aVThe downfall with this is that it doesn't really help you solve a memory fragmentation problem
p10772
aVThere is nothing you can do to affect the way the Windows memory manager sub-allocates the virtual memory space
p10773
aVShort from not allocating memory
p10774
aVIf you are struggling now with OOM, you really ought to consider re-architecting your app
p10775
aVOr switching to a 64-bit operating system, the two hundred dollar solution
p10776
as(dp10777
g9
V17034
p10778
stp10779
a((dp10780
g2
(lp10781
VThere are three categories of Windows messages that are dispatched by the message loop and a call to Application
p10782
aVDoEvents()
p10783
aVFirst are messages that are sent with SendMessage()
p10784
aVThey are important, they need to be dispatched right away because there is some other program waiting on the result of the SendMessage() call
p10785
aVThey are not put on the message queue, Windows calls the window procedure directly
p10786
aVThen there are messages that are put on the message queue with PostMessage()
p10787
aVThey can wait, they are merely notifications
p10788
aVAll of the keyboard and mouse messages fit that category
p10789
aVThen there are the low priority messages, WM_TIMER and WM_PAINT
p10790
aVThey only get dispatched when there's nothing else to do, no SendMessage is pending and the message queue is empty
p10791
aVSounds like you got yourself into a situation where you starving Windows so badly that it can't get around to dispatching those low priority message anymore
p10792
aVProbably neither getting timer Ticks nor Paint events anymore
p10793
aVCalling DoEvents only once a second will certainly do that
p10794
aVThis is bad, your program is now affecting the operation of other programs as well
p10795
aVYou'll have to fix that
p10796
aVDo so by re-architecting your app so you no longer depend on DoEvents
p10797
as(dp10798
g9
V17034
p10799
stp10800
a((dp10801
g2
(lp10802
VYou'll have to move up the food chain if you want to be able to detect that the process exited
p10803
aVThe native CreateProcess() Win32 API can give you back a HANDLE, you can use it in the WaitForSingleObject() API to wait or test if the process has exited
p10804
aVIf you can get the PID, you can use OpenProcess() to get the HANDLE you need
p10805
aVAnother approach is to use _P_WAIT to make it a synchronous call
p10806
aVThat will require a thread
p10807
as(dp10808
g9
V17034
p10809
stp10810
a((dp10811
g2
(lp10812
VThe compiler is already smart enough to only list referenced assemblies in the final executable that are actually used
p10813
aVNo need to fiddle with assembly references or using directives
p10814
aVThe JIT compiler will only ever generate code for methods that are actually called
p10815
aVSo you will not have any machine code or compile time overhead due to code that is never used
p10816
aVYour executable image is getting referenced through a memory-mapped file by the CLR
p10817
aVRAM will only be used if actual content in the DLL is used by the CLR
p10818
aVIt depends how the IL of the methods you use is distributed through the image
p10819
aVThere are reasonable odds that since the JIT compiler never references the IL, the image data won't be paged into RAM either
p10820
aVIn other words, you'll lose some virtual memory space but won't consume a corresponding amount of RAM
p10821
aVIf your DLL is strong named and stored in a non-trusted location then the warm boot time will be slightly longer due to the larger file size
p10822
as(dp10823
g9
V17034
p10824
stp10825
a((dp10826
g2
(lp10827
VWell, you already used a magic number in the structure declaration
p10828
aVMight as well do this:
p10829
as(dp10830
g9
V17034
p10831
stp10832
a((dp10833
g2
(lp10834
VYes, the source code for Tlbimp
p10835
aVexe is available
p10836
aVDownload it from here
p10837
as(dp10838
g9
V17034
p10839
stp10840
a((dp10841
g2
(lp10842
VI seriously doubt that's the real reason it crashes
p10843
aVYou probably just didn't deploy the CRT libraries to the target machine
p10844
aVOr deployed the debug build
p10845
aVIf this is a single EXE with no DLL dependencies then solve your problem by linking the static version of the CRT
p10846
aVRight-click the project in Solution Explorer, Properties, C/C++, Code Generation, Runtime libraries, select /MTd
p10847
aVRepeat for the Release configuration, now choosing /MT
p10848
as(dp10849
g9
V17034
p10850
stp10851
a((dp10852
g2
(lp10853
VYes, a
p10854
aVlib file is merely a collection of
p10855
aVobj files
p10856
aVNothing was done with the content of the
p10857
aVobj files, the best analogy is a
p10858
aVzip archive
p10859
aVYes, you can delete the
p10860
aVobj files after creating the
p10861
aVlib since the
p10862
aVlib contains a verbatim copy of the
p10863
aVobj files
p10864
aVBeware that if you use a
p10865
aVlib to distribute your product then you'll typically have to create 4 of them
p10866
aVDebug vs Release build and the two flavors of CRT (/MT vs /MD)
p10867
as(dp10868
g9
V17034
p10869
stp10870
a((dp10871
g2
(lp10872
VThere is little reason to assume that it should be easy
p10873
aVRemoting works over TCP, HTTP and IPC channels
p10874
aVThe transport mechanisms are abstracted away so they don't get in the way of using Remoting
p10875
aVFor a TCP channel, the actual socket is managed by the TcpClientSocketHandler and TcpServerSocketHandler classes
p10876
aVThey are internal sealed classes in the
p10877
aVNET framework, you can't get to them from your own code
p10878
aVThe code in the linked post looks okay to me, it is a direct copy of the framework code
p10879
aVI'd recommend you try it
p10880
as(dp10881
g9
V17034
p10882
stp10883
a((dp10884
g2
(lp10885
VWell, you know it is possible because your browser could render them
p10886
aVOn Windows you can use the charmap
p10887
aVexe applet to discover their Unicode code points:
p10888
aV\u2660 = 0x2660
p10889
aV\u2663 = 0x2663
p10890
aV\u2665 = 0x2665
p10891
aV\u2666 = 0x2666
p10892
aVThe challenge is to get a C/C++ program to display them
p10893
aVThat's not going to be possible in any kind of non-platform specific way unless you use a cross-platform UI library like Qt or wxWidgets
p10894
aVIn a Windows GUI program you can do it like this in the WM_PAINT message handler:
p10895
as(dp10896
g9
V17034
p10897
stp10898
a((dp10899
g2
(lp10900
VSomething is messing with the file, not Visual Studio
p10901
aVUse SysInternals' Handle utility to find out what process does this
p10902
aVPop the network cable to block out co-workers with an odd sense of humor
p10903
as(dp10904
g9
V17034
p10905
stp10906
a((dp10907
g2
(lp10908
VIt can be done, you'd have to adjust the ClientSize when a row is added or removed
p10909
aVHowever, it doesn't hide the background completely once the vertical scrollbar appears and the grid height is not a divisble by the row height
p10910
aVAdd a new class to your project and paste the code shown below
p10911
aVCompile
p10912
aVDrop the new control from the top of the toolbox onto your form
p10913
as(dp10914
g9
V17034
p10915
stp10916
a((dp10917
g2
(lp10918
VIt is a bug in Reflector, it gets confused by a method that's virtual but doesn't have the "newslot" attribute and doesn't have a base class type
p10919
aVIt might be easier to see when you switch the decompiler to IL
p10920
aVThe real declaration of the finalizer, as copied from the Reference Source, is much as you'd expect it to be:
p10921
as(dp10922
g9
V17034
p10923
stp10924
a((dp10925
g2
(lp10926
VSounds like a misbehaving DllMain() in one of the implicitly linked DLLs used by your program
p10927
aVYou might get a hint from the Output window, it lists the names of the DLLs as they get loaded
p10928
aVIf it is wininet
p10929
aVdll then you've fallen into a deadlock trap with the symbol server
p10930
as(dp10931
g9
V17034
p10932
stp10933
a((dp10934
g2
(lp10935
VUse:
p10936
aVLearn more about numeric format strings from here
p10937
as(dp10938
g9
V17034
p10939
stp10940
a((dp10941
g2
(lp10942
VIt's a good question, I'm struggling to come up with a reason
p10943
aVThere's no hint in the Reference Source
p10944
aVOne possibility is that they try to avoid a problem when the class that implements the ICollection<>
p10945
aVCopyTo() method objects against copying to a start index other than 0
p10946
aVOr as a security measure, preventing the collection from messing with the array elements it should not have access to
p10947
aVAnother one is that this is a counter-measure when the collection is used in thread-unsafe manner
p10948
aVIf an item got added to the collection by another thread it will be the collection class' CopyTo() method that fails, not the Microsoft code
p10949
aVThe right person will get the service call
p10950
aVThese are not great explanations
p10951
as(dp10952
g9
V17034
p10953
stp10954
a((dp10955
g2
(lp10956
VNo you didn't get it, that file will only be present on your dev machine
p10957
aVAfter you deploy your program, the file will be embedded in your program and cannot be printed
p10958
aVYou'll have to write the code that saves the file from the resource to disk, then prints it
p10959
aVFor example:
p10960
aVGiven that you have to save the resource to a file, it probably makes more sense to simply deploy the file with your app instead of embedding it as a resource and writing it to disk over and over again
p10961
aVUse Application
p10962
aVExecutablePath to locate the file
p10963
aVTo make that work at debug time you have to copy the file to bin\u005cDebug
p10964
aVDo so by adding the file to your project with Project + Add Existing Item and setting the Copy to Output Directory property to Copy if Newer
p10965
as(dp10966
g9
V17034
p10967
stp10968
a((dp10969
g2
(lp10970
VI think you mistyped the Guid
p10971
aVIt is close to one supported by qedit
p10972
aVdll, 65BD0711-24D2-4FF7-9324-ED2E5D3ABAFA, you're off by one digit
p10973
as(dp10974
g9
V17034
p10975
stp10976
a((dp10977
g2
(lp10978
VYes, this doesn't work, the delegates are completely unrelated types
p10979
aVNormally, generic types would have only System
p10980
aVObject as the common base type
p10981
aVBut here, since they are delegates, you could store them in a
p10982
aVI doubt that's going to help you getting them unregistered though
p10983
aVBut I can't really envision what that code might look like
p10984
as(dp10985
g9
V17034
p10986
stp10987
a((dp10988
g2
(lp10989
VAs soon as you make a method virtual, you are giving a derived class a chance to break your class
p10990
aVA responsible deriver will always ask himself "should I call the base implementation
p10991
aVGuidance for this should always come from documentation
p10992
aVMSDN uses standard verbiage:
p10993
aVNotes to Inheritors:
p10994
aVWhen overriding Xxxxx in a derived
p10995
aVclass, be sure to call the base
p10996
aVclass's Xxxx method so that blablah
p10997
aVhappens
p10998
aVThe C# language makes that easy with the "base" keyword
p10999
aVWorking from the assumption that this documentation is not available or unclear, your second example would strongly discourage a deriver to call the other base class method
p11000
aVAfter all, s/he wouldn't use the standard pattern
p11001
aVUse this pattern only if you want to discourage the inheritor from calling a base class method
p11002
as(dp11003
g9
V17034
p11004
stp11005
a((dp11006
g2
(lp11007
VI don't see anything in the 7
p11008
aV0 version of the SDK that allows drawing that style
p11009
aVThe ComboBoxRenderer class doesn't pay attention to DropDownStyle at all
p11010
aVI think you're stuck
p11011
as(dp11012
g9
V17034
p11013
stp11014
a((dp11015
g2
(lp11016
VYes, the [STAThread] attribute is required on your Main() method so that COM is initialized properly to make the main thread a Single Threaded Apartment
p11017
aVThat's not all though, you will also need to pump a message loop
p11018
aVThat's a requirement for an STA
p11019
aVWithout one, WebBrowser cannot update its state or run its event handlers, you'll never get the DocumentCompleted event for example
p11020
aVYou can get a message loop with Application
p11021
aVRun()
p11022
aVYour console application is now indistinguishable from a Windows Forms application
p11023
aVIt is actually easier to get everything right by starting a new project with the Windows Forms application project template, then Project + Properties, Output type = Console Application
p11024
aVEdit the Application
p11025
aVRun() call in Program
p11026
aVcs so it doesn't create a form
p11027
aVIt won't make dealing with Application
p11028
aVRun() any easier, consider a Timer to run code
p11029
as(dp11030
g9
V17034
p11031
stp11032
a((dp11033
g2
(lp11034
VYou'll have to avoid getting in the way of regular use of the Enter key
p11035
aVThis should be close:
p11036
as(dp11037
g9
V17034
p11038
stp11039
a((dp11040
g2
(lp11041
VI'll just formally post an answer earlier left in a comment
p11042
aVYou'll need to use the DrawMode property, there's a good example of a DrawItem event handler in the MSDN Library article
p11043
aVYou can draw the text any way you like, including drawing two lines of text
p11044
aVUse a large Font or set the ItemHeight property with DrawMode = OwnerDrawVariable to give yourself enough space for two lines
p11045
as(dp11046
g9
V17034
p11047
stp11048
a((dp11049
g2
(lp11050
VYou cannot not know this if you write GUI code
p11051
aVWhich makes it likely you want to use CreateTimerQueueTimer()
p11052
as(dp11053
g9
V17034
p11054
stp11055
a((dp11056
g2
(lp11057
VYou'll need to derive your own control from TabControl so that you can intercept the arrow keys and generate an event
p11058
aVAdd a new class to your project and paste the code shown below
p11059
aVCompile
p11060
aVDrop the new control from the top of the toolbox onto your form
p11061
aVSample usage in a form:
p11062
as(dp11063
g9
V17034
p11064
stp11065
a((dp11066
g2
(lp11067
VYou are not using the command line arguments at all
p11068
aVRecode your main() method to look like this:
p11069
aVBe careful what you drop, your code rewrites the file contents
p11070
as(dp11071
g9
V17034
p11072
stp11073
a((dp11074
g2
(lp11075
VAll rows in a ListView have to be the same height
p11076
aVYou can get a tall row that fits more than one line of text by making the Font large, then using a small font in the DrawItem event handler
p11077
aVIf this is too restrictive then you should look at DataGridView or a custom 3rd party component
p11078
as(dp11079
g9
V17034
p11080
stp11081
a((dp11082
g2
(lp11083
VThere already is a very good style tool built into the VB compiler
p11084
aVIt is called Option Explicit On, put it at the top of the source code file or use Tools + Options + Project and Solutions + VB Defaults, Option Explicit = On
p11085
aVIf that wasn't turned on previously there could be a mountain of errors when you compile your code after changing that
p11086
aVIf it is clean or already turned on, consider that you are 95% close to writing clean C# code and that the language doesn't really matter anymore
p11087
as(dp11088
g9
V17034
p11089
stp11090
a((dp11091
g2
(lp11092
VYou could take a look at the source code
p11093
aVOr google "IL rewriting", it is a common technique
p11094
as(dp11095
g9
V17034
p11096
stp11097
a((dp11098
g2
(lp11099
VYes, the hotspot is determined by the content of the
p11100
aVcur file
p11101
aVThe Wikipedia article shows you this, offsets 4 and 6
p11102
aVWindows doesn't have an API to change the hotspot after the cursor is loaded
p11103
aVSimply edit the cursor in Visual Studio or any other cursor editor, specify the hot spot and save the file as a
p11104
aVcur file
p11105
as(dp11106
g9
V17034
p11107
stp11108
a((dp11109
g2
(lp11110
VNo, what you got is as good as it gets
p11111
aVThe available properties are listed here
p11112
as(dp11113
g9
V17034
p11114
stp11115
a((dp11116
g2
(lp11117
VBackgroundWorker and a window are water and fire
p11118
aVA window requires an STA thread and a message loop, neither are provided by BGW
p11119
aVCheck my answer in this thread for an alternative
p11120
as(dp11121
g9
V17034
p11122
stp11123
a((dp11124
g2
(lp11125
VYes, your expression fatally confuses the JIT optimizer
p11126
aVThe generated machine code looks like this:
p11127
aVThe bug occurs at address 41, the optimizer has concluded that value will always be null so it directly passes a null to String
p11128
aVConcat()
p11129
aVFor comparison, this is the code that's generated when JIT optimization is turned off:
p11130
aVThe code got moved, but do note that at address 5c it now uses the local variable (value) instead of null
p11131
aVYou can report this bug at connect
p11132
aVmicrosoft
p11133
aVcom
p11134
aVThe workaround is simple:
p11135
as(dp11136
g9
V17034
p11137
stp11138
a((dp11139
g2
(lp11140
VThat entirely depends on the app that reads the file
p11141
aVI certainly wouldn't do this if it is a native C/C++ app that reads it
p11142
ag3471
aVNET or Java app shouldn't have any trouble with it, short from consuming more memory
p11143
aVMIME (RFC 2045) requires no more than 76 characters on a line and "=" for padding
p11144
aVI'd suggest you use that
p11145
as(dp11146
g9
V17034
p11147
stp11148
a((dp11149
g2
(lp11150
VIt is actually available in the
p11151
aVNET framework
p11152
aVYou can get to it like this:
p11153
aVPlease don't use that
p11154
as(dp11155
g9
V17034
p11156
stp11157
a((dp11158
g2
(lp11159
VI seriously doubt that's going to work out for you
p11160
aVYou can't use an include file to jam the changes into the derived controls
p11161
aVYou'd normally make the changes in a common base class, one derived from Control for example, then derive individual controls from that base class
p11162
aVBut that's not going to work if you customized 8 separate control classes
p11163
aVCopy-and-paste is your lot
p11164
as(dp11165
g9
V17034
p11166
stp11167
a((dp11168
g2
(lp11169
VNot sure what's going on, but getting a character like % out of a keyboard hook is very untrivial
p11170
aVThe hook only notifies you of virtual keys
p11171
aVBut % is a typing key, produced by pressing Shift + 5 on my keyboard (a US layout)
p11172
aVWindows normally produces these characters by processing the WM_KEYDOWN/UP messages, generating a WM_CHAR message for the typing key
p11173
aVThat's not happening in your case
p11174
aVThe low-level Windows function that does this is ToUnicodeEx()
p11175
as(dp11176
g9
V17034
p11177
stp11178
a((dp11179
g2
(lp11180
VMenuStrip uses a custom renderer, it doesn't leave it up to Windows to draw the menu
p11181
aVYou can change the RenderMode property to System but that doesn't help, it's a pre-Win7 version of what system-drawn menus looked like
p11182
aVIf you want Windows to render the menu then you'll have to fall back to the
p11183
aVNET 1
p11184
aV1 MainMenu component
p11185
aVAnother way is to assign the Renderer property to your own custom renderer, not really practical
p11186
aVThis is also an issue with WPF, worse because it renders all the controls itself
p11187
aVWe are quickly approaching a stage where the look-and-feel of a program is determined by the UI class library, not the operating system
p11188
as(dp11189
g9
V17034
p11190
stp11191
a((dp11192
g2
(lp11193
s(dp11194
g9
V17034
p11195
stp11196
a((dp11197
g2
(lp11198
VIt sounds like your linker configuration is incorrect
p11199
aVRight-click the project, Properties, Linker, System, SubSystem setting
p11200
aVMake sure "Windows" is selected, not "Console"
p11201
as(dp11202
g9
V17034
p11203
stp11204
a((dp11205
g2
(lp11206
VIt has a wrapper for ActiveX controls, AxHost
p11207
aVBut if you mean OLE Linking and Embedding, no, that's dead technology
p11208
aVIt used to be possible with DsoFramer but that has been removed from the MSFT download site due to serious Office compatibility problems
p11209
aVYou might be able to dig up a copy somewhere
p11210
aVLong term, you should avoid this, OLE has no future
p11211
as(dp11212
g9
V17034
p11213
stp11214
a((dp11215
g2
(lp11216
VStart by looking how your form is behaving with Taskmgr
p11217
aVexe
p11218
aVClick Processes tab, View + Select columns and tick Handles, USER objects, GDI objects
p11219
aVIf any of these columns for your process keeps climbing up and up you've got a resource leak, usually by forgetting Dispose()
p11220
aVGDI being the likely one from your description
p11221
aVThe show is over when it reaches 10,000
p11222
as(dp11223
g9
V17034
p11224
stp11225
a((dp11226
g2
(lp11227
VThere are not of lot of options on Windows for DLLs that are implicitly linked to the EXE
p11228
aVShort from storing the DLL in the same folder as the EXE, you can store it in a directory that's listed on the PATH environment variable
p11229
aVOnly c:\u005cwindows\u005csystem32 is guaranteed to be listed, you can't reasonably use that folder
p11230
aVAn installer that changes the system environment would work, still not reasonable
p11231
aVThe only real option is to store the DLL in the WinSxS side-by-side cache
p11232
aVYou'll need to write a manifest so that Windows can find the DLL
p11233
aVAnd you'll need to write an installer to put the DLL in WinSxS
p11234
aVGiven the quality of the documentation, you'll need to really, really want to do that
p11235
aVIf this is only a consideration for debugging then perhaps it really isn't such a big deal to change the PATH on your dev machine
p11236
aVUse Control Panel, System applet
p11237
as(dp11238
g9
V17034
p11239
stp11240
a((dp11241
g2
(lp11242
VYes, that can be done easier:
p11243
as(dp11244
g9
V17034
p11245
stp11246
a((dp11247
g2
(lp11248
VYou cannot make this work
p11249
aVThe P/Invoke marshaller doesn't support functions that return structures
p11250
as(dp11251
g9
V17034
p11252
stp11253
a((dp11254
g2
(lp11255
VAlways check the return value of API functions
p11256
aVYou'll see that RegSetValueEx() returns 5, access denied
p11257
aVYou didn't ask for write permission
p11258
aVFix:
p11259
as(dp11260
g9
V17034
p11261
stp11262
a((dp11263
g2
(lp11264
VThis blog post explains why you can't optimize the virtual call
p11265
as(dp11266
g9
V17034
p11267
stp11268
a((dp11269
g2
(lp11270
VUsually yes, there is no need to pass the "this" reference
p11271
aVThat reference is passed in the ECX register so there is no additional stack space required
p11272
aVThe register is already set if you make the call from an instance method of the same class, there will be no savings at all
p11273
aVBut it can help relieving the pressure on a x86 CPU core when the method is in another class, x86 doesn't have a lot of registers
p11274
aVSeeing a measurable perf improvement would be exceedingly rare
p11275
aVI do religiously mark methods of a class that don't use instance members as static
p11276
aVI value the inherent contract provided by the static keyword: "this method does not mutate the object state
p11277
as(dp11278
g9
V17034
p11279
stp11280
a((dp11281
g2
(lp11282
VThe available symbol APIs are listed in this blog article
p11283
aVI think the MDbg wrappers are your best bet for managed code
p11284
aVI only tried the DIA sdk and wasn't thrilled
p11285
as(dp11286
g9
V17034
p11287
stp11288
a((dp11289
g2
(lp11290
VThere are too many verbs used in this thread, like destroyed, reclaimed, deallocated, removed
p11291
aVThat doesn't correspond well with what actually happens
p11292
aVA local variable simply ceases to be, Norwegian parrot style
p11293
aVUpon entry of a method, the CPUs stack pointer is adjusted, creating a "stack frame"
p11294
aVSimply a chunk of bytes on the stack for private use by the method
p11295
aVWhen the method returns, the stack pointer is adjusted back to its previous value
p11296
aVThe local variable values are still there, nothing was done to them
p11297
aVBut they won't last long, the next method call quickly overwrites them
p11298
as(dp11299
g9
V17034
p11300
stp11301
a((dp11302
g2
(lp11303
VThreading problems due to improper locking tend to reveal themselves under heavy load because the timing changes
p11304
aVIt isn't actually the heavy load that produces the problem, it is the changed timing due to random scheduling delays
p11305
aVYou can repro the problems without heavy loads by introducing random delays in the thread's execution
p11306
aVThis is the approach Chess uses
p11307
as(dp11308
g9
V17034
p11309
stp11310
a((dp11311
g2
(lp11312
VYou need the SetWindowsHookEx() API function, setting a WH_SHELL hook
p11313
aVThe callback gets a HSHELL_WINDOWCREATED notification when a new toplevel window is created
p11314
aVThis is a global hook, you cannot write the code for this hook in C#
p11315
aVIt requires a DLL that can be injected in a process, the CLR cannot be initialized properly to support managed code
p11316
aVYou'll need an unmanaged DLL to get the job done, this project offers one
p11317
as(dp11318
g9
V17034
p11319
stp11320
a((dp11321
g2
(lp11322
VHere's a memory map I found for the Ti-83+
p11323
aVYou can't be loading this program at address $0080, that's where ROM lives
p11324
aVIt gets loaded elsewhere
p11325
aVThat works for a while until you make a JP or CALL
p11326
aVThe CALL $0099 doesn't jump to your expected jump address, it jumps into ROM
p11327
aVThat's a quick end
p11328
aVYou need to choose a proper ORG directive in your
p11329
aVasm so it gets loaded into RAM at the expected address
p11330
aVWherever that might be
p11331
as(dp11332
g9
V17034
p11333
stp11334
a((dp11335
g2
(lp11336
VYes, the Office automation model is still the dominant way to implement out-of-process automation
p11337
aVMost of all because just about any language supports it
p11338
aVIt is not that easy to implement in
p11339
aVNET, it doesn't support out-of-process COM activation out of the box
p11340
aVStart reading here to find out how to do it with COM+
p11341
aVYes, Remoting certainly would work too if your client is a
p11342
aVNET app
p11343
aVIt isn't exactly obsolete but it has effectively been replaced by WCF
p11344
as(dp11345
g9
V17034
p11346
stp11347
a((dp11348
g2
(lp11349
VYou have to run the ActiveX control in a separate 32-bit process
p11350
aVThat's going to be difficult, it would have its own window that isn't going to be part of the UI of your 64-bit process
p11351
aVAlthough it is expressly forbidden by the SDK docs, you can try to take advantage of the Windows 3 appcompat built into the SetParent() API function
p11352
aVIt might work
p11353
aVYou'll have lots of additional trouble, communicating between processes is tricky enough (you'll need Remoting or WCF), the hard part is dealing with exceptions
p11354
aVOne process bombing with the other one surviving and never noticing that something is wrong is not going to be pretty
p11355
aVPerhaps the Platform Target option starts sounding attractive
p11356
as(dp11357
g9
V17034
p11358
stp11359
a((dp11360
g2
(lp11361
VYou didn't say how you observed the process
p11362
aVI'll assume you used Taskmgr
p11363
aVexe
p11364
aVBeware that it's default view gives very misleading values in the Memory column
p11365
aVIt shows Working set size, the amount of RAM that's being used by the process
p11366
aVThat has nothing to do with the source of your problem, running out of virtual memory space
p11367
aVThere is not much reason to assume that Windows 2008 would show the same value as XP, it has a significantly different memory manager
p11368
aVYou can see the virtual memory size as well, use View + Columns
p11369
aVThe reason your program doesn't bomb on a 64-bit operating system is because 32-bit processes have close to 4 gigabytes of addressable virtual memory
p11370
aVOn a 32-bit operating system, it needs to share the address space with the operating system and gets only 2 gigabytes
p11371
aVMore if you use the /3GB boot option
p11372
aVUse the SAX parser to avoid consuming so much memory
p11373
as(dp11374
g9
V17034
p11375
stp11376
a((dp11377
g2
(lp11378
VYou'd normally use SysInternals' Process Monitor to diagnose this problem
p11379
aVThe fact that this is a service complicates matters
p11380
aVCheck this blog post for a similar troubleshooting session
p11381
aVIt quacks like a CRL (Certification Revocation List) problem btw
p11382
aVTo disable it: Control Panel, Internet Options, Advanced tab, Security, untick "Check for publisher's certificate revocation"
p11383
as(dp11384
g9
V17034
p11385
stp11386
a((dp11387
g2
(lp11388
VThis can not possibly be correct
p11389
aVSurely you are supposed to return some kind of error code that gives the caller a chance to find out why it didn't work
p11390
as(dp11391
g9
V17034
p11392
stp11393
a((dp11394
g2
(lp11395
VI'll assume you mean Common Type System
p11396
aVThe CLR has a very capable interop engine, called the P/Invoke marshaller
p11397
aVIt is no trouble converting 'C' strings to System
p11398
aVString, it is automatic with the [DllImport] and [MarshalAs] attributes
p11399
aVNot all possible 'C' function signatures or struct declarations are compatible, you may occasionally have to marshal an IntPtr yourself with the Marshal class
p11400
aVBest thing to do is to provide an example of such a troublesome function
p11401
aVNote that if you use String^ then you are probably writing code in C++/CLI
p11402
aVYou then would be using C++ Interop to interop with legacy unmanaged code
p11403
aV[DllImport] certainly still works but is not commonly used in C++/CLI
p11404
aVC++ Interop is very powerful, much more so than the P/Invoke marshaller
p11405
aVBut with power comes a price, you have to paper over the gross incompatibility between a char* and a Unicode string yourself
p11406
aVIt isn't especially difficult with the marshal_as<> template class
p11407
as(dp11408
g9
V17034
p11409
stp11410
a((dp11411
g2
(lp11412
VYes, you can get automatic version incrementing by using * in the [AssemblyVersion] attribute
p11413
aVUnfortunately, that is rarely correct
p11414
aVWhat Microsoft should have done is give the [AssemblyFileVersion] that capability
p11415
aVThey didn't
p11416
aV[AssemblyVersion] is a very important attribute, used by the CLR to verify that the assembly that got loaded is compatible with the assembly that was used when the code was compiled
p11417
aV"Compatible" means: the assembly is going to work cleanly with the client code, no changes were made to the assembly source code that could make it fail to work correctly if the client wasn't recompiled
p11418
aVUsing that definition, a bug fix update is very compatible
p11419
aVAn update that reorganized the internal implementation of the classes in the assembly could be very compatible as well
p11420
aVChanges to publicly visible classes or members is likely to not be compatible
p11421
aVAlthough the JIT compiler is very good at detecting when the changes were grossly incompatible (like removing a previously public member)
p11422
aVUsing * in the attribute essentially means: it is always incompatible
p11423
aVEven if you didn't change any code at all, the assembly will be incompatible after it is built again
p11424
aVThat's pretty useless in most any scenario, except if you always build the assembly together with its client code
p11425
aVAnd redeploy them together
p11426
aVThat works, but then the notion of having a version number at all becomes fairly useless
p11427
aVLong story short: IMO you should manage the assembly version yourself
p11428
aVChange it when you make a breaking change in the public interface of the assembly
p11429
aVThat's certainly the approach that Microsoft takes
p11430
aVNET 2
p11431
aV0 assemblies are still marked as version 2
p11432
ag2512
ag2512
aV0 in the
p11433
aVNET 3
p11434
aV5 SP1 framework
p11435
aVEven though they are not actually compatible anymore, WaitHandle
p11436
aVWaitOne(int) got added later
p11437
aVThey did otherwise a stellar job of maintaining compatibility for the past 5 years, it couldn't have been easy
p11438
aVNote that none of this applies to [AssemblyFileVersion], auto incrementing it for every build is very appropriate
p11439
as(dp11440
g9
V17034
p11441
stp11442
a((dp11443
g2
(lp11444
VThere's no concrete class in the framework that does this
p11445
aVThere's an abstract one though, KeyedCollection
p11446
aVYou'll have to derive your own class from that one and implement the GetKeyForItem() method
p11447
aVThat's pretty easy, just return the value of the property by which you want to index
p11448
aVThat's all you need to do, but do keep an eye on ChangeItemKey()
p11449
aVYou have to do something meaningful when the property that you use as the key changes value
p11450
aVEasy enough if you ensure that the property is immutable (only has a getter)
p11451
aVBut quite awkward when you don't, the object itself now needs to have awareness of it being stored in your collection
p11452
aVIf you don't do anything about it (calling ChangeItemKey), the object gets lost in the collection, you can't find it back
p11453
aVPretty close to a leak
p11454
aVNote how Dictionary<> side-steps this problem by specifying the key value and the object separately
p11455
aVYou may still not be able to find the object back but at least it doesn't get lost by design
p11456
as(dp11457
g9
V17034
p11458
stp11459
a((dp11460
g2
(lp11461
VYou should work with colors in the HSL color space, not RGB
p11462
aVThat allows you to smoothly change the hue value from 0 (red) to 1 (violet)
p11463
aVThe System
p11464
aVDrawing
p11465
aVColor structure allows converting from RBG to HSL (GetHue etc) but not the other way
p11466
aVThe math is simple though
p11467
as(dp11468
g9
V17034
p11469
stp11470
a((dp11471
g2
(lp11472
VThere's an exception handler somewhere in your code base that is swallowing exceptions
p11473
aVLook for SetUnhandledExceptionFilter first
p11474
aVAlso: Debug + Exceptions, Win32 Exceptions, tick the Thrown checkbox
p11475
as(dp11476
g9
V17034
p11477
stp11478
a((dp11479
g2
(lp11480
VYou cannot use
p11481
aVc file in a C# project, it is a completely different language
p11482
aVForums cannot really provide you with a short-cut for basic knowledge and skills you'll need to acquire to bring this project to a good end
p11483
aVYou'll need to take the time, experiment, read a few books
p11484
as(dp11485
g9
V17034
p11486
stp11487
a((dp11488
g2
(lp11489
VYour local machine uses the RTM version, your build machine uses the SP1 version
p11490
aVIt really sounds like you don't have SP1 installed on your local machine
p11491
aVNote that both versions are obsolete, the current version is 9
p11492
ag2512
aV30729
p11493
aV4148
p11494
aVA security patch that was distributed last July
p11495
aVYou can get it from here
p11496
as(dp11497
g9
V17034
p11498
stp11499
a((dp11500
g2
(lp11501
VTaking you literally, you need to find the line numbers, even though only parts of line 1 and 4 are selected
p11502
aVDo that as follows:
p11503
as(dp11504
g9
V17034
p11505
stp11506
a((dp11507
g2
(lp11508
VA key difference is that StyleCop analyzes C# source code
p11509
aVFxCop analyzes
p11510
aVNET assemblies after they are compiled, it works for any language
p11511
aVAccordingly, StyleCop is picky about how your source code looks
p11512
aVFxCop is picky about how you use the
p11513
aVNET framework classes
p11514
aVThey complement each other
p11515
as(dp11516
g9
V17034
p11517
stp11518
a((dp11519
g2
(lp11520
VYou should think about this twice
p11521
aVYou are essentially creating a memory leak
p11522
aVEvery object created by the thread stays referenced and can't be garbage collected
p11523
aVUntil the thread ends
p11524
as(dp11525
g9
V17034
p11526
stp11527
a((dp11528
g2
(lp11529
VNo it is not
p11530
aVThe thread might just be executing the event handler while you unregister it and close the form
p11531
aVSmall odds, but not zero
p11532
aVYou have to have the thread stopped before you can close the form
p11533
aVIf you don't want to abort it, you'll have to keep the form open by canceling the FormClosing event, then let the thread's completion callback close the form
p11534
aVCheck this thread for more info
p11535
as(dp11536
g9
V17034
p11537
stp11538
a((dp11539
g2
(lp11540
VYou are trying to run this code on a 64-bit operating system
p11541
aVYour C# code will get nicely compiled to 64-bit machine code
p11542
aVBut you'll hit the wall when it tries to load a 32-bit C++/CLI assembly
p11543
aVIn the C# project, use Project + Properties, Application tab, Platform Target = x86
p11544
aVCreating a 64-bit version of your C++/CLI assembly is possible too, use Build + Configuration Manager
p11545
aVUsing Platform Target is the better solution
p11546
as(dp11547
g9
V17034
p11548
stp11549
a((dp11550
g2
(lp11551
VYes, you don't have to use the ActiveX control
p11552
aVJust use Project + Add Reference, Browse tab, select c:\u005cwindows\u005csystem32\u005cwmp
p11553
aVdll
p11554
aVBut you really do need a thread that is initialized with [STAThread] or Thread
p11555
aVSetApartmentState() and a message loop (Application
p11556
aVRun)
p11557
aVIs is required for COM servers (like wmp
p11558
aVdll) that have a Single Threaded Apartment requirement
p11559
aVCOM uses the message loop to marshal calls and generate events
p11560
aVWithout a loop, the server will deadlock
p11561
as(dp11562
g9
V17034
p11563
stp11564
a((dp11565
g2
(lp11566
VThis kind of information is always provided either through a PerformanceCounter or WMI
p11567
aVUse Perfmon
p11568
aVexe or download WmiCodeCreator to find out what the card manufacturer provided
p11569
aVPerhaps needless to say, this kind of code doesn't port well from one machine to another
p11570
as(dp11571
g9
V17034
p11572
stp11573
a((dp11574
g2
(lp11575
VIt is completely up to the client code to call your Dispose() method
p11576
aVOnly it knows when it is done using the objects
p11577
aVYou cannot help in any way because you don't know what that code will look like
p11578
aVCreating list objects that dispose their elements is not a good idea
p11579
aVThe framework contains no collection object that does this
p11580
aVYou'll just confuse the client code programmer
p11581
as(dp11582
g9
V17034
p11583
stp11584
a((dp11585
g2
(lp11586
VWell, there are ways to shoot the foot but Windows Forms rarely forgets to tell you about it
p11587
aVYes, there's something special about the "main thread"
p11588
aVIt runs in STA mode, a Single Threaded Apartment
p11589
aVIt is a mode that affects COM components, the shell dialogs like OpenFileDialog and operations like Drag + Drop and the Clipboard
p11590
aVThreads that display a UI always must be STA
p11591
aVThat's automatic in normal WF apps with the [STAThread] attribute on the Main() method
p11592
aVIn your own app you have to call Thread
p11593
aVSetApartmentState() before you start it
p11594
aVAnd the thread is special because it pumps a message loop (Application
p11595
aVRun), a requirement for STA threads
p11596
aVBy default, any Thread you start or any threadpool thread runs in MTA mode
p11597
aVThreadpool threads cannot be changed, they are always MTA
p11598
as(dp11599
g9
V17034
p11600
stp11601
a((dp11602
g2
(lp11603
VThe Windows Forms ToolTip component already is a wrapper for the native Win32 tool tip control
p11604
aVYou can write your own wrapper but you'll end up with the exact same result
p11605
aVIf you are contemplating this because you want to show more than one tooltip at a time, you probably don't want a tooltip at all
p11606
aVConsider using Labels that you make visible and hide with a timer, something like that
p11607
aVDo try to avoid confusing users with a UI that they've never seen before
p11608
as(dp11609
g9
V17034
p11610
stp11611
a((dp11612
g2
(lp11613
VThe problem is that buttons you dropped on the form before you edited the class are already being initialized by the form's InitializeComponent() call with a different color
p11614
aVIn other words, they override the default color you set in the constructor
p11615
aVWhat you have to do is declare the default value of the property so that the designer doesn't generate an assignment
p11616
aVThat should look like this:
p11617
as(dp11618
g9
V17034
p11619
stp11620
a((dp11621
g2
(lp11622
VIt is code that is produced by the Form item template (common7\u005cide\u005citemtemplates\u005ccsharp\u005cwindows forms\u005c1033\u005cform
p11623
aVzip\u005cform
p11624
aVdesigner
p11625
aVcs)
p11626
aVIt actually has a bug, the InitializeComponent() method it contains initializes the "this
p11627
aVcomponents" variable unnecessarily
p11628
aVYou can safely delete the statement from the code if your form doesn't have any components
p11629
aVThe designer will automatically put it back if you add a component later
p11630
aVAnother thing that is not so nice is that the Dispose() method is put in the Designer
p11631
aVcs file
p11632
aVIt really belongs in the form
p11633
aVcs file so you can add Dispose() calls for fields in your form that should be disposed
p11634
aVDon't hesitate to move the code yourself, modifying the designer file this way doesn't have any unpleasant side-effects
p11635
aVJust stay away from the code that's bracketed with the "generated code" region
p11636
aVAs mentioned in most other answers, this code is necessary to call the Dispose() method of any components that you've dropped on the form when the form is closed
p11637
aVControls on the form need to be disposed as well but that's automatic
p11638
aVThe Form class finds them back by iterating the Controls collection
p11639
as(dp11640
g9
V17034
p11641
stp11642
a((dp11643
g2
(lp11644
VIt is pretty simple
p11645
aVIf you can load the image before you assign it to the picture box then you've sufficiently proven that the image is valid and that the user has something to look at
p11646
aVThe GDI+ image decoders very carefully check the file contents
p11647
aVThus:
p11648
as(dp11649
g9
V17034
p11650
stp11651
a((dp11652
g2
(lp11653
VYes, it is really simple with capCreateCaptureWindow
p11654
aVThat googles really well, you'll have no trouble finding code samples
p11655
as(dp11656
g9
V17034
p11657
stp11658
a((dp11659
g2
(lp11660
VYou'll need to P/Invoke GetWindowLongPtr() to get the extended style of the window (GWL_EXSTYLE = -20) and check if the WS_EX_TOPMOST style is turned on (0x08)
p11661
aVVisit pinvoke
p11662
aVnet for the declarations
p11663
as(dp11664
g9
V17034
p11665
stp11666
a((dp11667
g2
(lp11668
VThe RGB color space is not suitable for this
p11669
aVUse HSL or HSV, it is easy to auto-generate a good looking gradient by varying an individual component
p11670
aVConverting from HSL/V to an RGB triplet you can use in the API is simple
p11671
as(dp11672
g9
V17034
p11673
stp11674
a((dp11675
g2
(lp11676
VYou'll want to create UserControls instead of a Panel, it is easy to edit in the designer
p11677
aVDock the tree view to the left and use code like this to select the active user control:
p11678
as(dp11679
g9
V17034
p11680
stp11681
a((dp11682
g2
(lp11683
VNo, but it is simple to create your own:
p11684
as(dp11685
g9
V17034
p11686
stp11687
a((dp11688
g2
(lp11689
VYes, this is possible
p11690
aVSet a breakpoint at the location where you'd want to see the value
p11691
aVRight-click the breakpoint and choose "When Hit
p11692
aVTick "Print a message" and write an expression like { value }
p11693
aVThe message is displayed in the Output window while your program runs
p11694
as(dp11695
g9
V17034
p11696
stp11697
a((dp11698
g2
(lp11699
VThe C compiler will parse the values as int
p11700
aVYou need only 5 bits for the values you've listed, it will fit comfortably in a char
p11701
aVBut a char get promoted to an int in a function call anyway, you might as well use int
p11702
as(dp11703
g9
V17034
p11704
stp11705
a((dp11706
g2
(lp11707
VAdd this line to your Main() method, before the Application
p11708
aVRun() call:
p11709
aVThis disables the ThreadExceptionDialog and trips the AppDomain
p11710
aVUnhandledException event
p11711
aVI doubt you'll get a stack trace out of Watson
p11712
aVYou'd better create your own by writing a handler for AppDomain
p11713
aVUnhandledException
p11714
as(dp11715
g9
V17034
p11716
stp11717
a((dp11718
g2
(lp11719
VGetting an image resized by PB to fit the control is very expensive
p11720
aVGDI+ has a very good filter but it doesn't come for free
p11721
aVResize the image yourself before you assign it to the Image property so the PB doesn't have to resize it
p11722
aVUsing a bitmap created with Format32bppPArgb can make a big difference too, it is 10 times faster than any other format
p11723
as(dp11724
g9
V17034
p11725
stp11726
a((dp11727
g2
(lp11728
VYes, this is a known bug in the native Windows implementation of ComboBox
p11729
aVThere's another aspect to this bug
p11730
aVPut a button on your form and give it TabIndex = 0, change the CB's TabIndex to 1
p11731
aVRun it, the button will have the focus
p11732
aVResize
p11733
aVNote that the ComboBox's text changes as before but now also gets highlighted, as though it has the focus
p11734
aVEven though it hasn't
p11735
aVI think this bug has been around since Vista, it didn't get fixed in Win7
p11736
aVThere's no known workaround for it
p11737
as(dp11738
g9
V17034
p11739
stp11740
a((dp11741
g2
(lp11742
VUnmanaged code rarely needs a lot of help from C# to start generating access violations
p11743
aVThere's nothing wrong with your P/Invoke signature, that cannot be the cause
p11744
aVThe most common source of AVs in unmanaged code is heap corruption
p11745
aVC/C++ code doesn't have a garbage collector, memory must be managed explicitly
p11746
aVNot only must it take care of releasing memory (or it will leak), it is also responsible for allocating the correct size and making sure that the code that writes to the allocated memory doesn't write past the end of the allocated memory block or writes into memory that was already freed
p11747
aVThat last requirement is where C/C++ code often fails
p11748
aVThe trouble with heap corruption is that it is extremely hard to diagnose
p11749
aVIt can go unnoticed for quite a while
p11750
aVThe typical damage done is that the internal heap structure is compromised, or the data in another heap allocation is overwritten
p11751
aVThat doesn't cause a problem until later, when the heap block is released or the overwritten data is used
p11752
aVThe code that generates the exception is not actually responsible for the damage that was done earlier
p11753
aVWhich sets you off on the wrong track trying to find the source of the problem
p11754
aVFinding the real trouble maker is very hard, you'd have only a few breadcrumbs to figure out what might have gone wrong
p11755
aVIt is very hard when you have the C/C++ source code, but running it in a debug build with a debug allocator helps
p11756
aVIt is impossible when you don't have the source code
p11757
aVUnless you can pin-point a problem with using the API from earlier calls made, you'll need help from the vendor or support group to really solve this problem
p11758
aVGood luck
p11759
as(dp11760
g9
V17034
p11761
stp11762
a((dp11763
g2
(lp11764
VIt already works this way
p11765
aVEach byte is transmitted with a non-data start bit first
p11766
aVThat lets the receiver synchronize its clock
p11767
aVAnd there's at least one stop bit, that lets the receiver verify that the baudrate is not so much off that the last transmitted data bit is unreliable
p11768
aVWith 8 data bits, that yields 10 total bits, providing 10% tolerance on the baudrate
p11769
aVBeing off more generates a framing error
p11770
aVEarly PC designs readily took advantage of this
p11771
aVThe UART's clock was generated by a cheap crystal, present in any TV set to synch the chrominance carrier off the color burst, 3
p11772
aV579545 MHz
p11773
aVThe oscillator divides it by two, the UART divides the input clock by 16, yielding 3579545 / 32 = 111861 Hz
p11774
aVThe baudrate divisor then selects the frequency, the divisor for 9600 baud is 12
p11775
aV111861 / 12 = 9322 baud, a 2
p11776
aV9% error
p11777
aVWell within the 10% tolerance
p11778
aVAlso explains why 110,000 baud was the maximum
p11779
as(dp11780
g9
V17034
p11781
stp11782
a((dp11783
g2
(lp11784
VNobody likes to see an error message
p11785
aVBut this is a special case, don't do this
p11786
aVCOM activation has always been hard to trouble-shoot
p11787
aVBut recent developments like 64-bit operating systems, registry virtualization, registry redirection and UAC has exponentially increased the number of ways it might not work
p11788
aVThe very last thing your customer's IT staff needs is another layer of code that silently changes the activation rules or suppresses diagnostic information
p11789
aVThey'll shoot you some serious flak when it doesn't work and they can't find out why
p11790
aVFirst ask yourself if your program is still useful when the interop doesn't work
p11791
aVIf it isn't then do nothing, just let the exception terminate your program but do make sure the exception details are well visible
p11792
aVIf it is still useful then simply add a config option to your program that lets it bypass the interop without even trying
p11793
as(dp11794
g9
V17034
p11795
stp11796
a((dp11797
g2
(lp11798
VYou don't need to use Marshal
p11799
aVGetFunctionPointerForDelegate(), the P/Invoke marshaller does it automatically
p11800
aVYou'll need to declare a delegate on the C# side whose signature is compatible with the function pointer declaration on the C++ side
p11801
aVFor example:
p11802
aVAnd the corresponding C++ code used to create the unmanaged DLL:
p11803
aVThat's enough to get you started with it
p11804
aVThere are a million details that can get you into trouble, you are bound to run into some of them
p11805
aVThe much more productive way to get this kind of code going is writing a wrapper in the C++/CLI language
p11806
aVThat also lets you wrap a C++ class, something you can't do with P/Invoke
p11807
aVA decent tutorial is available here
p11808
as(dp11809
g9
V17034
p11810
stp11811
a((dp11812
g2
(lp11813
VNo, they are components, not controls
p11814
aVTheir code actually lives in the shell, they were written in unmanaged C/C++ by Microsoft
p11815
aVThe only thing that's managed about them is a small wrapper that makes the necessary API calls to display them and return their result
p11816
aVOpenFileDialog for example
p11817
aVThe very first problem you'll run into is run your code when such a dialog is displayed
p11818
aVIt is a dialog, control doesn't return to your program after the ShowDialog() call until the user dismisses it
p11819
aVIt is possible with a fair amount of trickery
p11820
aVCheck my code in this thread for the approach
p11821
aVAs noted, that code will work for any shell dialog, as well as MessageBox
p11822
aVThat gets you the window handle of the dialog
p11823
aVNext, you have to iterate the child windows of the dialog
p11824
aVYou can do that with the EnumChildWindows API call
p11825
aVThat gives you the window handle of each child, you can then use SendMessage() to do something with the child
p11826
aVWhatever that might be, you didn't specify that in your question
p11827
as(dp11828
g9
V17034
p11829
stp11830
a((dp11831
g2
(lp11832
VI remember the registry key name from a previous question
p11833
aVYou had a problem creating the value
p11834
aVIn that thread, the value was created as a DWORD, 4 bytes
p11835
aVThat's too much of a coincidence
p11836
aVRun Regedit
p11837
aVexe and navigate to the key you created and check what the value type is
p11838
aVIf it is still a DWORD, you'll never get more than 4 bytes back, even if you ask for a string
p11839
aVFix the code that creates the value, make sure you create a REG_SZ, not a REG_DWORD
p11840
aVUse Regedit
p11841
aVexe to delete the old value before you run the code
p11842
as(dp11843
g9
V17034
p11844
stp11845
a((dp11846
g2
(lp11847
VThis is available soon, currently shipping in Visual Studio 2010 beta 2
p11848
aVHere's a video of the tool
p11849
as(dp11850
g9
V17034
p11851
stp11852
a((dp11853
g2
(lp11854
VI saw this question coming from your previous thread
p11855
aVTo mis-quote the great Jamie Zawinski: "Some people, when confronted with a problem, think "I know, I'll use an attribute
p11856
aVNow they have two problems"
p11857
aVAn attribute is merely out-of-band data, compiled into an assembly's metadata
p11858
aVIt cannot affect program execution or tool behavior, unless the program or the tool is explicitly programmed to recognize the specific attribute
p11859
aVIt needs to do so using Reflection
p11860
aVWhat you need to do is write your own tool
p11861
aVIt should execute after an assembly is built, using the Post-Build step for a project
p11862
aVIt needs to load the assembly and use Reflection to iterate the types in the assembly
p11863
aVFor each type, iterate the methods with Type
p11864
aVGetMethods() and use MethodInfo
p11865
aVGetCustomAttributes() to discover and construct an attribute that might have been programmed
p11866
aVYou can use Type
p11867
aVGetInterfaces() to discover which interfaces are implemented by the type
p11868
aVYou can now complain when you see that a method is present that implements an interface method but is missing an attribute that says so
p11869
aVAnd your ultimate goal: you can complain when you see a method with an attribute that says it implements an interface method but the type no longer inherits it
p11870
aVUse Environment
p11871
aVExitCode to make the tool fail the build if you see anything objectionable
p11872
aVThis takes care of enforcement
p11873
aVBtw: programmers really hate to break the build
p11874
aVThat might well encourage them to use the attribute religiously
p11875
aVOr it might encourage them to edit the post build step
p11876
as(dp11877
g9
V17034
p11878
stp11879
a((dp11880
g2
(lp11881
VThe structure will marshal without help or need for the unsafe keyword if you declare it like this:
p11882
aVConvert the void* to the structure with Marshal
p11883
aVPtrToStructure()
p11884
as(dp11885
g9
V17034
p11886
stp11887
a((dp11888
g2
(lp11889
VUse the FormClosing event
p11890
aVThe MSDN Library article is here
p11891
aVPoke around a bit more, these are the kind of events you need to know pat to do any kind of Windows Forms programming
p11892
as(dp11893
g9
V17034
p11894
stp11895
a((dp11896
g2
(lp11897
VWell, it really is ServicePipeTimeout that controls the timeout
p11898
aVWhat isn't clear is when this timeout timer starts ticking
p11899
aVThe fact that your OnStart() doesn't get called would indicate that it starts when the SCM creates the process
p11900
aVThe next mental leap that can be made is that the 30 second timeout still applies to the process start time, regardless of the registry value
p11901
aVThe box is in really poor shape if the
p11902
aVNET cold start time is longer than 30 seconds
p11903
aVCold start time is dominated by hard disk performance, roughly 85% of the time is spent locating and loading DLLs
p11904
aVNormally
p11905
aVIt's sorta possible if the box never had its hard disk defragmented and you've recently installed
p11906
aVNET on it
p11907
aVThat would cause the clusters of the
p11908
aVNET files to be scattered all over the disk, requiring many read head moves
p11909
aVThis can dramatically reduce data throughput, as low as a kilobyte per second if every cluster is on a different track
p11910
aVFixing this could be as simple as defragging the drive
p11911
aVAsk questions about that at superuser
p11912
aVcom
p11913
as(dp11914
g9
V17034
p11915
stp11916
a((dp11917
g2
(lp11918
VKernel32
p11919
aVdll exports the function as "CreateProcessA", note the missing leading underscore
p11920
aVThe only way to convince the linker to use that export is by linking kernel32
p11921
aVlib, an import library supplied by the Windows SDK
p11922
aVYou'll then run into the next problem, the import library declares the export as
p11923
aVThis is a name decoration applied by the __stdcall calling convention
p11924
aVThat calling convention was explicitly designed to catch your mistake, you didn't declare the function properly
p11925
aVThe @40 part of the name indicates the number of bytes needed in the stack frame to pass the arguments
p11926
aVSo, to make it work you should  to get the proper function declaration and link kernel32
p11927
aVlib to get the proper export name
p11928
as(dp11929
g9
V17034
p11930
stp11931
a((dp11932
g2
(lp11933
VYou cannot target 1
p11934
aV1 with VS2008 so scratch that option
p11935
aVThere are no real differences between 2
p11936
aV0, 3
p11937
aV0 and 3
p11938
aV5, they all use the same version of the CLR
p11939
aVVersions 3
p11940
aV0 and 3
p11941
aV5 just added more assemblies
p11942
aVNotably those that support WPF, WCF and Linq
p11943
aVIf you are not interested in using these new features then targeting 2
p11944
aV0 will work just fine
p11945
aVAnd your program will run without problems if the target machine has any version of
p11946
aVNET equal or greater than 2
p11947
aV0 installed
p11948
aVFinding out that you might accidentally uses a class that's only available in a later version is easy enough, you simply can't add the assembly reference when you use Project + Add Reference
p11949
aVThe later ones will be grayed out in the list
p11950
aVIt is also well documented in the MSDN Library, the framework version the class is available in is listed at the bottom of the page
p11951
aVYet one more option: if you have a lot of customers still on XP that don't have
p11952
aVNET installed yet then you might want to consider checking the "Client-only Framework subset"
p11953
aVThis cuts down the assemblies you can reference to the core ones, the associated Client Framework install is a very lean 28 MB
p11954
as(dp11955
g9
V17034
p11956
stp11957
a((dp11958
g2
(lp11959
VYour question is missing essential details, it isn't at all clear whether the memory allocated by the C++ code needs to be released on the C# side
p11960
aVThat's normally done automatically with, say, the P/Invoke marshaller or the COM interop layer in the CLR
p11961
aVOr can be done manually by declaring a method argument as IntPtr, then use of the Marshal class
p11962
aVIf it is done automatically you must use the COM memory allocator, CoTaskMemAlloc()
p11963
aVIf you marshal yourself you could also use GlobalAlloc(), release on the C# side with Marshal
p11964
aVFreeHGlobal()
p11965
aVThere isn't any advantage to using GlobalAlloc(), you might as well use CoTaskMemAlloc() and release with Marshal
p11966
aVFreeCoTaskMem()
p11967
aVBut you should have noticed this yourself
p11968
aVAllocating with malloc() or HeapAlloc() on the C++ side causes leaks instead of corruption if the managed code releases the memory
p11969
aVVista and Win7 have a much stricter heap manager, it terminates the program if it notices a bad release
p11970
aVIt sounds to me that you have simple heap corruption in your C++ code
p11971
aVThat is the most common scourge of unmanaged C++ programming, over-running the end of a buffer, writing to memory that's been freed, bad pointer values
p11972
aVThe way to get rid of bugs like these is a careful code review and use of a debug allocator, such as the one provided by
p11973
aVGood luck with it
p11974
as(dp11975
g9
V17034
p11976
stp11977
a((dp11978
g2
(lp11979
VPut double quotes around the value so that it is obvious to Excel that it is a string and not a number in scientific notation
p11980
as(dp11981
g9
V17034
p11982
stp11983
a((dp11984
g2
(lp11985
VLooks like a Zebra label printer, I've had the displeasure
p11986
aVThe first thing you need to fix is the way you generate the print
p11987
aVtxt file
p11988
aVYou'll need to write one line for each section of the command string that's terminated with \u005cr
p11989
aVFor example, your command string should be written like this:
p11990
aVNow you can use ReadLine() when you read the label from print
p11991
aVtxt
p11992
aVYou'll need to read multiple lines to get the complete label
p11993
aVI added a blank line at the end, you could use that when you read the file to detect that you got all the lines that creates the label
p11994
aVDon't forget to append "\u005cr" again when you send it to the printer
p11995
as(dp11996
g9
V17034
p11997
stp11998
a((dp11999
g2
(lp12000
VYour DecryptBytes() method is broken
p12001
aVYou are not using the return value of csDecrypt
p12002
aVRead(), it tells you have many bytes were decrypted
p12003
aVThat will not be the same as fromEncrypt
p12004
aVLength
p12005
aVYou'd also have a very hard time guessing how large a byte array to pass to this function
p12006
aVConsider changing the function to return a MemoryStream
p12007
aVCall Read() in a loop and write what was read to the memory stream
p12008
aVExit the loop when Read() returns 0
p12009
as(dp12010
g9
V17034
p12011
stp12012
a((dp12013
g2
(lp12014
VIf performance really matters then the fastest way to do it is by using the CRT library included with every version of Windows
p12015
aVThis code takes ~51 msec on my poky laptop, works on 64-bit machines too:
p12016
as(dp12017
g9
V17034
p12018
stp12019
a((dp12020
g2
(lp12021
VMake the copy constructor and the assignment operator private as well
p12022
aVJust the declaration is enough, you don't have to provide an implementation
p12023
as(dp12024
g9
V17034
p12025
stp12026
a((dp12027
g2
(lp12028
VNo, WPT leverages windows events, it would only help you diagnose a problem when Windows is the cause of your slow-down
p12029
aVYou certainly won't get any diagnostics for your code
p12030
aVWhat you need is a real profiler
p12031
aVGood ones cost money
p12032
aVCheck this thread for more advice
p12033
as(dp12034
g9
V17034
p12035
stp12036
a((dp12037
g2
(lp12038
VYou can't, it is drawn with the color that the user selected in her preferred theme, selected in Control Panel's Display applet
p12039
aVOverriding the user preference is risky, but you can do so by drawing it yourself
p12040
aVSet the DGV's BorderStyle property to None and draw a border yourself in the form's OnPaintBackground() method
p12041
aVFor example:
p12042
as(dp12043
g9
V17034
p12044
stp12045
a((dp12046
g2
(lp12047
VThe value of S_OK is 0, that's why your if() statement doesn't execute
p12048
aVYou should use the SUCCEEDED macro:
p12049
as(dp12050
g9
V17034
p12051
stp12052
a((dp12053
g2
(lp12054
VYes, the VB
p12055
aVNET data types are not compatible with the VB6 ones
p12056
aVA VB6 Integer is now a Short (aka Int16)
p12057
aVA VB6 Long is now an Integer (aka Int32)
p12058
aVA VB6 Boolean was an odd duck, now equivalent to Short where the value True is -1 and False is 0
p12059
aVStart by changing Long in the function declaration to Integer, that's the Big One
p12060
as(dp12061
g9
V17034
p12062
stp12063
a((dp12064
g2
(lp12065
VYou'll need to write an event handler for the AppDomain
p12066
aVUnhandledException event
p12067
aVLogging the e
p12068
aVExceptionObject
p12069
aVToString() value is almost always good enough, the stack trace tells you how the code got into trouble
p12070
aVP/Invoking MiniDumpWriteDump() from dbghelp
p12071
aVdll is possible too, you'd get a
p12072
aVdmp file that you could use to analyze the exception with WinDbug
p12073
aVDbghelp
p12074
aVdll is available on Vista and Win7, you can get it from the Debugging Tools for Windows download for earlier versions
p12075
aVHowever, you can't get good managed stack traces from that minidump, not until VS2010 ships
p12076
as(dp12077
g9
V17034
p12078
stp12079
a((dp12080
g2
(lp12081
VIt is a bug
p12082
aVThere are lots of bugs in the ToolStripItem classes, they were not fixed when the time was right (some time after the
p12083
aVNET 2
p12084
aV0 release), now it is too late
p12085
aVPosting these bugs to the Connect feedback site isn't useful, they'll just tell you to visit the MSDN forums to find a workaround
p12086
aVI think you already got one
p12087
aVFwiw, here's one that matches your case
p12088
as(dp12089
g9
V17034
p12090
stp12091
a((dp12092
g2
(lp12093
VThe "string" return value is the problem
p12094
aVThe P/Invoke marshaller is going to call CoTaskMemFree() on the pointer you return
p12095
aVThat's not going to work well unless you used CoTaskMemAlloc() in your C/C++ code to allocate the string buffer
p12096
aVWhich is a fairly unusual thing to do
p12097
aVThe best solution is to allow the caller of your code to pass a pointer to a buffer and the buffer length to you as arguments
p12098
aVThat way all memory allocation happens on one side
p12099
aVScott showed you how to do this
p12100
as(dp12101
g9
V17034
p12102
stp12103
a((dp12104
g2
(lp12105
VInvalidateRect() already does this
p12106
aVAnother way is RedrawWindow() with the RDW_NOCHILDREN option
p12107
as(dp12108
g9
V17034
p12109
stp12110
a((dp12111
g2
(lp12112
VCheck out Detours from Microsoft Research
p12113
aVIt allows you to detour arbitrary Windows API functions
p12114
aVC/C++ programming is required to make it work though
p12115
aVYou won't need much
p12116
as(dp12117
g9
V17034
p12118
stp12119
a((dp12120
g2
(lp12121
VYou will have to use P/Invoke to make this work
p12122
aVYou'll find example code in this thread
p12123
aVIt is for a ListBox, it will also work for ListView
p12124
aVUse pinvoke
p12125
aVnet to find the C# declaration for SendMessage
p12126
aVI'm not aware of a fix for the scroll increment
p12127
aVThe SetScrollInfo API function doesn't allow setting the small step increment
p12128
as(dp12129
g9
V17034
p12130
stp12131
a((dp12132
g2
(lp12133
VYes, that folder has the "read only" attribute set
p12134
aVThis would work:
p12135
aVYou should always pay attention to the file attributes when you delete stuff
p12136
aVBe sure to stay clear from anything that is System or ReparsePoint
p12137
aVAnd careful with ReadOnly and Hidden
p12138
as(dp12139
g9
V17034
p12140
stp12141
a((dp12142
g2
(lp12143
VYes, it is very well hidden
p12144
aVDouble-click the
p12145
aVrc file in Solution Explorer to open the Resource View window
p12146
aVExpand the String Table node, right-click "String Table" and select "Insert Copy"
p12147
aVThat takes you to the language selection combo
p12148
as(dp12149
g9
V17034
p12150
stp12151
a((dp12152
g2
(lp12153
VCheck the docs for WideCharToMultiByte()
p12154
aVCP_ACP converts using the current system code page
p12155
aVThat's a very lossy one
p12156
aVYou want CP_UTF8
p12157
as(dp12158
g9
V17034
p12159
stp12160
a((dp12161
g2
(lp12162
VThe underlying Windows API that makes FileSystemWatcher work is ReadDirectoryChangesW()
p12163
aVNote the 2nd argument, lpBuffer
p12164
aVThat's a one-to-one match with the internal buffer whose size you can set with the InternalBufferSize property
p12165
aVA buffer is required because Windows cannot easily run user code in response to directory changes
p12166
aVThese changes are detected by the respective file system drivers, they run in kernel mode
p12167
aVRunning user mode code requires an expensive mode switch and a thread context switch, much too expensive to do so for each individual detected change
p12168
aVThe buffer is there to collect changes, waiting for the user mode code to start running and empty the buffer
p12169
aVThere's a well documented failure mode for FSW, there could be too many changes to keep up with
p12170
aVYou'd see the Error event in managed code
p12171
aVIncreasing the buffer size can help, a lot, the default buffer is rather small at 4096 bytes
p12172
aVMaking it arbitrary large is not a good idea though, buffer space is also required in the kernel and that's taken from the kernel memory pool
p12173
aVThat's a limited resource, gobbling large amounts from the pool affects all programs running on the machine
p12174
as(dp12175
g9
V17034
p12176
stp12177
a((dp12178
g2
(lp12179
VThat bit of magic is created by inheriting and implementing the IExtenderProvider interface
p12180
aVIt is pretty easy to do, the designer is doing all the heavy lifting
p12181
aVThere's a very good How To in this MSDN Library article
p12182
as(dp12183
g9
V17034
p12184
stp12185
a((dp12186
g2
(lp12187
VYour loop is causing deadlock, the BGWs cannot complete
p12188
aVThe problem is the RunWorkerCompleted event, it is raised on the UI thread
p12189
aVThat bit of BGW magic requires the UI thread to be idle, it must be pumping its message loop
p12190
aVProblem is, the UI thread is not idle and it isn't pumping messages, it is stuck in the for loop
p12191
aVThus, the event handler cannot run and IsBusy stays true
p12192
aVYou'll need to do this differently
p12193
aVLeverage the RunWorkerCompleted event to run the code that you'd normally run after this for loop
p12194
aVResist all temptation to call Application
p12195
aVDoEvents() inside the loop
p12196
as(dp12197
g9
V17034
p12198
stp12199
a((dp12200
g2
(lp12201
VI don't really see what role the COM object plays in this
p12202
aVBut, no, there isn't anything that makes MMFs fundamentally incompatible with managed code
p12203
aVThey are merely very awkward to use since you need pointers to access them
p12204
aVSupport for MMFs is coming in
p12205
aVNET 4
p12206
ag2512
aVIt is probably too soon to use that in production code
p12207
aVBut do make sure to take a look at the API so that what you do now is going to fit the API well when you switch
p12208
as(dp12209
g9
V17034
p12210
stp12211
a((dp12212
g2
(lp12213
VThere are two pixel formats for 16-bit color, 555 and 565
p12214
aVYou'd have to mask the R, G and B values with 0xf8 (5 bits) and 0xfc (6 bits) before comparing them
p12215
aVDo keep in mind that the machine on which you run the designer is not representative for the machine on which your program runs
p12216
as(dp12217
g9
V17034
p12218
stp12219
a((dp12220
g2
(lp12221
VHmm, that's very odd
p12222
aVHave you actually written this form yet
p12223
aVThe Form class is extremely insistent that its Size can never be larger than the screen
p12224
aVI've never found a workaround for this and have never seen one posted in a WF related forum
p12225
aVAnyhoo, you can't make a screen shot because you don't have enough screen
p12226
aVThe only other option is Control
p12227
aVDrawToBitmap()
p12228
aVSeveral thousands of pixels" is liable to get you into trouble with OutOfMemory exceptions on 32-bit operating systems when you try to create the bitmap
p12229
aVNot because you don't have enough memory but because there isn't an empty hole left in the virtual memory address space that is large enough to fit the bitmap  The only good workaround for that is a 64-bit operating system
p12230
as(dp12231
g9
V17034
p12232
stp12233
a((dp12234
g2
(lp12235
VOdd, I like C++/CLI but you listed exactly its features I dislike
p12236
aVMy criticisms:
p12237
aVOkay
p12238
aVBut accidental use of the hat is pretty widespread, getting the value of the value type boxed without warning
p12239
aVThere is no way to diagnose this mistake
p12240
aVPower that comes at a high price, templates you write are not usable in any other
p12241
aVNET language
p12242
aVIf anything, it worsens the C++ template export problem
p12243
aVThe complete failure of STL/CLR is worth pondering too
p12244
aVErm, no
p12245
aVThis was IMO a serious mistake
p12246
aVIt already is difficult to avoid problems with accidental boxing, as outlined in the first bullet
p12247
aVStack semantics makes it seriously difficult for any starting programmer to sort this out
p12248
aVThis was a design decision to placate C++ programmers, that's okay, but the using statement was a better solution
p12249
aVNot sure how it is easier
p12250
aVThe GC
p12251
aVSuppressFinalize() call is automatic, that's all
p12252
aVIt is very rare for anybody to write a finalizer, but you can't avoid the auto-generated code from making the call
p12253
aVThat's inefficient and a violation of the 'you don't pay for what you don't use' principle
p12254
aVAdd to this that writing the destructor also forces a default finalizer to be auto-generated
p12255
aVOne you'd never use and wouldn't want to be used if you forgot or omitted to use the destructor
p12256
aVWell, that's all very subjective perhaps
p12257
aVThe death-knell will come with VS2010, it will ship without IntelliSense support for C++/CLI
p12258
as(dp12259
g9
V17034
p12260
stp12261
a((dp12262
g2
(lp12263
VThe 2nd snippet is probably cheaper
p12264
aVThe lambda doesn't have to capture the value of the cursor argument
p12265
aVThey are otherwise functionally the same
p12266
aVTry not to sweat the small stuff
p12267
as(dp12268
g9
V17034
p12269
stp12270
a((dp12271
g2
(lp12272
VThis works, but it has an unpleasant side-effect on the taskbar button
p12273
aVI can't think of another way, animation isn't even accessible from SystemParametersInfo()
p12274
aVUpdate: disabling animation on Aero is possible by pinvoking DwmSetWindowAttribute() with the DWMWA_TRANSITIONS_FORCEDISABLED attribute
p12275
aVSee this answer
p12276
as(dp12277
g9
V17034
p12278
stp12279
a((dp12280
g2
(lp12281
VIt is TreeViewItem
p12282
as(dp12283
g9
V17034
p12284
stp12285
a((dp12286
g2
(lp12287
VThis goes back to early CPU designs
p12288
aVThe fastest way to crunch through the bits of the bitmap is by reading them 32-bits at a time, starting at the start of a scan line
p12289
aVThat works best when the first byte of the scan line is aligned on a 32-bit address boundary
p12290
aVIn other words, an address that's a multiple of 4
p12291
aVOn early CPUs, having that first byte mis-aligned would cost extra CPU cycles to read two 32-bit words from RAM and shuffle the bytes to create the 32-bit value
p12292
aVEnsuring each scan line starts at an aligned address (automatic if the stride is a multiple of 4) avoids that
p12293
aVThis isn't a real concern anymore on modern CPUs, now alignment to the cache line boundary is much more important
p12294
aVNevertheless, the multiple of 4 requirement for stride stuck around for appcompat reasons
p12295
aVBtw, you can easily calculate the stride from the format and width with this:
p12296
as(dp12297
g9
V17034
p12298
stp12299
a((dp12300
g2
(lp12301
VBy far the simplest way is to just create a new instance of the form and close the old one
p12302
aVThat requires a little bit of surgery if this is the main form of your app, closing it would terminate the program
p12303
aVStart by opening Program
p12304
aVcs and edit it so it looks like this:
p12305
aVThe ApplicationContext variable now controls the lifetime of the app, instead of the Form1 instance
p12306
aVYou can recreate the form with code like this in Form1:
p12307
as(dp12308
g9
V17034
p12309
stp12310
a((dp12311
g2
(lp12312
VCopy and paste this into your class:
p12313
aVThe [Browsable] attribute hides the property in the Properties window
p12314
aVThe [EditorBrowsable] attribute hides it from IntelliSense
p12315
as(dp12316
g9
V17034
p12317
stp12318
a((dp12319
g2
(lp12320
VI guess I better post the answer instead of leaving it in the comment: did you implement the Error event
p12321
aVWhen you do get errors, bump up the value of the InternalBufferSize property
p12322
aVTry 16384
p12323
as(dp12324
g9
V17034
p12325
stp12326
a((dp12327
g2
(lp12328
VYes, this is a problem with COM components having non-COM dependencies
p12329
aVWindows doesn't consider the location of the COM DLL when it searches for dependent DLLs
p12330
aVThe normal search rules are in effect, the folder that contains the EXE first, Windows directories, current working directory, PATH environment
p12331
aVThe location of the COM server does not play a role
p12332
aVAssuming you don't want to deploy to the EXE folder, none of these are good places to store your DLL, although plenty of installers made the desperation move of storing it in c:\u005cwindows\u005csystem32 or modify the system PATH environment variable
p12333
aVOne thing you could do is P/Invoke SetDllDirectory() in your C# code before running any code in the DLL
p12334
aVUsing Assembly
p12335
aVGetExecutingAssembly()
p12336
aVLocation will do it
p12337
aVThat is however not a safe thing to do though, it might alter the search rules for the app that uses your component
p12338
aVThe only real fix is to install the DLL in the Windows side-by-side cache (WinSxS) and to include a manifest in your C# executable
p12339
aVGiven the state of the documentation, I can only wish you the best of luck
p12340
as(dp12341
g9
V17034
p12342
stp12343
a((dp12344
g2
(lp12345
VI think you're doing battle with the Visual Studio hosting process
p12346
aVIt is a helper
p12347
aVexe that hosts the CLR to improve the debugging experience, it is always running while you've got a project loaded into VS
p12348
aVProject + Properties, Debug tab, scroll down, uncheck the "Enable the Visual Studio hosting process" checkbox
p12349
aVThis does affect the debugging session somewhat, most notable is that the output written by Console
p12350
aVWriteLine() in your program no longer shows up in the Output window
p12351
aVSome obscure security options, not at all well documented
p12352
aVI doubt you'll have a problem
p12353
as(dp12354
g9
V17034
p12355
stp12356
a((dp12357
g2
(lp12358
VFile
p12359
aVCreateFile, through StreamWriter, ends up calling the FileStream constructor passing FileMode
p12360
aVCreate, FileAccess
p12361
aVWrite and FileShare
p12362
aVRead
p12363
aVThat's a very normal way to create, access and share files
p12364
aVYou certainly would want write access since you just created the file
p12365
aVAnd it is sorta okay for other processes to read the file while you are writing it, nothing really bad happens when they do
p12366
aVWhat you are asking for is possible, but you can't use File
p12367
aVCreateFile()
p12368
aVYou'll have to first create a FileStream (Create, Write and FileShared
p12369
aVReadWrite), and pass that to the StreamWriter constructor
p12370
aVNow the file can be written both by you and another process
p12371
aVWhich is rather tricky, suppose you and some other process both write to the file at the same time
p12372
aVThat's first-come, first serve, the file will end up containing your program output, randomly mixed with the other process' output
p12373
aVIt isn't very likely that the file will be readable after that happened
p12374
aVMaybe you want to do something like intentionally not writing to the file yourself so this doesn't happen
p12375
aVIt is very unusual, but it could be made to work
p12376
aVThe bigger problem then would be for that other process to detect that the file is even there
p12377
aVEverything would probably work better if you just leave it up to the other process to create the file
p12378
as(dp12379
g9
V17034
p12380
stp12381
a((dp12382
g2
(lp12383
VThat's not possible, exceptions are local to a thread first, local to a process secondary if it is unhandled
p12384
aVAn unhandled exception will terminate the process
p12385
aVThe only shrapnel you could pick up from such a dead process is the process exit code
p12386
aVWhich should be set to 0xe0434f4e, the exception code for an unmanaged exception
p12387
aVNo other relevant info is available, unless there's an unhandled exception handler in the process that logs state
p12388
aVThat state is very unreliable, the process suffered a major heart attack
p12389
aVKeeping multiple processes in synch and running properly when they may die from exceptions is extraordinarily difficult
p12390
aVOnly death can be detect reliably, avoid doing more
p12391
as(dp12392
g9
V17034
p12393
stp12394
a((dp12395
g2
(lp12396
VYou could just copy the file with Explorer
p12397
aVOr better yet, start refactoring your projects so that you'll create assemblies that are usable by multiple client projects
p12398
as(dp12399
g9
V17034
p12400
stp12401
a((dp12402
g2
(lp12403
VThere's invariably a dedicated FPU instruction that gets the job done, cvttsd2si if the code generator uses the Intel SSE2 instruction set
p12404
aVThat's fast, but not as fast as a static cast
p12405
aVThat doesn't usually require any code at all
p12406
as(dp12407
g9
V17034
p12408
stp12409
a((dp12410
g2
(lp12411
VUse the Bitmap
p12412
aVMakeTransparent() method on the images when you load them
p12413
aVYou'll need to select the color that's the background color for those images
p12414
aVStoring the images in the PNG format with the transparency selected in the graphics editor would be another way
p12415
as(dp12416
g9
V17034
p12417
stp12418
a((dp12419
g2
(lp12420
VAre you 100% sure this code runs in the Load event
p12421
aVUsing the Handle property ensures that the control window is created and that it will automatically scale to adjust to the machine's video adapter and system font settings
p12422
aVThat should never be necessary if the code actually runs due to the Load event, all Handles of all controls will have been created by then
p12423
aVNote that AutoResizeColumnHeadersHeight() is actually for manual resizing, it only works once
p12424
aVAlthough it automatically calculates the height
p12425
aVTo get automatic resizing, set the ColumnHeadersHeightSizeMode property to AutoSize
p12426
as(dp12427
g9
V17034
p12428
stp12429
a((dp12430
g2
(lp12431
VMaybe it will help if you stop thinking about it being an installer but consider it a configuration utility
p12432
aVThat needs an installer before it can run
p12433
aVJust create a regular Setup project for it, one that automatically launches the utility after it is installed
p12434
aVCheck this thread for an example on how to do that
p12435
as(dp12436
g9
V17034
p12437
stp12438
a((dp12439
g2
(lp12440
VIf you need this keyboard hook only to detect hot keys then you should not use a hook
p12441
aVWindows supports hot keys with the RegisterHotKey() API function
p12442
aVCheck my code sample in this thread to see how to use it
p12443
aVThere's a C# sample further down the page
p12444
as(dp12445
g9
V17034
p12446
stp12447
a((dp12448
g2
(lp12449
VIt is not actually a COM error, it is a Windows error, wrapped in a COM error code
p12450
aVIt is a very low-level error, little can be distilled from the error code or the stack trace
p12451
aVThere are plenty of hits when you Google the message, here's one that looks good
p12452
aVBe sure to find more yourself if that's not a good match
p12453
as(dp12454
g9
V17034
p12455
stp12456
a((dp12457
g2
(lp12458
VThis is most likely a DLL that has a dependency on the C Runtime Library (CRT)
p12459
aVYou need to make sure to deploy the Release build of the DLL, the debug version of the CRT libraries cannot be distributed
p12460
aVIf you compiled with the /MD option, you will also need to deploy the CRT DLLs to the target machine
p12461
aVCompiling with /MT avoids that but this option is not available if you use managed code in your DLL
p12462
as(dp12463
g9
V17034
p12464
stp12465
a((dp12466
g2
(lp12467
VIn Visual Studio, use Tools + Attach to Process and select your program
p12468
aVIf necessary, use Debug + Windows + Threads to select a thread
p12469
aVDebug + Break All, look at the call stack to see where it is deadlocked
p12470
as(dp12471
g9
V17034
p12472
stp12473
a((dp12474
g2
(lp12475
VClearly the InitializeComponent() method isn't running properly anymore
p12476
aVNot sure why of course
p12477
aVPerhaps the better approach is to turn the form in a control:
p12478
as(dp12479
g9
V17034
p12480
stp12481
a((dp12482
g2
(lp12483
VIt is a side-effect of the Visual Basic syntax, a new-line terminates a statement
p12484
aVThat makes a multi-line comment pretty incompatible with the basic way the compiler parses the language
p12485
aVNot an issue in the curly brace languages, new-lines are just white space
p12486
aVIt has never been a real problem, Visual Basic has had strong IDE support for a very long time
p12487
aVCommenting out multiple lines is an IDE feature, Edit + Advanced + Comment Selection
p12488
as(dp12489
g9
V17034
p12490
stp12491
a((dp12492
g2
(lp12493
VLooks to me you've created an O(n^2) algorithm
p12494
aVYou are searching for the interval, that's O(n), then probably apply it n times
p12495
aVYou'll get a quick and cheap speed-up by taking advantage of the fact that the items are already ordered in the list
p12496
aVUse BinarySearch(), that's O(log(n))
p12497
aVIf still necessary, you should be able to do something speedier with the outer loop, what ever interval you found previously should make it easier to find the next one
p12498
aVBut that code isn't in your snippet
p12499
as(dp12500
g9
V17034
p12501
stp12502
a((dp12503
g2
(lp12504
VThe default implementation of the designer already takes care of the BindingNavigator and  DataGridView properties
p12505
aVThe property grid uses a combobox to let you select the control that matches the control type
p12506
aVYou'd have to drop, say, a BindingNavigatorQ1 control on the form to get anything other than None in the combobox
p12507
aVThe Type property is a tougher, you'll need at least a TypeConverter to convert between the Type value and a string
p12508
aVNot so sure this ought to be a designable property, the type you want to bind to surely doesn't yet exist at design time, only at runtime when all the assemblies are compiled
p12509
as(dp12510
g9
V17034
p12511
stp12512
a((dp12513
g2
(lp12514
VClearly your COM server hasn't been properly registered
p12515
aVOnce difference for a service is that it usually runs under a different account
p12516
aVUse Regedit
p12517
aVexe and make sure the registration is present in HKLM\u005cSoftware\u005cClasses\u005cCLSID and not in HKCU
p12518
aVReregister, this time make sure that you are running Regsvr32
p12519
aVexe in a administrator account with UAC turned off
p12520
as(dp12521
g9
V17034
p12522
stp12523
a((dp12524
g2
(lp12525
VYour GetMyObject() method is bad, it returns a pointer to a local variable
p12526
aVThat will only work by accident, never for any language that wraps COM
p12527
aVFix (minus error handling):
p12528
aVNot sure if __uuidof() is available in Builder, use whatever you got to get the IID of the interface
p12529
as(dp12530
g9
V17034
p12531
stp12532
a((dp12533
g2
(lp12534
VThe usual cop-out is to leave it up to the client code to guess the best number of buckets up front
p12535
aVThat's serviceable, the client usually has a reasonable guess as to how many elements will end up in the table
p12536
aVIf you want to do it automatically then you first have to declare an array of primes for bucket sizes
p12537
aVWhen you see the load factor of a bucket getting too high, pick the next prime in the array, recreate the bucket list and move the elements from the old buckets to the new table
p12538
as(dp12539
g9
V17034
p12540
stp12541
a((dp12542
g2
(lp12543
VYour code snippet got mangled exactly at the critical point, where you assign e
p12544
aVHasMorePages
p12545
aVThere's one glaring problem in your code: you need to implement a BeginPrint event handler to reset the page counter back to 0
p12546
as(dp12547
g9
V17034
p12548
stp12549
a((dp12550
g2
(lp12551
VThere are a large number of possible failure modes for OpenFileDialog
p12552
aVUsing one exposes your app to just about any shell extension that's installed on your machine
p12553
aVMany of which can be very destabilizing, it isn't that likely that the extension author has checked if it works properly in a WPF process
p12554
aVTackle this problem by running SysInternals' AutoRuns utility
p12555
aVClick the Explorer tab and look for the groups that have "ShellEx" in their name
p12556
aVUncheck anything that wasn't published by Microsoft
p12557
aVReboot and check if the problem is solved
p12558
as(dp12559
g9
V17034
p12560
stp12561
a((dp12562
g2
(lp12563
VThis is something to fret about
p12564
aVThe compiler has detected that code in the base class may run
p12565
aVIt won't be pure a virtual method, it knows how to filter those
p12566
aVMaybe a constructor or a destructor
p12567
aVThe failure mode is that the memory layout of the class object might not be the same in the client code vs the DLL
p12568
aVThe runtime mayhem this causes is very hard to diagnose
p12569
aVYou'll be okay if as long as you can guarantee that both the client and the DLL are compiled with the exact same compile and link settings, using the exact same versions of the CRT and those tools
p12570
aVYou can make the base class guaranteed abstract by using the non-standard __interface keyword instead of class
p12571
as(dp12572
g9
V17034
p12573
stp12574
a((dp12575
g2
(lp12576
VWell, you know for a fact that the file actually did get created, otherwise File
p12577
aVCopy() throws an exception
p12578
aVAnd File
p12579
aVCopy() never deletes the source file, like File
p12580
aVMove() does
p12581
aVThe simplest explanation is that the file is just getting created in a folder that you didn't expect
p12582
aVWhich is common if  is not an absolute path
p12583
aVThis commonly happens when you've used OpenFileDialog with its RestoreDirectory property set to false
p12584
aVFor example
p12585
aVAvoid this by always using absolute paths
p12586
aVEnvironment
p12587
aVGetFolderPath() is your friend
p12588
as(dp12589
g9
V17034
p12590
stp12591
a((dp12592
g2
(lp12593
VThe source code for this class, with comments, is available from the Reference Source
p12594
aVI never had any luck getting the source server to work reliably,  I strongly recommend the NetMassDownloader to get it
p12595
aVHalf an hour of babysitting and you're set
p12596
aVBe sure to read John Robbins' usage notes in his blog
p12597
as(dp12598
g9
V17034
p12599
stp12600
a((dp12601
g2
(lp12602
VGiven the "P" prefix, it looks like the real declaration is
p12603
aVwhere DEV_INFO is a structure
p12604
aVYou'll need to find the declaration of this structure and add it to your C# code with the [StructLayout] attribute
p12605
aVYou'd then declare the function like this in your C# code:
p12606
aVand use Marshal
p12607
aVPtrToStructure() to obtain the structure value
p12608
aVHopefully you don't have to free the structure, you'd be screwed
p12609
aVA second interpretation is that "pid" returns an array of pointers to DEV_INFO structures
p12610
aVSomewhat likely given the "n" argument, which could well mean the number of elements in the array you pass to be filled by the function
p12611
aVIn that case, pass an IntPtr[] and set "n" to its Length
p12612
as(dp12613
g9
V17034
p12614
stp12615
a((dp12616
g2
(lp12617
VJust two calls
p12618
aVYou need CLSIDFromProgID() to map the argument you normally pass to CreateObject to a CLSID
p12619
aVWhich you can then use in CoCreateInstance()
p12620
as(dp12621
g9
V17034
p12622
stp12623
a((dp12624
g2
(lp12625
VThey are instructions that have no effect, like a NOP, but take more bytes
p12626
aVUseful to get code aligned to a cache line boundary
p12627
aVAn instruction like lea edi,[edi+0] is an example, it would take 7 NOPs to fill the same number of bytes but takes only 1 cycle instead of 7
p12628
as(dp12629
g9
V17034
p12630
stp12631
a((dp12632
g2
(lp12633
VIt is both
p12634
aVThe fact that you're running MMC makes it hard for
p12635
aVNET to resolve assemblies, it isn't going to find any in c:\u005cwindows\u005csystem32
p12636
aVYou can't reasonably solve this with a
p12637
aVconfig file for MMC, it is going to muck with any future plug-ins
p12638
aVCOM doesn't help either, the directory in which you placed the COM DLL does not in any way affect the probing path
p12639
aVYou already found one way to solve this, AssemblyResolve
p12640
aVOr you could put everything in the GAC
p12641
aVOr you could avoid using COM and write MMC plug-ins directly with the Microsoft
p12642
aVManagementConsole namespace
p12643
as(dp12644
g9
V17034
p12645
stp12646
a((dp12647
g2
(lp12648
VYou could use GetUserDefaultLCID() instead
p12649
aVThat's a number, you can compare it with the value produced by the MAKELCID macro
p12650
as(dp12651
g9
V17034
p12652
stp12653
a((dp12654
g2
(lp12655
VIt is the JIT compiler that directs the loading of assemblies, in response to translating IL to machine code
p12656
aVType method calls are at first translated to call a stub function
p12657
aVWhen called, this stub activates the JIT compiler to load the IL (which loads the assembly if necessary) and translate it
p12658
aVVery much on-demand
p12659
aVOne wrinkle in this process are assemblies that were run through Ngen
p12660
aVexe, all the
p12661
aVNET framework assemblies were when they were installed on the machine
p12662
aVThis is detected when an assembly is first loaded
p12663
aVThe JIT compiler then skips the translation step and uses the pre-translated machine code as-is
p12664
aVWhile this will load all of the machine code produced by an assembly, it is still on-demand
p12665
aVThe term "load" is relative here, Windows uses a memory mapped file to map the native image into the virtual memory space
p12666
aVNo actual bytes are read from the file until code execution arrives at a memory page that hasn't been mapped into RAM yet
p12667
aVThe technical term for this is "page fault", it is visible in Taskmgr
p12668
aVexe
p12669
as(dp12670
g9
V17034
p12671
stp12672
a((dp12673
g2
(lp12674
VUse CreateProcessAsUser()
p12675
aVDetails are in the linked SDK docs
p12676
as(dp12677
g9
V17034
p12678
stp12679
a((dp12680
g2
(lp12681
VYes, the TabControl component works this way
p12682
aVAll you have to do is hide the tabs
p12683
aVAdd a new class to your project and paste the code shown below
p12684
aVCompile
p12685
aVDrop the new control from the top of the toolbox onto your form
p12686
aVThe tabs are still visible at design time, makes it easy to edit the pages
p12687
aVBut hidden at runtime
p12688
aVUse the SelectedTab or SelectedIndex property to select the view
p12689
as(dp12690
g9
V17034
p12691
stp12692
a((dp12693
g2
(lp12694
VThe x86 instruction set is in no way representative anymore for what is really being done by the CPU
p12695
aVThe instructions are translated to an internal machine language, the term "micro-op" was coined back in the 486 days
p12696
aVThrow in stuff like register renaming, speculative execution, multiple execution units and their interaction with the cache and there's just no way to predict how long something should take anymore
p12697
aVChip manufacturers have stopped posting cycle time predictions a long time ago
p12698
aVTheir designs are a trade secret
p12699
as(dp12700
g9
V17034
p12701
stp12702
a((dp12703
g2
(lp12704
VIt is easy to go back and forth from a font to a string and back with the System
p12705
aVDrawing
p12706
aVFontConverter class
p12707
aVFor example:
p12708
as(dp12709
g9
V17034
p12710
stp12711
a((dp12712
g2
(lp12713
VNo, that's not really a best practice
p12714
aVThe intention of a user control is to compose a new control with its own behavior
p12715
aVYou should at most have "several" properties, methods and events that are public and allows a form to interact with the new control
p12716
aVIf you find that the only good way to work with it is by exposing its constituent controls that you're better off not using a UserControl but just place the controls on the form directly
p12717
as(dp12718
g9
V17034
p12719
stp12720
a((dp12721
g2
(lp12722
VYou would normally handle the MouseClick event to detect the click and call the ContextMenuStrip
p12723
aVShow() method:
p12724
aVBut that doesn't actually work properly, the CMS won't close when you click outside of it
p12725
aVNot sure why, probably a mouse capture problem
p12726
aVThis is however known to work properly, I discovered it quite a while ago and nobody reported a problem with it yet
p12727
aVSet the NFI's ContextMenuStrip property and implement the MouseUp event like this:
p12728
as(dp12729
g9
V17034
p12730
stp12731
a((dp12732
g2
(lp12733
VSend the EM_SCROLLCARET message
p12734
aVPosition the caret first, GetWindowTextLength() and EM_SETSEL
p12735
as(dp12736
g9
V17034
p12737
stp12738
a((dp12739
g2
(lp12740
VThis is an exception generated by the CLR when it detects that the garbage collected heap is corrupted
p12741
aVThe most typical source of this kind of corruption is unmanaged code writing to, say, a managed array and overflowing the array boundary
p12742
aVIf you have no idea what unmanaged code might be doing this then you're in for a pretty rough ride debugging this
p12743
aVFwiw, virus scanners are pretty notorious for this, especially products from Symantec
p12744
as(dp12745
g9
V17034
p12746
stp12747
a((dp12748
g2
(lp12749
VIf you don't need to insert elements often then a vector will be more efficient
p12750
aVIt has much better CPU cache locality than a list
p12751
aVIn other words, accessing one element makes it very likely that the next element is present in the cache and can be retrieved without having to read slow RAM
p12752
as(dp12753
g9
V17034
p12754
stp12755
a((dp12756
g2
(lp12757
VSomething is leaking somewhere
p12758
aVStart by assuming it is your program
p12759
aVYou can observe its handle usage with Taskmgr
p12760
aVexe, Processes tab, View + Select columns and tick Handles, GDI objects and USER objects
p12761
aVObserve these numbers while your app is running
p12762
aVIf they climb steadily then you're leaking handles in your code
p12763
aVThe show is over once a column reaches 10,000
p12764
aVA more obscure explanation is running out of space in the kernel memory pool
p12765
aVAlso visible in Taskmgr from the Performance tab
p12766
as(dp12767
g9
V17034
p12768
stp12769
a((dp12770
g2
(lp12771
VIt is just simpler
p12772
aVIL is a heckofalot easier to parse than C# source code
p12773
aVAnd it is language agnostic
p12774
as(dp12775
g9
V17034
p12776
stp12777
a((dp12778
g2
(lp12779
VThe last remaining database project templates were removed in VS2008
p12780
aVNobody writes code like this in C++ anymore
p12781
aVC# and VB
p12782
aVNET, their IDEs have very good dbase integration through the server explorer window
p12783
aVGive it a try, you'll find it easy going
p12784
as(dp12785
g9
V17034
p12786
stp12787
a((dp12788
g2
(lp12789
VBe careful for behavior of c_str()
p12790
aVThe char* it returns is temporary, it will become invalid after the string is modified or destructed
p12791
aVWhich may well happen before the _postData is used, possibly as soon as setPostData() returns
p12792
aVYou'll need to copy it
p12793
aVThe next problem is that c_str() doesn't return a LPCWSTR, it is a LPCSTR
p12794
aVA cast cannot convert it, that produces Chinese
p12795
aVYou'll need to convert it to a Unicode string with for example MultiByteToWideChar()
p12796
as(dp12797
g9
V17034
p12798
stp12799
a((dp12800
g2
(lp12801
VSleep cannot hang
p12802
aVWatch out for debugger behavior, it tends to put the green arrow on the next statement if it doesn't have any source code for the active code
p12803
aVSeeing a pipe call hang would be quite normal
p12804
aVAfter Debug + Break All, be sure to scroll the stack trace up to frames in the operating system code
p12805
as(dp12806
g9
V17034
p12807
stp12808
a((dp12809
g2
(lp12810
VEven if there was any locking in Dictionary (there isn't), it could not affect your measurements since each thread is using a separate one
p12811
aVRunning this test 10,000 times is not enough to get reliable timing data, ContainsKey() only takes 20 nanoseconds or so
p12812
aVYou'll need at least several million times to avoid scheduling artifacts
p12813
as(dp12814
g9
V17034
p12815
stp12816
a((dp12817
g2
(lp12818
VTelnet
p12819
aVexe cannot be redirected
p12820
aVThe probable reason is that it acts like a terminal, emulating a VT100
p12821
aVOne hint of that you see when you start it, it clears the screen
p12822
aVThat's only possible if a program directly writes to the console screen buffer
p12823
aVThere is no known way to make it behave otherwise, the set term command doesn't have a non-terminal mode option
p12824
as(dp12825
g9
V17034
p12826
stp12827
a((dp12828
g2
(lp12829
VWell, yes, there's no reason to wait for the delegate to execute to get the proper return value
p12830
aVFix:
p12831
aVAnd it's okay to let the OutputStringToUserInterface() execute asynchronously, assuming you don't call ThreadFunction() so often that it floods the UI thread with requests
p12832
aVIf your real code actually depends on a return value from a function that must run on the UI thread then, no, you can't make it faster
p12833
aVClearly, that's something you really want to avoid
p12834
as(dp12835
g9
V17034
p12836
stp12837
a((dp12838
g2
(lp12839
VIf this DLL is really, really old (back when char was still unsigned) then it could be returning strings
p12840
aVThat's pretty unlikely though, just declare them as out byte:
p12841
aVWhere "noidea" presumably is void or some kind of int error code
p12842
aVAnother thing to fret about is the DllImport
p12843
aVCallingConvention property, it could be Cdecl
p12844
aVUse that when you get a MDA warning about a stack imbalance
p12845
aVAnd don't forget to set your project's Platform Target to x86 or it will bomb on 64-bit operating systems
p12846
as(dp12847
g9
V17034
p12848
stp12849
a((dp12850
g2
(lp12851
VJudging from available source code (Rotor), the System
p12852
aVString(Char*) constructor uses a heavily optimized code path through CtorCharPtr(), it allocates the string with FastAllocateString()
p12853
aVMarshal
p12854
aVPtrToStringUni() follows an entirely different code path, it is written in C++ and looks to be copying the string twice, without the benefit of a "fast allocator"
p12855
aVClearly, not the same programmer worked on this
p12856
aVAlmost certainly not even the same team since the code fits a different programming model
p12857
aVThe closest manager in common was probably four levels up
p12858
aVNot sure how that would be helpful, use the fast one
p12859
aVMishaps would generate a similar kind of exception on Windows
p12860
as(dp12861
g9
V17034
p12862
stp12863
a((dp12864
g2
(lp12865
VYou have to Invoke() so you can wait for the function to return and obtain its return value
p12866
aVYou'll also need another delegate type
p12867
aVThis ought to work:
p12868
as(dp12869
g9
V17034
p12870
stp12871
a((dp12872
g2
(lp12873
VI have to say, this doesn't sound good
p12874
aVThe extremely small subset of computer users that would be capable of correctly entering a regex should probably also be trusted to interpret the exception message correctly
p12875
aVTrying to validate their entry and getting it wrong would be sufficient grounds for them to get pretty flipping mad and uninstall your program
p12876
aVIf experienced programmers are not actually your target customer, be sure to avoid regex
p12877
as(dp12878
g9
V17034
p12879
stp12880
a((dp12881
g2
(lp12882
VThis doesn't look like more than just a missed opportunity in the compiler to suppress the cast
p12883
aVIt will work if you write it like this:
p12884
aVwhich suggests that it gets too conservative because casts can throw exceptions
p12885
aVHowever, it does work when you cast to the non-generic ICollection
p12886
aVI'd conclude that they simply overlooked it
p12887
aVThere's a bigger optimization issue at work here, the JIT compiler doesn't apply the loop invariant hoisting optimization
p12888
aVIt should have re-written the code like this:
p12889
aVWhich is a standard optimization in the C/C++ code generator for example
p12890
aVStill, the JIT optimizer can't burn a lot of cycles on the kind of analysis required to discover such possible optimizations
p12891
aVThe happy angle on this is that optimized managed code is still quite debuggable
p12892
aVAnd that there still is a role for the C# programmer to write performant code
p12893
as(dp12894
g9
V17034
p12895
stp12896
a((dp12897
g2
(lp12898
VA lambda can cleanly solve this:
p12899
aVHowever, lambdas that can call a Sub won't be available until VS2010
p12900
as(dp12901
g9
V17034
p12902
stp12903
a((dp12904
g2
(lp12905
VIt is no different for WebBrowser from Internet Explorer
p12906
aVOnce an app can obtain the window handle for WB, it can use LresultFromObject() to get access to the Accessibility interface, the one used by screen readers
p12907
aVI've seen this used to get an IHmtlDocument2 interface pointer, providing access to the DOM
p12908
aVOf course, once an app gains enough privilege to do this, there will be many other ways to accomplish the same
p12909
aVFocus on securing IE first, WebBrowser will follow suit since it is simply IE without the frame window
p12910
as(dp12911
g9
V17034
p12912
stp12913
a((dp12914
g2
(lp12915
VThat's because you don't need the DLL
p12916
aVAn enum assignment gets compiled to its numeric value, there is no reference the type in the IL
p12917
aVFor example, this:
p12918
aVgets compiled to this:
p12919
aVThe compiler automatically filters out "using" directives for assemblies that are not actually used
p12920
aVApparently you've found a wrinkle in this, it is very important that you put details like this in your question
p12921
aVYes, binary serialization will put a type reference in the serialized data, something the compiler cannot see
p12922
aVThe only workaround for this is to ensure the assembly gets copied into the build directory
p12923
aVProject + Add Existing Item, navigate to the DLL
p12924
aVSelect it in the Solution Explorer window, set the Copy to Output Directory property to "Copy if Newer"
p12925
as(dp12926
g9
V17034
p12927
stp12928
a((dp12929
g2
(lp12930
VPlace anywhere:
p12931
as(dp12932
g9
V17034
p12933
stp12934
a((dp12935
g2
(lp12936
VAny exception thrown while a drag+drop is in progress is swallowed by a catch all handler in DoDragDrop
p12937
aVYou can see the first-chance exception in the Output window but that's all
p12938
aVTo get the debugger to stop use Debug + Exceptions, tick the Thrown checkbox on CLR exceptions
p12939
as(dp12940
g9
V17034
p12941
stp12942
a((dp12943
g2
(lp12944
VYes, use the Mutex class
p12945
aVYou'll want the Mutex(bool, string, out bool) constructor, the last "createdNew" argument tells you if the mutex wasn't created yet
p12946
aVPrefix the name of the mutex with "global\u005c" if you want to be able to detect that any version of the program is running in any session (including services and remote logins)
p12947
as(dp12948
g9
V17034
p12949
stp12950
a((dp12951
g2
(lp12952
VA message loop is a small piece of code that exists in any native Windows program
p12953
aVIt roughly looks like this:
p12954
aVThe GetMessage() Win32 API retrieves a message from Windows
p12955
aVYour program typically spends 99
p12956
aV99% of its time there, waiting for Windows to tell it something interesting happened
p12957
aVTranslateMessage() is a helper function that translates keyboard messages
p12958
aVDispatchMessage() ensures that the window procedure is called with the message
p12959
aVEvery GUI enabled
p12960
aVNET program has a message loop, it is started by Application
p12961
aVRun()
p12962
aVThe relevance of a message loop to Office is related to COM
p12963
aVOffice programs are COM-enabled programs, that's how the Microsoft
p12964
aVOffice
p12965
aVInterop classes work
p12966
aVCOM takes care of threading on behalf of a COM coclass, it ensures that calls made on a COM interface are always made from the correct thread
p12967
aVMost COM classes have a registry key in the registry that declares their ThreadingModel, by far the most common ones (including Office) use "Apartment"
p12968
aVWhich means that the only safe way to call an interface method is by making the call from the same thread that created the class object
p12969
aVOr to put it another way: by far most COM classes are not thread-safe
p12970
aVEvery COM enabled thread belongs to a COM apartment
p12971
aVThere are two kinds, Single Threaded Apartments (STA) and a Multi Thread Apartment (MTA)
p12972
aVAn apartment threaded COM class must be created on an STA thread
p12973
aVYou can see this back in
p12974
aVNET programs, the entry point of the UI thread of a Windows Forms or WPF program has the [STAThread] attribute
p12975
aVThe apartment model for other threads is set by the Thread
p12976
aVSetApartmentState() method
p12977
aVLarge parts of Windows plumbing won't work correctly if the UI thread is not STA
p12978
aVNotably Drag+Drop, the clipboard, Windows dialogs like OpenFileDialog
p12979
aVAnd any ActiveX control and most COM servers, like Office
p12980
aVA hard requirement for an STA thread is that it should never block and must pump a message loop
p12981
aVThe message loop is important because that's what COM uses to marshal an interface method call from one thread to another
p12982
aVAlthough
p12983
aVNET makes marshaling calls easy (Control
p12984
aVBeginInvoke or Dispatcher
p12985
aVBeginInvoke for example), it is actually a very tricky thing to do
p12986
aVThe thread that executes the call must be in a well-known state
p12987
aVYou can't just arbitrarily interrupt a thread and force it to make a method call, that would cause horrible re-entrancy problems
p12988
aVA thread should be "idle", not busy executing any code that is mutating the state of the program
p12989
aVPerhaps you can see where that leads: yes, when a program is executing the message loop, it is idle
p12990
aVThe actual marshaling takes place through a hidden window that COM creates, it uses PostMessage to have the window procedure of that window execute code
p12991
aVOn the STA thread
p12992
aVThe message loop ensures that this code runs
p12993
as(dp12994
g9
V17034
p12995
stp12996
a((dp12997
g2
(lp12998
VNo, Windows Forms makes this explicitly very difficult to do
p12999
aVIt uses the add and remove accessors of the event, storing the event handler delegate in a list
p13000
aVThe only documented way to remove the handler from that list is to use RemoveHandler, providing the exact same AddressOf argument
p13001
aVPoking the list is technically possible with Reflection, you'll need to first find the secret "cookie" that's used to identify the event in the list
p13002
aVYou'll need to use Reflector or the Reference Source to find the name of the cookie
p13003
aVReview this forum post for a possible reason why MenuItem causes leaks
p13004
as(dp13005
g9
V17034
p13006
stp13007
a((dp13008
g2
(lp13009
VThere's only really one place in the
p13010
aVNET framework where you have to know IL, the classes in the System
p13011
aVReflection
p13012
aVEmit namespace
p13013
aVIt lets you generate code on the fly, that can be useful in select cases
p13014
aVThe best way to get exposure to IL is through the Ildasm
p13015
aVexe tool, Reflector could work too
p13016
aVA very convenient way to run it is by adding it to the Tools menu
p13017
aVTools + External Tools, Add
p13018
aVTitle = Ildasm
p13019
aVCommand = c:\u005cProgram Files\u005cMicrosoft SDKs\u005cWindows\u005cv6
p13020
aV0A\u005cBin\u005cildasm
p13021
aVexe
p13022
aVArguments = $(TargetPath)
p13023
aVInitial directory = $(TargetDir)
p13024
aVYou can now write some managed code, compile and quickly take a look at the generate IL
p13025
aVYou'll find it pretty easy going if you've been exposed to machine code before
p13026
aVJust keep in mind that IL is untyped, the same opcode is used for any value type
p13027
aVThe next step is to take a look at how IL gets translated to machine code
p13028
aVStart debugging, right-click the code and choose Go To Disassembly
p13029
aVBeware that you won't look at the real machine code unless you run the Release build and enable JIT optimization
p13030
aVTools + Options, Debugging, untick "Suppress JIT optimization on module load"
p13031
as(dp13032
g9
V17034
p13033
stp13034
a((dp13035
g2
(lp13036
VIt is a warning that's generated when you make calls on an ActiveX object from a background thread and your main thread is blocked
p13037
aVPerhaps more likely: there was a bug in the retail version of Visual Studio 2005 that tripped this warning for no good reason
p13038
aVIt got fixed in Service Pack 1, be sure you have that installed
p13039
aVYet another workaround is to shut it up
p13040
aVDebug + Exceptions, Managed Debugging Assistants, untick the ContextSwitchDeadlock warning
p13041
aVBut use SP1 if you don't have it
p13042
as(dp13043
g9
V17034
p13044
stp13045
a((dp13046
g2
(lp13047
VImplicit conversions you'll need to consider:
p13048
aVIdentity
p13049
aVsbyte to short, int, long, float, double, or decimal
p13050
aVbyte to short, ushort, int, uint, long, ulong, float, double, or decimal
p13051
aVshort to int, long, float, double, or decimal
p13052
aVushort to int, uint, long, ulong, float, double, or decimal
p13053
aVint to long, float, double, or decimal
p13054
aVuint to long, ulong, float, double, or decimal
p13055
aVlong to float, double, or decimal
p13056
aVulong to float, double, or decimal
p13057
aVchar to ushort, int, uint, long, ulong, float, double, or decimal
p13058
aVfloat to double
p13059
aVNullable type conversion
p13060
aVReference type to object
p13061
aVDerived class to base class
p13062
aVClass to implemented interface
p13063
aVInterface to base interface
p13064
aVArray to array when arrays have the same number of dimensions, there is an implicit conversion from the source element type to the destination element type and the source element type and the destination element type are reference types
p13065
aVArray type to System
p13066
aVArray
p13067
aVArray type to IList<> and its base interfaces
p13068
aVDelegate type to System
p13069
aVDelegate
p13070
aVBoxing conversion
p13071
aVEnum type to System
p13072
aVEnum
p13073
aVUser defined conversion (op_implicit)
p13074
aVI assume you're looking for the latter
p13075
aVYou'll need to write something resembling a compiler to cover all of them
p13076
aVNotable is that System
p13077
aVLinq
p13078
aVExpressions
p13079
aVExpression didn't attempt this feat
p13080
as(dp13081
g9
V17034
p13082
stp13083
a((dp13084
g2
(lp13085
VYou can generate them by holding down the Alt key and typing in the 4 digit Unicode codepoint on the numeric keypad
p13086
aV = Alt + 0229,  = Alt + 0241
p13087
aVFind other codes with the Charmap
p13088
aVexe applet
p13089
as(dp13090
g9
V17034
p13091
stp13092
a((dp13093
g2
(lp13094
VThis is a side effect of the way the JIT optimizer works
p13095
aVIt does more work if there is less code to generate
p13096
aVThe loop in your original snippet gets compiled to this:
p13097
aVWhen you add the extra Console
p13098
aVWriteLine() statement, it compiles it to this:
p13099
aVNote the difference at address 15 vs address 17+1a, the first loop keeps the intermediate result in the FPU
p13100
aVThe second loop stores it back to the @float local variable
p13101
aVWhile it stays inside the FPU, the result is calculated with full precision
p13102
aVStoring it back however truncates the intermediate result back to a float, losing lots of bits of precision in the process
p13103
aVWhile unpleasant, I don't believe this is a bug
p13104
aVThe x64 JIT compiler behaves differently yet
p13105
aVYou can make your case at connect
p13106
aVmicrosoft
p13107
aVcom
p13108
as(dp13109
g9
V17034
p13110
stp13111
a((dp13112
g2
(lp13113
VAssume a launch speed of V, launch angle of a radians, gravity g, time t:
p13114
aVx = V * cos(a) * t + g * t * t / 2
p13115
aVy = V * sin(a) * t - g * t * t / 2
p13116
aVBackground info is here
p13117
as(dp13118
g9
V17034
p13119
stp13120
a((dp13121
g2
(lp13122
VThe __report_gsfailure on the stack frame is significant
p13123
aVThat's a CRT function that's called when a security error was detected
p13124
aVReview the /GS command line options for the MSVC compiler
p13125
aVThe most common cause is a corrupted stack frame
p13126
aVI see no obvious reason in your code snippet for this mishap, it is already deeply nested inside Windows
p13127
aVMaybe corruption in the registry that in turn causes a buffer overflow
p13128
aVYou should be able to find out where by using SysInternals' ProcMon utility
p13129
as(dp13130
g9
V17034
p13131
stp13132
a((dp13133
g2
(lp13134
VYou've set your handshake to None but the cash drawer probably has its own idea
p13135
aVAlso set DtrEnable to True
p13136
aVChr(65) is the ASCII code for an "A", your VB code suggests the real command is "AA"
p13137
aVThe manual documents that the cash drawer auto-tunes its baudrate
p13138
aVIt recommends sending at least 20 @ characters
p13139
aVAnd that the real command is Ctrl+G (Chr(7))
p13140
aVThe "AA" command might have worked previously due to a baudrate mismatch
p13141
aVPerhaps
p13142
as(dp13143
g9
V17034
p13144
stp13145
a((dp13146
g2
(lp13147
VYou inherited code where the original programmer just didn't want to deal with errors
p13148
aVAs written, the program will simply malfunction (say, not save a record to the database) and there's no way to find out why it malfunctioned
p13149
aVEspecially since this is dbase code, this will cause random data corruption and loss of precious data
p13150
aVYou indeed cannot leave the code the way it is
p13151
aVThe very first thing you need to do is remove all try/catch statements so the program terminates when there's an error
p13152
aVAdd an AppDomain
p13153
aVUnhandledException event handler to log the exception so you know what went wrong
p13154
aVFix errors you'll encounter by correcting code or validating the data
p13155
aVDo expect this to take time, it is very likely that you'll discover many design problems that were shoved under a doormat before
p13156
as(dp13157
g9
V17034
p13158
stp13159
a((dp13160
g2
(lp13161
VApplying the static keyword to a class is a C# language convention, it doesn't mean anything special to the CLR
p13162
aVIt merely makes sure that all members are static as well and that you can't accidentally create an instance of the class with the new keyword
p13163
aVThe merits of static methods are discussed in this thread
p13164
as(dp13165
g9
V17034
p13166
stp13167
a((dp13168
g2
(lp13169
VIt will work, that's about all that can be said for it
p13170
aVSyncRoot was a mistake from
p13171
aVNET 1
p13172
aV1, there's no reason to continue the practice
p13173
as(dp13174
g9
V17034
p13175
stp13176
a((dp13177
g2
(lp13178
VEach AppDomain has its own probing path for assemblies, configured with the AppDomainSetup class
p13179
aVThe app
p13180
aVconfig file for the primary AppDomain
p13181
aVIt looks like in your case it is finding an assembly to load but a different one from the one that was used to serialize the data
p13182
aVThe one it found is missing the enum type
p13183
aVTroubleshoot this with Fuslogvw
p13184
aVexe, it lets you see what assemblies are being resolved
p13185
as(dp13186
g9
V17034
p13187
stp13188
a((dp13189
g2
(lp13190
VThis is not the correct way
p13191
aVServices cannot find out when a user logs in since Vista
p13192
aVIn your prior thread you got the advice to create two programs, although that wasn't explicitly stated
p13193
aVA service that runs after the machine boots and a user interface that allows the user to communicate with the service after she logs in
p13194
aVYou'll need an inter-process communication mechanism to get them to talk to each other
p13195
aVNamed pipes, a socket, Remoting or WCF will work
p13196
aVRead the MSDN Library docs on the ServiceBase class, that's what you'll need to create a service
p13197
as(dp13198
g9
V17034
p13199
stp13200
a((dp13201
g2
(lp13202
VThe ToolTip that appears in the object tree looks significant to me
p13203
aVIt probably wires a event handler for the RowSelected event so it can update the tip
p13204
aVClearly you are using a 3rd party control, it smells like Infragistics
p13205
aVNot a company well known for the quality of its products
p13206
aVI'd further guess that the ToolTip is internal to its control and that you can't access it to forcibly unsubscribe the event handler
p13207
aVBeyond giving up on tool tips, if that's even possible, you can't do much but contact the vendor for support
p13208
aVOr ditch the control
p13209
as(dp13210
g9
V17034
p13211
stp13212
a((dp13213
g2
(lp13214
VThat's a problem, Vista/Win7 don't appear to have an API to obtain the unprivileged user token you need to call CreateProcessAsUser()
p13215
aVThe only solutions I've found involve using the task scheduler to launch the program
p13216
aVThat doesn't strike me as very practical
p13217
aVAn easy solution that jumps to mind is to use a small non-elevated helper process
p13218
aVIt can in turn launch the elevated setup process and wait for a confirmation from that one to launch the non-elevated one
p13219
aVThe handshake is simple enough to do this with a named mutex
p13220
as(dp13221
g9
V17034
p13222
stp13223
a((dp13224
g2
(lp13225
VOnly the Form and the UserControl classes have designers that allow you to edit their child controls at design time
p13226
aVCreating your own designer to give SplitContainer the same behavior is not exactly simple, most of all because it is so poorly documented and difficult to debug
p13227
aVYou'll need to study the framework code with Reflector to get it right
p13228
aVPunt this problem, put the SplitContainer in a user control
p13229
aVSet its Dock property to Fill
p13230
aVNow it is easy
p13231
as(dp13232
g9
V17034
p13233
stp13234
a((dp13235
g2
(lp13236
VYes
p13237
aVPart of the problem is that you talk about them as dialogs but don't actually use the ShowDialog() method to display them
p13238
aVThat would make it impossible for the user to close the main form while a dialog is displayed
p13239
aVThe message loop terminates when the main form is closed, the remaining forms will be disposed without going through the normal shutdown sequence
p13240
aVOne solution is to pro-actively close the forms yourself when the main form closes
p13241
aVThis worked well:
p13242
aVYou probably should pay attention to e
p13243
aVCloseReason so you don't block a Windows shutdown
p13244
as(dp13245
g9
V17034
p13246
stp13247
a((dp13248
g2
(lp13249
VYour code snippet doesn't repro the problem for me
p13250
aVWhat really matters is what is going on with the main form
p13251
aVWhat you see happening is not that unusual
p13252
aVWhen your wait form closes, Windows goes hunting for another window in your app to give the focus to
p13253
aVIf it cannot find one, it will pick another window from another process and bring it to the foreground
p13254
aVIn effect, your main form will disappear behind that window
p13255
aVThis is guaranteed to happen when your main form is disabled, perhaps you set its Enabled property to false
p13256
aVI imagine it can also happen when your main form is still unresponsive to Windows messages, that part is murky
p13257
aVAvoid these kind of problems (and the incorrect threading apartment you use for the wait form) by executing the time consuming code on a background thread instead of the UI thread
p13258
aVBackgroundWorker was designed to make that easy
p13259
as(dp13260
g9
V17034
p13261
stp13262
a((dp13263
g2
(lp13264
VThere's little hope to ever get any useful info out of a
p13265
aVsuo file
p13266
aVEven if you do manage to reverse-engineer its (complicated) format, your hard work will be for naught with the next release or service pack for Visual Studio
p13267
aVThe file stores IDE state
p13268
aVThat state is also accessible from the extensibility interfaces
p13269
aVUse macros to get ahead
p13270
aVLookup the EnvDTE namespace in the MSDN library to get started
p13271
as(dp13272
g9
V17034
p13273
stp13274
a((dp13275
g2
(lp13276
VIf you create a Class instead of a Module then VB
p13277
aVNET will insist you use the class name
p13278
aVFor example:
p13279
aVIt is hardly necessary, but you can prevent anyone from inheriting this class by adding a private constructor
p13280
aVUpdate
p13281
aVTo avoid extension methods from polluting the global namespace in IntelliSense
p13282
aVI found a rather unexpected workaround for this:
p13283
as(dp13284
g9
V17034
p13285
stp13286
a((dp13287
g2
(lp13288
VWell, sure, VCL requires a Borland compiler
p13289
aVThe Win32 API works for any language
p13290
aVThe point of using a GUI class library, like VCL, is to make the effort of creating a GUI enabled program easier
p13291
aVDoing so using only Win32 is quite punishing
p13292
as(dp13293
g9
V17034
p13294
stp13295
a((dp13296
g2
(lp13297
VIt works fine when I try it
p13298
aVBe sure to click on the volume control tray icon, click Mixer and modify the volume for your app
p13299
as(dp13300
g9
V17034
p13301
stp13302
a((dp13303
g2
(lp13304
VIt certainly does, System
p13305
aVIO
p13306
aVPorts
p13307
aVSerialPort, available since
p13308
aVNET 2
p13309
ag2512
as(dp13310
g9
V17034
p13311
stp13312
a((dp13313
g2
(lp13314
VThis MSDN magazine article should have everything you need
p13315
as(dp13316
g9
V17034
p13317
stp13318
a((dp13319
g2
(lp13320
VMacros are pretty evil, but there's nothing more evil than obfuscating control statements and blocks with macros
p13321
aVThere is no good reason to write code like this
p13322
aVJust make it:
p13323
as(dp13324
g9
V17034
p13325
stp13326
a((dp13327
g2
(lp13328
VNot to be obvious: the symbol server gives you symbols
p13329
aVSo you can debug the minidumps you get back from your customer when your code crashes and burns
p13330
aVIt is absolutely crucial to do post-mortem analysis on real problems that your customer is experiencing
p13331
aVBecause by the time your several month old version of your code gets an opportunity to crash on your customer's machine, you've already progressed a couple of versions
p13332
aVThe real effort is not in setting up a symbol server, it is making sure it has the right pdb files to give you a good debugging opportunity
p13333
aVControlling the build process is a crucial part of that equation
p13334
as(dp13335
g9
V17034
p13336
stp13337
a((dp13338
g2
(lp13339
VKeep in mind that all WPF locations and sizes are floating point with a unit of 1/96 inch
p13340
aVNot pixels
p13341
aVThis makes your window designs resolution independent
p13342
aVDoing the math: height = 960 / 96 = 10 inches
p13343
aVWith your video adapter set to 120 DPI (120/96 = 125%): 10 * 120 = 1200 pixels
p13344
aVSame for width: 1536 / 96 * 120 = 1920 pixels
p13345
aVSystem
p13346
aVWindows
p13347
aVForms works in units of pixels
p13348
aVYou are getting less than 1050 for the height because it subtracts the height of the taskbar
p13349
aVBut for WPF you always want to work with 1/96", never pixels
p13350
as(dp13351
g9
V17034
p13352
stp13353
a((dp13354
g2
(lp13355
VThe article you linked manages to be both irrelevant and outdated
p13356
aVClearTypeGridFit is already the default anti-aliasing drawing mode on machines that have ClearType enabled
p13357
aVAnd you should use the TextRenderer class for text rendering, Graphics
p13358
aVDrawString() has problems
p13359
aVYou can double-check that you are getting ClearType anti-aliasing by using SysInternals' ZoomIt utility
p13360
aVYou should be able to see the reddish and bluish fringes drawn along the font outline when you zoom in
p13361
as(dp13362
g9
V17034
p13363
stp13364
a((dp13365
g2
(lp13366
VJust a word of warning, the 7
p13367
aV0 SDK has a badly broken installer
p13368
aVIt hacks registry keys that are used by Visual Studio to find SDK components and drops files in the VS install directory
p13369
aVThis can render it unusable
p13370
aVThe worst problems are documented as sticky posts in the Windows SDK forum at the MSDN forums
p13371
aVI had problems as well, the installer failed half-way through on my machine with a completely undescriptive error
p13372
aVOn a pretty virgin machine with VS2008
p13373
aVIt didn't roll back the install even though it failed, I had to edit the registry by hand to fix the damage
p13374
aVI recommend you actually install the SDK on a machine you don't care about
p13375
aVThen copy the directory to a production machine and edit the VC++ directories yourself
p13376
aVGood luck with it
p13377
as(dp13378
g9
V17034
p13379
stp13380
a((dp13381
g2
(lp13382
VYes, that's possible
p13383
aVYou'll need to use the  element in the manifest
p13384
aVThere's a decent how-to located here
p13385
aVThe SDK docs are otherwise pretty miserable, you'll need Junfeng Zhang's blog to get better background info
p13386
as(dp13387
g9
V17034
p13388
stp13389
a((dp13390
g2
(lp13391
VWMI can provide this, use the Win32_Service class
p13392
aVDoing this in 'C' is fugly, the SDK only provides C++ samples
p13393
aVThis is the equivalent C# code:
p13394
as(dp13395
g9
V17034
p13396
stp13397
a((dp13398
g2
(lp13399
VYou can P/Invoke GetWindowProcessThreadId() to get the thread ID for the UI thread that owns the main window
p13400
aVFrom there, you can find any other top-level window owned by that thread with EnumThreadWindows()
p13401
aVAny child windows (controls) owned by a top-level window can be found with EnumChildWindows()
p13402
aVVisit pinvoke
p13403
aVnet for the necessary P/Invoke declarations
p13404
as(dp13405
g9
V17034
p13406
stp13407
a((dp13408
g2
(lp13409
VIt is the standard function entry and exit code
p13410
aVIt establishes and tears down the stack frame
p13411
aVIf you don't want it you can use __declspec(naked)
p13412
aVDon't forget to include the RET if you do
p13413
aVHowever, your snippet relies on a valid stack frame, your "m" variable requires it
p13414
aVIt is addressed at [ebp-10]
p13415
aVWithout the preamble, the ebp register won't be set correctly and you'll corrupt the stack frame of the caller
p13416
as(dp13417
g9
V17034
p13418
stp13419
a((dp13420
g2
(lp13421
VRTF is old, older than Job and considerably predates Unicode
p13422
aVI think it using code page 936, a double-byte character set for Simplified Chinese
p13423
aVYour snippet shows it using c3db for the character, it matches the glyph shown in this table
p13424
as(dp13425
g9
V17034
p13426
stp13427
a((dp13428
g2
(lp13429
VOdd that it got converted to UTF-16
p13430
aVBut it is easy enough to fix from Visual Studio 2008
p13431
aVUse File + Save As, keep the same name, click on the arrow on the Save button and choose Save with Encoding
p13432
aVClick on the "Encoding" combobox and select UTF8
p13433
aVThat's the default encoding used by VS2008
p13434
aVThe resulting file has a BOM, just like your UTF-16 version had
p13435
aVThat should be good enough for any reasonably modern diff tool, including KDiff3
p13436
aVThey'll decode the text in the source code file back to Unicode
p13437
aVTest this on a couple of files to make sure
p13438
as(dp13439
g9
V17034
p13440
stp13441
a((dp13442
g2
(lp13443
VI have to say, this is well intended but not well executed
p13444
aVIt is sorta nice that your program won't crash and burn when you try to free() a NULL pointer
p13445
aVOr sort a NULL string
p13446
aVBut that's a mixed blessing
p13447
aVIt prevents you from discovering nasty bugs in your code as well
p13448
aVNot only will you have a hard time getting your program ported some day, because you're relying on non-standard functions, you'll have a really hard time because your code was buggy and you never found out
p13449
as(dp13450
g9
V17034
p13451
stp13452
a((dp13453
g2
(lp13454
VI think you're seeing something else
p13455
aVMost common calling conventions on x86 pass arguments the function arguments on the stack
p13456
aVBut the x64 calling convention is different, it is similar to __fastcall on x86, it passes the first 4 function arguments in registers (rcx, rdx, r8 and r9)
p13457
aVIf the function is non-trivial, the compiler generates code to save those registers on the stack frame right away
p13458
aVUnfortunately, the debugger isn't smart enough to know about the saved register locations
p13459
aVIt displays the register value in the call stack, a value that almost always has changed
p13460
aVYou can technically dig the argument value out of the stack frame yourself, but you really, really want to have to do this
p13461
aVIn optimized code it is an offset from rsp, not rbp, and the stack pointer value has changed as well
p13462
aVI haven't found any good workaround for this yet
p13463
aVLooking forward to improvements in the VS2010 debugger, no idea if this was addressed
p13464
as(dp13465
g9
V17034
p13466
stp13467
a((dp13468
g2
(lp13469
VVideo is rendered to a hardware overlay in the video adapter
p13470
aVYou'll need to create your own to overlay that overlay
p13471
aVI think DirectX provides that capability, you can also get it by using the WS_EX_LAYERED window style and the SetLayeredWindowAttributes()
p13472
aVWhich you'll need to set the transparency key
p13473
aVNot so sure that's a slam-dunk btw, I've seen this behave oddly
p13474
as(dp13475
g9
V17034
p13476
stp13477
a((dp13478
g2
(lp13479
VThis blog post explains how it is done
p13480
as(dp13481
g9
V17034
p13482
stp13483
a((dp13484
g2
(lp13485
VLetting your program use a DLL requires an import library
p13486
aVIt is a file with the
p13487
aVlib extension, just like a static
p13488
aVlib
p13489
aVBut it is very small, it only contains a list of the functions that are exported by the DLL
p13490
aVThe linker needs this so it can embed the name of the DLL in the import table
p13491
aVYou can see this for yourself by running Dumpbin
p13492
aVexe /imports on your
p13493
aVexe
p13494
as(dp13495
g9
V17034
p13496
stp13497
a((dp13498
g2
(lp13499
VThe boilerplate code is in this MSDN Library article
p13500
as(dp13501
g9
V17034
p13502
stp13503
a((dp13504
g2
(lp13505
VNot in any CRT implementation that I've ever seen
p13506
aVIt is useless info, you already have to supply the file name to get a FILE*
p13507
aVYou could probably dig an operating system handle out of the FILE structure although you might need to hop through a file descriptor table
p13508
aVYour next problem is then the operating system support you'd need to map a file handle back to a file name
p13509
aVThat should be difficult too
p13510
as(dp13511
g9
V17034
p13512
stp13513
a((dp13514
g2
(lp13515
VYou are asking for a guarantee that the serialized representation will match
p13516
aVThat's going to be awfully hard to come by, BinaryFormatter is a complicated class
p13517
aVParticularly serialized structures that have alignment padding could be a potential problem
p13518
aVWhat's much simpler is to provide an example where it won't match
p13519
aVSystem
p13520
aVDecimal has different byte patterns for values like 0
p13521
aV01M and 0
p13522
aV010M
p13523
aVIts operator==() will say they are equal, its serialized byte[] won't
p13524
as(dp13525
g9
V17034
p13526
stp13527
a((dp13528
g2
(lp13529
VYou'll probably want to use the true minus sign, Unicode codepoint \u005cu2212
p13530
aVThe minus sign you use in programming (\u005cu002d) is a "hyphen-minus", its collation order is context sensitive because it is also frequently used as a hyphen
p13531
aVThere's more than you'll want to know about the many different kind of dashes in this article
p13532
as(dp13533
g9
V17034
p13534
stp13535
a((dp13536
g2
(lp13537
VSetting the WebBrowser's Dock property to Fill is the correct answer here
p13538
aVThis completely eliminates the possibility that you'll have layout problems when you run your program on a machine that has a different system font size or a different video adapter DPI setting
p13539
aVIf you need room for some kind of gadget or toolbar, be sure to dock it as well (usually Top)
p13540
aVUse Format + Order if the browser ends up underneath the gadget
p13541
as(dp13542
g9
V17034
p13543
stp13544
a((dp13545
g2
(lp13546
VYou've got a problem, TextBox is, erm, special
p13547
aVWindows Forms leaves all painting to the native Windows EDITBOX control, the Paint event won't be raised
p13548
aVThat can be fixed by setting the UserPaint control style to true:
p13549
aVCopy and paste this into a new class, compile and drop the new control from the top of the toolbox
p13550
aVTry it out, you'll be quite disappointed
p13551
aVWhat you see is the result of close to 20 years of appcompat hacks on a control that dates back to Windows version 2
p13552
aVOne of the grave crimes that EDITBOX commits is painting itself without generating a WM_PAINT message
p13553
aVThat was important way back when Windows had to run on a 386SUX, keeping it compatible with old programs prevented Microsoft from fixing its behavior
p13554
aVNo happy answers here, you'll have to give up on the idea of customizing the border
p13555
aVWhat you can do is give the control a distinct BackColor when it has the focus
p13556
aVFor example:
p13557
as(dp13558
g9
V17034
p13559
stp13560
a((dp13561
g2
(lp13562
VThe diagnostic indicates that the native CreateWindowEx() API function failed
p13563
aVThere are very few reasons for it to fail, the most common one is a gross mistake in the window procedure for the window
p13564
aVThat certainly is not the case for the Form class, I've only ever seen Windows Forms programs fail with this error because the process exceeded its handle quota
p13565
aVTo explain that is going to require some hand waving
p13566
aVFirst off, by default a Windows process is only allowed to create 10,000 handles, GDI objects and user32 objects
p13567
aVIt is of course very unlikely that your program consumed that many right at start up
p13568
aVSeeing this happen when it is started by the installer is however a lead
p13569
aVMsi
p13570
aVexe gets special dispensation, it is allowed to create many more handles
p13571
aVI've seen it do this, the VS2008 service pack 1 installer I ran on an old unpatched version of XP got up to 500,000 handles about 2 hours after I started it before it decided a reboot was necessary to complete the install
p13572
aVYour installer would use CreateProcess() to start the program
p13573
aVIt has an argument named bInheritHandles that determines whether or not the child process inherits the handles of the parent process
p13574
aVA possible scenario is thus that the installer consumes many handles, and that it has the bInheritHandles argument set to TRUE
p13575
aVYour WF program would then start with its handle quota already exceeded, creating another handle will fail
p13576
aVThe SetVisibleCore() method is indeed the one that creates the main form's Handle property
p13577
aVThis is all conjecture of course, you should be able to see this for yourself with Taskmgr
p13578
aVexe, Process tab while the process is displaying the exception dialog
p13579
aVUse View + Select Columns and tick Handles, GDI Object and USER objects
p13580
aVAn ultimate fix is going to require finding out why the installer is consuming so many handles
p13581
aVOr using a different way to start the program
p13582
as(dp13583
g9
V17034
p13584
stp13585
a((dp13586
g2
(lp13587
VNo, that's not going to work
p13588
aVThe CLR will verify the assembly version number, expecting to get the one that your main program was compiled against
p13589
aVYou would have to use the  element in the app
p13590
aVconfig file to convince it that a different version is okay
p13591
aVThat's a slippery slope
p13592
aVConsider only changing the [AssemblyVersion] attribute if the public interface of the assembly changed and requires clients to be recompiled
p13593
aVNow the exception you'll get is one that identifies a real problem
p13594
aVThis is another kind of slippery slope, but one you'll have much more control over
p13595
aVFor comparison, this is the way all the base assemblies in the
p13596
aVNET framework work
p13597
aVThere have been many revisions of them between
p13598
aVNET 2
p13599
aV0 RTM and 3
p13600
aV5 SP1, including many invisible hotfixes
p13601
aVBut the [AssemblyVersion] is still 2
p13602
ag2512
ag2512
aV0, Microsoft only modifies the [AssemblyFileVersion]
p13603
as(dp13604
g9
V17034
p13605
stp13606
a((dp13607
g2
(lp13608
VThe error code you got is CONNECT_E_CANNOTCONNECT, something that Googles well
p13609
aVIt indicates that the COM server isn't happy about your attempt to subscribe an event handler
p13610
aVWhy it is not is something you'll need to find out
p13611
aVGetting help from the component author or vendor is almost always required
p13612
aVOne thing you can try is to look at the type library with Oleview
p13613
aVexe and find out if the event you're trying to subscribe to is on a dispinterface that's marked as the default source interface
p13614
aVIf it is not, try casting the object to the dispinterface type, then subscribe to its event
p13615
as(dp13616
g9
V17034
p13617
stp13618
a((dp13619
g2
(lp13620
VThe AcceptsReturn property does something else
p13621
aVThe Enter key normally operates the OK button on a dialog
p13622
aVWith AcceptsReturn = true, the Enter key will enter a new line in the text box instead of activating the OK button Click event
p13623
aVPressing Ctrl+Enter will generate a line feed, TextBox treats this as a new line as well
p13624
aVUse this KeyDown event to filter all combinations:
p13625
as(dp13626
g9
V17034
p13627
stp13628
a((dp13629
g2
(lp13630
VHeap corruption is a likely candidate
p13631
aVThe v-table pointer in the object is vulnerable, it is usually the first field in the object
p13632
aVA buffer overflow for some kind of other object that happens to be adjacent to the object will wipe the v-table pointer
p13633
aVThe call to a virtual method, often much later, will blow
p13634
aVAnother classic case is having a bad "this" pointer, usually NULL or a low value
p13635
aVThat happens when the object reference on which you call the method is bad
p13636
aVThe method will run as usual but blow up as soon as it tries to access a class member
p13637
aVAgain, heap corruption or using a pointer that was deleted will cause this
p13638
aVGood luck debugging this; it is never easy
p13639
as(dp13640
g9
V17034
p13641
stp13642
a((dp13643
g2
(lp13644
VYes, it gets to be important when your List<> gets large
p13645
aVThe exact numbers depend on the element type and the machine architecture, let's pick a List of reference types on a 32-bit machine
p13646
aVEach element will then take 4 bytes inside an internal array
p13647
aVThe list will start out with a Capacity of 0 and an empty array
p13648
aVThe first Add() call grows the Capacity to 4, reallocating the internal array to 16 bytes
p13649
aVFour Add() calls later, the array is full and needs to be reallocated again
p13650
aVIt doubles the size, Capacity grows to 8, array size to 32 bytes
p13651
aVThe previous array is garbage
p13652
aVThis repeats as necessary, several copies of the internal array will become garbage
p13653
aVSomething special happens when the array has grown to 65,536 bytes (16,384 elements)
p13654
aVThe next Add() doubles the size again to 131,072 bytes
p13655
aVThat's a memory allocation that exceeds the threshold for "large objects" (85,000 bytes)
p13656
aVThe allocation is now no longer made on the generation 0 heap, it is taken from the Large Object Heap
p13657
aVObjects on the LOH are treated specially
p13658
aVThey are only garbage collected during a generation 2 collection
p13659
aVAnd the heap doesn't get compacted, it takes too much time to move such large chunks
p13660
aVThis repeats as necessary, several LOH objects will become garbage
p13661
aVThey can take up memory for quite a while, generation 2 collections do not happen very often
p13662
aVAnother problem is that these large blocks tend to fragment the virtual memory address space
p13663
aVThis doesn't repeat endlessly, sooner or later the List class needs to re-allocate the array and it has grown so large that there isn't a hole left in the virtual memory address space to fit the array
p13664
aVYour program will bomb with an OutOfMemoryException
p13665
aVUsually well before all available virtual memory has been consumed
p13666
aVLong story short, by setting the Capacity early, before you start filling the List, you can reserve that large internal array up front
p13667
aVYou won't get all those awkward released blocks in the Large Object Heap and avoid fragmentation
p13668
aVIn effect, you'll be able to store many more objects in the list and your program runs leaner since there's so little garbage
p13669
aVDo this only if you have a good idea how large the list will be, using a large Capacity that you'll never fill is wasteful
p13670
as(dp13671
g9
V17034
p13672
stp13673
a((dp13674
g2
(lp13675
VIt isn't very likely that the code as posted bombs on ObjectDisposed
p13676
aVHowever, getting the exception is unsurprising when you use System
p13677
aVTimers
p13678
aVTimer
p13679
aVYou have to make sure that the timer is shut down before the form closes
p13680
aVNot doing so allows the Elapsed event to run when the form object is dead
p13681
aVThe bigger problem with that is that it is practically impossible to guarantee that the timer is actually stopped
p13682
aVThere is an inevitable race condition, the Elapsed event may have already been scheduled to run while you are stopping the timer
p13683
aVThere are various, unpleasant, things you can do about that
p13684
aVBut before you go there, make sure that System
p13685
aVWindows
p13686
aVForms
p13687
aVTimer doesn't solve your problem
p13688
aVIt is a synchronous timer, it will never Tick after the form closes
p13689
aVIt also avoids the kind of nasty threading problems you can run into when you access class members in the Elapsed event without using the lock statement
p13690
as(dp13691
g9
V17034
p13692
stp13693
a((dp13694
g2
(lp13695
VDon't get your hopes up,
p13696
aVNET 4
p13697
aV0 is definitely not a perf oriented release
p13698
aVBefore anything else, it is a compatibility release
p13699
aVFive long years of MSFT not being able to release a side-by-side installable version of the CLR and the base class libraries come to end
p13700
aVBetter yet, it is a SxS version that even supports running old versions of the CLR together with the new version in one process
p13701
aVThat's an awesome accomplishment, I didn't think it was possible
p13702
aVThe many BCL additions are cream on the cake
p13703
as(dp13704
g9
V17034
p13705
stp13706
a((dp13707
g2
(lp13708
VIt is a convention specific to the C# language, the CLR has no notion of static classes
p13709
aVIt ensures that you cannot accidentally add an instance member in the class, cannot inherit the class and client code cannot accidentally create an instance of the class
p13710
aVThe underlying TypeAttributes for the class are Abstract and Sealed
p13711
aVAbstract ensures that the new operator can't work, Sealed ensures that you can't inherit from the class
p13712
aVAlso by convention, extension methods must be static members of a static class
p13713
aVVB
p13714
aVNET does it differently, it requires the [Extension] attribute
p13715
aVUsing static classes in your code is not necessary, but it is useful
p13716
aVTheir contract is very descriptive, it makes your code easier to understand
p13717
aVBut be careful not to use them as a vehicle to write procedural code instead of OOP code
p13718
as(dp13719
g9
V17034
p13720
stp13721
a((dp13722
g2
(lp13723
VYou will have to use LoadLibrary() and GetProcAddress() to get the entry point for this function
p13724
aVOn XP you'll get a NULL back from GetProcAddress(), good enough to simply skip the call
p13725
aVThere's a good example in the SDK docs, the only tricky part is declaring the function pointer:
p13726
as(dp13727
g9
V17034
p13728
stp13729
a((dp13730
g2
(lp13731
VThe heavy hitters on memory usage for a DataSet are the DataRow object required for each row in a DataTable and the index that's automatically generated for each column
p13732
aVStorage of the column values is efficient, you can't improve that
p13733
aVReplacing this with a collection of generic collections will allow elimination of the DataRows, that could be a rough 50% savings if the DataTable doesn't have a lot of columns
p13734
aVThe indexes is what you need to worry about
p13735
aVThey make queries on the DataSet very fast, you'll lose that unless you provide some kind of custom substitute
p13736
aVWhether you'll need to provide a substitute is impossible to say, it depends on the kind of queries you run
p13737
as(dp13738
g9
V17034
p13739
stp13740
a((dp13741
g2
(lp13742
VMicrosoft
p13743
aVVisualStudio
p13744
aVShell
p13745
aVdll is parenthetically not a redistributable component
p13746
aVYou'll find a list of the ones you can redistribute in the redist
p13747
aVtxt file in the Visual Studio install directory
p13748
aVGetting rid of this particular dependency isn't hard
p13749
aVIt is a COM HRESULT value, S_OK = 0
p13750
aVYou can find those values listed in the WinError
p13751
aVh SDK header file
p13752
aVFor VS2008, you'll find it in the c:\u005cprogram files\u005cmicrosoft sdks\u005cwindows\u005cv6
p13753
aV0a\u005cinclude
p13754
aVEarlier releases in the vc\u005cPlatformSDK subdirectory of the VS install directory
p13755
as(dp13756
g9
V17034
p13757
stp13758
a((dp13759
g2
(lp13760
VWell, that doesn't make a lot of sense of course
p13761
aVIt smells like the child window is re-parenting itself
p13762
aVIt is a common technique in
p13763
aVNET Windows Forms, it has a "Parking window" where child controls can find a temporary home when their container window needs to be recreated because a window style changed
p13764
aVThis isn't a very visible effect, it is also temporary
p13765
aVAnother, remote, possibility is SetParent()
p13766
aVIt has appcompat behavior to support old Windows 3
p13767
aVx programs
p13768
aVIt is explained pretty well in the SDK docs for it, in a nutshell a window can be parented but not set its WS_CHILD style flag
p13769
aVAdobe Acrobat Reader is a classic example of a program that does this
p13770
aVWhat effect that will have on EnumChildWindows is unclear to me
p13771
aVLast but not least: don't forget that Spy++ gives a static view of the windows
p13772
aVPressing F5 to update the window list can be important to track changes
p13773
aVNot great explanations
p13774
aVTry to find out if it matters which toplevel window is active, I suspect it does
p13775
as(dp13776
g9
V17034
p13777
stp13778
a((dp13779
g2
(lp13780
VYour can use the PerformanceCounter class
p13781
aVRun Perfmon
p13782
aVexe to find out what's available on your machine
p13783
aVYou should have Network Interface + Packets Received Discarded for each of your network adapters for example
p13784
as(dp13785
g9
V17034
p13786
stp13787
a((dp13788
g2
(lp13789
VThis worked:
p13790
as(dp13791
g9
V17034
p13792
stp13793
a((dp13794
g2
(lp13795
VYou are getting perilously close to having too many controls on your form
p13796
aVYou'll see each control taking its turn painting itself
p13797
aVDouble buffering cannot fix this, the entire form with all control windows would have to be double-buffered
p13798
aVThat's possible since XP, it supports the WS_EX_COMPOSITED window style flag
p13799
aVIt won't speed up painting but the screen won't be updated until all rendering is completed
p13800
aVPaste this code into your form to enable it:
p13801
as(dp13802
g9
V17034
p13803
stp13804
a((dp13805
g2
(lp13806
VWell, sure, you'll be running the app with a CLR version it has never been tested against
p13807
aVMicrosoft does a great job keeping it backwards compatible
p13808
aVBut the case of Microsoft managers losing email access for a few days after a
p13809
aVNET upgrade is famous
p13810
aVThe threadpool timing was slightly different, exposing a threading race in a program written by an intern
p13811
aVCan't google the link right now
p13812
as(dp13813
g9
V17034
p13814
stp13815
a((dp13816
g2
(lp13817
VThere's no real evidence of any kind of leak from what you've posted
p13818
aVThe garbage collector hasn't run for a while, that's normal on an idle program
p13819
aVThe 0
p13820
aV5 MB those uncollected objects take is peanuts
p13821
aVWhat will happen when a program is idle for a while is that its virtual memory pages will get swapped out to the paging file
p13822
aVWhen it regains the focus, those pages need to be swapped back in
p13823
aVWhen the machine is old, that can take a while
p13824
aVYour real problem is more than likely disk fragmentation, especially on the paging file
p13825
aVYou should be able to tell from the hard disk drive access light, it ought to be furiously blinking
p13826
aVYou can also tell from TaskMgr
p13827
aVexe, Process tab
p13828
aVView + Select Columns, tick Page Fault Delta
p13829
aVThat number should go to zero in a second or less after restoring the program's window
p13830
aVDefrag your disk
p13831
aVEspecially the paging file, which is hard to do
p13832
aVAsk questions about that at superuser
p13833
aVcom
p13834
as(dp13835
g9
V17034
p13836
stp13837
a((dp13838
g2
(lp13839
VI think it is done by CoCreateObject() the CLSID_CorMetaDataDispenser coclass, asking for IID_IMetaDataDispenser interface
p13840
aVIMetaDataDispenser::OpenScope() lets you open the assembly metadata
p13841
aVAsk for IID_IMetaDataAssemblyImport, it has a bunch of methods to iterate the metadata
p13842
aVWatch out for
p13843
aVNET 4
p13844
aV0, it's around the corner and I'm pretty sure the metadata format has changed
p13845
aVAlthough that should only be an issue for generating metadata, reading should be backwards compatible as long as you get the 4
p13846
aV0 version of the interfaces
p13847
aVhas CLSIDs for the version specific metadata coclasses
p13848
aVI'll assume that you're not interested in Irony
p13849
as(dp13850
g9
V17034
p13851
stp13852
a((dp13853
g2
(lp13854
VThe MSDN Library article for the Workbook class constructor is quite explicit:
p13855
aVMicrosoft
p13856
aVOffice
p13857
aVTools
p13858
aVExcel
p13859
aVWorkbook
p13860
aVhost items cannot be created
p13861
aVprogrammatically
p13862
aVUse the Application
p13863
aVWorkbooks
p13864
aVAdd() method, sample code is here
p13865
as(dp13866
g9
V17034
p13867
stp13868
a((dp13869
g2
(lp13870
VYou'll want to download and experiment with the WMI Code Creator utility
p13871
aVThe available events are listed under the "Receive an event" tab
p13872
aVAn example in C# is available in this thread
p13873
aVFormal documentation for the WMI classes and their events starts here
p13874
as(dp13875
g9
V17034
p13876
stp13877
a((dp13878
g2
(lp13879
VNo can do
p13880
aVThe resource string is stored in XML format in a
p13881
aVresx file, #ifdef doesn't apply
p13882
aVThe Properties
p13883
aVResources class is autogenerated, any #ifdef you put in the Designer
p13884
aVcs source code file will be lost when the file is re-generated
p13885
aVPut the #ifdef in the code that retrieves the string
p13886
aVA small static helper method will do the job
p13887
as(dp13888
g9
V17034
p13889
stp13890
a((dp13891
g2
(lp13892
VSetting it to NULL isn't actually a good practice, it hides bugs
p13893
aVParticularly double free()s
p13894
aVCheck the OS memory map, something like 0xfeeefeee or 0xdeadbeef is usually good
p13895
aVYou can diagnose double free()s with a debug allocator
p13896
aVMost any decent CRT has one
p13897
as(dp13898
g9
V17034
p13899
stp13900
a((dp13901
g2
(lp13902
VThe
p13903
aVNET Console
p13904
aVCapsLock and NumberLock properties return the key state
p13905
aVMono has them too, but they are not yet documented
p13906
aVGive it a try
p13907
as(dp13908
g9
V17034
p13909
stp13910
a((dp13911
g2
(lp13912
VOpening the drive requires the drive name, like "\u005c\u005c
p13913
aV\u005cPhysicalDrive0"
p13914
aVFinding the drive name requires QueryDosDevice()
p13915
aVThe odds that Windows will allow this are fairly minimal
p13916
as(dp13917
g9
V17034
p13918
stp13919
a((dp13920
g2
(lp13921
VStack frame corruption due to buffer overflow is the usual explanation for this
p13922
aVHere's an example:
p13923
aVOutput:
p13924
aVThe "msg" string buffer is too short by one character, the string terminator overwrites the value of "cpd"
p13925
aVThe best way to find the cause is to use the data breakpoint feature of the debugger
p13926
aVSet a regular breakpoint on the function entry point
p13927
aVThen find the address of the "cpd" variable and a set a byte-size data breakpoint on it
p13928
aVThe debugger will stop as soon as the cpd value changes
p13929
aVBeware that this won't necessarily work in optimized code, the "cpd" value might be stored in a register
p13930
aVWhich is another possible explanation why its value is different in separate statements
p13931
as(dp13932
g9
V17034
p13933
stp13934
a((dp13935
g2
(lp13936
VYou are trying to print an HRESULT, the error code for "access denied"
p13937
aVThat is best formatted in hex, at least to be easily recognizable to a programmer
p13938
aVNow you'll instantly recognize the facility code 7 (Windows API) and the error code 5 (access denied)
p13939
as(dp13940
g9
V17034
p13941
stp13942
a((dp13943
g2
(lp13944
VDispatcherTimer is the regular timer
p13945
aVIt fires its Tick event on the UI thread, you can do anything you want with the UI
p13946
aVSystem
p13947
aVTimers
p13948
aVTimer is an asynchronous timer, its Elapsed event runs on a thread pool thread
p13949
aVYou have to be very careful in your event handler, you are not allowed to touch any UI component
p13950
aVAnd you'll need to use the lock statement where ever you access class members that are also used on the UI thread
p13951
aVIn the linked answer, the Timer class was more appropriate because the OP was trying to run code asynchronously on purpose
p13952
as(dp13953
g9
V17034
p13954
stp13955
a((dp13956
g2
(lp13957
VYou are making it unnecessarily difficult
p13958
aVIt is not a "handle", there's no need for reference counting
p13959
aVA __ComObject is a regular
p13960
aVNET class and subject to normal garbage collection rules
p13961
as(dp13962
g9
V17034
p13963
stp13964
a((dp13965
g2
(lp13966
VIt is possible, a message box is a regular window that can be messed with like any other
p13967
aVThe code to do so is however a bit gritty
p13968
aVAdd a new class to your project and paste this code:
p13969
aVAnd use it like this:
p13970
aVThere is one flaw in this approach
p13971
aVAfter making the font bold, the text must still fit in the static control that the message box reserved for the text
p13972
aVThat required me to make the font smaller
p13973
aVYou may have to tweak this value
p13974
as(dp13975
g9
V17034
p13976
stp13977
a((dp13978
g2
(lp13979
VYup, there is
p13980
aVThe RunOnce key
p13981
as(dp13982
g9
V17034
p13983
stp13984
a((dp13985
g2
(lp13986
VYes, it is possible
p13987
aVMono has xbuild, an implementation of msbuild which is used by Visual Studio to build VB
p13988
aVNET and C# projects (but not VC++)
p13989
aVAs is typical for Mono, this is a work in progress, be sure to check the todo items to see how suitable it is for your projects
p13990
as(dp13991
g9
V17034
p13992
stp13993
a((dp13994
g2
(lp13995
VIt depends what constructor you used
p13996
aVThe TextWriterTraceListener(String) constructor creates a StreamWriter that opens the file with FileShare
p13997
aVRead
p13998
aVThat allows any process to read the file
p13999
aVThe usual problem is trying to open the file with the wrong FileShare setting in the other process
p14000
aVYou have to specify FileShare
p14001
aVReadWrite
p14002
aVThe trace listener has already gained write access to the file, you cannot deny it
p14003
as(dp14004
g9
V17034
p14005
stp14006
a((dp14007
g2
(lp14008
VBootstrapper packages are the basic components you might need to get a
p14009
aVNET program installed
p14010
aVYou'll find them listed in the BootsTrapper\u005cPackages subdirectory of the Windows SDK folder (c:\u005cprogram files\u005cmicrosoft sdks\u005cwindows\u005cv6
p14011
aV0 for VS2008)
p14012
aVThe ones on my machine are:
p14013
aVDotNetFx(Xxx) - installs
p14014
aVNET on the target machine
p14015
aVOffice2007PIARedist - the Office PIA, required when you automate Office programs
p14016
aVReportViewer - required when you use report viewer
p14017
aVSql Server Compact Edition - required when you use SQL Server Compact
p14018
aVSqlExpress - required when you use SQL Express
p14019
aVVBPowerPacks - required when you use any VB Power Pack component (PrintForm, Shape etc)
p14020
aVvcredist(Xxx) - required when you used any C/C++ code that uses /MD
p14021
aVVSTOR30 - required when you used VSTO
p14022
aVWindowsInstaller3_1 - installs MSI 3
p14023
aV1 (don't ask)
p14024
aVMaking sure that
p14025
aVNET is installed isn't really necessary anymore today
p14026
aVThe rest of them might however be required, even if this is a CO install
p14027
aVI think a Setup project can autodetect them reliably
p14028
as(dp14029
g9
V17034
p14030
stp14031
a((dp14032
g2
(lp14033
VRecursively searching all drives for particular files is not going to work well
p14034
aVIt will take about a minute to do so with today's large drives
p14035
aVOne standard trick, used by Windows Explorer, is to only list the top level directories and files
p14036
aVIt puts a dummy node in a directory node
p14037
aVWhen the user opens the node (BeforeExpand event), it searches only that directory and replaces the dummy node with the directories and files found it that directory
p14038
aVAgain putting a dummy node in the directories
p14039
aVEtcetera
p14040
aVYou can see this at work by adding an empty subdirectory
p14041
aVThe directory node will be shown with the + glyph
p14042
aVWhen you open it, Explorer discovers that there are no directory or files to be listed and deletes the dummy node
p14043
aVThe + glyph disappears
p14044
aVThis is very fast, listing the content of a single directory takes well less than a second
p14045
aVThere's a problem however using this approach in your case
p14046
aVThe odds that a directory contains a suitable music file are small
p14047
aVThe user will constantly be frustrated by finding out that the navigating through a set of subdirectories produces nothing
p14048
aVThat's why Windows has a dedicated place to store specific media files
p14049
aVMy Music in this case
p14050
aVUse Environment
p14051
aVGetFolderPath(Environment
p14052
aVSpecialFolder
p14053
aVMyMusic) to find it
p14054
aVIterating it should not take long
p14055
as(dp14056
g9
V17034
p14057
stp14058
a((dp14059
g2
(lp14060
VShell programming like this is invariably hard to do
p14061
aVYou'll have a fighting chance on this one though, shell32
p14062
aVdll has an automation interface that's callable from COM clients
p14063
aVThe ShellFolderItem::ExtendedProperty property makes them available
p14064
aVYou'll need a WPF or Windows Forms project so that COM is properly initialized
p14065
aVUse Project + Add Reference, Browse tab, select c:\u005cwindows\u005csystem32\u005cshell32
p14066
aVdll
p14067
aVThis sample code reads the Author property of the c:\u005ctemp\u005ctest
p14068
aVtxt file:
p14069
aVThe property ID (PID) values that you can use are documented in this SDK article
p14070
as(dp14071
g9
V17034
p14072
stp14073
a((dp14074
g2
(lp14075
VIt isn't clear to me why you couldn't just solve this by explicitly calling a component's method from the form's Load event handler
p14076
aVMaking a component aware of the form on which it is dropped is possible
p14077
aVThe designer can be coaxed to initialize a property of the component to the form instance
p14078
aVThis is a technique used by ErrorProvider for example, it paints the error icons on the form
p14079
aVThis could then be extended to let the component subscribe to the form's Load event
p14080
aVHere is an example:
p14081
as(dp14082
g9
V17034
p14083
stp14084
a((dp14085
g2
(lp14086
VGIF was a bad choice, it can only render images with 256 colors
p14087
aVYou need all the colors you can get to make the anti-aliasing work properly
p14088
aVUse PNG
p14089
aVYou will also need to make sure that the background color of the container is the same as the one you used in Photoshop, the anti-aliasing pixels will otherwise have the wrong colors
p14090
aVAnd you cannot stretch the image, that will also stretch the anti-aliasing pixels, ruining the effect
p14091
as(dp14092
g9
V17034
p14093
stp14094
a((dp14095
g2
(lp14096
VTough question, I don't see anything added to the latest Windows SDK that could fit the "Main Instruction" color
p14097
aVThe only one that is a decent match (name and color) is Highlight
p14098
as(dp14099
g9
V17034
p14100
stp14101
a((dp14102
g2
(lp14103
VThe DateTime
p14104
aVToLocalTime() method is available on CF, no need to jump through hoops
p14105
aVDo make sure to use a DateTime constructor that takes a DateTimeKind argument so you can tell it that it's a UTC time, if necessary
p14106
as(dp14107
g9
V17034
p14108
stp14109
a((dp14110
g2
(lp14111
VYou can do it with GDI+ ()
p14112
aVThe Graphics class has the RotateTransform method
p14113
aVThat allows arbitrary rotations
p14114
aVUse Image::RotateFlip() if you only need to rotate by 90 degree increments, that's a lot more efficient
p14115
as(dp14116
g9
V17034
p14117
stp14118
a((dp14119
g2
(lp14120
VYes, you really ought to use a Setting
p14121
aVProject + Properties, Settings tab
p14122
aVAdd one: Name = Option1Checked, Type = bool, Scope = user, Value = false
p14123
aVIn your form's Load event, you'd write:
p14124
aVAnd in the FormClosing event, you'd write:
p14125
as(dp14126
g9
V17034
p14127
stp14128
a((dp14129
g2
(lp14130
VThis hasn't been true for any kind of mainstream operating system for a long time
p14131
aVThe OS ensures that all kernel resources are released, even if the program didn't explicitly do so
p14132
aVCalling abort() or exit() from anywhere in your code is fine
p14133
as(dp14134
g9
V17034
p14135
stp14136
a((dp14137
g2
(lp14138
VNo
p14139
aVA managed
p14140
aVexe requires a Main() method
p14141
as(dp14142
g9
V17034
p14143
stp14144
a((dp14145
g2
(lp14146
VI would guestimate the conversion rate of a really skilled hacker at about 1 kilobyte of machine code per day
p14147
aVAt common Western salaries, that puts the price of, say, a 100 KB executable at about $25,000
p14148
aVAfter spending that much money, all that's gained is a chunk of C code that does exactly what yours does, minus the benefit of comments and whatnot
p14149
aVIt is no way competitive with your version, you'll be able to deliver updates and improvements much quicker
p14150
aVReverse engineering those updates is a non trivial effort as well
p14151
aVIf that price tag doesn't impress you, you can arbitrarily raise the conversion cost by adding more code
p14152
aVJust keep in mind that skilled hackers that can tackle large programs like this have something much better to do
p14153
aVThey write their own code
p14154
as(dp14155
g9
V17034
p14156
stp14157
a((dp14158
g2
(lp14159
VCOM marshals calls to your server through the message loop
p14160
aVYou can get into re-entrancy hell with the COM modal loop
p14161
aVThat loop takes care of outgoing calls that need to be marshaled back to the client thread
p14162
aVLike events
p14163
aVOr calls your server makes to another server that's in a different STA apartment
p14164
aVWhile the modal loop pumps messages, waiting for the outgoing call to be completed, it can pick up incoming calls, just like the regular message loop
p14165
aVTechnically, re-entrancy can also happen when your server is trying to keep a UI alive by pumping messages itself
p14166
aVYes, this can be very hard to deal with
p14167
aVI'm not aware of any magic fix for this, and I've been looking hard for quite a while
p14168
aVI also looked at IMessageFilter and concluded it was useless to solve this problem
p14169
as(dp14170
g9
V17034
p14171
stp14172
a((dp14173
g2
(lp14174
VPossible reasons are that you forgot to register the "MyWindow" window class with RegisterClass/Ex(), didn't set the window procedure correctly or don't properly handle the WM_CREATE message
p14175
aVAlso, your P/Invoke declaration is wrong, it won't work on 64-bit operating systems
p14176
aVDon't write this kind of code yourself, Windows Forms is a very nice wrapper around CreateWindowEx()
p14177
as(dp14178
g9
V17034
p14179
stp14180
a((dp14181
g2
(lp14182
VYou are making it kinda hard on yourself by putting the lambda in its own method
p14183
aVIt gets to be a lot easier if you write it inline
p14184
aVSomething like this:
p14185
as(dp14186
g9
V17034
p14187
stp14188
a((dp14189
g2
(lp14190
VIt isn't that clear what's going on here
p14191
aVGetting multiple UpdateProgress calls on the UI thread for one UpdateProgress call on the worker thread is definitely bad
p14192
aVYour code as posted should not do this
p14193
aVBut, yes, the Post() call is not particularly fast
p14194
aVIt takes roughly a millisecond for the message loop on the UI thread to pick up the notification, assuming it is not busy doing something else
p14195
aVThis is not one millisecond of hard CPU work, it is a delay induced by the Windows plumbing that handles GetMessage()
p14196
aVThe thread context switch is part of it, but just a small part
p14197
aVThis can have notable nasty side-effects
p14198
aVCalling Post() too often, or having the posted delegate doing too much hard work, can seriously affect the UI thread
p14199
aVTo the point that it doesn't get around its regular duties anymore
p14200
aVBecause of the delay, you can get there quickly; it only takes 1000 posts per second
p14201
aVOf course, it is never necessary to post that often, the human eye cannot perceive updates at a rate any faster than about 25 per second
p14202
aVDoing it more frequently is just wasted effort
p14203
aVBut obtaining this ideal update rate is not particularly easy to achieve, unless the worker thread pays specific attention to elapsed time
p14204
aVAnyhoo, it is better to leave it up to the client code to tell you how it wants its notifications marshaled
p14205
aVThe FileSystemWatcher
p14206
aVSynchronizingObject is a good example of that
p14207
aVIf Post() falls apart, that's one way for the client code to fix the problem
p14208
aVAlso take a look at the BackgroundWorker class
p14209
as(dp14210
g9
V17034
p14211
stp14212
a((dp14213
g2
(lp14214
VClearly the mString member contains a garbage pointer
p14215
aVJudging from the call stack, you'll need help from the SubversionSharp team
p14216
aVOr find out somehow why it is trying to handle a Subversion error
p14217
aVThe last post at their web site dates from 2006, "We're not dead
p14218
aVTheir forum server looks pretty dead to me though
p14219
aVGood luck
p14220
as(dp14221
g9
V17034
p14222
stp14223
a((dp14224
g2
(lp14225
VI think you want to use DTE
p14226
aVLocaleID, that's what other add-ins use to find their resource DLLs
p14227
as(dp14228
g9
V17034
p14229
stp14230
a((dp14231
g2
(lp14232
VNo, the HtmlHelp API function is far too primitive to support enumerating topics
p14233
aVYou could use the 7-zip file manager to look inside the
p14234
aVchm file
p14235
aVRight-click the file and choose "Open Inside"
p14236
aVOr use the help authoring tool that was used
p14237
as(dp14238
g9
V17034
p14239
stp14240
a((dp14241
g2
(lp14242
VI think the description is misleading
p14243
aVPractically all virtual memory pages in a process are pageable
p14244
aVBut they don't necessarily end up in the paging file
p14245
aVAny code that's loaded from DLLs doesn't have to be stored there
p14246
aVThe memory manager simply discards the page when it needs room, it reloads it from the DLL when it needs to be swapped back in
p14247
aVIn a
p14248
aVNET process, that will at least be the pages mapped for the code for the CLR, JIT compiler and any Ngen-ed assemblies
p14249
aVAll the
p14250
aVNET framework assemblies are Ngen-ed
p14251
aVThe paging file will be used for the rest, any JIT-compiled code and data
p14252
aVThis number is not going to be helpful to diagnose leaks
p14253
aVIt constantly changes, there's nothing you would do to make the memory manager directly decide to swap out a page
p14254
aVOther perhaps than minimizing your program's main window, that triggers the memory manager to aggressively trim the working set (= number of pages resident in RAM)
p14255
aVGet a good memory profiler to get ahead
p14256
as(dp14257
g9
V17034
p14258
stp14259
a((dp14260
g2
(lp14261
VStart + Control Panel, System, Advanced, Environment variables
p14262
aVSelect Path in the System variables section, Edit
p14263
aVAt the very least it should look like this:
p14264
aVAsk more questions about this at superuser
p14265
aVcom
p14266
as(dp14267
g9
V17034
p14268
stp14269
a((dp14270
g2
(lp14271
VThis is almost always easy to debug
p14272
aVWhen you see the worker thread ignoring the cancel request, use Debug + Break All
p14273
aVThen Debug + Windows + Threads and double-click the worker thread
p14274
aVThen look at the call stack to see what the thread is doing and why it doesn't pass through the code that checks the flag
p14275
aVBeware that you have to declare the flag member with the volatile keyword
p14276
aVThis prevents the JIT compiler from generating machine code that loads the member value in a register and never checking the actual variable value in memory
p14277
aVWhich is liable to happen when you run the Release version of your program without a debugger
p14278
aVIn that case, be sure to use Tools + Attach to Process to attach the debugger before you use the Break All command
p14279
aVA ManualResetEvent, checked with a WaitOne(0) call is better
p14280
as(dp14281
g9
V17034
p14282
stp14283
a((dp14284
g2
(lp14285
VThe SO version is the accurate one, for the pure sake of accuracy you should use it
p14286
aVFwiw, the AttributeTarget
p14287
aVMethod specifier is crystal clear
p14288
aVClass and Assembly less so
p14289
aVBoth the C# and the VB
p14290
aVNET compiler emit the attribute on the static class / Module that contains the extension method
p14291
aVAnd on the assembly that contains the class / Module
p14292
aVWhy they do this is less crystal clear, it wouldn't be needed to properly compile them
p14293
aVI'm guessing this is an optimization at work, helping both the compiler and IntelliSense discover when an extension method should be considered
p14294
aVGetting the attribute applied to the assembly is actually a problem
p14295
aVThat won't work right when you compile code to
p14296
aVnetmodules
p14297
aVBut that's a very obscure issue
p14298
as(dp14299
g9
V17034
p14300
stp14301
a((dp14302
g2
(lp14303
VYour question is quite unclear
p14304
aVWild stab at it: you lose all formatting when you assign the Text property
p14305
aVBe sure to use AppendText() instead
p14306
aVAnd to set the SelectionColor and SelectionBackColor properties back to what it was after colorizing any text so that newly entered text gets the preferred default colors
p14307
as(dp14308
g9
V17034
p14309
stp14310
a((dp14311
g2
(lp14312
VWell, you're quite right to have second thoughts about this
p14313
aVWhat's probably the toughest read possible, War and Peace by Tolstoy, has roughly half a million words
p14314
aVWhat you're dumping to the screen is a hundred times more
p14315
aVIt doesn't really matter how long it takes to put this much info on the screen, it will take your user a wholeheckofalot longer to even scroll through it
p14316
aVI personally hesitate to ever put anything more than, oh, 50 items in a list
p14317
aV100 tops
p14318
aVBeyond that, it becomes sheer torture for a human being
p14319
aVTo get there, allow your user to filter content, gradually drilling down in the huge result set to a relevant item
p14320
aVExactly what that ought to look like is not clear from your question
p14321
aVThink about it for a bit, I'm sure you'll come up with something
p14322
as(dp14323
g9
V17034
p14324
stp14325
a((dp14326
g2
(lp14327
VNo can do
p14328
aVIt is a much harder task than matching braces
p14329
aVFinding the matching NEXT keyword requires syntax parsing
p14330
aVBraces can be matched by merely tokenizing the text
p14331
aVI'd recommend you put in a feature request at connect
p14332
aVmicrosoft
p14333
aVcom, it is a good request
p14334
as(dp14335
g9
V17034
p14336
stp14337
a((dp14338
g2
(lp14339
VAbsolutely
p14340
aVPUSHA followed by RET is never correct, the return address will be junk
p14341
aVSeeing ADD AL,[EAX] in your disassembly is another dead give away, that's the disassembly for 0
p14342
aVIn other words: you are disassembling data, not code
p14343
aVYour program bombed because it was executing data
p14344
aVThe classic way that happens is corrupting a stack frame with a buffer overflow
p14345
aVWhen the function returns it pops an invalid return address from the corrupted stack and jumps into never never land
p14346
aVNot getting a seg fault is very unlucky
p14347
aVHard to debug, the stack trace is junked
p14348
aVYou'll need to set a breakpoint at the last known good code address and start single stepping
p14349
aVThe last good function you stepped into just before it bombs is typically the trouble maker
p14350
as(dp14351
g9
V17034
p14352
stp14353
a((dp14354
g2
(lp14355
VWell, that's normal
p14356
aVThe Receive() method won't return until the server sends something else
p14357
aVWhich it probably doesn't do in your case until you ask it to send something else first
p14358
aVYou should only call Receive() again if you didn't get the full server response
p14359
aVCheck the protocol specification
p14360
aVA server usually sends something that lets you tell that the full response was received
p14361
aVLike the number of bytes in the message
p14362
aVOr a special character at the end of the message
p14363
aVLinefeed (vbLf) is popular
p14364
as(dp14365
g9
V17034
p14366
stp14367
a((dp14368
g2
(lp14369
VCopied from an old C++ program I wrote a long time ago, it still runs at dozens of places:
p14370
aVacos() is the same as Math
p14371
aVAcos()
p14372
as(dp14373
g9
V17034
p14374
stp14375
a((dp14376
g2
(lp14377
VYou'll get the linker error when you wrote the class like this:
p14378
aVlolbutton
p14379
aVh:
p14380
aVYou won't get it when you write it like this:
p14381
aVFix the linker error by moving the destructor definition from the
p14382
aVh file to a
p14383
aVcpp file
p14384
aVThis ensures there is only one definition of the destructor
p14385
as(dp14386
g9
V17034
p14387
stp14388
a((dp14389
g2
(lp14390
VYou are confusing the delegate type declaration with the instance of the delegate
p14391
aVYes, you made your delegate declaration public, that was wrong
p14392
aVOnly the Form1 class uses it, it should be private
p14393
aVIt is the instance of the delegate that matters here, the one you created with the new statement
p14394
aVRight now, you are storing the instance in a local variable of the Form1 constructor
p14395
aVThat keeps a reference on the instance for a few microseconds
p14396
aVAs soon as the constructor completes, that reference is gone and the garbage collector can collect the delegate instance at any point after that
p14397
aVIt cannot see that the unmanaged code keeps a reference to it, the collector can only discover references held by managed code
p14398
aVNothing good happens when the unmanaged code calls the callback on a collected delegate instance, you'll hear a loud kaboom
p14399
aVYou must change your code so that there will be a managed reference to the instance
p14400
aVOne easy way to do this is to add a private member to the Form1 class to store the instance
p14401
aVEven that might not be good enough, the Form1 object will be garbage collected at some point in the future as well
p14402
aVWhich collects the delegate object as well
p14403
aVYou also must make sure that the unmanaged code cannot use the callback after that happens
p14404
aVGiven the name of the class (Form1), that isn't that likely to happen in this specific case
p14405
aVBut code defensively and make a call that resets the callback in the form's FormClosing event handler
p14406
as(dp14407
g9
V17034
p14408
stp14409
a((dp14410
g2
(lp14411
VIt is permitted in MSVC with the deprecated /Ze (extensions enabled) option
p14412
aVIt was allowed in previous versions of MSVC
p14413
aVIt generates a diagnostic with all warnings enabled:
p14414
aVwarning C4238: nonstandard extension used : class rvalue used as lvalue
p14415
aVUnless the /Za option is used (enforce ANSI compatibility), then:
p14416
aVerror C2102: '&' requires l-value
p14417
as(dp14418
g9
V17034
p14419
stp14420
a((dp14421
g2
(lp14422
VWindows does not provide a direct way to generate any kind of notification when a process is about to start
p14423
aVYou can find out it got started, as shown in my post with the WMI code
p14424
aVTechnically it is possible to inject a DLL into all running processes and detour the CreateProcess() API call
p14425
aVShort from this being potentially very destabilizing, it is also impossible to write code like that in C# language
p14426
aVYou can't get the CLR initialized
p14427
aVIt isn't any kind of oversight that this kind of functionality isn't available
p14428
aVIt would be a rather easily exploitable security hole
p14429
as(dp14430
g9
V17034
p14431
stp14432
a((dp14433
g2
(lp14434
VThe  macro is pre-defined in the MSVC compiler
p14435
aVYou'll need to make it look like this:
p14436
aVOr the other way around, if you prefer:
p14437
as(dp14438
g9
V17034
p14439
stp14440
a((dp14441
g2
(lp14442
VI'll work from the assumption that you use Assembly
p14443
aVLoadFile()
p14444
aVReflection cannot really get you into trouble, it needs an Assembly reference to get the ball rolling
p14445
aVYour code is in control when it decides what Assembly reference to use
p14446
aVClearly, you'll need the one you got from a previous call to LoadFile() if you'd want to load a type from the old version
p14447
aVThe LoadFile() call cannot otherwise mess up any other assembly resolves, the assembly is loaded without a loading context
p14448
as(dp14449
g9
V17034
p14450
stp14451
a((dp14452
g2
(lp14453
VYou can easily see it from the Fuslogvw
p14454
aVexe tool
p14455
aVStart it from the Visual Studio Command Prompt
p14456
aVConfigure it with Log Categories = Native Images, Settings + Log all binds to disk
p14457
aVRun your program
p14458
aVBack to fuslogvw, Refresh
p14459
aVIt will show you a list of all assemblies that got loaded
p14460
aVDouble-click an entry to see how the assembly got loaded
p14461
aVIf it came from the GAC, you'll see:
p14462
aVLOG: IL assembly loaded from C:\u005cWindows\u005cassembly\u005cGAC_MSIL\u005cblahblah
p14463
aVIf the Ngen-ed images was used, you'll see:
p14464
aVLOG: Bind to native image succeeded
p14465
as(dp14466
g9
V17034
p14467
stp14468
a((dp14469
g2
(lp14470
VYou will need to write an event handler for the AppDomain
p14471
aVUnhandledException event
p14472
aVLog the value of e
p14473
aVExceptionObject
p14474
aVToString()
p14475
aVThat will include the exception message and a stack trace that shows you how your code got into trouble
p14476
as(dp14477
g9
V17034
p14478
stp14479
a((dp14480
g2
(lp14481
VUse the SpeakAsync() method instead
p14482
aVThat prevents the UI from blocking on the Speak() method, it cannot respond to button clicks while it is blocked
p14483
aVYou can use SpeakAsyncCancelAll() to stop it from nattering on
p14484
as(dp14485
g9
V17034
p14486
stp14487
a((dp14488
g2
(lp14489
VI looked at SharpBITS about a year ago
p14490
aVI remember seeing a Big Bug back then which would make it unsuitable on 64-bit operating systems
p14491
aVCan't remember the exact bug, probably a bad P/Invoke declaration
p14492
aVThis code snippet is definitely wrong:
p14493
aVAn IntPtr cannot be cast to an int in x64 mode
p14494
aVIt must look like this:
p14495
aVOr much better:
p14496
aVI'd strongly recommend you force your app to run in 32-bit mode if you use this library to avoid these problems
p14497
aVProject + Properties, Build tab, Platform Target = x86
p14498
aVYou can notify the author here
p14499
as(dp14500
g9
V17034
p14501
stp14502
a((dp14503
g2
(lp14504
VWell, it is safe, just inefficient
p14505
aVThe compiler will generate a call to the default constructor
p14506
aVWrite it like this instead to avoid that:
p14507
as(dp14508
g9
V17034
p14509
stp14510
a((dp14511
g2
(lp14512
VThat's a pretty gross version mismatch
p14513
aVbindingRedirect is not going to help when the versions differ so much
p14514
aVYou got it wrong btw, you'd want newVersion to match the one that was found
p14515
aVBut don't go there
p14516
aVLooking at the Migrator
p14517
aVNET download, I think I see the problem
p14518
aVThe lib folder contains a really old version of MySql
p14519
aVData
p14520
aVdll, it was made to run on
p14521
aVNET 1
p14522
ag2512
aVStart by zapping it and try to rebuild with version 6 of that assembly
p14523
aVGood luck, I think you'll need it
p14524
as(dp14525
g9
V17034
p14526
stp14527
a((dp14528
g2
(lp14529
VYou will have to call Application
p14530
aVRun() in your Main() method to get the Windows Forms synchronziation machinery in place so that FileSystemWatcher can properly marshal the call to the main thread
p14531
aVThe problem you'll have then is that the main form will become visible
p14532
aVFix that by pasting this code into the class:
p14533
aVThere are no restrictions on what your form looks like if you do this
p14534
as(dp14535
g9
V17034
p14536
stp14537
a((dp14538
g2
(lp14539
VSure, no problem
p14540
aVAs long as you got the
p14541
aVpdb file
p14542
aVThe debugging experience isn't as rich, you'll frequently be unable to inspect local variables and single-stepping behaves odd at times
p14543
as(dp14544
g9
V17034
p14545
stp14546
a((dp14547
g2
(lp14548
VUse a callback instead of directly calling EndInvoke:
p14549
aVBtw: it looks to me like you are already calling this code from a background thread
p14550
aVStarting yet another thread to run FindRoot() looks strange
p14551
as(dp14552
g9
V17034
p14553
stp14554
a((dp14555
g2
(lp14556
VThe AxFoo
p14557
aVdll assembly contains an automatically generated class that's derived from the System
p14558
aVWindows
p14559
aVForms
p14560
aVAxHost control
p14561
aVIt is pretty simple, it has methods, properties and events, the same ones you have available in the
p14562
aVocx, that simply call the Foo
p14563
aVdll interop library
p14564
aVSo, yes, you definitely need to deploy both assemblies
p14565
as(dp14566
g9
V17034
p14567
stp14568
a((dp14569
g2
(lp14570
VYou'll have to use an installer to get the font registered on the target machine
p14571
aVBut maybe you won't have to, GDI+ supports private fonts
p14572
as(dp14573
g9
V17034
p14574
stp14575
a((dp14576
g2
(lp14577
VThe server is not configured correctly
p14578
aVControl Panel + Region and Language, Location tab
p14579
aVChanging this could be a bit tricky
p14580
aVThe server may well have been mis-configured on purpose
p14581
aVTalk to the server administrator first before doing anything
p14582
aVYour fallback plan is to use the DateTime
p14583
aVTryParse() method overload that takes the IFormatProvider argument
p14584
aVPass CultureInfo
p14585
aVGetCultureInfo("en-gb")
p14586
aVDateTimeFormat
p14587
as(dp14588
g9
V17034
p14589
stp14590
a((dp14591
g2
(lp14592
VYou can easily fake it
p14593
aVEnsure that the list view items you add have UseItemStyleForSubItems = false so that you can set the sub-item's ForeColor to blue
p14594
aVImplement the MouseMove event so you can underline the "link" and change the cursor
p14595
aVFor example:
p14596
aVNote that this snippet checks if the 2nd column is hovered, tweak as needed
p14597
as(dp14598
g9
V17034
p14599
stp14600
a((dp14601
g2
(lp14602
VIt is not a COM error, it is a Windows error reported by a COM component
p14603
aVYou can tell from the facility code, 7 = Windows API
p14604
aVWindows error 0x12 is ERROR_NO_MORE_FILES, but you already knew that
p14605
aVThe most common usage is in the FindFirstFile and FindNextFile API functions, used to indicate that there are no more files left to enumerate
p14606
aVSeeing this reported as an error is a programming bug, it is normal that there are no more files left to enumerate
p14607
aVYou'll need to find out where that bug is located, can't help you with that
p14608
as(dp14609
g9
V17034
p14610
stp14611
a((dp14612
g2
(lp14613
VCall the operating system's process terminate function
p14614
aVTerminateProcess() on Windows
p14615
as(dp14616
g9
V17034
p14617
stp14618
a((dp14619
g2
(lp14620
VThis will always work, regardless of proper event handler assignment, KeyPreview, CancelButton etc:
p14621
as(dp14622
g9
V17034
p14623
stp14624
a((dp14625
g2
(lp14626
VUse the HtmlElement
p14627
aVInvokeMember() method
p14628
aVHere's an example that clicks the Google home page "I feel lucky" button:
p14629
as(dp14630
g9
V17034
p14631
stp14632
a((dp14633
g2
(lp14634
VGMT does not adjust for Daylight saving time (DST)
p14635
aVYou can hear it from the horse's mouth on this web site
p14636
aVAdd this line of code to see the source of the problem:
p14637
aVOutput: True
p14638
aVThis is not a
p14639
aVNET problem, it is Windows messing up
p14640
aVThe registry key that TimeZoneInfo uses is HKLM\u005cSOFTWARE\u005cMicrosoft\u005cWindows NT\u005cCurrentVersion\u005cTime Zones\u005cGMT Standard Time
p14641
aVYou'd better stick with UTC
p14642
as(dp14643
g9
V17034
p14644
stp14645
a((dp14646
g2
(lp14647
VIt isn't very clear from your snippet how the all-important Init() method is called and how the thread got started
p14648
aVClearly, the thread on which the COM object is created is not the same thread as the one where the SomeMethod() call is made
p14649
aVFurther assuming that the COM server is apartment threaded, COM needs to marshal the SomeMethod() call to the thread that created the object
p14650
aVThe one that called Init()
p14651
aVIf that thread is no longer running, hilarity ensues
p14652
aVThere's one glaring problem, you forgot to call Thread
p14653
aVSetApartmentState()
p14654
aVGiven that COM already marshals inter-thread calls, you are probably not gaining anything by starting your own thread
p14655
aVYou can't magically make a COM server multi-threaded if it refuses to support it
p14656
as(dp14657
g9
V17034
p14658
stp14659
a((dp14660
g2
(lp14661
VChapter 5
p14662
aV3 of the C# Language Specification discusses this
p14663
aVIt is a beefy chapter, but it sure looks to me that the compiler should also have emitted an error for the unassigned "currency" variable
p14664
aVIt gets interesting if you comment out the if() statement and block, now the compiler suddenly wises up
p14665
aVEven though "currency" was never used in the commented code
p14666
aVThat can't be right, I think you found a bug
p14667
aVIf Eric Lippert doesn't pass by, you can report the bug at connect
p14668
aVmicrosoft
p14669
aVcom
p14670
as(dp14671
g9
V17034
p14672
stp14673
a((dp14674
g2
(lp14675
VLooks okay, although the approach is strange
p14676
aVBut use Encoding
p14677
aVASCII
p14678
aVGetBytes() to convert the base64 string to byte[]
p14679
aVBase64 encoding only contains ASCII characters
p14680
aVUsing Unicode gets you an extra 0 byte for each character
p14681
as(dp14682
g9
V17034
p14683
stp14684
a((dp14685
g2
(lp14686
VUnusual requirement
p14687
aVBut it can be done
p14688
aVAdd a new project to your solution, use the Visual C++ > General > Makefile Project template
p14689
aVSet its NMake > Build Command Line setting to the commands you want to execute
p14690
aVUse Project > Project Dependencies to make all other projects depend on it
p14691
as(dp14692
g9
V17034
p14693
stp14694
a((dp14695
g2
(lp14696
VVisual Basic uses the SHFileOperation() API function to display the dialog
p14697
aVI think you can call it yourself and customize it the way you want by specifying the FOF_FILESONLY flag for the SHFILEOPSTRUCT
p14698
aVfFlags member
p14699
aVThe P/Invoke is gritty, visit pinvoke
p14700
aVnet for the declarations
p14701
as(dp14702
g9
V17034
p14703
stp14704
a((dp14705
g2
(lp14706
VIt is a deployment detail
p14707
aVThere are a few cases where you have to put an interface type in its own assembly
p14708
aVDefinitely when using them in plug-in development or any other kind of code that runs in multiple AppDomains
p14709
aVAlmost definitely when Remoting or any other kind of connected architecture
p14710
aVBeyond that, it doesn't matter so much anymore
p14711
aVAn interface type is just like another class, you can add an assembly reference if you need it in another project
p14712
aVKeeping them separate can help controlling versioning
p14713
aVIt is a good idea to keep them separate if a change in an interface type can lead to wide-spread changes in the classes that implement them
p14714
aVThe act of changing the [AssemblyVersion] when you do so now helps troubleshooting deployment issues where you forgot to update a client assembly
p14715
as(dp14716
g9
V17034
p14717
stp14718
a((dp14719
g2
(lp14720
VVB
p14721
aVNET version 9 acquired type inference
p14722
aVPreviously your Dim declaration was untyped, serviceArray was of type Object
p14723
aVNow, the compiler inferred from your previous usage that serviceArray is of type Service
p14724
aVUsing the same variable to store different objects is fishy
p14725
as(dp14726
g9
V17034
p14727
stp14728
a((dp14729
g2
(lp14730
VButtonRenderer uses VisualStyleRenderer
p14731
aVDrawBackground() to draw the button background
p14732
aVThat method is very much aware of the user selected theme, the button's background will use the colors specified by the theme
p14733
aVUsing a non-standard BackColor would violate the user selected theme
p14734
aVYou can't have it both ways
p14735
aVThe Button class doesn't actually use ButtonRenderer, it uses one of three renderers derived from the internal ButtonBaseAdapter class in the System
p14736
aVWindows
p14737
aVForms
p14738
aVButtonInternal namespace
p14739
aVThese renderers are internal, you can't use them in your own code
p14740
aVTake a look at them with Reflector or the Reference Source to see what it takes
p14741
aVFocus on the PaintButtonBackground method
p14742
as(dp14743
g9
V17034
p14744
stp14745
a((dp14746
g2
(lp14747
VProbably because you don't have the correct
p14748
aVpdb files
p14749
aVOr because your code has been put through the optimizer's version of RSA encryption
p14750
aVOr because you've got the x64 build where pointers are passed in registers
p14751
aVOr because your code crashed due to heap corruption, making the debug info equally unreliable
p14752
aVOr the stack of the crashing thread is blown, leaving no bread crumbs to track
p14753
aVTake your pick
p14754
as(dp14755
g9
V17034
p14756
stp14757
a((dp14758
g2
(lp14759
VSample code:
p14760
aVCondition: myvar == "bar"
p14761
aVWorks well
p14762
as(dp14763
g9
V17034
p14764
stp14765
a((dp14766
g2
(lp14767
VYou are looking at the wrong memory diagnostic if you see it decrease significantly when you minimize the app's main window
p14768
aVThat's the working set, the amount of virtual memory that's mapped to RAM
p14769
aVWorking set is always variable, it largely depends what other processes are running and need to have their own pages mapped to RAM
p14770
aVAn app bombs on OOM when it runs out of free virtual memory, an entirely different number
p14771
aVYes, use a good memory profiler to avoid making conclusions that don't help you diagnose the problem
p14772
as(dp14773
g9
V17034
p14774
stp14775
a((dp14776
g2
(lp14777
VThere's nothing wrong with using #include in a header file
p14778
aVIt is a very common practice, you don't want to burden a user a library with also remembering what other obscure headers are needed
p14779
aVA standard example is
p14780
aVGets you the vector class
p14781
aVAnd a raft of internal CRT header files that are needed to compile the vector class properly, stuff you really don't need nor want to know about
p14782
as(dp14783
g9
V17034
p14784
stp14785
a((dp14786
g2
(lp14787
VUsing "ref" is the correct way, get rid of the [MarshalAs] attribute
p14788
aVThe real problem is almost certainly the structure declaration
p14789
aVYou didn't post anything that would help us help you with that
p14790
aVThe DllImportAttribute
p14791
aVCharSet property is wrong, make it CharSet
p14792
aVAnsi
p14793
aVThe "var" member is declared wrong, make it byte[]
p14794
aVBe sure to initialize it before the call:
p14795
aVBest guess, hope it works
p14796
as(dp14797
g9
V17034
p14798
stp14799
a((dp14800
g2
(lp14801
VThere are typically at least two data sections
p14802
aVOne with initialized globals, another without (BSS)
p14803
aVA stack section isn't typically emitted in the binary
p14804
aVOf course, these kind of very implementation specific questions are kinda useless if you don't specify the implementation
p14805
as(dp14806
g9
V17034
p14807
stp14808
a((dp14809
g2
(lp14810
VThe System
p14811
aVIO
p14812
aVFileStream class is a highly suitable replacement
p14813
aVIts constructor calls CreateFile(), its Read method calls ReadFile(), its Write method calls WriteFile()
p14814
aVYou should have little trouble matching the FileAcces, FileMode and FileShare enums to the corresponding CreateFile() arguments
p14815
aVYou will however have to P/Invoke the SetupAPI functions
p14816
as(dp14817
g9
V17034
p14818
stp14819
a((dp14820
g2
(lp14821
VThey have a lot in common, they are both derived from ContainerControl
p14822
aVUserControl however is designed to be a child window, it needs to be placed in a container
p14823
aVForm was designed to be a top-level window without a parent
p14824
aVYou can actually turn a Form into a child window by setting its TopLevel property to false:
p14825
as(dp14826
g9
V17034
p14827
stp14828
a((dp14829
g2
(lp14830
VYou don't have to do anything special to make this work
p14831
aVFirst try to open the file with FileAccess
p14832
aVReadWrite and FileShare
p14833
aVRead
p14834
aVIf you don't get an IOException, you'll have exclusive write access to the file
p14835
aVOther processes can read from the file but can never gain write access
p14836
aVIf that open attempt fails, you can assume that somebody else already has the file open for writing
p14837
aVNow switch your internal program logic to "read-only" mode and open the file with FileAccess
p14838
aVRead and FileShare
p14839
aVReadWrite
p14840
aVIf that still bombs then there's something fundamentally wrong with the file, the IOException tells you what
p14841
aVBe very careful to avoid an "is the file locked" test
p14842
aVThat can't work reliably on a network, you have to keep the file opened after gaining access to it
p14843
aVAs soon as you close it, another process can gain access to it, a nanosecond later
p14844
aVAnother typical problem with this kind of locking is that the user typically wants to know who's got a lock on the file
p14845
aVWindows doesn't provide any standard way to find out
p14846
aVOffice deals with this by creating a hidden file in the same directory with the same name as the file but another filename extension
p14847
aVIt writes the name of the user in this file, available to any process that finds the file locked
p14848
aVYou can do the same, Environment
p14849
aVUserName would be good for that
p14850
as(dp14851
g9
V17034
p14852
stp14853
a((dp14854
g2
(lp14855
VYes, the VB
p14856
aVNET compiler treats identifiers in a case insensitive way
p14857
aVAnd yes, that can cause problems when it consumes assemblies that were written in another language or uses COM components
p14858
aVThe former case is covered by the Common Language Specification
p14859
aVThe relevant rule is:
p14860
aVFor two identifiers to be considered
p14861
aVdistinct, they must differ by more
p14862
aVthan just their case
p14863
aVThe COM case is rather crudely taken care of by the type library builder, it forces the casing of identifiers with the same name to be identical
p14864
aVEven when those identifiers have different roles
p14865
aVIn other words, a method parameter with the name "index" will force a method name "Index" to be recased to "index"
p14866
aVThat has produced rather a lot of head scratching, as you might imagine :)
p14867
as(dp14868
g9
V17034
p14869
stp14870
a((dp14871
g2
(lp14872
VI'm not exactly sure what kind of errors you are talking about, I'll assume they are the ones that the IntelliSense parser generates
p14873
aVYes, that parser isn't very reliable
p14874
aVIt is not meant to be a full-blown C# parser, it was optimized to do a very different kind of job: providing context-sensitive help even if the code is incomplete and cannot compile
p14875
aVThere isn't anything you can do to make it more reliable, other than waiting for the next VS release perhaps
p14876
aVBut it strikes me that you might be trying to fix the wrong problem
p14877
aVThe key issue is that your add-in appears to be removing using directives that should not be removed
p14878
aVA real fix is to improve your code analysis engine so it reliably detects true namespace dependencies
p14879
aVTrying to guess which ones matter from hoping that IntelliSense is going to complain is only going to frustrate your customer
p14880
as(dp14881
g9
V17034
p14882
stp14883
a((dp14884
g2
(lp14885
VFirst off, setting Platform Target to x86 on your
p14886
aVexe project is a very useful when you are debugging your project on a 64-bit version of Windows
p14887
aVThe VS2005/8 debugger doesn't support Edit + Continue on 64-bit code
p14888
aVChoosing x86 in your release build is something you should do if you program has a dependency on a component that only works in 32-bit code
p14889
aVThat's not uncommon, there are tons of COM components out there that never have and never will be ported to 64-bit unmanaged code
p14890
aVOne classic example is the Microsoft Jet database engine
p14891
aVChoosing x64 is very unusual, there isn't much unmanaged code that is only available in the 64-bit version
p14892
aVNotable is that you'll get warnings when you build your assembly, there are several
p14893
aVNET framework assemblies that contain unmanaged code; only the 32-bit versions of them are available in c:\u005cwindows\u005cmicrosoft
p14894
aVnet
p14895
aVYou can safely ignore those warnings, the 64-bit versions are actually installed in the GAC
p14896
aVOne wrinkle when selecting x64 is that the C# 3
p14897
aV0 compiler will emit a binary that asks Windows to create the startup thread with a 4 megabyte stack size, instead of the default 1 megabyte
p14898
aVThat's somewhat justified, 64-bit code does need more stack to store pointers and return addresses
p14899
aVFinally, the Windows SDK has the Corflags
p14900
aVexe tool available to switch the bit-ness of an assembly after it is built
p14901
aVThe /32BIT+ option is equivalent to setting Platform Target to x86
p14902
aVUsing /32BIT- ensures that the assembly will run in 64-bit mode on a 64-bit operating system
p14903
aVChanging the default stack size is possible with the Editbin
p14904
aVexe tool
p14905
as(dp14906
g9
V17034
p14907
stp14908
a((dp14909
g2
(lp14910
VFor the kind of resolution you are looking, DateTime
p14911
aVNow is an excellent clock and very cheap
p14912
aVIt updates with a accuracy of a bit over 15 msec
p14913
aVHere's an example, call the Operation() method just before you perform the operation:
p14914
aVCreate the instance of the class in your thread, don't share it
p14915
as(dp14916
g9
V17034
p14917
stp14918
a((dp14919
g2
(lp14920
VYou have to use DeviceIoControl() and send the FSCTL_GET_REPARSE_POINT control code
p14921
aVThe P/Invoke and API usage details are quite gritty, but it Googles really well
p14922
as(dp14923
g9
V17034
p14924
stp14925
a((dp14926
g2
(lp14927
Vstd::list is O(1) for inserts and deletions
p14928
aVBut you may well need O(n) to find the insertion or deletion point
p14929
aVstd::set is O(log(n)) for inserts and deletions, it is usually implemented as a red-black tree
p14930
aVConsider the effort to find the insert/delete point to make your choice
p14931
as(dp14932
g9
V17034
p14933
stp14934
a((dp14935
g2
(lp14936
VUse this to compare two floating point numbers to 4 digits in the fraction:
p14937
as(dp14938
g9
V17034
p14939
stp14940
a((dp14941
g2
(lp14942
VThe calling convention is wrong
p14943
aVIf removing the int arguments doesn't trip the MDA then it is Cdecl:
p14944
aVThis isn't the standard calling convention for exported DLL functions, you might consider changing it in the C/C++ code, if you can
p14945
as(dp14946
g9
V17034
p14947
stp14948
a((dp14949
g2
(lp14950
VThe original programmer wanted to make a derived control available to client code
p14951
aVBut prevent the client from inheriting and messing with the virtual method
p14952
aVThat's not a bad idea, it is usually easy to break a base class by overriding a method and doing something like forgetting to call the base class method
p14953
as(dp14954
g9
V17034
p14955
stp14956
a((dp14957
g2
(lp14958
VFilling the array with byte values of 0xff produces NaN
p14959
aVTry this code to see what is fastest on your machine
p14960
aVMemset() is not always a slam-dunk btw:
p14961
as(dp14962
g9
V17034
p14963
stp14964
a((dp14965
g2
(lp14966
VThe point of base64 is to avoid encoding issues
p14967
aVPractically all machines still running agree on the ASCII character set
p14968
aVAlthough there's probably still a few EBCDIC machines out there consuming kilowatts
p14969
aVASCII only encodes 96 unambiguous characters
p14970
aVBase64 uses 64 of those, plus a padding character
p14971
aVBase128 is already too much
p14972
aVThere's nothing unambiguous about Unicode, common encodings in use are UTF7, UTF8, UTF16, UTF32, UCS-2 and their least-endian and big-endian varieties
p14973
aVBase1024 would require 1024 unambiguous characters, way too much for anybody to ever agree on
p14974
aVNote that it can't just be an encoded range, the Unicode charts have lots of holes in them and they are randomly distributed
p14975
as(dp14976
g9
V17034
p14977
stp14978
a((dp14979
g2
(lp14980
VIt is not a proper declaration, you'd have to declare it like this:
p14981
aVAnd somewhere in a
p14982
aVc source code file actually define it:
p14983
aVWhich will make it zero initialized
p14984
as(dp14985
g9
V17034
p14986
stp14987
a((dp14988
g2
(lp14989
VThis is one of the burden's you'll have to take on when you use UDP
p14990
aVYou'll have to consider Path MTU discovery
p14991
aVThen again, since you are making reliable UDP, you should be able to auto-detect this and dynamically switch to a smaller packet size
p14992
aVThat will solve PMTUD problems as well
p14993
aVHopefully, this doesn't sound too much like: "those whose don't use TCP are doomed to reinvent it
p14994
aVCheck out the RFCs that are linked in that article for ideas
p14995
as(dp14996
g9
V17034
p14997
stp14998
a((dp14999
g2
(lp15000
VIt's available, I've been hearing a lot about Google's protobuf
p15001
aVIt has a C and C++ binding
p15002
as(dp15003
g9
V17034
p15004
stp15005
a((dp15006
g2
(lp15007
VThere's a good reason functionality like this isn't built into Windows
p15008
aVDisplaying large flashing rectangles is prone to induce seizures in people that suffer from photosensitive epilepsy
p15009
aVDon't do this
p15010
as(dp15011
g9
V17034
p15012
stp15013
a((dp15014
g2
(lp15015
VIt would have been helpful if you had documented how you solved this problem for your unmanaged assemblies
p15016
aVOptions to direct Windows to find an unmanaged DLL are a lot more restricted
p15017
aVYour issue would be simple to solve if you'd install the
p15018
aVNET assemblies to the GAC but that's not very compatible with your deployment strategy
p15019
aVAnyhoo, you can almost surely solve your problem by implementing the AppDomain
p15020
aVAssemblyResolve event
p15021
aVThe CLR will call this when it needs to find an assembly but can't find it by itself
p15022
aVYour code would have to be aware of the locations of the CS$ and Proj$ folders to make this work right
p15023
as(dp15024
g9
V17034
p15025
stp15026
a((dp15027
g2
(lp15028
VYeah, that looks like trouble
p15029
aVDerive your class from Panel instead
p15030
aVSet its AutoScroll to true, AutoMinSize property to the size of the scrollable grid
p15031
aVThat automatically makes the scrollbars appear
p15032
aVUse the OnPaintBackground() method to draw the background and grid
p15033
aVYou'll need to offset the drawing of the grid by the AutoScrollPosition property:
p15034
as(dp15035
g9
V17034
p15036
stp15037
a((dp15038
g2
(lp15039
VYou'll need to consider how you are going to draw the rectangle around the window first, that affects the rest of your code
p15040
aVThe easiest way to do this is by using a Form that has its TransparencyKey set to its BackColor and FormBorderStyle set to None
p15041
aVDraw a rectangle in the Paint event, the same size as the form's ClientRectangle, that gets you a visible rectangle with everything else transparent
p15042
aVSet the form's Location and Size property to match the window you found
p15043
aVNow finding the window from the mouse position
p15044
aVYou can't use WindowFromPoint(), it doesn't consider disabled windows
p15045
aVYou'll need to use EnumWindows()
p15046
aVIn the callback, call GetWindowRect() and check if the mouse is located inside the rectangle
p15047
aVBe sure to ignore your rectangle drawing window
p15048
aVWhen you get a match, now call GetWindow() repeatedly with the GW_HWNDPREV to find windows that overlap the window you found
p15049
aVKeep checking the rectangle and keep ignoring your rectangle window
p15050
aVThis eventually gets you the top-level window that the mouse cursor is on
p15051
aVNow use ChildWindowFromPoint() to check if the mouse is on a child window, if any
p15052
aVCreate your rectangle drawing form, if necessary, and give it the same size and location as the found window
p15053
aVCall this code from the MouseMove event of, say, a PictureBox that displays a bulls-eye graphic
p15054
aVSet its Capture property to true in its MouseDown event
p15055
aVClose the Close() method of your rectangle drawing form in the MouseUp event
p15056
as(dp15057
g9
V17034
p15058
stp15059
a((dp15060
g2
(lp15061
VNot even browsers work this way
p15062
aVUse a LinkLabel, not a TextBox
p15063
as(dp15064
g9
V17034
p15065
stp15066
a((dp15067
g2
(lp15068
VThe compiler generates this code:
p15069
aVThe auto-generated cs$3$000 local variable implements the contract
p15070
as(dp15071
g9
V17034
p15072
stp15073
a((dp15074
g2
(lp15075
VIt cannot change, your code would never be able to find the dialog template back in the resources
p15076
as(dp15077
g9
V17034
p15078
stp15079
a((dp15080
g2
(lp15081
VNo, the  element is known to work well
p15082
aVYou may find this doesn't have an effect when you run the code in the debugger
p15083
aVThat's because of the "Visual Studio Hosting process", a customized version of the CLR that improves debugging
p15084
aVCopy yourapp
p15085
aVexe
p15086
aVconfig to yourapp
p15087
aVvshost
p15088
aVexe
p15089
aVconfig
p15090
aVOr disable the hosting process: Project + Properties, Debugging tab
p15091
as(dp15092
g9
V17034
p15093
stp15094
a((dp15095
g2
(lp15096
VDebug + Windows + Threads
p15097
aVNote the flag in the first column
p15098
aVIt can sometimes be difficult to find the current thread in this window when your app has a lot of threads
p15099
aVEspecially when the thread doesn't have a good name
p15100
aVWhile stepping through code, you can use the "Toggle current thread flagged state" command in the Debug Location command bar to turn on the flag of the current thread
p15101
aVIt also turns on the flag in the Thread combo box on that same command bar
p15102
as(dp15103
g9
V17034
p15104
stp15105
a((dp15106
g2
(lp15107
VIterate the windows that might overlap yours by repeatedly calling GetWindow(), using GW_HWNDPREV
p15108
aVUse GetWindowRect() to check if such a window actually overlap yours
p15109
aVThere's no shortcut for two known windows, just check if GetWindow() returns hWnd2 while iterating
p15110
as(dp15111
g9
V17034
p15112
stp15113
a((dp15114
g2
(lp15115
VYou'll have to write a service
p15116
aVStart here
p15117
as(dp15118
g9
V17034
p15119
stp15120
a((dp15121
g2
(lp15122
VIf you are comfortable with C/C++ then you should use ReadDirectoryChangesW()
p15123
aVFileSystemWatcher is a thin wrapper around this API function
p15124
aVBut undeniably easier to get going
p15125
aVSample SDK code is available here
p15126
aVThe usual problem with FSW/RDC is that you can't access the file when you get a notification because the app that's writing the file has a lock on it
p15127
aVYou'd need a thread-safe queue to store notifications, emptied by another thread that periodically tries to perform the required operation
p15128
aVThis is also a healthy approach when processing the notifications, you'll want to spend as little time as possible to avoid having to create large notification buffers
p15129
aVThey are an expensive system resource
p15130
as(dp15131
g9
V17034
p15132
stp15133
a((dp15134
g2
(lp15135
VThis is something you really want to avoid
p15136
aVYou do so by adding virtual methods to the base class
p15137
aVDiscussed in more detail in this article
p15138
as(dp15139
g9
V17034
p15140
stp15141
a((dp15142
g2
(lp15143
VCreate a new project from either the Class Library project template or the Windows Forms Control Library project template
p15144
aVThe latter can be helpful if you create your own controls
p15145
aVThe resulting DLL assembly can be referenced in used in other Windows Forms Application projects
p15146
aVUsing an EXE assembly as a project reference is possible, although I reckon most installers will get pretty confuzzled by it
p15147
aVYou would have to deploy the EXE to the same directory as your "main" application EXE
p15148
aVDo it properly with a class library project
p15149
as(dp15150
g9
V17034
p15151
stp15152
a((dp15153
g2
(lp15154
VThat's very little to go by
p15155
aVHowever, the exception code is EXCEPTION_SOFTSO, a "soft stack overflow" exception
p15156
aVIt is raised when the CLR is about to run managed code but detects that there isn't enough stack space left to safely execute the code
p15157
aVYou'll need a debugger to get to the bottom of it
p15158
aVUse the Debug + Exceptions dialog to make the debugger stop at the exact point where the exception is raised
p15159
as(dp15160
g9
V17034
p15161
stp15162
a((dp15163
g2
(lp15164
VThe manifest that's included with your binaries is automatically generated by the VS build system
p15165
aVImportant headers that determine the version dependency that's emitted into the manifest are vc\u005cinclude\u005ccrtassem
p15166
aVh and crtdefs
p15167
ag6193
aVThe former declares the CRT version
p15168
aVNote that it already has support for the RTM version vs the "latest" version with the _BIND_TO_CURRENT_CRT_VERSION macro
p15169
aVThe latter contains #pragma comment directives to embed the /manifestdependency linker option into the
p15170
aVobj file, which in turn makes the linker auto-generate the manifest
p15171
aVYou don't have to do it this way, you can simply turn off the linker options that generate the manifest and write your own
p15172
aVThat gives you complete control over the CRT version that your app binds to
p15173
aVWhether you are ahead with this is a bit questionable
p15174
aVYou would probably still be shipping the old version of the CRT that got updated in July of last year, it contained a critical security bug
p15175
aVCustomers tend to be a bit unhappy about getting software installed on their machine that has well documented and solved security flaws
p15176
aVThe next thing you'd have to do is take control of the deployment of the DLLs
p15177
aVYou'll have to deploy the DLLs into the WinSxS side-by-side cache yourself
p15178
aVThat will work, if you figure out how, but it isn't likely to survive for very long
p15179
aVWindows Update, if enabled, may discover that the machine is using an unpatched version of the DLLs and will update it
p15180
aVAnd deploy a publisher policy to redirect load requests
p15181
aVIt is likely that your machine has such a policy file in place if you see your manifested version request resulting in the load of another version
p15182
aVThe somewhat unescapable conclusion is that this is MSFT's DLL and they'll do with it what they think is necessary
p15183
aVLook at applocal deployment to avoid this
p15184
as(dp15185
g9
V17034
p15186
stp15187
a((dp15188
g2
(lp15189
VThe exit code provides a good hint, 0xc0150002 = STATUS_SXS_CANT_GEN_ACTCTX, "Windows was not able to process the application binding information
p15190
aVPlease refer to your System Event Log for further information
p15191
aVThe event log will tell you what is wrong with the manifest or what side-by-side installed component is missing from your machine
p15192
as(dp15193
g9
V17034
p15194
stp15195
a((dp15196
g2
(lp15197
VCOM has no support at all for method overloads
p15198
aVYour second Foo() function will be renamed when Regasm
p15199
aVexe generates the type library
p15200
aVYou can use the Oleview
p15201
aVexe tool to take a look at it if Foxpro can't tell you what name was used
p15202
aVBest thing to do is to completely avoid the problem and simply give the overload another name so you don't have to guess at it
p15203
as(dp15204
g9
V17034
p15205
stp15206
a((dp15207
g2
(lp15208
VAfter activating the parent, you would have to send the WM_MDIACTIVATE message to activate a particular MDI child window
p15209
aVGetting your hands on the MDI child window handles ought to be challenging
p15210
as(dp15211
g9
V17034
p15212
stp15213
a((dp15214
g2
(lp15215
VYou can't use _asm in a 64-bit program
p15216
aVThe replacement is intrinsics, a list of instructions is available here
p15217
aVNOP isn't one of them, you'd have to use MASM64, available as vc\u005cbin\u005cx86_amd64\u005cml64
p15218
aVexe when you've got the 64-bit compilers installed
p15219
as(dp15220
g9
V17034
p15221
stp15222
a((dp15223
g2
(lp15224
VYou are leaving us guessing about what kind of effect you are looking for
p15225
aVI'll just arbitrarily pick a collapse and expand effect
p15226
aVIt takes a Timer, you implement the effect in a Tick event handler
p15227
aVHere's an example, it requires a Panel, Timer and Button:
p15228
as(dp15229
g9
V17034
p15230
stp15231
a((dp15232
g2
(lp15233
VThe JET database engine will never be ported to 64-bit
p15234
aVYou will have to consider a different engine
p15235
aVSQL Server Compact or Express are excellent choices
p15236
as(dp15237
g9
V17034
p15238
stp15239
a((dp15240
g2
(lp15241
VThis fits my doctor's usual advice: if it hurts, don't do it
p15242
aVThe C++ IDE isn't smart enough to create the
p15243
aVresx in the correct folder
p15244
aVIt is fixable though
p15245
aVWhen you get the error message box, switch to Explorer and move the just created
p15246
aVresx file from the project directory to the subdirectory yourself
p15247
aVSwitch back and hit OK, everything appears to work correctly after that
p15248
as(dp15249
g9
V17034
p15250
stp15251
a((dp15252
g2
(lp15253
VCreating your own control is the way to go here
p15254
aVAdd a new class to your project and paste the code shown below
p15255
aVCompile
p15256
aVThe new control shows up on the top of your toolbox
p15257
aVYou'll want to implement the BadValue event to warn the user that the entered text isn't suitable
p15258
aVAnd the ValueChanged is available to get an event when the Value property changes
p15259
as(dp15260
g9
V17034
p15261
stp15262
a((dp15263
g2
(lp15264
VFiguring out how to access the device yourself is not typically a good idea when you have zero documentation on how to do so properly
p15265
aVThere are too many possibilities and the code can be quite awkward in a managed language
p15266
aVYou probably can't even get any documentation if the supplier already provides an access DLL
p15267
aVThe odds are pretty good that this DLL will work if you simply copy the DLL into the same folder as your EXE
p15268
aVTry that first, only the DLL name is required in the Declare statement
p15269
aVLook in the install directory for other DLLs that might need to be copied as well if you have trouble
p15270
aVThe next option is to P/Invoke the SetDllDirectory() function if you can discover the path at runtime
p15271
aVThe next option is to have the installer add the directory that contains the DLL to the system PATH environment variable
p15272
aVHard-coding the path is your last resort
p15273
as(dp15274
g9
V17034
p15275
stp15276
a((dp15277
g2
(lp15278
VThe last argument really is a Byte()
p15279
aVExecutionEngineException indicates that the garbage collected heap got corrupted
p15280
aVBe sure to pass an initialized array that's large enough to contain the response:
p15281
as(dp15282
g9
V17034
p15283
stp15284
a((dp15285
g2
(lp15286
VThis is not the correct MFC source code, have you edited it
p15287
aVUsing CStringA and LPSTR is quite inappropriate, the real code uses CString and LPTSTR so that Unicode is correctly handled
p15288
aVYes, as posted the code would only return one character
p15289
aVSeeing the version helped
p15290
aVThe bug is described in this feedback article
p15291
aVIf you can't reasonably upgrade to VS2008 SP1, you could derive your own class from CRichEditCtrl and replace the function
p15292
aVFor example:
p15293
as(dp15294
g9
V17034
p15295
stp15296
a((dp15297
g2
(lp15298
VIt is easy to do
p15299
aVYou can rename the file, Windows has a lock on the handle, not the directory entry for the file
p15300
aVNow you can just copy the update without problems
p15301
aVAll that's left to do is to get rid of the renamed file after your app starts up again
p15302
aVIf necessary
p15303
as(dp15304
g9
V17034
p15305
stp15306
a((dp15307
g2
(lp15308
VIt almost certainly installs a shell icon extension handler
p15309
aVWriting your own and knowing how to detect the version in a file format that isn't documented well or at all is quite tricky
p15310
as(dp15311
g9
V17034
p15312
stp15313
a((dp15314
g2
(lp15315
VA lock is just not appropriate here, you'll want to signal an event
p15316
aVFor example:
p15317
as(dp15318
g9
V17034
p15319
stp15320
a((dp15321
g2
(lp15322
VThe default scaling for PrintDocument is 1 pixel = 0
p15323
aV01 inch
p15324
aVA typical piece of paper is about 7
p15325
aV5 inches wide (usable space), an image of 750 pixels wide is going to fill it completely
p15326
aVSurely your screen is wider than that
p15327
aVUse the Graphics
p15328
aVDrawImage(Image, Rectangle) overload instead so you can rescale the image to make it exactly wide enough
p15329
aVPageSettings
p15330
aVLandscape lets you rotate it
p15331
as(dp15332
g9
V17034
p15333
stp15334
a((dp15335
g2
(lp15336
VThere are some APIs that expect a "string array" with multiple zero terminated strings, a double zero to mark the end
p15337
aVRaymond Chang just recently blogged about it, most of all to demonstrate how often that this gets fumbled
p15338
as(dp15339
g9
V17034
p15340
stp15341
a((dp15342
g2
(lp15343
VIf you often run into trouble like this then you should consider "apps hungarian"
p15344
aVThe good kind, as opposed to the bad kind
p15345
aVWhile this doesn't normally tries to express constant-ness of a method parameter (that's just too unusual), there is certainly nothing that stops you from tacking an extra "c" before the identifier name
p15346
aVTo all those aching to slam the downvote button now, please read the opinions of these luminaries on the topic:
p15347
aVEric Lippert
p15348
aVLarry Osterman
p15349
aVJoel Spolsky
p15350
as(dp15351
g9
V17034
p15352
stp15353
a((dp15354
g2
(lp15355
VThe argument of the Control
p15356
aVControlCollection
p15357
aVAdd() method must be of type Control
p15358
aVThat's not an interface type
p15359
aVYour control is already derived from Control, no cast is needed
p15360
aVYou'll just need a separate local variable, no way around that:
p15361
aVOr a little helper method:
p15362
as(dp15363
g9
V17034
p15364
stp15365
a((dp15366
g2
(lp15367
VLots of ways to do it
p15368
aVCreating a form for each wizard step is possible, but very awkward
p15369
aVAnd ugly, lots of flickering when the user changes the step
p15370
aVMaking each step a UserControl can work, you simply switch them in and out of the form's Controls collection
p15371
aVOr make one of them Visible = true for each step
p15372
aVThe UC design tends to get convoluted though, you have to add public properties for each UI item
p15373
aVThe easy and RAD way is to use a TabControl
p15374
aVWorks very well in the designer since it allows you to switch tabs at design time and drop controls on each tab
p15375
aVSwitching steps is trivial, just change the SelectedIndex property
p15376
aVThe only thing non-trivial is to hide the tabs at runtime
p15377
aVStill easy to do by processing a Windows message
p15378
aVAdd a new class to your form and paste the code shown below
p15379
aVCompile
p15380
aVDrop the new control from the top of the toolbox onto your form
p15381
as(dp15382
g9
V17034
p15383
stp15384
a((dp15385
g2
(lp15386
VLoading assemblies and JIT compiling their code was already heavily optimized in
p15387
aVNET 1
p15388
ag2512
aVVery important since it directly affects the startup time for any
p15389
aVNET app
p15390
aVThe 2
p15391
aV0 CLR hasn't dramatically improved this
p15392
aVThere was however an update in
p15393
aVNET 3
p15394
aV5 SP1 to the security policy
p15395
aVThe strong name of an assembly is no longer checked when the assembly location is trusted
p15396
aVThe exact rules are documented here
p15397
aVThis can make warm starts faster by as much as 40%
p15398
aVThat's an optimistic number, YMMV
p15399
as(dp15400
g9
V17034
p15401
stp15402
a((dp15403
g2
(lp15404
VThe base form's Size is inherited, the designer normally prevents setting the size again in the derived form
p15405
aVBut mishaps can happen, a sub form might have been subtly altered once
p15406
aVOr it might have been designed on a machine that had a different video DPI setting from the machine on which the base form was designed
p15407
aVThere is only workaround for this that I can think of, edit the designer-generated code
p15408
aVIn the Solution Explorer window, open the node next to the sub-form and double-click the Designer
p15409
aVcs file
p15410
aVExpand the region labeled "Windows Form Designer generated code" and locate the assignment to the ClientSize property
p15411
aVDelete it
p15412
aVNo idea what's going on in your second problem, this is not a normal issue
p15413
aVTake a look at what happens to the designer generated code when you manipulate the button
p15414
as(dp15415
g9
V17034
p15416
stp15417
a((dp15418
g2
(lp15419
VYes, volatile is the absolute minimum you'll need
p15420
aVIt ensures that the code generator won't generate code that stores the variable in a register and always performs reads and writes from/to memory
p15421
aVMost code generators can provide atomicity guarantees on variables that have the same size as the native CPU word, they'll ensure the memory address is aligned so that the variable cannot straddle a cache-line boundary
p15422
aVThat is however not a very strong contract on modern multi-core CPUs
p15423
aVVolatile does not promise that another thread that runs on another core can see updates to the variable
p15424
aVThat requires a memory barrier, usually an instruction that flushes the CPU cache
p15425
aVIf you don't provide a barrier, the thread will in effect keep running until such a flush occurs naturally
p15426
aVThat will eventually happen, the thread scheduler is bound to provide one
p15427
aVThat can take milliseconds
p15428
aVOnce you've taken care of details like this, you'll eventually have re-invented a condition variable (aka event) that isn't likely to be any faster than the one provided by a threading library
p15429
aVOr as well tested
p15430
aVDon't invent your own, threading is hard enough to get right, you don't need the FUD of not being sure that the very basic primitives are solid
p15431
as(dp15432
g9
V17034
p15433
stp15434
a((dp15435
g2
(lp15436
VLook at the Output window when you run your program with the debugger
p15437
aVYou'll see lots of IllegalOperationException messages
p15438
aVThe background worker method is dying on an exception, you are not noticing it because you don't check the e
p15439
aVError property in a DoWorkCompleted event handler
p15440
aVThat's why it ain't moving
p15441
aVYou are not allowed to set the properties of a control in a background thread
p15442
aVThat's what the exception is trying to tell you
p15443
aVYou'll need to give up on the idea of using threads to implement your UI logic
p15444
aVGames are usually implemented with a game loop
p15445
as(dp15446
g9
V17034
p15447
stp15448
a((dp15449
g2
(lp15450
VSuspend/ResumeLayout isn't your problem here
p15451
aVThat only suspends automatic layout, the kind that is triggered by the Anchor and Dock properties
p15452
aVDouble-buffering can't fix your problem either, that only suppresses flicker in each individual control
p15453
aVYour real problem is that you are updating too many controls at the same time, each will take its turn to paint itself and that takes time
p15454
aVWhat you need is a different kind of double-buffering, compositing
p15455
aVCheck out if the solution in this thread solves your problem
p15456
as(dp15457
g9
V17034
p15458
stp15459
a((dp15460
g2
(lp15461
VIt doesn't use 8859-1 either, it uses your system's local code page
p15462
aVYou can convert to UTF16 and use DrawText() by converting the string yourself
p15463
aVIf your class library doesn't have any support then you can use MultiByteToWideChar()
p15464
as(dp15465
g9
V17034
p15466
stp15467
a((dp15468
g2
(lp15469
VFirst count the number of nodes in the list
p15470
aVThen traverse again, counting off n less nodes
p15471
aVStill an O(n) algorithm, that's unavoidable
p15472
as(dp15473
g9
V17034
p15474
stp15475
a((dp15476
g2
(lp15477
V3,579,545 is the magic number
p15478
aVThat's the frequency in Hertz before dividing it by 3 and feeding it into the 8053 timer chip in the original IBM PC
p15479
aVThe odd looking number wasn't chosen by accident, it is the frequency of the color burst signal in the NTSC TV system used in the US and Japan
p15480
aVThe IBM engineers were looking for a cheap crystal to implement the oscillator, nothing was cheaper than the one used in every TV set
p15481
aVOnce IBM clones became widely available, it was still important for their designers to choose the same frequency
p15482
aVA lot of MS-DOS software relied on the timer ticking at that rate
p15483
aVDirectly addressing the chip was a common crime
p15484
aVThat changed once Windows came around
p15485
aVA version of Windows 2 was the first one to virtualize the timer chip
p15486
aVIn other words, software wasn't allowed to directly address the timer chip anymore
p15487
aVThe processor was configured to run in protected mode and intercepted the attempt to use the I/O instruction
p15488
aVRunning kernel code instead, allowing the return value of the instruction to be faked
p15489
aVIt was now possible to have multiple programs using the timer without them stepping on each other's toes
p15490
aVAn important first step to break the dependency on how the hardware is actually implemented
p15491
aVThe Win32 API (Windows NT 3
p15492
aV1 and Windows 95) formalized access to the timer with an API, QueryPerformanceCounter() and QueryPerformanceFrequency()
p15493
aVA kernel level component, the Hardware Adaption Layer, allows the BIOS to pass that frequency
p15494
aVNow it was possible for the hardware designers to really drop the dependency on the exact frequency
p15495
aVThat took a long time btw, around 2000 the vast majority of machines still had the legacy rate
p15496
aVBut the never-ending quest to cut costs in PC design put an end to that
p15497
aVNowadays, the hardware designer just picks any frequency that happens to be readily available in the chipset
p15498
aV3,325,040,000 would be such a number, it is most probably the CPU clock rate
p15499
aVHigh frequencies like that are common in cheap designs, especially the ones that have an AMD core
p15500
aVYour number is pretty unusual, some odds that your machine wasn't cheap
p15501
aVAnd that the timer is a lot more accurate, CPU clocks have typical electronic component tolerances
p15502
as(dp15503
g9
V17034
p15504
stp15505
a((dp15506
g2
(lp15507
VLots of things wrong
p15508
aVYou are sending the message to the Process
p15509
aVHandle instead of the window handle
p15510
aVUse at least Process
p15511
aVMainWindowHandle
p15512
aVAlso, you should send a virtual keystroke, not a string
p15513
aVThe Keys enumeration gets you the key codes
p15514
aVSending a string requires a keystroke for each letter in the string
p15515
aVAlso, you should send the WM_KEYUP message as well
p15516
aVAlso, the receiving application is likely to use the keyboard state to determine whether the Shift, Ctrl or Alt keys are down and translate the keystroke to a typing key accordingly
p15517
aVYou can't fake that with PostMessage()
p15518
aVThat ought to get it somewhat working
p15519
aVTo make it truly reliable, I think you need a WH_JOURNALPLAYBACK hook, set by SetWindowsHookEx()
p15520
aVYou can't write that in C#, it doesn't support injecting DLLs into another process
p15521
aVCheck out what AutoHotkey can do for you
p15522
as(dp15523
g9
V17034
p15524
stp15525
a((dp15526
g2
(lp15527
VConsistent GUIDs are absolutely essential in COM
p15528
aVThe [assembly:Guid] attribute generates the type library LIBID
p15529
aVSurely the project template auto-generates one to make sure that the programmer doesn't forget to provide one when s/he flips ComVisible to true
p15530
aVIf an assembly [Guid] isn't provided then Tlbexp
p15531
aVexe synthesizes one from the assembly name, version and public key
p15532
aVThat's not really good enough, type libraries already have a version
p15533
aVChanging [AssemblyVersion] would generate a different LIBID
p15534
aVEspecially bad when you use the auto-increment option for the version (like 1
p15535
ag2512
aV*), you could quickly fill the registry with a mountain of dead TypeLib registry keys
p15536
aVLong story short, it avoids a lot of nasty mishaps
p15537
as(dp15538
g9
V17034
p15539
stp15540
a((dp15541
g2
(lp15542
VThe audio stack was significantly rewritten for Vista
p15543
aVPer-application volume and mute control was indeed one of the new features
p15544
aVStrange calls will be required to use the IAudioEndpointVolume interface
p15545
as(dp15546
g9
V17034
p15547
stp15548
a((dp15549
g2
(lp15550
VIt is an RPC error, you'll see it when you use out-of-process COM
p15551
aVIt tells you that the server
p15552
aVexe stopped running
p15553
aVIt probably bombed
p15554
aVOr decided to exit even though there were still active interface references
p15555
aVThat could be a reference count problem
p15556
aVOr improper use of CAtlModule::Lock()
p15557
aVEtcetera, I can only guess
p15558
aVDebug the server with Tools + Attach to Process and find out why it decided to quit
p15559
as(dp15560
g9
V17034
p15561
stp15562
a((dp15563
g2
(lp15564
VThe EDIT control has very broken paint behavior, you'll never get there by overriding the WM_PAINT message handler or using transparency
p15565
aVYes, overlay it with a STATIC control that you hide when you see text being entered
p15566
as(dp15567
g9
V17034
p15568
stp15569
a((dp15570
g2
(lp15571
VIt's there to help you hoist yourself out of a really deep hole dug by versioning
p15572
aVSay your first version of your program uses this class
p15573
aVAnd you've been serializing lots of bank accounts records with it
p15574
aVAnd an accountant starts complaining about the balance sheet being off by a billionth of a penny, so you change the class:
p15575
aVProblem solved, the next customer has happy balance sheets
p15576
aVUntil you're asked to upgrade an existing customer with lots of serialized records in the old format
p15577
aVBig problem, you cannot deserialize the records anymore since the class has changed
p15578
aVextern alias solves your problem, you can reference both the old version and the new version of the class in your code, even though the namespace names and class names are the same
p15579
as(dp15580
g9
V17034
p15581
stp15582
a((dp15583
g2
(lp15584
VYes, the $(DefineConstants) macro is available and can be tested in a build event
p15585
aVFor example, Project + Compile, Advanced Compile Options, Custom constants = Test can be tested like this:
p15586
aVMore complicated custom constants like Test=TRUE or compound constants need to be parsed differently
p15587
aVAdmittedly I quickly gave up trying to figure out how to use the horrid FOR command
p15588
as(dp15589
g9
V17034
p15590
stp15591
a((dp15592
g2
(lp15593
VOffice is not properly installed on that machine
p15594
aVYou can verify that with Regedit
p15595
aVexe, navigate to  to verify the type library GUID (should be {00062FFF-0000-0000-C000-000000000046}), then to  to verify that the type library is indeed properly registered, using the correct type library version number
p15596
aVThe latter part should be the problem
p15597
aVIf the target machine runs a 64-bit version of Windows, try setting the Project + Properties, Build, Platform Target to x86
p15598
as(dp15599
g9
V17034
p15600
stp15601
a((dp15602
g2
(lp15603
VProject + Add Reference, COM tab, select "Microsoft ADO Ext
p15604
aV6
p15605
aV0 for DDL and Security"
p15606
aVThat gets you the ADOX namespace
p15607
aVThe docs start here, this page has a specific example of creating a new database
p15608
aVBeware that the JET database is desperately outdated, it was deprecated close to 10 years ago
p15609
aVYou'll have major problems keeping it running in the very near future
p15610
aVThere is no 64-bit version available
p15611
as(dp15612
g9
V17034
p15613
stp15614
a((dp15615
g2
(lp15616
VA cache without an expiration policy is a memory leak
p15617
aVThere's nothing in your question that suggests you have considered a good policy
p15618
aVIf you don't have one then don't use a cache
p15619
aVIf you do then test it to see if you can measure actual improvements
p15620
as(dp15621
g9
V17034
p15622
stp15623
a((dp15624
g2
(lp15625
VYou'd use the ColorMatrix class for this
p15626
aVThere's a good tutorial available in this project
p15627
as(dp15628
g9
V17034
p15629
stp15630
a((dp15631
g2
(lp15632
VYou are battling virtual memory address space fragmentation
p15633
aVA process on the 32-bit version of Windows has 2 gigabytes of memory available
p15634
aVThat memory is shared by code as well as data
p15635
aVChunks of code are the CLR and the JIT compiler as well as the ngen-ed framework assemblies
p15636
aVChunks of data are the various heaps used by
p15637
aVNET, including the loader heap (static variables) and the garbage collected heaps
p15638
aVThese chunks are located at various addresses in the memory map
p15639
aVThe free memory is available for you to allocate your arrays
p15640
aVProblem is, a large array requires a contiguous chunk of memory
p15641
aVThe "holes" in the address space, between chunks of code and data, are not large enough to allow you to allocate such large arrays
p15642
aVThe first hole is typically between 450 and 550 Megabytes, that's why your first array allocation succeeded
p15643
aVThe next available hole is a lot smaller
p15644
aVToo small to fit another big array, you'll get OOM even though you've got an easy gigabyte of free memory left
p15645
aVYou can look at the virtual memory layout of your process with the SysInternals' VMMap utility
p15646
aVOkay for diagnostics, but it isn't going to solve your problem
p15647
aVThere's only one real fix, moving to a 64-bit version of Windows
p15648
aVPerhaps better: rethink your algorithm so it doesn't require such large arrays
p15649
as(dp15650
g9
V17034
p15651
stp15652
a((dp15653
g2
(lp15654
VChange the uiMode property from "full" to "none"
p15655
aVYou probably don't need to worry about the border anymore after that
p15656
as(dp15657
g9
V17034
p15658
stp15659
a((dp15660
g2
(lp15661
VUse _WIN32 instead
p15662
aVThe IntelliSense parser in VS2008 is troublesome, this might not necessarily solve your problem
p15663
aVIt got a complete rewrite in VS2010
p15664
as(dp15665
g9
V17034
p15666
stp15667
a((dp15668
g2
(lp15669
VYup, IMessageFilter cannot work
p15670
aVWM_QUIT makes the GetMessage() function return FALSE
p15671
aVIt never gets around to calling the message filter, the message loop immediately exits
p15672
aVOverriding WndProc() or canceling OnFormClosing() won't work either
p15673
aVThe only workaround I can think of is Detours to disable PostQuitMessage()
p15674
aVThat requires some C/C++ skillz
p15675
as(dp15676
g9
V17034
p15677
stp15678
a((dp15679
g2
(lp15680
VThat doesn't require a keyboard hook, you'll want to register a hot key
p15681
aVMuch easier to implement and much less demanding of system resources
p15682
aVHere's an example, it restores the form to the foreground if it was minimized
p15683
aVNote that you can register more than one key:
p15684
as(dp15685
g9
V17034
p15686
stp15687
a((dp15688
g2
(lp15689
VIt doesn't make any difference
p15690
aVThe cost is in retrieving the metadata from the assembly
p15691
aVWhether it is a PropertyInfo or the MethodInfo that reflects the setter or getter is immaterial
p15692
aVTime this with System
p15693
aVDiagnostics
p15694
aVStopwatch to convince yourself, the proof is in the pudding
p15695
aVMake sure you time the first use, it is fast after that thanks to the metadata getting cached
p15696
as(dp15697
g9
V17034
p15698
stp15699
a((dp15700
g2
(lp15701
VProbably because you are assuming it is an instance method instead of a static method:
p15702
aVConsider  instead of an array, List<>
p15703
aVIndexOf() is an instance method
p15704
as(dp15705
g9
V17034
p15706
stp15707
a((dp15708
g2
(lp15709
VIt is possible, but requires a fairly heavy serving of P/Invoke
p15710
aVThe trick is to enumerate the windows owned by the UI thread and check if one of them is a Windows dialog window
p15711
aVThis code will do the trick
p15712
aVI can't guarantee a 100% accuracy, there might be another unmanaged dialog in an app that resembles the message box template
p15713
as(dp15714
g9
V17034
p15715
stp15716
a((dp15717
g2
(lp15718
VIt is not okay
p15719
aVYou are getting lucky here because you only started two threads
p15720
aVThey'll immediately start running when you call Set on a dual core machine
p15721
aVTry this instead and watch it bomb:
p15722
aVYour original code will fail similarly on an old machine or your current machine when it is very busy with other tasks
p15723
as(dp15724
g9
V17034
p15725
stp15726
a((dp15727
g2
(lp15728
VThere is plenty of room for failure here
p15729
aVThe odds that the client would be able to guess the server's IP address are slim, unless you type it in by hand
p15730
aVIt would have to run on another network as well
p15731
aVConsider using the local IP address if you are testing this with two machines close together, 127
p15732
ag2512
ag2512
aV1 if you are testing this on the same machine
p15733
aVAnd the port number is almost certainly blocked by your firewall
p15734
aVYou'll have to make an explicit exception for it
p15735
as(dp15736
g9
V17034
p15737
stp15738
a((dp15739
g2
(lp15740
VA template function solves your problem:
p15741
as(dp15742
g9
V17034
p15743
stp15744
a((dp15745
g2
(lp15746
VIt doesn't make a lot of sense that you would see message boxes from calling LoadLibrary()
p15747
aVSee if P/Invoking SetErrorMode() with SEM_NOOPENFILEERRORBOX solves your problem
p15748
aVUsing the Shown instead of a Load event is worth a try too
p15749
as(dp15750
g9
V17034
p15751
stp15752
a((dp15753
g2
(lp15754
VYou can do this with the waveInOpen() and waveInStart() API functions
p15755
aVThere's a sample project available here
p15756
as(dp15757
g9
V17034
p15758
stp15759
a((dp15760
g2
(lp15761
VIf you don't have any, or prefer your own, use Tools + Customize, Keyboard and assign keystrokes to the Edit
p15762
aVImplementInterfaceStubsImplicitly and Edit
p15763
aVImplementInterfaceStubsExplicitly commands
p15764
as(dp15765
g9
V17034
p15766
stp15767
a((dp15768
g2
(lp15769
VBecause it doesn't always return an AsyncResult
p15770
aVThe delegate target may exist in another execution context, a RealProxy derived class may implement a proxy for it
p15771
aVRemoting would be an example
p15772
aVReturning an interface type makes that transparent
p15773
as(dp15774
g9
V17034
p15775
stp15776
a((dp15777
g2
(lp15778
VThe UNC path you posted () is odd
p15779
aVThere is no "drive", such a share behaves as a directory
p15780
aVYou'd use
p15781
as(dp15782
g9
V17034
p15783
stp15784
a((dp15785
g2
(lp15786
VLetting a thread run code in another thread is quite untrivial
p15787
aVBut it is a common requirement for Windows Forms and WPF apps, user interface components are never thread-safe
p15788
aVThey do have a common pattern for it, respectively the Control
p15789
aVInvoke and the Dispatcher
p15790
aVInvoke methods
p15791
aVAnd there is a standard helper class, BackgroundWorker
p15792
aVIt raises events on the UI thread, it's analogue for the callback method is its RunWorkerCompleted event
p15793
aVYou can certainly spin your own mechanism if you prefer using a delegate's BeginInvoke() method, but getting that right can be tricky
p15794
as(dp15795
g9
V17034
p15796
stp15797
a((dp15798
g2
(lp15799
VNeither the Update() method nor the progressBar2
p15800
aVValue assignment are legal from a worker thread
p15801
aVIt won't crash Visual Studio, not even VS2010, you'll get a simple IllegalOperationException to tell you that you are doing something improper
p15802
aVYou'll need to use the Control
p15803
aVInvoke() method
p15804
aVThere's a good example in the MSDN article I linked
p15805
as(dp15806
g9
V17034
p15807
stp15808
a((dp15809
g2
(lp15810
VOnly for IPv6 addresses with the IPAddress
p15811
aVIsIPv6SiteLocal property
p15812
aVYou'll have to cook your own for IP4
p15813
as(dp15814
g9
V17034
p15815
stp15816
a((dp15817
g2
(lp15818
VIt is called a "delegating constructor"
p15819
aVIt is not available in the language yet
p15820
aVBut there's a formal proposal, you'll find it in annex F
p15821
ag2586
aV1 of the language specification
p15822
aVGiven Microsoft's stance towards C++/CLI, that is unlikely to see the light of day anytime soon
p15823
aVUPDATE: delegating constructors did have a life beyond the proposal in that annex, they were added to the standard C++11 language specification
p15824
aVMicrosoft has been working on getting the C++11 additions implemented
p15825
aVDelegating constructors finally made it for VS2013
p15826
aVAnd they also work in C++/CLI in that edition
p15827
as(dp15828
g9
V17034
p15829
stp15830
a((dp15831
g2
(lp15832
VYou can make an auto-correcting guess, as long as there are sufficient operations that each can be timed individually and each take roughly the same amount of time
p15833
aVStart out with a guess and multiply by the number of operations to perform
p15834
aVMeasure the time of the next operation and add that to a list
p15835
aVMake a new guess by taking the average of the times in this list and multiply that by the number of operations left
p15836
aVYour guess will get more accurate as you get more timing samples
p15837
aVAnd your progress bar will always reach 100% (+/- a wee bit)
p15838
aVTaking the median instead of the average is better, it eliminates outliers due to sudden activity on your machine by other processes
p15839
aVAnd you'll want to throw out old measurements in the list, keeping only 10 to 20 is enough
p15840
aVKeep more samples if the operation time is more variable
p15841
as(dp15842
g9
V17034
p15843
stp15844
a((dp15845
g2
(lp15846
VFibers were specifically added to Win32 to support this
p15847
aVStart reading here
p15848
aVCheck this cautionary blog post as well
p15849
as(dp15850
g9
V17034
p15851
stp15852
a((dp15853
g2
(lp15854
VUnsubscribing inside the event handler is possible, but there is an explicit race condition here
p15855
aVAnother thread might be in the midst of calling the event handler as well, getting the handler called after unsubscribing is quite possible
p15856
aVYou'll need to serialize access to the event delegate:
p15857
aVThis isn't any different from protecting your boolean flag, although you can make that a lot more efficient with the Interlocked class
p15858
as(dp15859
g9
V17034
p15860
stp15861
a((dp15862
g2
(lp15863
VUse the NamedPipeClientStream constructor that takes a PipeOptions argument
p15864
aVSpecifying PipeOptions
p15865
aVAsynchronous will complete the Read() call when you call the Close() method
p15866
aVThe Read() method returns 0
p15867
as(dp15868
g9
V17034
p15869
stp15870
a((dp15871
g2
(lp15872
VThe System
p15873
aVManagement
p15874
aVManagementDateTimeConverter class was made to solve your problem
p15875
aVUse its ToDateTime() method
p15876
aVIt properly parses milliseconds and the UTC offset in the string:
p15877
aVOutput:
p15878
aV1/31/2010 2:23:08 AM
p15879
as(dp15880
g9
V17034
p15881
stp15882
a((dp15883
g2
(lp15884
VThere is no equivalent, not even with WINE
p15885
aVIt relies on timezone info stored in the registry, retrieved with GetTimeZoneInformation()
p15886
aVNote how the WINE code ends up in find_reg_tz_info()
p15887
aVThat info is just missing in Win2k
p15888
aVYou'd have to create your own timezones table
p15889
as(dp15890
g9
V17034
p15891
stp15892
a((dp15893
g2
(lp15894
VThis is by design, the event handler is called on a different thread for each notification
p15895
aVA quick fix is to set the FileSystemWatcher
p15896
aVSynchronizingObject property:
p15897
aVBut that's not a really good idea, the FSW is liable to miss notifications because it is blocked, waiting for you to click the OK button
p15898
aVDisplaying a message box in the notification event is just not a good idea, you want to process the notifications as quickly as possible
p15899
as(dp15900
g9
V17034
p15901
stp15902
a((dp15903
g2
(lp15904
VYour problem ought to be a bit more obvious than not seeing the bitmap, you should not see the form either
p15905
aVThat's because you never complete the Load event
p15906
aVYou could use the Shown event instead
p15907
aVCheck this thread for the code for a true game loop
p15908
as(dp15909
g9
V17034
p15910
stp15911
a((dp15912
g2
(lp15913
VPaste this into your Form1 constructor:
p15914
as(dp15915
g9
V17034
p15916
stp15917
a((dp15918
g2
(lp15919
VHard to parse your question
p15920
aVDelay-load is a feature of unmanaged code
p15921
aVIt won't load a DLL until the program actually makes a call to a function exported in the DLL
p15922
aVDependencyWalker is quite unsuitable for managed code
p15923
aVAssemblies are dynamically loaded by the JIT compiler, DependencyWalker cannot see such assembly references
p15924
as(dp15925
g9
V17034
p15926
stp15927
a((dp15928
g2
(lp15929
VIt is a Windows error, not a
p15930
aVNET error
p15931
aVThe error code is 14001, ERROR_SXS_CANT_GEN_ACTCTX, "The application has failed to start because its side-by-side configuration is incorrect
p15932
aVPlease see the application event log for more detail
p15933
aVLook in the Windows event log, it tells you what DLL you forgot to install on the target machine
p15934
aVIf it is a mixed-mode assembly then it is typically the C/C++ runtime DLL, or you deployed the debug build
p15935
as(dp15936
g9
V17034
p15937
stp15938
a((dp15939
g2
(lp15940
VThe proper declaration is:
p15941
aVIntelliSense can help you get these declarations just right, but it is pretty flaky
p15942
aVStart out by writing this:
p15943
aVCursor up and insert this line:
p15944
aVWhen you press Enter after the final ) then the IDE will automatically insert all required methods and properties
p15945
as(dp15946
g9
V17034
p15947
stp15948
a((dp15949
g2
(lp15950
VYes, you'll have to implement the interface literally
p15951
aVA possible workaround is to republish the property in the class with another name:
p15952
aVDeclare the property Overridable if you intend to override it in derived classes
p15953
as(dp15954
g9
V17034
p15955
stp15956
a((dp15957
g2
(lp15958
VUserControl will fight you tooth and nail to avoid getting the focus
p15959
aVIt has code that automatically passes the focus to a child control (if any) if it does get the focus
p15960
aVYou'll at a minimum have to override WndProc() and trap the WM_SETFOCUS message
p15961
aVThere might be other surgery needed, like ControlStyles
p15962
aVSelectable and the TabStop and TabIndex properties
p15963
aVYour next issue is that UserControl won't respond meaningfully to, say, keyboard messages when it does have focus
p15964
aVYou'll need to detect clicks on the UC background to handle mouse messages, as well as override the painting so it is obvious to the user that the UC has the focus (use ControlPaint
p15965
aVDrawFocusRectangle)
p15966
aVIf this starts to sound unattractive, it's because UC was really meant to be a container control
p15967
as(dp15968
g9
V17034
p15969
stp15970
a((dp15971
g2
(lp15972
VYes, you can't make this kind of code work in a Windows Forms or WPF app
p15973
aVWindows apps are event driven, you can't program long loops without blocking UI updates
p15974
aVWindows Media Player generates events when something significant happened
p15975
aVLike the PlayStateChange event
p15976
aVWrite an event handler for that event to index to the next item in your list
p15977
aVNote that WMP also supports play lists
p15978
aVYour ultimate resource for programming WMP in Visual Basic is this MSDN Library topic
p15979
aVTake a look at the provided samples
p15980
as(dp15981
g9
V17034
p15982
stp15983
a((dp15984
g2
(lp15985
VA bit late, but I came up with this code, it restarts a timer on any input event:
p15986
as(dp15987
g9
V17034
p15988
stp15989
a((dp15990
g2
(lp15991
VMurky problem, I can't repro and haven't heard of this before
p15992
aVThis behavior is normal when the Windows window manager is forced to hunt for another window to give the focus to when the current one closes
p15993
aVAnd the app doesn't have any window left that is enabled
p15994
aVThat should not be the case in your app, unless you intentionally set your main window's Enable property to False if the tool window gets the focus
p15995
aVRunning windows on different threads is a long-shot explanation
p15996
aVThings to try are to set the tool window's ShowInTaskbar property to false so the user must always go through the main window to refocus the app
p15997
aVAnd to make sure the window only closes due to a MouseUp event so mouse capture can't mess things up
p15998
aVAnd, yes, to explicitly focus the main window in the FormClosing event
p15999
as(dp16000
g9
V17034
p16001
stp16002
a((dp16003
g2
(lp16004
VNot using a type library in COM programming is fairly common
p16005
aVAny scripting language does, it uses IDispatch to discover supported methods and properties at runtime
p16006
aVIDispatch::GetIDsOfNames() or IDispatch::GetTypeInfo() gets that ball rolling
p16007
aVThis is called late-binding
p16008
aVIt is slow, but that doesn't matter in a scripting language
p16009
aVAnother standard way is through header files generated by MIDL from a
p16010
aVidl file that describes the interfaces and coclasses
p16011
aVYou'll find many of them in the Windows SDK include directory, mshtml
p16012
aVh for example
p16013
aVBut this is suitable only to unmanaged C/C++ code
p16014
aVUsing COM without a type library in a managed language like C# is difficult but not impossible
p16015
aVVB
p16016
aVNET is the better language, it supports late binding out of the box
p16017
aVC# will get better when version 4
p16018
aV0 arrives, it has a new "dynamic" keyword
p16019
as(dp16020
g9
V17034
p16021
stp16022
a((dp16023
g2
(lp16024
VCustomizing a tree view is not for the feint of heart
p16025
aVBut you're lucky, this project does exactly what you are asking for
p16026
as(dp16027
g9
V17034
p16028
stp16029
a((dp16030
g2
(lp16031
VIt is almost certainly a statement inside a With block:
p16032
aVwhich is syntax sugar for
p16033
aVwhich is syntax sugar for
p16034
aVwhere "DefaultProperty" is a property with dispid zero that's indexed by a string
p16035
aVLike the Fields property of an ADO Recordset object
p16036
aVSomewhat inevitable with sugar is that it produces rotten teeth
p16037
aVThis is the reason you have to use the Set keyword in VB6 and VBA
p16038
aVBecause without it the compiler doesn't know whether you meant to copy the object reference or the object's default property value
p16039
aVEliminated in vb
p16040
aVnet
p16041
as(dp16042
g9
V17034
p16043
stp16044
a((dp16045
g2
(lp16046
VPlease don't design your forms so they always fill the screen
p16047
aVYour customer has bought that nice expensive monitor to see more windows, not more of your form
p16048
aVA well designed form is otherwise always resizable
p16049
aVUse the Anchor and Dock properties, TableLayoutPanel and FlowLayoutPanel to ensure that your controls move and size themselves properly
p16050
aVIf your customer wants it big, she'll just click the Maximize button
p16051
as(dp16052
g9
V17034
p16053
stp16054
a((dp16055
g2
(lp16056
VWell, there are 4 statements in your code, 3 of them are wrong
p16057
aVThreadsShouldContinue cannot work well because VB
p16058
aVNET doesn't have the "volatile" keyword
p16059
aVThe Random statement cannot work well because you create a new instance of the Random class every time, preventing it from being truly random
p16060
aVAnd the Remove() method call cannot work well because you don't use the SyncLock statement
p16061
aVThe Sleep() call is the only statement without an issue
p16062
aVDoes that explain the problem
p16063
aVProbably not
p16064
aVUse Debug + Break All to see what the threads are doing
p16065
as(dp16066
g9
V17034
p16067
stp16068
a((dp16069
g2
(lp16070
VNo it isn't
p16071
aVThe internal layout of a class or struct is undiscoverable
p16072
aVMarshaling is required, guided by a [StructLayout], to convert that undocumented layout to a known one
p16073
aVThe JIT compiler readily takes advantage of this, it re-orders the fields in a struct for example to get them properly aligned and require the minimum of storage
p16074
aVThis defeats any tricks that messes with unmanaged pointers
p16075
aVThe simple value types behave predictably, but they are already well covered by BitConverter
p16076
aVStructures are your nemesis
p16077
aVThis is one reason why it took so long for memory-mapped files to be supported by the
p16078
aVNET framework
p16079
aVBut they'll be available in
p16080
aVNET 4
p16081
aV0, you could take advantage of the MemoryMappedViewAccessor class
p16082
aVIt still uses marshaling, it is hidden under the floor mat
p16083
as(dp16084
g9
V17034
p16085
stp16086
a((dp16087
g2
(lp16088
VTools + Options, Text Editor, pick your language or use All Languages, tick "Enable virtual space"
p16089
aVThat ensures that the caret stays in the same column when you move it vertically, no matter what text is in a line
p16090
aVVery much my personal preference
p16091
aVTools + Macros + Record is an easy way to generate the macro you want
p16092
aVTools + Customize + Keyboard to assign it a shortcut key
p16093
as(dp16094
g9
V17034
p16095
stp16096
a((dp16097
g2
(lp16098
VThis is a similar question to "I want to change the clock" or "I want to change the user password" or "I want to change the Windows theme"
p16099
aVAn application program has no business making such system configuration changes, accordingly it isn't wrapped by the
p16100
aVNET framework
p16101
aVYou can do it, but it will require P/Invoke
p16102
aVUse ChangeDisplaySettingsEx()
p16103
aVNot exactly easy to use, nor very safe to use
p16104
aVLots of LCD panels only look good in one particular resolution, the one that the user selected
p16105
aVPicking a resolution that the monitor cannot support produces a black screen and the three-finger salute
p16106
aVSmoke in the good old days
p16107
as(dp16108
g9
V17034
p16109
stp16110
a((dp16111
g2
(lp16112
VIt has nothing to do with DLLs vs EXEs
p16113
aVIt is a thread that crashes
p16114
aVIf you don't catch the exception then that will invoke the default exception handler in Windows
p16115
aVWhich will terminate the process, optionally telling Microsoft about the problem
p16116
aVCatching and handling exceptions like AccessViolation is not possible in VB6
p16117
aVIt isn't worth the trouble anyway, your main execution thread has suffered a heart attack and cannot continue in a meaningful way
p16118
aVEven if you could catch it, the program is in a very poor state with its global state partially mutated
p16119
aVTrying to continue will just create more crashes
p16120
aVOr much worse, generate invalid results and destroy valuable data
p16121
aVOne option is to run the DLL in a separate process
p16122
aVA crash will terminate that process, not yours
p16123
aVGetting this right is very difficult, it is hard to detect the crash
p16124
aVAnd the process interop is tricky
p16125
as(dp16126
g9
V17034
p16127
stp16128
a((dp16129
g2
(lp16130
VPsychic debugging powerz tells me that you are using the type library in a managed project
p16131
aVThe
p16132
aVNET type library importer (Tlbimp
p16133
aVexe) has an obscure bug, it improperly capitalizes a method or property name if it appears more than once in the library
p16134
aVIt uses the capitalization of the first one it encounters
p16135
aVThe first approach is to ignore it, the managed code could just use the identifier with the wrong capitalization
p16136
aVOr you could upgrade the importer, I'm fairly sure this bug was fixed in this one
p16137
as(dp16138
g9
V17034
p16139
stp16140
a((dp16141
g2
(lp16142
VThis cannot work, there is no main-stream C++ compiler that makes templates exportable
p16143
aVFurthermore, templates are instantiated by the C++ compiler through type erasure, similar to the way Java generics works
p16144
aVIn other words, the concrete callable functions have to be embedded in the DLL by the C++ compiler
p16145
aVThey are no longer generic
p16146
aVAs an alternative, you can write a ref class in the C++/CLI language
p16147
aVThat produces a true
p16148
aVNET generic class, usable by any
p16149
aVNET language that supports generics
p16150
as(dp16151
g9
V17034
p16152
stp16153
a((dp16154
g2
(lp16155
VThis is pretty obscure, but I think this is an optimization
p16156
aVIt has something to do with the way generics are implemented
p16157
aVThe machine code for a generic class method is created at runtime by the JIT compiler
p16158
aVIt needs to make several concrete versions of it
p16159
aVThere is one for any reference type
p16160
aVAnd one each for every single value type argument that is used in a program
p16161
aVThat can be inefficient, potentially lots of code that needs to be generated
p16162
aVEspecially bad for generic framework classes, they are Ngen-ed
p16163
aVThe concrete method implementation would have to be JIT compiled and could not be in the Ngen image
p16164
aVTo combat that, there's private code in the framework (sorry, I forgot where), that instantiates a whole raft of various versions of generic classes
p16165
aVInteresting do-nothing code, it puzzled me for quite a while
p16166
aVBut the side-effect is that Ngen
p16167
aVexe generates code for the generic class methods
p16168
aVIf you now use such a generic class in your own code, you'll get the concrete implementation of the method from the Ngen image, the JIT compiler isn't needed
p16169
aVYou can see where that leads, System
p16170
aVCollections
p16171
aVObjectModel
p16172
aVReadOnlyCollection was probably deemed too obscure to get included in this list
p16173
aVEasily verifiable, you'll see that when you single step into one if its methods, you won't step into the source code, even if you got the Reference Source
p16174
aVpdbs
p16175
aVI'm not 100% sure this is the exact explanation
p16176
aVBut the shoe fits
p16177
as(dp16178
g9
V17034
p16179
stp16180
a((dp16181
g2
(lp16182
VYou can trap the WM_SYSCOMMAND by overriding WndProc()
p16183
aVBut it can easily be done as well with an event handler for the Resize event:
p16184
as(dp16185
g9
V17034
p16186
stp16187
a((dp16188
g2
(lp16189
VI don't understand the code, but the threading sync is definitely bad
p16190
aVYou assume that threads will call SuspendThread() in a certain order
p16191
aVA succeeded WaitForSingleObject() call doesn't tell you which thread called ReleaseSemaphore()
p16192
aVYou'll thus call ReleaseThread() on a thread that wasn't suspended
p16193
aVThis quickly deadlocks the program
p16194
aVAnother bad assumption is that a thread already called SuspendThread after the WFSO returned
p16195
aVUsually yes, not always
p16196
aVThe thread could be pre-empted right after the RS call
p16197
aVYou'll again call ReleaseThread() on a thread that wasn't suspended
p16198
aVThat one usually takes a day or so to deadlock your program
p16199
aVAnd I think there's one ReleaseSemaphore call too many
p16200
aVTrying to unwedge it, no doubt
p16201
aVYou cannot control threading with Suspend/ReleaseThread(), don't try
p16202
as(dp16203
g9
V17034
p16204
stp16205
a((dp16206
g2
(lp16207
VThis kind of duplication is very rare in the
p16208
aVNET framework
p16209
aVBut there's a story about this one, told by Krzysztof Cwalina in this lecture
p16210
aVThey did a usability study on an early version of the framework, asking a bunch of experienced (but otherwise
p16211
aVNET agnostic) programmers to write some code using the FileStream and StreadReader/Writer classes
p16212
aVIt didn't go well, they got a 100% fail rate
p16213
aVThey responded by adding methods to the System
p16214
aVIO
p16215
aVFile class, using the "most likely to fall into the pit of success" approach
p16216
aVCool video btw, if you're at all into the reasons the framework looks the way it looks
p16217
aVBetter post a real answer: the File
p16218
aVOpen() method calls the FileStream constructor, passing values for FileAccess and FileShare (if you don't specify them) that are most likely to do the Right Thing
p16219
aVWhich is FileAccess
p16220
aVReadWrite and FileShare
p16221
aVNone
p16222
as(dp16223
g9
V17034
p16224
stp16225
a((dp16226
g2
(lp16227
VYou can't declare a variable in a method call
p16228
aVNor do you use the equivalent of "out"
p16229
aVAnd don't use "As New" when the method returns a new list
p16230
aVWrite it like this:
p16231
as(dp16232
g9
V17034
p16233
stp16234
a((dp16235
g2
(lp16236
VThe docs contain this phrase near the top:
p16237
aVApplies to: 2007 Microsoft Office
p16238
aVSystem, Microsoft Office 2003,
p16239
aVMicrosoft Office XP, Microsoft Office
p16240
aV2000
p16241
aVUser comment in this employee blog post:
p16242
aVA small update : Just tried it on a PC
p16243
aVwith Outlook 2003 and the addin works
p16244
aVGood enough
p16245
as(dp16246
g9
V17034
p16247
stp16248
a((dp16249
g2
(lp16250
VYou are up the creek with the wrong paddle, GetExecutingAssembly() never returns null
p16251
aVProof it to yourself by removing all the error avoidance code, including the null check
p16252
aVGetting occasional failure is usually a threading issue
p16253
as(dp16254
g9
V17034
p16255
stp16256
a((dp16257
g2
(lp16258
VI repro (Win7 x86), I think the chief problem is that FirefoxHTML is not actually a ProgID
p16259
aVAn essential subkey for a ProgID is the CLSID key, it points to the associated HKCR\u005cClasses subkey
p16260
aVFirefox is quite COM agnostic
p16261
as(dp16262
g9
V17034
p16263
stp16264
a((dp16265
g2
(lp16266
VNo
p16267
aVYou can't alter the designer, it generates the resources
p16268
aVApplyResources() calls
p16269
aVYou can't alter the ComponentResourceManager class, it is baked into the framework
p16270
aVThe class has only one way to alter its behavior: Thread
p16271
aVCurrentThread
p16272
aVCurrentUICulture
p16273
aVUse it
p16274
aVChange the UI culture before the InitializeComponent() call, restore it afterwards
p16275
aVPlenty of culture abbreviations you can hijack to map to something meaningful
p16276
as(dp16277
g9
V17034
p16278
stp16279
a((dp16280
g2
(lp16281
VResharper can do it, check this blog post
p16282
as(dp16283
g9
V17034
p16284
stp16285
a((dp16286
g2
(lp16287
VYou are confusing namespace names with assembly names
p16288
aVSystem
p16289
aVIO is a namespace
p16290
aVIt actually appears in more than one assembly
p16291
aVThe System
p16292
aVIO
p16293
aVFile class lives in mscorlib
p16294
aVdll, System
p16295
aVIO
p16296
aVFileSystemWatcher in system
p16297
aVdll, System
p16298
aVIO
p16299
aVPipes
p16300
aVPipeStream in system
p16301
aVcore
p16302
aVdll
p16303
aVGetReferencedAssemblies is accurate
p16304
aVPlay around with Red Gate's Reflector before writing this code
p16305
as(dp16306
g9
V17034
p16307
stp16308
a((dp16309
g2
(lp16310
VThis is an inevitable consequence of working with local time instead of UTC
p16311
aVThe end of DST is a doozy too, timestamps are ambivalent during the change-over since local time matches two times
p16312
aVThis is easily solved by working with UTC instead, that's what the operating system does as well
p16313
aVCheck your CRT implementation, something like _gmtime64() or the native GetFileTime()
p16314
as(dp16315
g9
V17034
p16316
stp16317
a((dp16318
g2
(lp16319
VThe Format16bppRgb1555 pixel format is declared but GDI+ doesn't actually support it
p16320
aVRgb555 is the closest match:
p16321
as(dp16322
g9
V17034
p16323
stp16324
a((dp16325
g2
(lp16326
VSafeIUnknown is derived from SafeHandle
p16327
aVThat's the class that implements the finalizer
p16328
aVIt is special, its finalization code runs in a critical execution region (CER)
p16329
aVSuch kind of code provides an execution guarantee, exceptions are suppressed
p16330
aVThe finalizer runs SafeIUnknown
p16331
aVReleaseHandle(), it makes a call to Marshal
p16332
aVRelease() to release the COM interface pointer that's wrapped by SafeIUnknown
p16333
aVSeeing a lot of these wrappers in the finalization queue indicates that the Marshal
p16334
aVRelease() call is throwing an exception
p16335
aVPreventing the wrapper from getting finalized
p16336
aVFinding out exactly why it is throwing an exception is going to be tricky
p16337
aVThis is unmanaged code bombing, you'll have few hints available to find out why
p16338
aVThe 95% case is heap corruption, a very difficult problem to troubleshoot
p16339
aVMost of all because this probably isn't your code and you don't have any source
p16340
aVYou ought to be able to get a breakpoint in a good unmanaged code debugger (like WinDbug) on the first-chance exception
p16341
aVGetting debugging symbols is essential to make any kind of sense of the stack trace
p16342
aVIt will however probably still be a long shot from there
p16343
aVConsider getting help from Microsoft Support
p16344
aVOr something drastic like rebuilding the machine
p16345
aVGood luck with it
p16346
as(dp16347
g9
V17034
p16348
stp16349
a((dp16350
g2
(lp16351
VSend the BM_SETCHECK message
p16352
aVBe sure to use a tool like Spy++ to see the messages
p16353
as(dp16354
g9
V17034
p16355
stp16356
a((dp16357
g2
(lp16358
VThe $user pseudo variable is the only other documented one
p16359
aVIn VS2010, the VB
p16360
aVNET debugger acquires some new ones
p16361
as(dp16362
g9
V17034
p16363
stp16364
a((dp16365
g2
(lp16366
VUsage:
p16367
as(dp16368
g9
V17034
p16369
stp16370
a((dp16371
g2
(lp16372
VNot possible
p16373
aVThis was a core design decision made by Dave Cutler and co when they designed Windows NT
p16374
aVA process must be backed by a file on the file system
p16375
aVWindows uses a memory mapped file to map the code of the process to virtual memory
p16376
aVThis is not different for a
p16377
aVNET program, even though a lot of its code gets JIT compiled to memory
p16378
aVThe assembly that contains the IL gets mapped the same way
p16379
aVGood for more than just efficient operating system operation, users and virus scanners really dislike executable code popping out of nowhere
p16380
as(dp16381
g9
V17034
p16382
stp16383
a((dp16384
g2
(lp16385
VIt works the exact same way as unmanaged code
p16386
aVThe CLR, the JIT compiler and the
p16387
aVNET framework assemblies are DLLs that are shared by any process that runs managed code
p16388
aVOnly one copy of their code is loaded in RAM, all processes map their virtual memory pages to that one copy
p16389
aVManaged code tends to have more private bytes than unmanaged code, the kind that cannot be shared
p16390
aVThat's first of all due to the JIT compiler, it generates machine code on-the-fly at addresses that won't be the same for one process vs another
p16391
aVAnd the loader and garbage collected heaps tend to be a bit beefy
p16392
aVYou eliminate the JIT compiler overhead by using Ngen
p16393
aVexe
p16394
aVThat's why the
p16395
aVNET framework assemblies are shared, they were Ngen-ed when you installed the framework on the machine
p16396
aVYou can't do anything about the heaps, but that's not really different in unmanaged code
p16397
as(dp16398
g9
V17034
p16399
stp16400
a((dp16401
g2
(lp16402
VSurgery is required to make the nested panel designable
p16403
aVThe steps are explained well in this blog post
p16404
as(dp16405
g9
V17034
p16406
stp16407
a((dp16408
g2
(lp16409
VJust use the regular Win32 Console Application template
p16410
aVA service doesn't have any special compile or link settings, just special code
p16411
aVThe SDK docs mention this here
p16412
as(dp16413
g9
V17034
p16414
stp16415
a((dp16416
g2
(lp16417
VIts purpose is backwards compatibility
p16418
aVWS_TILED and WS_ICONIC probably date back to Windows version 1
p16419
aVOne of Microsoft's great burdens, once they put a #define or function in an SDK header file, they can never delete it again
p16420
as(dp16421
g9
V17034
p16422
stp16423
a((dp16424
g2
(lp16425
VYes, this is a common request but it is not available
p16426
aVWindows always initializes an OS thread to the system default LCID, configured in the Regional and Language Options applet in Control Panel
p16427
aVYou can override this as long as you create the threads yourself
p16428
aVBut that is not practical for threadpool threads and threads that might have been created by some kind of unmanaged code running your process, like a COM server
p16429
aVThe latter case is the problem
p16430
aVNET has no trouble running managed code on threads that were created by unmanaged code
p16431
aVBut it cannot do anything about the way the thread is initialized
p16432
aVThat's true for CurrentUICulture but also for more obscure stuff like Thread
p16433
aVSetApartmentState()
p16434
aVDon't underestimate the likelihood that such a thread runs code in your program, COM servers written by Microsoft are very thread-happy
p16435
aVYou will have to pour through your code with a fine-toothed comb and find any code that might run on a thread you didn't create
p16436
aVAny event handler is suspect, as is any BeginXxx() method that has a callback
p16437
aVBackgroundWorker is definitely the lesser problem
p16438
aVNot overriding the thread's culture can produce very subtle and hard to diagnose bugz
p16439
aVA good example would be a SortedList that keys on a string
p16440
aVWhen run with the wrong culture, it randomly will fail to find elements that are actually present in the list
p16441
aVCaused by the list not being sorted anymore in another culture with different collation rules
p16442
aVIf I managed to scare you enough then I got my message across
p16443
aVThis happened to me, debugging an issue with a very large program that misbehaved on a Danish machine
p16444
aVWe didn't have a Danish localization and forced the UI to run in English
p16445
aVA worker thread used a red-black tree that had a string as the key
p16446
aVIt failed randomly when asked to deal with rdvrks
p16447
aVTook me a week
p16448
aVUpdate: this problem has been addressed in
p16449
aVNET 4
p16450
ag2447
aVThe CultureInfo class now has a DefaultThreadCurrentCulture and DefaultThreadCurrentUICulture
p16451
aVWhen set, it will be used to initialize the culture of any managed thread instead of the default Windows system culture
p16452
aVExactly how it interacts with threads that got started by native code and enter managed code isn't yet clear to me
p16453
as(dp16454
g9
V17034
p16455
stp16456
a((dp16457
g2
(lp16458
VYou should write it like this:
p16459
aVThis can get out of hand if your method is creating a lot of disposable objects, common in painting code
p16460
aVRefactor into a helper method or switch to an explicit finally block
p16461
as(dp16462
g9
V17034
p16463
stp16464
a((dp16465
g2
(lp16466
VThe upvoted answer is dramatically wrong, I have to post an answer
p16467
aVSomebody is wrong on the Internet, can't come to bed just yet
p16468
aVIt is convenient but it doesn't come for free
p16469
aVThe compiler has to generate a class for the anonymous method and the JIT compiler has to generate code for it
p16470
aVAnd that code always executes when you raise the event, whether or not a client has subscribed an event handler
p16471
aVThe null check code also always executes, but that takes a lot less code and time
p16472
aVThis isn't a lot of code and a lot of time
p16473
aVThe null check takes 2 machine code instructions and should execute in a single CPU cycle
p16474
aVThe anonymous delegate takes about an order of magnitude more but that's still not a lot on a modern machine
p16475
aVPersonally, I'm too old to be wasteful like that, two invariably is my choice
p16476
aVNot in the least because that's the standard pattern, everybody recognizes it
p16477
as(dp16478
g9
V17034
p16479
stp16480
a((dp16481
g2
(lp16482
VForm
p16483
aVKeyPreview is a bit of an anachronism, inherited from the Visual Basic object model for form design
p16484
aVBack in the VB6 days, you needed KeyPreview to be able to implement short-cut keystrokes
p16485
aVThat isn't needed anymore in Windows Forms, overriding the ProcessCmdKey() is the better solution:
p16486
aVBut KeyPreview was supported to help the legion of VB6 programmers switch to
p16487
aVNET back in the early 2000's
p16488
aVThe point of KeyPreview or ProcessCmdKey() is to allow your UI to respond to shortcut keystrokes
p16489
aVKeyboard messages are normally sent to the control that has the focus
p16490
aVThe Windows Forms message loop allows code to have a peek at that message before the control sees it
p16491
aVThat's important for short-cut keys, implementing the KeyDown event for every control that might get the focus to detect them is very impractical
p16492
aVSetting KeyPreview to True doesn't cause problems
p16493
aVThe form's KeyDown event will run, it will only have an affect if it has code that does something with the keystroke
p16494
aVBut do beware that it closely follows the VB6 usage, you can't see the kind of keystrokes that are used for navigation
p16495
aVLike the cursor keys and Tab, Escape and Enter for a dialog
p16496
aVNot a problem with ProcessCmdKey()
p16497
as(dp16498
g9
V17034
p16499
stp16500
a((dp16501
g2
(lp16502
VIt is somewhat true, both for VB
p16503
aVNET and C#
p16504
aVIn C# the programmer has to declare the variable that holds the return value explicitly, it is automatic in VB
p16505
aVNET
p16506
aVMost return values are returned in the EAX or RAX register, the JIT compiler has to generate code to load the register from the return value variable before the function exits
p16507
aVWhen you use the return statement, the JIT compiler might have the opportunity to load the EAX register directly, or already have the register containing the correct value, and jump to the function exit code, bypassing the load-from-variable instruction
p16508
aVThat's a pretty big "might" btw, real code invariably tests some expression with the if() statement
p16509
aVEvaluating that expression almost always involves using the EAX register, it still has to be reloaded with the return value
p16510
aVThe x64 JIT compiler does a completely different job doing that compared to the x86 compiler, the latter always seems to use the variable in a few spot checks I did
p16511
aVSo you're not likely to be ahead unless you run on a 64-bit version of Windows
p16512
aVOf all the evil in premature optimization, this one is arguably the worst
p16513
aVThe potential time savings are minuscule, write your code for clarity first
p16514
aVProfile later
p16515
as(dp16516
g9
V17034
p16517
stp16518
a((dp16519
g2
(lp16520
VI repro this
p16521
aVI think the SDK docs are wrong and the XML docs for the SetApplicationIdForSpecificWindow() method are correct:
p16522
aVAppId specifies a unique Application
p16523
aVUser Model ID (AppID) for the
p16524
aVapplication or individual top-level
p16525
aVwindow whose taskbar button will hold
p16526
aVthe custom JumpList built through the
p16527
aVmethods class
p16528
aVBy setting an appId for a specific
p16529
aVwindow, the window will NOT be grouped
p16530
aVwith it's parent window/application
p16531
aVInstead it will have it's own taskbar
p16532
aVbutton
p16533
aVI emphasized NOT
p16534
as(dp16535
g9
V17034
p16536
stp16537
a((dp16538
g2
(lp16539
V"Execution frame" is a term that is used in interpreted languages, Python in particular
p16540
aVThat's a very different execution model from C#
p16541
aVThe closest equivalent is a scope block in a C# method, a chunk of code that is is bracketed with curly braces
p16542
aVAlthough a Python execution frame could also extend to the body of a function, now it's equivalent to a stack frame in C#
p16543
aVWhich is another term for an activation frame
p16544
aVThe C# compiler recognizes declarations that are local to a scope block in C#
p16545
aVThe runtime doesn't, it only recognizes a stack frame that's active for the life of the entire method
p16546
aVThe difference is trivially papered-over by the compiler by simply declaring the sum of all local variables in all scope blocks as the activation frame
p16547
aVThat's a luxury that a Python interpreter cannot afford
p16548
as(dp16549
g9
V17034
p16550
stp16551
a((dp16552
g2
(lp16553
VThe CLR has no notion of static classes, it is specific to C#
p16554
aVThe compiler implements it by slick use of CLR attributes for a class: it declares it abstract and sealed
p16555
aVThat prevents any language from instantiating such a class
p16556
aVThis is what it looks like when you run Ildasm:
p16557
aVMaking it sealed is very much the point of a static class, it is used as a container for static methods and fields
p16558
aVWhich makes them act like global variables and functions like you have in languages like C or Pascal
p16559
aVAn abstract class is very much the opposite, it is designed to be derived from
p16560
aVA abstract class that has all of its member abstract acts like an interface
p16561
aVC# has a keyword for that, making static class and interface the exact opposites
p16562
as(dp16563
g9
V17034
p16564
stp16565
a((dp16566
g2
(lp16567
VIt is not possible
p16568
aVI actually filed a bug report about it at Microsoft's feedback site but they flipped me the bird on it
p16569
aVAdmittedly, it is a tricky problem to solve, changing the property requires Windows Forms to recreate the window from scratch because it is controlled by a style flag
p16570
aVThe kind you can only specify in a CreateWindowEx() call with the dwExStyle argument
p16571
aVRecreating a window makes it difficult to keep it modal, as required by the ShowDialog() method call
p16572
aVWindows Forms works around a lot of User32 limitations
p16573
aVBut not that one
p16574
as(dp16575
g9
V17034
p16576
stp16577
a((dp16578
g2
(lp16579
VError codes are old skool, you needed them back in the bad old days of COM and C programming, environments that didn't support exceptions
p16580
aVNowadays, you use exceptions to notify client code or the user about problems
p16581
aVExceptions in
p16582
aVNET are self-descriptive, they have a type, a message and diagnostics
p16583
aVYou need to distinguish two types of exceptions, those that are reasonably recoverable and those where you have no idea what exactly went wrong or how you recover from them
p16584
aVThe latter kind is by far the most common, you'll need a human to take corrective action
p16585
aVUse one of the standard built-in
p16586
aVNET exception types to raise them
p16587
aVIllegalOperationException, FormatException, ArgumentException are common choices
p16588
aVIf it is the back-end that raises such an exception then you just want to pass it through without altering
p16589
aVYou typically need a finally block to ensure your internal state is consistent, sometimes a catch block that contains a simple throw to recover state
p16590
aVAnything you consider recoverable should be raised with an exception type that you declare yourself, derived from the Exception class
p16591
aVThat gives code upstream a chance to write a catch clause and do something meaningful
p16592
aVYou'll need to generate a Message that is descriptive of the problem, in case the up-stream code doesn't actually handle it, the text of the message needs to be retrieved from either a hard-coded string or a resource if you support localization
p16593
as(dp16594
g9
V17034
p16595
stp16596
a((dp16597
g2
(lp16598
VA floating point literal in your source code is parsed as a double
p16599
aVAssigning it to a variable that is of type float will lose precision
p16600
aVA lot of precision, you're throwing away 7 significant digits
p16601
aVThe "f" postfix let's you tell the compiler: "I know what I'm doing, this is intentional
p16602
aVDon't bug me about it"
p16603
aVThe odds of producing a bug isn't that small btw
p16604
aVMany a program has keeled over on an ill-conceived floating point comparison or assuming that 0
p16605
aV1 is exactly representable
p16606
as(dp16607
g9
V17034
p16608
stp16609
a((dp16610
g2
(lp16611
VYou can't
p16612
aVYou either get the min/max buttons OR the help button
p16613
aVThese are standard Windows UI guidelines, the help button should only appear on dialogs and dialogs shouldn't have min/max buttons
p16614
aVYou can solve you problem with a wee bit of P/Invoke
p16615
aVAdd a What's This button to your UI and implement its Click event like this:
p16616
as(dp16617
g9
V17034
p16618
stp16619
a((dp16620
g2
(lp16621
VAdd this statement to your code:
p16622
aVYou'll now get an image that is equally "light" on all 4 sides
p16623
aVThat doesn't really solve your problem I would assume
p16624
aVBut it is fairly inevitable, the interpolator simply runs out of usable pixels at the edges of the bitmap to make a better guess
p16625
aVYou might be better off by leaving the PixelOffsetMode at its original setting and intentionally drawing the image too large so the edge effects are not visible
p16626
aVThis looked good:
p16627
as(dp16628
g9
V17034
p16629
stp16630
a((dp16631
g2
(lp16632
VThe WDK header files are not that clean
p16633
aVThe return type for MmGetSystemRoutineAddress() should have been declare FARPROC instead of PVOID
p16634
aVStill, that doesn't matter on any machine for which you'd write device drivers with the WDK, a void* is convertible to a function address without problems, data and code pointers have the same size on 32- and 64-bit platforms
p16635
aVIt is going to be a cold day in hell when we ever get that segmented memory model misery back
p16636
aVI recommend you simply turn off the warning with #pragma warning(disable:4055)
p16637
as(dp16638
g9
V17034
p16639
stp16640
a((dp16641
g2
(lp16642
VThis is very unusual
p16643
aVThe Windows font mapper will always provide a substitute font when your program requests a font that isn't available on the target machine
p16644
aVThat substitute font will usually be Microsoft Sans Serif on XP, Segoe UI on later versions
p16645
aVNeither of those should ever cause a problem
p16646
aVThen again, if the machine is so messed up that it doesn't have the core fonts available, it might have no TrueType font available at all
p16647
aVYes, that will bomb your program
p16648
aVFrankly, this isn't something you should have to deal with, unless this is a really valuable customer
p16649
aVIt is otherwise trivially solved by your customer's support team
p16650
as(dp16651
g9
V17034
p16652
stp16653
a((dp16654
g2
(lp16655
VThe ServiceController
p16656
aVStatus() property already uses the native QueryServiceStatus() API function
p16657
aVIt will return ServiceControllerStatus
p16658
aVStartPending if the service returns the SERVICE_START_PENDING status code
p16659
aVYou'll have to take the return value as-is, the service is in complete control of its status codes
p16660
aVIf you never get StartPending then the service most likely just doesn't require any time to get started
p16661
aVWhich is fairly common
p16662
aVIf you find the service to be unresponsive for a while, even though you got the Running status back then there's a flaw in the service implementation
p16663
as(dp16664
g9
V17034
p16665
stp16666
a((dp16667
g2
(lp16668
VYour original code is okay, you just have to initialize the max and second_max variables
p16669
aVUse the first two elements in the array
p16670
as(dp16671
g9
V17034
p16672
stp16673
a((dp16674
g2
(lp16675
VYou'll want to check if the text box value can actually be converted to a number
p16676
aVChecking for digits isn't good enough, you'll accept something bad like "4-" or reject something good like "1e3"
p16677
aVAnd please use meaningful control names so you don't accidentally enable the wrong control
p16678
aVFor example:
p16679
aVThis probably isn't quite good enough for your calculator, but demonstrates the approach
p16680
as(dp16681
g9
V17034
p16682
stp16683
a((dp16684
g2
(lp16685
VYou will have to use Reflection to discover the attribute
p16686
aVIn your case, you'll get it from PropertyInfo
p16687
aVGetCustomAttributes()
p16688
aVThe harder part of using attributes is to find a suitable execution model to actually use them
p16689
aVSomething like a compiler, a designer or a class that serializes objects is an obvious one
p16690
aVThe usability of attributes quickly spirals down from there
p16691
aVIt is almost always the wrong choice when you try to use an attribute where a virtual property is actually needed
p16692
aVRetrieving attribute values is very expensive, many orders of magnitude more expensive than retrieving a property value
p16693
aVUse them only when the reflection code runs at human time (like compilers) or when the cost is insignificant compared to the benefit or the overhead (common in any kind of I/O operation)
p16694
as(dp16695
g9
V17034
p16696
stp16697
a((dp16698
g2
(lp16699
VIt is an implementation detail that this code runs without a problem
p16700
aVThe Control
p16701
aVText property happens to be cached by the Control class so disposing the TextBox doesn't cause an ObjectDisposed exception
p16702
aVThat's fairly rare btw, lots of control property getters and setters generate a Windows message to ask the native Window control for the property value
p16703
aVYou'll get a kaboom on those because the Handle property is no longer valid
p16704
aVNotable also is that the Text property setter updates the cached value but also generates a Window message to update the native control
p16705
aVKaboom here
p16706
aVI assume this is just general interest, don't ever use code like that in your program
p16707
aVWell, you'd find out quick enough
p16708
as(dp16709
g9
V17034
p16710
stp16711
a((dp16712
g2
(lp16713
VIt isn't difficult, just P/Invoke the AllocConsole() API function to create your own console
p16714
aVFor example, make your Program
p16715
aVcs source code file look like this:
p16716
as(dp16717
g9
V17034
p16718
stp16719
a((dp16720
g2
(lp16721
VRadio carbon dating would be a typical example of this
p16722
aVYou need a class with two members
p16723
aVThe guessed date and the error estimate
p16724
aVThe latter usually expressed in years, but you're free to pick any unit
p16725
aVBeware that DateTime cannot express a date before 0 BCE, so make it a simple int for the year
p16726
aVAvoid making it any more fancy than that, guessing the right month is meaningless for any date before the year 1000
p16727
as(dp16728
g9
V17034
p16729
stp16730
a((dp16731
g2
(lp16732
VNever heard of NetMX, version 0
p16733
aV7 might have something to do with it
p16734
aVWMI is quite adroit at monitoring
p16735
aVNET apps as well as unmanaged apps
p16736
aVFire up Perfmon
p16737
aVexe to see the
p16738
aVNET performance counters at work
p16739
aVQueryable with WMI, experiment with WMI Code Creator
p16740
as(dp16741
g9
V17034
p16742
stp16743
a((dp16744
g2
(lp16745
VIt is possible by doing it the other way around, keeping the helper form enabled
p16746
aVThat however requires a few tricks
p16747
aVThe ShowDialog() method call iterates the toplevel windows in the app and calls EnableWindow() on them to disable them
p16748
aVYou can undo this by calling EnableWindow yourself
p16749
aVOne thing that's tricky is that you can't, ShowDialog() blocks
p16750
aVBeginInvoke() can fix that
p16751
aVHere's an example:
p16752
as(dp16753
g9
V17034
p16754
stp16755
a((dp16756
g2
(lp16757
VTricky problem
p16758
aVI could not find a good fix for this, merely a workaround
p16759
aVAdd a new class and paste the code shown below
p16760
aVCompile
p16761
aVDrop the new control from the top of the toolbox onto your form
p16762
aVThe workaround is not a very good one
p16763
aVThe problem is that the dropdown window will ignore the attempt to move it until the drop-down animation is complete
p16764
aVThe visual effect is not great, you'll see the window drop down, then jump to the left
p16765
aVI don't know an other way to slap it over the head, maybe somebody else does
p16766
aVC# version:
p16767
aVVB
p16768
aVNet version:
p16769
as(dp16770
g9
V17034
p16771
stp16772
a((dp16773
g2
(lp16774
VIt is considered a crime against usability to not make a control appear disabled when it is disabled
p16775
aVNothing quite like the sight of user banging away on the mouse button to try to get the program to do what she thinks is possible
p16776
aVWindows Forms doesn't support it, but you can fake it
p16777
aVYou could display an image of the enabled controls, overlapping the disabled ones
p16778
aVAdd a new class to your project and paste the code shown below
p16779
aVCompile
p16780
aVDrop the control from the top of the toolbox onto your form and add controls to it
p16781
aVTry it out by having a button toggle the Enabled property
p16782
aVPlease don't use this
p16783
as(dp16784
g9
V17034
p16785
stp16786
a((dp16787
g2
(lp16788
VIt usually isn't hard for an add-in to bomb the host
p16789
aVAll it has to do is start a thread and make it throw an unhandled exception
p16790
aVJesse Kaplan has blogged about a possible counter-measure for those kind of failures
p16791
aVSandboxing was covered by Shawn Farkas in this blog post
p16792
as(dp16793
g9
V17034
p16794
stp16795
a((dp16796
g2
(lp16797
VIt looks like the form's constructor is not public
p16798
aVThis example form generates that exact same error message:
p16799
as(dp16800
g9
V17034
p16801
stp16802
a((dp16803
g2
(lp16804
VYou get it from the DllMain() entrypoint, 1st argument
p16805
aVWrite one, store it in a global variable:
p16806
aVThere's an undocumented hack that works on any version of 32-bit and 64-bit Windows that I've seen
p16807
aVThe HMODULE of a DLL is the same value as the module's base address:
p16808
as(dp16809
g9
V17034
p16810
stp16811
a((dp16812
g2
(lp16813
VUse the fuslogvw
p16814
aVexe tool to find out what assembly it is using
p16815
aVThe exception indicates that it does find the assembly but that the assembly doesn't contain the MyControl type
p16816
aVMaybe it finds an old version of the assembly
p16817
aVFuslogvw will tell you
p16818
as(dp16819
g9
V17034
p16820
stp16821
a((dp16822
g2
(lp16823
VYes, it's a built-in capability of the TextRenderer
p16824
aVDrawText() method
p16825
aVOne of its overloads accepts a TextFormatFlags argument, you can pass TextFormatFlags
p16826
aVPathEllipsis
p16827
aVDoing this for a TextBox is not appropriate, the user cannot reasonably edit such an abbreviated path, you would have no idea what the original path might be
p16828
aVA Label is the best control
p16829
aVAdd a new class to your project and paste the code shown below
p16830
aVCompile
p16831
aVDrop the new control from the top of the toolbox onto your form
p16832
aVDon't make it too small
p16833
as(dp16834
g9
V17034
p16835
stp16836
a((dp16837
g2
(lp16838
VThis is a normal exception for XML serialization
p16839
aVDebug + Exceptions, turn off the check boxes
p16840
aVUse the Sgen
p16841
aVexe tool to pre-compile serialization assemblies, it's a lot faster
p16842
as(dp16843
g9
V17034
p16844
stp16845
a((dp16846
g2
(lp16847
VIt is just a convention for native Win32 programs
p16848
aVYou can easily change it, the MSVC linker accepts the /ENTRY:main command line option to change the entry point name to "main"
p16849
aVYou will however also have to change the signature of the main() function, it takes different arguments:
p16850
aVWhich I guess was the point of giving it a different name 20 years ago
p16851
as(dp16852
g9
V17034
p16853
stp16854
a((dp16855
g2
(lp16856
VInstead of doing a bunch of work in the UserControl's constructor or Load event, do it in a worker thread
p16857
aVBackgroundWorker is good for that
p16858
aVThis will give you quick startup of the form, but not necessarily quick availability of the user interface
p16859
aVConsider a splash screen
p16860
as(dp16861
g9
V17034
p16862
stp16863
a((dp16864
g2
(lp16865
VI don't see any error checking code in your snippet, you don't assert the return value
p16866
aVIf there's a problem, you'd never discover it
p16867
aVAlso, you are using ANSI strings, beware of the weirdo requirement for the nSize argument (1 extra)
p16868
as(dp16869
g9
V17034
p16870
stp16871
a((dp16872
g2
(lp16873
VThat's because the Project Default settings change a bunch of settings, not just one
p16874
aVThe CharacterType is the easier one, this
p16875
aVvsprops file changes it to Unicode:
p16876
aVConfigurationType however changes a lot of them
p16877
aVThe best thing to do is to start with a vanilla project template
p16878
aVSave the
p16879
aVvcproj file
p16880
aVChange the ConfigurationType and save again
p16881
aVRun a diff on the two
p16882
aVvcproj files to see what settings you should include in your project property sheet
p16883
aVYou'll then also easily see that the ConfigurationType element is actually in the  section
p16884
as(dp16885
g9
V17034
p16886
stp16887
a((dp16888
g2
(lp16889
VUse Graphics
p16890
aVDrawImage() to copy the selection portion of the source image
p16891
aVYou'll need the overload that takes a source and a destination Rectangle
p16892
aVCreate the Graphics instance from Graphics
p16893
aVFromImage() on a new bitmap that has the same size as the rectangle
p16894
as(dp16895
g9
V17034
p16896
stp16897
a((dp16898
g2
(lp16899
VThis is appropriate for unmanaged code (all of Google's code is)
p16900
aVThe usual scenario is that an app opens a named pipe to talk to the crash handler and tells it to start watching the app
p16901
aVThe crash handler then adds a named event to a list it watches
p16902
aVWhen the app crashes, an exception filter inside the app, installed with SetUnhandledExceptionFilter() will gain control
p16903
aVThat exception filter then turns on the named event
p16904
aVThe crash handler immediately notices and it takes a minidump of the crashed app and uploads it
p16905
aVAnd terminates the app
p16906
aVA crash handler like this is necessary because a crashed app cannot be trusted to still be able to function correctly when it suffered a heart attack
p16907
aVMicrosoft has one too, it is built in Windows
p16908
aVCalled WER, Windows Error Reporting
p16909
aVThat's the source of the dialog you see when a crashed app asks you if it is okay to let Microsoft know about the crash
p16910
aVThis is approach is unnecessary for managed apps
p16911
aVThey almost never die from the kind of hardware exceptions (like AccessViolation) that unmanaged apps die from
p16912
aVJust write code for the AppDomain
p16913
aVUnhandledException event
p16914
as(dp16915
g9
V17034
p16916
stp16917
a((dp16918
g2
(lp16919
VThe c = If(a, 0) + If(b, 0) statement gets compiled to this:
p16920
aVThe second snippet gets compiled exactly as-is
p16921
aVIt is the clear winner here
p16922
as(dp16923
g9
V17034
p16924
stp16925
a((dp16926
g2
(lp16927
VDon't read anything in the error text
p16928
aV"Catastrophic failure" must be the worst named HRESULT code ever
p16929
aVThe programmer used the E_UNEXPECTED error code, it is common in COM programming
p16930
aVIt usually indicates "I can't make this work, but I don't know why"
p16931
aVWhich of course doesn't leave you with many options to figure out why
p16932
aVIt is unlikely that it is directly related to running on a 64-bit version of Windows
p16933
aVYou are using the 32-bit scripting hosts, they do an excellent job of providing a 32-bit execution environment for COM servers
p16934
aVMuch more likely is that there simply is something amiss with the install, some kind of missing component
p16935
aVThe only good way to get to the bottom of this is by contacting the author or vendor of the COM server for support
p16936
aVIf that's impractical, consider running this inside a virtual PC that boots an earlier version of Windows
p16937
as(dp16938
g9
V17034
p16939
stp16940
a((dp16941
g2
(lp16942
VYou don't have to mess with Reflector, the source code for the DLR is readily available for download here
p16943
aVNicely commented too
p16944
aVYou'll find the source code for ExpandoObject in src\u005cRuntime\u005cMicrosoft
p16945
aVScripting
p16946
aVCore\u005cActions\u005cExpandoObject
p16947
aVcs
p16948
aVThe data store for an ExpandoObject is an ExpandoData, available in the same source file
p16949
aVThe values are stored in a simple object[]
p16950
aVThe ExpandoClass (same directory) keeps track of the keys in a simple string[]
p16951
aVExpandoObject definitely doesn't use a Dictionary as earlier stated, but it does implement IDictionary
p16952
as(dp16953
g9
V17034
p16954
stp16955
a((dp16956
g2
(lp16957
VYou start a process in Windows with the CreateProcess() function
p16958
aVIt returns a HANDLE to the process in PROCESS_INFORMATION
p16959
aVhProcess
p16960
aVThat handle will be signaled when the process terminates, allowing you to keep track of its lifetime
p16961
aVUse WaitForSingleObject() or WaitForMultipleObjects() to do so
p16962
aVThere's a code sample available here
p16963
as(dp16964
g9
V17034
p16965
stp16966
a((dp16967
g2
(lp16968
VI'll assume that "get crashes" doesn't actually mean that your code crashes
p16969
aVYou'll need to offset the drawing by the scroll amount
p16970
aVThat's easy to do:
p16971
as(dp16972
g9
V17034
p16973
stp16974
a((dp16975
g2
(lp16976
VProject + Properties, Debugging, set Command = Regsvr32
p16977
aVexe $(TargetPath)
p16978
aVSet a breakpoint on your DllRegisterServer function or use Debug + Exceptions, check Win32 Exceptions
p16979
aVPress F5 to get it going
p16980
as(dp16981
g9
V17034
p16982
stp16983
a((dp16984
g2
(lp16985
VThis is an odd request, it is almost always the other way around; trying to use a 32-bit COM server from 64-bit code
p16986
aVIf you have a 32-bit build of the server, then be sure to use it in-process, much more efficient and easier to get going than an out-of-proc surrogate
p16987
aVThe registry on a 64-bit version of Windows is virtualized for 32-bit apps
p16988
aVAll 32-bit COM registration is stored in the HKLM\u005cSoftware\u005cWow6432Node
p16989
aVUse Regedit
p16990
aVexe to verify that the COM server registration is actually present there
p16991
aVYou may also have an issue with the proxy/stub DLLs for the COM server
p16992
aVThey'll be needed because your server runs in another process
p16993
aVBe sure to build those DLLs both in 32-bit and 64-bit versions and register them with the proper version of Regsvr32
p16994
aVexe
p16995
as(dp16996
g9
V17034
p16997
stp16998
a((dp16999
g2
(lp17000
VIt is dying on a Windows error, 14001 = ERROR_SXS_CANT_GEN_ACTCTX, "The application has failed to start because its side-by-side configuration is incorrect
p17001
aVPlease see the application event log for more detail
p17002
aVLook in the Windows event log for the manifest entry that causes the problem
p17003
aVThis is usually due to a unmanaged C/C++ runtime DLL dependency that wasn't installed on the target machine
p17004
aVAlso make sure that the dev didn't give you the Debug build of his DLL
p17005
as(dp17006
g9
V17034
p17007
stp17008
a((dp17009
g2
(lp17010
VThis code is guaranteed to deadlock when the BGW is still running
p17011
aVBGW cannot complete until its RunWorkerCompleted event finished running
p17012
aVRunWorkerCompleted cannot run until the UI thread goes idle and runs the message loop
p17013
aVBut the UI thread isn't idle, it is stuck in the while loop
p17014
aVIf you want the BGW thread to complete cleanly, you have to keep your form alive
p17015
aVCheck this thread to see how to do that
p17016
as(dp17017
g9
V17034
p17018
stp17019
a((dp17020
g2
(lp17021
VI don't know what they were smoking when they wrote that
p17022
aVDouble
p17023
aVEpsilon is the smallest representable non-denormal floating point value that isn't 0
p17024
aVAll you know is that, if there's a truncation error, it will always be larger than this value
p17025
aVMuch larger
p17026
aVThe System
p17027
aVDouble type can represent values accurate to up to 15 digits
p17028
aVSo a simple first order estimate if a double value x is equal to some constant is to use an epsilon of constant * 1E-15
p17029
aVYou have to watch out though, truncation errors can accumulate
p17030
aVIf both x and y are computed values then you have to increase the epsilon
p17031
as(dp17032
g9
V17034
p17033
stp17034
a((dp17035
g2
(lp17036
VMy condolences, I've seen one of the APIs and it was indeed shockingly bad
p17037
aVThe bigger problem is that you'll need to be able to convince Windows to find the DLL
p17038
aVThey won't be in your
p17039
aVexe directory so the default won't work
p17040
aVUsing SetDllDirectory() would work, using Environment
p17041
aVCurrentDirectory does too
p17042
aVLoadLibrary cannot work, the P/Invoke marshaller will use LoadLibrary itself
p17043
aVIf it is at all an option, you can use different names for the two P/Invoke declarations, using different arguments for the DllImport() constructor and using the EntryPoint attribute
p17044
aVDoesn't sound like that will fly
p17045
as(dp17046
g9
V17034
p17047
stp17048
a((dp17049
g2
(lp17050
VNo problem here, the lock is re-entrant by the same thread
p17051
aVNot all sync objects have thread affinity, Semaphore for example
p17052
aVBut Mutex and Monitor (lock) are fine
p17053
as(dp17054
g9
V17034
p17055
stp17056
a((dp17057
g2
(lp17058
VWell, you can, just need to make an extra hop
p17059
aVYou can use Type
p17060
aVGetConstructor() and call the returned ConstructorInfo
p17061
aVInvoke() method
p17062
aVType
p17063
aVGetType() will also take a assembly-qualified name
p17064
aVOr you could use Assembly
p17065
aVLoad() and Assembly
p17066
aVGetType() to get the Type instance
p17067
as(dp17068
g9
V17034
p17069
stp17070
a((dp17071
g2
(lp17072
VAny compression algorithm uses Huffman encoding
p17073
aVWhich is basically what you are looking for here
p17074
aVThat encoding isn't exposed as a class separately, it is part of the algorithm of the DeflateStream and GZipStream classes
p17075
aVWhich is what you ought to use, as long as your strings are a reasonable size
p17076
aVIf they are short then there isn't any point in encoding them
p17077
as(dp17078
g9
V17034
p17079
stp17080
a((dp17081
g2
(lp17082
VWell, it's a bug
p17083
aVThe const modifiers is emitted into the metadata with the modopt custom modifier
p17084
aVUnfortunately, the C++/CLI language rules do not match the CLI rules
p17085
aVChapter 7
p17086
ag2582
aV1 of the CLI spec says:
p17087
aVCustom modifiers, defined using modreq
p17088
aV(\u201crequired modifier\u201d) and modopt
p17089
aV(\u201coptional modifier\u201d), are similar to
p17090
aVcustom attributes (21) except that
p17091
aVmodifiers are part of a signature
p17092
aVrather than being attached to
p17093
aVadeclaration
p17094
aVEach modifer associates
p17095
aVa type reference with an item in the
p17096
aVsignature
p17097
aVThe CLI itself shall treat required
p17098
aVand optional modifiers in the same
p17099
aVmanner
p17100
aVTwo signatures that differ
p17101
aVonly by the addition of a custom
p17102
aVmodifier (required or optional) shall
p17103
aVnot be considered to match
p17104
aVCustom
p17105
aVmodifiers have no other effect on the
p17106
aVoperation of the VES
p17107
aVSo, the CLR says that Derived::Foo() is not a override, C++/CLI says it is
p17108
aVThe CLR wins
p17109
aVYou could report the bug at connect
p17110
aVmicrosoft
p17111
aVcom but it probably a waste of time
p17112
aVI think this incompatibility was intentional
p17113
aVThey should have changed the language rules for C++/CLI but surely thought C++ compatibility to be more important
p17114
aVCV modifiers are a pain anyway, there are other scenarios that are not well supported, const pointers to const for one
p17115
aVThis cannot be enforced at runtime anyway, the CLR has no support for it
p17116
as(dp17117
g9
V17034
p17118
stp17119
a((dp17120
g2
(lp17121
VThat's because QuickSort is not a stable sort
p17122
aVI don't see a good option to fix this in the CompareTo method unless you can somehow obtain the index of the element
p17123
as(dp17124
g9
V17034
p17125
stp17126
a((dp17127
g2
(lp17128
VIt is not Vista specific, this will happen with any kind of user account that doesn't have admin privileges
p17129
aVYour program just can't write to folders like c:\u005cprogram files\u005cblah
p17130
aVThat UAC disables admin privileges has been publicized for a long time now
p17131
aVUse Environment
p17132
aVGetFolderPath() to get the path to an ApplicationData folder that you can write to
p17133
as(dp17134
g9
V17034
p17135
stp17136
a((dp17137
g2
(lp17138
VCheck in Control Panel's Regional and Language Options applet if the date format was changed
p17139
aVYou ought to be able to insulate yourself from these overrides or unusual culture properties by using the CultureInfo
p17140
aVInvariantCulture
p17141
aVDateTimeFormat property in the DateTime
p17142
aVToString() overload
p17143
as(dp17144
g9
V17034
p17145
stp17146
a((dp17147
g2
(lp17148
VYes, this is by design
p17149
aVComboBox uses the SHAutoComplete API function to implement the autocomplete feature
p17150
aVNote the declaration, the function takes a handle to the text box portion of the ComboBox
p17151
aVAs such, it has no idea that it is actually providing autocomplete info for a ComboBox instead of a TextBox
p17152
aVAccordingly, there is nothing it can do to compensate for the non-standard dropdown width you use
p17153
aVWell, that explains why it doesn't work
p17154
aVFixing it is technically possible but quite ugly
p17155
aVYou would have to run code in the KeyUp event and use EnumTheadWindows() to find the autocomplete window handle
p17156
aVThen you can use SetWindowPos() to make it larger
p17157
aVThere is already code similar to this in ComboBox
p17158
aVcs (AutoCompleteDropDownFinder
p17159
aVFindDropDowns), use the Reference Source or Reflector to help you get this right
p17160
aVGood luck
p17161
as(dp17162
g9
V17034
p17163
stp17164
a((dp17165
g2
(lp17166
VYes, CopyFileEx() has the COPY_FILE_OPEN_SOURCE_FOR_WRITE option, allowing you to copy a file that was opened for writing
p17167
aVYou'd still need cooperation from the owner of the file, it would have had to open the file allowing read sharing
p17168
aVBeware of the trouble you can get into with this option, you'll essentially get a random snapshot of the file, you could copy the file while the app was in the middle of writing to the file
p17169
aVSuch a copy isn't usually readable anymore
p17170
aVYou'd be lucky if the app trying to read such a copy crashes and dies
p17171
aVBut the more likely outcome is subtly corrupt data
p17172
as(dp17173
g9
V17034
p17174
stp17175
a((dp17176
g2
(lp17177
VAfter you changed the extension, you are now using the wrong names in the client code
p17178
aVThose names are no longer decorated as they were when you compiled it as C++ code
p17179
aVThe proper way to export names like this, so that those decorations are never used and you don't depend on the language:
p17180
aVTo see the exported names, use Dumpbin
p17181
aVexe /exports on your DLL
p17182
as(dp17183
g9
V17034
p17184
stp17185
a((dp17186
g2
(lp17187
VIt crashed
p17188
aVIt's a dead parrot
p17189
aVAn AccessViolation hardware exception, in an Office DLL (mso
p17190
aVdll)
p17191
aVYou have few options to figure out why exactly it crashed, this is not your code
p17192
aVBut using threading is definitely a good way to crash a COM server that's single-threaded
p17193
aVAny kind of Office code would qualify
p17194
aVGet rid of the threading first, then call Microsoft Support
p17195
as(dp17196
g9
V17034
p17197
stp17198
a((dp17199
g2
(lp17200
VKeep in mind that you are updating something that's meant for human eyes
p17201
aVWe can't see anything but a blur once those updates happen any faster than 25 times per second
p17202
aVSo, buffer the data you get from SerialPort and don't Begin/Invoke() until at last 50 msec have passed since the last time you called it
p17203
aVEither DateTime
p17204
aVUtcNow or Environment
p17205
aVTickCount lets you time this with (just) enough accuracy
p17206
aVYou should have no trouble avoiding stalling the UI thread at this rate
p17207
as(dp17208
g9
V17034
p17209
stp17210
a((dp17211
g2
(lp17212
VYou can use a Regular Expression search
p17213
aVSearch for
p17214
aVTo find a single line with a comment
p17215
aVYou'll probably want to find at least 3 lines that start with a comment:
p17216
aVKeep the cat away from your keyboard
p17217
as(dp17218
g9
V17034
p17219
stp17220
a((dp17221
g2
(lp17222
VYou are mixing up the virtual key and the scan code
p17223
aVThe wVk member is the important one, the scan code will only be used it the virtual key is ambiguous
p17224
aVFix:
p17225
as(dp17226
g9
V17034
p17227
stp17228
a((dp17229
g2
(lp17230
VNo, that can't work
p17231
aVThe CLR creates a memory mapped file view on the DLL, it can't be deleted until that view is destroyed
p17232
aVWhich won't happen until the AppDomain is unloaded
p17233
aVSince you're probably loading it in the primary AD, that won't happen until the program stops running
p17234
aVA helper process that starts your main one and deletes the DLL after it stops running is about all I can think of if you don't want to use an AD
p17235
as(dp17236
g9
V17034
p17237
stp17238
a((dp17239
g2
(lp17240
VYou are much better off writing your own assembly code, best way to learn
p17241
aVBut you can get reams of inscrutable assembly code from dumpbin
p17242
aVexe /disasm or IDA Pro
p17243
as(dp17244
g9
V17034
p17245
stp17246
a((dp17247
g2
(lp17248
VYour version of VS is really old, not sure if this applies
p17249
aVBut in VS2005/8 you would have to prevent inheriting the settings from the "Core Windows Library" project property sheet
p17250
aVWhich you'd do by either removing the sheet from the project or setting the Linker + Input setting to:
p17251
aVetcetera, listing all the
p17252
aVlibs you really use
p17253
as(dp17254
g9
V17034
p17255
stp17256
a((dp17257
g2
(lp17258
VThat isn't possible in unmanaged code either, a pointer value has no meaning in another process
p17259
aVManaged objects live on the garbage collected heap, that will never coincide with the address of a MMF view
p17260
aVEven if it somehow did, the garbage collector would cause havoc
p17261
aVPrimary reasons why it took 4 versions of
p17262
aVNET for MMFs to become supported
p17263
aVSerializing managed objects to the view is inevitable
p17264
as(dp17265
g9
V17034
p17266
stp17267
a((dp17268
g2
(lp17269
VThe native SQL Compact code is crashing
p17270
aVThat's very unusual
p17271
aVAnd very unlikely to be caused by your code
p17272
aVNot the kind of problem you could ever debug, you don't have anything but machine code to look at
p17273
aVIf you run any other in-process unmanaged code then consider it to be responsible for the instability
p17274
aVWriting off the PC and shooting it between the disk platters is the quick fix
p17275
as(dp17276
g9
V17034
p17277
stp17278
a((dp17279
g2
(lp17280
VI've been recommending this project, never heard a complaint about it
p17281
aVNote that an embeddable browser is available since Vista, it is wrapped by the ExplorerBrowser class available in the Windows API Code Pack
p17282
aVBeware that these kind of solutions put a lot of dependencies into your project
p17283
aVConsider weighing that cost against simply implementing the OpenFileDialog's FileOk event and canceling the OK button click if you don't like the path
p17284
as(dp17285
g9
V17034
p17286
stp17287
a((dp17288
g2
(lp17289
VThe processorArchitecture element lets you write an  that is specific
p17290
aVAdd two of them, one that uses "x86", the other "amd64"
p17291
aVIt is documented in this (very poor) MSDN Library article
p17292
as(dp17293
g9
V17034
p17294
stp17295
a((dp17296
g2
(lp17297
VThis is covered very well in the Shareware Starter Kit
p17298
aVIt has code for limited trials, secure activation, registration and Paypal integration
p17299
aVHighly recommended, you don't want to invent that wheel
p17300
aVThe link I gave you is not a great one, you have to click through the license to get to the download
p17301
aVI can't find a link anymore that describes the C# specific version of that kit
p17302
as(dp17303
g9
V17034
p17304
stp17305
a((dp17306
g2
(lp17307
VI think you are talking about SharpBits
p17308
aVNET, a wrapper for the BITS component
p17309
aVYes, there are several places where the author fumbled the interop
p17310
aVThere is otherwise no reason why it couldn't work, BITS is available both as a 32-bit and a 64-bit COM server
p17311
aVOne example of such a fumble is in this thread
p17312
aVGetting the P/Invoke declaration wrong or improperly manual marshaling is the vast majority  of all 64-bit interop problems
p17313
aVI've left lots of hints on 64-bit coding problems in this thread
p17314
as(dp17315
g9
V17034
p17316
stp17317
a((dp17318
g2
(lp17319
VClearly, you are doing something in your code that causes the assembly to be loaded in your own process
p17320
aVOnce there, it is stuck and the file is locked until the AppDomain in which it gets loaded gets unloaded
p17321
aVWhich is no doubt the primary one, it's stuck until your program terminates
p17322
aVPay attention to the Visual Studio Output window, you'll get a debugger notification as soon as it gets loaded
p17323
aVStepping through your code while watching the windwo will easily isolate the statement that causes it
p17324
as(dp17325
g9
V17034
p17326
stp17327
a((dp17328
g2
(lp17329
VYou'll need hardware for such kind of absolute accuracies, like a GPS Radio clock
p17330
aVYou will also need to write device driver level software, user mode programs cannot nearly respond fast enough to time something down to a millisecond
p17331
aVIn general, Windows is not the right kind of operating system for this
p17332
as(dp17333
g9
V17034
p17334
stp17335
a((dp17336
g2
(lp17337
VWell, reading it isn't hard, just use FileStream to read a byte[]
p17338
aVConverting it to text isn't really generally possible or meaningful unless you convert the 1's and 0's to hex
p17339
aVThat's easy to do with the BitConverter
p17340
aVToString(byte[]) overload
p17341
aVYou'd generally want to dump 16 or 32 bytes in each line
p17342
aVYou could use Encoding
p17343
aVASCII
p17344
aVGetString() to try to convert the bytes to characters
p17345
aVA sample program that does this:
p17346
as(dp17347
g9
V17034
p17348
stp17349
a((dp17350
g2
(lp17351
VDebug / Exceptions / Common Language
p17352
aVRuntime Exceptions / Thrown" is on
p17353
aVThat's your problem, makes the debugger stop on the first chance exception
p17354
aVVery useful, but not if you prefer the exception assistant
p17355
aVTurn it off
p17356
aVWell documented question btw, my compliments
p17357
as(dp17358
g9
V17034
p17359
stp17360
a((dp17361
g2
(lp17362
VBehold the Evil of On Error Resume Next
p17363
aVIt resumes right into the loop when your fooCollection reference is Nothing
p17364
as(dp17365
g9
V17034
p17366
stp17367
a((dp17368
g2
(lp17369
VTray icons don't support square tool tips, only balloons
p17370
aVKinda makes sense, the icons are usually quite close together so it would be hard to see what icon produced the tip without the "stem" on the balloon
p17371
aVUse the NotifyIcon
p17372
aVBalloonTipText property
p17373
as(dp17374
g9
V17034
p17375
stp17376
a((dp17377
g2
(lp17378
VThe font is selected by a registry entry
p17379
aVIt is well described in this article
p17380
aVQuoting the relevant part:
p17381
aVIf font linking is enabled on your
p17382
aVdevice, you can examine the registry
p17383
aVby enumerating the subkeys of the
p17384
aVregistry key at
p17385
aVHKEY_LOCAL_MACHINE\u005cSOFTWARE\u005cMicrosoft\u005cWindows
p17386
aVNT\u005cCurrentVersion\u005cFontLink\u005cSystemLink
p17387
aVto determine the mappings of linked
p17388
aVfonts to base fonts
p17389
aVYou can add links
p17390
aVby using Regedit to create additional
p17391
aVsubkeys
p17392
as(dp17393
g9
V17034
p17394
stp17395
a((dp17396
g2
(lp17397
VYour form doesn't work for the same reason shellForm doesn't work
p17398
aVThe UI thread is busy loading and painting the controls, it can't paint your PleaseWait form at the same time
p17399
aVYou'll need to create a separate thread that pumps a message loop to keep your PW form alive
p17400
aVYou could make it work like this:
p17401
aVSample usage:
p17402
as(dp17403
g9
V17034
p17404
stp17405
a((dp17406
g2
(lp17407
VIt depends on how you use the buffer argument in your C code
p17408
aVIf you only pass a string from your VB
p17409
aVNET code to your C code then declaring it ByVal String is good enough
p17410
aVIf however you let the C code return a string in the buffer then you have to declare it ByVal StringBuilder and initialize it properly before the call
p17411
aVFor example:
p17412
aVNote the ambiguity in the returned Length value
p17413
as(dp17414
g9
V17034
p17415
stp17416
a((dp17417
g2
(lp17418
VYou've got only two options: deploy the DLL in the same directory as the EXE (that's where Windows looks first) or using manifests and deploy the DLL to the Windows side-by-side cache
p17419
aVI don't think the latter option is common in the Open Source world but it is the only real fix if you want to share DLLs between different apps
p17420
as(dp17421
g9
V17034
p17422
stp17423
a((dp17424
g2
(lp17425
VYou cannot make this work, ShowDialog() will always return when the form is hidden
p17426
aVThe trick is to use a regular form and a normal call to Application
p17427
aVRun() but to prevent it from becoming visible immediately
p17428
aVPaste this code into your form class:
p17429
aVBeware that your Load event handler won't run until the form actually becomes visible so be sure to do any initialization in the Sub New constructor
p17430
as(dp17431
g9
V17034
p17432
stp17433
a((dp17434
g2
(lp17435
VYes, no problem
p17436
aVBoth PipeStream
p17437
aVRead and Write directly call the native Windows API, ReadFile and WriteFile are thread safe
p17438
as(dp17439
g9
V17034
p17440
stp17441
a((dp17442
g2
(lp17443
VThe "no
p17444
aVNET" requirement forces you to write code in unmanaged C++
p17445
aVCOM has a pretty steep learning curve, flattened somewhat by using ATL
p17446
aVAt least will will help you get the basics right
p17447
aVVS2005 has built-in class wizards to generate the boilerplate code you'll need and keep you code and the IDL in sync
p17448
aVYou'll need a good COM book (hard to find) and Chris Sells' ATL Internals
p17449
as(dp17450
g9
V17034
p17451
stp17452
a((dp17453
g2
(lp17454
VYou'll have to write the VGA driver first
p17455
aVAnd the mouse driver
p17456
aVAnd probably get the garbage collector going
p17457
aVSo much to do
p17458
as(dp17459
g9
V17034
p17460
stp17461
a((dp17462
g2
(lp17463
VIt is a support DLL in the Compact Framework
p17464
aVIt contains unmanaged code to help make Windows Forms run on Windows CE and Windows Mobile
p17465
aVThe term "PAL" you see used means Platform Abstraction Layer
p17466
aVThe @106 syntax in the [DllImport] attribute means "106th exported function"
p17467
aVExports are normally named instead of numbered, but AGL isn't meant for general use
p17468
aVThe Blt() function maps to BitBlt() in the Windows API
p17469
as(dp17470
g9
V17034
p17471
stp17472
a((dp17473
g2
(lp17474
VYes, that does work this way
p17475
aVA DLL is just a blob of code, it gets merged with the code in the EXE
p17476
aVA DLL cannot "own" any memory, an AppDomain does
p17477
aVYou can however see how much time is spent in the code that came from a DLL
p17478
aVIf you write a test program that itself doesn't make any major memory allocations but does call the methods of the classes in the DLL then you can attribute the memory usage to the DLL without a problem
p17479
aVWriting such a test program and make it resemble the way the DLL code is used in a real program is however not that easy
p17480
as(dp17481
g9
V17034
p17482
stp17483
a((dp17484
g2
(lp17485
VYou can't convert a tracking reference to an unmanaged reference or pointer
p17486
aVThe garbage collector would cause havoc when the passed float is a field in an object
p17487
aVYou'll need to use a temporary:
p17488
as(dp17489
g9
V17034
p17490
stp17491
a((dp17492
g2
(lp17493
VThe subobject1 and subobject2 values will be stored
p17494
aVYes, the string are also stored, needed to be able to match the name passed to GetValue() during deserialization
p17495
as(dp17496
g9
V17034
p17497
stp17498
a((dp17499
g2
(lp17500
VPlenty of hits when googling this error message
p17501
aVThis one looks really good
p17502
as(dp17503
g9
V17034
p17504
stp17505
a((dp17506
g2
(lp17507
VTimothy's explanation is compelling, but System
p17508
aVThreading
p17509
aVTimer already works this way
p17510
aVAt least in the Rotor implementation, it uses the value returned by GetTickCount() to calculate when the next callback is due
p17511
aVIt isn't terribly likely that the real CLR does this as well, it is more likely to use CreateTimerQueueTimer()
p17512
aVNevertheless, this API function is also likely to depend on the internal tick incremented by the clock tick interrupt
p17513
aVAt issue is how well the internal clock tick (as returned by GetTickCount() and Environment
p17514
aVTickCount) stays in sync with the absolute wall time (as returned by DateTime
p17515
aVNow)
p17516
aVUnfortunately, that's an implementation detail of the HAL on your machine, the Hardware Abstraction Layer
p17517
aVThe machine builder can provide a custom HAL, one that was tweaked to work with the machine's BIOS and chipset
p17518
aVI'd expect trouble if the machine has two timing sources, a clock chip that was designed to track the wall time and keeps ticking even you unplug the machine power, and another frequency available on the chipset that can be divided to provide the clock interrupt
p17519
aVThe original IBM AT PC worked that way
p17520
aVThe clock chip can usually be trusted, the clock would be grossly off if it isn't accurate
p17521
aVThe chipset cannot, cutting corners on the quality of the oscillators is an easy way to save a penny
p17522
aVSolve your problem by avoiding long periods on your timer and recalculating the next due-time from DateTime
p17523
aVNow in the callback
p17524
as(dp17525
g9
V17034
p17526
stp17527
a((dp17528
g2
(lp17529
VThis should not be an issue
p17530
aVNET 2
p17531
aV0 RTM through
p17532
aVNET 3
p17533
aV5 SP2 all use the exact same version of the CLR
p17534
aVThey only differ by the number of assemblies that are included
p17535
aVThe assembly format is the same
p17536
aVOf course, if you do take advantage of an assembly that's only included with
p17537
aVNET 3
p17538
aV5, you must make sure that 3
p17539
aV5 is actually installed on the target machine
p17540
aVYou'll find out quickly if it isn't
p17541
ag2586
aV5 should already be on the machine if it has Windows Update enabled
p17542
aVIf not, it takes a dozen or so minutes to get it on there
p17543
as(dp17544
g9
V17034
p17545
stp17546
a((dp17547
g2
(lp17548
VAdam is correct, you've got a mismatch on the calling convention on a 32-bit version of Windows
p17549
aVThe function pointer defaults to __cdecl, the delegate declaration defaults to CallingConvention
p17550
aVStdCall
p17551
aVThe mismatch causes the stack pointer to not be properly restored when the delegate call returns, triggering the diagnostic in the debug build of your C/C++ code
p17552
aVTo fix it on the C/C++ side:
p17553
aVTo fix it on the C# side:
p17554
as(dp17555
g9
V17034
p17556
stp17557
a((dp17558
g2
(lp17559
VYour code snippet doesn't explain it, but deadlocking the UI thread is never that difficult when you use BGW and are interested in its IsBusy property
p17560
aVA deadlock like this is usually easy to diagnose, use Debug + Break All
p17561
aVThen Debug + Windows + Threads and double-click the Main Thread
p17562
aVThen Debug + Windows + Call Stack to see what the UI thread is doing
p17563
aVThe common scenario is that the UI thread is looping on the IsBusy property
p17564
aVThe BGW can't complete because its RunWorkerCompleted event can't run until the UI thread goes idle
p17565
as(dp17566
g9
V17034
p17567
stp17568
a((dp17569
g2
(lp17570
VYou might consider the way it was done in the
p17571
aVNET framework
p17572
aVIt invariably declares a static class (Module in VB
p17573
aVNET) named NativeMethods that contain the P/Invoke declarations
p17574
aVYou could be more organized then the Microsoft programmers, there are many duplicate declarations
p17575
aVDifferent teams working on different parts of the framework
p17576
aVHowever, if you want to share this among all projects you have to declare these declarations Public instead of Friend
p17577
aVWhich isn't great, it ought to be an implementation detail
p17578
aVI think you can solve that by re-using the source code file in every project that needs it
p17579
aVNormally taboo but okay in this case, I think
p17580
aVI personally declare them as needed in the source code file that needs them, making them Private
p17581
aVThat also really helps when lying about the argument types, especially for SendMessage
p17582
as(dp17583
g9
V17034
p17584
stp17585
a((dp17586
g2
(lp17587
VForced to take a guess, I'd gamble at you emitting a static method but used an instance method in your C# code
p17588
aVThere's definitely a "this" argument (arg
p17589
aV0) but it is never used
p17590
aVDeclare it static, compile and disassemble again
p17591
as(dp17592
g9
V17034
p17593
stp17594
a((dp17595
g2
(lp17596
VI thought it'd be easy, just look at the key's repeat count
p17597
aVDidn't work though if modifiers are used
p17598
aVYou'll need to see the key go up as well, that requires implementing IMessageFilter
p17599
aVThis worked:
p17600
as(dp17601
g9
V17034
p17602
stp17603
a((dp17604
g2
(lp17605
VYou did eliminate all the obvious sources of this error for your process
p17606
aVMakes it likely that this is actually an operating system issue
p17607
aVThe one resource that is always under pressure on a server is the kernel memory pool
p17608
aVIt is easy to see, TaskMgr
p17609
aVexe displays it on the Performance tab
p17610
aVIt somewhat matches your call stack, looks like the Oracle provider is creating threads for a thread pool
p17611
aVA thread takes a megabyte in your process and 24 KB in the kernel memory pool, used as a stack when the thread switches to kernel mode
p17612
aVBackground info is available here
p17613
as(dp17614
g9
V17034
p17615
stp17616
a((dp17617
g2
(lp17618
VThis code was derived from the Reference Source, it should be very close
p17619
aVIt returns the number of pixels added to the text height when it displays more than one line of text:
p17620
as(dp17621
g9
V17034
p17622
stp17623
a((dp17624
g2
(lp17625
VSomebody did
p17626
aVYou'll find several
p17627
aVxsl files in the Xml subdirectory of the FxCop install directory
p17628
aVFxCopReport
p17629
aVxsl
p17630
aVFxCopRichConsoleOutput
p17631
aVxsl
p17632
aVVSConsoleOutput
p17633
aVxsl
p17634
as(dp17635
g9
V17034
p17636
stp17637
a((dp17638
g2
(lp17639
VThe CPU stack contains more than just addresses of code
p17640
aVFunction arguments get passed on the stack as well
p17641
aVOnly a debugger would know exactly what's in the stack frame, it gets it from the
p17642
aVpdb file
p17643
aVThat won't really help you, a program cannot debug itself
p17644
aVOn regular Windows, you'd use a minidump to do postmortem analysis, no idea if that's available on Mobile
p17645
aVIt should be
p17646
as(dp17647
g9
V17034
p17648
stp17649
a((dp17650
g2
(lp17651
VThat's not possible, a control like Button can have only one Parent
p17652
aVNor can you "call a button", a Button has a Click event
p17653
aVYou write an event handler for that event, get started on that quickly by simply double-clicking the button in the designer
p17654
aVSuch a handler could look like this:
p17655
aVAll of the Save buttons can call the common Document
p17656
aVSave() method, you'll have the "save document" logic in only one place
p17657
aVNote that an MDI form would be a good approach, you can give it a ToolStrip with a Save button and a File + Save menu item so the user is never confused about how to save the document
p17658
aVThis walkthrough shows you have to create such a user interface
p17659
as(dp17660
g9
V17034
p17661
stp17662
a((dp17663
g2
(lp17664
VThe book is probably a bit dated, middleware threads (aka fibers) were popular about 10 years ago
p17665
aVYes, context switches are relatively expensive, somewhere between 2000 and 10,000 CPU instructions
p17666
aVThey require a kernel transition and acquiring a global lock
p17667
aVUser threading can avoid a large portion of that cost, only the CPU state needs to be switched
p17668
aVBut that doesn't come for free:
p17669
aVYou'll need to create your own scheduler
p17670
aVWhen a user thread blocks on an I/O operation, all user threads will block
p17671
aVA user context switch blows the CPU cache
p17672
aVThe latter issue is the big one, blowing the cache is really expensive
p17673
aVCPU cores have become so fast compared to memory that the cost of trashing the cache becomes comparable to an OS context switch
p17674
aVAnd getting a lot of CPU cores is cheap
p17675
as(dp17676
g9
V17034
p17677
stp17678
a((dp17679
g2
(lp17680
VLooks like you are using Microsoft tools
p17681
aVThere's a group at Microsoft Research that has been working on a tool specifically designed to shake out concurrency bugz
p17682
aVCheck out CHESS
p17683
aVOther research projects, in their early stages, are Cuzz and Featherlite
p17684
aVVS2010 includes a very good looking concurrency profiler, video is available here
p17685
as(dp17686
g9
V17034
p17687
stp17688
a((dp17689
g2
(lp17690
VListBox doesn't have support for that
p17691
aVYou can bolt something on, you could deselect a selected item
p17692
aVHere's a silly example that prevents even-numbered items from being selected:
p17693
aVBut the flicker is quite noticeable and it messes up keyboard navigation
p17694
aVYou can get better results by using CheckedListBox, you can prevent the user from checking the box for an item:
p17695
aVBut now you cannot override drawing to make it look obvious to the user that the item isn't selectable
p17696
aVNo great solutions here, it is far simpler to just not display items in the box that shouldn't be selectable
p17697
as(dp17698
g9
V17034
p17699
stp17700
a((dp17701
g2
(lp17702
VYou are not getting a very good error message
p17703
aVBut the problem is that the STL map<> template class is only suitable for unmanaged types
p17704
aVIt requires an element type to have a destructor, managed types don't have one
p17705
aVIn the C++/CLI language, destructors are simulated with the IDisposable interface, that's the source of the confusing error message you see
p17706
aVIf you really want to use STL, you can with the STL/CLR implementation, available in VS2008
p17707
aVIt is however pretty widely ignored as it basically combines the disadvantages of STL (expensive value semantics) with those of managed code (no default value semantics on reference types)
p17708
aVThis web page compares it to the native
p17709
aVNET collection classes, stark results to put it mildly
p17710
aVThe appropriate collection class to use here is System::Collections::Generic::Dictionary<>
p17711
as(dp17712
g9
V17034
p17713
stp17714
a((dp17715
g2
(lp17716
VNothing special is needed, it is built into Reflector, albeit not very discoverable
p17717
aVRight-click the assembly in the left pane and choose Export
p17718
aVYou'll get a chance to change the output directory
p17719
aVClick OK and Reflector starts decompiling the code, creating a source file for each individual class
p17720
aVAnd creates a
p17721
aVcsproj file which you can open in Visual Studio
p17722
as(dp17723
g9
V17034
p17724
stp17725
a((dp17726
g2
(lp17727
VThis is not possible
p17728
aVThe way arguments are passed to a method is an implementation detail, left to the JIT compiler
p17729
aVIt is very different between x86 and x64 for example
p17730
aVx86 passes arguments on the stack, x64 passes the first 4 arguments through registers
p17731
aVFloating point values are passed either on the FPU stack or SSE register
p17732
aVEtcetera
p17733
aVThe debugger is aware of the details by using debugging info generated by the JIT compiler
p17734
aVBut using the debugging interfaces in a program can't work, programs cannot debug themselves
p17735
as(dp17736
g9
V17034
p17737
stp17738
a((dp17739
g2
(lp17740
VChecking out the API, it looks to me that the driver is capable of emulating a COM port
p17741
aVI see the GetComPort() method returning a "COMx" string
p17742
aVThat makes it pretty likely that you can use the System
p17743
aVIO
p17744
aVPorts
p17745
aVSerialPort class
p17746
aVWhich already does what your wrapper is trying to do, it supports a DataReceived event
p17747
aVWorth a shot
p17748
as(dp17749
g9
V17034
p17750
stp17751
a((dp17752
g2
(lp17753
VSerializing structures into a database table column is very definitely a bad practice
p17754
aVOnly your code could ever read them back reliably
p17755
aVAnd you'll have a huge problem when requirements change and you need to add a field to the structure, you'll need to re-create all the data, the dbase engine cannot help you
p17756
aVPassing these structures by reference is likely to be the correct thing to do
p17757
aVSurely they are larger than 16 bytes (~4 fields), beyond which passing by value starts to get (relatively) expensive
p17758
aVNot that you'd ever notice, the cost of updating the dbase is orders of magnitude larger than the cost of copying structures
p17759
as(dp17760
g9
V17034
p17761
stp17762
a((dp17763
g2
(lp17764
VYes, this code will bomb after the machine has been running for 2^31 milliseconds
p17765
aVYou cannot selectively suppress overflow checking in VB
p17766
aVNET
p17767
aVThere's only one fix for this: Project + Properties, Compile tab, scroll down, Advanced Compile Options, check "Remove integer overflow checks"
p17768
aVIt is not a terrible loss but you do lose a level of protection
p17769
aVAnother way to do this that doesn't cause overflow is by using DateTime
p17770
aVUtcNow
p17771
aVSubtracting produces a TimeSpan, use its TotalMilliseconds property
p17772
aVThe accuracy is the same
p17773
aVBeware that it returns a Double, avoid equality checks
p17774
as(dp17775
g9
V17034
p17776
stp17777
a((dp17778
g2
(lp17779
VDown-converting a GUI app is major surgery
p17780
aVThe programming model is entirely different, a GUI app is event driven
p17781
aVRelying on a message loop to deliver events, processed in message handlers
p17782
aVAnd typically a bunch of controls that take care of the grunge work of taking input
p17783
aVGiven that you have to completely redesign the app to make it work as a console mode app and that you don't have experience with the language, writing this in a
p17784
aVNET language you have experience with is the best way to get it completed quickly
p17785
as(dp17786
g9
V17034
p17787
stp17788
a((dp17789
g2
(lp17790
VYou're pretty close, you just need to initialize the rectangle better and adjust the rectangle size in the Move event:
p17791
as(dp17792
g9
V17034
p17793
stp17794
a((dp17795
g2
(lp17796
VWell, yes, the Bitmap class can save bitmaps in the
p17797
aVtiff format and supports multiple frames
p17798
aVBut you'll most likely find that now it is your program taking 30 seconds to get the job done
p17799
aVYou'll also be battling memory problems on a 32-bit operating system, printers have a lot of resolution and the Bitmap class isn' particularly frugal with unmanaged memory usage
p17800
aVEncoding a multi-frame
p17801
aVtiff is covered by this thread
p17802
as(dp17803
g9
V17034
p17804
stp17805
a((dp17806
g2
(lp17807
VIt is not the way UAC works, 99
p17808
aV99% of the time the answer will be No
p17809
aVYou get access by asking for it
p17810
aVInclude a manifest in your installer
p17811
aVThe redist installer already has that manifest
p17812
as(dp17813
g9
V17034
p17814
stp17815
a((dp17816
g2
(lp17817
VThe resource
p17818
aVh only declares the resource identifiers
p17819
aVIt is included by your code, the resource ids are used in your code to load the resources
p17820
aVThe actual resources are defined in your project's
p17821
aVrc file
p17822
aVRight-click the
p17823
aVrc file in the Solution Explorer window, select Open With and choose Text Editor
p17824
aVClick through the warnings, if any, and you'll see the actual resources declared
p17825
aVNote how it also #includes resource
p17826
ag6193
aVThe
p17827
aVrc file gets translated by the resource compiler into a
p17828
aVres file and linked to your binary by the linker
p17829
as(dp17830
g9
V17034
p17831
stp17832
a((dp17833
g2
(lp17834
VUse the GetLengthSid() to get the number of bytes you'll need
p17835
aVThen memcpy() from the PSID
p17836
as(dp17837
g9
V17034
p17838
stp17839
a((dp17840
g2
(lp17841
VYes, you'll need DefineUnmanagedResource()
p17842
aVThe file you pass must be in the
p17843
aVRES file format
p17844
aVThat requires the rc
p17845
aVexe Windows SDK tool
p17846
aVTo create one, start by creating a text file named test
p17847
aVrc with this content:
p17848
aVWhere test
p17849
aVico is the name of a file that contains the icon
p17850
aVStart the Visual Studio Command Prompt and use this command
p17851
aVThat creates a test
p17852
aVres file
p17853
aVPass its path to DefineUnmanagedResource(), your final
p17854
aVexe contains the icon resource
p17855
aVNote that this is not verify practical, the target machine probably won't have the Windows SDK installed and you cannot redistribute rc
p17856
aVexe
p17857
aVBut you could distribute the
p17858
aVres file
p17859
as(dp17860
g9
V17034
p17861
stp17862
a((dp17863
g2
(lp17864
VIt is a key difference between a compiler and an interpreter
p17865
aVAn interpreter does a identifier name lookup while it interpreting code
p17866
aVIf that name lookup happens inside a loop that executes many times, the time needed for that lookup can matter
p17867
aVLonger names require more time
p17868
aVThe C# compiler eliminates identifier names in two distinct stages
p17869
aVThe names of local variables are erased and replaced by stack frame offsets when it compiles the source code to IL
p17870
aVNamespace and type names are still present in the assembly
p17871
aVThe JIT compiler erases those, replacing them with code offsets for methods and data offsets for fields
p17872
aVThe length of the identifier names doesn't matter here, the lookup only happens once
p17873
aVEliminating the expense of the name lookup in an interpreter isn't hard btw
p17874
aVA decent interpreter tokenizes the source code, essentially a pre-compile step to make the interpreter more efficient
p17875
aVSuch an interpreter would not have a slowdown issue with long identifier names either
p17876
as(dp17877
g9
V17034
p17878
stp17879
a((dp17880
g2
(lp17881
VI suspect you're looking for the width() method:
p17882
as(dp17883
g9
V17034
p17884
stp17885
a((dp17886
g2
(lp17887
VError 53 is ERROR_BAD_NETPATH, "The network path was not found"
p17888
aVClearly you are using the wrong server name for the mailslot
p17889
aVUse  if the server runs on the same machine as your client
p17890
aVAnd don't forget to escape the backslash in a string:
p17891
as(dp17892
g9
V17034
p17893
stp17894
a((dp17895
g2
(lp17896
VTruncating the hash is your problem here
p17897
aVThe Xor method can only ever produce 256 distinct values
p17898
aVThe Prime method can generate more than 750,000 distinct values, but you throw 749,744 of them away by using only the 8 low bits
p17899
aVAnd can thus never do a better job than Xor
p17900
aVIn your specific case, you can do much better
p17901
aVThere are enough bits in an Integer to generate a unique hash with 16 million distinct values:
p17902
aVThe Xor method is okay when the input values are well distributed
p17903
aVA problem with the prime method is that it is easy to trigger an Overflow exception
p17904
aVThat's difficult to deal with in VB
p17905
aVNET code, it doesn't have the equivalent of the C# unchecked keyword
p17906
aVYou have to turn that off globally with Project + Properties, Compile tab, Advanced Compile Options, tick "Remove integer overflow checks"
p17907
aVAvoid that by computing the hash as an Int64
p17908
aVWhich makes it a bit expensive
p17909
as(dp17910
g9
V17034
p17911
stp17912
a((dp17913
g2
(lp17914
VSet the Capture property to true in a MouseDown event handler
p17915
aVYou'll keep getting MouseMove messages, even if the mouse has left the client area
p17916
as(dp17917
g9
V17034
p17918
stp17919
a((dp17920
g2
(lp17921
V"res" has to be a subdirectory of your project directory for this to work
p17922
aVThe project directory is the directory that contains your
p17923
aVvcproj file
p17924
as(dp17925
g9
V17034
p17926
stp17927
a((dp17928
g2
(lp17929
VNot possible by design, you'll always get an OutOfMemory exception if a new object cannot be created
p17930
aVA corrupted garbage collected heap is technically possible, invariably triggered by misbehaving unmanaged code, but I never heard of any cases where that didn't trigger an ExcecutionEngineException
p17931
as(dp17932
g9
V17034
p17933
stp17934
a((dp17935
g2
(lp17936
VThere is no clean solution for this, Windows doesn't provide a way to detect that the work station is locked and that the "wrong" desktop is active
p17937
aVYou can only detect the session switch, sample code is here
p17938
aVTo make this work, you're pretty much forced to include this code in the app and have it leave a breadcrumb that it could read back when it starts back up
p17939
aVBe sure to reset it after you used it once so that the app cannot get stuck permanently
p17940
as(dp17941
g9
V17034
p17942
stp17943
a((dp17944
g2
(lp17945
VBeware that you asked for a big-endian result, that's a bit unusual
p17946
as(dp17947
g9
V17034
p17948
stp17949
a((dp17950
g2
(lp17951
VProbably:
p17952
aVhttps://connect
p17953
aVmicrosoft
p17954
aVcom/VisualStudio/feedback/details/521243/mtlm-client-crash-when-viewing-test-case-result-history
p17955
aVhttps://connect
p17956
aVmicrosoft
p17957
aVcom/VisualStudio/feedback/details/383492/visual-studio-2008-crashes-on-exit-with-ide-on-second-monitor-and-output-error-list-history-find-results-on-main-first-monitor
p17958
aVhttps://connect
p17959
aVmicrosoft
p17960
aVcom/VisualStudio/feedback/details/120065/crash-on-viewing-code-coverage-of-loaded-trx-file-after-viewing-test-run-details
p17961
as(dp17962
g9
V17034
p17963
stp17964
a((dp17965
g2
(lp17966
VTearing occurs when your image update is not in sync with the refresh rate of the monitor
p17967
aVThe monitor shows part of the previous image, part of the new image
p17968
aVWhen the objects in the image move fast, the effect is quite noticeable
p17969
aVIt isn't fixable in Windows Forms, you can't get to the video adapter's v-sync signal
p17970
aVYou can in a DirectX app
p17971
as(dp17972
g9
V17034
p17973
stp17974
a((dp17975
g2
(lp17976
VThis is really obscure
p17977
aVIt is not ever documented in the SDK and doesn't appear in the SDK header files
p17978
aVGoogle produces only a few hits, most sites are down or untrusted
p17979
aVThe only decent hit I get is XBox code, it only declares it but doesn't actually use it
p17980
aVI'm not sufficiently convinced that this is a real code that you'd ever encounter in a regular Windows program
p17981
as(dp17982
g9
V17034
p17983
stp17984
a((dp17985
g2
(lp17986
VThe "GMT" timezone is ambiguous
p17987
aVOn Windows, it refers to the timezone for London et al and includes daylight savings adjustment
p17988
aVIn Greenwich at the Royal Observatory, it refers to the timezone that matches UTC with no DST adjustment
p17989
aVClearly, you want to avoid this kind of possible confusion
p17990
aVAs well as the large number of mistakes you'll get when you ask users to make the conversion themselves
p17991
aVThere's only one good way to do this, allow the user to enter times in the her local timezone
p17992
aVConvert that immediately to UTC and send that to the server
p17993
aVAnything coming back from the server should be converted back to local time at the last possible moment, just before display
p17994
as(dp17995
g9
V17034
p17996
stp17997
a((dp17998
g2
(lp17999
VIt is TryCast:
p18000
as(dp18001
g9
V17034
p18002
stp18003
a((dp18004
g2
(lp18005
VThis SDK article lists considerations for 64-bit Windows
p18006
aVMSVC++ specific considerations are listed here
p18007
aVIn general, just compiling your code will flush out most issues
p18008
aVI cannot comment on your specific scenario, it isn't detailed enough
p18009
as(dp18010
g9
V17034
p18011
stp18012
a((dp18013
g2
(lp18014
VYou could just change the cursor:
p18015
as(dp18016
g9
V17034
p18017
stp18018
a((dp18019
g2
(lp18020
VPictureBox already has double-buffering turned on
p18021
aVThe only way you could perceive flicker is when you draw directly to the screen instead of using the Paint event
p18022
aVIt isn't clear whether you do from your snippet
p18023
aVBuffering yourself with a bitmap would work too but isn't as efficient as the double-buffering implemented by Windows Forms
p18024
aVCall its Invalidate() method when the data changes, do the drawing in the Paint event (using e
p18025
aVGraphics) and it won't flicker
p18026
as(dp18027
g9
V17034
p18028
stp18029
a((dp18030
g2
(lp18031
VIt just doesn't work this way, it is not an HTML editor
p18032
aVHacking RTF directly is technically possible through the Rtf property but very hard to get right
p18033
aVRTF is not exactly a friendly format
p18034
aVStart reading here, try not to panic at the quality of that first page
p18035
aVWell, go ahead
p18036
as(dp18037
g9
V17034
p18038
stp18039
a((dp18040
g2
(lp18041
VIt is one of the most common COM errors, "Class not registered"
p18042
aVIt starts at VB6, it has an option to control binary compatibility
p18043
aVI forgot exactly what that looks like, it's been too long
p18044
aVIf you don't control this, VB6 is going to create a new COM server with different CLSID values
p18045
aVThat requires re-registering the DLL with Regsvr32
p18046
aVexe
p18047
aVAnd re-generating the interop library with Tlbimp
p18048
aVexe
p18049
aVThe latter step is probably the one you missed
p18050
aVNote that using different CLSID values is a hard requirement for COM, it must be done when the public interface changes
p18051
aVBut not when only the implementation changes
p18052
as(dp18053
g9
V17034
p18054
stp18055
a((dp18056
g2
(lp18057
VYou can't make changes in the program's install folder, you don't have the required admin privileges
p18058
aVAdding a manifest to your updater isn't practical, the user is quickly going to tire seeing the elevation prompt
p18059
aVThe only practical way is to run your updater as a scheduled task
p18060
aVThose tasks are permitted to run with admin privileges because it requires admin privileges to schedule one
p18061
aVWhich you'll need to do with your installer
p18062
as(dp18063
g9
V17034
p18064
stp18065
a((dp18066
g2
(lp18067
VThe "drag it over to my toolbox" part cannot work
p18068
aVRight-click the toolbox and select "Choose Items", use the Browse tab
p18069
aVYou are much better off just adding the UserControl to your project instead of putting it in a DLL by itself
p18070
aVWhen you do, it automatically appears at the top of the toolbox after you compile
p18071
as(dp18072
g9
V17034
p18073
stp18074
a((dp18075
g2
(lp18076
VThe KB article you linked is old, it was written before VS2008 came out
p18077
aVIt doesn't solve the problem, it is a fundamental limitation of C++
p18078
aVThere is no mechanism to verify that classes in separately built binaries have compatible memory layouts and were allocated with the same memory allocator
p18079
aVThings you can do to avoid the problem:
p18080
aVavoid exporting class objects
p18081
aVbuild your DLLs and EXE with /MD so they'll share the memory allocator
p18082
aVbuild all DLLs and EXE with the same compiler and CRT version
p18083
aVcarefully control the build settings to ensure they are the same for all projects, project property sheets are the best way to ensure this
p18084
as(dp18085
g9
V17034
p18086
stp18087
a((dp18088
g2
(lp18089
VYour SoundPlayer object should just be stored in a private field of your form class so that it stays referenced long enough
p18090
aVYou probably need to dispose it when your form closes
p18091
aVFwiw, pinning doesn't work because your class is missing a [StructLayout] attribute
p18092
aVNot that it will work effectively with one, you would have to store the returned GCHandle somewhere so that you can unpin it later
p18093
aVYour form class is the only logical place to store it
p18094
aVMake it simple
p18095
as(dp18096
g9
V17034
p18097
stp18098
a((dp18099
g2
(lp18100
VIt deadlocks inside the mmsys API code
p18101
aVCalling waveOutGetPosition() inside the callback deadlocks when the main thread is busy executing waveOutWrite()
p18102
aVIt is fixable, you'll need a lock so these two functions cannot execute at the same time
p18103
aVAdd this field to LeapFrogPlayer:
p18104
aVAnd use it in GetElapsedMilliseconds():
p18105
aVand HandleWaveCallback():
p18106
aVThis might have side-effects, I didn't notice any though
p18107
aVTake a look at the NAudio project
p18108
aVPlease use Build + Clean the next time you create an uploadable
p18109
aVzip of your project
p18110
as(dp18111
g9
V17034
p18112
stp18113
a((dp18114
g2
(lp18115
VYou'll have to do some parsing to convert it
p18116
aVThe format is yyyyMMddhhmmss
p18117
aVffffff+zzz (zzz is UTC offset in minutes)
p18118
aVThe SWbemDateTime
p18119
aVGetVarDate() method can do it for you
p18120
as(dp18121
g9
V17034
p18122
stp18123
a((dp18124
g2
(lp18125
VThat's not how Ngen works
p18126
aVIt only bypasses the JIT compilation step
p18127
aVThe resulting
p18128
aVni
p18129
aVdll file only contains machine code, not the metadata of the assembly
p18130
aVYou need to keep the original assembly available for that
p18131
aVAnd the CLR and the
p18132
aVNET framework assemblies must be available on the target machine, requiring you to install
p18133
aVNET
p18134
as(dp18135
g9
V17034
p18136
stp18137
a((dp18138
g2
(lp18139
VThis is not a source of flicker that double-buffering can solve
p18140
aVWhen the UC repaints itself, it draws the background image, leaving holes where the controls go
p18141
aVThe controls then each get to paint themselves, filling in the hole by first asking the UC to draw itself again to produce the background pixels, then draw themselves on top
p18142
aVThe temporary hole is what you see as flicker
p18143
aVYou can make it less objectionable by allowing the UC to draw itself in the client area of the controls so the background is already set correctly
p18144
aVPaste this code in the UserControl class:
p18145
aVThis doesn't make the painting any faster and may have side-effects
p18146
aVIf that is still a problem then you need to make the BackgroundImage draw faster
p18147
aVPrescale it to the client size of the user control so it can be drawn without rescaling
p18148
aVUse the PixelFormat
p18149
aVFormat32bppPArgb format for the bitmap, it is about 10x faster than any other one on most video adapters
p18150
as(dp18151
g9
V17034
p18152
stp18153
a((dp18154
g2
(lp18155
VIt is (arguably) a bug in the debugger
p18156
aVYou can add your vote to this feedback article
p18157
aVThis isn't easy to fix, I'm sure, the debugger doesn't have ready access to the base property getter method address since the v-table slot for the property getter has been replaced in the derived class
p18158
aVOne possible workaround is to store the base value in a local variable first so you can inspect that one
p18159
aVThat isn't going to make your getter any slower
p18160
as(dp18161
g9
V17034
p18162
stp18163
a((dp18164
g2
(lp18165
VIt is not a Z-order issue
p18166
aVThe problem is that you can't draw inside the client rectangle of another window
p18167
aVThe "Text" window in your case
p18168
aVA window like your "form" has the WS_CLIPCHILDREN style flag turned on
p18169
aVI'm not exactly sure how the Windows Forms designer manages to draw selection handles around the controls
p18170
aVBut when I look at the designer with Spy++, I see two otherwise invisible windows listed that are the size of the design area
p18171
aVThey are named "OverlayControl" and "AdornerWindow"
p18172
aVMy guess is that the designer actually draws the handles on one of those windows (OverlayControl probably) and that the windows background is transparent
p18173
aVI used a similar trick in this thread, you might be able to leverage the code
p18174
aVYou also really ought to take a look at this magazine article
p18175
as(dp18176
g9
V17034
p18177
stp18178
a((dp18179
g2
(lp18180
VFor some mysterious reason TimeSpan never got the ToString() overloads that support formatting until
p18181
aVNET 4
p18182
ag2512
aVFor earlier releases, as long as it is positive, you can hijack DateTime
p18183
aVToString():
p18184
as(dp18185
g9
V17034
p18186
stp18187
a((dp18188
g2
(lp18189
VI can't really understand the question
p18190
aVBut it sounds like you're trying to blend an image into the background
p18191
aVCheck out my code in this thread to see how to use ColorMatrix to achieve this
p18192
as(dp18193
g9
V17034
p18194
stp18195
a((dp18196
g2
(lp18197
VThis only works by accident on your machine
p18198
aVThe CLR has no reason to look inside the directory with your COM visible DLL for any dependencies
p18199
aVIt will probe the EXE folder and the GAC to look for them
p18200
aVNot sure how this accident happens on your machine, take a look at the assembly resolution with Fuslogvw
p18201
aVexe
p18202
aVMaybe your test program is in the same folder as your COM assembly
p18203
aVThe proper way to do this is to deploy the assemblies to the GAC (no /codebase)
p18204
aVImportant to avoid getting eaten alive by the DLL Hell problem that always lurks around the corner with COM
p18205
as(dp18206
g9
V17034
p18207
stp18208
a((dp18209
g2
(lp18210
VThe LocalFileSettingsProvider class, the one that manages the file with user settings, is quite impossible to tweak
p18211
aVWhomever wrote that must have been paralyzed by security concerns
p18212
aVPerhaps not unjustified
p18213
aVIf you want to stick with System
p18214
aVConfiguration then you'll need to implement your own provider
p18215
aVProbably the best way to do that is to start from the RegistrySettingsProvider sample
p18216
aVIt won't help you get the file handling right but at least you'll have something to build on
p18217
aVA couple of peeks with Reflector can help
p18218
as(dp18219
g9
V17034
p18220
stp18221
a((dp18222
g2
(lp18223
VYou'll want to use DropDownStyle = DropDownList so you can easily make sure that the user picked an entry from the list and can't type random text in the box
p18224
aVAdd an empty item to Items before you populate it (or "Please select")
p18225
aVNow, the default is automatically empty and the test is simple: just check that SelectedIndex > 0
p18226
as(dp18227
g9
V17034
p18228
stp18229
a((dp18230
g2
(lp18231
VOdd, nobody mentions this: it works so well with IntelliSense
p18232
aVType "this
p18233
aVand a list of valid member names pop up
p18234
aVIt didn't take me long to justify that with "well, it makes the scope of the identifier obvious"
p18235
as(dp18236
g9
V17034
p18237
stp18238
a((dp18239
g2
(lp18240
VA service runs in its own session, the infamous session 0 in Vista and Win7
p18241
aVThat session isolates services from the user desktop, it runs in another session
p18242
aVSpecifically to prevent a service that usually runs with a very privileged account (like LocalSystem) from interacting with the user
p18243
aVA security hole
p18244
aVAccordingly, a service cannot see the window handles owned by another session
p18245
aVNot sure why you are doing this but you typically need a helper program that presents a user interface and communicates with the service through an IPC mechanism like named pipes, sockets,
p18246
aVNET remoting or WCF
p18247
aVIf you use a named pipe, prefix the pipe name with  so all sessions can see it
p18248
as(dp18249
g9
V17034
p18250
stp18251
a((dp18252
g2
(lp18253
VThe x86 instruction set has tricky floating point consistency issues due the way the FPU works
p18254
aVInternal calculations are performed with more significant bits than can be stored in a double, causing truncation when the number is flushed from the FPU stack to memory
p18255
aVThat got fixed in the x64 JIT compiler, it uses SSE instructions, the SSE registers have the same size as a double
p18256
aVThis is going to byte you when your calculations test the boundaries of floating point accuracy and range
p18257
aVYou never want to get close to needing more than 15 significant digits, you never want to get close to 10E308 or 10E-308
p18258
aVYou certainly never want to square the largest representable value
p18259
aVThis is never a real problem, numbers that represent physical quantities don't get close
p18260
aVUse this opportunity to find out what is wrong with your calculations
p18261
aVIt is very important that you run the same operating system and hardware that your customer is using, high time that you get the machines needed to do so
p18262
aVShipping code that is only tested on x86 machine is not tested
p18263
aVThe Q&D; fix is Project + Properties, Compile tab, Platform Target = x86
p18264
aVFwiw, the bad result on x86 is caused by a bug in the JIT compiler
p18265
aVIt generates this code:
p18266
aVThe fmul instruction is missing, removed by the code optimizer in release mode
p18267
aVNo doubt triggered by it seeing the value at double
p18268
aVMaxValue
p18269
aVThat's a bug, you can report it at connect
p18270
aVmicrosoft
p18271
aVcom
p18272
aVPretty sure they're not going to fix it though
p18273
as(dp18274
g9
V17034
p18275
stp18276
a((dp18277
g2
(lp18278
VThe fact that a class is missing [Serializable] can be explained two ways
p18279
aVIt might be an error of omission, the more common case
p18280
aVOr the class can simply not support serialization
p18281
aVWhich is not unusual, classes often depend on state that cannot be faithfully reproduced at deserialization time because it depends on global program state
p18282
aVAny of the Windows Forms controls would be a good example, they can't be deserialized without having a native Windows window that is in the required state, a state that often requires other windows to be created as well (like the container window) and many messages
p18283
aVWell, this isn't going to help you implement your visualizer
p18284
aVYou can't reliably implement it with serialization
p18285
aVUsing reflection however gives you access to the same property and field values
p18286
aVAnd reflection is always supported
p18287
as(dp18288
g9
V17034
p18289
stp18290
a((dp18291
g2
(lp18292
VYour code has a serious problem, it adds a control to the user control every time the mouse hovers but never removes them
p18293
aVFirst, make very sure that the built-in ToolTip component doesn't already solve your problem
p18294
aVIt should, it behaves the way your describe
p18295
aVNote that it has the OwnerDraw property, it allows you to customize its appearance
p18296
aVCreating your own is tricky
p18297
aVA tool tip is a fairly unusual window, it isn't a child control like all other WF controls
p18298
aVIt is a top-level window, which allows it to overlap other windows and extend past the client area of the container window
p18299
aVThe only class in Windows Forms that behaves this way is the Form class
p18300
aVUsing a borderless form to implement your custom tool tip is possible
p18301
aVThe trickiest part is ensuring that it moves when the parent form of your user control moves
p18302
aVYou'll have to iterate the Parent property of the UC until you find a Form, then subscribe the LocationChanged, VisibleChanged and FormClosing events
p18303
aVYou'll also should wire the UC's ParentChanged and HandleDestroyed events
p18304
as(dp18305
g9
V17034
p18306
stp18307
a((dp18308
g2
(lp18309
VNot using break in your for(;;) loop is a serious stylistic mistake
p18310
aVBut you'll get away with it
p18311
aVBut not when you use foreach, you have to use the break keyword
p18312
aVPay attention to the title of this blog post
p18313
as(dp18314
g9
V17034
p18315
stp18316
a((dp18317
g2
(lp18318
VIt isn't that likely that your code will find the proper window
p18319
aVExcel is a single-instance app, it will open additional windows for each spreadsheet if you start it more than once
p18320
aVYou'll at a minimum have to iterate the windows it has open by P/Invoking EnumWindows and getting their title with GetWindowText
p18321
as(dp18322
g9
V17034
p18323
stp18324
a((dp18325
g2
(lp18326
VNot including WPF and WWF, I'm seeing:
p18327
aVSystem
p18328
aVNet"
p18329
aVSystem
p18330
aVNet
p18331
aVHttpListener"
p18332
aVSystem
p18333
aVNet
p18334
aVSockets"
p18335
aVSystem
p18336
aVNet
p18337
aVCache"
p18338
aVSystem
p18339
aVRuntime
p18340
aVSerialization
p18341
aVCodeGeneration"
p18342
aVSystem
p18343
aVServiceModel
p18344
aVOperationInvoker
p18345
aVCodeGeneration"
p18346
aVSystem
p18347
aVServiceModel
p18348
aVMessageLogging"
p18349
aVAnd one for VB
p18350
aVNET's My
p18351
aVApplication
p18352
aVLog
p18353
aVNote that these are trace source names, not class names
p18354
aVYou can use Red Gate's Reflector to find this yourself
p18355
as(dp18356
g9
V17034
p18357
stp18358
a((dp18359
g2
(lp18360
VThere are still lots of STL implementations that don't have a std::codecvt that can handle Unicode encodings
p18361
aVTheir wchar_t templated streams will default to the system code page, even though they are otherwise Unicode enabled for, say, the filename
p18362
aVIf the file actually contains UTF-8, they'll produce junk
p18363
aVMaybe this will help
p18364
as(dp18365
g9
V17034
p18366
stp18367
a((dp18368
g2
(lp18369
VYou are going to have a hard time finding sample code
p18370
aVCompiler writers use bootstrapping
p18371
aVThe first C compiler was written in B
p18372
aVWhich was then used to write the first C++ compiler
p18373
aVWhich was used to write the C# compiler
p18374
aVWhich is very commonly used to write compilers for managed code
p18375
aVThis is not a process that ever goes backwards
p18376
aVAlthough side-ways was common, C compilers often were used to cross-compile a compiler for another operating system
p18377
aVI think I used this book, it has terrific C compiler code in the appendices
p18378
aVWritten in C
p18379
aVI used parts of it when writing a Basic compiler I needed in a large project
p18380
aVThe expression parser is hard to get right, it has an elegant solution for the operator precedence rules
p18381
aVTargeting a managed language is the easier way to get this going
p18382
aVThe language shouldn't matter too much, it is getting it working that is the real challenge
p18383
aVEven though it is a lot easier to get managed code working
p18384
aVIf you want to target C, you'll need black-belt machine code skillz and deep insight in the object file format and the linker
p18385
as(dp18386
g9
V17034
p18387
stp18388
a((dp18389
g2
(lp18390
VThis is an error that's caused by mis-behaving unmanaged C/C++ code
p18391
aVThe unmanaged CRT verifies that code doesn't overrun the end of an array located on the stack by storing a cookie in the stack frame
p18392
aVWhen a function returns, it checks if the cookie is still there
p18393
aVIf it isn't, it assumes some kind of malicious code or a bug in the C/C++ code has destroyed the stack frame
p18394
aVFair assumption, that's how most virus infections worked in late nineties
p18395
aVThe odds are about 99
p18396
aV999% that this is a bug in the C/C++ code, 0
p18397
aV001% that the machine is under attack
p18398
aVYou'll need to find that C/C++ code and get a hold of the programmer that wrote it to get the bug fixed
p18399
aVIf you have no clue where to look, start by suspecting any kind of ActiveX control or COM server
p18400
aVAnd attach a debugger in unmanaged mode to a running version of your program to see what DLLs it has loaded
p18401
aVUse Debug + Windows + Modules and verify that you can account for all DLLs
p18402
aVOh, and the crash details would be verify helpful to localize the source
p18403
as(dp18404
g9
V17034
p18405
stp18406
a((dp18407
g2
(lp18408
VNo, a screenshot is exactly what it sounds like
p18409
aVYou'll read the pixels out of the video adapter, what you get is what you see
p18410
aVYou'll have to restore the window and bring it to the foreground to get the full view
p18411
aVWM_SYSCOMMAND+SC_RESTORE and SetForegroundWindow() respectively
p18412
aVPlus some time to allow the app to repaint its window if necessary
p18413
aVThe WM_PRINT message is available to ask a window to draw itself into a memory context
p18414
aVThat could handle the overlapped window problem
p18415
aVBut that can only work if is your window
p18416
aVAnd rarely has the expected result, programmers don't often implement WM_PRINT correctly
p18417
as(dp18418
g9
V17034
p18419
stp18420
a((dp18421
g2
(lp18422
VThat was only true in the olden days, back when RAM was expensive
p18423
aVThe operating system maps pages of virtual memory to RAM as needed
p18424
aVIf there isn't enough RAM to satisfy a program's request, it starts unmapping pages to make room
p18425
aVIf such a page contains data instead of code, it gets written to the paging file
p18426
aVWhenever the program accesses that page again, it generates a paging fault, letting the operating system read the page back from disk
p18427
aVIf the machine has little RAM and lots of processes consuming virtual memory pages, that can cause a very unpleasant effect called "thrashing"
p18428
aVThe operating system is constantly accessing the disk and machine performance slows down to a crawl
p18429
aVMore RAM means less disk access
p18430
aVThere's very little reason not to use 3 or 4 GB of RAM on a 32-bit operating system, it's cheap
p18431
aVEven if you do not get to use all 4 GB, not all of it will be addressable due hardware devices taking space on the address bus (video, mostly)
p18432
aVBut that won't change the size of the virtual memory accessible by user code, it is still 2 Gigabytes
p18433
aVWindows Internals is a good book
p18434
as(dp18435
g9
V17034
p18436
stp18437
a((dp18438
g2
(lp18439
VWell, you know the entry point name, use the EntryPoint = "
p18440
aVSetHook@@YA_NXZ" property in the [DllImport] attribute
p18441
aVOr put extern "C" before the declaration in your C++ code so the name doesn't get mangled
p18442
as(dp18443
g9
V17034
p18444
stp18445
a((dp18446
g2
(lp18447
VUnusual request
p18448
aVBut you can do it by selectively disable the theming for the control
p18449
aVAdd a new class to your project and paste the code shown below
p18450
aVCompile
p18451
aVDrop the new control from the top of the toolbox onto your form
p18452
as(dp18453
g9
V17034
p18454
stp18455
a((dp18456
g2
(lp18457
VI don't get the problem
p18458
aVHow else do you propose for the client to guess the port number that the server is using
p18459
aVMaybe you can create a DNS style "port-number lookup server"
p18460
aVBut then the client wouldn't know what port to use for that server either
p18461
aVPerhaps you can create a
p18462
aVconfig file for both the server and client and get somebody to make sure they contain the exact same number
p18463
aVWhich would be a one-time install hassle, they'll never change the number again
p18464
as(dp18465
g9
V17034
p18466
stp18467
a((dp18468
g2
(lp18469
VIt is not much of a functional spec
p18470
aVWhen it is supposed to turn off
p18471
aVAnyhoo, use a CheckBox, set Appearance = Button, AutoSize = False, TextAlign = MiddleCenter
p18472
as(dp18473
g9
V17034
p18474
stp18475
a((dp18476
g2
(lp18477
VSomething very fishy going on in the exception dump
p18478
aVThe call stack is clearly showing that it is executing Linq code, GetXmlReaderSettings() is only available in System
p18479
aVXml
p18480
aVLinq, a
p18481
aVNET 3
p18482
aV5 assembly
p18483
aVThe list of assemblies however doesn't show this assembly
p18484
aVIn fact that list looks corrupted, note the entry named "4u_pgrmq"
p18485
aVLoaded from System
p18486
aVdll, already listed before
p18487
aVThe
p18488
aVNET revision number is very low, 832 ought to be somewhere around the
p18489
aVNET 3
p18490
aV0 timeframe
p18491
aVPossible evidence that you've added 3
p18492
aV5 assemblies to an earlier installed version
p18493
aVOdds ought to be good that you'll solve this by simply installing
p18494
aVNET 3
p18495
aV5 SP1 on the machine
p18496
as(dp18497
g9
V17034
p18498
stp18499
a((dp18500
g2
(lp18501
VUsing the Microsoft convention might be a good idea
p18502
aVThe static version is prefixed "lib"
p18503
aVThe debug version is post-fixed "d"
p18504
aVThe 64-bit version goes in the amd64 subdirectory
p18505
aVNot the greatest convention but at least it is familiar
p18506
aVIn MSVC, you can use the predefined _DLL macro to detect that the user selected the DLL version of the CRT
p18507
aVThe _WIN64 macro is defined if the 64-bit compilation is selected
p18508
aVEnough to generate the required #pragma comment(lib, "name") directive
p18509
as(dp18510
g9
V17034
p18511
stp18512
a((dp18513
g2
(lp18514
VYou've declared a pointer to WIN32_FIND_DATA, you need a concrete instance of that structure
p18515
aVFix:
p18516
as(dp18517
g9
V17034
p18518
stp18519
a((dp18520
g2
(lp18521
VAwkward problem, there is no easy way to iterate the available RegionInfo
p18522
aVYou'd have to iterate all available specific cultures and create their RegionInfo to compare
p18523
aVThis code gets the job done:
p18524
aVBeware that this generates a lot of garbage
p18525
aVIf you do this often, be sure to cache the region info in a Dictionary<> first
p18526
as(dp18527
g9
V17034
p18528
stp18529
a((dp18530
g2
(lp18531
VThe problem is not in the posted snippet
p18532
aVYou'll need to start a new message loop with Application
p18533
aVRun() or Form
p18534
aVShowDialog()
p18535
aVYou'll also need to take care of thread properties so it is suitable to act as a UI thread
p18536
aVFor example:
p18537
aVThere are some awkward choices here
p18538
aVThe form cannot be owned by any form on your main thread, that usually causes Z-order problems
p18539
aVYou'll also need to do something meaningful when the UI thread's main form is closed
p18540
aVSloppily solved here by using IsBackground
p18541
aVWindows was designed to support multiple windows running on one thread
p18542
aVOnly use code like this if you really have to
p18543
aVYou should never have to
p18544
as(dp18545
g9
V17034
p18546
stp18547
a((dp18548
g2
(lp18549
VIt is not that clear to me what this getter might look like
p18550
aVHowever, you want to make sure that the designer doesn't serialize properties that should only ever be used at runtime
p18551
aVDo this with an attribute:
p18552
as(dp18553
g9
V17034
p18554
stp18555
a((dp18556
g2
(lp18557
VThis looks like a very low-level Windows error
p18558
aVWith some luck there's a breadcrumb in the Windows event log that tells you what DLL is missing on the target machine
p18559
aVA damaged registry is possible too
p18560
as(dp18561
g9
V17034
p18562
stp18563
a((dp18564
g2
(lp18565
VYes, the memory manager will do the job for you
p18566
aVNot without side-effects though, it is going to evict pages from RAM that other processes have mapped and give them to you
p18567
aVThose other processes are going to get slowed down by this, they'll be hit with a page fault when they access such a swapped-out page
p18568
aVThe balancing act here is whether your app is "important" enough to justify those other processes from getting short shrift
p18569
aVUsually that's Yes on a work station, a resounding No on a server
p18570
as(dp18571
g9
V17034
p18572
stp18573
a((dp18574
g2
(lp18575
VProject + Properties, C/C++, Optimization, Whole Program Optimization = No
p18576
aVThat at least ought to keep your Release build size from blowing up
p18577
aVI can't repro the debug library size, just the headers gives me a 111KB
p18578
aVlib
p18579
as(dp18580
g9
V17034
p18581
stp18582
a((dp18583
g2
(lp18584
VYou could just iterate the controls and remove the ampersands
p18585
aVFor example:
p18586
as(dp18587
g9
V17034
p18588
stp18589
a((dp18590
g2
(lp18591
VThat's not how it works
p18592
aVMarshal
p18593
aVGetExceptionCode only returns a meaningful number if the CLR has caught an SEH exception
p18594
aVIt will try to translate the exception into a meaningful managed exception
p18595
aVThe common ones are NullReferenceException, OverflowException, DivideByZeroException, StackOverflowException, AccessViolationException
p18596
aVSEHException is the fall-back one
p18597
aVYou can call GetExceptionCode while handling one of those exceptions
p18598
aVChicken-and-egg, the managed exception gets raised first
p18599
as(dp18600
g9
V17034
p18601
stp18602
a((dp18603
g2
(lp18604
VTurn off Whole Program Optimization to keep the size reasonable
p18605
aVProject + Properties, C/C++, Optimization
p18606
as(dp18607
g9
V17034
p18608
stp18609
a((dp18610
g2
(lp18611
VEvery situation
p18612
aVNo
p18613
aVIt is required for servers, they need to call Listen() and that's meaningless unless Socket knows what IP-address to listen on
p18614
aVClients only have to call Connect(), that takes an IP-address
p18615
aVThe TcpListener class hides the Bind() call for you
p18616
as(dp18617
g9
V17034
p18618
stp18619
a((dp18620
g2
(lp18621
VIt is because your "restart" identifier is data, not code
p18622
aVIt probably should have been named "restart_state"
p18623
aVExporting data from a DLL is a supported scenario but a good way to blow your foot off
p18624
aVThe client code has to have strict binary compatibility with the DLL code
p18625
aVThat's a very questionable proposition for setjmp(), the saved state is highly implementation dependent
p18626
aVYou are much better off exporting functions that make the setjmp() and longjmp() calls and keep the jmp_buf private
p18627
as(dp18628
g9
V17034
p18629
stp18630
a((dp18631
g2
(lp18632
VYou didn't post the code for you WebDLAmountChanged method
p18633
aVBut the error message says its argument should have been declare As Long but isn't
p18634
aVFix:
p18635
as(dp18636
g9
V17034
p18637
stp18638
a((dp18639
g2
(lp18640
VIni files are quite okay in my book
p18641
aVThe problem is GetPrivateProfileString() and cousins
p18642
aVAppcompat has turned that into one ugly mutt of an API function
p18643
aVRetrieving a single ini value takes about 50 milliseconds, that's a mountain of time on a modern PC
p18644
aVBut the biggest problem is that you can't control the encoding of the INI file
p18645
aVWindows will always use the system code page to interpret strings
p18646
aVWhich is only okay as long as your program doesn't travel far from your desk
p18647
aVIf it does, it has a serious risk of producing gibberish when you don't restrict the character set used in your INI file to ASCII
p18648
aVXML doesn't have this problem, it is well supported by the
p18649
aVNET framework
p18650
aVWhether by using settings or managing your config yourself
p18651
as(dp18652
g9
V17034
p18653
stp18654
a((dp18655
g2
(lp18656
VNot sure if it is worth the effort for a property that is so easy to change and so easy to see that it has the wrong value
p18657
aVBut you can create your own item template
p18658
aVFor example: Project + Add User Control
p18659
aVSet its Localizable property to True
p18660
aVFile + Export Template, select Item template
p18661
aVNext
p18662
aVCheck the control you added
p18663
aVNext
p18664
aVCheck all references, omit only the ones you'll never need
p18665
aVNext
p18666
aVGive it is good template name (say: "Localizable User Control")
p18667
aVYou'll now have an item template available for future projects that has the property set
p18668
aVRepeat as necessary for other item templates, like a Form
p18669
as(dp18670
g9
V17034
p18671
stp18672
a((dp18673
g2
(lp18674
VI don't see the problem
p18675
aVIf you implement A, B and C then interface A must QI properly for A, B, C and IUnknown
p18676
aVIncluding itself
p18677
aVThe test is the same for all interfaces, you need only one small function that takes an IUnknown* argument
p18678
as(dp18679
g9
V17034
p18680
stp18681
a((dp18682
g2
(lp18683
VYou'll need to call WindowsIdentity
p18684
aVImpersonate() on the thread
p18685
aVIt is one of the very few
p18686
aVNET class methods where you have to use P/Invoke, LogonUser() is necessary to get the impersonation token
p18687
aVIt is well described in the code example shown in the linked MSDN article
p18688
as(dp18689
g9
V17034
p18690
stp18691
a((dp18692
g2
(lp18693
VNET has a very nice and reliable way to tell you that there's something wrong
p18694
aVBut that stops working when you catch Exception and don't do anything to let the user (or you) know what is wrong
p18695
aVYour catch statement is hiding all kinds of serious problems, like OutOfMemory
p18696
aVDebug + Exceptions, check "Common Language Runtime Exceptions" and run your program
p18697
as(dp18698
g9
V17034
p18699
stp18700
a((dp18701
g2
(lp18702
VYou can do it with a macro
p18703
aVMake it look like this:
p18704
aVBind it to a key other than Ctrl-K+C, you'll want to keep that one around
p18705
as(dp18706
g9
V17034
p18707
stp18708
a((dp18709
g2
(lp18710
VIt is a limitation of ClickOnce
p18711
aVThe retail edition allows you to create installers that will deploy your app for all users
p18712
aVBut the Express edition doesn't support Setup projects
p18713
aVThat's one of the ways they encourage you to pay for the license
p18714
aVBackgrounder info is in this blog post
p18715
as(dp18716
g9
V17034
p18717
stp18718
a((dp18719
g2
(lp18720
VThe Type class is used in a lot more places, not just System
p18721
aVReflection
p18722
aVA quick search with Reflector reveals hundreds of them
p18723
aVIt is crucial in System
p18724
aVConfiguration, System
p18725
aVData,  System
p18726
aVDrawing, System
p18727
aVLinq, System
p18728
aVWindows
p18729
aVForms, etc
p18730
aVThe way the Type instance is actually used in these classes isn't visible
p18731
aVIt is likely that System
p18732
aVReflection is used but that's an implementation detail that in no way affects the program
p18733
aVGiven that creating the Type instance that these classes need is trivial with the typeof operator and object
p18734
aVGetType and that you never have to use System
p18735
aVReflection unless you actually write reflection code, Type certainly deserves an easily accessible location in the System namespace
p18736
as(dp18737
g9
V17034
p18738
stp18739
a((dp18740
g2
(lp18741
VIt is possible with the undocumented __arglist keyword:
p18742
aVPlease don't use that
p18743
as(dp18744
g9
V17034
p18745
stp18746
a((dp18747
g2
(lp18748
VYou can't ship an ngen-ed image, Ngen
p18749
aVexe must run on the target machine
p18750
aVThere's a dedicated service, installed by the
p18751
aVNET installer that takes care of it
p18752
aVIt doesn't help protect anything anyway, the original assembly must still be present as well
p18753
aVNET has built-in support for licensing but it only works for designable classes
p18754
aVSystem
p18755
aVComponentModel
p18756
aVLicense is the base class declaration
p18757
aVLicFileLicenseProvider is a concrete implementation of it
p18758
aVYou can buy something 3rd party, dongles are unbeatable
p18759
aVEither way, the only true protection you'll get for your IP is in a court of law
p18760
aVClaim copyright in a visible place, ensure your user goes through an explicit license agreement step before using your code
p18761
as(dp18762
g9
V17034
p18763
stp18764
a((dp18765
g2
(lp18766
VThe exception tells you that the function has corrupted the garbage collected heap
p18767
aVIt writing past the end of the array
p18768
aVIf it is actually a FooClass[], big question, then you'll have to create the array first:
p18769
aVWhich assumes that the function will fill the array with FooClass objects
p18770
aVThe size of the array really matters here, you'll have to have some kind of idea how many elements you'll get back
p18771
aVThat can only work reliable if "iNum" is an argument that says how long the array is
p18772
aVPass array
p18773
aVLength
p18774
aVIt could also mean that the function will create the array itself and return a pointer to it
p18775
aVYou're really screwed if that's the case, you cannot release the memory for the array
p18776
as(dp18777
g9
V17034
p18778
stp18779
a((dp18780
g2
(lp18781
VUsing ISerializable is not the recommended way to deal with versioning
p18782
aVThe [OptionalField] is, the ins and outs are well described in this MSDN library article
p18783
aVAnswering your question: SerializationInfo
p18784
aVGetValue("fieldName", typeof(Color)) ought to give you the color
p18785
aVYou'll need to cast the return value
p18786
as(dp18787
g9
V17034
p18788
stp18789
a((dp18790
g2
(lp18791
VThat happened because it doesn't make any sense to have Copy Local = True if an assembly is installed in the GAC
p18792
aVBecause that local copy will never be used, the GAC is always searched first
p18793
aVLeaving it unchanged would cause major confusion, you'd think you are using the local copy but get another one instead
p18794
aVChanging it causes a confusion too, if you don't notice it, that could perhaps have been addressed with a message box at solution load time
p18795
aVLog4net is a troublemaker, there are way too many versions in the wild without any deployment procedure that ensures that those versions don't bite each other
p18796
aVSomething Apache apparently just didn't want to address, leaving it up to the programmer instead
p18797
aVHaving products that take a dependency on Log4net and do something about the perceived DLL Hell risk is somewhat inevitable
p18798
aVGiving you a DLL Hell problem in return
p18799
aVNo clean simple answers, beyond being aware what's installed on your machine
p18800
aVConsider posting to connect
p18801
aVmicrosoft
p18802
aVcom to ask for a warning when Visual Studio automatically updates the Copy Local property
p18803
aVIt is a reasonable ask
p18804
as(dp18805
g9
V17034
p18806
stp18807
a((dp18808
g2
(lp18809
VThe ValidateChildren() method prevents the form from closing
p18810
aVPaste this code in your form to fix that:
p18811
as(dp18812
g9
V17034
p18813
stp18814
a((dp18815
g2
(lp18816
VYou cannot [DllImport] MFC classes, it only works for static functions
p18817
aVTurning them into COM coclasses is only technically possible, the surgery is major
p18818
aVThe best way to do this is by writing managed class wrappers in the C++/CLI language
p18819
aVYou'd write a ref class for every MFC class
p18820
aVIt stores a pointer to the MFC class object, every method directly calls the corresponding MFC class method
p18821
aVIn the vast majority of cases that's one line of code
p18822
aVIt is a very mechanical process, you can use SWIG to do the job for you
p18823
aVNot sure how good it is, never used it myself
p18824
aVA decent tutorial on C++/CLI and the wrapper approach is available here
p18825
as(dp18826
g9
V17034
p18827
stp18828
a((dp18829
g2
(lp18830
VSad problem to have in this day and age
p18831
aVClearly the NFD form that the MAC uses is causing you this headache
p18832
aVOne thing you could consider is removing the diacritics from the glyphs that causes NFD to be different from NFC
p18833
aVI'm not 100% sure this is completely accurate (especially for Asian scripts), but it ought to be close:
p18834
as(dp18835
g9
V17034
p18836
stp18837
a((dp18838
g2
(lp18839
VThe point of using the mutex is that you don't know what thread might make the callback
p18840
aVYes, a critical section would work too
p18841
aVCareful, getting it wrong causes random and very hard to diagnose failure
p18842
as(dp18843
g9
V17034
p18844
stp18845
a((dp18846
g2
(lp18847
VProject + Properties, Build tab, Platform Target
p18848
aVThat should be set to Any CPU, the default
p18849
aVWhich will automatically make your code run 64-bit when you run it on a 64-bit version of Windows
p18850
aVThe JIT compiler takes care of it
p18851
aVYou will have to install the 64-bit version of the
p18852
aVocx on the machine to make this work
p18853
as(dp18854
g9
V17034
p18855
stp18856
a((dp18857
g2
(lp18858
VTrapping unhandled exceptions requires calling SetUnhandledExceptionFilter() in the process
p18859
aVThat's going to be difficult to do if you don't have source code, although it is technically possible by injecting a DLL into the process
p18860
aVThis however cannot be done with managed code, you can't get the CLR initialized properly
p18861
aVThe default unhandled exception handler that Windows installs will always run WerFault
p18862
aVexe, the Windows Error Reporting tool
p18863
aVThat can be turned off but that's a system setting
p18864
aVExpecting your user or admin to do this is not realistic
p18865
aVOnly after WER runs will the JIT debugger get a shot at it
p18866
aVI recommend a simpler approach, one that's also much more selective
p18867
aVUse the Process class to get the program you're interested in protecting started
p18868
aVWhen the Exited event fires, use the ExitCode property to find out how it terminated
p18869
aVAny negative value is a sure sign that the process died on an unhandled exception, the exit code matches the exception code
p18870
aVYou can use the EventLog class to read the event message that WER writes to the Windows event log
p18871
aVAnd you can restart it the same way you got it started
p18872
as(dp18873
g9
V17034
p18874
stp18875
a((dp18876
g2
(lp18877
VYes, available in Analyze menu
p18878
aVBut only in the Team System edition
p18879
as(dp18880
g9
V17034
p18881
stp18882
a((dp18883
g2
(lp18884
VFollowing the links in that article takes you to this one
p18885
aVQuoting:
p18886
aVTo determine if a specified directory
p18887
aVis a mounted folder, first call the
p18888
aVGetFileAttributes function and inspect
p18889
aVthe FILE_ATTRIBUTE_REPARSE_POINT flag
p18890
aVin the return value to see if the
p18891
aVdirectory has an associated reparse
p18892
aVpoint
p18893
aVIf it does, use the
p18894
aVFindFirstFile and FindNextFile
p18895
aVfunctions to obtain the reparse tag in
p18896
aVthe dwReserved0 member of the
p18897
aVWIN32_FIND_DATA structure
p18898
aVTo
p18899
aVdetermine if the reparse point is a
p18900
aVmounted folder (and not some other
p18901
aVform of reparse point), test whether
p18902
aVthe tag value equals the value
p18903
aVIO_REPARSE_TAG_MOUNT_POINT
p18904
aVFor more
p18905
aVinformation, see Reparse Points
p18906
as(dp18907
g9
V17034
p18908
stp18909
a((dp18910
g2
(lp18911
VIt is easy to see from TaskMgr
p18912
aVexe, Processes tab
p18913
aVView + Select Columns, tick GDI Objects
p18914
aVYour description indeed matches a handle leak
p18915
aVThat shouldn't really happen in a managed program, the finalizer should take care of you forgetting to call Dispose()
p18916
aVUnless you don't consume a lot of garbage collected heap space
p18917
aVIt could also be the unmanaged app leaking handles, they very often do
p18918
as(dp18919
g9
V17034
p18920
stp18921
a((dp18922
g2
(lp18923
VThe lingua franca of interop in unmanaged code is COM
p18924
aVThat's very easy to get going on the C# side, just use the ] attribute
p18925
aVYou'll need to write COM code in your C++ program to use it, not so easy to get going if you've never done that
p18926
aVStart with the #import directive if you use the MSVC compiler
p18927
aVYour next option is to host the CLR in your unmanaged code yourself rather than relying on the COM interop layer to take care of it
p18928
aVIt allows you to create managed types directly
p18929
aVThis requires COM as well, but only to get the CLR loaded and initialized
p18930
aVThis project shows the approach
p18931
as(dp18932
g9
V17034
p18933
stp18934
a((dp18935
g2
(lp18936
VUnless you run on a very constrained embedded CPU with a very small stack, there is no reason to allocate that buffer from the heap
p18937
aVOne kilobyte is peanuts
p18938
aVChange your declaration to this:
p18939
aVand you can exit your function without having to clean up
p18940
as(dp18941
g9
V17034
p18942
stp18943
a((dp18944
g2
(lp18945
VYou are definitely tackling this problem from the wrong end
p18946
aVHacking the hex isn't ever going to get you what you want, the PE file structure is too sophisticated
p18947
aVYou'll need two things
p18948
aVMatt Pietrek's seminal article is essential reading to understand the structure
p18949
aVDon't get started on code until you understand at least 75% of it
p18950
aVYou'll need the Windows SDK
p18951
aVThe include/winnt
p18952
aVh file contains the declarations of the structures used in the PE format
p18953
aVIt starts at _IMAGE_DOS_HEADER, the first chunk of the file
p18954
aVWrite the code to create the structures from their declarations, that's the only way to end up with a valid executable file
p18955
aVPS: your hex dumps hang up the browsers of anybody that tries to look at your question
p18956
as(dp18957
g9
V17034
p18958
stp18959
a((dp18960
g2
(lp18961
VSounds to me you've found a buffer overflow bug in Visual Studio
p18962
aVYou're well past the typical usage scenario for snippets, this wouldn't be tested often
p18963
aVPost your bug to connect
p18964
aVmicrosoft
p18965
aVcom for feedback
p18966
aVDon't forget to document the service pack and IDE you use, as well as including the snippet
p18967
aVYou didn't do that in your question but that's the only way anybody can truly diagnose this issue
p18968
as(dp18969
g9
V17034
p18970
stp18971
a((dp18972
g2
(lp18973
VHard to formulate an answer that could even remotely be considered helpful
p18974
aVSurely you've already considered that the number of records might be the problem
p18975
aVIf it is a design-time issue then surely you've considered tweaking the report query temporarily so that it only returns a few records
p18976
aVIf it is a runtime issue then consider asking for a nice new machine with >= 8 Gigabytes of RAM and a 64-bit operating system
p18977
as(dp18978
g9
V17034
p18979
stp18980
a((dp18981
g2
(lp18982
VCheck my code in this thread for a trick to keep list boxes scrolling in-sync
p18983
aVTurning off the scrollbar requires overriding the CreateParams property:
p18984
as(dp18985
g9
V17034
p18986
stp18987
a((dp18988
g2
(lp18989
VThe native TreeView control isn't going to be helpful at all to make this work
p18990
aVProgramming one yourself is a tricky proposition
p18991
aVIt is however a very popular UI gadget
p18992
aVAny component vendor sells one, invariably called "TreeList"
p18993
aVYou'll have to do some shopping if you want to use such a component from unmanaged C/C++
p18994
aVAn ActiveX version of such a control is as close as you can get
p18995
aVMost component vendors have however put that in their legacy bag
p18996
as(dp18997
g9
V17034
p18998
stp18999
a((dp19000
g2
(lp19001
VNah, that's not it
p19002
aVThe error code, converted to hex, is 0x80070057
p19003
aVThe 7 indicates a Windows error, 57 is error code 87, ERROR_INVALID_PARAMETER, "The parameter is incorrect"
p19004
aVA couple of possible reasons
p19005
aVFirst is that entry point #232 isn't actually the entry point for SHSetFolderPath()
p19006
aVYou might be calling a different function, it wouldn't know what to do with the argument values you pass
p19007
aVHard to say, it is an unnamed entry point on XP's version of shell32
p19008
aVdll
p19009
aVOr it could be that XP just isn't happy about you changing the desktop folder path
p19010
aVNot that surprising, there's a heckofalot it has to do to actually implement that, refreshing all Explorer
p19011
aVexe views, rebuilding the desktop contents and whatnot
p19012
aVCheck this thread for possible help
p19013
as(dp19014
g9
V17034
p19015
stp19016
a((dp19017
g2
(lp19018
VMost math coprocessors have an option to truncate denormal values to zero
p19019
aVOn x86 it is the FZ (Flush to Zero) flag in the MXCSR control register
p19020
aVCheck your CRT implementation for a support function to set the control register
p19021
aVIt ought to be in , something resembling _controlfp()
p19022
aVThe option bit usually has "FLUSH" in the #defined symbol
p19023
aVDouble-check your math results after you set this
p19024
aVWhich is something you ought to do anyway, getting denormals is a sign of health problems
p19025
as(dp19026
g9
V17034
p19027
stp19028
a((dp19029
g2
(lp19030
VThe Message constructor uses XML serialization to serialize your "observation" object
p19031
aVYou'll need to make sure that this works properly
p19032
aVXML serialization will only deal with public members of the class, it is not going to serialize private members
p19033
aVYour object may well look "empty" after it is deserialized again
p19034
aVHere's some test code to verify that it works properly:
p19035
as(dp19036
g9
V17034
p19037
stp19038
a((dp19039
g2
(lp19040
VI think the following verbiage in section 26
p19041
ag2586
aV1 of the C# Language Specification is important:
p19042
aVSimilar to an
p19043
aVanonymous-method-expression, a
p19044
aVlambda-expression is classified as a
p19045
aVvalue with special conversion rules
p19046
aVThe value does not have a type but can
p19047
aVbe implicitly converted to a
p19048
aVcompatible delegate type
p19049
aVSpecifically, a delegate type D is
p19050
aVcompatible with a lambda-expression L
p19051
aVprovided:  [List elided]
p19052
aVWhich prevents code like this from compiling:
p19053
aVWhich leads to:
p19054
aVDefeated by the compiler disallowing conversions from one delegate type to another, even if their signatures are compatible
p19055
aVForcing:
p19056
aVWhich compiles without trouble
p19057
aVIrrelevant bonus feature: early usability tests on the first Apple Mac discovered a problem with the first version of the OK button on the dialogs that used a sans-serif font
p19058
aVUsers were often clicking Cancel instead, with some visible anguish
p19059
aVAfter several interviews, one user finally admitted the problem: "I hate it when a computer calls me a Dolt
p19060
aVWell, a compiler calling you a dolt perhaps isn't that irrelevant :)
p19061
as(dp19062
g9
V17034
p19063
stp19064
a((dp19065
g2
(lp19066
VYou can do it application-wide by filtering the key down messages with IMessageFilter
p19067
aVHere's an example:
p19068
aVOne thing I pursued is the repeat count in the WM_KEYDOWN message
p19069
aVOddly this didn't work on my machine, it was 1 for repeating keys
p19070
aVNot sure why
p19071
as(dp19072
g9
V17034
p19073
stp19074
a((dp19075
g2
(lp19076
VYour original code can only work for reference types
p19077
aVThat's why string wasn't a problem, it directly derives from System
p19078
aVObject
p19079
aVThat a value type derives from ValueType and Object is a nice illusion on paper but actually requires code
p19080
aVThe C# compiler automatically emits that code, it requires a boxing conversion
p19081
aVThat's the part that is missing here, there is no runtime conversion from int to object without the BOX opcode
p19082
aVYou can get that opcode in your code, but you'll have to use System
p19083
aVReflection
p19084
aVEmit
p19085
aVBefore you go there, first check if what you've got now is actually too slow
p19086
aVThe expense of reflection is digging the metadata out of the assembly
p19087
aVThat was done when you created the delegate, the type info is cached after that
p19088
as(dp19089
g9
V17034
p19090
stp19091
a((dp19092
g2
(lp19093
Vshould not be there
p19094
aV$(DIRECTX_ROOT) requires the macro to be set in a project property sheet
p19095
aVYou are better off spelling it out:
p19096
as(dp19097
g9
V17034
p19098
stp19099
a((dp19100
g2
(lp19101
VRelease build
p19102
aVThe better approach to debug the control is to simply add the control project to your solution
p19103
aVAfter compiling, you'll automatically get the control at the top of the toolbox, ready to drop on a form
p19104
aVThat also automatically adds the assembly reference
p19105
as(dp19106
g9
V17034
p19107
stp19108
a((dp19109
g2
(lp19110
VIt is not
p19111
aVWebBrowser uses Internet Explorer which is a COM component
p19112
aVCOM components have a threading model, IE uses "Apartment"
p19113
aVWhich is an expensive word that means it is not thread-safe
p19114
aVYou are allowed to call its methods in a BGW but COM will automatically marshal the call to the UI thread
p19115
aVSince all method calls and property accesses actually happen on the UI thread, you will make it slower by using a BGW
p19116
aVYou can in fact run WebBrowser on another thread, you'll have to create an instance of it on that thread
p19117
aVAnd you will have to create a thread that is a so-called Single Threaded Apartment
p19118
aVSTA, an acronym you might well recognize from the [STAThread] attribute on the Main() method of a Winforms or WPF application
p19119
aVChanging a worker thread to STA requires calling Thread
p19120
aVSetApartmentState() before you start it
p19121
aVYou cannot do this for a BGW
p19122
aVAnd the thread must pump a message loop to implement the STA contract, it must call Application
p19123
aVRun()
p19124
aVRequired, for one, to get WebBrowser to raise its events
p19125
aVThis answer shows the approach
p19126
aVConsider using the WebRequest class
p19127
as(dp19128
g9
V17034
p19129
stp19130
a((dp19131
g2
(lp19132
VIt is pretty simple: it looks in the directory where the
p19133
aVexe is stored for an appname
p19134
aVexe
p19135
aVconfig file
p19136
aVThat makes it unsuitable for your intended use
p19137
as(dp19138
g9
V17034
p19139
stp19140
a((dp19141
g2
(lp19142
VYes, events generated by the SystemEvents class (SessionSwitch here) are apt to cause deadlock when a program is violating Windows threading rules
p19143
aVIt isn't clear to me exactly how that came about in your case but it sounds to me that you've been battling threading issues for a while already
p19144
aVNET 2
p19145
aV0 has built-in diagnostics for this
p19146
aVBe sure to leverage this, it only works in the debugger
p19147
aVMake sure you didn't set Control
p19148
aVCheckForIllegalCrossThreadCalls to false
p19149
as(dp19150
g9
V17034
p19151
stp19152
a((dp19153
g2
(lp19154
VYes, this is a limitation in the exception handling logic
p19155
aVIf a method contains more than one throw statement that throws an exception then you'll get the line number of the last one that threw
p19156
aVThis example code reproduces this behavior:
p19157
aVOutput:
p19158
aVThe work-around is simple, just use a helper method to run the code that might throw an exception
p19159
aVLike this:
p19160
aVThe underlying reason for this awkward behavior is that
p19161
aVNET exception handling is built on top of the operating system support for exceptions
p19162
aVCalled SEH, Structured Exception Handling in Windows
p19163
aVWhich is stack-frame based, there can only be one active exception per stack frame
p19164
ag3471
aVNET method has one stack frame, regardless of the number of scope blocks inside the method
p19165
aVBy using the helper method, you automatically get another stack frame that can track its own exception
p19166
aVThe jitter also automatically suppresses the inlining optimization when a method contains a throw statement so there is no need to explicitly use the [MethodImpl] attribute
p19167
as(dp19168
g9
V17034
p19169
stp19170
a((dp19171
g2
(lp19172
VNope, you can't down-cast a FireGridUnit to a FireResult
p19173
aVThe other way around is fine
p19174
aVEither you serialized the wrong object or the cast you used on the return value of Deserialize() is wrong
p19175
as(dp19176
g9
V17034
p19177
stp19178
a((dp19179
g2
(lp19180
VYes, I repro
p19181
aVThe largest buffer I can read back is 32766 bytes
p19182
aVLarger values produce ERROR_BAD_LENGTH
p19183
aVWith the checksum and the terminating zero, looks to me that it uses an internal buffer that is (32766+2) * 2 = 65536 bytes long
p19184
aVMakes somewhat sense, this is a legacy 16-bit API
p19185
aVYou really ought to consider using a regular file
p19186
aVBut a workaround is to split the buffer in two
p19187
as(dp19188
g9
V17034
p19189
stp19190
a((dp19191
g2
(lp19192
VI think this blog post by Junfeng Zhang is relevant, especially the earlier blog post he links to about assembly identity
p19193
aVAs usual with him, I don't understand any of it
p19194
aVGood luck
p19195
as(dp19196
g9
V17034
p19197
stp19198
a((dp19199
g2
(lp19200
VI think you'll need LsaEnumerateAccountRights()
p19201
aVThat isn't exposed in
p19202
aVNET but is being used
p19203
aVUse Reflector and take a look at the private ServiceProcessInstaller
p19204
aVAccountHasRight method
p19205
as(dp19206
g9
V17034
p19207
stp19208
a((dp19209
g2
(lp19210
VHow soon after boot does your service start
p19211
aVThe Windows Time service can adjust the clock to get it in sync with a domain controller
p19212
aVYour DateTime
p19213
aVNow value might be taken before that happens
p19214
aVDiagnose this first by entering the BIOS at boot-up and checking the clock
p19215
aVFix it with a service dependency
p19216
as(dp19217
g9
V17034
p19218
stp19219
a((dp19220
g2
(lp19221
VWell, you found out why it leaves a space around the Image property
p19222
aVYou can customize the rendering of the button by assigning the ToolStrip
p19223
aVRenderer property
p19224
aVThat could look something like this:
p19225
aVYou'll have to fill in the // Something
p19226
aVlines and do some kind of drawing that makes it obvious to the user that the button is pressed or selected
p19227
aVMaybe draw a rectangle with a thick Pen, it is up to you
p19228
as(dp19229
g9
V17034
p19230
stp19231
a((dp19232
g2
(lp19233
VWhat you are trying to do is equivalent to drinking from a fire hose
p19234
aVYou are relying on the receive buffer to store the water, it isn't going to last long when somebody doesn't turn the tap off
p19235
aVWith your workaround, you are making sure that the receive buffer will overflow silently, you probably didn't implement the ErrorReceived event
p19236
aVTo make this work, you'll have to tell the input device to stop sending when the buffer is full
p19237
aVDo that by setting the Handshake property
p19238
aVSet it to Handshake
p19239
aVRequestToSend first
p19240
aVUse XOnXOff next
p19241
aVIt depends on the device whether it will use the handshake signals properly
p19242
aVUse the Read() method to make this a bit more efficient
p19243
aVOkay, not fire hose
p19244
aVI can think of only one other possibility
p19245
aVA common problem with early UART chip designs, they had a on-chip receive buffer that could store only one byte
p19246
aVWhich required the interrupt service routine to read that byte before the next one arrived
p19247
aVIf the ISR isn't quick enough, the chip turns on the SerialError
p19248
aVOverrun state and the byte is irretrievably lost
p19249
aVA workaround for this issue was to artificially put a delay between each transmitted byte, giving the ISR in the device more time to read the byte
p19250
aVWhich is what your workaround code does, as a side-effect
p19251
aVIt is not a great explanation, modern chip designs have a FIFO buffer that's at least 8 bytes deep
p19252
aVIf there is any truth to this at all, you should see the problem disappear when you lower the baudrate
p19253
aVAlso, using Read() instead of ReadByte() should make the problem worse since your Write() call can now transmit more than one byte at a time, eliminating the inter-character delay
p19254
aVTo be clear, I'm talking about the output device
p19255
as(dp19256
g9
V17034
p19257
stp19258
a((dp19259
g2
(lp19260
VNo, it's not
p19261
aVNET
p19262
aVShell programming is in the domain of unmanaged C/C++
p19263
aVShell32
p19264
aVdll has a type library that makes some functions available to scripting languages and
p19265
aVNET
p19266
aVBut the IShellIconOverlay interface inherits from IUnknown, not accessible to scripting
p19267
aVIt is technically possible but you'll have to redeclare the interface in C#, using the declaration in the SDK's ShlObj
p19268
aVh header file as a template
p19269
aVSomebody has done it somewhere, probably, but it is uncommon to try to make it work
p19270
aVA quick Google search turns up nothing useful
p19271
aVHopefully,
p19272
aVNET 4
p19273
aV0 will revive some activity, solving the CLR version injection problem
p19274
aVI haven't yet seen a sign of it
p19275
as(dp19276
g9
V17034
p19277
stp19278
a((dp19279
g2
(lp19280
VProbably because one Korean Won is worth $0
p19281
aV00088
p19282
aVThey don't have pennies
p19283
aVSame idea with the Swiss Franc, the 1 centime coin stopped being legal tender in 2007
p19284
as(dp19285
g9
V17034
p19286
stp19287
a((dp19288
g2
(lp19289
VIf it is a value type then you are done quick, just return "original":
p19290
aVYou'll have more trouble making this truly universal, a type doesn't have to have a parameter-less constructor
p19291
aVTry a String for example
p19292
as(dp19293
g9
V17034
p19294
stp19295
a((dp19296
g2
(lp19297
VIt is a persistent myth that the JIT compiler in managed code generates machine code that is a lot less efficient than the one generated by a C/C++ compiler
p19298
aVManaged code usually wins on memory management and floating point math, C/C++ usually wins when the code optimizer can spend a lot more time optimizing code
p19299
aVIn general, managed code is about 80% but it completely depends on the 10% of the code where a program spends 90% of its time
p19300
aVYour test won't show this, you didn't enable the optimizer and there isn't much to optimize
p19301
as(dp19302
g9
V17034
p19303
stp19304
a((dp19305
g2
(lp19306
VTough question
p19307
aVHWNDs and HDCs are GDI handles, not kernel handles, I doubt DuplicateHandle() works on them
p19308
aVHWNDs can be shared between processes, SendMessage() wouldn't work otherwise
p19309
aVThey are however scoped, at a minimum on sessions, possibly desktops
p19310
aVFor example, on Vista and Win7 session 0 where the services run cannot see the window handles of the desktop session
p19311
aVOr the logon session, you can't mess with the password entry box
p19312
aVBut as long as both processes run in the desktop you won't have any trouble
p19313
aVWM_COPYDATA is another IPC mechanism
p19314
aVHDCs are murky, never tried that
p19315
aVI wouldn't recommend it
p19316
aVYou can always create one from a HWND
p19317
as(dp19318
g9
V17034
p19319
stp19320
a((dp19321
g2
(lp19322
VDon't use the FormClosing event for this, you'll want to allow the user to dismiss the dialog with either Cancel or clicking the X
p19323
aVSimply implement the OK button's Click event handler and don't close until you are happy:
p19324
aVWhere "ValidateControls" is your validation logic
p19325
aVReturn false if there's something wrong
p19326
as(dp19327
g9
V17034
p19328
stp19329
a((dp19330
g2
(lp19331
VUsing the Enter event (better then GotFocus) is certainly a good approach
p19332
aVSubscribe a handler for all controls, then go find the parent of the control in the Enter event handler
p19333
aVThis sample code demonstrates the approach:
p19334
as(dp19335
g9
V17034
p19336
stp19337
a((dp19338
g2
(lp19339
VYou could prevent editing with the CellBeginEdit event if the cell isn't in the right column
p19340
aVFor example, if the checkbox is in the first column:
p19341
as(dp19342
g9
V17034
p19343
stp19344
a((dp19345
g2
(lp19346
VIf is File Not Found, not a permission problem
p19347
aVThe 7 indicates a Windows error, 2 is ERROR_FILE_NOT_FOUND
p19348
aVThe usual trouble with COM visible components is either Windows or the CLR not being able to find dependent DLLs
p19349
aVBut that should generate a different error code
p19350
aVLook for trouble in your source code, trying to open files without using the full path name of the file
p19351
aVThe working directory will be different on your server
p19352
aVBest way to solve this is to use a debugger
p19353
as(dp19354
g9
V17034
p19355
stp19356
a((dp19357
g2
(lp19358
VGDI+ exception messages are pretty miserable, OutOfMemoryException can be raised in the Clone() method if the rectangle you pass is outside of the image bounds
p19359
aVNothing to do with running out of memory
p19360
aVWhich could easily happen here, it isn't that likely that the source bitmap is 1200 x 1800
p19361
aVMake your code look like this:
p19362
aVNot so sure the resulting bitmap would look good or is usable, GDI+ has poor support for indexed pixel formats
p19363
aVWin7 has a different version of gdiplus
p19364
aVdll than Windows 2003
p19365
aVI tested this code only on Win7
p19366
as(dp19367
g9
V17034
p19368
stp19369
a((dp19370
g2
(lp19371
VThis is not possible
p19372
aVThere's nothing "thin" about Visual Studio, it has an enormous mass of files in many different directories and a very large number of critical registry entries
p19373
aVIncluding many COM components
p19374
aVThat it works as well as it does is one of the modern day's Seven World Wonders of software engineering
p19375
aVYour license allows you to install VS on more than one machine as long as only one user uses it
p19376
aVI recommend you take advantage of it
p19377
as(dp19378
g9
V17034
p19379
stp19380
a((dp19381
g2
(lp19382
VYour code worked fine when I tried it, there's no obvious mistake that I can see
p19383
aVI called it like this, using a Validating event of a text box:
p19384
aVBeware that ToolTip can be cranky
p19385
aVThe native Windows component has a "feature" that prevents a tooltip from showing again when it timed out before
p19386
aVThe ErrorProvider component is a better mouse trap to get this done
p19387
as(dp19388
g9
V17034
p19389
stp19390
a((dp19391
g2
(lp19392
VNot a documented one
p19393
aVWhich is consistent with almost all
p19394
aVNET framework classes, there are no hard-coded limits
p19395
aVYou'll eventually run out of a system resource, usually memory or paging file
p19396
aVOr user patience
p19397
as(dp19398
g9
V17034
p19399
stp19400
a((dp19401
g2
(lp19402
VYou are not doing this right I think
p19403
aVUsing _set_se_translator() already requires you to compile with /EHa
p19404
aVFrom the MSDN Library page:
p19405
aVMore seriously, you'll break managed code when you use it
p19406
aVThe CLR relies on SEH exceptions to detect various mishaps
p19407
aVIt uses SetUnhandledExceptionFilter to trap them
p19408
aVParticularly NullReferenceException and OverflowException (x86) are raised this way
p19409
aVWhen you inject your own __try block, you'll prevent this exception from flowing into the CLR
p19410
aVAlthough you'll "handle" it, you won't have any trace of the exact reason for the exception
p19411
aVAnd managed try/catch blocks can't detect it
p19412
aVA cure for /EHa efficiency (if it is actually a problem) is 64-bit code
p19413
aVIts function table based stack unwinding is very efficient with zero overhead for a try block
p19414
as(dp19415
g9
V17034
p19416
stp19417
a((dp19418
g2
(lp19419
VOn Vista and Win7 Services run in their own session with a private desktop
p19420
aVYou'll get Firefox started but it will never be visible
p19421
aVThe account name is actually how this came about, LocalSystem is a highly privileged account, a giant security hole
p19422
aVYou will need an "agent" in the user session to get the process started
p19423
aVAn otherwise invisible program that you start with the Run key or the Startup folder that talks to the service through, say, a named pipe or socket
p19424
aVIt can start the program
p19425
as(dp19426
g9
V17034
p19427
stp19428
a((dp19429
g2
(lp19430
VIn
p19431
aVNET 1
p19432
aVx, a Thread was always matched with an operating system thread
p19433
aVAt the request of the SQL Server team, that association was broken for
p19434
aVNET 2
p19435
ag2512
aVA CLR host can now take control of thread mapping itself, the IHostTaskManager is the work-horse interface for that
p19436
aVThere's a good backgrounder in this blog post
p19437
aVSometimes code really does care that it runs on a particular operating system thread
p19438
aVWindows critical sections and mutants would be an example
p19439
aVReally, any kind of unmanaged code interop
p19440
aVThread
p19441
aVBeginThreadAffinity() invokes IHostTaskManager::BeginThreadAffinity() to let the host know that the task should not be allowed to run on another operating system thread but stick on the one it is currently on, until EndThreadAffinity() is called
p19442
aVBut, don't worry about any of this
p19443
aVThe SQL Server project was a bust, they couldn't get it reliable
p19444
aVThere have been no signs that they'll try again
p19445
as(dp19446
g9
V17034
p19447
stp19448
a((dp19449
g2
(lp19450
VOdd that VS generated the add/remove accessors
p19451
aVYou don't need them, the compiler automatically generates them
p19452
aVIt should look like this:
p19453
aVUsing the "handler" variable avoids a null exception if a thread wires the event
p19454
aVEdit: ah, it's because you implemented the event explicitly
p19455
aVNot necessary, the event should be public anyway
p19456
aVThat's what got you in trouble, the C# syntax diverges here from VB
p19457
aVNET
p19458
as(dp19459
g9
V17034
p19460
stp19461
a((dp19462
g2
(lp19463
VRecompressing a JPEG image is something you ought to avoid
p19464
aVBut the real problem here is the InterpolationMode, a high quality one produces a lot of subtly shaded pixels, making it harder to compress the image
p19465
aVUsing InterpolationMode
p19466
aVNearestNeighbor should avoid that, but at the cost of getting a lower quality image
p19467
as(dp19468
g9
V17034
p19469
stp19470
a((dp19471
g2
(lp19472
VThe BMP file format is a simple one, you'll have little trouble creating your own
p19473
aVBut you'll hit the wall on a compressed format like PNG, TIFF or JPEG
p19474
aVNobody writes an encoder for these, there are well established reference implementations for them
p19475
aVThey are written in C, the universal language for libraries like these
p19476
aVGoogle "libpng", "libtiff" and "libjpeg" to find them
p19477
aVYou'll need a C compiler to turn them in a DLL that you can P/Invoke
p19478
as(dp19479
g9
V17034
p19480
stp19481
a((dp19482
g2
(lp19483
VWhat you are trying to do is not possible, it is a miracle that you didn't get an exception
p19484
aVA window handle is valid between processes, as long as they run in the same session
p19485
aVBut Control
p19486
aVFromHandle() can only find controls that were created in the process from which it is called
p19487
aVIn your case it should return null
p19488
aVMaking the form in the other process visible is actually possible, you'll have to P/Invoke ShowWindow() using SW_SHOWNORMAL
p19489
aVVisit pinvoke
p19490
aVnet for the declaration
p19491
aVUse Handle
p19492
aVToInt64() so it will work properly on 64-bit operating systems
p19493
as(dp19494
g9
V17034
p19495
stp19496
a((dp19497
g2
(lp19498
VThere are two parts to attributes, their code and their constructor argument and property data
p19499
aVThe code is stored in the IL of the assembly, the data is stored in the assembly metadata
p19500
aVIf an attribute isn't used, that only takes up some virtual memory space but doesn't require any machine resources
p19501
aVNothing happens until you use the GetCustomAttributes() method
p19502
aVThen the code for the attribute class gets just-in-time compiled, just like the regular code in your assembly
p19503
aVAnd the constructor and the property setters are called, using the attribute data in the metadata
p19504
aVYou'll use up some RAM for both when the memory manager maps the IL, machine code and the metadata pages
p19505
as(dp19506
g9
V17034
p19507
stp19508
a((dp19509
g2
(lp19510
VYes, use a ColorMatrix
p19511
aVIt ought to look like this:
p19512
aVWhere R, G and B are the scaled color values of the replacement color (divide by 255
p19513
aV0f)
p19514
as(dp19515
g9
V17034
p19516
stp19517
a((dp19518
g2
(lp19519
VIt is the CRT that is killing your program
p19520
aVThe required behavior for an unhandled exception (std::bad_alloc here) is a call to terminate()
p19521
aVWhich displays the "Abnormal program termination" message in the MSVC implementation and calls abort() to kill the program
p19522
as(dp19523
g9
V17034
p19524
stp19525
a((dp19526
g2
(lp19527
VCalling PlaySync on the UI thread isn't so great
p19528
aVIt will make your main window unresponsive as your UI thread is busy waiting for the sound to finish, it doesn't get around to pumping messages like it should do
p19529
aVIf that takes long enough, Windows steps in and overlaps the window with a "ghost", it usually says "Not Responding" in the title bar (if it has one)
p19530
aVThis ghost window might not quite match your own window, that could explain the "shaking"
p19531
aVUsing Play() instead will solve that problem
p19532
aVBut gets you a new one, sequencing sounds becomes difficult
p19533
aVMaking the calls from a thread can solve both
p19534
aVCheck out NAudio for better control over sound
p19535
as(dp19536
g9
V17034
p19537
stp19538
a((dp19539
g2
(lp19540
VUsing number
p19541
aVToString("N0") is a slam-dunk
p19542
aVTrying to optimize it is pointless, whatever you are doing to display the string to the user is going to be a lot more expensive
p19543
as(dp19544
g9
V17034
p19545
stp19546
a((dp19547
g2
(lp19548
VYou are calling BeginInvoke() too often
p19549
aVThe UI thread will dispatch the delegate before it does its normal duties, like painting controls and responding to the mouse
p19550
aVIf the delegate target is doing a lot of work (appending text to an RTB is expensive) or you are simply flooding it with requests, it doesn't get around to doing its normal job anymore
p19551
aVThe UI will freeze
p19552
aVThat happens pretty easily, about a 1000 invokes per second is enough
p19553
aVThe key to solve this is to realize that it is wasted effort to invoke so often
p19554
aVThe human eye can't perceive updates faster than 25 times per second
p19555
aVSo buffer the text until 50 milliseconds have passed since the last update
p19556
aVEnvironment
p19557
aVTickCount is a cheap timer
p19558
aVAlso beware that you might actually produce text faster than can be appended to the RTB
p19559
aVThat requires throttling the thread
p19560
aVThat's easy: use Invoke instead of BeginInvoke
p19561
as(dp19562
g9
V17034
p19563
stp19564
a((dp19565
g2
(lp19566
VYes, the Windows memory manager was optimized to fulfill requests for memory as quickly and efficiently possible, it was not optimized to easily measure how much space is used
p19567
aVThe first downfall is that heap blocks that are released are rarely unmapped
p19568
aVThey are simply marked as "free", to be used by the next allocation
p19569
aVThat's why VirtualQueryEx() cannot work
p19570
aVThe problem with HeapWalk is that you have to lock the heap (HeapLock) so that it can walk it without the heap allocation changing
p19571
aVThat lock can have very detrimental side-effects
p19572
aVQuoting:
p19573
aVWalking a heap may degrade
p19574
aVperformance, especially on symmetric
p19575
aVmultiprocessing (SMP) computers
p19576
aVThe
p19577
aVside effects may last until the
p19578
aVprocess ends
p19579
aVEven then, the number you get back is pretty meaningless
p19580
aVA program never runs out of free space, it runs out of a large enough contiguous chunk of memory to fulfill the request
p19581
aVNo happy answers I'm afraid
p19582
aVExcept one: a 64-bit operating system cost less than two hundred bucks
p19583
as(dp19584
g9
V17034
p19585
stp19586
a((dp19587
g2
(lp19588
VYour code is hard to decipher
p19589
aVSimply drawing the metafile to a bitmap should get the job done
p19590
aVFor example:
p19591
as(dp19592
g9
V17034
p19593
stp19594
a((dp19595
g2
(lp19596
VMy local copy doesn't have it, looks like a mistake to me
p19597
aVChunked is covered in this article, "Transfer encoding header" section
p19598
aVIt should be transparent for reading
p19599
as(dp19600
g9
V17034
p19601
stp19602
a((dp19603
g2
(lp19604
VNeither approach makes sense
p19605
aVThe GC has no trouble with detecting circular references or complicated object graphs
p19606
aVNo point in setting references to null
p19607
aVIDisposable does nothing to improve GC perf
p19608
aVIf there's any lead in how you solved the problem, it is in setting events to null
p19609
aVThey have a knack for keeping objects referenced if they are implemented "backwards"
p19610
aVIn other words: keeping the originator of the event alive and tearing down its clients
p19611
aVUnsubscribing then has to be done explicitly
p19612
aVBut trying to guess at this was the wrong approach to start with
p19613
aVAny decent memory profiler would have shown you what reference was keeping a graph alive
p19614
as(dp19615
g9
V17034
p19616
stp19617
a((dp19618
g2
(lp19619
VI would encourage you to try this for yourself
p19620
aVFor example:
p19621
aVRun this at the command prompt so you can see the last gasp
p19622
aVFirst with the throw statement commented out
p19623
aVLike any unhandled exception in Windows, the default exception filter that Windows provides invokes the Windows Error Reporting dialog, displayed by WerFault
p19624
aVexe
p19625
aVIf you click "Close program", WerFault will use TerminateProcess() to kill the program
p19626
aVThat's a quick end, there is no opportunity to run the finalizer thread, as would happen when a program exits normally
p19627
aVWindows then takes care of cleanup up the shrapnel
p19628
aVIt automatically closes any operating system handles your program might have opened but didn't get a chance to close in the finalizer
p19629
aVFiles are the trickier problem here, their buffers don't get flushed and you'll easily end up with a partially written file on disk
p19630
as(dp19631
g9
V17034
p19632
stp19633
a((dp19634
g2
(lp19635
VYes, this is by design on 64-bit operating systems
p19636
aVA lot of COM components are in-process DLLs and are only available as 32-bit DLLs
p19637
aVA 64-bit program cannot load any 32-bit code
p19638
aVTo prevent them from malfunctioning, the registry is virtualized; different programs have different views of the registry
p19639
aV32-bit programs actually see the keys in HKLM\u005cSoftware\u005cWow6432\u005cClasses
p19640
aV64-bit programs see the regular keys
p19641
aVThis automatically avoids COM server mishaps
p19642
aVNET servers are unusual in that they can run both in 32-bit and in 64-bit mode, the JIT compiler takes care of that
p19643
aVWhat you should normally do is run both versions of Regasm
p19644
aVexe
p19645
aVThe one from the Framework folder will register the server for 32-bit programs, the one from the Framework64 folder registers it for 64-bit programs
p19646
as(dp19647
g9
V17034
p19648
stp19649
a((dp19650
g2
(lp19651
VThe first possibility is that send() failed and returned SOCKET_ERROR
p19652
aVYour code cannot detect this, you really ought to fix that
p19653
aVThe next possibility is that send() just doesn't block
p19654
aVWhich is pretty normal, it will only block when there's no buffer space left in the transport sub-system
p19655
aVYou'll have to pump several megabytes before that happens
p19656
as(dp19657
g9
V17034
p19658
stp19659
a((dp19660
g2
(lp19661
VThe work-horse class here is System
p19662
aVConfiguration
p19663
aVApplicationSettingsBase
p19664
aVNot available in the Compact Framework
p19665
aVWith the considerable amount of glue needed to support this class, adding it yourself isn't an option either
p19666
aVThe System
p19667
aVXml namespace contains what you need to serialize your own "settings" object
p19668
as(dp19669
g9
V17034
p19670
stp19671
a((dp19672
g2
(lp19673
VThe PInvoke Interop Assistant ought to be a better fit for you, it was specifically designed to work with C code
p19674
aVJust beware that no tool gives you a 100% guaranteed solution, C declarations are way too ambiguous to guarantee a completely trouble-free result
p19675
aVThe trouble is pointers, ubiquitous in C code
p19676
aVThere's no way to tell that a pointer is used to read or write memory
p19677
aVOr both
p19678
aVOr who is responsible for releasing the memory that is being pointed-to
p19679
as(dp19680
g9
V17034
p19681
stp19682
a((dp19683
g2
(lp19684
VYou can get a pretty accurate time stamp out of timeGetTime() when you reduce the time period
p19685
aVYou'll just need some work to get its return value converted to a clock time
p19686
aVThis sample C# code shows the approach:
p19687
aVOn second thought, this is just measurement
p19688
aVTo get an action performed periodically, you'll have to use timeSetEvent()
p19689
aVAs long as you use timeBeginPeriod(), you can get the callback period pretty close to 1 msec
p19690
aVOne nicety is that it will automatically compensate when the previous callback was late for any reason
p19691
as(dp19692
g9
V17034
p19693
stp19694
a((dp19695
g2
(lp19696
VThe
p19697
aVNET framework already has very good support for splash screens in Windows Forms apps
p19698
aVCheck this thread for a code sample
p19699
aVIt is indeed optimized for warm startup time, it makes sure the splash thread and screen is up and running before initializing the main app
p19700
as(dp19701
g9
V17034
p19702
stp19703
a((dp19704
g2
(lp19705
VUse this:
p19706
as(dp19707
g9
V17034
p19708
stp19709
a((dp19710
g2
(lp19711
VProgrammers that have worked with VB6 tend to put a lot of code in the Load event, in VB6 that event was used to initialize the form
p19712
aVBut that's not appropriate anymore in Windows Forms, the Form class can have a constructor
p19713
aVThe
p19714
aVNET way is to initialize class objects in the constructor, there are very few compelling reason to not do so for the Form class
p19715
aVThe Load event runs right after the window handle for the form was created, just before it becomes visible to the user
p19716
aVYou should only write code in the event handler that depends on having the handle created
p19717
aVThere is not a load of code that qualifies for this requirement except one kind: code that requires the window size and location to be known
p19718
aVThe design-time Size and Location property values of a Form are not the same as their actual values when the form runs on another machine
p19719
aVThe form can get rescaled to accommodate the system font size or the video adapter DPI setting on the target machine
p19720
aVThe user preferences play a role too, the user might have selected a different font size for the window caption
p19721
aVYou don't typically care about any of this, unless you want the window to have a particular position on the desktop or be aligned with some other window
p19722
aVWriting code in the Load event that does things like initialize TreeView or ListView controls can actually dramatically slow down the startup time
p19723
aVWhen you do it in the constructor, Windows Forms doesn't have to update the physical window yet, it hasn't been created yet
p19724
aVOnce the native control gets created, Winforms initializes it with a bulk update instead of one node/item at a time as will happen when the code runs in the Load event
p19725
aVBig difference
p19726
aVLast but not least: you should never use the Load event, you should override the OnLoad() method
p19727
aVThis ensures code runs in a predictable order when you (or somebody else) inherits from your Form class
p19728
aVIntelliSense helps you write this method, just type "protected onl" and press tab to have IntelliSense auto-complete the method
p19729
aVNote how you have a choice to put code before or after the base
p19730
aVOnLoad() call, that's how you control who is the boss
p19731
aVYou are the boss when you put it after, not often the correct choice btw
p19732
as(dp19733
g9
V17034
p19734
stp19735
a((dp19736
g2
(lp19737
VYou'll need to mentally put a space between 00 and fExtended, the actual phrase is "ScanCode:00" followed by "fExtended:0"
p19738
aVThat the scan code is 0 is unsurprising, you set it to 0 in your code:
p19739
aVThis shouldn't cause trouble, the scan code is only used when the virtual key is ambiguous
p19740
aVThe left and right Shift key for example
p19741
aVYou can use MapVirtualKey() if you prefer
p19742
as(dp19743
g9
V17034
p19744
stp19745
a((dp19746
g2
(lp19747
VYour code is crashing the BGW thread
p19748
aVBe sure to display the value of e
p19749
aVError in the RunWorkerCompleted event handler if it isn't null
p19750
aVFrom the MSDN Library article for Backgroundworker
p19751
aVReportProgress:
p19752
aVpercentProgress Type:
p19753
aVSystem
p19754
aVInt32
p19755
aVThe percentage, from 0 to 100, of the
p19756
aVbackground operation that is complete
p19757
aVFix:
p19758
as(dp19759
g9
V17034
p19760
stp19761
a((dp19762
g2
(lp19763
VIt is quite unlikely you'll be ahead by using a background timer
p19764
aVYour chart control almost certainly requires it to be updated from the same thread is was created on
p19765
aVAny kind of control that has a visible appearance does
p19766
aVWhich requires you to use Control
p19767
aVBeginInvoke in the Elapsed event handler so that the update code runs on the UI thread
p19768
aVDequeueing data isn't likely to be expensive, you will have actually have made it slower by invoking
p19769
aVAnd still not have taken the pressure off the UI thread
p19770
aVYou'll also have a potentially serious throttling problem, the timer will keep on ticking and pump data, even if the UI thread can't keep up
p19771
aVThat will eventually crash your program with OOM
p19772
aVConsider instead to make the code that updates the chart smarter
p19773
aVA chart can only display details of the data if such details are at least a pixel wide
p19774
aVRealistically, it can only display 2000 pixels with useful information
p19775
aVThat's not much, updating 2000 data points shouldn't cause any trouble
p19776
as(dp19777
g9
V17034
p19778
stp19779
a((dp19780
g2
(lp19781
VGetting the window with the focus is pretty easy with GetFocus()
p19782
aVAlthough I think GetGuiThreadInfo() uses internal data from the window manager
p19783
aVYour approach is liable to fail if IE is minimized or doesn't have the focus
p19784
aVUse EnumChildWindows() instead, iteratively for each child you find, until you get a window whose GetClassName() call returns "Internet Explorer_Server"
p19785
aVThanks for bringing this up btw
p19786
aVWhat IE is doing is expressly forbidden in the docs for SetParent()
p19787
aVI only knew of Acrobat violating this rule, but now you provided evidence of a Microsoft program doing this
p19788
aVThat settles it, it is no longer a rule
p19789
as(dp19790
g9
V17034
p19791
stp19792
a((dp19793
g2
(lp19794
VThis never makes any sense to me
p19795
aVWhere are you going to stop
p19796
aVAre you going to make sure as well that the user doesn't install it on Windows 98
p19797
aVThat the machine has enough RAM
p19798
aVThat the user account has enough privileges
p19799
aVSoftware vendors publish system requirements
p19800
aVYou always quote the lowest supported Windows version, minimum amount of RAM, required disk space, minimum browser version, etc
p19801
aVMinimum
p19802
aVNET framework version belongs in that list too
p19803
aVThe intention of this list is clear: don't expect it to work properly if you don't meet the requirements
p19804
aVIf you do it anyway, it is your problem, not mine
p19805
aVThis is different for a consumer-level app
p19806
aVBut when you install to Windows 2008 server, you are not writing a consumer app
p19807
as(dp19808
g9
V17034
p19809
stp19810
a((dp19811
g2
(lp19812
VThat's pretty easy to answer, free RAM is always sufficiently close to 0 to consider it zero and not bother
p19813
aVUnused RAM is always used by the file system cache, you can see this in the Taskmgr
p19814
aVexe, Performance tab
p19815
aVIf you actually mean "free virtual memory", the number you'd only really care about, then the answer is "not really possible"
p19816
aVYou'd need HeapWalk(), a very awkward and dangerous function to use
p19817
aVOnly HeapWalk can detect blocks in the heap that are marked free but are still mapped
p19818
aVThe number you'd arrive at is meaningless anyway
p19819
aVA program never runs out of free virtual memory blocks, it always runs out of large-enough memory blocks first
p19820
aVDetecting this condition is easy enough
p19821
aVMalloc returns NULL, the new operator throws std::bad_alloc
p19822
aVDealing with the condition is not easy
p19823
aVSolving it takes less than two hundred bucks, roughly the license fee for a 64-bit version of Windows
p19824
as(dp19825
g9
V17034
p19826
stp19827
a((dp19828
g2
(lp19829
VThis code links for me without trouble, using the 6
p19830
aV0a version of the SDK
p19831
aV"cmcfg" googles as Connection Manager Configuration, no idea what that is or why it would be needed here
p19832
aVJust delete the #pragma
p19833
as(dp19834
g9
V17034
p19835
stp19836
a((dp19837
g2
(lp19838
VThis squarely falls in the "premature optimization" category
p19839
aVIt is not at all guaranteed that you'll cause fragmentation, the disc may well have uncommitted clusters past the file end and often does
p19840
aVPerhaps more the point, there isn't anything in the
p19841
aVNET framework that allows you to detect or fix this
p19842
aVAccessing the volume's MFT requires unmanaged code and admin privileges
p19843
aVDefragging a disk is a normal machine maintenance task
p19844
aVIt became automatic with Win7
p19845
as(dp19846
g9
V17034
p19847
stp19848
a((dp19849
g2
(lp19850
VYes, the default handling of Application
p19851
aVThreadException was a mistake
p19852
aVUnfortunately, it was a necessary mistake, needed to not immediately discourage and despair hundreds of thousands of programmers writing their first Windows Forms application
p19853
aVThe fix you are contemplating is not a fix, it has a lot of potential to make it worse
p19854
aVWhile a user clicking the Continue button on the exception dialog is a questionable outcome, swallowing exceptions in a global exception handler is much worse
p19855
aVYes, do write a replacement handler for ThreadException
p19856
aVHave it display the value of e
p19857
aVException
p19858
aVToString() in a message box so the user has some idea what blew up
p19859
aVThen fire off an email or append to an error log so you know what went wrong
p19860
aVThen call Environment
p19861
aVFailFast() so no more damage can be done
p19862
aVDo the same for AppDomain
p19863
aVCurrentDomain
p19864
aVUnhandledException
p19865
aVIt won't get much of a workout
p19866
aVUse the feedback to improve your code
p19867
aVYou'll find out where validation is required
p19868
aVYou can help the customer's IT staff diagnose trouble with their LAN and equipment
p19869
aVAnd you'll find the very few cases where your own try/catch blocks might be able to recover from the exception
p19870
as(dp19871
g9
V17034
p19872
stp19873
a((dp19874
g2
(lp19875
VYour approach invokes the worst kind of DLL Hell
p19876
aVUpdating a "library" assembly can break all untested apps with no way to get them to repaired by letting them use the old version of the assembly
p19877
aVThat's why the CLR doesn't support this scenario
p19878
aVYou've listed all the usual workarounds
p19879
aVExcept one: give each app its own copy
p19880
as(dp19881
g9
V17034
p19882
stp19883
a((dp19884
g2
(lp19885
VDon't ever write code that checks for a null argument and then does nothing
p19886
aVHiding bugs in the client code is quite wrong, you want to be as helpful as possible when your API doesn't get used properly
p19887
aVArgumentNullException is very helpful
p19888
as(dp19889
g9
V17034
p19890
stp19891
a((dp19892
g2
(lp19893
VBinaryWriter is very efficient:
p19894
as(dp19895
g9
V17034
p19896
stp19897
a((dp19898
g2
(lp19899
VThe LoadXml() method expects a string that contains the xml, not a path to a file
p19900
aVUse the Load() method instead
p19901
aVNo, there's nothing out-of-date about the Microsoft
p19902
aVBuild namespace
p19903
aVAssuming you are using the 3
p19904
aV5 version
p19905
as(dp19906
g9
V17034
p19907
stp19908
a((dp19909
g2
(lp19910
VSet the new form's StartPosition to Manual and give it the same Size and Location:
p19911
as(dp19912
g9
V17034
p19913
stp19914
a((dp19915
g2
(lp19916
VNET supports lots of image file formats
p19917
aVYou can't reasonably screen the memory stream content for all possible formats
p19918
aVLooking for the cookie in the image header isn't enough, the image might still not load if there's something wrong with the image data or the image happens to be stored in a format that the
p19919
aVNET decoder doesn't support
p19920
aVPunt this: just load the image
p19921
aVIf there's something wrong with it, you'll get a loud complaint
p19922
aVCatch the exception
p19923
as(dp19924
g9
V17034
p19925
stp19926
a((dp19927
g2
(lp19928
VYes, that's possible
p19929
aVStart debugging with the exact same binaries as ran by your user, make sure the DLL is loaded and you've got a matching PDB file for it
p19930
aVLook in Debug + Windows + Modules for the DLL base address
p19931
aVAdd the offset
p19932
aVDebug + Windows + Disassembly and enter the calculated address in the Address field (prefix with 0x)
p19933
aVThat shows you the exact machine code instruction that caused the exception
p19934
aVRight-click + Go To Source code to see the matching source code line
p19935
aVWhile that shows you the statement, this isn't typically good enough to diagnose the cause
p19936
aVThe 0xc0000005 exception is an access violation, it has many possible causes
p19937
aVOften you don't even get any code, the program may have jumped into oblivion due to a corrupted stack
p19938
aVOr the real problem is located far away, some pointer manipulation that corrupted the heap
p19939
aVYou also typically really need a stack trace that shows you how the program ended up at the statement that bombed
p19940
aVWhat you need is a minidump
p19941
aVYou can easily get one from your user if she runs Vista or Win7
p19942
aVStart TaskMgr
p19943
aVexe, Processes tab, select the bombed program while it is still displaying the crash dialog
p19944
aVRight-click it and Create Dump File
p19945
aVTo make this smooth, you really want to automate this procedure
p19946
aVYou'll find hints in my answer in this thread
p19947
as(dp19948
g9
V17034
p19949
stp19950
a((dp19951
g2
(lp19952
VSmoke and mirrors is the best way to describe it
p19953
aVI'll try better
p19954
aVValue types don't support inheritance and cannot have virtual methods
p19955
aVBut yet, the int type has the ToString() and GetHashCode() methods, both virtual methods
p19956
aVIt inherits them from System
p19957
aVObject
p19958
aVThis magic comes about from a boxing conversion
p19959
aVThere are dedicated IL opcodes that perform it, OpCodes
p19960
aVBox and OpCodes
p19961
aVConstrained
p19962
aVThat turns a value type into an object, one that stores the value of the original value type
p19963
aVIt goes the other way around too, unboxing converts an object back to a value type
p19964
aVIf you have a good
p19965
aVNET compiler, like the C# one, you never explicitly invoke the conversion yourself
p19966
aVThe compiler can figure out from the language syntax when such a conversion is required and emits the required IL code
p19967
aVThe System
p19968
aVInt32 type is a helper type that the compiler has special knowledge of
p19969
aVIt is useful for its methods only, you never explicitly create an instance of it
p19970
aVThe compiler calls those methods directly when it knows that you are calling a method of the int "class"
p19971
aVAll of this works together to create the illusion that int derives from System
p19972
aVObject (through System
p19973
aVValueType)
p19974
aVUsing the principle of "if it looks, swims and quacks like a duck, it's a duck"
p19975
as(dp19976
g9
V17034
p19977
stp19978
a((dp19979
g2
(lp19980
VThere is no such thing as "lock-free threading" these days
p19981
aVIt was an interesting playground for academia and the like, back in the end of the last century when computer hardware was slow and expensive
p19982
aVDekker's algorithm was always my favorite, modern hardware has put it out to pasture
p19983
aVIt doesn't work anymore
p19984
aVTwo developments have ended this: the growing disparity between the speed of RAM and the CPU
p19985
aVAnd the ability of chip manufacturers to put more than one CPU core on a chip
p19986
aVThe RAM speed problem required the chip designers to put a buffer on the CPU chip
p19987
aVThe buffer stores code and data, quickly accessible by the CPU core
p19988
aVAnd can be read and written from/to RAM at a much slower rate
p19989
aVThis buffer is called the CPU cache, most CPUs have at least two of them
p19990
aVThe 1st level cache is small and fast, the 2nd is big and slower
p19991
aVAs long as the CPU can read data and instructions from the 1st level cache it will run fast
p19992
aVA cache miss is really expensive, it puts the CPU to sleep for as many as 10 cycles if the data is not in the 1st cache, as many as 200 cycles if it isn't in the 2nd cache and it needs to be read from RAM
p19993
aVEvery CPU core has its own cache, they store their own "view" of RAM
p19994
aVWhen the CPU writes data the write is made to cache which is then, slowly, flushed to RAM
p19995
aVInevitable, each core will now have a different view of the RAM contents
p19996
aVIn other words, one CPU doesn't know what another CPU has written until that RAM write cycle completed and the CPU refreshes its own view
p19997
aVThat is dramatically incompatible with threading
p19998
aVYou always really care what the state of another thread is when you must read data that was written by another thread
p19999
aVTo ensure this, you need to explicitly program a so-called memory barrier
p20000
aVIt is a low-level CPU primitive that ensures that all CPU caches are in a consistent state and have an up to date view of RAM
p20001
aVAll pending writes have to flushed to RAM, the caches then need to be refreshed
p20002
aVThis is available in
p20003
aVNET, the Thread
p20004
aVMemoryBarrier() method implements one
p20005
aVGiven that this is 90% of the job that the lock statement does (and 95+% of the execution time), you are simply not ahead by avoiding the tools that
p20006
aVNET gives you and trying to implement your own
p20007
as(dp20008
g9
V17034
p20009
stp20010
a((dp20011
g2
(lp20012
VThere are different kinds of DLLs, you'll need to treat them differently when you use them in a C# project
p20013
aVThe 3 main kinds are:
p20014
aVDLLs that contain unmanaged code and were designed to be used by a program written in unmanaged code
p20015
aVYou cannot use such a DLL directly, there is no way to add a reference to them in a C# project
p20016
aVYou must use P/Invoke, the [DllImport] attribute is required to declare the exported functions in the DLL
p20017
aVGlut32
p20018
aVdll is such a DLL
p20019
aVA very basic test you can use to see if you've got such a DLL is to run Dumpbin
p20020
aVexe /exports on that DLL
p20021
aVIt lists the names of the functions that are exported
p20022
aVDLLs that implement an in-process COM server
p20023
aVThey are written in unmanaged code as well
p20024
aVNET has very good support for using such servers, as long as you have a type library for them
p20025
aVThe type library is usually embedded in the DLL, Visual Studio expects to find it when you add a project reference, either through the COM tab or the Browse tab
p20026
aVA very basic test is Dumpbin
p20027
aVexe /exports again, an in-process COM server has 4 exported functions
p20028
aVThe DllGetClassObject function is the important one
p20029
aVYou can view the type library embedded in the DLL with OleView
p20030
aVexe, File + View Typelibrary
p20031
aVA good example is c:\u005cwindows\u005csystem32\u005cshell32
p20032
aVdll
p20033
aVDLLs that were created by a managed compiler
p20034
aVThey don't contain machine code like the other types, they contain IL code and metadata
p20035
aVIt is the native kind of DLL for managed code, you simply use Project + Add Reference to add a reference, the compiler automatically knows the types that are available in the DLL
p20036
aVThe first kind is the one you'll encounter a lot for DLLs in the wild
p20037
aVThere's a lot of code written for Windows in an unmanaged language
p20038
aVIt isn't a kind of DLL that's particularly easy to use from managed code
p20039
aVGlut32
p20040
aVdll for example has a lot of exported functions, writing a P/Invoke declaration for every single one of them is painful
p20041
aVTools you can use to help with this are SWIG and PInvoke Interop Assistant
p20042
aVThe former is required when the DLL was written in the C++ language
p20043
aVC++ classes are not directly usable from a C# program, they need a wrapper written in the C++/CLI language
p20044
aVThe latter tool is useful for DLLs written in C, including the Windows API
p20045
aVBeware that those tools don't usually give you a clean and guaranteed-to-work interop solution
p20046
aVDeclarations in unmanaged code are ambiguous, you'll need to know the exact semantics of the arguments of an unmanaged function to pick the right one
p20047
aVGetting the wrong one can be hard to diagnose, the best place to get help is a forum or Q+A site
p20048
aVLike stackoverflow
p20049
aVcom
p20050
as(dp20051
g9
V17034
p20052
stp20053
a((dp20054
g2
(lp20055
VWriting your own destructor (aka finalizer) is wrong in 99
p20056
aV99% of all cases
p20057
aVThey are needed to ensure that your class releases an operating system resource that isn't automatically managed by the
p20058
aVNET framework and wasn't properly released by the user of your class
p20059
aVThis starts by having to allocate the operating system resource first in your own code
p20060
aVThat always requires some kind of P/Invoke
p20061
aVThis is very rarely needed, it was the job of the
p20062
aVNET programmers working at Microsoft to take care of that
p20063
aVThey did in the case of StreamWriter
p20064
aVThrough several layers, it is a wrapper around a file handle, created with CreateFile()
p20065
aVThe class that created the handle is also the one that's responsible for writing the finalizer
p20066
aVMicrosoft code, not yours
p20067
aVSuch a class always implements IDisposable, giving the user of the class an opportunity to release the resource when it is done with it, rather than waiting for the finalizer to get the job done
p20068
aVStreamWriter implements IDisposable
p20069
aVOf course, your StreamWriter object is a private implementation detail of your class
p20070
aVYou don't know when the user is done with your Logger class, you cannot call StreamWriter
p20071
aVDispose() automatically
p20072
aVYou need help
p20073
aVGet that help by implementing IDisposable yourself
p20074
aVThe user of your class can now call Dispose or use the using statement, just like she would with any of the framework classes:
p20075
aVWell, that's what you should do in 99
p20076
aV9% of all cases
p20077
aVBut not here
p20078
aVAt the risk of fatally confusing you: if you implement IDisposable, there must also be a reasonable opportunity for the user of your class to call its Dispose() method
p20079
aVThat is normally not much of a problem, except for a Logger type class
p20080
aVIt is pretty likely that your user wants to log something up to the last possible moment
p20081
aVSo that she can log an unhandled exception from AppDomain
p20082
aVUnhandledException for example
p20083
aVWhen to call Dispose() in this case
p20084
aVYou could do it when your program terminates
p20085
aVBut that's kinda besides the point, there isn't much point in releasing resources early if it happens when the program is exiting
p20086
aVA logger has the special requirement to shut down properly in all cases
p20087
aVThat requires that you set the StreamWriter
p20088
aVAutoFlush property to true so that logging output is flushed as soon as it is written
p20089
aVGiven the difficulty of calling Dispose() properly, it is now actually better that you don't implement IDisposable and let Microsoft's finalizer close the file handle
p20090
aVFwiw, there's another class in the framework that has the same problem
p20091
aVThe Thread class uses four operating system handles but doesn't implement IDisposable
p20092
aVCalling Thread
p20093
aVDispose() is really awkward, so Microsoft didn't implement it
p20094
aVThis causes problems in very unusual cases, you'd need to write a program that creates a lot of threads but never uses the new operator to create class objects
p20095
aVIt's been done
p20096
aVLast but not least: writing a logger is fairly tricky as explained above
p20097
aVLog4net is a popular solution
p20098
aVNLog is a better mousetrap, a library that feels and works dotnetty instead of feeling like a Java port
p20099
as(dp20100
g9
V17034
p20101
stp20102
a((dp20103
g2
(lp20104
VYes, that what you should do
p20105
aVThere are many controls that don't have a meaningful way to take the focus
p20106
aVPictureBox, Panel are good examples
p20107
aVAnything that derives from ContainerControl
p20108
aVControl
p20109
aVOnMouseDown() therefore doesn't automatically call Focus() in OnMouseDown()
p20110
aVJust overriding the OnMouseDown method isn't enough, you should also make it clear to the user that your control has the focus
p20111
aVSo she'll have an idea where the keyboard strokes go
p20112
aVThat requires overriding OnPaint() so you can draw a focus rectangle
p20113
aVControlPaint
p20114
aVDrawFocusRectangle() is a boilerplate implementation for that
p20115
aVBut taking the focus is really only useful if you do something meaningful with keyboard messages
p20116
aVSo you'll have to override OnKeyDown and/or OnKeyPressed as well
p20117
aVAnd show feedback to the user so she can see what she typed
p20118
aVIf you don't have a useful implementation for that, you shouldn't take the focus
p20119
aVWhich is why PictureBox doesn't
p20120
as(dp20121
g9
V17034
p20122
stp20123
a((dp20124
g2
(lp20125
VI can't follow your code, "imagePanel" seems to fall from the sky without any notion how it got created
p20126
aVWhat you are doing is however quite illegal, Windows requires the Parent of a control (set by your Controls
p20127
aVAdd() call) to be a window that was created in the same thread as the child
p20128
aVNET 2
p20129
aV0 normally checks for this and generates an IllegalOperationException when you violate that rule, hard to guess why they would leave that out of CF
p20130
aVIf they in fact did
p20131
aVObjectDisposedException is common with BackgroundWorker when its RunWorkerCompleted or ProgressChanged event runs and the form was closed
p20132
aVYou always have to make sure to cancel the BGW before you allow the form to disappear
p20133
aVThat's kinda irrelevant here, you have to completely redesign this anyway
p20134
as(dp20135
g9
V17034
p20136
stp20137
a((dp20138
g2
(lp20139
VThis is something you normally shouldn't fix
p20140
aVThe user clicked somewhere intentionally, that might well be because she wanted to deselect an item
p20141
aVIf it was unintentional then she'll understand what happened and know how to correct it
p20142
aVGiving standard controls non-standard behavior tends to only confuse the user
p20143
aVBut you can fix it
p20144
aVYou'll need to prevent the native ListView control from seeing the click
p20145
aVThat requires overriding the WndProc() method and checking where the click occurred
p20146
aVAdd a new class to your project and paste the code shown below
p20147
aVCompile
p20148
aVDrop the new control from the top of the toolbox onto the form
p20149
as(dp20150
g9
V17034
p20151
stp20152
a((dp20153
g2
(lp20154
VThis is possible, the native tab control implemented by Windows sends the TCM_ADJUSTRECT message to allow the client to override the size of the tabs
p20155
aVAdd a new class to your project and paste the code shown below
p20156
aVCompile
p20157
aVDrop the new control from the top of the toolbox onto your form
p20158
aVAt design time it still has the tabs so you can easily switch between the pages
p20159
aVBut they'll be gone at runtime
p20160
as(dp20161
g9
V17034
p20162
stp20163
a((dp20164
g2
(lp20165
VThis goes back a long time, back when terminals were still used
p20166
aVYou'll also have to allow the backspace character
p20167
aVPut this in the front of your code:
p20168
aVThe Delete key doesn't need any help, that already works
p20169
as(dp20170
g9
V17034
p20171
stp20172
a((dp20173
g2
(lp20174
VWell, Israel is significant
p20175
aVI read somewhere that DST start and end dates were decided each year, often after a long and acrimonious debate in the Knesset
p20176
aVRequiring Microsoft to issue an update for Windows so that the registry could be updated
p20177
aVWas that done on this machine
p20178
aVThe relevant registry key is HKEY_LOCAL_MACHINE\u005cSOFTWARE\u005cMicrosoft\u005cWindows NT\u005cCurrentVersion\u005cTime Zones\u005cIsrael Standard Time\u005cDynamic DST
p20179
aVI've got a huge list of dates in there
p20180
aVThis is a Vista + Win7 feature, not sure what happens on XP
p20181
aVThe update probably needs to take care of it
p20182
aVAsk more questions about it at superuser
p20183
aVcom
p20184
as(dp20185
g9
V17034
p20186
stp20187
a((dp20188
g2
(lp20189
VHmya, what you're trying to do is pretty fundamentally incompatible with the Windows programming model
p20190
aVA native Windows program is event driven
p20191
aVYour program is always idle, sitting inside a loop started by Application
p20192
aVRun(), waiting for Windows to tell it that something interesting happened that it should respond to
p20193
aVPaint requests, mouse clicks, timer expirations, stuff like that
p20194
aVYour program should respond to this and filter what is interesting to you
p20195
aVWhen you drop a button on a form, you are always interested in the Click event, generated when Windows sends the MouseDown notification message
p20196
aVYour Click event handler runs some kind of custom code that you write
p20197
aVLike updating a status bar message in your case
p20198
aVUpdating the status bar message half a second later doesn't make a whole heckofalot of sense
p20199
aVWhat exactly happened during those 500 milliseconds that changed the way your program responds to events
p20200
aVYou can call the Update() method of the StatusBar so the new message is visible, then call System
p20201
aVThreading
p20202
aVThread
p20203
aVSleep(500) to get what you want
p20204
aVYou'll get away with it, the "Not Responding" ghost that Windows puts up takes your program going dead for several seconds
p20205
aVBut that doesn't make a lot of sense, nothing happened during that half second, the state of your program didn't change
p20206
aVIt couldn't change, it was dead to Windows and not receiving any messages that would allow it to change state
p20207
aVWell, that's about as far as I can take this
p20208
aVPlease update your question and explain why you need to do this
p20209
aVJust in case: if you're contemplating this to fake doing something important for half a second, your user will not be impressed
p20210
aVShe'll eventually notice your UI is dead for half a second without anything to show for it
p20211
as(dp20212
g9
V17034
p20213
stp20214
a((dp20215
g2
(lp20216
VWMI is the easier way to do this in C#
p20217
aVThe Win32_Process class has the ParentProcessId property
p20218
aVHere's an example:
p20219
aVOutput when run from Visual Studio:
p20220
aVI was started by devenv
p20221
as(dp20222
g9
V17034
p20223
stp20224
a((dp20225
g2
(lp20226
VYou are starting a program that was installed with ClickOnce
p20227
aVThe
p20228
aVappref-ms is executed by a helper program, rundll32
p20229
aVexe, that starts the process and quickly exits
p20230
aVTo terminate the started process, you'll need to find the actual running
p20231
aVexe with Process
p20232
aVGetProcessesByName() and use the Kill method
p20233
aVWe can't tell you what the process name is, that's contained in the
p20234
aVappref-ms file
p20235
aVBut it is easy for you to see with TaskMgr
p20236
aVexe
p20237
as(dp20238
g9
V17034
p20239
stp20240
a((dp20241
g2
(lp20242
VMy VS2008 x64 compiler doesn't do the same thing yours does
p20243
aVThe struct fits in an XMM register, it passes a pointer to the copy of the pair object in a register:
p20244
aVNothing is passed on the stack here
p20245
as(dp20246
g9
V17034
p20247
stp20248
a((dp20249
g2
(lp20250
VThe background is no longer correct when you move it
p20251
aVThe control doesn't know it, you'll have to tell it by calling its Invalidate() method
p20252
aVIt dipping underneath controls is a Z-order problem
p20253
aVThat can be difficult to fix if the form contains any nested container controls like Panels, UserControls or GroupBoxes
p20254
aVYou can't get it displayed on top of those
p20255
aVBut as long as everything has the form as its Parent then calling BringToFront() on the control will make sure that it is always on top
p20256
aVA more generic solution is a form that overlays the original and has its TransparencyKey property set to its BackColor so that it is completely transparent
p20257
aVAny control you put on that form will always be on top
p20258
aVMy code in this thread demonstrates the overlay idea
p20259
aVIf you are creating your own designer, you'll want to read this article
p20260
as(dp20261
g9
V17034
p20262
stp20263
a((dp20264
g2
(lp20265
VThis is backwards
p20266
aVThe only possible way you can get the attribute value is through PropertyInfo
p20267
aVGetCustomAttributes()
p20268
aVThat requires knowing the property name first so you can get the PropertyInfo object from Type
p20269
aVGetProperty()
p20270
as(dp20271
g9
V17034
p20272
stp20273
a((dp20274
g2
(lp20275
VThe comment is simply wrong
p20276
aVYes, it is a red-black tree, O(log(n)) for inserts
p20277
aVTaking a look with Reflector bears this out, the private AddIfNotPresent() method contains a while() loop to find the insertion point, using normal red-black node traversal
p20278
aVThis doc bug has already been submitted by you-know-who
p20279
as(dp20280
g9
V17034
p20281
stp20282
a((dp20283
g2
(lp20284
VIt is normal for a profiler to show that most execution takes place in those Windows API calls
p20285
aVCallWindowProc() runs the default message handler for a control, you are measuring how long it takes for the native edit box control built into Windows to handle your text file
p20286
aVWaitMessage() spins, waiting for a message from Windows that something interesting happened
p20287
aVThis makes profiling GUI code difficult, you have to lift the code you wrote into a unit test style program
p20288
aVNot practical here, you didn't write any of the code that is taking all the CPU cycles
p20289
aVYour problem is that TextBox isn't a very good text editor
p20290
aVIt doesn't have any of the optimizations that you'd find in a full-blown editor
p20291
aVBe sure to turn the WordWrap property off, that's especially expensive
p20292
aVAnd be sure not to fill the TextBox line-by-line from a file, that's very slow as the native control constantly has to re-allocate its buffer
p20293
aVUse File
p20294
aVReadAllText() or use a StringBuilder, then assign Text
p20295
aVSomething like the open source ScintillaNET does a much better job
p20296
as(dp20297
g9
V17034
p20298
stp20299
a((dp20300
g2
(lp20301
VYou ought to consider the Color structure
p20302
aVIt has R, G and B properties and FromArgb() and ToArgb() methods
p20303
as(dp20304
g9
V17034
p20305
stp20306
a((dp20307
g2
(lp20308
VI rolled a die and came up with this answer:
p20309
aVOr you could use Random
p20310
aVNext()
p20311
as(dp20312
g9
V17034
p20313
stp20314
a((dp20315
g2
(lp20316
VIf this code is part of your project then the control should automatically appear in the toolbox after you compiled the code
p20317
aVBut it is an option that might have been turned off
p20318
aVTools + Options, Windows Forms Designer, General, Toolbox, AutoToolboxPopulate must be True
p20319
aVIf it is a separate assembly then Drag+Drop won't work
p20320
aVRight click the toolbox, Choose Items, use the Browse tab
p20321
as(dp20322
g9
V17034
p20323
stp20324
a((dp20325
g2
(lp20326
VThe e
p20327
aVKeyData argument includes the modifier keys
p20328
aVMake it look like this:
p20329
as(dp20330
g9
V17034
p20331
stp20332
a((dp20333
g2
(lp20334
VNot sure why this is a problem
p20335
aVWhy don't you create the setup package before obfuscating the assemblies
p20336
as(dp20337
g9
V17034
p20338
stp20339
a((dp20340
g2
(lp20341
VThe SHFileOperation() API function is the workhorse function for copying files
p20342
aVIt supports recursing directories
p20343
aVReview the options available in the SHFILEOPSTRUCT structure to control the copy
p20344
as(dp20345
g9
V17034
p20346
stp20347
a((dp20348
g2
(lp20349
VIt is actually the job of the JIT compiler to assign the memory layout of classes and structures
p20350
aVThe actual layout is not discoverable in any way (beyond looking at the generated machine code), a [StructLayout] attribute is required to marshal the object to a known layout
p20351
aVThe JIT takes advantage of this by re-ordering fields to keep them aligned and minimize the allocation size
p20352
aVThere will be no surprises in the struct you quoted, the fields are already aligned on any current CPU architecture that can execute managed code
p20353
aVThe size of value types is guaranteed by the CLI, a short always takes 16 bits
p20354
aVYour structure will take 32 bits
p20355
as(dp20356
g9
V17034
p20357
stp20358
a((dp20359
g2
(lp20360
VIt is an abstract class, you don't use it directly
p20361
aVConcrete derived classes are ManualResetEvent, AutoResetEvent, Mutex and Semaphore
p20362
aVImportant classes in your toolbox to implement thread synchronization
p20363
aVThey inherit the WaitOne, WaitAll and WaitAny methods, you use them to detect that one or more threads signaled the wait condition
p20364
aVTypical usage scenario for Manual/AutoResetEvent is to tell a thread to exit or to let a thread signal that it has progressed to an important sequence point
p20365
aVSemaphore helps you to limit the number of threads that perform an action
p20366
aVOr to implement threading synchronization that should not have affinity to a particular thread
p20367
aVMutex is there to assign ownership to a section of code to one thread, the lock statement is often applicable there as well
p20368
aVBooks have been written about it
p20369
aVJoe Duffy's Concurrent Programming in Windows is the latest and greatest
p20370
aVStrongly recommended if you contemplate writing threaded code
p20371
as(dp20372
g9
V17034
p20373
stp20374
a((dp20375
g2
(lp20376
VThat's what happens when you lie to printf(), it gets it wrong
p20377
aVWhen you use the %x format specifier, it expects an integer to be passed on the stack, not a float passed on the FPU stack
p20378
aVFix:
p20379
aVYou can get infinity out of the  C++ header file:
p20380
as(dp20381
g9
V17034
p20382
stp20383
a((dp20384
g2
(lp20385
VYour interface is exported to the type library like this:
p20386
aVThe trouble is the Value property setter, it is declared as propputref instead of propput
p20387
aVThat there's a difference at all is a nasty consistency issue in COM, brought about by it supporting a default property
p20388
aVThat's why you have to use the Set keyword in VBA
p20389
aVProblem is: you're not passing an object in the VBA code, even though
p20390
aVNET expects one
p20391
aVAfter researching this a bit, I found no ready solution for this problem
p20392
aVThere's a small chance that the Let keyword might work in VBA, I didn't try it
p20393
aVThe only halfway decent fix is to force late binding, instead of ComInterfaceType
p20394
aVInterfaceIsDual use ComInterfaceType
p20395
aVInterfaceIsIDispatch
p20396
aVOr avoid using "object"
p20397
as(dp20398
g9
V17034
p20399
stp20400
a((dp20401
g2
(lp20402
VOn 64-bit operating systems, the ProgramW6432 environment variable points to c:\u005cprogram files
p20403
aVThe full list for a 32-bit app on an English version of Windows:
p20404
aVProgramFiles => c:\u005cprogram files (x86)
p20405
aVProgramFiles(x86) => c:\u005cprogram files (x86)
p20406
aVProgramW6432 => c:\u005cprogram files
p20407
aVCommonProgramFiles => c:\u005cprogram files (x86)\u005ccommon files
p20408
aVCommonProgramFiles(x86) => c:\u005cprogram files (x86)\u005ccommon files
p20409
aVCommonProgramW6432 => c:\u005cprogram files\u005ccommon files
p20410
aVJust a reminder: that folder should not contain anything of interest to a 32-bit program
p20411
aVTechnically
p20412
as(dp20413
g9
V17034
p20414
stp20415
a((dp20416
g2
(lp20417
VThe Opacity property is what you need to "dim" a form
p20418
aVYou'll need to create an overlay, my code in this thread shows how to do this
p20419
aVBe careful to not make it look like your program is displaying a UAC prompt
p20420
aVWhile perhaps appropriate in browsers, the user will never have any trouble recognizing that a window overlaid by a dialog is disabled
p20421
aVControls paint themselves differently to make it clear
p20422
as(dp20423
g9
V17034
p20424
stp20425
a((dp20426
g2
(lp20427
VYou should use a Timer
p20428
aVEnable it when you detect the item getting dragged near the top or bottom of the client area
p20429
aVSimply avoiding scrolling when the timer is busy
p20430
aVThe Interval property of the timer determines how fast the scrolling takes place
p20431
aVA bonus effect is that the user can speed up the scrolling by waving the dragged item up-and-down
p20432
aVI wrote some sample VB
p20433
aVNET code that uses this approach, you'll find it in this thread
p20434
as(dp20435
g9
V17034
p20436
stp20437
a((dp20438
g2
(lp20439
VThose are functions that were designed to work with MDI child windows
p20440
aVAn MDI child window must have a caption
p20441
aVIf they work with non-MDI child windows too (haven't tried) then surely Windows avoids moving a window that cannot easily be moved back by the user
p20442
as(dp20443
g9
V17034
p20444
stp20445
a((dp20446
g2
(lp20447
VEasy peasy
p20448
aVImplement the Scroll event for the 1st panel and have it Invalidate() the 2nd
p20449
aVDraw the text in the 2nd panel's Paint event, using the scroll position of the 1st:
p20450
as(dp20451
g9
V17034
p20452
stp20453
a((dp20454
g2
(lp20455
VYes, the LoadCompleted event tells you what went wrong:
p20456
aVThere could also be a case where the image load completed properly but there was something wrong with the image file itself:
p20457
aVThis event handler catches load errors too so might be the one you want to use
p20458
as(dp20459
g9
V17034
p20460
stp20461
a((dp20462
g2
(lp20463
VReflector is not perfect
p20464
aVThe actual code of this method is available from the Reference Source
p20465
aVIt is located in ndp\u005cfx\u005csrc\u005cxsp\u005csystem\u005cweb\u005csecurity\u005cadmembershipprovider
p20466
aVcs:
p20467
aVNote how it failed to detect the last else clause and compensated for it with a goto
p20468
aVIt is almost certainly tripped-up by the try/catch blocks inside the if() statements
p20469
aVClearly you'll want to favor the actual source code instead of the decompiled version
p20470
aVThe comments in themselves are quite helpful and you can count on the source being accurate
p20471
aVWell, mostly accurate, there's some minor damage from a buggy post-processing tool that removed the names of the Microsoft programmers
p20472
aVIdentifiers are sometimes replaced by dashes and the code is repeated twice
p20473
aVYou can download the source here
p20474
as(dp20475
g9
V17034
p20476
stp20477
a((dp20478
g2
(lp20479
VBackgroundWorker derives from Component
p20480
aVComponent implements the IDisposable interface
p20481
aVThat in turn makes BackgroundWorker inherit the Dispose() method
p20482
aVDeriving from Component is a convenience for Windows Forms programmers, they can drop a BGW from the toolbox onto a form
p20483
aVComponents in general are somewhat likely to have something to dispose
p20484
aVThe Windows Forms designer takes care of this automatically, look in the Designer
p20485
aVcs file for a Form for the "components" field
p20486
aVIts auto-generated Dispose() method calls the Dispose() method for all components
p20487
aVHowever, BackgroundWorker doesn't actually have any member that requires disposing
p20488
aVIt doesn't override Dispose()
p20489
aVIts base implementation, Component
p20490
aVDispose(), only makes sure that the component is removed from the "components" collection
p20491
aVAnd raise the Disposed event
p20492
aVBut doesn't otherwise dispose anything
p20493
aVLong story short: if you dropped a BGW on a form then everything is taken care of automatically, you don't have to help
p20494
aVIf you didn't drop it on a form then it isn't an element in a components collection and nothing needs to be done
p20495
aVYou don't have to call Dispose()
p20496
as(dp20497
g9
V17034
p20498
stp20499
a((dp20500
g2
(lp20501
VReplacing the message loop in the Application class is not practical
p20502
aVThere is far more going on then the boilerplate Windows message loop
p20503
aVIt isn't the real problem anyway, the Application class forces the form to become visible with a call to ShowWindow()
p20504
aVThat's necessary because forms are lazily initialized, without the ShowWindow() call it never creates the native Window handle
p20505
aVThis issue is easy to fix in the regular
p20506
aVNET framework version by overriding SetVisibleCore():
p20507
aVBut I don't think that's available in CF
p20508
aVTo find a solution, you'll need to explain exactly why you want to prevent the UI from being shown
p20509
aVWithout any created window handle, an app is usually dead as a doornail
p20510
aVIt could be as simple as delaying the Application
p20511
aVRun() call
p20512
as(dp20513
g9
V17034
p20514
stp20515
a((dp20516
g2
(lp20517
VIf you don't use the /type argument for sgen
p20518
aVexe then it will generate de/serialization code for all public types in the assembly
p20519
aVNote that the [Serializable] attribute is not used in XML serialization
p20520
aVI doubt you'd want this, use /type to keep the generated assembly small
p20521
aVAdding a reference is not necessary, Xml serialization always tries an Assembly
p20522
aVLoad() on the
p20523
aVXmlSerializers
p20524
aVdll assembly anyway
p20525
aVPlus, you'll never reference the generated XmlSerializationWriterXxx and XmlSerializationReaderXxx classes directly in your code
p20526
aVIt does have one advantage, the build system will automatically copy the assembly when you include the project in a solution
p20527
aVInstalling it in the GAC is only worth considering when different apps serialize and deserialize the XML file
p20528
aVYou can provide other apps with the
p20529
aVXmlSerializers
p20530
aVdll assembly by copying the assembly by hand as well
p20531
aVWhich is a bit error prone, use your own judgment here
p20532
aVCheck the previous paragraph for a way to automate the copy
p20533
as(dp20534
g9
V17034
p20535
stp20536
a((dp20537
g2
(lp20538
VJust set the environment variable in your Main or OnStart method:
p20539
aVUsing SetEnvironmentVariable() changes the environment only for the running instance of the process, it doesn't change the user's system environment
p20540
as(dp20541
g9
V17034
p20542
stp20543
a((dp20544
g2
(lp20545
VUgh, annoying isn't it
p20546
aVYou can see it being doing by running sgen
p20547
aVexe on your assembly with the /keep and /debug options so you can debug the deserialization code
p20548
aVIt looks roughly like this:
p20549
aVNo less than 3 places where it makes sure the @To property isn't null
p20550
aVThe first one is somewhat defensible, hard to deserialize data when the structure doesn't exist
p20551
aVThe second one does the null test again, that's the only real good one
p20552
aVThe third one is the problem, ReadNull() returned true but it still creates a non-null property value
p20553
aVIf you want to differentiate between empty and null then you have no good solution but edit this code by hand
p20554
aVDo this only if you are really desperate and the class is 100% stable
p20555
aVWell, don't do it
p20556
aVJoo's solution is the only good one
p20557
as(dp20558
g9
V17034
p20559
stp20560
a((dp20561
g2
(lp20562
VIt generates the Keys
p20563
aVApps keystroke
p20564
aVPaste this code into your form:
p20565
as(dp20566
g9
V17034
p20567
stp20568
a((dp20569
g2
(lp20570
VThe kind of peer-to-peer networking problems become simple to the point of being trivial if you designate one machine as the master server
p20571
aVIt should have a well-known name that all sub-servers can connect to so they can publish (and withdraw) their availability
p20572
aVA client can then send a query request to the same server and get a list of known servers in return
p20573
aVThis can also solve your firewall problem, the master server could be listening on port 80
p20574
aVLook into the System
p20575
aVNet
p20576
aVPeerToPeer namespace for a p2p solution supported by the framework
p20577
as(dp20578
g9
V17034
p20579
stp20580
a((dp20581
g2
(lp20582
VThis code sorta works:
p20583
aVThe ultimate problem is that the layout of the menu item is calculated and internal
p20584
aVYou can't find out where the image ends and the text starts
p20585
aVThe OnRenderItemImage() is sadly called without any hint how wide the image area is
p20586
aVBit of a design goof there
p20587
as(dp20588
g9
V17034
p20589
stp20590
a((dp20591
g2
(lp20592
VYes, this is less than perfect
p20593
aVThe exception is caught and re-thrown in the thread that called Invoke()
p20594
aVNecessarily, it is missing the stack frames of the code in the UI thread, they are already unwound by the time the exception is re-thrown
p20595
aVThat it doesn't use the InnerException property is not great
p20596
aVOne workaround is to catch the exception in the invoked method and store it in a private field
p20597
aVA better one is to use BeginInvoke instead of Invoke
p20598
aVThat will raise the exception in the UI thread directly
p20599
as(dp20600
g9
V17034
p20601
stp20602
a((dp20603
g2
(lp20604
VThere isn't anything fundamentally wrong with calling Application
p20605
aVDoEvents() in a loop
p20606
aVThat's what Form
p20607
aVShowDialog() does
p20608
aVIt takes counter-measures to ensure the user cannot get into trouble: it disables all windows other than the dialog so the user cannot exit the application or start the dialog again
p20609
aVYou'll need to create your own, set a global flag that indicates that your main window was closed so you can immediately exit the loop without calling any more code when the rug is pulled out from under you
p20610
aVYou'll need to yield the processor to avoid 100% CPU load
p20611
aVThe easiest way to do that is by calling Thread
p20612
aVSleep(1)
p20613
aVCheck my answer in this thread for an example
p20614
as(dp20615
g9
V17034
p20616
stp20617
a((dp20618
g2
(lp20619
VTry this:
p20620
aVSample usage:
p20621
as(dp20622
g9
V17034
p20623
stp20624
a((dp20625
g2
(lp20626
VKyle is right
p20627
aVIt is just a matter of setting the PATH environment variable properly
p20628
aVThe regular x86 compiler lives in the vc\u005cbin subdirectory
p20629
aVThere are two 64-bit compilers, a 32-bit compiler that generates 64-bit code in vc\u005cbin\u005cx86_amd64 and a 64-bit compiler that generates 64-bit code in vc\u005cbin\u005camd64
p20630
aVThe default Visual Studio setup always uses the 32-bit compiler to generate 64-bit code
p20631
aVNote that the 64-bit compilers are not installed by default
p20632
aVYou'll have to re-run setup
p20633
aVexe if you didn't use the custom install option
p20634
aVAnd re-run the SP1 installer
p20635
as(dp20636
g9
V17034
p20637
stp20638
a((dp20639
g2
(lp20640
VNo need for WndProc hacking, this works fine:
p20641
aVMoves also trigger the OnResizeXxx events
p20642
as(dp20643
g9
V17034
p20644
stp20645
a((dp20646
g2
(lp20647
VThere is a marked irony in your approach
p20648
aVBy pre-creating the pens/brushes, you are exactly creating the problem that Dispose() is trying to solve
p20649
aVThose GDI objects will be around longer, just like they would be when you don't call Dispose()
p20650
aVIt is actually worse, they'll be around at least until the form is closed
p20651
aVThey are probably around long enough to get promoted to generation #2
p20652
aVThe garbage collector doesn't do a gen#2 collection very often, it is now more important to call Dispose() on them
p20653
aVDo so by moving the Dispose() method of the form from the Designer
p20654
aVcs file to your form
p20655
aVcs file and add the Dispose calls
p20656
aVBut, do this the Right Way
p20657
aVPens and brushes are very cheap objects
p20658
aVCreate them when you need them, in the Paint event
p20659
aVAnd use the using statement so they'll get disposed right away
p20660
aVUse the Stopwatch class to re-assure yourself this doesn't actually cause any slowdown
p20661
as(dp20662
g9
V17034
p20663
stp20664
a((dp20665
g2
(lp20666
VIt is called a "cue-banner"
p20667
aVWindows Forms doesn't support it but it can be bolted on
p20668
aVAdd a new class to your project and paste the code shown below
p20669
aVCompile
p20670
aVDrop a button and the new control from the top of the toolbox onto your form
p20671
aVSet the Cue property to the text you want to show
p20672
aVVista or Win7 required, the cue is only visible if the combobox doesn't have the focus
p20673
as(dp20674
g9
V17034
p20675
stp20676
a((dp20677
g2
(lp20678
VYes, your code will throw, you cannot cast a Control object to byte[]
p20679
aVThat kind of conversion requires serialization, the kind performed by BinaryFormatter
p20680
aVTrouble is: the Control class and its decedents are not serializable, they don't have the [Serializable] attribute
p20681
aVThe Control class is a complicated mother, it has hundreds of private fields
p20682
aVA lot of those fields have values that are generated at runtime, often by interoperating with the native Windows window
p20683
aVWhile serializing them is somewhat possible, deserializing is not
p20684
aVReconstructing the Control object requires the native window to be reconstructed as well
p20685
aVAnd it has a lot of state itself, the kind that's set by sending it a bunch of message
p20686
aVRegenerating those messages isn't practical
p20687
aVThis doesn't leave you with a lot of attractive options
p20688
aVSerializing a UI is possible, the Windows Forms designer and WPF XAML does it
p20689
aVBut these are very large chunks of code, not easily embedded in your program
p20690
aVAim lower, don't try to serialize the entire control
p20691
aVJust some of its properties, like Size and Location, and you'll have a shot at making this work
p20692
as(dp20693
g9
V17034
p20694
stp20695
a((dp20696
g2
(lp20697
VI'm going to assume you don't actually want to capture the screen, your question cannot make sense
p20698
aVI'm guessing you simply want to make your window maximized to occupy the full screen
p20699
aVPut the template generated code back the way it was, simply change the ShowWindow call:
p20700
as(dp20701
g9
V17034
p20702
stp20703
a((dp20704
g2
(lp20705
VThat's pretty strange
p20706
aVSounds to me like the arguments passed by the unmanaged code caused an exception in the VB
p20707
aVNET code
p20708
aVYour unmanaged code cannot detect managed exceptions
p20709
aVIt should be visible in the debug output in the Output window, you should see a first-chance exception with exception code 0xe0434f4e
p20710
aVYour changes are not a true replacement for CInt/CDec, they'll only handle string arguments
p20711
aVBut stranger yet is that CInt() doesn't have trouble with strings, it shouldn't throw
p20712
aVYou are playing fast and loose with argument types though, treating strings as numbers is always trouble
p20713
aVMake sure you declare the argument type
p20714
aVPutting Option Strict On at the top of your source code is a good way to operate the two-by-four
p20715
as(dp20716
g9
V17034
p20717
stp20718
a((dp20719
g2
(lp20720
VIt is a very common mistake, every programmer makes it at least once
p20721
aVThere are two kind of division operators, they both use the same symbol, integral and floating point
p20722
aVThe compiler chooses which it uses based on the types of the operands
p20723
aVIf both the left- and right-hand operands are integral then you'll get an integral division
p20724
aVThe idiv instruction in machine code
p20725
aVWhich truncates to zero and produces an integral result
p20726
aVAs soon as at least one operand is floating point, you'll get the fdiv instruction in machine code and the result you are looking for
p20727
aVSimply casting to (float) or (double) is enough, like you did in your question
p20728
aVYou only have to cast one of them
p20729
aVOr use a floating point literal like 200f or 200
p20730
ag2512
as(dp20731
g9
V17034
p20732
stp20733
a((dp20734
g2
(lp20735
VNo, C++ doesn't have syntax for accessors
p20736
aVC++ programmers frown on features that are not well supported by the language
p20737
aVNor does if have many Resharper style tools
p20738
aVIf you don't like to type then C++ is not a language you should consider
p20739
aVKeep Neil happy and avoid the "bad design" put-down by omitting the "get" prefix
p20740
aVLike size(), not getSize()
p20741
aVMSVC supports declaring properties with the __declspec(property) declarator
p20742
aVIt is however very non-standard
p20743
aVAnd takes a lot of typing, you still need to write the accessor functions
p20744
as(dp20745
g9
V17034
p20746
stp20747
a((dp20748
g2
(lp20749
VNo, this is next-to-impossible to get 100% reliable
p20750
aVYou have to write a C++ language parser to be able to accurately lift the class name out of the declaration and deal with complexities like default argument values and missing argument names
p20751
aVWriting a C++ parser is hard in any language but you'll especially find VBA lacking
p20752
aVCheck out Visual Assist
p20753
aVTheir website is down right now (uh-oh), can't give you an accurate link
p20754
as(dp20755
g9
V17034
p20756
stp20757
a((dp20758
g2
(lp20759
VYes, quite a resource hog
p20760
aVI'm guessing at variables you've marked with the [ThreadStatic] attribute
p20761
aVYou've got way too many threads
p20762
as(dp20763
g9
V17034
p20764
stp20765
a((dp20766
g2
(lp20767
VThis worked as you wanted:
p20768
as(dp20769
g9
V17034
p20770
stp20771
a((dp20772
g2
(lp20773
VYou can lie in your P/Invoke declaration, the members will align properly on all current CPU architectures to be readable as an array in unmanaged code:
p20774
as(dp20775
g9
V17034
p20776
stp20777
a((dp20778
g2
(lp20779
VDictionary<> is an unordered collection, you'll only get the elements out of it in the order you put them in by accident
p20780
aVYou'll need a SortedDictionary<>
p20781
as(dp20782
g9
V17034
p20783
stp20784
a((dp20785
g2
(lp20786
VSet the MinimumSize property in the designer or add this code to the form constructor:
p20787
as(dp20788
g9
V17034
p20789
stp20790
a((dp20791
g2
(lp20792
VIt is per-thread on Windows
p20793
aVNot sure about OS-X, surely it does
p20794
aVBeware the nastiness you can run into if you are using libraries that expect the control word to be set at the default
p20795
aVAlmost all of them do
p20796
as(dp20797
g9
V17034
p20798
stp20799
a((dp20800
g2
(lp20801
VThat's not what RestoreDirectory is designed to do
p20802
aVIt makes sure that the program's default directory is restored when the dialog closes, even if the user navigated to another directory
p20803
aVThe directory that is first selected by the dialog is selected by a registry key, written by Windows
p20804
aVThe exact rules for that are murky and isn't the same for different versions of Windows
p20805
aVIf you want the dialog to open at a specific directory, be sure to set the InitialDirectory property
p20806
as(dp20807
g9
V17034
p20808
stp20809
a((dp20810
g2
(lp20811
VThis doesn't look good
p20812
aVThere is almost never a valid reason to assume that when the last thread is completed that the other ones are done as well
p20813
aVUnless you somehow interlock the worker threads, which you should never do
p20814
aVIt also makes little sense to Sleep(), waiting for a thread to complete
p20815
aVYou might as well do the work that thread is doing
p20816
aVIf you've got multiple threads going, give them each a ManualResetEvent
p20817
aVYou can wait on completion with WaitHandle
p20818
aVWaitAll()
p20819
aVCounting down a thread counter with the Interlocked class can work too
p20820
aVOr use a CountdownLatch
p20821
as(dp20822
g9
V17034
p20823
stp20824
a((dp20825
g2
(lp20826
VOn a 32-bit operating system, you'll get at most a contiguous chunk of memory around 550 Megabytes, allowing loading a file of half that size
p20827
aVThat goes down hill quickly after your program has been running for a while and the virtual memory address space gets fragmented
p20828
aV100 Megabytes is about all you can hope for
p20829
aVThis is not an issue on a 64-bit operating system
p20830
aVSince reading a text file one line at a time is just as fast as reading all lines, this should never be a real problem
p20831
as(dp20832
g9
V17034
p20833
stp20834
a((dp20835
g2
(lp20836
VYour app crashed on an unhandled exception
p20837
aVThe Watson log won't be good enough to find the cause
p20838
aVWrite an event handler for the AppDomain
p20839
aVCurrentDomain
p20840
aVUnhandledException event, have it write e
p20841
aVExceptionObject
p20842
aVToString() to the event log so you'll get a good stack trace that shows you why and where it bombed
p20843
as(dp20844
g9
V17034
p20845
stp20846
a((dp20847
g2
(lp20848
VA Bitmap will work fine, display it with the PictureBox
p20849
aVImage property
p20850
aVUse Graphics
p20851
aVFromImage() to get the Graphics object you'll need to draw on the bitmap
p20852
aVUse PictureBox
p20853
aVInvalidate() to let the PB know that it needs to update the image on the screen
p20854
as(dp20855
g9
V17034
p20856
stp20857
a((dp20858
g2
(lp20859
VYou really need to pay attention to the meaning for the return value of the API functions
p20860
aVYou cannot ignore a FALSE return from CreateProcess()
p20861
aVWaitForSingleObject() can return several values, it returns 0 if the wait completed successfully
p20862
aVWhich makes you print "false"
p20863
as(dp20864
g9
V17034
p20865
stp20866
a((dp20867
g2
(lp20868
VThe wrapper is a very thin one, it directly calls the native ogg codec functions
p20869
aVLook for the docs of ov_read to see what you get back from OggVorbisEncodedStream
p20870
aVRead()
p20871
aVRaw PCM would be my guess
p20872
aVThe wrapper doesn't attempt any kind of format conversion
p20873
aVYes, SoundPlayer won't work here, it requires wav and can't stream
p20874
aVYou'll need a player that can take chunks of PCM as an input
p20875
aVNot sure what does that, the NAudio project is usually good for stuff like this
p20876
as(dp20877
g9
V17034
p20878
stp20879
a((dp20880
g2
(lp20881
VIt really doesn't matter
p20882
aVThe true cost is in I/O, getting the query to the dbase engine and getting the results back
p20883
aVAnd getting them painted to the screen in the case of WinForms
p20884
aVWhacking the bits into an object model is a fraction of a percent of the overall cost
p20885
as(dp20886
g9
V17034
p20887
stp20888
a((dp20889
g2
(lp20890
s(dp20891
g9
V17034
p20892
stp20893
a((dp20894
g2
(lp20895
VDraw the bitmap with a ColorMatrix that has 3 x 255 in the diagonal, that will blow any non-black pixel to pure white
p20896
aVThen draw that bitmap to a smaller one whose width is a multiple of 4 and has the Format24bppRgb format
p20897
aVThat eliminates the alpha, reduces the size and leaves only zeros if the bitmap is truly black
p20898
aVYou'll have to experiment to see how small you can make the bitmap, use a sample one that has only one white pixel to see when the interpolator makes it disappear
p20899
aVI'm guessing you can go pretty far
p20900
as(dp20901
g9
V17034
p20902
stp20903
a((dp20904
g2
(lp20905
VIt is made up from 3 distinct sources:
p20906
aVTools + Options, Projects and Solutions, VC++ Directories
p20907
aVIn turn built up from several registry keys
p20908
aVthe settings in your
p20909
aVvsprops project property sheets
p20910
aVthe settings in your
p20911
aVvcproj project
p20912
aVThe first part is the hardest, you can get it by running vc\u005cvsvarsall
p20913
aVbat
p20914
aVThe
p20915
aVvsprops and
p20916
aVvcproj files are XML, easy to parse
p20917
aVIf you just want to find out what the command line should look like then you can get it from the buildlog
p20918
aVhtm file, produced when building from the IDE
p20919
aVOr you could use vcbuild
p20920
aVexe on the command line to build your project from the
p20921
aVvcproj file
p20922
aVOr you could build using devenv
p20923
aVexe /build
p20924
as(dp20925
g9
V17034
p20926
stp20927
a((dp20928
g2
(lp20929
VWPF sizes are not in pixels, they are in units of 1/96 inch
p20930
aVYour video adapter is probably set to 120 DPI, you'd have to make it 730 / 96 * 120 = 913 units wide
p20931
as(dp20932
g9
V17034
p20933
stp20934
a((dp20935
g2
(lp20936
VMicrosoft sternly and repeatedly has warned against this practice
p20937
aVThe resources in shell32
p20938
aVdll are a private implementation detail and can change without notice
p20939
aVAssuming you want to ignore this: you can lift the icons out of it by P/Invoking LoadLibrary() to get a module handle and LoadImage() to get the icon
p20940
aVUnfortunately, the Icon constructor that takes a handle is private, you'll have to use Reflection to invoke it
p20941
aVVisit pinvoke
p20942
aVnet for the declarations
p20943
aVWhile this all works, this isn't great code that you'll enjoy maintaining
p20944
aVFwiw, lifting the icons out of shell32
p20945
aVdll and putting it in a managed resource is very simple
p20946
aVIn Visual Studio, use File + Open + File and open shell32
p20947
aVdll
p20948
aVYou'll get a list of all the resources, navigate into the Icons node
p20949
aVDouble click one to see what it contains, right click + Export to save it to a file
p20950
aVNo idea how legal this is, the icons themselves don't carry a copyright notice but shell32
p20951
aVdll certainly does
p20952
aVIt probably isn't
p20953
as(dp20954
g9
V17034
p20955
stp20956
a((dp20957
g2
(lp20958
VWindows sends the WM_MOUSESCROLL message to the control with the focus
p20959
aVIf the control doesn't use it then it gets sent to the parent of the control
p20960
aVEventually that will be your form which then uses it to scroll itself
p20961
aVComboBox is however quite happy to use the message itself
p20962
aVWhen the dropdown is shown, it scrolls the dropdown list
p20963
aVIt also captures the mouse so that it can see you clicking outside of the list
p20964
aVWhich closes the list and keeps the focus on the ComboBox
p20965
aVWhich then uses the message to scroll the items through the text box portion
p20966
aVIn other words, when the CB has the focus, you'll never get the scroll the form
p20967
aVYou can mess with this by using IMessageFilter
p20968
aVMy code in this thread shows an example
p20969
aVYou'll have to doctor it, the code was made to do something else
p20970
aVYou can replace the m
p20971
aVHWnd field with the form's Handle property value for example so all mouse scroll messages go to the form instead
p20972
aVOr you can use the code as-is, it is perhaps more intuitive
p20973
aVBe careful with this, your user might well be fatally confused by this non-standard behavior
p20974
aVMaybe she really wants to scroll the combo
p20975
aVHere is the code to make it work
p20976
aVPut it in your app's main form, it is active for all other forms that your app shows:
p20977
as(dp20978
g9
V17034
p20979
stp20980
a((dp20981
g2
(lp20982
VNo problem, just change the output folders for each configuration
p20983
aVIn the C++ IDE it is General + Output Directory, make it $(SolutionDir)x86\u005c$(ConfigurationName) for Win32
p20984
aVIn the C# IDE it is Project + Properties, Build tab, Output path
p20985
aVSwitch between configurations and repeat
p20986
as(dp20987
g9
V17034
p20988
stp20989
a((dp20990
g2
(lp20991
VIt is a shell dialog, you'll get the shell extensions injected into your process
p20992
aVYou probably got a lousy one that is causing the crash
p20993
aVYou can see them getting loaded with Project + Properties, Debug tab, tick Enabled unmanaged code debugging
p20994
aVPay attention to the Output window when you open the dialog, you'll see a line for each DLL getting loaded
p20995
aVShort from uninstalling the trouble-maker, SysInterals' AutoRuns utility is a good way to disable shell extensions
p20996
as(dp20997
g9
V17034
p20998
stp20999
a((dp21000
g2
(lp21001
VThis worked:
p21002
aVSample usage:
p21003
aVBeware that the value returned by GetNodeBounds() may change when the user expands nodes
p21004
aVIt can only see the width of visible nodes
p21005
as(dp21006
g9
V17034
p21007
stp21008
a((dp21009
g2
(lp21010
VYes, no problem
p21011
aVC++/CLI supports inheritance just as well as any other managed language
p21012
aVWhat is missing is the point-and-click IDE support, you'll have to type
p21013
aVAdd the base form to your project, change the derived Form declaration
p21014
aVFor example:
p21015
as(dp21016
g9
V17034
p21017
stp21018
a((dp21019
g2
(lp21020
VSHFileOperation, it is well supported by the standard
p21021
aVNET framework
p21022
aVAdd a reference to Microsoft
p21023
aVVisualBasic
p21024
aVdll and use the Microsoft
p21025
aVVisualBasic
p21026
aVFileIO
p21027
aVFileSystem
p21028
aVCopyDirectory() method
p21029
aVSeveral overloads are available that allows you to control what the UI looks like and how to handle errors
p21030
as(dp21031
g9
V17034
p21032
stp21033
a((dp21034
g2
(lp21035
VYes, the old 16-bit Windows 3
p21036
aVx maximum value on coordinates is still around in scattered unobvious places
p21037
aVIn this case it is very likely to be your printer driver
p21038
aVIf a driver upgrade doesn't fix it, there's not much you can do but scale the polyline yourself
p21039
as(dp21040
g9
V17034
p21041
stp21042
a((dp21043
g2
(lp21044
VThey don't have default values
p21045
aVThese properties are "ambient" properties
p21046
aVThe Control class detects that a property assignment has occurred for them
p21047
aVIf that never happened, it uses the corresponding property from the Parent
p21048
aVWhich is nice, it ensures child controls use the same colors and font as their container
p21049
aVThere is a ShouldSerializeForeColor() method in the Control class
p21050
aVIt is internal and can't be overridden by user code
p21051
aVSame for the other properties
p21052
aVHave a look-see with Reflector or the
p21053
aVNET Reference Source
p21054
aVThe MSDN Library documents them like this:
p21055
aVWindows Forms controls use ambient
p21056
aVproperties so child controls can
p21057
aVappear like their surrounding
p21058
aVenvironment
p21059
aVAn ambient property is a
p21060
aVcontrol property that, if not set, is
p21061
aVretrieved from the parent control
p21062
aVIf
p21063
aVthe control does not have a Parent,
p21064
aVand the property is not set, the
p21065
aVcontrol attempts to determine the
p21066
aVvalue of the ambient property through
p21067
aVthe Site  property
p21068
aVIf the control is
p21069
aVnot sited, if the site does not
p21070
aVsupport ambient properties, or if the
p21071
aVproperty is not set on the
p21072
aVAmbientProperties, the control uses
p21073
aVits own default values
p21074
aVTypically, an
p21075
aVambient property represents a
p21076
aVcharacteristic of a control, such as
p21077
aVBackColor, that is communicated to a
p21078
aVchild control
p21079
aVFor example, a Button
p21080
aVwill have the same BackColor as its
p21081
aVparent Form  by default
p21082
aVAmbient
p21083
aVproperties provided by the Control
p21084
aVclass include: Cursor, Font,
p21085
aVBackColor, ForeColor, and RightToLeft
p21086
as(dp21087
g9
V17034
p21088
stp21089
a((dp21090
g2
(lp21091
VRoughly 95% of all failure modes for unmanaged code produce an access violation
p21092
aVYou can trigger such a failure mode by getting the [DllImport] declaration wrong
p21093
aVBut DoesExist() as posted cannot trigger one
p21094
aVContact the vendor or the author of the DLL for support
p21095
aVThey should have little trouble reproducing the fault and diagnosing it with a debugger and their source code if you got it to fail so easily
p21096
aVFor completeness, the most typical causes of AccessViolation:
p21097
aVa memory management bug in the unmanaged code, causing heap corruption
p21098
aVnot validating data, causing null dereferences or buffer overflows
p21099
aVnot checking for failure return error codes when calling support functions
p21100
as(dp21101
g9
V17034
p21102
stp21103
a((dp21104
g2
(lp21105
VFirst add the
p21106
aVwav file as a resource: Project + Properties, Resources tab, click on the arrow of "Add Resource", Add Existing File and navigate to your wav
p21107
aVLet's say it is called "Beep"
p21108
aVThen add code like this to play the sound:
p21109
as(dp21110
g9
V17034
p21111
stp21112
a((dp21113
g2
(lp21114
VComplex numbers have many applications
p21115
aVThey are useful for being able to store two properties (the real and imaginary parts) that behave sensibly when you apply standard math operators on them, like multiplication
p21116
aVMany problems become easy to solve by transforming them to the complex number domain, perform an operation on them that is easy to calculate, then transforming them back
p21117
aVA good example is calculating the behavior of an electronic circuit that has reactive components
p21118
aVThe impedance of a coil in the complex domain is jwL, of a capacitor is 1/jwC (w = omega)
p21119
aVDriven with a signal in the complex domain, you can easily calculate the response
p21120
aVIn this particular case, graphing the response is meaningful by mapping the real part on the X-axis and the imaginary part on the Y-axis
p21121
aVThe length of the vector is the amplitude, the angle is the phase
p21122
aVThe Laplace transform is another complex domain transformation, based on Euler's identity
p21123
aVIt has a very useful graphical representation too, plotting the complex roots of the equation within the unity circle allows predicting the stability of a feedback system
p21124
aVThese kind of transforms are popular because they simplify the math or their graphical representation are easy to interpret
p21125
aVWhether yours are equally useful really depends on what the transform does
p21126
as(dp21127
g9
V17034
p21128
stp21129
a((dp21130
g2
(lp21131
VWindows Forms has built-in support for that, you don't need to write any code
p21132
aVSelect your check box
p21133
aVIn the Properties window, scroll to the top on expand the "ApplicationSettings" node
p21134
aVClick on "Checked" and drop-down the combobox
p21135
aVClick New
p21136
aVSet the Name property to something meaningful
p21137
aVDone
p21138
aVYour check box will always restore with the last selection that the user selected
p21139
aVDon't call Show() when it is turned on, dispose the form right away
p21140
as(dp21141
g9
V17034
p21142
stp21143
a((dp21144
g2
(lp21145
VOnly if you run on an old operating system, XP is the last one that allows a service to interact with the desktop
p21146
aVYou'll need to write a separate app that can run on the user's desktop
p21147
aVTalk to the service through, well, WCF
p21148
aVOr a named pipe or socket
p21149
as(dp21150
g9
V17034
p21151
stp21152
a((dp21153
g2
(lp21154
VIt is available in version 7 of the SDK
p21155
aVVS2008 came with version 6
p21156
aV0a
p21157
as(dp21158
g9
V17034
p21159
stp21160
a((dp21161
g2
(lp21162
VYou need the lock statement to protect shared data, variables that are read and written by more than one thread at the same time
p21163
aVThe "lot" variable doesn't qualify that requirement, every thread creates its own instance of a Lot object
p21164
aVAnd the reference is stored in a local variable ("lot"), every thread has its own local variables
p21165
aVThe lots field does fit the requirement
p21166
aVThere is only one instance of it, because there is only one instance of the Work class, all threads access it
p21167
aVAnd threads both read and write to the list, respectively through the Contains method and the Add method
p21168
aVYour lock statement prevents a thread from accessing the list at the same time and is correct, Contains can never run at the same time as Add
p21169
aVYou are 95% there, you just missed that each thread has a unique "lot" object
p21170
aVOne that cannot have been added to the list before
p21171
aVEvery single thread will therefore get a false return from Contains
p21172
aVIf you want the Lot class to have identity, based on the LotID and LotNumber property values instead of just the object instance, then you'll need to give it identity by overriding the Equals() and GetHashCode() method
p21173
aVCheck your favorite C# programming book, they all mention this
p21174
aVIt doesn't otherwise have anything to do with threading
p21175
as(dp21176
g9
V17034
p21177
stp21178
a((dp21179
g2
(lp21180
VThat's not how it works
p21181
aVThe test property getter will return an object of a concrete class that implements ITest
p21182
aVWhatever was assigned to it last, either null, an object of Test1 or an object of Test2
p21183
aVPropertyGrid uses Reflection to look at the object Type and its members
p21184
aVIt will display either Test1Property or Test2Property
p21185
aVYou cannot choose
p21186
aVNot sure what you are trying to do, you probably want a UITypeEditor if you want to assign an object of a different type
p21187
as(dp21188
g9
V17034
p21189
stp21190
a((dp21191
g2
(lp21192
VYou can't get this perfect, the players cannot start at the same time by design
p21193
aVYou'll need to mix the two songs into a new song, the NAudio library can do this
p21194
as(dp21195
g9
V17034
p21196
stp21197
a((dp21198
g2
(lp21199
VYes, you'll have to change the FPU control word to avoid this
p21200
aVIt is explained well for most popular compilers in this web page
p21201
aVBeware that this is dramatically incompatible with what most libraries expect the FPU to do, don't mix and match
p21202
aVAlways restore the FPU control word after you're done
p21203
as(dp21204
g9
V17034
p21205
stp21206
a((dp21207
g2
(lp21208
VIt doesn't make a lot of sense, don't have an easy way to check it
p21209
aVI reckon the best approach is to read the
p21210
aVlnk file the way it is supposed to be read
p21211
aVYou can use COM to do so, the ShellLinkObject class implements the IShellLink interface
p21212
aVGet started with Project + Add Reference, Browse tab and navigate to c:\u005cwindows\u005csystem32\u005cshell32
p21213
aVdll
p21214
aVThat generates an interop library
p21215
aVWrite code like this:
p21216
as(dp21217
g9
V17034
p21218
stp21219
a((dp21220
g2
(lp21221
VNo repro, it scales perfectly
p21222
aVIt will not scale properly if you've set the Font property of the UserControl and it doesn't match the font size of the form
p21223
aVThe Font property is an "ambient" property, like ForeColor and BackColor
p21224
aVAs long as you leave it to the default setting (not bold in the Properties window) then it will use the Font of the parent
p21225
aVWhen every control uses the same font size, they'll all scale proportionally
p21226
aVTo fix, select the text of the Font property in the Properties window, press Backspace to erase it and press Enter
p21227
aVIt resets back to the default
p21228
aVFix your code like this:
p21229
as(dp21230
g9
V17034
p21231
stp21232
a((dp21233
g2
(lp21234
VThere's an extra level of indirection here
p21235
aVYes, the RCW keeps a single reference count on the native COM interface pointers
p21236
aVBut the RCW has a reference count too, it is incremented every time a COM interface pointer is mapped to the RCW
p21237
aVWhich may happen if a COM method returns an interface pointer
p21238
aVThe finalizer of the corresponding
p21239
aVNET wrapper class decrements it
p21240
aVYou can tinker with that reference count directly through Marshal
p21241
aVReleaseComObject(), which decrements it by one like the finalizer does, and Marshal
p21242
aVFinalReleaseComObject(), which zaps it to zero, guaranteeing that the IUnknown::Release() method is called
p21243
aVThey of course fall in the "better know what you're doing" category
p21244
aVGetting it wrong produces the ugly and undebuggable "COM object separated from its underlying RCW" exception
p21245
as(dp21246
g9
V17034
p21247
stp21248
a((dp21249
g2
(lp21250
VI'm pretty sure there are no project templates in the Windows SDK
p21251
aVNote that the web page "recommends" downloading the VS2008 Professional Trial Edition
p21252
aVYes, that would work, it has WF project templates
p21253
as(dp21254
g9
V17034
p21255
stp21256
a((dp21257
g2
(lp21258
VYes, 522 Megabytes is about as large a contiguous chunk of virtual memory that can be allocated on the 32-bit version of Windows
p21259
aVThat's one hunking large library, you'll have to split it up
p21260
aVYou might be able to postpone the inevitable by building on a 64-bit version of Windows, 32-bit programs get a much larger virtual memory space, close to 4 GB
p21261
as(dp21262
g9
V17034
p21263
stp21264
a((dp21265
g2
(lp21266
VIt is not how it works
p21267
aVNothing gets "pushed", the compiler simply reserves space in the stack frame
p21268
aVYou cannot return such a string from the function, you'll return a pointer to a dead stack frame
p21269
aVAny subsequent function call will destroy the string
p21270
aVReturn strings by letting the caller pass a pointer to a buffer, as well as an argument that says how large the buffer is so you won't overrun the end of the buffer when the string is too long
p21271
as(dp21272
g9
V17034
p21273
stp21274
a((dp21275
g2
(lp21276
VYou can use VirtualLock
p21277
aVHowever, you'll surely hit the quota with the amount you're talking about
p21278
aVGiven that you should never run any other code on this machine, you'll be better off just disabling the paging file
p21279
aVControl Panel + System + Advanced
p21280
as(dp21281
g9
V17034
p21282
stp21283
a((dp21284
g2
(lp21285
VYes, included since 3
p21286
aV0, no doubt to support WPF
p21287
aVEvidence is here
p21288
aVCopied to c:\u005cwindows\u005csystem32\u005crgb9rast
p21289
aVdll
p21290
as(dp21291
g9
V17034
p21292
stp21293
a((dp21294
g2
(lp21295
VA standard optimization with any string class is to store the string length along with the string
p21296
aVWhich will make any string operation that requires the string length to be known to be O(1) instead of O(n), strlen() being the obvious one
p21297
aVOr copying a string, there's no gain in the actual copy but figuring out how much memory to allocate before the copy is O(1)
p21298
aVThe overall algorithm is still O(n)
p21299
aVThe basic operation is still the same, shoveling bytes takes just as long in any language
p21300
aVString classes are useful because they are safer (harder to shoot your foot) and easier to use (require less explicit code)
p21301
aVThey became popular and widely used because they weren't slower
p21302
as(dp21303
g9
V17034
p21304
stp21305
a((dp21306
g2
(lp21307
VThis kind of code can never work in a generic way
p21308
aVIt relies on a hard assumption that the memory layout for T is predictable and consistent
p21309
aVThat is only true if T is a simple value type
p21310
aVIgnoring endianness for a moment
p21311
aVYou are dead in the water if T is a reference type, you'll be copying tracking handles that can never be deserialized, you'll have to give T the struct constraint
p21312
aVBut that's not enough, structure types are not copyable either
p21313
aVNot even if they have no reference type fields, something you can't constrain
p21314
aVThe internal layout is determined by the JIT compiler
p21315
aVIt swaps fields at its leisure, selecting one where the fields are properly aligned and the structure value take the minimum storage size
p21316
aVThe value you'll serialize can only be read properly by a program that runs with the exact same CPU architecture and JIT compiler version
p21317
aVThere are already plenty of classes in the framework that do what you are doing
p21318
aVThe closest match is the
p21319
aVNET 4
p21320
aV0 MemoryMappedViewAccessor class
p21321
aVIt needs to do the same job, making raw bytes available in the memory mapped file
p21322
aVThe workhorse there is the System
p21323
aVRuntime
p21324
aVInteropServices
p21325
aVSafeBuffer class, have a look-see with Reflector
p21326
aVUnfortunately, you can't just copy the class, it relies on the CLR to make the transformation
p21327
aVThen again, it is only another week before it's available
p21328
as(dp21329
g9
V17034
p21330
stp21331
a((dp21332
g2
(lp21333
VYou are mixing class libraries, don't use Windows Forms classes in a WPF project
p21334
aVMake it look like this:
p21335
as(dp21336
g9
V17034
p21337
stp21338
a((dp21339
g2
(lp21340
VThere is no disassembler built into the
p21341
aVNET framework
p21342
aVYou could use Reflector to convert the IL you emitted to one of the source code languages it supports
p21343
aVIt isn't terribly likely that this will work without problems, Reflector was designed to convert code that was generated by a compiler back to source code
p21344
aVCompilers tend to be conservative about the IL they generate, unlike the anything-goes approach that System
p21345
aVReflection
p21346
aVEmit offers
p21347
aVIf you want source code then you're best off by generating it in the first place
p21348
aVUse System
p21349
aVCodeDom
p21350
aVThat's what System
p21351
aVXml
p21352
aVSerialization uses
p21353
as(dp21354
g9
V17034
p21355
stp21356
a((dp21357
g2
(lp21358
VIn Visual Studio, use File + Open + File and select c:\u005cwindows\u005csystem32\u005cuser32
p21359
aVdll
p21360
aVOpen the Icon node and double-click 103
p21361
aVOn my machine that's the Error icon
p21362
aVBack, right-click it and select Export to save it to a file
p21363
aVThat's the iffy way
p21364
aVThese icons are also available in Visual Studio
p21365
aVFrom your Visual Studio install directory, navigate to Common7\u005cVS2008ImageLibrary\u005cxxxx\u005cVS2008ImageLibrary
p21366
aVzip + VS2008ImageLibrary\u005cAnnotations&Buttons;\u005cico_format\u005cWinVista\u005cerror
p21367
aVico
p21368
aVThe redist
p21369
aVtxt file in the Visual Studio install directly explicitly gives you the right to use this icon in your own application
p21370
as(dp21371
g9
V17034
p21372
stp21373
a((dp21374
g2
(lp21375
VNo repro on Win7
p21376
aVAdding 5000 items takes forever, adding one is quick
p21377
aVAre you sure it isn't the image list that's slow
p21378
aVDiagnose this by setting up Windows debugging symbols and using Debug + Break All
p21379
aVCheck out the call stack for a pattern
p21380
aVPost what you see in your question if you need help interpreting it
p21381
as(dp21382
g9
V17034
p21383
stp21384
a((dp21385
g2
(lp21386
VYou need to isolate the virtual key out of the wHotKey value:
p21387
as(dp21388
g9
V17034
p21389
stp21390
a((dp21391
g2
(lp21392
VThe C# compiler generates code like this:
p21393
aVThe temp variable is the CS$0$0000 you see
p21394
aVI think it does this to ensure that an exception that might be raised while initializing the array doesn't leave a partially initialized array in "parameters"
p21395
aVWhich could cause unexpected failure when code catches the exception
p21396
aVAs written, the named variable is either null or fully initialized
p21397
aVGood idea
p21398
as(dp21399
g9
V17034
p21400
stp21401
a((dp21402
g2
(lp21403
VYou could declare it void* and cast the errors away
p21404
aVThis is close to a never-ending battle though, sooner or later you'll get tripped up
p21405
aVUse pre-compiled headers so you don't care about the size of windows
p21406
ag6193
aVstdafx
p21407
aVh:
p21408
as(dp21409
g9
V17034
p21410
stp21411
a((dp21412
g2
(lp21413
VThis code will get the job done:
p21414
aVYou can speed it up, if necessary, by using unsafe code to replace the GetPixel() method
p21415
as(dp21416
g9
V17034
p21417
stp21418
a((dp21419
g2
(lp21420
VThere's not enough code to make the call
p21421
aVBut sure, nothing good is going to happen if you don't serialize write access to the file
p21422
aVThe 2nd thread that assigns the property is going to bomb on an IOException if the 1st thread is still busy writing the file
p21423
aVFine-grained locking like this is usually a problem
p21424
aVThe client code could be busy changing more than one property of the class
p21425
aVYou'll get a partial update if an exception is raised, producing a file that contains serialized state that is invalid and may cause trouble when it is read
p21426
aVYou'll need something like a BeginUpdate(), EndUpdate() pair
p21427
as(dp21428
g9
V17034
p21429
stp21430
a((dp21431
g2
(lp21432
VYou cannot suppress AppDomain
p21433
aVUnhandledException
p21434
aVSomething really nasty happened, a thread in your program died from a heart attack
p21435
aVThe odds that the program will continue to run in a meaningful way are zero,
p21436
aVNET puts an end to the misery by terminating the program
p21437
aVWrite an event handler for the AppDomain
p21438
aVCurrentDomain
p21439
aVUnhandledException event and log or display the value of e
p21440
aVExceptionObject
p21441
aVToString() so you know what caused the mishap
p21442
aVThat gives you a hint how to fix your code
p21443
aVIf any, it may well be something that you cannot fix yourself
p21444
aVSome kind of database server malfunction for example
p21445
aVDoing anything to intentionally hide the error is therefore a Very Bad Idea
p21446
aVYour customer's support staff will have no idea what to do
p21447
as(dp21448
g9
V17034
p21449
stp21450
a((dp21451
g2
(lp21452
VThese kind of long delays are almost always network related
p21453
aVThis blog post shows a troubleshooting strategy
p21454
as(dp21455
g9
V17034
p21456
stp21457
a((dp21458
g2
(lp21459
VSome sample code that allow moving and resizing the form:
p21460
as(dp21461
g9
V17034
p21462
stp21463
a((dp21464
g2
(lp21465
VYou are getting the correct processor count, AMD X2 is a true multi-core processor
p21466
aVAn Intel hyperthreaded core is treated by Windows as a muti-core CPU
p21467
aVYou can find out whether or not hyperthreading is used with WMI, Win32_Processor, NumberOfCores vs NumberOfLogicalProcessors
p21468
as(dp21469
g9
V17034
p21470
stp21471
a((dp21472
g2
(lp21473
VLockWorkstation is available on Windows 2000 and up
p21474
aVYou have to declare the version of Windows you are targeting
p21475
aVMake it look like this:
p21476
as(dp21477
g9
V17034
p21478
stp21479
a((dp21480
g2
(lp21481
VJust pass it to the constructor:
p21482
as(dp21483
g9
V17034
p21484
stp21485
a((dp21486
g2
(lp21487
VHiding your form with the NotifyIcon is often desirable so your app starts in the tray right away
p21488
aVYou can prevent it from getting visible by overriding the SetVisibleCore() method
p21489
aVYou also typically want to prevent it from closing when the user clicks the X button, override the OnFormClosing method to hide the form
p21490
aVYou'll want a context menu to allow the user to really quit your app
p21491
aVAdd a NotifyIcon and a ContextMenuStrip to your form
p21492
aVGive the CMS the Show and Exit menu commands
p21493
aVMake the form code look like this:
p21494
as(dp21495
g9
V17034
p21496
stp21497
a((dp21498
g2
(lp21499
VIt is possible with some servings of P/Invoke and the magic provided by Control
p21500
aVBeginInvoke()
p21501
aVAdd a new class to your project and paste this code:
p21502
aVSample usage:
p21503
aVNote that this code works for any of the Windows dialogs
p21504
aVMessageBox, OpenFormDialog, FolderBrowserDialog, PrintDialog, ColorDialog, FontDialog, PageSetupDialog, SaveFileDialog
p21505
as(dp21506
g9
V17034
p21507
stp21508
a((dp21509
g2
(lp21510
VYour requirement is incomplete, it doesn't say what should happen when some nodes are checked
p21511
aVAnyhoo, this kind is code is easy to get going with the AfterCheck event
p21512
aVFor example:
p21513
as(dp21514
g9
V17034
p21515
stp21516
a((dp21517
g2
(lp21518
VThere is no equivalent
p21519
aVA form has a modal sizing loop, started when the user clicks the edge or a corner of the form
p21520
aVChild controls cannot be resized that way, it only sees changes to its Size property
p21521
aVSolve this by adding a Sizing property to your user control
p21522
aVThe form can easily assign it from its OnResizeBegin/End() overrides
p21523
aVFollowing the Parent property in the UC's Load event until you find the Form is possible too:
p21524
as(dp21525
g9
V17034
p21526
stp21527
a((dp21528
g2
(lp21529
VInternet Explorer supports the IHtmlElementRenderer interface, available to render a page to an arbitrary device context
p21530
aVHere's a sample form that shows you how to use it
p21531
aVStart with Project + Add Reference, select Microsoft
p21532
aVmshtml
p21533
as(dp21534
g9
V17034
p21535
stp21536
a((dp21537
g2
(lp21538
VThat's not how it works, the Tag property type is System
p21539
aVObject
p21540
aVYou can store a reference to anything you want, including a 2 gigabyte string on a 64-bit version of Windows
p21541
as(dp21542
g9
V17034
p21543
stp21544
a((dp21545
g2
(lp21546
VSome compilers support a long double format that has more precision than double
p21547
aVMicrosoft MSVC isn't one of them
p21548
aVIf 15 significant digits isn't good enough then the odds are very high that you shouldn't be using a floating point type in the first place
p21549
aVCheck this thread for arbitrary precision libraries
p21550
as(dp21551
g9
V17034
p21552
stp21553
a((dp21554
g2
(lp21555
VA database engine is already very good at generating unique primary key values for a dbase table
p21556
aVEither by marking the column auto-increment or by using a Guid
p21557
aVTrying to create your own is a grave mistake
p21558
aVSystem wide is just not wide enough, it fails miserably when your app grows and more than one machine starts using the database
p21559
aVNevertheless, you can get what you want in VB6 by creating a COM server
p21560
aVIt's been to long, I forgot the exact names of the project options, something resembling "single use"
p21561
as(dp21562
g9
V17034
p21563
stp21564
a((dp21565
g2
(lp21566
VThat's the exception code for a managed exception
p21567
aVWhile your code is running in Excel, start Visual Studio and use Tools + Attach to Process
p21568
aVSelect excel
p21569
aVexe from the list and select Managed code
p21570
aVDebug + Exceptions, check the Thrown box for Common Language Runtime Exceptions
p21571
aVThe debugger will stop when the exception is thrown
p21572
as(dp21573
g9
V17034
p21574
stp21575
a((dp21576
g2
(lp21577
VYou could use this:
p21578
aVFor example:
p21579
aVOutput:
p21580
as(dp21581
g9
V17034
p21582
stp21583
a((dp21584
g2
(lp21585
VThe TimeZoneInfo
p21586
aVConvertTimeFromUtc() method will solve your problem:
p21587
aVOutput:
p21588
aVYou'll need
p21589
aVNET 3
p21590
aV5 or better and run on an operating system that keeps historical daylight saving time changes (Vista, Win7 or Win2008)
p21591
as(dp21592
g9
V17034
p21593
stp21594
a((dp21595
g2
(lp21596
VJust suppress it with a proper KeyDown event handler:
p21597
as(dp21598
g9
V17034
p21599
stp21600
a((dp21601
g2
(lp21602
VI'm getting ~5 msec for both
p21603
aV7100 fps is way too fast for the software rendering done by GDI+
p21604
aVVideo drivers notoriously cheat to win benchmarks, they can detect that a BitBlt doesn't have to be performed because the image didn't change
p21605
aVTry passing random values to e
p21606
aVGraphics
p21607
aVTranslateTransform to eliminate the cheat
p21608
as(dp21609
g9
V17034
p21610
stp21611
a((dp21612
g2
(lp21613
VThis was discussed before
p21614
aVYour case is much easier though, you are also implementing the finalizer
p21615
aVThat's fundamentally wrong, you are hiding a bug in the client code
p21616
aVBeware that finalizers run on a separate thread
p21617
aVDebugging a consistent deadlock is much easier than dealing with locks that disappear randomly and asynchronously
p21618
aVRecommendation: follow the
p21619
aVNET framework lead: don't help too much
p21620
aVMicrosoft abandoned the Synchronized method for the same reason
p21621
as(dp21622
g9
V17034
p21623
stp21624
a((dp21625
g2
(lp21626
VThis code showed all settings that have a description:
p21627
as(dp21628
g9
V17034
p21629
stp21630
a((dp21631
g2
(lp21632
VThe ultimate mystery is still where 12 50 is coming from
p21633
aVThey are the ASCII codes for Ctrl+R, P
p21634
aVWhich happens to be the secret keystrokes you have to type to enter the validation code for QuickBooks
p21635
aVLink: Where to enter Validation code
p21636
aVQuite a coincidence
p21637
aVI wonder what happens when you type these keys in the wrong place
p21638
as(dp21639
g9
V17034
p21640
stp21641
a((dp21642
g2
(lp21643
VNo cando
p21644
aVAt best you can flush the undo stack completely by sending EM_SETUNDOLIMIT twice
p21645
aVEM_SETTEXTEX offers the same option with the ST_DEFAULT flag
p21646
aVSurely not what you want
p21647
aVLook at ScintillaNET for a real editor
p21648
as(dp21649
g9
V17034
p21650
stp21651
a((dp21652
g2
(lp21653
VWhat you're doing is fine
p21654
aVOld tricks like SetROP2() don't work anymore with text getting anti-aliased, especially with ClearType rendering
p21655
aVGetting the aliasing pixels with the wrong color is very noticeable
p21656
aVGraphics
p21657
aVCompositingMode accordingly doesn't support the effects anymore
p21658
as(dp21659
g9
V17034
p21660
stp21661
a((dp21662
g2
(lp21663
VYes, the Microsoft Chart controls
p21664
as(dp21665
g9
V17034
p21666
stp21667
a((dp21668
g2
(lp21669
VYou can do this by having your app's main form implement the IMessageFilter interface
p21670
aVYou can screen the Window messages it gets and look for clicks
p21671
aVFor example:
p21672
aVNote that this logs all clicks in any window of your app
p21673
as(dp21674
g9
V17034
p21675
stp21676
a((dp21677
g2
(lp21678
VDirectoryNotFoundException is a bug in your code, you are doing something wrong with the path you pass
p21679
aVUnauthorizedAccessException is common enough, some directories you cannot read, not even with administrator privileges
p21680
aVc:\u005csystem volume information is an example, it stores restore point data, hidden from everyone
p21681
aVPay attention to DirectoryInfo
p21682
aVAttributes
p21683
aVAvoid recursing into any directory that has the System and Hidden attributes
p21684
aVThat will avoid the vast majority of security exceptions
p21685
aVThe rest requires GetAccessControl() to check the ACL and verify that the user has read access
p21686
aVThe quick fix for awkward code like that is catching the exception
p21687
as(dp21688
g9
V17034
p21689
stp21690
a((dp21691
g2
(lp21692
VAs long as you only use it on dictionaries of object, you can constrain T to be a reference type to make the cast valid:
p21693
aVBut that's probably not what you want
p21694
aVNote that C# version 4 doesn't solve your problem either
p21695
as(dp21696
g9
V17034
p21697
stp21698
a((dp21699
g2
(lp21700
VThe primary job of XML documentation is not to generate documentation
p21701
aVIt is to provide good IntelliSense info for the client of your class
p21702
aVShip the generated
p21703
aVxml file along with your assembly
p21704
as(dp21705
g9
V17034
p21706
stp21707
a((dp21708
g2
(lp21709
VNo, there's a chicken-and-egg problem here
p21710
aVIn order to find the attributes you applied, the designer has to use Reflection to load the Type
p21711
aVLoading the type requires any types used by its members to be loaded as well
p21712
aVWhich will cause the CLR to go hunting for your mytools
p21713
aVdll assembly
p21714
aVThe probing path in effect at design time is the one for Visual Studio, not your app's
p21715
aVWhat exactly that path looks like is murky to me
p21716
aVThe toolbox plays a role as well
p21717
aVIt makes a copy of the assembly that contains the control in a private directory
p21718
aVThe place to look is c:\u005cusers\u005cyourname\u005cappdata\u005clocal\u005cmicrosoft\u005cvisualstudio\u005c9
p21719
aV0\u005cprojectassemblies
p21720
aVThis often goes wrong and stray copies are left behind in that directory
p21721
aVI have to clean it out by hand from time to time when I notice that toolbox initialization starts to get slow
p21722
aVWell, something you can check to see if a copy of mytools
p21723
aVdll is present there as well and isn't an old version
p21724
aVPutting it the GAC is one way to stay out of trouble
p21725
as(dp21726
g9
V17034
p21727
stp21728
a((dp21729
g2
(lp21730
VThe VB declaration dates back to VB6, it is quite inappropriate for a
p21731
aVNET language
p21732
aVAlthough the P/Invoke marshaller will allow unmanaged code scribbling into a string, it causes random failure due to string interning
p21733
aVYou also really want to use the Unicode version so you don't get unexpected character translation
p21734
aVAnd you want to do something meaningful if the function fails
p21735
aVHere's my version:
p21736
as(dp21737
g9
V17034
p21738
stp21739
a((dp21740
g2
(lp21741
VYou are relying on the key auto-repeating to keep the piece moving
p21742
aVThat's not appropriate, the user's keyboard repeat delay is variable and will affect the playability of the game
p21743
aVAnd as you found out, it stops auto-repeating when another key is pressed
p21744
aVFix this by giving each game object as motion status
p21745
aVUse the KeyDown event to change it
p21746
aVAnd the KeyUp event to reset it, if the motion status value still matches the key
p21747
aVIn your game loop, update the game object positions based on their motion status
p21748
aVYou'd do so at a fixed rate, triggered by a timer
p21749
aVThe motion status should also indicate "falling down"
p21750
aVYou can now simply make the game more difficult as the levels progress by reducing the timer rate
p21751
aVPieces fall down quicker
p21752
aVAnd the keyboard becomes more responsive, giving the user a chance to still win a level
p21753
as(dp21754
g9
V17034
p21755
stp21756
a((dp21757
g2
(lp21758
VIt does, System
p21759
aVRuntime
p21760
aVInteropServices
p21761
aVComTypes
p21762
aVIStream
p21763
aVA sample wrapper:
p21764
as(dp21765
g9
V17034
p21766
stp21767
a((dp21768
g2
(lp21769
VThe behavior of the ThreadPool manager matters
p21770
aVIt tries to carefully avoid scheduling more threads than you have cores
p21771
aVSo if your XP machine has a single-core CPU, it will only allow one thread to run
p21772
aVOnly when threads get "stuck" and do not complete in a timely manner will it allow another thread to start
p21773
aVThese scheduling decisions are made twice a second
p21774
aVGiven that you are using threads to play sounds, a thread pool thread is not the appropriate solution
p21775
aVYou should create your own Thread
p21776
as(dp21777
g9
V17034
p21778
stp21779
a((dp21780
g2
(lp21781
VThe default ILMerge install path isn't relative to anything
p21782
aVIf you want to add it to the PATH environment variable then write this in your postbuild event:
p21783
as(dp21784
g9
V17034
p21785
stp21786
a((dp21787
g2
(lp21788
VYes, it is a fundamental property of Windows
p21789
aVWhen an executable file gets loaded (EXE or DLL), Windows creates a memory mapped view of the file
p21790
aVChunks of code or data from the executable file get page-faulted into RAM, as needed to keep the program running
p21791
aVIt works the other way around too, when Windows needs to make RAM available for another program then it throws chunks of mapped pages away, the ones that weren't used in a while
p21792
aVThose pages don't take up space in the paging file if they are code, they can be reloaded from the executable file
p21793
aVVery efficient, code that was written when 16 megabytes of RAM was a luxury
p21794
aVThe memory mapped section keeps a write lock on the file
p21795
aVStill useful in this day and age, it prevents some kind of malware with fecking with the code of a running process
p21796
as(dp21797
g9
V17034
p21798
stp21799
a((dp21800
g2
(lp21801
VI would have to recommend you try this for yourself
p21802
aVThis code takes a fraction of second in the Release build:
p21803
aVI trust it will repro well
p21804
as(dp21805
g9
V17034
p21806
stp21807
a((dp21808
g2
(lp21809
Vit is unusual, but you can easily override your Complex class's ToString method
p21810
aVFor example:
p21811
aVSample usage:
p21812
aVOutput:
p21813
aVTweak as necessary
p21814
as(dp21815
g9
V17034
p21816
stp21817
a((dp21818
g2
(lp21819
VThis is almost certainly a wasted effort
p21820
aVThe XML needs to come from somewhere, a file on disk on a network card
p21821
aVI/O operations are orders of magnitude slower than whatever you'd do to get the reader class instantiated
p21822
aVThe typical trap is that you run a test program to profile the code using the same data over and over again
p21823
aVIt is not a realistic test, you'll retrieve the XML from a cached copy, the file system cache for example
p21824
aVThat's very fast, it runs at bus speeds
p21825
aVThat doesn't work that way in a production machine, the data is almost certainly not yet cached
p21826
aVIt needs to be read from the disk for example
p21827
aVThat's very slow
p21828
as(dp21829
g9
V17034
p21830
stp21831
a((dp21832
g2
(lp21833
VMarshaling a call from one thread to another is a considerable trick
p21834
aVWhat is required is a mechanism that ensures that the target thread is idle and can run execution requests without any danger of nasty re-entrancy problems
p21835
aVThe SynchronizationContext class is the base class for such a mechanism
p21836
aVIts default implementation doesn't actually synchronize anything, it runs the delegate target on a threadpool thread
p21837
aVWindows Forms provides a class that does what you are looking for, the WindowsFormsSynchronizationContext class
p21838
aVIt relies on the message loop in the Application class to provide the synchronization
p21839
aVAn instance of this class gets automatically installed, the Application
p21840
aVRun() method takes care of it
p21841
aVWPF has one as well, DispatcherSynchronizationContext
p21842
aVProblem is: you never called Application
p21843
aVRun() and you're not running a message loop
p21844
aVThe required plumbing is missing
p21845
aVYou cannot get what you want without that message loop
p21846
as(dp21847
g9
V17034
p21848
stp21849
a((dp21850
g2
(lp21851
VThe DebuggerDisplay attribute is your problem, your class inherits one specified on the Collection(Of T) base class
p21852
aVGetting it to start using your ToString() override again is simple, just make it look like this:
p21853
as(dp21854
g9
V17034
p21855
stp21856
a((dp21857
g2
(lp21858
VThe TrackBar control is a wrapper around the native Windows Trackbar control
p21859
aVYou won't find any relevant code
p21860
aVThis is almost certainly controlled by WM_MOUSEMOVE messages, if you move the mouse fast, it skips reporting back some intermediate positions
p21861
aVYour custom control should therefore act exactly like TrackBar
p21862
as(dp21863
g9
V17034
p21864
stp21865
a((dp21866
g2
(lp21867
VProvider=Microsoft
p21868
aVSQLSERVER
p21869
aVCE
p21870
aVOLEDB
p21871
ag2586
aV5;Data Source=c:\u005ctest
p21872
aVsdf;
p21873
aVVerify that you have the provider available
p21874
aVStart Regedit
p21875
aVexe, open the HKEY_CLASSES_ROOT node, scroll down and verify that you see the Microsoft
p21876
aVSQLSERVER
p21877
aVCE
p21878
aVOLEDB
p21879
ag2586
aV5 key
p21880
aVIf it is not there, you have to install it
p21881
aVDownload link
p21882
as(dp21883
g9
V17034
p21884
stp21885
a((dp21886
g2
(lp21887
VThere's a lot of stuff going on after you assigned the Text property
p21888
aVThe label will not visually update until the Click event handler is done executing
p21889
aVIt's Paint event cannot run until the UI thread goes idle again
p21890
aVYou can force it to paint right away by calling the strip's Update() method:
p21891
as(dp21892
g9
V17034
p21893
stp21894
a((dp21895
g2
(lp21896
VVisual Assist ought to help
p21897
as(dp21898
g9
V17034
p21899
stp21900
a((dp21901
g2
(lp21902
VThere's a simple solution, don't change your [AssemblyVersion], only your [AssemblyFileVersion]
p21903
aVTo make that meaningful, it is certainly better to move the classes that both the plug-in and the host need to a separate assembly
p21904
aVNow, when you make a breaking change in one of those classes, you can change the [AssemblyVersion] to force the plug-in to be recompiled
p21905
aVWhich is now a Good Thing instead of a problem
p21906
as(dp21907
g9
V17034
p21908
stp21909
a((dp21910
g2
(lp21911
VYou could take advantage of the SetDllDirectory API function, it alters the search path for unmanaged assemblies
p21912
aVStore your 32-bit DLLs in the x86 subdirectory of the app install directory, the 64-bit DLLs in the x64 subdirectory
p21913
aVRun this code at app startup before you do any P/Invoke:
p21914
as(dp21915
g9
V17034
p21916
stp21917
a((dp21918
g2
(lp21919
VWindows doesn't support it
p21920
aVBut you easily add it yourself
p21921
aVWhen you gain write access to the file, write another hidden file with the user name (Environment
p21922
aVUserName) in the same directory (like ~originalname
p21923
aVusername)
p21924
aVWhen you fail to gain write access, try to open that file to read the user name
p21925
aVSleep for a second if that fails
p21926
as(dp21927
g9
V17034
p21928
stp21929
a((dp21930
g2
(lp21931
VYou already got the Method property
p21932
aVYou'll need the Target property to pass as the 1st argument to MethodInfo
p21933
aVInvoke()
p21934
as(dp21935
g9
V17034
p21936
stp21937
a((dp21938
g2
(lp21939
VI'm probably missing something, but I can't make sense of using an attribute here
p21940
aVYou might as well have written it like this:
p21941
aVA whole heckofalot faster too
p21942
aVAnd safer, you're dead in the water when the JIT compiler inlines SetupSomething()
p21943
as(dp21944
g9
V17034
p21945
stp21946
a((dp21947
g2
(lp21948
VIt's too late, the 8th digit was lost in the compiler
p21949
aVThe float type can store only 7 significant digits
p21950
aVYou'll have to rewrite the code, assigning to double or decimal will of course solve the problem
p21951
as(dp21952
g9
V17034
p21953
stp21954
a((dp21955
g2
(lp21956
VBinary serialization is pretty powerful, it can create an instance of a class without running the constructor and can set fields in your class that you declared private
p21957
aVRegular code can of course not do this
p21958
aVBy applying the [Serializable] attribute, you explicitly give it the go-ahead to mess with your private parts
p21959
aVAnd you implicitly give that permission to only the BinaryFormatter class
p21960
aVXML serialization doesn't need this kind of okay, it only serializes members that are public
p21961
aVDataContractSerializer can serialize private members as well
p21962
aVIt therefore needs an explicit okay again, now with the [DataContract] attribute
p21963
as(dp21964
g9
V17034
p21965
stp21966
a((dp21967
g2
(lp21968
VThe P/Invoke marshaller already does this, you don't have to help
p21969
aVJust declare the function argument as an array:
p21970
aVJust in case: although you don't have to use the unsafe keyword here, there isn't anything safe about it
p21971
aVThe C code can easily corrupt the heap when it writes past the end of the block you allocated
p21972
as(dp21973
g9
V17034
p21974
stp21975
a((dp21976
g2
(lp21977
VIf the files are relatively small (say, ~10 megabytes), you'll only need two lines of code:
p21978
as(dp21979
g9
V17034
p21980
stp21981
a((dp21982
g2
(lp21983
VTake a look at the Shell_NotifyIcon() API method, the one that implements a NotifyIcon
p21984
aVClick through to the NOTIFYICONDATA structure
p21985
aVThe second member of that structure is a window handle:
p21986
aVA handle to the window that receives
p21987
aVnotifications associated with an icon
p21988
aVin the notification area
p21989
aVYou don't have a window and can therefore not receive notifications
p21990
aVYou must put the NotifyIcon on a Form
p21991
aVAnd use Application
p21992
aVRun() to get the notifications and activate the event handlers
p21993
aVKeep your form hidden by pasting this code:
p21994
as(dp21995
g9
V17034
p21996
stp21997
a((dp21998
g2
(lp21999
VThis is a pretty fundamental issue with
p22000
aVNET programming, every programmer falls for it at least once
p22001
aVThe PrintableArea property type is RectangleF
p22002
aVThat's a structure, a value type
p22003
aVWhen you use the property, you get back a copy of the value
p22004
aVThe compiler will notice that you are trying to modify a member of the copy, like when you try to assign the Height property
p22005
aVBut it gets noddy when you use the Inflate() method
p22006
aVYou are inflating the copy, not the original value and the compiler isn't smart enough to notice
p22007
aVKey problem here is that the PrintableArea property only has a getter, it doesn't have a setter
p22008
aVWhich means that you can't change it
p22009
aVWhich makes sense if you think about it, you can't change the size of the piece of paper nor change the design of the printer
p22010
aVYou probably want to use the Margins property
p22011
as(dp22012
g9
V17034
p22013
stp22014
a((dp22015
g2
(lp22016
VGuessing at Windows Forms: HatchBrush is probably your best bet
p22017
aVTextureBrush is the most flexible
p22018
as(dp22019
g9
V17034
p22020
stp22021
a((dp22022
g2
(lp22023
VYes, the DES class is an abstract base class, DESCryptoServiceProvider is a concrete implementation for it
p22024
aVThe inheritance chain is a bit boring, it is the only one
p22025
aVMost cryptography classes follow this pattern
p22026
aVIt is documented as follows:
p22027
aVThe
p22028
aVNET Framework security system
p22029
aVimplements an extensible pattern of
p22030
aVderived class inheritance
p22031
aVThe
p22032
aVhierarchy is as follows:
p22033
aVAlgorithm type class, such as SymmetricAlgorithm or HashAlgorithm
p22034
aVThis level is abstract
p22035
aVAlgorithm class that inherits from an algorithm type class; for example,
p22036
aVRC2 or SHA1
p22037
aVThis level is abstract
p22038
aVImplementation of an algorithm class that inherits from an algorithm
p22039
aVclass; for example,
p22040
aVRC2CryptoServiceProvider or
p22041
aVSHA1Managed
p22042
aVThis level is fully
p22043
aVimplemented
p22044
aVUsing this pattern of derived classes,
p22045
aVit is easy to add a new algorithm or a
p22046
aVnew implementation of an existing
p22047
aValgorithm
p22048
aVFor example, to create a
p22049
aVnew public-key algorithm, you would
p22050
aVinherit from the AsymmetricAlgorithm
p22051
aVclass
p22052
aVTo create a new implementation
p22053
aVof a specific algorithm, you would
p22054
aVcreate a nonabstract derived class of
p22055
aVthat algorithm
p22056
aVNot so sure how often somebody actually adds a new public key algorithm
p22057
as(dp22058
g9
V17034
p22059
stp22060
a((dp22061
g2
(lp22062
VMessageBox itself pumps a message loop
p22063
aVThat of course won't be the Windows Forms message loop
p22064
aVEverything runs as normal, but minus the dispatching of delegate invocation requests posted by Control
p22065
aVBeginInvoke()
p22066
aVOnly the Windows Forms message loop can do that
p22067
aVThis happens when the MessageBox
p22068
aVShow() call is made on the UI thread
p22069
aVBut not when it is made on a worker thread, message queues are a per-thread property
p22070
aVIf you can get the Show call to be delegated to a worker, you probably solve your problem
p22071
aVAddressing your questions:
p22072
aVYou really want the opposite: the worker threads should block
p22073
aVNot blocking can cause major problems, the BeginInvoke dispatch queue will fill up without bounds
p22074
aVOne possible trick is to count the number of BeginInvoke calls, count down in the delegate target
p22075
aVUse the Interlocked class
p22076
aVThe execution order of BeginInvoke targets is guaranteed
p22077
aVThe real problem is probably related to having worker threads getting out of sync
p22078
aVShow the message box on a thread
p22079
as(dp22080
g9
V17034
p22081
stp22082
a((dp22083
g2
(lp22084
VIt is not a property, it is a field
p22085
aVThis works:
p22086
aVDon't use it
p22087
as(dp22088
g9
V17034
p22089
stp22090
a((dp22091
g2
(lp22092
VReading the MSDN Library with a browser is self-inflicted punishment
p22093
aVDownload and install it on your own machine so that navigating to the details of a class member is instant
p22094
aVThe index you'll get is very useful as well
p22095
as(dp22096
g9
V17034
p22097
stp22098
a((dp22099
g2
(lp22100
VWell, this is indeed tricky
p22101
aVThe dropdown listbox gets created dynamically when the user clicks the arrow
p22102
aVIt is an entirely unmanaged window, Windows Forms doesn't wrap it
p22103
aVWhat you need to do is send the CB_GETCOMBOBOXINFO message in an override for ComboBox
p22104
aVOnDropDown to get the window handle, it is return in the COMBOBOXINFO
p22105
aVhwndList
p22106
aVFrom there, I'd have to assume you already have the P/Invoke to skin the scrollbar of a ListBox
p22107
aVPart of the code you'll need you'll find in my post in this thread
p22108
as(dp22109
g9
V17034
p22110
stp22111
a((dp22112
g2
(lp22113
VIs it not abnormal, when you have 20 different rules for 20 controls
p22114
aVLots of things you can do to DRY this out
p22115
aVIf rules are the same for several controls, give those controls the same Validating event handler
p22116
aVIf you have just a few rules, you could create your own control class by deriving from the base and bake-in the rule by overriding OnValidating
p22117
aVOr you could override the form's ValidatingChildren method and validate everything in one method
p22118
as(dp22119
g9
V17034
p22120
stp22121
a((dp22122
g2
(lp22123
VYou can handle this by using the FileMode
p22124
aVCreateNew argument to the stream constructor
p22125
aVOne of the threads is going to lose and find out that the file was already created a microsecond earlier by another thread
p22126
aVAnd will get an IOException
p22127
aVIt will then need to spin, waiting for the file to be fully created
p22128
aVWhich you enforce with FileShare
p22129
aVNone
p22130
aVCatching exceptions here doesn't matter, it is spinning anyway
p22131
aVThere's no other workaround for it anyway unless you P/Invoke
p22132
as(dp22133
g9
V17034
p22134
stp22135
a((dp22136
g2
(lp22137
VRight-shifting an integral value by one is equivalent to dividing it by 2
p22138
aVTwo shifts equivalent to dividing by 4
p22139
aVEtcetera
p22140
aVWhich makes the expression equivalent to:
p22141
as(dp22142
g9
V17034
p22143
stp22144
a((dp22145
g2
(lp22146
VThere are a lot of details to get right
p22147
aVBest thing to do is to use ATL and the built-in ATL object wizard
p22148
aVIt auto-generates a bunch of files so that the IDL, type library, registration script, class wrapper and event proxies are all done correctly
p22149
as(dp22150
g9
V17034
p22151
stp22152
a((dp22153
g2
(lp22154
VAdd this line of code to the Click event handler:
p22155
as(dp22156
g9
V17034
p22157
stp22158
a((dp22159
g2
(lp22160
VYou are correct
p22161
aVAnything is possible of course, but it won't be nearly as convenient or easy to maintain
p22162
aVIt doesn't sound like a satellite assembly would fly here
p22163
aVAn application setting is about the easiest
p22164
aVA good way to keep requests like these at bay is to quote an accurate price that includes the hassle of maintaining this for the next N years
p22165
as(dp22166
g9
V17034
p22167
stp22168
a((dp22169
g2
(lp22170
VThe
p22171
aVNET runtime is already very good at throwing these exceptions
p22172
aVThey are also highly descriptive of what is wrong, you can't add any good commentary to the exception message
p22173
aV"You can't divide by zero" adds no value
p22174
aVHowever, you can avoid many of these exceptions by screening the values passed by the client code
p22175
aVYou'll want ArgumentNullException with the name of argument if the client code passed a null, ArgumentException when it passed something that is liable to trip DivideByZero
p22176
as(dp22177
g9
V17034
p22178
stp22179
a((dp22180
g2
(lp22181
VYes, there's an EXIF tag that can store the orientation
p22182
aVTag number 274, values are documented here
p22183
aVSample code to read the tags from the JPEG data is available here
p22184
as(dp22185
g9
V17034
p22186
stp22187
a((dp22188
g2
(lp22189
VIt's a bit of a mystery but it works if you use ModifyMenu or DeleteMenu:
p22190
aVor:
p22191
as(dp22192
g9
V17034
p22193
stp22194
a((dp22195
g2
(lp22196
VNo repro, the
p22197
aVlib file has the correct DLL name
p22198
aVThe original name is not present at all
p22199
aVBut, don't make the same mistake I first made
p22200
aVUse cba
p22201
aVlib, not abc
p22202
aVlib
p22203
as(dp22204
g9
V17034
p22205
stp22206
a((dp22207
g2
(lp22208
VIt already means that without the extern keyword
p22209
aVFunctions have external linkage by default, unless you declare them static
p22210
aVUsing function prototypes is okay but it is easy get it wrong
p22211
aVThe linker error you'll get isn't that easy to diagnose when you redefine the function implementation
p22212
aVThe linker doesn't know where to look, it is your job to give it an object file that contains the function definition to keep it happy
p22213
as(dp22214
g9
V17034
p22215
stp22216
a((dp22217
g2
(lp22218
VAssuming you are running on a mainstream operating system
p22219
aVYou'll need help from the operating system to find out which addresses in your virtual memory space have mapped pages
p22220
aVFor example, on Windows you'd use VirtualQueryEx()
p22221
aVThe memory dump you'll get can be as large as two gigabytes, it isn't that likely you discover anything recognizable quickly
p22222
aVYour debugger already allows you to inspect memory at arbitrary addresses
p22223
as(dp22224
g9
V17034
p22225
stp22226
a((dp22227
g2
(lp22228
VThere is one path that you can always reliably find, no matter how your program got deployed to the target machine: the directory in which your
p22229
aVexe is stored
p22230
aVTake advantage of this, put the
p22231
aVbmp file in the same directory
p22232
aVOr a subdirectory of the install directory
p22233
aVYou didn't say what kind of program you wrote, it is easy with Application
p22234
aVExecutablePath in Windows Forms
p22235
aVBut the generic solution that works everywhere:
p22236
aVWhich assumes the images are stored in a subdirectory named "images"
p22237
aVTweak as necessary
p22238
aVLast but not least: don't forget that you can add images to your program's resources so it is baked in the
p22239
aVexe file
p22240
aVProject + Properties, Resources tab
p22241
aVHighly recommended
p22242
as(dp22243
g9
V17034
p22244
stp22245
a((dp22246
g2
(lp22247
VThis is just not the way serial ports work
p22248
aVIt is not a bus, like USB or PCI, where you can plug something in and the operating system will do the ah-ha, new hardware
p22249
aVdiscovery automatically
p22250
aVSerial ports are very primitive, dating from the stone age of computer hardware
p22251
aVIt takes a human to plug a serial port device connector
p22252
aVWith some luck, the connector will have a label which says what COM port number is assigned to the connector
p22253
aVAlthough that luck is hard to come by these days
p22254
aVShe'll then tell a program to establish a connection on that particular COM port
p22255
aVHyperterminal is the canonical implementation of such a program on Windows
p22256
aVYou cannot realistically open every COM port that might be available
p22257
aVThat prevents another program from using another COM port
p22258
aVYou'll prevent a modem from getting used for example
p22259
aVPart of the stone age legacy is that only one program can open a COM port, every other program will be locked out
p22260
aVSo, provide your program with a UI that lets the user select the COM port(s)
p22261
aVSave the selection in your config data, it is very likely that the device is still connected to the same port when it starts back up
p22262
aVYou can use WMI and the Win32_SerialPort class to provide a better description for the COM port (more than just the number)
p22263
aVSome USB serial port emulators may set the Description property to something recognizable
p22264
aVSerialPort
p22265
aVGetPortNames() enumerates the available COM port numbers
p22266
aVA basic sanity test is to check the SerialPort
p22267
aVDsrHolding property, it should be true when the serial port device is plugged in and powered-up
p22268
as(dp22269
g9
V17034
p22270
stp22271
a((dp22272
g2
(lp22273
VYour CharSet property on the [DllImport] attribute is definitely wrong, you need CharSet
p22274
aVAnsi to get the P/Invoke marshaller to convert it to a char[]
p22275
aVDeclare the buff member as a string for easier usage
p22276
aVWhile declaring the fid member as a byte[] isn't wrong, I really don't see the point of it
p22277
aVThat the unmanaged code copies a char[] into it is an implementation detail
p22278
aVThus:
p22279
as(dp22280
g9
V17034
p22281
stp22282
a((dp22283
g2
(lp22284
VIt is an odd quirk in the C language, structure tag names are stored in a different namespace (symbol table)
p22285
aVThe C++ language got rid of this behavior
p22286
aVThe typedef creates an alias for the structure type in the global namespace
p22287
aVSo you don't have to type "struct" before the structure name
p22288
aVNot sure what Ritchie was smoking when he defined this behavior
p22289
aVI'm guessing at some kind of problem with the parser in an early version of the compiler
p22290
as(dp22291
g9
V17034
p22292
stp22293
a((dp22294
g2
(lp22295
VThere's an instance of the ClassLoader class associated with each assembly
p22296
aVIt loads types from the assembly
p22297
aVIt has a bunch of debug fields that are only present when the CLR is built in Debug mode
p22298
aVThe pointer to the ClassLoader instance is no doubt listed to help a Microsoft tester find that debug data back
p22299
aVIt isn't going to be very interesting the retail build
p22300
aVYou can find the source code for this in the SSCLI20 distribution
p22301
aVThe class loader is declared in clr\u005csrc\u005cvm\u005cclsload
p22302
aVhpp
p22303
aVIn case it matters: it has nothing to do with the Java notion of a class loader
p22304
as(dp22305
g9
V17034
p22306
stp22307
a((dp22308
g2
(lp22309
VIt doesn't take a lot of surgery to turn on Windows Visual Styles and get an instant new look
p22310
aVIf your toolset doesn't allow creating resources then take a look at mt
p22311
aVexe in the Windows SDK
p22312
as(dp22313
g9
V17034
p22314
stp22315
a((dp22316
g2
(lp22317
VYes, you are passing an unmanaged structure by reference
p22318
aVThat's a problem for a C# program, pointers are quite incompatible with garbage collection
p22319
aVNot counting the fact that it probably doesn't have the declaration for the structure either
p22320
aVYou can solve it by declaring a managed version of the structure:
p22321
aVNow you can declare the method as
p22322
aVor
p22323
aVPick the latter if the structure has more than 4 fields (~16 bytes)
p22324
aVThe method needs to copy the structure members, one-by-one, into an unmanaged api_struct and call the unmanaged class method
p22325
aVThis is unfortunately necessary because the memory layout of a managed structure is not predictable
p22326
aVThis is all pretty mechanical, you might get help from SWIG
p22327
aVHaven't used it myself, not sure if it is smart enough to deal with a passed structure
p22328
aVA completely different approach is to make the wrapper class cleaner by giving it a constructor and/or properties that lets you build the content of an api_struct
p22329
aVOr you could declare a wrapper ref class for the structure, much like you would in managed code
p22330
as(dp22331
g9
V17034
p22332
stp22333
a((dp22334
g2
(lp22335
VYou can use dumpbin
p22336
aVexe /symbols on the
p22337
aVlib file
p22338
aVThat lists all the symbols used, the external ones have the "External" prefix
p22339
as(dp22340
g9
V17034
p22341
stp22342
a((dp22343
g2
(lp22344
VIt already outputs the source code file name in the Output window
p22345
aVIf you also want to see which #include file it is processing then use Project + Properties, C/C++, Advanced, Show Includes = Yes
p22346
as(dp22347
g9
V17034
p22348
stp22349
a((dp22350
g2
(lp22351
VThe default protection level for I/O ports in Windows prevents a user-mode program from using inp and out instructions on any port
p22352
aVYour program will die with a GPF
p22353
aVThere are several freely available drivers around that change that protection level so that ring 3 code can access the ports
p22354
aVWhich is okay if you're interested in killer pokes
p22355
aVThe canonical one is inpout32
p22356
as(dp22357
g9
V17034
p22358
stp22359
a((dp22360
g2
(lp22361
VFwiw, there is an expression parser built into the
p22362
aVNET framework
p22363
aVThe DataTable
p22364
aVCompute() method uses it:
p22365
aVBeware however that it isn't a very full-featured one
p22366
aVSimple expressions only, the kind you'd find in a SQL query
p22367
as(dp22368
g9
V17034
p22369
stp22370
a((dp22371
g2
(lp22372
VReflection can only provide type information from the assembly metadata
p22373
aVGetting the address requires the
p22374
aVpdb debugging file and the address of the function in memory, as compiled by the JIT compiler
p22375
aVYou can't get the address without the StackFrame
p22376
aVGetNativeOffset() method or the debugger interfaces, assuming the method is even compiled
p22377
aVThe latter approach can't work in-process, a program cannot debug itself
p22378
aVThe CLR doesn't have any trouble because it can retrieve the method address from the stack frames when it processes the exception
p22379
aVThat's still an imperfect art, it cannot see addresses of methods that were inlined
p22380
aVHaving those stack frames is the required first step
p22381
as(dp22382
g9
V17034
p22383
stp22384
a((dp22385
g2
(lp22386
VSounds like you are somehow triggering scaling, as selected by the AutoScaleMode property of the form
p22387
aVThe difference between your two projects would be the AutoScaleDimensions property, visible in the Designer
p22388
aVcs file
p22389
aVNot sure why this would cause a problem, but the Form class already uses GetWindowPlacement() internally, RecreateHandleCore() and UpdateWindowState() methods
p22390
aVTo get real help, I assume you'll need to post a repro project somewhere
p22391
as(dp22392
g9
V17034
p22393
stp22394
a((dp22395
g2
(lp22396
VFrom chapter 7
p22397
aV13 of the C# Language Specification:
p22398
aVThe second and third operands of the
p22399
aV: operator control the type of the conditional expression
p22400
aVLet X and Y be the types of the second and third operands
p22401
aVThen,
p22402
aVIf X and Y are the same type, then this is the type of the conditional expression
p22403
aVOtherwise, if an implicit conversion (6
p22404
aV1) exists from X to Y, but not from Y to X, then Y is the type of the conditional expression
p22405
aVOtherwise, if an implicit conversion (6
p22406
aV1) exists from Y to X, but not from X to Y, then X is the type of the conditional expression
p22407
aVOtherwise, no expression type can be determined, and a compile-time error occurs
p22408
aVIn your case, there is no implicit conversion from int to null nor the other way around
p22409
aVYour cast solves the problem, int is convertible to int
p22410
as(dp22411
g9
V17034
p22412
stp22413
a((dp22414
g2
(lp22415
VNo, it is history
p22416
aVGDI+ was written quite a while before
p22417
aVNET ever came around
p22418
aVThe SDK wrapper for it was written in C++
p22419
aVExceptions are iffy in C++, not everybody buys into them
p22420
aVGoogle doesn't for example
p22421
aVSo to keep it compatible it reports problems with error codes
p22422
aVThat just never scales well, library programmers make it a goal to intentionally limit the number of possible error codes, it lessen the burden on the client programmer having to report them
p22423
aVGDI+ has this problem in spades, it defines only 20 error codes
p22424
aVThat is not much for such a large chunk of code with so many external dependencies
p22425
aVWhich in itself is a problem, there are a gazillion ways to mess up an image file
p22426
aVNo way that a library's error reporting can be fine-grained enough to cover them all
p22427
aVThe fact that these error codes were picked long before
p22428
aVNET defined standard Exception derived types certainly didn't help
p22429
aVThe Status::OutOfMemory error code got overloaded to mean different things
p22430
aVSometimes it really does mean out of memory, it can't allocate enough space to store the bitmap bits
p22431
aVSadly, an image file format problem is reported by the same error code
p22432
aVThe friction here is that it cannot possibly decide if the width * height * pixels it read from the image file is a problem because there isn't enough storage available for the bitmap
p22433
aVOr if the data in the image file is junk
p22434
aVIt assumes that image file is not junk, fair call, that's another program's problem
p22435
aVSo OOM is what it reports
p22436
aVFor completeness, these are the error codes:
p22437
as(dp22438
g9
V17034
p22439
stp22440
a((dp22441
g2
(lp22442
VIt doesn't get distributed with Windows, you'll have to deploy it yourself
p22443
aVYes, Microsoft will update it when it contains a critical security flaw
p22444
aVLike the one you linked to
p22445
aVYou'll want this one
p22446
aVYou'll need the x64 version if you built your program with the x64 compiler
p22447
aVHmm, reminds me of another thread
p22448
as(dp22449
g9
V17034
p22450
stp22451
a((dp22452
g2
(lp22453
VWhile it might look like the code is compiled in-memory (CompilerParameters
p22454
aVGenerateInMemory), that's not what actually happens
p22455
aVThe same compiler as the one used in Visual Studio is used to compile the code (csc
p22456
aVexe)
p22457
aVIt gets started by CreateProcess (much like Process
p22458
aVStart) and runs out-of-process to compile the code to an assembly on disk in a temporary folder
p22459
aVThe GenerateInMemory option invokes Assembly
p22460
aVLoadFrom() to load the assembly
p22461
aVYou'll get the equivalent of a syntax check simply by setting GenerateInMemory to false and delete the OutputAssembly after it is done
p22462
aVWhile this might sound kinda backwards, the huge benefit it has is that this won't put any memory pressure on your process
p22463
aVThis will hold you over until C# 5
p22464
aV0 ships
p22465
as(dp22466
g9
V17034
p22467
stp22468
a((dp22469
g2
(lp22470
VIt is rather strange that this isn't wrapped by the
p22471
aVNET framework
p22472
aVThe necessary fusion declarations are readily available
p22473
aVThis code worked well:
p22474
aVDon't forget to press F5 in the Explorer window to refresh the view if you are adding and removing assemblies with this code
p22475
as(dp22476
g9
V17034
p22477
stp22478
a((dp22479
g2
(lp22480
VThis is a highly variable number, you cannot calculate it
p22481
aVThe Windows memory manager constantly swaps pages in and out of RAM
p22482
aVTaskMgr
p22483
aVexe gets it from a performance counter
p22484
aVYou can get the same number like this:
p22485
aVDo beware that the number really doesn't mean much, it will drop when other processes get started and compete for RAM
p22486
as(dp22487
g9
V17034
p22488
stp22489
a((dp22490
g2
(lp22491
VWell, you know it is possible, SysInternals' Handle utility does it
p22492
aVNtQueryInformation isn't going to be phased out, it is an essential low-level interface between Win32 and the "real" operating system
p22493
aVWhat is however never going to happen is that the NtQueryInformation arguments that allow iterating handles is going to be documented
p22494
aVBecause it doesn't stop just there, some muppet is going to use it to call CloseHandle() on a file that s/he doesn't want to be locked
p22495
aVWhich is a very good way to destroy your hard disk content
p22496
aVThe process that owned the handle doesn't know the handle is closed
p22497
aVIt will just keep writing to it, probably completely ignoring the "it didn't work" return code from WriteFile()
p22498
aVWhich is harmless until the program opens another handle, getting the same value back as the one that was closed earlier
p22499
aVNow it starts writing a mix of garbage (intended for the previous handle) and new data to the handle
p22500
aVUtterly destroying the content of whatever it is writing to
p22501
aVSpin up the backup tapes if that's something like a mission critical database
p22502
as(dp22503
g9
V17034
p22504
stp22505
a((dp22506
g2
(lp22507
VIt is not the kind of flicker that double-buffering can solve
p22508
aVNor BeginUpdate or SuspendLayout
p22509
aVYou've got too many controls, the BackgroundImage can make it a lot worse
p22510
aVIt starts when the UserControl paints itself
p22511
aVIt draws the BackgroundImage, leaving holes where the child control windows go
p22512
aVEach child control then gets a message to paint itself, they'll fill in the hole with their window content
p22513
aVWhen you have a lot of controls, those holes are visible to the user for a while
p22514
aVThey are normally white, contrasting badly with the BackgroundImage when it is dark
p22515
aVOr they can be black if the form has its Opacity or TransparencyKey property set, contrasting badly with just about anything
p22516
aVThis is a pretty fundamental limitation of Windows Forms, it is stuck with the way Windows renders windows
p22517
aVFixed by WPF btw, it doesn't use windows for child controls
p22518
aVWhat you'd want is double-buffering the entire form, including the child controls
p22519
aVThat's possible, check my code in this thread for the solution
p22520
aVIt has side-effects though, and doesn't actually increase painting speed
p22521
aVThe code is simple, paste this in your form (not the user control):
p22522
aVThere are many things you can do to improve painting speed, to the point that the flicker isn't noticeable anymore
p22523
aVStart by tackling the BackgroundImage
p22524
aVThey can be really expensive when the source image is large and needs to be shrunk to fit the control
p22525
aVChange the BackgroundImageLayout property to "Tile"
p22526
aVIf that gives a noticeable speed-up, go back to your painting program and resize the image to be a better match with the typical control size
p22527
aVOr write code in the UC's OnResize() method to create a properly sized copy of the image so that it doesn't have to be resized every time the control repaints
p22528
aVUse the Format32bppPArgb pixel format for that copy, it renders about 10 times faster than any other pixel format
p22529
aVNext thing you can do is prevent the holes from being so noticeable and contrasting badly with the image
p22530
aVYou can turn off the WS_CLIPCHILDREN style flag for the UC, the flag that prevents the UC from painting in the area where the child controls go
p22531
aVPaste this code in the UserControl's code:
p22532
aVThe child controls will now paint themselves on top of the background image
p22533
aVYou might still see them painting themselves one by one, but the ugly intermediate white or black hole won't be visible
p22534
aVLast but not least, reducing the number of child controls is always a good approach to solve slow painting problems
p22535
aVOverride the UC's OnPaint() event and draw what is now shown in a child
p22536
aVParticular Label controls are very wasteful of system resources
p22537
as(dp22538
g9
V17034
p22539
stp22540
a((dp22541
g2
(lp22542
VNo repro with the given code and my own test
p22543
aVpng on Win7
p22544
aVThe only thing I see wrong is your Stat() function, it doesn't fully initialize the STATSTG
p22545
aVIt contains garbage on the first call
p22546
aVThe call stack shows heap corruption
p22547
aVVista has a new and much improved heap manager that diagnoses heap corruption much sooner than XP
p22548
aVI can only assume that the corruption happens in code not shown
p22549
as(dp22550
g9
V17034
p22551
stp22552
a((dp22553
g2
(lp22554
VThrottling is important here, by the sound of it, the BoundedBuffer class in this magazine article fits the bill
p22555
aVA similar class will be available in
p22556
aVNET 4
p22557
aV0 as the BlockingCollection class
p22558
aVTuning the buffer size is still up to you
p22559
as(dp22560
g9
V17034
p22561
stp22562
a((dp22563
g2
(lp22564
VUse the Control
p22565
aVModifierKeys property to detect whether the Shift key is pressed
p22566
aVSample code:
p22567
aVImplementing the SetSelectionStart/End is up to you
p22568
as(dp22569
g9
V17034
p22570
stp22571
a((dp22572
g2
(lp22573
VThe
p22574
aVNET framework already contains them, they are just not advertised as such
p22575
aVProbably because of the inherent ambiguity in the three different ways to iterate a tree
p22576
aVSortedDictionary uses a self-balancing red-black tree under the hood and has the same time and space complexity as a binary tree
p22577
aVYou'll need SortedList if your tree contains duplicates
p22578
as(dp22579
g9
V17034
p22580
stp22581
a((dp22582
g2
(lp22583
VWell, you'll need Thread
p22584
aVSetApartmentState() to switch the Thread to STA before you start it, then call Application
p22585
aVRun() in the thread function to start the message loop
p22586
aVThis has nothing to do with the Action and Func delegates though
p22587
aVThe message queue is an internal Windows structure that stores mouse and keyboard messages
p22588
aVIt is not suitable to store your own objects
p22589
aVNot sure where you want to go with this
p22590
aVA regular System
p22591
aVCollections
p22592
aVGeneric
p22593
aVQueue<> object can store any kind of object, including an object of a class that represents a "command"
p22594
aVMake it thread-safe with a ReaderWriterLockSlim
p22595
as(dp22596
g9
V17034
p22597
stp22598
a((dp22599
g2
(lp22600
VThere is no documented way to obtain the file name associated with a file handle
p22601
aVThe example you linked can only work for memory mapped files, it relies on the GetMappedFileName() API function
p22602
aVNo such API exists for regular file handles
p22603
aVIt is in fact possible, the SysInternals' Handle utility does it
p22604
aVThe reason it isn't documented is that the structure of the kernel handle table is highly variable, it has changed for every Windows version
p22605
aVAnd, most of all, because it would allow extremely unsafe operations on a file handle, the kind that destroys file system integrity
p22606
aVPeople will use it to close a file handle owned by another process to get rid of a file locking problem
p22607
aVYou can probably find out how to do it by googling NtQuerySystemInformation
p22608
aVMake daily backups of your hard drive if you contemplate using it
p22609
as(dp22610
g9
V17034
p22611
stp22612
a((dp22613
g2
(lp22614
VWell, no problem, you can simply implement the constructor of your derived exception class to format the string you'll return from what()
p22615
aVFree the buffer you use for that in the destructor
p22616
as(dp22617
g9
V17034
p22618
stp22619
a((dp22620
g2
(lp22621
VEverything disappears when you minimize a window
p22622
aVI assume you mean that the table isn't there anymore when you restore the window
p22623
aVThat will happen when you don't use the Paint event to draw the table but draw the screen directly
p22624
aVImplement the panel's Paint event:
p22625
as(dp22626
g9
V17034
p22627
stp22628
a((dp22629
g2
(lp22630
VThis is going to require some psychic debugging
p22631
aVOr a web cam
p22632
aVI'll guess that you added this project to an existing solution
p22633
aVIn which case you'll find the DLL in the Debug subdirectory of the solution folder, not the Debug folder of your project
p22634
aVTo get it in the right place, right-click the project that needs the DLL, Add Reference, Project tab, select your C++/CLI project
p22635
aVNow it will get copied in the bin\u005cDebug folder of your C# project, ready for your C# project to use it
p22636
as(dp22637
g9
V17034
p22638
stp22639
a((dp22640
g2
(lp22641
VVista file redirection can explain this
p22642
aVIt is a feature to allow legacy programs that don't handle UAC properly to still operate
p22643
aVThe file gets redirected to the virtual store
p22644
aVThis will happen when you use Visual Studio 2005 or earlier or did something to prevent the manifest from getting embedded in the exe
p22645
aVFix it by including a manifest
p22646
as(dp22647
g9
V17034
p22648
stp22649
a((dp22650
g2
(lp22651
VIt depends on what you define as "distance"
p22652
aVYou could give the base class an abstract CenterPoint property, overridden by each derived class
p22653
aVNow it is simple
p22654
as(dp22655
g9
V17034
p22656
stp22657
a((dp22658
g2
(lp22659
VSet the AutoScrollMinSize property
p22660
aVIf you implemented the OnPaint() override then you'll need to use the AutoScrollPosition property to set the arguments for e
p22661
aVGraphics
p22662
aVTranslateTransform()
p22663
as(dp22664
g9
V17034
p22665
stp22666
a((dp22667
g2
(lp22668
VYeah, there is one
p22669
aVIf you initialize an object with the default constructor and use parentheses then the POD members will be zero initialized:
p22670
as(dp22671
g9
V17034
p22672
stp22673
a((dp22674
g2
(lp22675
VUse the EnumDisplayMonitors() function, passing NULL for the first 2 arguments
p22676
aVYour callback gets the monitors in numeric order with their virtual location, relative from the main monitor
p22677
aVNegative positions are to the left and top of your main monitor
p22678
as(dp22679
g9
V17034
p22680
stp22681
a((dp22682
g2
(lp22683
VIt is the MDI parent form that gets the Activated event
p22684
aVYou can subscribe to the event in your child form's Load event
p22685
aVBe careful, you have to make sure you unsubscribe the event when the child gets closed or you'll leak the child form instance
p22686
aVMake it look like this:
p22687
as(dp22688
g9
V17034
p22689
stp22690
a((dp22691
g2
(lp22692
VYou are getting hung up on what the IDE looks like when you create a Setup project
p22693
aVThere is no "application files" folder, the Setup project creates a setup
p22694
aVexe file when it is built
p22695
aVThat's the only file that you need to distribute to your client
p22696
aVThe "application files" node on the screen is simply a container in which you can put files while you create your Setup project
p22697
aVThose files will be available in the application's install directory after your client runs the setup
p22698
aVexe installer on her machine
p22699
aVActually run the setup
p22700
aVexe on your machine to see what it will look like on your client's machine
p22701
as(dp22702
g9
V17034
p22703
stp22704
a((dp22705
g2
(lp22706
VThe code is sloppy, it doesn't call the Dispose() method on the bitmap after saving it
p22707
aVThat keeps a lock on the file, GDI+ uses a memory-mapped file to avoid putting pressure on the paging file
p22708
aVImportant because bitmaps can be quite large
p22709
aVTrying to save to the same file again fails because of the lock
p22710
aVGDI+ exception messages are notoriously sloppy as well
p22711
aVI think the bug is located in Interpreter\u005cConverter\u005cImage\u005cRtfImageConverter
p22712
aVcs, SaveImage() method
p22713
aVThe "convertedImage" bitmap doesn't get disposed
p22714
aVNote that the Graphics object in that same method doesn't get disposed either
p22715
aVFix it by wrapping them with the using statement
p22716
aVRun this code through FxCop to catch similar mistakes
p22717
aVAnd ask yourself if you really want to maintain code like this
p22718
as(dp22719
g9
V17034
p22720
stp22721
a((dp22722
g2
(lp22723
VYou are right, that's a problem
p22724
aVThe finalizer is useless, it will run far too late to be of any use
p22725
aVThe code should have deadlocked heavily before that anyway
p22726
aVUnfortunately, there's no way for you to tell the difference between the a foreach calling your MoveNext/Current members or the client code using them explicitly
p22727
aVNo fix, don't do this
p22728
aVMicrosoft didn't do it either, they had plenty of reason to back in
p22729
aVNET 1
p22730
aVx
p22731
aVThe only real thread-safe iterator you can make is one that creates a copy of the collection object in the GetEnumerator() method
p22732
aVThe iterator getting out of sync with the collection is no joy either though
p22733
as(dp22734
g9
V17034
p22735
stp22736
a((dp22737
g2
(lp22738
VWell, as indicated, you need to create a delegate instance to wrap your callback
p22739
aVBut don't go there, SAPI 5
p22740
aV1 is quite outdated
p22741
aVUpdates are no longer shipped because the
p22742
aVNET framework has a very nice wrapper for it
p22743
aVCheck out the System
p22744
aVSpeech
p22745
aVRecognition namespace and the SpeechRecognitionEngine class
p22746
aVYou'll want to use the SpeechRegonized event
p22747
aVYou'll find plenty of code samples in the MSDN Library pages for the class
p22748
as(dp22749
g9
V17034
p22750
stp22751
a((dp22752
g2
(lp22753
VToString() overrides like this for a collection class rarely work out well in practice
p22754
aVThey don't behave well when you've got thousands of elements in the collection
p22755
aVA decent visualization is to display the top element and the number of elements
p22756
aVFor example:
p22757
as(dp22758
g9
V17034
p22759
stp22760
a((dp22761
g2
(lp22762
VThere are ~3E38 possible GUID values
p22763
aVBut the Birthday Paradox cuts the 50/50 odds to producing a duplicate GUID to ~1E19
p22764
aVWhile still an enormous number, comparing quite favorably to the odds that your machine will be destroyed by a meteor impact first, the system clock is used to ensure no duplicates can occur
p22765
aVMany large and mission critical dbase apps use a GUID as the primary key in a table
p22766
aVDon't hesitate to follow their lead
p22767
as(dp22768
g9
V17034
p22769
stp22770
a((dp22771
g2
(lp22772
VYeah, there's another way
p22773
aVThe Controls
p22774
aVSetChildIndex() also changes Z-order
p22775
aVThe one with index 0 is the one on top
p22776
aVDoesn't buy you anything though, BringToFront() uses this method
p22777
aVYour SendLabelsToBack() method as given cannot work, it will also send the label to added to the back
p22778
aVBut your next statement fixes that again
p22779
aVOkay, that doesn't work, which means the BringToFront() method doesn't get executed
p22780
aVLook in the Output window for a "first chance exception" notification
p22781
aVAs written, your SendLabelsToBack() will cause an exception if the user control contains any control other than a UserLabel
p22782
aVAlso, set a breakpoint after the BringToFront() call and check the value of userContainer
p22783
aVControls[0]
p22784
aVName when it breaks
p22785
as(dp22786
g9
V17034
p22787
stp22788
a((dp22789
g2
(lp22790
VRun Tlbimp
p22791
aVexe on the type library to generate the
p22792
aVNET interop assembly for it
p22793
as(dp22794
g9
V17034
p22795
stp22796
a((dp22797
g2
(lp22798
VThe TextFieldParser constructor you use expects the name of a file
p22799
aVInstead, it gets the contents of the file
p22800
aVThat goes Kaboom, the file content is not a valid path to a file
p22801
aVYou'll need to the constructor that takes a Stream and use the StringReader class to provide the stream
p22802
aVFor example:
p22803
aVThis is a bit wasteful of memory but not an issue if the text is less than a megabyte or so
p22804
aVIf it is more then you shouldn't put it in a resource
p22805
as(dp22806
g9
V17034
p22807
stp22808
a((dp22809
g2
(lp22810
VYou'll need these declarations:
p22811
aVUsage:
p22812
aVwhere x and y are in screen coordinates
p22813
aVUse Control
p22814
aVPointToScreen() if necessary
p22815
as(dp22816
g9
V17034
p22817
stp22818
a((dp22819
g2
(lp22820
VIt is a pretty essential requirement for an efficient transport mechanism that involves device drivers
p22821
aVThe King of the heap is TCP, it ensures no matter what you throw at it, it will do its level best to get the data across the wire
p22822
aVIt does that quite well, it has a 9 nines delivery guarantee
p22823
aVIt normally requires an earth quake or somebody tripping over a power cord to not deliver on that promise
p22824
aVWhich means that you don't have to worry that, when you write data to a socket, that it won't be delivered
p22825
aVWhich means that the kernel driver can take the liberty of saying "I've got space to store this, bring it on
p22826
aVand give the user mode program a quick return to more important things, like keeping the UI updated
p22827
aVGood Thing
p22828
aVIf for some reason your delivery guarantee needs to be stronger than that, maybe 12 nines, then you shouldn't use TCP
p22829
aVIt's been done, "reliable UDP" googles well
p22830
aVAlthough it tends to get re-invented over and over again
p22831
aVGood luck
p22832
as(dp22833
g9
V17034
p22834
stp22835
a((dp22836
g2
(lp22837
VYou are already calling SP
p22838
aVWrite(), that ought to be close
p22839
aVAlthough you probably don't want to send the port name back, the sender has little use for that
p22840
aVIt also shouldn't be in the InvokeRequired test
p22841
aVWhich is always true btw, you might as well remove that
p22842
aVYou also really want to get rid of the Sleep() call
p22843
aVUse ReadLine() if the sender terminates its message with a line feed ("\u005cn")
p22844
aVIf you are contemplating this because you need the sender to stop sending until it gets the acknowledgment then the real problem is in you using Sleep and ReadExisting
p22845
as(dp22846
g9
V17034
p22847
stp22848
a((dp22849
g2
(lp22850
VIt's not the way it is done with a ToolStripMenuItem
p22851
aVYou give the MenuStrip a custom renderer
p22852
aVExample code is in this thread
p22853
as(dp22854
g9
V17034
p22855
stp22856
a((dp22857
g2
(lp22858
VRemove the project from your solution by right-clicking it in the Solution Explorer window and choosing Remove
p22859
aVMove the entire project folder, including subdirectories wherever you want it to go
p22860
aVAdd the project back to your solution
p22861
aVNamespace names is something completely different, just edit the source code
p22862
as(dp22863
g9
V17034
p22864
stp22865
a((dp22866
g2
(lp22867
VI've tinkered with this source code before
p22868
aVIt was done well, recommended
p22869
as(dp22870
g9
V17034
p22871
stp22872
a((dp22873
g2
(lp22874
VYes, it is technically possible for this code to cause OOM
p22875
aVThat will happen when the UI thread cannot keep up with the worker thread
p22876
aVEach Control
p22877
aVBeginInvoke() adds a delegate to an internal  maintained by Windows Forms
p22878
aVThe message pump empties that list
p22879
aVIf it cannot keep up with the rate at which the worker thread calls BeginInvoke then the list grows without bounds and, eventually, causes OOM
p22880
aVIf this is really called only 10 times per second and it code only updates a progress bar and the UI thread is otherwise idle then OOM should never happen
p22881
aVThat it does happen suggests that you somehow call this method a lot more frequently than 10 times per second
p22882
aVOr the real code does a lot more than just update a PB, the "UpdateLog" name suggests it does
p22883
aVUsing Invoke instead of BeginInvoke solves that problem, but will slow down the worker
p22884
as(dp22885
g9
V17034
p22886
stp22887
a((dp22888
g2
(lp22889
VYes, this is normal
p22890
aVThe Application
p22891
aVThreadException catcher is disabled when you run under a debugger
p22892
aVThis is done so you can easily diagnose exceptions
p22893
aVTo make it behave the same way, you have to call the Application
p22894
aVSetUnhandledExceptionMode() method
p22895
aVUnfortunately that's hard to do in a VB
p22896
aVNET project, you have to disable the application framework
p22897
aVNot worth the hassle, press Ctrl+F5 if you want to test the exception handling code
p22898
as(dp22899
g9
V17034
p22900
stp22901
a((dp22902
g2
(lp22903
VOne of the nice things about Windows Forms is that you'll usually get the new look of the common controls on a new version of Windows
p22904
aVThat certainly applies to ProgressBar, on Vista and Win7 you get the green continuous bar with the traveling highlight note
p22905
aVNo code is required
p22906
aVIf you now see a blocky blue bar then you've either got a really old version of Windows or you've got visual styles turned off
p22907
aVLooking for a replacement for PB is, frankly, a waste of time, look for a replacement of Windows
p22908
aVI recommend Win7
p22909
as(dp22910
g9
V17034
p22911
stp22912
a((dp22913
g2
(lp22914
VSpeechRecognitionEngine is a wrapper around a apartment-threaded COM server
p22915
aVYes, a hard requirement for them is at least one thread that is STA and pumps a message loop
p22916
aVSince you are writing a library, you can't control what your client selects
p22917
aVBut you can tell her that there's a problem instead of just having your speech recognizer deadlock
p22918
aVAdd this check to your class constructor:
p22919
aVThe check is a bit heavy-handed, the recognizer will still work if it is created on a worker thread in a program that also has a UI thread
p22920
aVAlthough that mode is quite undesirable, every single call to the recognizer will get marshaled and any events you generate will have to be marshaled by the client
p22921
aVI'd suggest an argument to your main class constructor that allows the client to indicate that she really does want the recognizer to run on a thread
p22922
as(dp22923
g9
V17034
p22924
stp22925
a((dp22926
g2
(lp22927
VDon't use the Load event, override the OnLoad() method
p22928
aVThat ensures that everything runs in a predictable order when you derive from the form class
p22929
aVYou should only use it for form initialization that requires the size of the actual form to be know
p22930
aVIt can be different from the design size due to scaling or user preferences and the actual size isn't know until the native window is created
p22931
aVInitializing controls in the OnLoad method is possible but it can be very slow, especially for ListView and TreeView
p22932
aVIf you initialize them in the constructor, they can be bulk-initialized when their native Windows controls are created
p22933
aVOne special exception: creating an MDI child window should always be done in OnLoad(), there's a bug in the plumbing code that messes up the MDI bar when you create a child in the constructor
p22934
as(dp22935
g9
V17034
p22936
stp22937
a((dp22938
g2
(lp22939
VThe attribute on the pcbData argument is wrong, it is ref, not out
p22940
aVYou need to initialize it to the Capacity of the StringBuilder you pass for the pvData argument
p22941
aVRight now the API function probably sees a 0 so will return the error code
p22942
aVIt ought to look something like this:
p22943
as(dp22944
g9
V17034
p22945
stp22946
a((dp22947
g2
(lp22948
VThat's not going to look great, TimeSpan is missing a decent ToString() override on
p22949
aVNET 3
p22950
aV5 and earlier
p22951
aVWork around that by using the DateTime
p22952
aVToString() method:
p22953
as(dp22954
g9
V17034
p22955
stp22956
a((dp22957
g2
(lp22958
VThere is no right way to reference a
p22959
aVresx file at runtime
p22960
aVThey are design-time files, the build system translates them to satellite assemblies
p22961
aVAnd copies the resulting DLL into the en-US folder of your bin\u005cDebug folder
p22962
aVAnd the runtime automatically finds and uses them if the current culture is set to en-US
p22963
aVI suppose you can get
p22964
aVresx reading going, but you'll get no help from the IDE or the build system to do so
p22965
aVI'd have to recommend you avoid fighting the machine
p22966
as(dp22967
g9
V17034
p22968
stp22969
a((dp22970
g2
(lp22971
VThe SerialPort
p22972
aVGetPortNames() method returns an array of the COM port names of all available serial ports
p22973
aVYou could iterate it and try to Open() them
p22974
aVExpect failure, the port might already be opened by another program
p22975
aVYou don't want to send something to a device that doesn't expect it
p22976
aVUsing the DsrHolding property is a reasonable test to see if a device is attached that's powered up
p22977
aVYour ultimate nemesis is going to be the Baudrate property
p22978
aVYou cannot guess the proper value
p22979
aVSerial ports are way too primitive to support plug-and-play style device discovery
p22980
aVAvoid using something that cannot work reliably, allow you user to configure your program with the settings you need
p22981
aVIt is the normal practice
p22982
as(dp22983
g9
V17034
p22984
stp22985
a((dp22986
g2
(lp22987
VIt completely depends on the program you are trying to start
p22988
aVThe Process class fully supports Unicode, as does the operating system
p22989
aVBut the program might be old and use 8-bit characters
p22990
aVIt will use GetCommandLineA() to retrieve the command line arguments, the ANSI version of the native Unicode GetCommandLineW() API function
p22991
aVAnd that translates the Unicode string to 8-bit chars using the system default code page as configured in Control Panel + Regional and Language Options, Language for Non-Unicode Programs
p22992
aVWideCharToMultiByte() using CP_ACP
p22993
aVIf that is not the Japanese code page, that translation produces question marks since the Japanese glyphs only have a code in the Japanese code page
p22994
aVSwitching the system code page isn't usually very desirable for non-Japanese speakers
p22995
aVUtf8 certainly won't work, the program isn't going to expect them
p22996
aVConsider running this program in a virtual machine
p22997
as(dp22998
g9
V17034
p22999
stp23000
a((dp23001
g2
(lp23002
VThere is only one kind of process on Windows
p23003
aVThat a
p23004
aVNET process executes machine code that's generated on-the-fly is not relevant, the machine code is no different from the kind that's executed in an unmanaged process
p23005
aVAnd a
p23006
aVNET process runs lots of unmanaged code, like Windows API functions, just like an unmanaged process
p23007
aVAppDomains have nothing to do with unmanaged code
p23008
aVIt is merely an abstraction that's available in managed code since memory is allocated in a managed way
p23009
aVWhich allows it to be unallocated in a one fell swoop, much like a process
p23010
aVJust a lot more efficiently
p23011
as(dp23012
g9
V17034
p23013
stp23014
a((dp23015
g2
(lp23016
VQuoting from the what's new article:
p23017
aVVisual Basic 2010 has been updated to
p23018
aVfully support the DLR in its
p23019
aVlatebinder
p23020
aVCan't get more explicit than that
p23021
aVIt is the DLR that implements the caching
p23022
as(dp23023
g9
V17034
p23024
stp23025
a((dp23026
g2
(lp23027
VContinuing to add data to the dbase when adding one record failed is almost always wrong
p23028
aVRecords are very frequently related
p23029
aVThey represent a set of transactions on a bank account
p23030
aVOr a batch of orders from a customer
p23031
aVAdding these with one of them missing is always a problem
p23032
aVNot only do you give your client a huge problem coming up with a new batch that contains the single corrected record, you make it far too easy to allow somebody to just ignore the error
p23033
aVThe kind of error that doesn't get discovered or causes problems until much later
p23034
aVInvariably with a huge cost associated with correcting the error
p23035
aVWhen an error occurs, reject the entire batch
p23036
aVKeep the dbase in a proper state by using transactions
p23037
aVUse, say, SqlTransaction and call BeginTransaction() when you start
p23038
aVCall Commit() when everything worked, call Rollback() in your catch clause
p23039
aVYour client can now go back to the sub-system that generates the records, make the correction and re-run your program
p23040
aVYour dbase will always contain a proper copy of that sub-system's data
p23041
aVAnd errors cannot be ignored
p23042
as(dp23043
g9
V17034
p23044
stp23045
a((dp23046
g2
(lp23047
VYou are talking about different exception handling features
p23048
aVThe ThreadExceptionDialog you see with the Quit and Continue buttons is triggered by the Application
p23049
aVThreadException event
p23050
aVIt will only ever appear if the exception happens on the UI thread, when an event handler that runs in response to a Windows message throws an exception
p23051
aVAny exception in a worker thread however will bomb the program through AppDomain
p23052
aVUnhandledException
p23053
aVYou cannot handle the latter, the program is dead and cannot continue
p23054
aVDisplaying ThreadExceptionDialog is pointless
p23055
aVYou can make the program bomb consistently by disabling the ThreadException event by calling Application
p23056
aVSetUnhandledExceptionMode()
p23057
aVNow every unhandled exception will trigger AppDomain
p23058
aVUnhandledException and terminate the program
p23059
aVThat's probably not what you want but is the wise choice
p23060
aVAlso note that the ThreadException event is disabled when you run the program with a debugger
p23061
aVWhich is presumably why you see a difference in VS2008
p23062
aVThere have otherwise not been any changes
p23063
as(dp23064
g9
V17034
p23065
stp23066
a((dp23067
g2
(lp23068
VThere is no good solution for this in Windows
p23069
aVWhen a program frees a heap block, it almost always gets added to a list of free blocks
p23070
aVYou can only discover these is by walking the heap with HeapWalk()
p23071
aVThat's expensive and very detrimental to the operation of a multi-threaded program because you have to lock the heaps
p23072
aVAlso, a program almost never runs out of free virtual memory space
p23073
aVIt first runs out of a free contiguous chunk of space that's large enough to fit the request
p23074
aVThe sum of block sizes you get from HeapWalk is not meaningful unless you only ever make very small allocations
p23075
aVThe most typical reason for wanting a feature like this is because your program is routinely running out of memory
p23076
aVThere is a very effective and cheap solution available for that problem
p23077
aVTwo hundred bucks buys you a 64-bit version of Windows
p23078
as(dp23079
g9
V17034
p23080
stp23081
a((dp23082
g2
(lp23083
VBrilliant
p23084
aVthats what I want
p23085
aVThat's not what you want
p23086
aVIt is the worst possible format for a date because it is so horribly ambiguous
p23087
aVDate string formats depend on the current culture
p23088
aV"4/1/2010" is Unicorn day at SO, it is day in January in Europe
p23089
aV"#4/1/2010#" is a legacy VB6 format
p23090
aVAlways store dates in a DateTime in your code
p23091
aVAlways store dates in a database column type of datetime in your dbase
p23092
aVThere is never any ambiguity and you'll have an easy time with the DateTime members to manipulate dates
p23093
as(dp23094
g9
V17034
p23095
stp23096
a((dp23097
g2
(lp23098
VYou'll need to terminate the app yourself
p23099
aVThis will do it:
p23100
as(dp23101
g9
V17034
p23102
stp23103
a((dp23104
g2
(lp23105
VYes, it mangles the position
p23106
aVThe X-location is always zero, the Y-location is the X-location of where the tip should appear
p23107
aVQuacks like a P/Invoke mistake, although I don't see it
p23108
aVThe bug is fixed in
p23109
aVNET 4
p23110
ag2512
as(dp23111
g9
V17034
p23112
stp23113
a((dp23114
g2
(lp23115
VA program must tell the operating system that it is DPI-aware to get the true resolution when you go past 125%
p23116
aVThat's best done with a manifest, as explained in this MSDN Library article
p23117
as(dp23118
g9
V17034
p23119
stp23120
a((dp23121
g2
(lp23122
VIt is going to sort the items each time you add an item
p23123
aVEither temporarily disable the sort or use the Items
p23124
aVAddRange() method to add a bunch of items at the same time
p23125
aVAnd consider Begin/EndUpdate() when you add one at a time
p23126
as(dp23127
g9
V17034
p23128
stp23129
a((dp23130
g2
(lp23131
VYes, you can see what's being used by using another instance of Visual Studio and use Tools + Attach to Process (managed) to look at the call stack
p23132
aVIt is a Microsoft
p23133
aVVisualStudio
p23134
aVWindows
p23135
aVForms
p23136
aVResourcePickerDialog
p23137
aVThat is not something you can use in your own code, the Visual Studio designer assemblies are not re-distributable
p23138
aVNor would they be useful, they monkey with the design-time state of the project
p23139
aVMaking you own isn't that hard, just use Reflection to iterate the properties of Properties
p23140
aVResources and find the ones that have the Bitmap or Icon type
p23141
aVDisplay them in a ListView to allow the user to pick one
p23142
aVAdding resources at runtime isn't an option
p23143
as(dp23144
g9
V17034
p23145
stp23146
a((dp23147
g2
(lp23148
VThe exception has a very specific meaning, it tells you that somebody already has the port opened
p23149
aVWho could that be
p23150
aVTriple-check four times that you are really using a different port name when you open the 2nd one
p23151
aVNext step is to take the USB emulator to the parking lot and run over it with your car several times so it can no longer drive a programmer nuts
p23152
aVGet one from another manufacturer that uses a different device driver supplier
p23153
as(dp23154
g9
V17034
p23155
stp23156
a((dp23157
g2
(lp23158
VThere's another exception being raised while the stack is being unwound for the Access Violation exception
p23159
aVWhich is being swallowed, causing the AV to disappear
p23160
aVYou'll need to find out what code is doing this
p23161
aVDebug + Exceptions, check the Thrown box for Win32 Exceptions
p23162
aVThe debugger will stop on the first one, continue
p23163
aVCheck out the call stack when it stop again
p23164
aVAdd it to your question if you can't figure it out
p23165
as(dp23166
g9
V17034
p23167
stp23168
a((dp23169
g2
(lp23170
VThe real problem here is that your method has too many arguments
p23171
aVThat makes it unwieldy for you to write the validation code
p23172
aVMakes it unwieldy on the client code as well
p23173
aVConsider writing a helper class where the arguments you now pass are properties
p23174
aVYour method could now take only one argument
p23175
aVAnd the validation can be done in the class itself instead of your method
p23176
as(dp23177
g9
V17034
p23178
stp23179
a((dp23180
g2
(lp23181
VNot sure if there is a real question here
p23182
aVBut the code as posted is fundamentally wrong
p23183
aVA stream is not obligated to return the requested number of bytes
p23184
aVIt can return less, and often does
p23185
aVOnly when it returns 0 do you know for a fact that you've reached the end of the stream
p23186
aVThis allows a stream to optimize its internal buffer usage and improves overlapped I/O throughput
p23187
aVNetworkStream is a good example
p23188
as(dp23189
g9
V17034
p23190
stp23191
a((dp23192
g2
(lp23193
VI have to strongly recommend you stay away from any code written by Esposito
p23194
aVAs usual, his P/Invoke declarations in the ShellExt folder are completely wrong, they cannot work in 64-bit code
p23195
aVPublishing this code was very irresponsible in the first place, shell extensions should never use a
p23196
aVNET CLR version before 4
p23197
ag2512
aVVisit pinvoke
p23198
aVnet if you want to rescue it
p23199
as(dp23200
g9
V17034
p23201
stp23202
a((dp23203
g2
(lp23204
VYou'll have no trouble if the DLL whose export you P/Invoke is also available in a 64-bit version
p23205
aVWhich is definitely the case for the Windows DLLs, like kernel32
p23206
aVdll
p23207
aVGetPrivateProfileString() will work just as well, you don't need to make the [DllImport] attribute any different
p23208
aVAssuming you used IntPtr where required
p23209
aVOdds get lower when you use COM servers that are outdated or were not written by Microsoft or 3rd party DLLs
p23210
aVYou'll find out quickly if the x86 Target Platform override is required
p23211
aV32-bit DLLs produce a BadImageFormat exception, 32-bit COM servers produce a Class Not Registered exception
p23212
as(dp23213
g9
V17034
p23214
stp23215
a((dp23216
g2
(lp23217
VThe drive connection needs to be restored, that's done automatically by the shell
p23218
aVIt used to be done by WNetRestoreConnectionW() but that function has been removed in Vista
p23219
aVI think you'll need to do it this way now
p23220
aVUsing a UNC path () might be the better cure
p23221
as(dp23222
g9
V17034
p23223
stp23224
a((dp23225
g2
(lp23226
VThis is something you really should not fix
p23227
aVKeeping a form enabled while a dialog is displayed is risky
p23228
aVThe user could start code from that form that shouldn't run while a dialog is active
p23229
aVLike displaying another dialog
p23230
aVBut you can with a trick and doing it carefully
p23231
aVThe ShowDialog() call iterates all open forms and disables them
p23232
aVYou could re-enable one by P/Invoking the EnableWindow() API function
p23233
aVThe trick is to do so while the dialog is displayed, Control
p23234
aVBeginInvoke() can do this
p23235
aVThis is best explained with an example
p23236
aVIt needs three forms and a button on the main form, all with their default names
p23237
aVForm2 is kept non-modal while the dialog is displayed
p23238
aVYou may need to move it so it isn't hidden underneath the forms
p23239
as(dp23240
g9
V17034
p23241
stp23242
a((dp23243
g2
(lp23244
VDon't write this kind of code yourself
p23245
aVUse the Detours library from Microsoft Research
p23246
as(dp23247
g9
V17034
p23248
stp23249
a((dp23250
g2
(lp23251
VYes, this is a problem if you use Express
p23252
aVWhile it has lots of sample VB
p23253
aVNET code that demonstrates usage, the implementation is done in C# and there is no pre-built version of the assemblies available from the download site
p23254
aVThey have to built first before you can try the samples
p23255
aVTo get them built, you would have to run this command from the "Visual Studio Command Prompt":
p23256
aVBut I don't think the Express edition installs the "Visual Studio Command Prompt" shortcut in Programs either
p23257
aVWell, another good reason to upgrade to the RTM license
p23258
as(dp23259
g9
V17034
p23260
stp23261
a((dp23262
g2
(lp23263
VThe TextRenderer class uses GDI's DrawTextEx() function, it doesn't support transparency
p23264
aVSetting UseCompatibleTextRendering to true doesn't help either, the Label class forces the foreground color to an alpha of 255 to keep it compatible with TextRenderer
p23265
aVAll you can do is write your own paint override
p23266
aVAdd a new class to your project and paste the code shown below
p23267
aVCompile
p23268
aVDrop the new control from the top of the toolbox onto your form
p23269
aVBeware that I took a few short-cuts, it doesn't implement alignment, padding and Enabled
p23270
as(dp23271
g9
V17034
p23272
stp23273
a((dp23274
g2
(lp23275
VSystem
p23276
aVReflection
p23277
aVEmit contains classes that allows you to create dynamically generated code by emitting IL instructions
p23278
aVThe DynamicMethod and AssemblyBuilder classes are the work-horses for doing so
p23279
aVIL normally is loaded from an assembly, but there is no assembly when you generate the IL dynamically
p23280
aVAn assembly object is however needed to act as the container of the IL code and a "fake" one is created by AppDomain
p23281
aVDefineDynamicAssembly()
p23282
aVThat's what you see in the debugger notification
p23283
aVYou can't use Assembly
p23284
aVLoad(), the assembly is created dynamically
p23285
as(dp23286
g9
V17034
p23287
stp23288
a((dp23289
g2
(lp23290
VThere are several mistakes in the code and the declarations that prevents this code from working on a 64-bit operating system
p23291
aVBe sure to set the Platform Target to x86
p23292
aVAre you sure the native function actually returns data
p23293
aVWhat is the Result return value
p23294
aVA non-zero value indicates failure
p23295
aVThe proper way to call this function is to call it twice
p23296
aVFirst with the lpFormat argument set to null (IntPtr
p23297
aVZero) so it tells you how large a buffer it needs (returned by lpbcFormat)
p23298
aVThen you create the buffer and call it again
p23299
aVInstead of a custom marshaller, I would just create the buffer with Marshal
p23300
aVAllocHGobal after the first call and pass the IntPtr it returns as the lpFormat argument in the second call
p23301
aVThen, iff you get a success return code, use Marshal
p23302
aVPtrToStructure to write the WaveFormatEx
p23303
aVAnd Marshal
p23304
aVCopy to get the additional data
p23305
aVFwiw, using ref causes the P/Invoke marshaller to pass a WaveFormatEx** to the function but it expects a WaveFormatEx*
p23306
aVWhich will cause it to overwrite data in the garbage collected heap, destroying its internal format
p23307
aVA kaboom is next when the CLR notices this
p23308
aVCheck out the NAudio project as a good alternative for doing this yourself
p23309
as(dp23310
g9
V17034
p23311
stp23312
a((dp23313
g2
(lp23314
VThat KB article is badly outdated, it talks about
p23315
aVNET 1
p23316
ag22731
aVIn
p23317
aVNET 2
p23318
aV0, UserControl got a BorderStyle property
p23319
aVIt can be set to None, FixedSingle and Fixed3D
p23320
aVFixedSingle works fine when I try it, I never heard of a problem with it
p23321
aVRemove the CreateParams override
p23322
as(dp23323
g9
V17034
p23324
stp23325
a((dp23326
g2
(lp23327
V"Many images" is of course closely associated with running out of memory
p23328
aVBitmaps can get large, they'll eat up a lot of unmanaged virtual memory
p23329
aVYou'll have to make your program smarter and store less bitmaps in memory
p23330
aVOr save them temporarily to a file
p23331
aVOr re-download them if necessary
p23332
aVAnd properly clean up their resources with the Dispose() method, especially important for the Bitmap class
p23333
as(dp23334
g9
V17034
p23335
stp23336
a((dp23337
g2
(lp23338
VRe 1: there is no relevance to the actual day value, the two bytes used from the value simply roll over 65536 days after 1/1/1900
p23339
aVThe only thing that matters is that the values are roughly sequential
p23340
aVThe dbase is going to be a bit inefficient in the summer of 2079, nobody will notice
p23341
aVRe 2: yes, makes no sense
p23342
aVBut same story, the actual value doesn't matter
p23343
aVThe algorithm is questionable, messing with the guaranteed uniqueness of Guids is a tricky proposition
p23344
aVYou'll have to rely on somebody in the nHibernate team having insider knowledge that this works without problems
p23345
aVIf you change it, you're liable to break it
p23346
as(dp23347
g9
V17034
p23348
stp23349
a((dp23350
g2
(lp23351
VYes, the Graphics class supports scaling text
p23352
aVBut it needs to do so by rendering the text to a bitmap first, rescale the bitmap and pass that resized bitmap to the printer driver
p23353
aVAll those bitmaps make for a large spooler file
p23354
aVYou will need to justify the text yourself
p23355
aVThere's no support for this in the framework
p23356
aVOne way to do it is to hijack a rich edit control and let it take care of the justification and printing
p23357
aVVersion 5, msftedit
p23358
aVdll, supports full justification
p23359
aVThe best way to find the code you need is to find one of the many projects that implement a text editor with RTB, similar to Wordpad on Windows
p23360
as(dp23361
g9
V17034
p23362
stp23363
a((dp23364
g2
(lp23365
VFirst serialize the object to a MemoryStream with BinaryFormatter
p23366
aVSerialize()
p23367
aVMemoryStream
p23368
aVGetBytes() now gets you a byte[] that you can write to the blob
p23369
aVReading is requires deserializing the byte[] you got from the blob, now using BinaryFormatter
p23370
aVDeserialize()
p23371
aVCast to a
p23372
aVXmlSerializer will work too, the blob is just bigger
p23373
aVBut it does let you store the serialized value to an nvarchar(max) column in the dbase table instead of having to use a blob
p23374
aVIt is safer since it won't depend on the
p23375
aVNET framework version, important if this data is going to exist for a while
p23376
aVSerialize to a StringStream to get the string value of the generated XML
p23377
aVLast but not least, consider adding a table to your dbase that can store Points
p23378
aVIt is the clean solution
p23379
as(dp23380
g9
V17034
p23381
stp23382
a((dp23383
g2
(lp23384
VLook in the Output window:
p23385
aVc:\u005cprojects\u005ccpptemp3\u005ccpptemp3
p23386
aVcpp(9):
p23387
aVfatal error C1001: An internal error
p23388
aVhas occurred in the compiler
p23389
aV(compiler file 'msc1
p23390
aVcpp', line 1411)
p23391
aVTo work around this problem, try simplifying or changing the program
p23392
aVnear the locations listed above
p23393
as(dp23394
g9
V17034
p23395
stp23396
a((dp23397
g2
(lp23398
VBy process of elimination:
p23399
aVmaking your own implies that the exception is catchable and could be handled
p23400
aVIt should never be caught, you can't recover from bugs without recompiling
p23401
aVNotSupportedException implies that your code is at fault for not supporting the requested tool
p23402
aVNot likely, a Guid has trillions of invalid tool values
p23403
aVArgumentOutOfRange implies that the Guid is too small or too large
p23404
aVDoesn't make sense, they don't have a range
p23405
aVApplicationException is now considered not best-practice and is not specific enough
p23406
aVArgumentException("Unknown tool requested")
p23407
as(dp23408
g9
V17034
p23409
stp23410
a((dp23411
g2
(lp23412
VThe behavior is explicitly documented in the C# language specification, section 6
p23413
ag2584
aV1:
p23414
aVFor a conversion from float or double to an integral type, the
p23415
aVprocessing depends on the overflow checking context (7
p23416
ag2447
aV12) in which
p23417
aVthe conversion takes place:
p23418
aVIn a checked context, the conversion proceeds as follows:
p23419
aVIf the value of the operand is NaN or infinite, a
p23420
aVSystem
p23421
aVOverflowException is thrown
p23422
aVOtherwise, the source operand is rounded towards zero to the
p23423
aVnearest integral value
p23424
aVIf this integral value is within the range of
p23425
aVthe destination type then this value is the result of the conversion
p23426
aVOtherwise, a System
p23427
aVOverflowException is thrown
p23428
aVIn an unchecked context, the conversion always succeeds, and proceeds
p23429
aVas follows
p23430
aVIf the value of the operand is NaN or infinite, the result of the
p23431
aVconversion is an unspecified value of the destination type
p23432
aVOtherwise, the source operand is rounded towards zero to the
p23433
aVnearest integral value
p23434
aVIf this integral value is within the range of
p23435
aVthe destination type then this value is the result of the conversion
p23436
aVOtherwise, the result of the conversion is an unspecified value of
p23437
aVthe destination type
p23438
aVBold added for emphasis
p23439
aVYou've got Infinity and an unchecked context
p23440
aVThe value you get is unspecified
p23441
aVUse the checked keyword to make it bomb
p23442
as(dp23443
g9
V17034
p23444
stp23445
a((dp23446
g2
(lp23447
VVery unclear, I have to assume that when you hide the parent window then nothing will be visible
p23448
aVOne thing that might be relevant is that video is always displayed in a hardware overlay
p23449
aVThat's a feature of the video adapter, it can overlay different chunks of video memory to produce a composite image
p23450
aVAccordingly, if you hide that video window, the parent of that window will not get a repaint message because it wasn't actually overlapped
p23451
aVUse the Invalidate() method to force windows to repaint themselves
p23452
aVAvoid P/Invoking ShowWindow() if you can, the Visible property is always a good alternative
p23453
as(dp23454
g9
V17034
p23455
stp23456
a((dp23457
g2
(lp23458
VYou'll need to read this thread to get a feel for what accuracy means when you work with floating point numbers
p23459
aVWhatever happens to them when they get serialized to XML really doesn't matter much
p23460
aVIt will be accurate enough
p23461
aVUse the decimal type if you are uncomfortable about this kind of fuzziness
p23462
aVYou shouldn't be, that's how they work
p23463
as(dp23464
g9
V17034
p23465
stp23466
a((dp23467
g2
(lp23468
VHoly moly, you've found a whopper of a bug
p23469
aVThe P/Invoke used inside the TextRenderer class that calls DrawTextEx() is borked
p23470
aVThat API function is writing back into the string, which it is allowed to do since the cchText argument is a LPTSTR, not a LPCTSTR
p23471
aVThat destroys the
p23472
aVNET string content for both variables because the string is interned
p23473
aVThe bug isn't specific to
p23474
aVNET 4
p23475
aV0, I see it wrong in the ReferenceSource for
p23476
aVNET 3
p23477
aV5 SP1 as well and can repro it on VS2008
p23478
aVThe trouble is in the internal WindowsGraphics
p23479
aVMeasureText function
p23480
aVYou can report the bug at connect
p23481
aVmicrosoft
p23482
aVcom
p23483
aVA possible workaround is to alter the string so it gets copied and can't affect the original:
p23484
aVBut the better workaround in this case is to simply not pass the ModifyString option, it serves no purpose
p23485
aVWhich is safer too, there is still a possibility of destroying the garbage collected heap with the first workaround
p23486
aVThe fix for Microsoft is similarly simple, it should just mask out the ModifyString option
p23487
aVIt is documented to have no effect
p23488
as(dp23489
g9
V17034
p23490
stp23491
a((dp23492
g2
(lp23493
VWell, yes, GDI is the "it works anywhere anytime" API for rendering graphics
p23494
aVIt puts very low demands on the video driver
p23495
aVEverybody got that right a long time ago
p23496
aVWhich took a while, I got a distinct memory of a ATI Mach video card that gave me no end of trouble
p23497
aVIt stopped me from buying ATI products for quite a while
p23498
aVEverybody got DirectX right a lesser long time ago too
p23499
aVIt is being taking advantage of in the WPF rendering model, it completely relies on DirectX to get the job done
p23500
aVMilcore is the shim name
p23501
aVYou won't get it until you buy into the WPF programming model
p23502
as(dp23503
g9
V17034
p23504
stp23505
a((dp23506
g2
(lp23507
VYour P/Invoke declarations are impeccable
p23508
aVHowever, there's something very odd about the WAVEHDR dump you posted
p23509
aVIt is missing the lpData field
p23510
aVIf you insert that, all the numbers line up properly (i
p23511
ag9581
aVlpData = 0x19904c00, dwBufferLength = 0x0000fa00, etc)
p23512
aVNot sure how this came about, but it somehow is using the wrong WAVEHDR declaration
p23513
aVWinMM
p23514
aVWinMM ought to be a hint
p23515
as(dp23516
g9
V17034
p23517
stp23518
a((dp23519
g2
(lp23520
VThat googles well
p23521
aVHere's the best hit
p23522
aVBe sure to carefully read the "Unsupported scenarios" list
p23523
as(dp23524
g9
V17034
p23525
stp23526
a((dp23527
g2
(lp23528
VThis plumbing already exists, it is used to automatically update the MDI window list (MenuStrip
p23529
aVMdiWindowListItem property)
p23530
aVThe Form class has code in the OnVisibleChanged and OnMdiChildActivate methods to update the menu
p23531
aVIdle hope though, You can't see the menu item list change, nor can you override any of the plumbing code
p23532
aVNot without doing similar and overloading these methods in your own child forms
p23533
aVPunt this problem, simply write a public method in your MDI parent form that you consistently use to add new child windows:
p23534
aVYou can even make AddChild static, since there's only ever one MDI parent
p23535
as(dp23536
g9
V17034
p23537
stp23538
a((dp23539
g2
(lp23540
VYou are trouble-shooting the wrong problem
p23541
aVHeapRealloc() is bombing because the heap is corrupted
p23542
aVThat happened a while ago, some statement in your program overflowing a heap block, writing data to memory that was freed, something like that
p23543
aVMSVC has a debug memory allocator to help you troubleshoot these kind of problems, look in the MSDN library for
p23544
as(dp23545
g9
V17034
p23546
stp23547
a((dp23548
g2
(lp23549
VNo, the
p23550
aVNET 4
p23551
aV0 installer will only install version 4
p23552
aVIt will run apps targeted to CLR version 2 (like 3
p23553
aV5 apps) if there is no other version of the framework installed
p23554
aVOf course, you ought to test this scenario to make sure the version 4 changes don't have unexpected side effects
p23555
aVDo so by creating or editing the
p23556
aVexe
p23557
aVconfig file for your app:
p23558
aVNote that you can't use the VS2008 debugger when you do this
p23559
as(dp23560
g9
V17034
p23561
stp23562
a((dp23563
g2
(lp23564
VThe StatusStrip
p23565
aVPadding property is borked, it returns the wrong value for Padding
p23566
aVRight if the sizing grip is disabled
p23567
aVYou can fix it in your form constructor, like this:
p23568
aVUsing the Left property to specify Right is the fix
p23569
aVDon't bother submitting this bug to Connect, they won't fix it
p23570
as(dp23571
g9
V17034
p23572
stp23573
a((dp23574
g2
(lp23575
VTools + Options, Projects and Solutions, Build and Run
p23576
aV"On Run, when projects are out of date" = Always build
p23577
aVThe one below that = Do not launch
p23578
as(dp23579
g9
V17034
p23580
stp23581
a((dp23582
g2
(lp23583
VThat's not how it works, CultureInfo serves a different purpose
p23584
aVYou need the Encoding class
p23585
aVYou'll get one with:
p23586
aVWhich you can then use to convert text, use enc
p23587
aVGetString()
p23588
aVTake a step back though, this encoding is really old, 25 years is a long time in software engineering
p23589
aVYou really ought to consider upgrading this dbase
p23590
aVWhat's more, the encoding should be handled by your Sybase database provider
p23591
aVIt should already convert text columns to Unicode
p23592
aVYou should only need to convert yourself if the text is somehow contained in a blob
p23593
as(dp23594
g9
V17034
p23595
stp23596
a((dp23597
g2
(lp23598
VHard to see how this is possible, StreamReader is blindingly fast compared to HttpWebRequest
p23599
aVSome basic assumptions: say you are downloading 900 files with 5000 lines, 100 chars each in 6 minutes
p23600
aVThat means you need to download 900 x 5000 x 100 = 450 Megabytes
p23601
aVIn 6 minutes, that requires a bandwidth of 450E6 / 6 / 60 * 8 = 10 Mbps
p23602
aVWhat do you have
p23603
aV10 Mbps is about typical for high-speed Internet service, although you need a server that can sustain this
p23604
aVTo get it down to 2 seconds, you'll need to upgrade your service to 30 Mbps
p23605
aVYour boss can fix that
p23606
aVAbout the speed improvement you saw: watch out for the cache
p23607
as(dp23608
g9
V17034
p23609
stp23610
a((dp23611
g2
(lp23612
VCOM servers are required to change their CLSID guids if their interfaces are no longer compatible
p23613
aVSo if your supplier did it right, you should be able to register both of them and get the right one when you use the right reference in your project
p23614
aVLike any rule, this one got violated often and is presumably the reason you started this question in the first place
p23615
aVThe back-up plan is to use registry-free COM, you write a manifest and add it to your program so it always uses the local copy of the COM server DLL instead of the one that was registered
p23616
aVFind out how to do this by googling "regfree COM", I see many relevant and useful hits at the top
p23617
as(dp23618
g9
V17034
p23619
stp23620
a((dp23621
g2
(lp23622
VAssuming you gave the NUDs their default names:
p23623
as(dp23624
g9
V17034
p23625
stp23626
a((dp23627
g2
(lp23628
VThe exponent operator (Math
p23629
aVPow) isn't very fast, there is no dedicated CPU instruction for calculating it
p23630
aVYou mentioned that D and E are global variables
p23631
aVThat offers a glimmer of hope to get it faster, if you can isolate their changes
p23632
aVRewriting the equation using logarithms:
p23633
aVWhich provides this function to calculate the result:
p23634
aVI timed it with the StopWatch class, it is exactly as fast as your original expression
p23635
aVNot a coincidence of course
p23636
aVYou'll get ahead by somehow being able to pre-calculate the Math
p23637
aVLog(e) - Math
p23638
aVLog(d) term
p23639
as(dp23640
g9
V17034
p23641
stp23642
a((dp23643
g2
(lp23644
VExplicitly unregistering event handlers is only necessary when the event reference keeps the object that contains the delegate target alive for too long
p23645
aVIn your case, the sampleObj will have a reference to the Form object
p23646
aVThe C# syntax sugar hides this, the compiler actually generates this code:
p23647
aVsampleObj
p23648
aVAssignValue = new
p23649
aVSample
p23650
aVAssignValueDelegate(this,
p23651
aVAssignValue);
p23652
aVWere the this argument initializes the Delegate
p23653
aVTarget property and the AssignValue argument initializes the Delegate
p23654
aVMethod property
p23655
aVWhich means that as long as the sampleObj object stays referenced, the form object stays referenced too and won't be garbage collected
p23656
aVHowever, in your case, the only object that has a reference to sampleObj is the form object itself
p23657
aVThe garbage collector has no trouble with circular references like this and will detect that there are no other references to either object
p23658
aVAnd will collect them both at the same time
p23659
aVThere is one (uncommon) exception to this, you'll get in trouble with the sampleObj class generates events after the form is closed
p23660
aVWhich could happen if the event is triggered by something outside of the form, some hardware event for example
p23661
aVThat event could still run code in the form class
p23662
aVYou usually notice this quickly, any attempt to reference a control in the form will throw an ObjectDisposed exception
p23663
as(dp23664
g9
V17034
p23665
stp23666
a((dp23667
g2
(lp23668
VThere is no such list
p23669
aVYou can have a look-see in the install directory, but you won't get them all because Word uses COM servers heavily
p23670
aVAttaching a debugger and looking in the Modules window gets you merely a snapshot of what DLLs happened to be loaded at that particular point in time
p23671
aVThere is no download available for Word components, your customer will have to purchase a retail license
p23672
as(dp23673
g9
V17034
p23674
stp23675
a((dp23676
g2
(lp23677
VYou should be able to use CreateHwndRenderTarget instead, using the control's Handle property
p23678
aVTo do it completely right, create your own control and override the OnHandleCreated() method
p23679
aVAnd override OnPaintBackground() and do nothing
p23680
as(dp23681
g9
V17034
p23682
stp23683
a((dp23684
g2
(lp23685
VReflection has a knack for hiding the forest for the trees
p23686
aVYou never have a problem getting the current method name accurately and quickly:
p23687
aVAlbeit that a refactoring tool probably won't fix it automatically
p23688
aVIf you completely don't care about the (considerable) cost of using Reflection then this helper method should be useful:
p23689
aVUpdate: C# version 5 and
p23690
aVNET 4
p23691
aV5 have the golden solution to this common need, you can use the [CallerMemberName] attribute to have the compiler auto-generate the name of the calling method in a string argument
p23692
aVOther useful attributes are [CallerFilePath] to have the compiler generate the source code file path and [CallerLineNumber] to get the line number in the source code file for the statement that made the call
p23693
as(dp23694
g9
V17034
p23695
stp23696
a((dp23697
g2
(lp23698
VIt uses Microsoft
p23699
aVVisualBasic
p23700
aVCompilerServices
p23701
aVConversions
p23702
aVToDouble()
p23703
aVThat function contains a Select statement on the object's GetTypeCode() return value so it can use a custom converter based on the type of the argument
p23704
aVThe string converter considers the possibility that the string might contain a currency value and does some processing on the string to deal with that
p23705
aVOne allowed format for currency values is a trailing negative sign
p23706
aVThis is not particularly cheap
p23707
aVThe quickest way to achieve the same conversion is:
p23708
as(dp23709
g9
V17034
p23710
stp23711
a((dp23712
g2
(lp23713
VA bitmap records the resolution of the device on which it was created
p23714
aVThe biX/YPelsPerMeter field in the BITMAPINFOHEADER structure for a
p23715
aVbmp file
p23716
aVThis will usually be set to the DPI (Dots Per Inch) setting of your video adapter, after converting it to meters
p23717
aVWhich is normally set to 96 or 120 DPI, 96 being the more common setting
p23718
aVYou can find the setting in the advanced properties tab of your Display applet, on Win7 you see it with Personalize + Display + Set custom text size
p23719
aVThe program that reads the bitmap can use it to resize the image so it has the same physical size on the display device
p23720
aVThe Graphics
p23721
aVDrawImage(Image, Point) overload does this for example
p23722
aVIf the source device was set to 96 DPI and the display device to 120 DPI then the image will be rescaled from 220x220 to 275x275
p23723
aVThis isn't always desirable btw, display monitors do not have a very good resolution, compared to a printer for example
p23724
aVUpscaling the image from 220 to 275 pixels produces noticeable artifacts if the image contains line art
p23725
aVUpscaling on a printer is however always needed, your 220x220 bitmap turns into a postage stamp when printed one-to-one
p23726
aVTo suppress scaling, you'd use the Graphics
p23727
aVDrawImage(Image, Rectangle) overload
p23728
as(dp23729
g9
V17034
p23730
stp23731
a((dp23732
g2
(lp23733
VI get a repro for this
p23734
aVIt is visible in Ildasm
p23735
aVexe, the 2010 compiler marks the metadata as v4
p23736
ag2512
aV30319
p23737
aVYou can also see it with Corflags
p23738
aVexe
p23739
aVThe 2008 build system generates a warning for this, you can see it in the Output window:
p23740
aVwarning MSB3246: Resolved file has a
p23741
aVbad image, no metadata, or is
p23742
aVotherwise inaccessible
p23743
aVChanging the Target Framework to 3
p23744
aV5 fixes the problem, the assembly will now be marked as v2
p23745
ag2512
aV50727, the CLR version used in 2005 and 2008
p23746
aVThe IDE is however not smart enough to detect this change
p23747
aVYou'll have to remove the assembly reference, then put it back in
p23748
aVAnd the yellow exclamation mark is no longer there
p23749
as(dp23750
g9
V17034
p23751
stp23752
a((dp23753
g2
(lp23754
VYou can cleanly solve this with a lambda expression, available in VS2008 and up
p23755
aVA silly example:
p23756
aVFor earlier versions you'll have to make "currentKey" a private field of your class
p23757
aVCheck my code in this thread for a cleaner solution
p23758
as(dp23759
g9
V17034
p23760
stp23761
a((dp23762
g2
(lp23763
VThe trick is to draw the same image again and use a ColorMatrix that inverts the image
p23764
aVFor example:
p23765
aVWhere mImage was my sample 1bpp image and I'm inverting a 100x100 rectangle at 50,50
p23766
as(dp23767
g9
V17034
p23768
stp23769
a((dp23770
g2
(lp23771
VIt's still not very clear, but I assume that the problem is that the Visible property getter returns the actual visibility state of the control
p23772
aVWhich is not just the last assigned value to Visible, it also takes account of whether the parents of the control are visible
p23773
aVIn other words, if you've got a button in a UserControl and the UserControl's Visible = false then the button's Visible will always be false as well
p23774
aVYou can override SetVisibleCore() to find out if the control intends to be visible:
p23775
as(dp23776
g9
V17034
p23777
stp23778
a((dp23779
g2
(lp23780
VThere's a fair amount of lameness here, this just never worked before
p23781
aVIt got "fixed" in VS2010, mt
p23782
aVexe now generates a warning instead of letting this silently go wrong
p23783
aVNot a real fix, and there's not an obvious one, the linker can't just embed the signature and still allow mt
p23784
aVexe to run afterwards
p23785
aVThe solution is to re-sign the assembly with a post-build event
p23786
aVMake it look like this:
p23787
aVCommand = sn -Ra "$(TargetPath)"
p23788
aV$(ProjectName)
p23789
aVsnk
p23790
aVIf you don't already have the key file, you'll need to create the
p23791
aVsnk file yourself, run sn
p23792
aVexe from the Visual Studio Command prompt
p23793
aVfor example:
p23794
aVOr extract it from a container or use your designated key file
p23795
aVDelay signing is just a matter of running sn
p23796
aVexe with the proper command line options
p23797
as(dp23798
g9
V17034
p23799
stp23800
a((dp23801
g2
(lp23802
VTearing is caused by not synchronizing your updates with the monitor's vertical blanking interval
p23803
aVIt's a bit hardware dependent in OpenGL (I think, not an expert), start with looking for glXWaitVideoSyncSGI
p23804
aVGoogling "opengl sync to vblank" pays off too
p23805
as(dp23806
g9
V17034
p23807
stp23808
a((dp23809
g2
(lp23810
VTechnically, yes, an unmanaged app can access any file
p23811
aVThe odds that such an app would just happen to open the file exclusively and lock you out are however vanishingly small
p23812
aVThe directories containing isolated storage files are not found by accident
p23813
aVDon't discount the possibility that it is another instance of your Silverlight app that has the file opened, that's far more likely
p23814
aVHaving a reasonable failure mode for an IOException is always a good idea
p23815
aVA "sorry, couldn't do it" message is acceptable
p23816
as(dp23817
g9
V17034
p23818
stp23819
a((dp23820
g2
(lp23821
VThis is like asking "I want to read half as fast from my hard drive"
p23822
aVOr "I want to use only 50% of the CPU cycles"
p23823
aVDoesn't make sense, it goes as fast as it can
p23824
aVIf more programs compete for the resource then it is up to the operating system to ensure everybody gets a fair share
p23825
aVIf you don't want a fair share then simply lower the thread priority of your thread doing the reading
p23826
aVOr call Sleep()
p23827
as(dp23828
g9
V17034
p23829
stp23830
a((dp23831
g2
(lp23832
VUsing your snippet and running Dumpbin
p23833
aVexe /exports on the DLL produces this output:
p23834
aVNote how the export for the static member is there but has a subtly different name from yours
p23835
aVIf I run your export name through undname
p23836
aVexe, I get:
p23837
aVNote the difference
p23838
aVYou've got an evil macro in your target project
p23839
aVFix your problem by adding this to the header file:
p23840
aVThis might have some side-effects :)
p23841
as(dp23842
g9
V17034
p23843
stp23844
a((dp23845
g2
(lp23846
VYou would have to use the cookie that the server left behind in your cookie cache that identified you as a authenticated user in a previous session
p23847
aVYou'll need to use the Cookie(name, value) constructor
p23848
aVGetting the value is the tricky part, look through your cookie cache to see if you can find one
p23849
aVIt is still going to fail if the server expires the cookie
p23850
aVUsing a tool that lets you look at the HTTP headers and cookie values is important to debug this
p23851
aVFirebug is very nice
p23852
as(dp23853
g9
V17034
p23854
stp23855
a((dp23856
g2
(lp23857
VThat's been a good 20 years since I last laid eyes on that
p23858
aVIt is a low-level graphics output function in BGI (IIRC)
p23859
aVYou'll get the glyph for code 8, a rectangle with a circle in the OEM character set
p23860
aVTo make it act like, say, puts(), you'll have to interpret the control codes yourself
p23861
aVIf you see a backspace (char 8), you'll have to update your internal "cursor position" variable and move x back by the font width
p23862
aVSame for '\u005cn' (increment y) and '\u005cr' (set x to 0)
p23863
as(dp23864
g9
V17034
p23865
stp23866
a((dp23867
g2
(lp23868
VYour error code is not a typical BSOD code
p23869
aVIt is STATUS_PAGEFILE_QUOTA, "The pagefile quota for the process has been exhausted
p23870
aVGetting this on a 64-bit version of Windows is possible
p23871
aV64-bit programs cannot run out of memory, they've got 16 terabytes of virtual memory
p23872
aVThey run out of mappable memory pages first
p23873
aVThe operating system sets an upper limit to how much of the paging file size a program can hog
p23874
aVYou exceeded it
p23875
aVIf it is really a BSOD then it probably ran out of kernel memory pool space, each thread you create needs about 24 KB of memory for the kernel stack
p23876
aVI have to guess that your program is creating way too many threads
p23877
aVKeep any eye on the Threads column in Taskmgr
p23878
aVexe, Processes tab
p23879
aVThe Performance tab shows what's happening to the kernel memory pool
p23880
as(dp23881
g9
V17034
p23882
stp23883
a((dp23884
g2
(lp23885
VYou can do this in C# without needing some external utility
p23886
aVThe trick is to search for the message box dialog and click its OK button
p23887
aVDoing it more than once requires a Timer that keeps searching for such a dialog and clicking it away
p23888
aVAdd a new class to your project and paste this code:
p23889
aVSample usage:
p23890
as(dp23891
g9
V17034
p23892
stp23893
a((dp23894
g2
(lp23895
VThis class should exhibit the same behavior:
p23896
aVSince every class inherits from System
p23897
aVObject, it also inherits the non-virtual Object
p23898
aVGetType() method
p23899
aVRedeclaring the method as virtual (note that not even the "new" keyword is needed) hides the original inherited GetType method
p23900
aVNot sure what this tool requires, but I suppose you'll need to rename the hidden inherited method with something like "Object_GetType"
p23901
as(dp23902
g9
V17034
p23903
stp23904
a((dp23905
g2
(lp23906
VYou make a screenshot with BitBlt()
p23907
aVThe size of the shot is set with the nWidth and nHeight arguments
p23908
aVThe upper left corner is set with the nXSrc and nYSrc arguments
p23909
as(dp23910
g9
V17034
p23911
stp23912
a((dp23913
g2
(lp23914
VIt doesn't make a lot of sense, the original GAC was already quite capable of storing different versions of assemblies
p23915
aVAnd there's little reason to assume a program will ever accidentally reference the wrong assembly, all the
p23916
aVNET 4 assemblies got the [AssemblyVersion] bumped up to 4
p23917
ag2512
ag2512
ag2512
aVThe new in-process side-by-side feature should not change this
p23918
aVMy guess: there were already too many
p23919
aVNET projects out there that broke the "never reference anything in the GAC directly" rule
p23920
aVI've seen it done on this site several times
p23921
aVOnly one way to avoid breaking those projects: move the GAC
p23922
aVBack-compat is sacred at Microsoft
p23923
as(dp23924
g9
V17034
p23925
stp23926
a((dp23927
g2
(lp23928
VDXF files were the universal interop file format in the CAD world, last I looked
p23929
aVThey are pretty easy to parse, it is a simple text format
p23930
aVAnd there is lots of info in the file you can simply skip and still get a recognizable model of the original drawing
p23931
aVThe R12 format was especially easy
p23932
aVAlthough you don't really want to write the code from scratch if you can avoid it
p23933
aVShop around, there are plenty of programmers that have done this before
p23934
aVBe careful to avoid re-inventing a CAD program
p23935
as(dp23936
g9
V17034
p23937
stp23938
a((dp23939
g2
(lp23940
VThis is very unusual, you almost always really care what particular control was clicked
p23941
aVAnd have a MouseDown event that takes a specific action, based on the clicked control
p23942
aVBut you can, you can catch input events before they are dispatched to the control itself
p23943
aVYou need to use the IMessageFilter interface
p23944
aVBest explained with a code sample:
p23945
aVBeware that this filter is active for all forms in your app
p23946
aVYou'll need to filter on the ctl value if you want to make it specific to only one form
p23947
as(dp23948
g9
V17034
p23949
stp23950
a((dp23951
g2
(lp23952
VIt is not that simple
p23953
aVYour catch clause will also catch exceptions raised by the assignment operator for the t object class
p23954
aVThe t object might be partially assigned
p23955
aVNever catch all exceptions and assume that the most likely thing happened
p23956
as(dp23957
g9
V17034
p23958
stp23959
a((dp23960
g2
(lp23961
VAnnotated compile errors:
p23962
aVCode using generic type arguments can only compile if the compiler knows the member of the generic type
p23963
aVIt doesn't know that the Result type argument has a "status" member
p23964
aVIt certainly doesn't if you invoke
p23965
aVYou'll need to use a constraint to make this work
p23966
aVYou already do, but new() isn't strong enough
p23967
aVSomething like "where Result : IResult" for example, where IResult is an interface type that has a status property
p23968
aVOr a base class
p23969
aVThe compiler can now be 100% sure that any allowed concrete instance of the generic method will execute without causing runtime errors
p23970
aVSince it can only ever be compiled when it was invoked with a type that has a "status" property
p23971
aVAll the same applies to the Param type argument
p23972
aVThe usefulness of a generic method here rapidly disappears when you do this, it is not the proper usage
p23973
aVUnless you can leverage IResult, like you can IEnumerable
p23974
as(dp23975
g9
V17034
p23976
stp23977
a((dp23978
g2
(lp23979
VRaising an event, will call its event
p23980
aVhandler
p23981
aVThat started off wrong
p23982
aVThere could be no event handler
p23983
aVOr many
p23984
aVYou don't know
p23985
aVWhich is the major difference from calling a method directly
p23986
aVLook up "observer pattern" in your favorite design patterns book
p23987
as(dp23988
g9
V17034
p23989
stp23990
a((dp23991
g2
(lp23992
VIt is a template function,
p23993
aVYour MSVC compiler doesn't support exportable templates (very few do)
p23994
aVMake sure you defined (not just declared) this function in a header file, not a
p23995
aVcpp file
p23996
as(dp23997
g9
V17034
p23998
stp23999
a((dp24000
g2
(lp24001
VIt's on your machine
p24002
aVIf you've got VS2008 then open c:\u005cprogram files\u005cmicrosoft skds\u005cwindows\u005cv6
p24003
aV0a\u005cwinuser
p24004
aVh and search for the message identifier
p24005
aVNo, you can't use this file in a C# program, it is written in C
p24006
aVThere's a tool available that translated these SDK header files to C#, download the P/Invoke Interop Assistant
p24007
aVClick the "SigImp Search" tab and type the identifier you are looking for
p24008
aVClick Generate to create the C# declaration
p24009
aVIts okay for message identifiers but gets ugly for API functions
p24010
aVThe declarations are auto-translated and are pretty noisy and not always optimal
p24011
aVDouble-check the generated definition with what's available at pinvoke
p24012
aVnet
p24013
as(dp24014
g9
V17034
p24015
stp24016
a((dp24017
g2
(lp24018
VCOM doesn't support inheritance
p24019
aVThe COM interface declarations are defined in the SDK header files with inheritance, but they are intended to be parsed by a C++ compiler
p24020
aVIt does support inheritance
p24021
aVThe concrete implementation of the IPersistFile interface must provide an implementation of all methods, including those from IUnknown and IPersist
p24022
aVIUnknown is taken care of by the CLR
p24023
as(dp24024
g9
V17034
p24025
stp24026
a((dp24027
g2
(lp24028
VObjects in your program have a well defined memory layout, imposed by your compiler
p24029
aVBut that layout is not going to be exactly the same in another program, running on another machine, compiled by a different compiler
p24030
aVAnd it is not typically very compatible with the transport medium, like a network connection or a file
p24031
aVWhich you need to take care of to get the object from one machine to another
p24032
aVFiles and network packets are simple streams of bytes
p24033
aVThat's where serialization comes into play, you'll need to serialize the in-memory object into a stream of bytes
p24034
aVAnd it needs to be de-serialized at the receiving end, back from a stream of bytes into an object
p24035
aVThe obvious way to do so is binary serialization
p24036
aVYou take the bytes for each field in the object and write them to the stream
p24037
aVVery efficient, but also very troublesome
p24038
aVThe first problem you run into is that the receiving end has a different idea of what the object looks like
p24039
aVIt might be compiled with a different version of the object declaration, one that had an added field for example
p24040
aVThe problem is starker when the object is exchanged between different machines
p24041
aVThey may have a very different idea about the number of bytes in an integer
p24042
aVOr the order of the bytes (endian-ness)
p24043
aVThere have been many solutions to this problem
p24044
aVThey typically involve some kind of metadata that describes the fields in the object
p24045
aVThe advent of Unicode made it possible to put both the metadata and the field values into a textual description, XML is the best example of this
p24046
as(dp24047
g9
V17034
p24048
stp24049
a((dp24050
g2
(lp24051
VIf you added the file as a resource in the Project + Properties, Resources tab, you'll get its content by using My
p24052
aVResources:
p24053
aVClick the arrow on the Add Resource button and select Add Existing File, select your data5
p24054
aVtxt file
p24055
as(dp24056
g9
V17034
p24057
stp24058
a((dp24059
g2
(lp24060
VIt knows because it is aware on which thread it was created
p24061
aVThere's an invisible helper window that receives the WM_TIMER message, which in turn triggers the Tick event
p24062
aVThe window has thread affinity, the message loop on the thread dispatches the message
p24063
aVWhich should be the UI thread of your app
p24064
aVMake sure you create this timer on the same thread as the form and its controls
p24065
aVJust drop it on the form or create it in the form or control constructor
p24066
aVYou then just need to set the timer's Enable property to true
p24067
aVThat's thread-safe, you can do this on the scheduler thread
p24068
as(dp24069
g9
V17034
p24070
stp24071
a((dp24072
g2
(lp24073
VPretty bizarre
p24074
aVThe iterator correctly implements IDisposable, it calls FindClose()
p24075
aVThe AllDirectories options could be a source of trouble since FindFileFirst/Next only allows iterating a single directory
p24076
aVBut I'm seeing the iterator doing the right thing, it only keeps a single handle open while iterating the directory structure
p24077
aVThe MSDN article specifically mentions "if there is an open handle that remains on one of the enumerated directories or files"
p24078
aVFindFileFirst/Next won't leave a handle open
p24079
aVBut sloppy user code that reads files while enumerating does
p24080
aV"a delete operation on a file or directory" is relevant too, I think the behavior changed in Vista
p24081
aVA DeleteFile() can succeed but the file won't actually disappear until all handles on the file are closed
p24082
aVWe need somebody to volunteer and not implement this code on XP
p24083
aVI reckon we'll find someone soon :)
p24084
as(dp24085
g9
V17034
p24086
stp24087
a((dp24088
g2
(lp24089
VHangs like these are usually associated with networking
p24090
aVA database perhaps
p24091
aVYou have to watch out for code that runs inside the UserControl at design time
p24092
aVNot just the constructor, also the Load event, timers, OnHandleCreated, OnResize, etcetera
p24093
aVThe way to avoid running that code is by testing the DesignMode property, don't do anything dangerous when it is true
p24094
aVYour ultimate fallback is to debug the code at design time with another instance of Visual Studio
p24095
as(dp24096
g9
V17034
p24097
stp24098
a((dp24099
g2
(lp24100
VYou have to allocate the structures on the heap so you can store a pointer in the hash table:
p24101
aVYou'll also need to use g_hash_table_new_full() so you can properly free the pointers when the table is destroyed
p24102
as(dp24103
g9
V17034
p24104
stp24105
a((dp24106
g2
(lp24107
VYou are getting a multi-dimensional array with a dimension of 1 instead of a vector
p24108
aVThe C# language doesn't allow you to declare an array like that
p24109
aVYou can reference the return value with the Array class, which allows conversion with code similar to this:
p24110
as(dp24111
g9
V17034
p24112
stp24113
a((dp24114
g2
(lp24115
VYou have to be careful to allow the form to resize itself at startup
p24116
aVNecessary to accommodate scaling needed on a machine that has a different video DPI setting or a different system font size
p24117
aVOr a user override that changed the height of the title bar
p24118
aVAll of this is sorted out by the time the Load event runs
p24119
aVThus:
p24120
aVThe next thing you ought to do is fix the behavior of the cursor when the user moves it on an edge of the window that allows resizing the window vertically
p24121
aVThat's a bit ugly, you have to trap the WM_NCHITTEST message with WndProc and change the message return value:
p24122
as(dp24123
g9
V17034
p24124
stp24125
a((dp24126
g2
(lp24127
VThe C++ standard committee will argue over it for 10 years, then reject it
p24128
aVPick a good variable name, myMap is pretty useless:
p24129
aVAnd a good editor so you don't have to type that out completely every time you use the map
p24130
aVFunctional hungarian is essentially the same idea
p24131
as(dp24132
g9
V17034
p24133
stp24134
a((dp24135
g2
(lp24136
VThe math functions are implemented in a library
p24137
aVThe library contains the FPU/SSE2 instructions but additional code is needed to implement the /fp compile option
p24138
aVWhile most CRT code is available as source code in the vc\u005ccrt\u005csrc subdirectory of the VS install directory, that's not the case for the math functions
p24139
aVIt is written by Intel, they probably didn't permit the source to be published
p24140
aVThe library is located in vc\u005ccrt\u005csrc\u005cintel\u005cmt_lib\u005ctran
p24141
aVlib
p24142
aVAt a megabyte, far too much to ever consider disassembling
p24143
aVIf you want to see the assembly, you should build your project with /MT and step into the function with the debugger
p24144
as(dp24145
g9
V17034
p24146
stp24147
a((dp24148
g2
(lp24149
VYou are reading too much in the attribute
p24150
aV[Serializable] does very little
p24151
aVIt is used by binary serialization, as implemented by the BinaryFormatter class
p24152
aVThat class has very powerful capabilities, it can create an instance of a class without using public properties of the class
p24153
aVIt directly assigns values to fields that are marked private, completely bypassing the normal access rules
p24154
aVYou have to explicitly give BinaryFormatter the right to do so, essentially acknowledging that an object of your class can be deserialized without problems
p24155
aVYou do so by applying the [Serializable] attribute
p24156
aVBinaryFormatter merely checks if it is present
p24157
aVThat's all
p24158
as(dp24159
g9
V17034
p24160
stp24161
a((dp24162
g2
(lp24163
VIt is non-standard, you should check the documentation for your CRT implementation
p24164
aVBut it ought to mean that the name refers to a regular file, instead of a pipe, stream, symbolic link, directory or device
p24165
as(dp24166
g9
V17034
p24167
stp24168
a((dp24169
g2
(lp24170
VYou should use Spy++ to take a look at the dialog
p24171
aVThe class name is important and the control ID of the button
p24172
aVIf it is a native Windows dialog then the class name should be "#32770"
p24173
aVIn which case you'll have a lot of use for my post in this thread
p24174
aVHere is another in C#
p24175
aVYou change the button text by P/Invoking SetWindowText() on the button handle
p24176
aVUsage:
p24177
as(dp24178
g9
V17034
p24179
stp24180
a((dp24181
g2
(lp24182
VYes, you'll need to dispose all of the controls in the tab page
p24183
aVThe form isn't special, it is just a child control when you set its TopLevel property to false
p24184
aVMake it look like this:
p24185
aVThe form's Dispose() method will automatically dispose any child controls it has, no additional help is needed
p24186
as(dp24187
g9
V17034
p24188
stp24189
a((dp24190
g2
(lp24191
VYou are on the wrong track with this, it isn't a bit vector
p24192
aVThe message is defined in "octets", better known as "bytes"
p24193
aVAn equivalent C# declaration that you can use with Marshal
p24194
aVPtrToStructure is:
p24195
aVYou'll need to handle the variable length options field separately
p24196
as(dp24197
g9
V17034
p24198
stp24199
a((dp24200
g2
(lp24201
VIt is possible, but not through ProgressBar
p24202
aVNor does Win7 use a PB to draw those meters, there is no window handle associated with the bar
p24203
aVIt must be using custom drawing
p24204
aVThat's possible in WinForms as well with the VisualStyleRenderer class
p24205
aVOne thing that doesn't help however is that the required visual style parts and states are not declared, not even in
p24206
aVNET 4
p24207
ag2512
aVThis sample form reproduces the meter bar:
p24208
aVI got the part and state numbers from the vsstyle
p24209
aVh SDK header file
p24210
as(dp24211
g9
V17034
p24212
stp24213
a((dp24214
g2
(lp24215
VThe DataReceived event is always raised on a threadpool thread
p24216
aVYou cannot update any UI control, you have to use Control
p24217
aVBeginInvoke()
p24218
aVThere is no point testing InvokeRequired, it is always true
p24219
aVA couple of things to keep in mind here:
p24220
aVDon't call Control
p24221
aVBeginInvoke for every single character or byte that you receive
p24222
aVThat will bring the UI thread to its knees
p24223
aVBuffer the data you get from the serial port until you've got a complete response
p24224
aVUsing SerialPort
p24225
aVReadLine() usually works well, a lot of devices send strings that are terminated by a line feed (SerialPort
p24226
aVNewLine)
p24227
aVShutting down your program can be difficult
p24228
aVYou have to make sure to keep the form alive until the serial port stops sending
p24229
aVGetting an event after the form is closed will generate an ObjectDisposed exception
p24230
aVUse the FormClosing event to close the serial port and start a one second timer
p24231
aVOnly really close the form when the timer expires
p24232
aVAvoid using Control
p24233
aVInvoke instead of BeginInvoke
p24234
aVIt can deadlock your program when you call SerialPort
p24235
aVClose()
p24236
aVLots of ways to get in trouble
p24237
aVConsider using your own thread instead using DataReceived to avoid them
p24238
as(dp24239
g9
V17034
p24240
stp24241
a((dp24242
g2
(lp24243
VYou need to iterate the SubItems, not the selected items
p24244
aVFix:
p24245
as(dp24246
g9
V17034
p24247
stp24248
a((dp24249
g2
(lp24250
VSerial ports are very simple devices, dating from the stone age of computing hardware
p24251
aVThey don't support Plug & Play, there is no way to tell that somebody plugged in a device
p24252
aVThe only thing you can do is discover what ports are available, the SerialPort
p24253
aVGetPortNames() returns the list
p24254
aVSome USB emulators can generate a descriptive name to go with the port name, you can discover those with WMI, Win32_SerialPort class
p24255
aVNone of which helps you discover what COM port is connected to a particular device
p24256
aVOnly a human knows, she physically plugged the cable in the connector
p24257
aVYou'll need to provide a config UI that lets the user select the port number
p24258
aVA combo box gets the job done
p24259
aVSave the selection in your config data, it is very likely that the device is still connected to the same port the next time your program starts
p24260
as(dp24261
g9
V17034
p24262
stp24263
a((dp24264
g2
(lp24265
VAdding so many items to a CMS that it requires to be scrolled completely defeats the purpose of a context menu
p24266
aVDon't design a UI that's hard to use and requires the user to scan through dozens of items
p24267
aVYour users will dislike you program with a passion and will find out where you live
p24268
aVA CMS supports sub-menus
p24269
aVCategorize your menu items
p24270
as(dp24271
g9
V17034
p24272
stp24273
a((dp24274
g2
(lp24275
VWorks fine when I try it
p24276
aVThere's really only one failure mode: forgetting to add a using statement for the namespace that contains the extension method:
p24277
as(dp24278
g9
V17034
p24279
stp24280
a((dp24281
g2
(lp24282
VThe private ShouldSerializeXxx() methods are an alternative for the [DefaultValue] attribute
p24283
aVThat attribute cannot always be used since the default value may depend on state that can't be expressed in the DefaultValueAttribute constructor or requires a complex expression
p24284
aVThe method is executed through Reflection, it is exposed through the PropertyDescriptor
p24285
aVShouldSerializeValue() method
p24286
aVImportant clients of this plumbing are the PropertyGrid control (uses it to select a bold font) and the Windows Forms design-time code serializer (uses it to suppress unnecessary code)
p24287
as(dp24288
g9
V17034
p24289
stp24290
a((dp24291
g2
(lp24292
VThe Windows side-by-side cache
p24293
aVBackgrounder info is here, technical reference is here
p24294
aVI haven't seen anybody actually do this yet, other than Microsoft
p24295
aVQuite notable is that MSFT gave up on winsxs deployment for the C/C++ CRT and MFC runtime DLLs for VS2010, it was causing too many problems
p24296
aVThey're back in c:\u005cwindows\u005csystem32
p24297
aVThe managed equivalent of this (the GAC) is going strong though
p24298
aVBetter tool support, probably
p24299
aVI'm fairly sure that by a large margin everybody chooses app-local deployment
p24300
as(dp24301
g9
V17034
p24302
stp24303
a((dp24304
g2
(lp24305
VIt very rarely makes sense to use threads to improve file processing performance
p24306
aVA thread, when run on a multi-core CPU, provides more CPU cycles
p24307
aVThis is rarely the resource you are short of when processing files
p24308
aVYou need more disks
p24309
aVNot an option of course
p24310
aVSmoke test this first
p24311
aVReboot your machine so the file won't be stored in the file system cache
p24312
aVRun your single-threaded program and observe the CPU load
p24313
aVTaskmgr
p24314
aVexe, Performance tab is good for that
p24315
aVIf you don't see one CPU maxed-out at 100% load then adding another CPU cannot make your program quicker
p24316
as(dp24317
g9
V17034
p24318
stp24319
a((dp24320
g2
(lp24321
VYou are using an old version of Visual Studio, Vista is going to treat your program as a "legacy" Windows app
p24322
aVAnd redirect the registry writes you make
p24323
aVInclude a manifest in your program so you'll look Vista-aware
p24324
aVThis manifest is automatically included by VS2008 and up
p24325
aVBeware that this still won't solve the problem for your user, she's very unlikely to run your app with UAC turned off
p24326
aVYou'll need to write a separate app that has a manifest as linked and asks for administrator privileges
p24327
aVIt needs the manifest with requestedExecutionLevel set to requireAdministrator
p24328
as(dp24329
g9
V17034
p24330
stp24331
a((dp24332
g2
(lp24333
VSuspendLayout() isn't going to have an effect, there are no child controls inside an RTB that need to be arranged
p24334
aVRTB is missing the Begin/EndUpdate() methods that most controls have, although it supports it
p24335
aVIt suspends painting, although I'm not so sure it suspends updates to the scrollbar
p24336
aVAdd them as follows:
p24337
aVThe better way to prevent the user from editing text is to set the ReadOnly property to True
p24338
aVRemoving the scrollbar entirely is possible too by overriding CreateParams
p24339
as(dp24340
g9
V17034
p24341
stp24342
a((dp24343
g2
(lp24344
VThis falls in the category of "how can you not know"
p24345
aVIt is your code that is calling ErrorProvider
p24346
aVSetError(), you should have no trouble keeping track of how many errors are still active
p24347
aVHere's a little helper class, use its SetError() method to update the ErrorProvider
p24348
aVIts Count property returns the number of active errors:
p24349
as(dp24350
g9
V17034
p24351
stp24352
a((dp24353
g2
(lp24354
V"Unique" and file names based timestamps are contradictory requirements
p24355
aVIt falls apart when the machine gets faster
p24356
aVWorkarounds that try to check if the file already exists fall apart when more of one instance of your program runs
p24357
aVOnly Path
p24358
aVGetTempFileName() can guarantee a completely unique name
p24359
aVUse FileInfo
p24360
aVCreationTimeUtc to find the last one
p24361
as(dp24362
g9
V17034
p24363
stp24364
a((dp24365
g2
(lp24366
VA group box, like any control, will paint itself when Windows sends it the WM_PAINT message
p24367
aVYou can indeed use Control
p24368
aVCreateGraphics() to draw yourself, bypassing the normal paint logic
p24369
aVBut that's not going to last and will randomly disappear when Windows decides that the control needs to repaint itself again
p24370
aVWhich is obvious when you minimize the form and restore it
p24371
aVLess obvious on Vista and Win7 with Aero enabled, repaints are not necessary when your form is overlapped by another window
p24372
aVBut it will be quite obvious on XP or with Aero disabled
p24373
aVYou cannot make this work reliably, you have to use the Paint event
p24374
aVNot your form's, the group box controls'
p24375
aVCall its Invalidate() method to force it to repaint when the color changes
p24376
as(dp24377
g9
V17034
p24378
stp24379
a((dp24380
g2
(lp24381
V"z" is fine in C# 4
p24382
aV0,  is covariant
p24383
aVis however not, you cannot make "y" work
p24384
aVIntuitively, if it were then this would be valid:
p24385
aVWhich breaks the promise that "list" can only contain  elements
p24386
as(dp24387
g9
V17034
p24388
stp24389
a((dp24390
g2
(lp24391
VAll modern programs use OleSetClipboard to publish clipboard formats and data
p24392
aVStart reading here
p24393
as(dp24394
g9
V17034
p24395
stp24396
a((dp24397
g2
(lp24398
VYes, the shaded boxes have those byte codes, in code page 1252
p24399
aVWhich no doubt is the default code page for the printer, 1252 is the Windows code page for Western Europe and the Americas
p24400
aVYou'll have to send a command to switch the code page to 850
p24401
aVJudging from the manual, that requires ^CI to select character set 13
p24402
aVKeeping the code page at 1252 and changing your character codes instead would be wise
p24403
aVThe glyph tables are in the back of the manual
p24404
as(dp24405
g9
V17034
p24406
stp24407
a((dp24408
g2
(lp24409
VYou are using the old VB6 COM interfaces
p24410
aVThere isn't any evidence in your code snippet of you ever calling Close() on the RecordSet
p24411
aVYou can't call Close() on the Connection since you set it to Nothing
p24412
aVAs written, Excel won't exit until the garbage collector runs and the finalizer thread releases the reference counts on the COM interfaces
p24413
aVWhich can take a long time if your program doesn't exit or goes dormant after processing the data
p24414
aVYou really should consider uplifting this code to use the classes in System
p24415
aVData
p24416
aVOledb so you can properly Dispose() everything when you're done with the objects
p24417
aVThe Q&D; solution is to force the finalizer thread to run:
p24418
aVRun this after you're done using the RecordSet
p24419
aVIt isn't otherwise recommended
p24420
as(dp24421
g9
V17034
p24422
stp24423
a((dp24424
g2
(lp24425
VEvents are not the proper choice here
p24426
aVThe parent never has a problem figuring out what child controls need to be notified
p24427
aVSimply add a public method to the UC, like UpdateMessage()
p24428
aVThe parent can directly call them
p24429
aVReserve events for being able to notify listeners when you have no idea what listeners might be interested
p24430
aVHaving a "reverse event" like you're contemplating is unhealthy, it keeps a reference on the form
p24431
aVA form should never be referenced so that it can get garbage collected when it closes
p24432
aVThat isn't a real problem here, since the reference is held by a child control, but the principle holds
p24433
as(dp24434
g9
V17034
p24435
stp24436
a((dp24437
g2
(lp24438
VBecause of a "publisher policy" that redirects requested DLL versions
p24439
aVYour manifest should not ask for 762 anymore, it's got cooties
p24440
aVYou'll need to deploy the security update to your machine so the vc\u005cinclude\u005ccrtassem
p24441
aVh gets updated
p24442
as(dp24443
g9
V17034
p24444
stp24445
a((dp24446
g2
(lp24447
VThe problem is the "myForm" reference
p24448
aVIt is a reference to an instance of Form1 that isn't visible and doesn't match the one that the user is looking at
p24449
aVIt can't be a match, you created a new one
p24450
aVWhatever class needs to update the form must have a constructor that takes a Form1 reference
p24451
aVYou can create the class object in your Form1 constructor or Load event, pass "this"
p24452
aVUsing Application
p24453
aVOpenForms[0] is another way to get the reference, one you should not use
p24454
as(dp24455
g9
V17034
p24456
stp24457
a((dp24458
g2
(lp24459
VLet's assume you have a "game loop" that updates the object you're moving with the keyboard
p24460
aVThe KeyDown event should change the object state to "moving upwards"
p24461
aVAnd your loop then gives it new positions each time it runs
p24462
aVThe KeyUp event should change the state back to "idle"
p24463
aVIff the state is still "moving upwards"
p24464
aVYou now no longer depend on a keystroke repeating to keep the object moving
p24465
aVAnd will have no trouble with the player pressing multiple keys at the same time
p24466
as(dp24467
g9
V17034
p24468
stp24469
a((dp24470
g2
(lp24471
VIt goes to the Output window when you run this code in Visual Studio
p24472
aVIt goes in the bit-bucket if you don't
p24473
aVIt goes to a console window if you change the application type
p24474
aVProject + Properties, Application tab, Output type = "Console Application"
p24475
aVNot exactly useful
p24476
as(dp24477
g9
V17034
p24478
stp24479
a((dp24480
g2
(lp24481
VThe debugger can get gimpy now and then
p24482
aVBut the expected case of getting "Could not be evaluated" is a Release build
p24483
aVSimple properties like this get optimized away by the JIT compiler
p24484
aVThe property getter code would not even be present
p24485
as(dp24486
g9
V17034
p24487
stp24488
a((dp24489
g2
(lp24490
VThe
p24491
aVjpeg file format is a lossy format, it throws information away
p24492
aVWhich makes for good compression ratios
p24493
aVThe
p24494
aVgif file format is not lossy but loses other information, it only supports 256 colors
p24495
aVThe
p24496
aVpng file format is not lossy and preserves the color range
p24497
as(dp24498
g9
V17034
p24499
stp24500
a((dp24501
g2
(lp24502
VThe nudge is UITypeEditor, it allows you to create a custom editor for any kind of property, including collections
p24503
aVMany examples in the framework, keep Reflector handy
p24504
as(dp24505
g9
V17034
p24506
stp24507
a((dp24508
g2
(lp24509
VSetThreadExecutionState
p24510
aVThere's no Get and it doesn't take a thread handle
p24511
aVDone
p24512
as(dp24513
g9
V17034
p24514
stp24515
a((dp24516
g2
(lp24517
VYou are completely on the wrong track with this
p24518
aVThe t object is not a COM interface pointer, it is a
p24519
aVNET object reference
p24520
aVA COM interface pointer (and its v-table) doesn't get created until unmanaged code creates the CCW (COM Callable Wrapper)
p24521
aVIt has to be unmanaged code, the CLR interop layer doesn't permit managed code to create a CCW
p24522
aVThe only way to keep this thread moving is by explaining why you want to do this
p24523
as(dp24524
g9
V17034
p24525
stp24526
a((dp24527
g2
(lp24528
VThere's the Marshal
p24529
aVAddRef() method, wrong reference count change though
p24530
aVI'm pretty sure incrementing the RCW count directly is not possible
p24531
aVDig yourself out of the deep hole you're in and fix the old code
p24532
as(dp24533
g9
V17034
p24534
stp24535
a((dp24536
g2
(lp24537
VAre you passing a struct instead of a class object
p24538
aVStructs are value types, you'll get a copy back of the first version of it
p24539
aVChanges you make will be lost since the state doesn't get passed by ref in the callback
p24540
aVUsing a class instead of a struct is the simple solution
p24541
aVStoring the state object in your own class is another approach
p24542
as(dp24543
g9
V17034
p24544
stp24545
a((dp24546
g2
(lp24547
VIt is a compromise, not an entirely unreasonable one
p24548
aVThe passed argument has to be rounded to deal with the resolution of DateTime
p24549
aVRounding to the accuracy of a tick (100 nanoseconds) is a problem
p24550
aVDouble doesn't have enough significant digits to be able to span the full range of possible dates
p24551
aV10000 years x 365 x 24 x 3600 x 1000 x 10000 = 3E18, double has only 15 significant digits
p24552
aVThere is no problem by rounding to a millisecond, 3E14 is just good enough (what are the odds
p24553
aVThe workaround is simple, just use AddTicks(1
p24554
aV5 * 10000)
p24555
as(dp24556
g9
V17034
p24557
stp24558
a((dp24559
g2
(lp24560
VThis doesn't need fixing, the interop wrapper created from the type library will be fine
p24561
aVThe ComTypes
p24562
aVIStream declaration is there to allow managed code to implement a COM server that implements an IStream or takes one as an argument
p24563
aVLots of
p24564
aVNET framework classes do
p24565
as(dp24566
g9
V17034
p24567
stp24568
a((dp24569
g2
(lp24570
VIt isn't likely that a BackgroundImage slows down your form dramatically
p24571
aVAt least on a modern machine
p24572
aVHowever, it does become a lot more noticeable that your form was slow to begin with
p24573
aVThe time taken to render the controls is a lot more visible, especially when the background image is dark
p24574
aVThe effect is called "flicker", albeit that it isn't the traditional source of flicker
p24575
aVMy post in this thread shows a few cures for it
p24576
as(dp24577
g9
V17034
p24578
stp24579
a((dp24580
g2
(lp24581
VWell, no, it doesn't get to be mix-mode until you tell the C++/CLI compiler that your legacy DLL was written in unmanaged code
p24582
aVWhich should have been noticeable, you should have gotten linker errors from the unmanaged DLL exports
p24583
aVYou need to use #pragma managed:
p24584
as(dp24585
g9
V17034
p24586
stp24587
a((dp24588
g2
(lp24589
VSetting the HotTracking property to true hides the focus rectangle
p24590
aVThis repro-ed the Explorer style on my Win7 machine:
p24591
aVBeware that getting the items underlined is a side-effect
p24592
as(dp24593
g9
V17034
p24594
stp24595
a((dp24596
g2
(lp24597
VYou'll have to assume certain responsibilities to get command-line compiling right
p24598
aVThat includes uses the correct /reference options and making sure that the correct version of csc
p24599
aVexe gets started so it uses the correct
p24600
aVrsp file
p24601
aVThe real source of the warning (which you should not ignore) is unguessable if you don't post the command line that you used
p24602
as(dp24603
g9
V17034
p24604
stp24605
a((dp24606
g2
(lp24607
VLinking the source of your quote is important
p24608
aVI have to assume it talks about an old version of
p24609
aVNET, perhaps version 1
p24610
ag22731
aVIt tried to be "tolerant" of unhandled exceptions, swallowing them without a squeak
p24611
aVThat did not work out well, chunks of code silently failing is extraordinarily hard to debug
p24612
aVThe
p24613
aVNET 2
p24614
aV0 version put an end to that, the default CLR host terminates the app for any unhandled exception
p24615
aVAn exception in a finalizer is fatal
p24616
as(dp24617
g9
V17034
p24618
stp24619
a((dp24620
g2
(lp24621
VWindows provides a way to do this, you can tinker with the system menu
p24622
aVProvides for nice feedback as well, the close button will actually look disabled
p24623
aVYou can disable the SC_CLOSE command in the system menu
p24624
aVBest demonstrated with a sample form, get started by dropping a button on it:
p24625
as(dp24626
g9
V17034
p24627
stp24628
a((dp24629
g2
(lp24630
VYou're in for a fair amount of pain, it depends on the operating system version
p24631
aVThe full list is available here
p24632
as(dp24633
g9
V17034
p24634
stp24635
a((dp24636
g2
(lp24637
VYou'll need to subscribe the event for the specific domain
p24638
aVYou also can't rely on the domain get unloaded at termination time
p24639
aVRemove the comment from this code to see that:
p24640
as(dp24641
g9
V17034
p24642
stp24643
a((dp24644
g2
(lp24645
VThat's what RichTextBox
p24646
aVGetLineFromCharIndex() does
p24647
aVPass the SelectionStart property value
p24648
as(dp24649
g9
V17034
p24650
stp24651
a((dp24652
g2
(lp24653
VOh joy, a runtime error mixed with a compile time error
p24654
aVMessageQueue uses XML serialization to serialize objects that are not Message
p24655
aVIf you haven't use sgen
p24656
aVexe to create a serialization assembly at build time (you really should) then it generates the assembly at runtime
p24657
aVClearly that fails, whatever object you are passing to Send() does not support XML serialization
p24658
aVJudging from the error message, that might be because it is not a simple
p24659
aVNET class
p24660
aVSolve it by making it a simple
p24661
aVNET class, one that survives XmlSerializer
p24662
aVSerialize() and back
p24663
as(dp24664
g9
V17034
p24665
stp24666
a((dp24667
g2
(lp24668
VWindows Forms is in maintenance mode
p24669
aVEvery framework release included some changes to it, but they are all changes that were only made to tighten up security or ensure it stays compatible with new releases of Windows
p24670
aVThe linked blog post shows new classes that are internal and not usable from your own code
p24671
aVVisualStyleElement
p24672
aVExplorerTreeView helps PropertyGrid draw the Vista style treeview with triangles for the nodes
p24673
aVThe CompatibleFrameWork stuff is all in the internal System
p24674
aVDeployment namespace, I think it is there to help ClickOnce deal with the
p24675
aVNET 4
p24676
aV0 version and the Target Framework setting in the project's Application tab
p24677
aVWF is feature complete, it's going to stay the way it is for the foreseeable future
p24678
as(dp24679
g9
V17034
p24680
stp24681
a((dp24682
g2
(lp24683
VThe  keyword was explicitly invented to prevent you from doing what you want to do
p24684
aVIt makes the  object for the event inaccessible so nobody can mess with the events handlers
p24685
aVWindows Forms puts an extra layer of security in place so it becomes difficult even if you use Reflection
p24686
aVIt stores  instances in an  with a secret "cookie", you'd have to know the cookie to dig the object out of the list
p24687
aVWell, don't go there
p24688
aVIt is trivial to solve your problem with a bit of code on your end:
p24689
as(dp24690
g9
V17034
p24691
stp24692
a((dp24693
g2
(lp24694
VIt's been too long ago, but I do remember that the native execution model for Visual Basic was interpreted P-code
p24695
aVSomewhere around the VB4 era, it started supporting compiling to native machine code
p24696
aVMostly to stay competitive with Borland's Delphi, IIRC
p24697
aVP-code will be loaded as data and is much more compact than machine code
p24698
aVAnd much slower
p24699
aVMachine code will be loaded like any DLL in Windows, a memory mapped file page-faults the code into memory
p24700
as(dp24701
g9
V17034
p24702
stp24703
a((dp24704
g2
(lp24705
VIID_IWebLocator
p24706
aVWhat's that
p24707
aVWhat is the HRESULT you get
p24708
aVSample code is here, also note the CoInitializeSecurity() call
p24709
as(dp24710
g9
V17034
p24711
stp24712
a((dp24713
g2
(lp24714
VThis is not possible
p24715
aVYou'll need to gain admin privileges by including a manifest in the app
p24716
aVGoogle "requireAdministrator" to find the manifest you'll need
p24717
aVYour user will probably quickly tire of doing this over and over again, your best bet is to spin-off the task that requires these privileges into a separate process
p24718
aVA service for example
p24719
as(dp24720
g9
V17034
p24721
stp24722
a((dp24723
g2
(lp24724
VDeserializing them requires code like this:
p24725
aVWhere TestAClass is the type of TestASettings
p24726
aVYou'll need to reset the stream in your serialization code, set the Position back to 0
p24727
as(dp24728
g9
V17034
p24729
stp24730
a((dp24731
g2
(lp24732
VUse XmlWriter
p24733
aVCreate() to create the writer and specify the format
p24734
aVThis worked well:
p24735
as(dp24736
g9
V17034
p24737
stp24738
a((dp24739
g2
(lp24740
VYou can't tinker with SplitContainer at all
p24741
aVOne possibility is to eliminate it entirely if you are only using it to resize a control
p24742
aVYou could use mouse events on the control itself instead
p24743
aVDrop a TreeView on a form and dock it on the left
p24744
aVSubscribe to the MouseDown/Move/Up events and write something like this:
p24745
as(dp24746
g9
V17034
p24747
stp24748
a((dp24749
g2
(lp24750
VThe FootballLeagueDatabase class must be public to allow a client of your code to call the MainMenu() method
p24751
aVThe error says that it isn't public
p24752
aVPut "public" in front of the class declaration
p24753
aVOr consider if you really intended to make MainMenu() public
p24754
aVIt quacks like a method that should be internal
p24755
as(dp24756
g9
V17034
p24757
stp24758
a((dp24759
g2
(lp24760
VThe GotFocus/LostFocus events are generated by Windows messages, WM_SETFOCUS and WM_KILLFOCUS respectively
p24761
aVThey are a bit troublesome, especially WM_KILLFOCUS which is prone to deadlock
p24762
aVThe logic inside Windows Forms that handles the validation logic (Validating event for example) can override focus changes
p24763
aVIn other words, the focus actually changed but then the validation code moved it back
p24764
aVThe logical state of your UI is that it never moved and you shouldn't be aware that it did
p24765
aVThe Enter/Leave events avoid the kind of trouble these low-level focus change notification events can cause, they are generated when Winforms has established the true focus
p24766
aVYou almost always want to use these
p24767
as(dp24768
g9
V17034
p24769
stp24770
a((dp24771
g2
(lp24772
VUse the Application
p24773
aVStartupPath property, it always points to your EXE
p24774
aVYou'll want to make sure the report gets copied to your bin\u005cDebug\u005cReports folder as well so it will work in the IDE
p24775
as(dp24776
g9
V17034
p24777
stp24778
a((dp24779
g2
(lp24780
VThis is not the right way to do this
p24781
aVFirst off, there is nothing exceptional about a user mis-typing something
p24782
aVSecondly, this extension method is liable to be called deeply nested in some kind of code that works with, say, the database
p24783
aVYou have to catch the exception, since a typing mistake is normal
p24784
aVBut you now also have the burden of writing the exception handler and a bunch of code that properly restores the state of the program
p24785
aVValidating user input should happen early, before you set off a train of code that is hard to stop
p24786
aVAnd there's no reason to use exceptions in user input validation, a simple if() statement gets the job done
p24787
aVYou can now leave the throw statement in place, if you wish, it does make for a better diagnostic
p24788
aVBut you should never handle that exception because now it diagnoses a bug in your code
p24789
aVAnd you can't fix bugs with catch clauses
p24790
as(dp24791
g9
V17034
p24792
stp24793
a((dp24794
g2
(lp24795
VProject + Properties, Application tab, change Output type to "Windows application"
p24796
aVNo more console window
p24797
as(dp24798
g9
V17034
p24799
stp24800
a((dp24801
g2
(lp24802
VOverriding DGV behavior is usually a huge pain in the neck
p24803
aVGot this going pretty quickly though
p24804
aVAdd a new class to your form and paste the code shown below
p24805
aVCompile
p24806
aVDrop the new control from the top of the toolbar onto a form
p24807
aVImplement the ScrollbarVisibleChanged event
p24808
as(dp24809
g9
V17034
p24810
stp24811
a((dp24812
g2
(lp24813
VRelative paths are relative to WebBrowser
p24814
aVUrl
p24815
aVWhich, when you load the HTML directly, either through DocumentStream or DocumentText is about:blank
p24816
aVThat's not going to help WB find the file, you must use an absolute path
p24817
aVTinkering with the Url property is not an option
p24818
aVConsider using Html Agility Pack to tinker with the file content before assigning it to the DocumentText property
p24819
aVUse Path
p24820
aVGetFullPath() to translate relative paths
p24821
as(dp24822
g9
V17034
p24823
stp24824
a((dp24825
g2
(lp24826
VYou are getting all these small Click event handlers because you used the designer to create the event handlers
p24827
aVIt is easy to get rid of them if you write the event assignment yourself
p24828
aVFor example:
p24829
aVIf you're still on C# 2
p24830
aV0 then you can use an anonymous method:
p24831
as(dp24832
g9
V17034
p24833
stp24834
a((dp24835
g2
(lp24836
VTryCast and DirectCast are casting operators that directly map to the CLR's support for casting
p24837
aVThey can quickly cast an object of a base type to a derived type or unbox a value of a value type
p24838
aVDirectCast throws an exception when the cast isn't possible, TryCast returns Nothing if it failed
p24839
aVYou typically want to favor DirectCast to catch programming mistakes
p24840
aVCType allows a superset of conversions, ones that the CLR frowns on
p24841
aVThe best example I can think of is converting a string to a number or date
p24842
aVFor example:
p24843
aVWhich you'll have to use if Option Strict On is in effect
p24844
aVIf it is Off then you can do it directly:
p24845
aVVery convenient of course and part of VB
p24846
aVNET's legacy as a dynamically typed language
p24847
aVBut not without problems, that date is Unicorn day at stackoverflow
p24848
aVcom but will be a day in January when a Briton enters the string
p24849
aVUnexpected conversions is the reason the CLR doesn't permit these directly
p24850
aVThe explicit, never a surprise conversion looks like this:
p24851
aVWhether you should buy into Try/DirectCast vs CType vs explicit conversions is rather a personal choice
p24852
aVIf you now program with Option Strict On then you should definitely start using Try/DirectCast
p24853
aVIf you favor the VB
p24854
aVNET language because you like the convenience of dynamic typing then don't hesitate to stay on CType
p24855
as(dp24856
g9
V17034
p24857
stp24858
a((dp24859
g2
(lp24860
VWell, you found a loop hole, the CLR permits it since all overlapped fields are objects
p24861
aVAnything that would allow you to mess with an object reference directly gets rejected with a TypeLoadException:
p24862
aVBut you can exploit it by giving the classes fields
p24863
aVNothing really bad happens as long as you are just reading the field values, you can get the value of the tracking handle that way for example
p24864
aVWriting those fields however leads to an ExecutionEngineException
p24865
aVI think however that it is an exploit if you can guess the value of a tracking handle correctly
p24866
aVPractical use is sufficiently close to zero though
p24867
as(dp24868
g9
V17034
p24869
stp24870
a((dp24871
g2
(lp24872
VYou haven't found a clean way
p24873
aVClose your form while the download is taking place and behold the kaboom you'll get
p24874
aVYou'll have to at least set the form's Enabled property to False
p24875
aVLook at the BackgroundWorker class to do this cleanly
p24876
as(dp24877
g9
V17034
p24878
stp24879
a((dp24880
g2
(lp24881
VYou can do it type-safe without casting by using a lambda:
p24882
as(dp24883
g9
V17034
p24884
stp24885
a((dp24886
g2
(lp24887
VNo happy answers here, Windows Explorer doesn't have an easily way to get it to start your program passing all selected files
p24888
aVThat requires a shell context menu handler, they are very difficult to write in managed code
p24889
aVAnd up to
p24890
aVNET 4
p24891
aV0 could not be safely written
p24892
aVIt is nevertheless easy to simulate it with the application framework available in VB
p24893
aVNET, make your app a singleton and implement the StartupNextInstance event
p24894
aVThe only issue is that this is not particularly fast
p24895
aVAnd that it doesn't work in console mode apps
p24896
as(dp24897
g9
V17034
p24898
stp24899
a((dp24900
g2
(lp24901
VHmya, watch out for micro-optimizations like this
p24902
aVIt is incredibly hard to make them pay off with modern computing hardware
p24903
aVThe true cost of the I/O involved with handling XML is not the amount of data, it is locating it
p24904
aVBytes are cheap, transmitting them is highly optimized already
p24905
aVIt is a disk drive read head grinding away on a server somewhere, perhaps on your own machine, that determines how fast your program runs
p24906
aVOnce it is in the right spot, reading a byte is very nearly as expensive as reading a kilobyte
p24907
aVMemory works the same way
p24908
aVThe ultimate hint: if it would be a common optimization, they would have come up with something better than IXmlSerializable
p24909
as(dp24910
g9
V17034
p24911
stp24912
a((dp24913
g2
(lp24914
VImage processing like this is expensive, there are a lot of bits to look at
p24915
aVIn real applications, you almost always need to filter the image to get rid of artifacts induced by imperfect image captures
p24916
aVA common library used for this kind of bit whacking is OpenCV, it takes advantage of dedicated CPU instructions available to make this fast
p24917
aVThere are several
p24918
aVNET wrappers available for it, Emgu is one of them
p24919
as(dp24920
g9
V17034
p24921
stp24922
a((dp24923
g2
(lp24924
VI don't like either
p24925
aVConverting object to a specific type is fraught with trouble, it should never be hidden in an expression
p24926
aVI'd much prefer that, if it bombs, then it does so on a specific statement
p24927
aVAnd to make it absolutely obvious to a reader of the code that this conversion is being done
p24928
aVSo, at the very minimum:
p24929
as(dp24930
g9
V17034
p24931
stp24932
a((dp24933
g2
(lp24934
VYou'll have to copy the files, you'll want your program to operate the same way after it is deployed
p24935
aVThe simplest way to do so is by adding them to your project
p24936
aVIn the Properties window, set Build Action = None, Copy to Output Directory = Copy if Newer
p24937
aVThe latter setting ensures that you don't waste time copying the files over and over again
p24938
aVThis ensures that the files will be present in the same directory as your EXE
p24939
aVBoth when you debug and after you deploy it
p24940
aVSimply use Application
p24941
aVStartupPath to locate them
p24942
aVCreating the Setup project for the app is now very simple as well
p24943
aVNote that if the files are small you really want to embed them as resources
p24944
as(dp24945
g9
V17034
p24946
stp24947
a((dp24948
g2
(lp24949
VYes
p24950
aVThe standard COM string type is BSTR
p24951
aVIt is a Unicode string encoded in UTF16, just like Windows' native string type
p24952
aVNo, a COM method isn't going to understand a UTF8 string, it will turn it into Chinese
p24953
aVUTF8 is a good encoding for a text file, not for programs manipulating strings in memory
p24954
aVUTF8 requires anywhere between 1 and 4 bytes to encode a Unicode codepoint
p24955
aVVery incompatible with basic string manipulations like getting the size or indexing a character
p24956
aVC and C++ programs tend to use 8-bit encodings, compatible with the "char" type
p24957
aVThat's an old practice, dating back from an era before Unicode was around
p24958
aVThere's nothing attractive about it, there are many 8-bit encodings
p24959
aVThe typical problem is that data entered as text can only be interpreted correctly if it is read by a program that uses the same 8-bit encoding
p24960
aVIn other words, when the computers are less than 1000 miles apart
p24961
aVLess in Europe
p24962
as(dp24963
g9
V17034
p24964
stp24965
a((dp24966
g2
(lp24967
VImaging data can easily exceed 4 GiB
p24968
aV;)
p24969
aVIt can't, x64 code has a +/-2 GB offset restriction
p24970
aVOne of the reasons you can't allocate arrays larger than 2GB in
p24971
aVNET
p24972
aVThis restriction exists in unmanaged 64-bit C/C++ code as well
p24973
aVThere are libraries that work around this restriction, like WIC, but addressing all of the bitmap bits directly doesn't make sense when you use them
p24974
aVNevertheless, it is possible to generate such an address by casting IntPtr to long in C#:
p24975
as(dp24976
g9
V17034
p24977
stp24978
a((dp24979
g2
(lp24980
VClearly it is not the right way to abort that particular thread, the exception tells you so
p24981
aVThe message shows that you are using a COM object on that thread
p24982
aVMaybe something like Microsoft Excel
p24983
aVRunning COM objects on a worker thread is troublesome, they very commonly have strict threading requirements
p24984
aVOne of which is that they are not thread-safe and have "apartment threading" affinity
p24985
aVAn expensive word for "all your method calls on the object will run on the UI thread anyway"
p24986
aVWhich makes it slower, defeating the advantages of threading completely
p24987
aVAnyhoo, don't use Reflection to find your threads back, use the Thread field in your class directly
p24988
aVAnd make sure you shut down the thread in a controlled way rather than pulling the rug
p24989
aVThis thread shows an example
p24990
as(dp24991
g9
V17034
p24992
stp24993
a((dp24994
g2
(lp24995
VYou have complete control by overriding the OnPaint() method
p24996
aVUse TextRenderer
p24997
aVDrawText() to get it exactly the way you want it
p24998
as(dp24999
g9
V17034
p25000
stp25001
a((dp25002
g2
(lp25003
VThere's something wrong with your setup of Visual Studio, it should never have any trouble finding and running rc
p25004
aVexe
p25005
aVFirst thing to check if the file is there
p25006
aVIt should be located in c:\u005cprogram files\u005cmicrosoft sdks\u005cwindows\u005cv6
p25007
aV0a\u005cbin\u005crc
p25008
aVexe
p25009
aVNext thing to check is that the paths are set properly
p25010
aVTools + Options, Projects and Solutions, C++ Directories
p25011
aVUpper right: Show directories for = Executable files
p25012
aVVerify that $(WindowsSdkDirs)\u005cbin is listed there
p25013
aVTry adding the folder name explicitly
p25014
aVIf the latter step works then your registry is messed up
p25015
aVDespair a bit, rerun Setup
p25016
aVexe and choose Repair
p25017
as(dp25018
g9
V17034
p25019
stp25020
a((dp25021
g2
(lp25022
VBecause unsigned integers are not CLS compliant
p25023
aVThere are languages that are missing support for them, Java would be an example
p25024
as(dp25025
g9
V17034
p25026
stp25027
a((dp25028
g2
(lp25029
VIt is not true, you can't see it because the code is wrong
p25030
aVIt should be:
p25031
aVYou can usually make string concatenation more efficient by using StringBuilder
p25032
aVHowever, that can only do a better job with so few strings if you can accurately guess the Capacity you need
p25033
aVYour specific code however gets optimized by the compiler to an overload of String
p25034
aVConcat() that takes multiple strings
p25035
aVWhich uses an internal high-speed concatenator, impossible to beat with StringBuilder
p25036
aVTake advantage from the composite formatting feature available in String
p25037
aVFormat:
p25038
aVQuick and readable
p25039
as(dp25040
g9
V17034
p25041
stp25042
a((dp25043
g2
(lp25044
VIt is sugar
p25045
aVThe kind of sugar that really comes in handy when you have to write this:
p25046
aVWhat
p25047
aVYou have to use the new keyword to remove an event handler
p25048
aVYes, you do
p25049
aVThe VB
p25050
aVNET team really pained about this, they decided for a completely different syntax:
p25051
aVEven the above C# statement is sugar, the real code looks like this:
p25052
aVWhere "remove" is the accessor function for an event
p25053
aVAnd "this" is required to initialize the Delegate
p25054
aVTarget property
p25055
aVNow it is obvious that it is actually a method call and using the new keyword suddenly makes sense again
p25056
aVHiding "this" has some disadvantages too, it isn't obvious anymore that an event subscription will prevent an object from getting garbage collected
p25057
as(dp25058
g9
V17034
p25059
stp25060
a((dp25061
g2
(lp25062
VWell, assigning the Text property takes about 0
p25063
aV6 nanoseconds, give or take
p25064
aVIt is the side effects that are expensive
p25065
aVYou've probably got the AutoSize property turned on for the labels
p25066
aVSo it needs to create the font handle, render the text in a temporary device context, measure the resulting string, taking account for side-effects due to TrueType hinting that artificially stretches the letter shape so it coincides with a pixel on the monitor, also adjusting for the modified ABC metrics to make ClearType work
p25067
aVThen tell the native Windows control that it needs to change its window size
p25068
aVWhich will produce paint events for the label as well as the container control that's the parent of the label control
p25069
aVWhich goes through the same routine again, now actually drawing pixels
p25070
aVWhich, when Aero is enabled, changes bytes in a memory device context which needs to be blitted to the video device driver that actually updates the video memory so that the user can see the result
p25071
aVYeah, that takes time
p25072
aVSpeed it up by writing your own code instead of Windows Forms doing it for you
p25073
aVOverride the OnPaint event, use TextRender
p25074
aVDrawText to draw the labels
p25075
aVQuick win there, it is easily 50 times faster
p25076
aVMinus the point-and-click convenience of the designer though
p25077
as(dp25078
g9
V17034
p25079
stp25080
a((dp25081
g2
(lp25082
VOverriding the Disposing method and calling it from the finalizer will get the job done
p25083
aVNote that you'll want to release the resources in both cases
p25084
aVThus:
p25085
as(dp25086
g9
V17034
p25087
stp25088
a((dp25089
g2
(lp25090
VThe native Windows control that is wrapped by TrackBar has an awkward restriction, you cannot get the positions for the first and last tic marks
p25091
aVYou can however get the display rectangles for the channel and the slider
p25092
aVThis class returns them:
p25093
aVHere is a sample usage in a form, it draws a line from the first tick mark to the slider pointer:
p25094
as(dp25095
g9
V17034
p25096
stp25097
a((dp25098
g2
(lp25099
VIt's because you turned it into a child control by setting its TopLevel property to false and adding it to the parent's Control collection
p25100
aVReplace this:
p25101
aVwith this:
p25102
aVBeware that the CMS will overlap the text box if it is too tall
p25103
as(dp25104
g9
V17034
p25105
stp25106
a((dp25107
g2
(lp25108
VSet the DataGridView
p25109
aVAutoSizeRowsMode to AllCells or DisplayedCells and it is done automatically
p25110
aVMore information about the various sizing options is available in this MSDN Library article
p25111
as(dp25112
g9
V17034
p25113
stp25114
a((dp25115
g2
(lp25116
VYes, the CellFormatting event will do just fine
p25117
aVHere's an example one, it tries to convert a decimal number in the first column to hex:
p25118
as(dp25119
g9
V17034
p25120
stp25121
a((dp25122
g2
(lp25123
VSolution templates do not exist
p25124
aVA VSTemplate type can be Project or Item, reference is here
p25125
aVThis is also visible from File + Export Template
p25126
aVMaybe you could write a macro to copy/create the required files
p25127
as(dp25128
g9
V17034
p25129
stp25130
a((dp25131
g2
(lp25132
VYou should provide one
p25133
aVh file and at least 4 versions of the
p25134
aVlib
p25135
aVThe important choice is C/C++, Code Generation, Runtime Library
p25136
aVYou can't predict whether the client will use the static or the DLL version of the CRT
p25137
aVYou'll also want to #define _CRT_NOFORCE_MANIFEST so you don't inject the CRT version number you use in the client's manifest
p25138
as(dp25139
g9
V17034
p25140
stp25141
a((dp25142
g2
(lp25143
VNo, you cannot count on having
p25144
aVNET available on a XP machine
p25145
aVWindows Update might have been disabled
p25146
aVNo problem on Vista (3
p25147
aV0) and Windows 7 (3
p25148
aV5 SP1)
p25149
as(dp25150
g9
V17034
p25151
stp25152
a((dp25153
g2
(lp25154
VStart with the Win32 Console mode project template
p25155
aVDelete the
p25156
aVcpp files
p25157
aVRight-click the project in the Solution Explorer window, Custom Build Rules, check Microsoft Macro Assembler
p25158
aVAdd a new
p25159
aVasm file by right-clicking the Source Files node, Add, Code, C++ File, be sure to use the
p25160
aVasm extension
p25161
aVIn the property window change the File Type to C/C++ Code so it gets passed to the linker
p25162
aVLinker settings, Manifest file, Generate = No
p25163
aVWith these settings I could build and debug this sample
p25164
aVasm file:
p25165
as(dp25166
g9
V17034
p25167
stp25168
a((dp25169
g2
(lp25170
VLatency is a non-issue on modern machines
p25171
aVSerial ports are glacially slow, 19
p25172
aV2 kilobaud is peanuts, the
p25173
aVNET SerialPort class handles them fine
p25174
aVThe DataReceived event is delivered asynchronously by a threadpool thread that performs a blocking wait with WaitCommEvent(), you can't go faster than that
p25175
as(dp25176
g9
V17034
p25177
stp25178
a((dp25179
g2
(lp25180
VIt's a bit of a screwy error message, but the caller needs to know the size of the structure to be able to make the call
p25181
aVIt needs to reserve space on the stack for the return value
p25182
aVOr expect the return value in registers if the structure is small enough
p25183
aVYou have to declare the structure in the header
p25184
aVWhen you do, the error disappears:
p25185
as(dp25186
g9
V17034
p25187
stp25188
a((dp25189
g2
(lp25190
VNormally Application
p25191
aVThreadException will handle the exception in the Load event
p25192
aVYou'll get the ThreadExceptionDialog that offers the Quit and Continue options
p25193
aVBut not when a debugger is attached
p25194
aVThe catch clause in the message loop that displays the dialog is intentionally disabled in that case
p25195
aVThat's necessary because it would be very difficult to trouble-shoot exceptions if that dialog pops up when you debug a program
p25196
aVWhich this catcher no longer active, your catch clause in the Main() method now gets a shot at the exception
p25197
aVYou can make it consistent by using Application
p25198
aVSetUnhandledExceptionMode() in the Main() method
p25199
aVYou shouldn't, exceptions really are hard to debug if you do this
p25200
aVIf you want to customize exception handling for the UI thread then you should register your own Application
p25201
aVThreadException handler:
p25202
aVTrapping unhandled exceptions in worker threads requires a AppDomain
p25203
aVUnhandledException handler
p25204
aVThey are not recoverable
p25205
aVAlso beware of a bug in 64-bit Windows, exceptions in the Load event are swallowed without diagnostic when a debugger is attached
p25206
aVForce AnyCPU mode to avoid that trap
p25207
as(dp25208
g9
V17034
p25209
stp25210
a((dp25211
g2
(lp25212
VDo you really want to create a new thread and a progress bar for each individual file
p25213
aVCreate the thread outside of the for() loop
p25214
aVBut this is not the right way to do it, your main UI is still dead as a doornail
p25215
aVWindows will turn your main window in a ghost with "Not Responding" in the title bar after a couple of seconds
p25216
aVYou want to use a worker thread to do the file manipulation and the main thread to display the progress bar using a dialog that can only be closed when the worker uses PostMessage() to indicate completion
p25217
as(dp25218
g9
V17034
p25219
stp25220
a((dp25221
g2
(lp25222
VYou don't have a lot of great options
p25223
aVYou can't use generics, that leaves you with the olden ArrayList class
p25224
aVOr an array
p25225
aVThe COM interop layer will automatically generate a COM enumerator for a C# class that implements IEnumerable, you can iterate it on the VB6 side with For Each
p25226
aVSimilarly, it generates an IEnumerable for a COM class that implements an COM enumerator
p25227
aVYou can use foreach in C# code to enumerate a VB6 Collection
p25228
aVChoose between them depending on who creates the collection
p25229
as(dp25230
g9
V17034
p25231
stp25232
a((dp25233
g2
(lp25234
VYou are getting in trouble because your object design is wrong
p25235
aVYou've got two choices to use existing classes: inheritance and encapsulation
p25236
aVTo choose between them, you can use the is-a and has-a test
p25237
aVPick the right choice from these tests:
p25238
aVSock is a Socket
p25239
aVSock has a Socket
p25240
aVGame is a Sock
p25241
aVGame has a Sock
p25242
aVYou picked 2 and 3, you should have picked 1 and 4
p25243
aVThe rest of your classes are wrong the same way too
p25244
aVOnce you make these corrections, you'll find it a lot easier going
p25245
as(dp25246
g9
V17034
p25247
stp25248
a((dp25249
g2
(lp25250
VIt just doesn't make any sense to do this
p25251
aVSpin the classes off in their own library project that builds a
p25252
aVlib, have both apps use the library
p25253
as(dp25254
g9
V17034
p25255
stp25256
a((dp25257
g2
(lp25258
VMemory mapped files are fundamentally incompatible with the garbage collector
p25259
aVWhich is why it took so long for such a principal operating system feature to get supported by
p25260
aVNET
p25261
aVReference types need to be serialized to the MMF view, MemoryMappedViewStream, no way around that
p25262
aVA similar restriction exists in unmanaged code, objects with pointers need to be flattened so the pointed-to objects are visible in the view as well
p25263
aVWhether you serialize them to a MMF or to a file won't make any difference, the file system cache is implemented with MMFs as well
p25264
aVFile writes are very fast, as long as the written data fits in available mappable memory
p25265
aVIf that's an issue then look at a 64-bit operating system to solve that problem
p25266
as(dp25267
g9
V17034
p25268
stp25269
a((dp25270
g2
(lp25271
VFirst consider if an exception isn't actually appropriate
p25272
aVYou expect a sheet with a certain name to be there
p25273
aVIf it isn't, can you still meaningful continue running your program
p25274
aVIf you can, you can avoid the exception by iterating the sheets collection and look for a match on the Name property
p25275
as(dp25276
g9
V17034
p25277
stp25278
a((dp25279
g2
(lp25280
VSomething wrong with your installer, I'd say
p25281
aVRestricted rights should not block users from reading keys in the HKLM\u005cSoftware hive
p25282
aVDo make sure you didn't ask for write permissions, pass False as the 2nd argument to RegistryKey
p25283
aVOpenSubKey()
p25284
as(dp25285
g9
V17034
p25286
stp25287
a((dp25288
g2
(lp25289
VNo happy answers here
p25290
aVIt is illegal to let a C++ or SEH exception terminate a COM method
p25291
aVYou must catch them and translate them to an appropriate HRESULT
p25292
aVYour coclass must implement the ISupportsErrorInfo and IErrorInfo interfaces so that the client can get exception information back
p25293
aVThe CLR will readily do so to produce a customized exception message
p25294
aVThe Error() method you speak of is most likely the ATL CComCoClass::Error() method
p25295
aVIt sets up the exception info that IErrorInfo will return
p25296
aVThere is no mechanism to inject a single try/catch block to catch all possible exceptions, COM methods are called directly from the client
p25297
aVYou have to do so for each individual COM method that calls C++ code that can throw an exception
p25298
aVUnpleasant, but this should have been done when the code was written
p25299
aVYou probably need to wrap every single one of them since finding out if it is calling code that may throw is difficult right now
p25300
aVTechnically, you could change the class factory to create a wrapper instead, one that implements each method of the interface and delegates to the actual method
p25301
aVWith boilerplate try/catch handlers
p25302
aVVery mechanical, you can probably come up with some macros to lessen the blow
p25303
as(dp25304
g9
V17034
p25305
stp25306
a((dp25307
g2
(lp25308
VUse TryCast instead
p25309
aVIt returns Nothing if the object is not of the expected type
p25310
as(dp25311
g9
V17034
p25312
stp25313
a((dp25314
g2
(lp25315
VThe foreach statement is hiding the enumerator you need to access
p25316
aVYou can do it directly like this:
p25317
as(dp25318
g9
V17034
p25319
stp25320
a((dp25321
g2
(lp25322
VThe problem is that DateTime
p25323
aVNow includes a date, "17:10:03" doesn't
p25324
aVDo it like this:
p25325
aVDo everything in your power to convert that string column type to a datetime column
p25326
as(dp25327
g9
V17034
p25328
stp25329
a((dp25330
g2
(lp25331
VYou are converting between file system paths and URLs
p25332
aVThe Uri class should fit the bill:
p25333
aVOutput:
p25334
as(dp25335
g9
V17034
p25336
stp25337
a((dp25338
g2
(lp25339
VThe code as posted is quite insufficient to guess what might be going on
p25340
aVI'll take a hint from the thread subject "while moving picBox"
p25341
aVIf you use the MouseMove event to move a control then you change the position of the control relative to the mouse
p25342
aVThe next reported position will be different, even if you didn't move the mouse
p25343
aVSince the mouse position is reported relative to the upper left corner of the client area of the control
p25344
aVThe effect is usually very interesting, the control does the pogo, jumping back and forth rapidly
p25345
aVYou need to compensate for this, usually by not updating the stored previous mouse position
p25346
aVI can't give better advice than this without seeing any relevant code
p25347
as(dp25348
g9
V17034
p25349
stp25350
a((dp25351
g2
(lp25352
VCatching this exception is not an option
p25353
aVIt is the worst kind of heart attack a thread can suffer, the CPU has detected a serious problem and cannot continue running code
p25354
aVThis is invariably caused by misbehaving unmanaged code, it sounds like you've got plenty of it running in your program
p25355
aVYou need to focus on debugging that unmanaged code to get somewhere
p25356
aVThe two most common causes of an AV are
p25357
aVHeap corruption
p25358
aVThe unmanaged code has written data to the heap improperly, destroying the structural integrity of the heap
p25359
aVTypically caused by overflowing the boundary of an allocated block of memory
p25360
aVOr using a heap block after it was freed
p25361
aVVery hard to diagnose, the exception will be raised long after the damage was done
p25362
aVStack corruption
p25363
aVMost typically caused by overflowing the boundaries of an array that was allocated on the stack
p25364
aVThis can overwrite the values of other variables on the stack or destroy the function return address
p25365
aVA bit easier to diagnose, it tends to repeat well and has an immediate effect
p25366
aVOne side-effect is that the debugger loses its ability to display the call stack right after the damage was done
p25367
aVHeap corruption is the likely one and the hard one
p25368
aVThis is most typically tackled by debugging the code in the debug build with a debug allocator that watches the integrity of the heap
p25369
aVThe  header provides one
p25370
aVIt's not a guaranteed approach, you can have some really nasty Heisenbugs that only rear their head in the Release build
p25371
aVVery few options available then, other than careful code review
p25372
aVGood luck, you'll need it
p25373
as(dp25374
g9
V17034
p25375
stp25376
a((dp25377
g2
(lp25378
VIs this a Telerik control
p25379
aVIts DropDownPanel class doesn't inherit from Control, it cannot be added to the Controls collection
p25380
aVWhich explains why the caption doesn't get set and why you cannot cast
p25381
aVReview the API documentation, there has to be some kind of other collection class that allows you to iterate RadElements that are present on the form
p25382
aVThe best place to find other programmers that have used this product is in the support forum for it
p25383
as(dp25384
g9
V17034
p25385
stp25386
a((dp25387
g2
(lp25388
VIt is a Managed Debugging Assistant warning, relating to using COM servers on a thread
p25389
aVOne of the features of COM is that it automatically handles threading for components that do not support multi-threading
p25390
aVIt automatically marshals a method call from a background thread to the UI thread so that the component isn't used in a thread-unsafe manner
p25391
aVThis is completely automatic, you don't write any code yourself to make this happen
p25392
aVFor this to work properly, the UI thread must be idle so that it can execute the method call
p25393
aVThe warning tells you that the UI thread has not been idle for a minute, it prevents the call from completing
p25394
aVThe most likely reason for that is that the UI thread is blocking, waiting for the thread to complete
p25395
aVThat will never happen, it is deadlocked
p25396
aVOr it could just have been busy running code for that minute, never getting around to doing its normal duties, pumping the message loop
p25397
aVNot pumping the message loop prevents the marshaled call from completing and trips the warning
p25398
aVThis should be readily visible, the main window of your app should be frozen and display the "Not Responding" message in the title bar
p25399
aVWhen you use Debug + Break All, Debug + Windows + Threads and switch to the UI thread, then look at the call stack, you should see the place where the UI thread is deadlocked
p25400
aVFix it by not making the UI thread wait on the thread or by avoiding using the COM component on a worker thread
p25401
aVIf it is completely inappropriate (shouldn't be) then you can turn off the warning with Debug + Exceptions
p25402
aVThat's the technical explanation for the warning
p25403
aVThe boring one is that there was a bug in the RTM version of Visual Studio 2005
p25404
aVSomething wrong with the debugger, it tended to trip the MDA while single stepping or inspecting variables
p25405
aVThat got fixed in Service Pack 1, be sure to download and install it if you haven't done this yet
p25406
as(dp25407
g9
V17034
p25408
stp25409
a((dp25410
g2
(lp25411
VThe linked code solves a different problem, you are trying to do something much more difficult
p25412
aVYou have to do nothing special with the iterators, as long as the collection isn't being modified while it is being iterated
p25413
aVGuaranteeing this can be difficult, you'll have to keep a lock that prevents any thread from adding items
p25414
aVNot great for concurrency
p25415
aVIf that's not suitable then you'll have to make a copy of the collection to provide the guarantee
p25416
aVNo bed of roses either, a thread will now by definition always see a stale version of the collection
p25417
as(dp25418
g9
V17034
p25419
stp25420
a((dp25421
g2
(lp25422
VThe OpenMP implementation in both VS2008 and VS2010 is compliant with the version 2
p25423
aV0 specification
p25424
aVThere are some annotations in the MSDN Library but it doesn't go deep
p25425
aVBest place to look for detailed specifications is at the openmp
p25426
aVorg site
p25427
as(dp25428
g9
V17034
p25429
stp25430
a((dp25431
g2
(lp25432
VYou are mixing code that was compiled with /MD (use DLL version of CRT) with code that was compiled with /MT (use static CRT library)
p25433
aVThat cannot work, all source code files must be compiled with the same setting
p25434
aVGiven that you use libraries that were pre-compiled with /MD, almost always the correct setting, you must compile your own code with this setting as well
p25435
aVProject + Properties, C/C++, Code Generation, Runtime Library
p25436
aVBeware that these libraries were probably compiled with an earlier version of the CRT, msvcr100
p25437
aVdll is quite new
p25438
aVNot sure if that will cause trouble, you may have to prevent the linker from generating a manifest
p25439
aVYou must also make sure to deploy the DLLs you need to the target machine, including msvcr100
p25440
aVdll
p25441
as(dp25442
g9
V17034
p25443
stp25444
a((dp25445
g2
(lp25446
VCreating your own label control is simple enough, you just need to start with Control and override OnPaint()
p25447
aVWhat is going to byte is to turn it into a control that also has focusing behavior
p25448
aVAnd allows the user to edit the text
p25449
aVBy the time you're done, you'll have re-invented the TextBox control
p25450
aVWhich is a lot harder than it looks
p25451
aVFocus on the focusing first, that's the trickiest problem
p25452
aVIt isn't very likely that the user will want to focus the control frequently
p25453
aVMaybe some kind of secret handshake, like a double-click
p25454
aVWhen you detect one, you could create a TextBox control and put it in front of the label
p25455
aVAnd dispose it when it loses focus, updating the label's Text property
p25456
aVOr a simple context menu that displays a small editing dialog
p25457
aVAn example that uses the double-click to edit approach:
p25458
as(dp25459
g9
V17034
p25460
stp25461
a((dp25462
g2
(lp25463
VThis is not okay, the DataReceived event is triggered when the SerialPort receives something
p25464
aVYou cannot just start a thread and hope that there will be something to read from the port
p25465
aVMore to the point, the DataReceived event already runs on a separate thread
p25466
aVThe SerialPort class uses a threadpool thread to run the event
p25467
aVUsing your own thread to read data from the port is okay but then you don't want to use DataReceived
p25468
aVYou simply use the blocking calls, any of the ReadXxx() methods qualify
p25469
as(dp25470
g9
V17034
p25471
stp25472
a((dp25473
g2
(lp25474
VYou should expect the client to follow the contract, honor the [out] attribute and not pass an initialized BSTR that needs to be freed
p25475
aVDouble-checking and expecting a NULL is not okay, the contract also doesn't require the client to pass a pointer to an initialized memory location
p25476
aVYou'd most typically get a pointer to a BSTR variable allocated on the stack frame
p25477
aVIt is likely to contain random garbage, although a defensive programmer would set it to NULL
p25478
aVIt is otherwise incompatible with OLE Automation
p25479
aVOnly [out,retval] and [in,out] are supported, no doubt to avoid this particular trap
p25480
as(dp25481
g9
V17034
p25482
stp25483
a((dp25484
g2
(lp25485
VYou just made it less obvious that your form paints very slowly by using the techniques shown in my answer
p25486
aVThe tricks don't speed it up, they merely make the ugliness less visible
p25487
aVBut they fall flat when you have to paint your form from scratch, which happens when you move another window across it
p25488
aVThe painting cannot keep up with the barrage of paint requests that are generated each time the overlapping form moves by one or more pixels
p25489
aVAn instant fix is to upgrade your operating system to Vista or Windows 7, windows don't overlap anymore with Aero enabled
p25490
as(dp25491
g9
V17034
p25492
stp25493
a((dp25494
g2
(lp25495
VThis sounds very wrong
p25496
aVI can imagine that your class objects share a single ArrayList instance and that therefore code that accesses it needs to be synchronized
p25497
aVBut that would make the ArrayList object reference static as well, why do you have to pass it as an argument
p25498
aVIf other code needs to call this static method without having to use a reference to your class object then they'd probably have to pass their own instance of the ArrayList
p25499
aVThen it doesn't make sense anymore that you would need to lock
p25500
aVThe calling code needs to take care of locking
p25501
aVOnly it knows in what other places that particular ArrayList object gets used
p25502
aVSorry, I can't make much sense of it
p25503
aVThat starts by you using the ArrayList object as the lock argument
p25504
aVYou can't lock data, you can only lock code that uses data
p25505
as(dp25506
g9
V17034
p25507
stp25508
a((dp25509
g2
(lp25510
VYou can't, you have no idea what allocator was used by the unmanaged code to create the CString instance
p25511
aVMoreover, you'd have to call the CString destructor, you can't get its address
p25512
aVYou are dead in the water if this CString object is returned as the function return value of a C++ function that you call from C#
p25513
aVIt isn't clear from your question
p25514
aVYou'll have an uncontrollable memory leak
p25515
aVA wrapper written in C++/CLI will be required to fix that problem
p25516
aVStrings returned as function return values must be allocated by CoTaskMemAlloc() to get properly cleaned up by the P/Invoke marshaller
p25517
aVNo C++ code ever does that
p25518
as(dp25519
g9
V17034
p25520
stp25521
a((dp25522
g2
(lp25523
VYou can use the Distinct() overload that accepts an IEqualityComparer argument
p25524
as(dp25525
g9
V17034
p25526
stp25527
a((dp25528
g2
(lp25529
VI don't get the problem
p25530
aVPNG is a loss-less format, you'll get the exact same image back
p25531
aVYes, you don't necessarily get the exact same bytes when you Save()
p25532
aVIt is a compressed format and the amount of time spent by the compressor on getting the best balance between compression and speed might not be the same
p25533
aVBut, so what
p25534
aVIf it is a real problem then you shouldn't add the image as a managed resource
p25535
aVYou can add it to your project as an embedded resource and read it from the metadata with Assembly
p25536
aVGetManifestResourceStream()
p25537
aVYou'll get the raw image file bytes
p25538
aVConvertible to an Image with Image
p25539
aVFromStream()
p25540
as(dp25541
g9
V17034
p25542
stp25543
a((dp25544
g2
(lp25545
VYou don't actually have SDK version 7
p25546
aV0A installed
p25547
aVThat's a problem you'll need to fix
p25548
aVLook in the VS2010 install log files to see what went wrong
p25549
aVThe SDK should be present in c:\u005cprogram files\u005cmicrosoft sdks\u005cwindows\u005c7
p25550
aV0a and the listed registry key must be present as well
p25551
aVRunning with the 6
p25552
aV0a version of sgen
p25553
aVexe isn't okay, it is bound to use the wrong compiler
p25554
as(dp25555
g9
V17034
p25556
stp25557
a((dp25558
g2
(lp25559
VYes,  is listed in a project file
p25560
aVIt matches the Visual Studio version number
p25561
as(dp25562
g9
V17034
p25563
stp25564
a((dp25565
g2
(lp25566
VYes, I've done this
p25567
aVUsed to write controllers for industrial equipment
p25568
aVImportant interfaces were a PLC, a 32 axis motion controller, custom operator stations
p25569
aVI wrote simulators for all of them, making the simulator behave as closely as possible to the hardware I didn't have readily available in my office
p25570
aVIt worked out well, the simulators were done before the custom hardware was anywhere near to being ready to run
p25571
aVWhich allowed me to write, debug and finish my code up front
p25572
aVBecoming instrumental in debugging the hardware
p25573
aVThe simulators were a joy forever, they were always there when I was in a different (and more preferable) place to work on the next project
p25574
aVOperating a steel mill roll grinder in my bath tub
p25575
aVRecommended
p25576
aVNail down the protocol early
p25577
as(dp25578
g9
V17034
p25579
stp25580
a((dp25581
g2
(lp25582
VYeah, you forgot to call SetConsoleActiveScreenBuffer
p25583
aVWhat exactly was the point of creating your own
p25584
aVUse GetStdHandle(STD_OUTPUT_HANDLE) to get a handle to the existing console
p25585
as(dp25586
g9
V17034
p25587
stp25588
a((dp25589
g2
(lp25590
VThose two files you list implement the Visual Studio "hosting process"
p25591
aVIt is a hosted version of the CLR, designed to improve the debugging experience
p25592
aVIt takes care of some security issues, the most visible side-effect is that it redirects output written with Console
p25593
aVWriteLine() in a GUI app to the Output window
p25594
aVThese files are not part of your project and do not get deleted when you use Build + Clean
p25595
aVIn fact, you cannot delete the
p25596
aVexe file, it is always running while you've got the project opened in Visual Studio
p25597
aVYou can disable the hosting process feature with Project + Properties, Debug, scroll down, "Enable the Visual Studio Hosting process" tick
p25598
aVThere's no compelling reason to do so
p25599
aVThere's no need to check these in, Visual Studio re-generates them when you check-in a project and load it in VS
p25600
aVIn general, you never need to check anything in from the bin subdirectory, its content is always re-created by building your project
p25601
as(dp25602
g9
V17034
p25603
stp25604
a((dp25605
g2
(lp25606
VAnyCPU will work in a 64-bit program, but you have to register it differently
p25607
aVUse the 64-bit version of Regasm
p25608
aVexe, you'll find it in c:\u005cwindows\u005cmicrosoft
p25609
aVnet\u005cframework64
p25610
aVVerify that you get the keys in HKLM\u005cSoftware\u005cClasses\u005cCLSID, not in HKLM\u005cSoftware\u005cWow6432Node\u005cClasses\u005cCLSID
p25611
as(dp25612
g9
V17034
p25613
stp25614
a((dp25615
g2
(lp25616
VThe opportunities for heap and stack corruption abound
p25617
aVNot initializing the variant is suicidal
p25618
aVCopying a C string into a local char[] without checking the length is hoping to always be lucky
p25619
aVThe real damage could be done anywhere, execute_job() or something that ran half an hour ago
p25620
aVConsider a tool to catch mistakes like these, something like Coverity
p25621
as(dp25622
g9
V17034
p25623
stp25624
a((dp25625
g2
(lp25626
VIt doesn't matter, it generates the exact same code
p25627
aVgets translated by the C# compiler to
p25628
aVYou can see this for yourself by writing a small test program and looking at it with ildasm
p25629
aVexe
p25630
aVSo "better" is merely what style you prefer
p25631
aVConsistent use of int
p25632
aVwould be my personal preference
p25633
aVOne practical note: in a typical debug session you might well be interested in finding out that null is getting returned
p25634
aVEspecially since the data you read doesn't produce what you expect
p25635
aVThat becomes very easy if you write the null-returning statement on a separate line:
p25636
aVGet's rid of the cast too
p25637
aVAnd produces the exact same code
p25638
as(dp25639
g9
V17034
p25640
stp25641
a((dp25642
g2
(lp25643
VNope, this is not okay
p25644
aVA WeakReference only tells you that a managed object got garbage collected
p25645
aVWhich has nothing to do with IDisposable
p25646
aVThe point of Dispose() is to release unmanaged resources before the garbage collector does it
p25647
aVIn fact, you got a serious problem if the managed object is in gen #1 and the COM wrapper is in gen #0
p25648
aVThe WeakReference can't keep the wrapper alive, it will be collected and the COM object disposed before you got a chance to call Dispose() yourself
p25649
aVJust store a plain reference to the wrapper object in your managed object
p25650
aVYou can set it to null after you call Dispose() so that the wrapper can get collected
p25651
aVAnd throw ObjectDisposedException if the client code tries to use it and the reference is null
p25652
aVOr recreate it, if that makes sense
p25653
as(dp25654
g9
V17034
p25655
stp25656
a((dp25657
g2
(lp25658
VLooks quite thread-safe to me, the WaitAny() will simply complete immediately because thee event is already set
p25659
aVThat's not a problem
p25660
aVDon't break threading sync that works
p25661
aVBut if you want a better mousetrap then you could consider Joe Duffy's BlockingQueue in this magazine article
p25662
aVA more general version of it is available in
p25663
aVNET 4
p25664
aV0, System
p25665
aVCollections
p25666
aVConcurrent
p25667
aVBlockingCollection with ConcurrentQueue as a practical implementation of it
p25668
as(dp25669
g9
V17034
p25670
stp25671
a((dp25672
g2
(lp25673
VThe ManagementClass
p25674
aVMethods property returns them, there's a good example in the MSDN Library topic for it
p25675
aVHave you found WmiCodeCreator yet
p25676
as(dp25677
g9
V17034
p25678
stp25679
a((dp25680
g2
(lp25681
VIf you don't know the format then you'll have to experiment
p25682
aVStart by iterating and displaying the available formats, use Clipboard
p25683
aVGetDataObject()
p25684
aVGetFormats()
p25685
aVThese are strings, you might recognize something
p25686
aVYou can pass one of them to Clipboard
p25687
aVGetData(), you'll get an opaque object back
p25688
aVPut it in a watch expression, maybe the debugger can make sense of it
p25689
aVIf Skype uses the clip board for its own use, there's little hope you can dig anything usable out
p25690
aVIf it intends to provide clipboard data to common apps like MS Word, without some kind of add-in, there will be lots of hope
p25691
as(dp25692
g9
V17034
p25693
stp25694
a((dp25695
g2
(lp25696
VYou should be able to do what you want to do in Sub Main() with the Startup event
p25697
aVProject + Properties, Application tab, scroll down, click View Application Events
p25698
aVUpper left combo, select "(My Application Events)"
p25699
aVUpper right combo, select Startup
p25700
aVNevertheless, you can still get the application framework and start it through Sub Main()
p25701
aVAdd a module to your project and make it look like this:
p25702
as(dp25703
g9
V17034
p25704
stp25705
a((dp25706
g2
(lp25707
VYou are right, you should not be doing this
p25708
aVRemove the Collect() call and let it run for a week
p25709
aVAny decent
p25710
aVNET book will talk about how the garbage collector works and how it does not immediately release memory when you set an object to Nothing
p25711
aVIt doesn't kick in until you've consumed somewhere between 2 and 8 megabytes
p25712
aVThis is not a leak, merely effective use of a plentiful resource
p25713
aVYou use a new thread for each individual connection, that's pretty expensive and scales very poorly when you get a lot of connections
p25714
aVConsider using ThreadPool
p25715
aVQueueUserWorkItem instead
p25716
aVThreadpool threads are very cheap and their allocation and execution is well controlled by the threadpool manager
p25717
as(dp25718
g9
V17034
p25719
stp25720
a((dp25721
g2
(lp25722
VThis translates to VB6 runtime error 429, "ActiveX can't create object"
p25723
aVIt is not your C# code that is failing, it is the VB6 code that has a problem
p25724
aVYou can only get somewhere by debugging the VB6 code
p25725
aVYou'll need the VB6 IDE, load the library project, set your C# program as the start program and set a breakpoint on the Class_Initialize subroutine of the class you are trying to create in your C# code
p25726
aVWorking from the assumption you don't have the tools anymore, error 429 has a lot of potential causes
p25727
aVThe most common one is a registration problem, solved by running Regsvr32
p25728
aVexe on a DLL that the VB6 code uses
p25729
as(dp25730
g9
V17034
p25731
stp25732
a((dp25733
g2
(lp25734
VFor VS2010, you can set the dictionary by editing your
p25735
aVvcxproj file and pasting this:
p25736
aVModify the path to your dictionary
p25737
aVTo make this a permanent setting for all your C++ projects, navigate to c:\u005cprogram files\u005cmsbuild\u005cmicrosoft
p25738
aVcpp\u005cv4
p25739
aV0 and edit Microsoft
p25740
aVCpp
p25741
aVprops, pasting the above (make a backup please)
p25742
aVTo verify that the change is effective, use Tools + Options, Projects and Solutions, Build and Run, MSBuild project build log file verbosity = Diagnostic
p25743
aVRebuild your project, look in the
p25744
aVlog file and verify that fxcopcmd
p25745
aVexe got started with the /dictionary option
p25746
aVBoth approaches worked well on my machine
p25747
as(dp25748
g9
V17034
p25749
stp25750
a((dp25751
g2
(lp25752
VSilverlight's Dictionary<> class has a [DebuggerTypeProxy] attribute but it doesn't work in the current release of the toolset
p25753
aVAlso mentioned in this thread
p25754
aVSame advice, report the bug at connect
p25755
aVmicrosoft
p25756
aVcom so they are aware of it, hopefully it will be fixed in the official RTM release of the tools
p25757
as(dp25758
g9
V17034
p25759
stp25760
a((dp25761
g2
(lp25762
VDon't use transactions in both your C# code and the sprocs
p25763
aVOne is enough
p25764
aVWhich almost always should be your C# code, only it knows what set of updates to the dbase should be rejected or committed in whole
p25765
as(dp25766
g9
V17034
p25767
stp25768
a((dp25769
g2
(lp25770
VThe code as written won't work, the exported function name is decorated by the C++ compiler and no longer resembles "hello"
p25771
aVYou'd normally declare the function extern "C" to suppress the decoration
p25772
aVBut, you haven't gotten that far yet
p25773
aVThe LoadLibrary() call is failing with Windows error 998, ERROR_NOACCESS, "Invalid access to memory location"
p25774
aVThis most typically happens when the DllMain() entrypoint in one of the DLLs you have a dependency on bombs with an AccessViolation hardware exception
p25775
aVThis should be visible in the debugger (Output window in Visual Studio), you should see a "First chance exception" with exception code 0xc0000005
p25776
aVThis is probably going to be unpleasant to diagnose, you've got several DLLs that are candidates and whose debugging symbols probably are a poor match for the debugger you use
p25777
aVTry to isolate this by writing a small test program in C that calls LoadLibrary
p25778
aVConfigure the debugger to stop on the first chance exception
p25779
aVIn Visual Studio you'd do this with Debug + Exceptions, Thrown checkbox
p25780
aVGood luck with it
p25781
as(dp25782
g9
V17034
p25783
stp25784
a((dp25785
g2
(lp25786
VNo tool, but easily accomplished with cut-and-paste text editing
p25787
aVAdd a new form to your project
p25788
aVIn the Solution Explorer, open the node next to the form and double-click the Designer
p25789
aVcs file
p25790
aVCut and paste the InitializeComponent() method from your old form to that file
p25791
aVCut and paste the rest of your code
p25792
aVRemove the old form, change the class name of the new one
p25793
as(dp25794
g9
V17034
p25795
stp25796
a((dp25797
g2
(lp25798
VAvoid the WER dialog by preventing your UnhandledException event handler from exiting
p25799
aVCall Environment
p25800
aVExit() to terminate your app
p25801
as(dp25802
g9
V17034
p25803
stp25804
a((dp25805
g2
(lp25806
VBase classes that generate events require the standard event generation pattern
p25807
aVThat must be done in code, the designer cannot auto-generate it
p25808
aVIt never will
p25809
as(dp25810
g9
V17034
p25811
stp25812
a((dp25813
g2
(lp25814
VYou'll want the PictureBox to participate in the tabbing order and show that it has the focus
p25815
aVThat takes a bit of minor surgery
p25816
aVAdd a new class to your project and paste the code shown below
p25817
aVCompile
p25818
aVDrop the new control from the top of the toolbox onto your form
p25819
aVImplement the KeyDown event
p25820
as(dp25821
g9
V17034
p25822
stp25823
a((dp25824
g2
(lp25825
VAgreed
p25826
aVIf all of your threads need to acquire an upgradable read lock and you cannot afford to release a read lock and acquire a write lock then ReaderWriterLockSlim is no improvement over a simple exclusive lock
p25827
aVRecursion does not change that
p25828
aVRWLS and the need to avoid the ever present danger of deadlock heavily favors a pattern where a single thread does the writing
p25829
as(dp25830
g9
V17034
p25831
stp25832
a((dp25833
g2
(lp25834
VThere's an excellent article in MSDN magazine that talks about the belly-aching and design considerations that went into adding Tuple to the BCL
p25835
aVChoosing between a value type and a reference type is particularly interesting
p25836
aVAs the article makes clear, the driving force behind Tuple was so many groups inside of Microsoft having a use for it, the F# team up front
p25837
aVAlthough not mentioned, I reckon that the new "dynamic" keyword in C# (and VB
p25838
aVNET) had something to do with it as well, tuples are very common in dynamic languages
p25839
aVIt is otherwise not particularly superior to creating your own poco, at least you can give the members a better name
p25840
as(dp25841
g9
V17034
p25842
stp25843
a((dp25844
g2
(lp25845
VYes, there are two versions of sgen
p25846
aVexe available, one for CLR v2 assemblies, the other for CLR v4 assemblies
p25847
aVIt bombs because you ask the v2 version of sgen
p25848
aVexe to process a v4 assembly
p25849
aVCheck how your project gets sgen
p25850
aVexe started
p25851
aVIf it is a post-build event then you'll have to tweak the path to sgen
p25852
aVexe
p25853
aVI don't see a macro or environment variable to get it right automatically, bit of an oversight
p25854
as(dp25855
g9
V17034
p25856
stp25857
a((dp25858
g2
(lp25859
VYou don't describe how you multiplex the traffic of multiple client streams onto a single outgoing stream
p25860
aVJust arbitrarily putting chunks of client traffic into the stream is guaranteed not the work
p25861
aVThe receiving end on the opposite end of the intertube will have no idea what bytes belong to what conversation
p25862
aVI'd recommend you focus on the opposite end first
p25863
aVWhat machine is out there, what does it do, what does it need to know about the multiple clients at the local end
p25864
as(dp25865
g9
V17034
p25866
stp25867
a((dp25868
g2
(lp25869
VBackgroundWorker will give you no obstacles to get the progress updates implemented, ReportProgress() is there to get that job done
p25870
aV"Sending messages" is another matter though
p25871
aVYou'll need a thread-safe queue in which you can stuff objects that represent a unit of work
p25872
aVEmptied by the BGW in its main loop in the DoWork event handler
p25873
aVNET 4
p25874
aV0 certainly helps you do that, ConcurrentQueue gets you the queue
p25875
as(dp25876
g9
V17034
p25877
stp25878
a((dp25879
g2
(lp25880
VYou cannot make this work in the client code, it has to be dealt with in the server
p25881
aVThe server must call CoRegisterClassObject(), passing REGCLS_MULTIPLEUSE so that multiple clients are allowed to use the single server instance
p25882
aVThere is no other mechanism to allow a client to obtain an interface pointer to the Application object
p25883
aVThis is very much by design, the server has to be designed and written to support such usage
p25884
aVIt cannot be bolted on later
p25885
as(dp25886
g9
V17034
p25887
stp25888
a((dp25889
g2
(lp25890
VThe struct isn't a problem, it will marshal correctly as-is
p25891
aVOf course, it will be up to you to convert the double to a matching DateTime value
p25892
aVHow it is encoded is unguessable from your question
p25893
as(dp25894
g9
V17034
p25895
stp25896
a((dp25897
g2
(lp25898
VYou handle it by fixing the bug and recompiling your program
p25899
aVAnything else makes no sense
p25900
as(dp25901
g9
V17034
p25902
stp25903
a((dp25904
g2
(lp25905
VIt's a flaw in the 64-bit version of the JIT compiler
p25906
aVIt looks like it doesn't generate entirely correct machine code address-to-statement debug mapping data
p25907
aVIt is only somewhat accurate, the "return true" statement does actually jump to the return statement at the end of the method
p25908
aVBut it should have hit the closing brace, not the "return false" statement
p25909
aVThis bug is not present in the x86 version of the JIT compiler
p25910
aVYou typically want to use that jitter during debugging, it supports Edit+Continue
p25911
aVProject + Properties, Build tab, Platform Target = x86
p25912
aVThat is automatic in VS2010 for new projects
p25913
aVYou can report the bug at connect
p25914
aVmicrosoft
p25915
aVcom
p25916
as(dp25917
g9
V17034
p25918
stp25919
a((dp25920
g2
(lp25921
VThere's some crucial info missing from your question
p25922
aVReverse-engineering: the "var" keyword didn't become available until C# version 3, shipped with Visual Studio 2008
p25923
aVUsing an old debugger isn't a great idea, although it probably isn't the real problem
p25924
aVAnother hint is that you use a stand-alone debugger instead of the one that's built into Visual Studio
p25925
aVMaking it very likely that you are debugging release code, not code built in the Debug configuration
p25926
aVNot getting info on local variables and properties is quite normal in that case, the JIT compiler optimizes them away
p25927
as(dp25928
g9
V17034
p25929
stp25930
a((dp25931
g2
(lp25932
VThis heavily ties into why properties are useful
p25933
aVThey provide a level of isolation between the class implementation and the client code that uses it
p25934
aVWhen you use a public field, you cannot easily refactor the way the field behaves, the client code references it directly
p25935
aVChanging the field to a property for example requires recompiling all client code that uses it
p25936
aVThe usefulness of an automatic property is that it doesn't force you to decide up front that a field may need to be refactored some day
p25937
aVYou can postpone the decision and change it from an automatic property to an explicit property with custom behavior any time you like
p25938
aVWithout having to make any changes in the client code
p25939
aVThe JIT compiler ensures that an automatic property is just as efficient as a field, it inlines the accessor method call
p25940
aVThe new automatic property syntax makes it just as efficient on your wrists as a public field
p25941
aVThis is a complete win-win, it just doesn't make any sense anymore to ever use a public field again
p25942
as(dp25943
g9
V17034
p25944
stp25945
a((dp25946
g2
(lp25947
VIt probably ought to look similar to this:
p25948
as(dp25949
g9
V17034
p25950
stp25951
a((dp25952
g2
(lp25953
VYour "depth" value doesn't match the PixelFormat of the Bitmap
p25954
aVIt needs to be 24 to match Format24bppRgb
p25955
aVThe PF for the bitmap needs to match the PF and stride of the FT_Bitmap as well, I don't see you take care of that
p25956
as(dp25957
g9
V17034
p25958
stp25959
a((dp25960
g2
(lp25961
VYou should use
p25962
aVTo get the index of the first visible character, pass  (the upper left corner of the RTB client area) as the  parameter
p25963
aVTo get the index of the last visible character, pass  as the  parameter
p25964
aVYou can then use  to get all visible text
p25965
aVIf necessary, you can use  to convert the character indexes to line numbers
p25966
as(dp25967
g9
V17034
p25968
stp25969
a((dp25970
g2
(lp25971
VThe Application
p25972
aVIdle event is raised by the RaiseIdle() method
p25973
aVYou cannot call this yourself directly, it is a private method
p25974
aVTechnically you can use Reflection to work around that
p25975
aVThis however isn't likely to work out well, Idle has a very specific meaning
p25976
aVIt is raised when the message loop has dispatched all pending messages and no more work needs to be done
p25977
aVRaising idle in a loop doesn't make sense, you're not idle, you're looping
p25978
aVAny action taken by the app in their Idle event handlers isn't going to have a noticeable effect on the UI
p25979
aVFor that matter, raising it in a loop doesn't make sense either, an app cannot be idle more than once
p25980
aVWhen you contemplate writing code like this you probably are really looking for Application
p25981
aVDoEvents()
p25982
as(dp25983
g9
V17034
p25984
stp25985
a((dp25986
g2
(lp25987
VThe bit-ness is determined by the Platform Target setting on the EXE
p25988
aVThere is no mechanism to ensure that a EXE that references a 32-bit only assembly will be forced to run in 32-bit mode as well
p25989
aVThe assembly will simply fail to load with a BadImageFormatException
p25990
aVIf your program has a dependency on such a DLL then you must force the Platform Target on your EXE project from AnyCPU to x86
p25991
as(dp25992
g9
V17034
p25993
stp25994
a((dp25995
g2
(lp25996
VYou can mess with ApplicationContext but the
p25997
aVNET framework already has very good support for this windowing mode with the WindowsFormsApplicationBase class
p25998
aVIts ShutdownStyle property is available to let the program shut down only after the last window was closed
p25999
aVMake the code in Program
p26000
aVcs look like this:
p26001
as(dp26002
g9
V17034
p26003
stp26004
a((dp26005
g2
(lp26006
VThe semi-colon is the SQL statement terminator
p26007
aVA single statement should be terminated as well, although most parsers don't require it
p26008
aVMore info here
p26009
as(dp26010
g9
V17034
p26011
stp26012
a((dp26013
g2
(lp26014
VYou could use SoundPlayer
p26015
aVPlay() and asynchronously annoy the user with something that sounds better than BEEP
p26016
as(dp26017
g9
V17034
p26018
stp26019
a((dp26020
g2
(lp26021
VThat is the baked-in arrangement for tile view
p26022
aVIf you want the labels underneath the images then you have to set View = LargeIcon
p26023
aVIf that produces an undesirable spacing of images then you can P/Invoke SendMessage() to send the LVM_SETICONSPACING message
p26024
aVThis worked well:
p26025
aVChange the new IconSpacing property in the designer to work well with the size of the images in your ImageList
p26026
aVYou'll see the effect immediately
p26027
as(dp26028
g9
V17034
p26029
stp26030
a((dp26031
g2
(lp26032
VThe info you read is outdated
p26033
aVWindows versions since ~1993 use a flat 32-bit virtual memory space
p26034
aVThe values of the CS and DS segment registers no longer matter and cannot be changed
p26035
aVThere is still a notion of code vs data, now implemented by memory page attributes
p26036
aVReview the allowed values passed in the flNewProtect argument for the VirtualProtectEx() API function
p26037
aVYou very rarely use this API yourself, the attributes are set by the executable image loader and the heap manager
p26038
as(dp26039
g9
V17034
p26040
stp26041
a((dp26042
g2
(lp26043
VYou are not passing the full path name of the
p26044
aVexe to CreateProcess()
p26045
aVThis usually only works if you are lucky
p26046
aVThe
p26047
aVexe files would have to be in the same directory and the working directory has to be set to that directory
p26048
aVFirst verify that the
p26049
aVexes are where you hope they are
p26050
aVAvoid the dependency on the working directory by generating the full path to the 2nd
p26051
aVexe
p26052
aVUse GetModuleFileName(), passing NULL, to get the full path of your 1st
p26053
aVexe
p26054
as(dp26055
g9
V17034
p26056
stp26057
a((dp26058
g2
(lp26059
VC# cannot cause BSODs
p26060
aVBluetooth device drivers certainly do, there are a lot of crummy ones out there
p26061
aVScrew up spell checkers too
p26062
aVPost to superuser
p26063
aVcom to get help finding updates or better BT stacks
p26064
as(dp26065
g9
V17034
p26066
stp26067
a((dp26068
g2
(lp26069
VYou have to be talking about SerialPort
p26070
aVGetPortNames(), "GetPortList" doesn't make sense
p26071
aVThe function iterates values in the registry, written there by your USB emulator device driver
p26072
aVYou can have a look-see with Regedit
p26073
aVexe, navigate to HKLM\u005cHardware\u005cDeviceMap\u005cSerialComm
p26074
aVUnplug it, press F5, if the COM port is still there then SerialPort doesn't know any better than the port still being present
p26075
aVThere is no prescribed behavior as to how a serial port device driver should behave when the port suddenly vanishes
p26076
aVSerial ports are very primitive, they date back to an era where "bug" meant a moth gumming up the teletype
p26077
aVThere is no hardware support at all for Plug and Play, removing a port with the power turned on is equivalent to unplugging the disk drive while Windows is swapping to the paging file
p26078
aVMost device drivers return an error code, it generates an uncatchable exception that crashes your program
p26079
aVThe subject of this feedback article
p26080
aVApparently your device driver doesn't do that, which ought to be preferable over bombing your program
p26081
aVEncouraging btw, most USB emulator device drivers are utter junk
p26082
aVThe ultimate workaround is simple: put a little tag on the plug "don't disconnect while in use
p26083
aVIt's kinda of a problem with USB, most people look at it and go "hmm, what can I do with it
p26084
aVAnd arrive at the only answer and unplug it
p26085
aVAfter a couple of kabooms, they'll learn to not do that anymore
p26086
as(dp26087
g9
V17034
p26088
stp26089
a((dp26090
g2
(lp26091
VThere were a lot of complaints about perf during the beta cycle
p26092
aVThey even delayed the RTM release date by a few weeks to buy extra time to work on it
p26093
aVIt sure looked like cloudy with a chance of meat balls to me, but I've got the Ultimate edition running on two machines that also have VS2008 and they both are very responsive
p26094
aVMany of the awkward delays in VS2008 are gone
p26095
aVIt is all around snappy
p26096
aVOnly starting the debugger seems a bit slower
p26097
aVThey did a great job, it is a fine product
p26098
aVYou won't be disappointed
p26099
aVDefrag your hard drive before you install it
p26100
as(dp26101
g9
V17034
p26102
stp26103
a((dp26104
g2
(lp26105
VYes, there was a change in
p26106
aVNET 4
p26107
aV0, Guid
p26108
aVNewGuid() directly calls CoCreateGuid(), a small wrapper around UuidCreate()
p26109
aVPrevious versions of
p26110
aVNET called a helper function in the CLR, GuidNative::CompleteGuid()
p26111
aVWhich calls CoCreateGuid
p26112
aVNot sure why this change was made, smells like nothing more than a minor optimization
p26113
aVAt any rate, the exact same Windows function generates the Guid, the algorithm has been the same for the past 10 years, it is as reliable as it ever was
p26114
as(dp26115
g9
V17034
p26116
stp26117
a((dp26118
g2
(lp26119
VThe prerequisites have changed since
p26120
aVNET 3
p26121
aV5 SP1,
p26122
aVNET 4
p26123
aV0 requires at least XP SP3,  Windows 2003 SP2 or Vista SP1
p26124
aVNET 3
p26125
aV5 could be installed on any version of these operating systems, including a 11 year old completely unpatched version of XP
p26126
aVSo the 3
p26127
aV5 installer also needs to be able to update a bunch of native Windows components
p26128
aVNot having to include the Windows component updates and additions allowed for a significant size reduction
p26129
aVIf that's an issue then you'll have to include the Windows service pack installers on your pen drive
p26130
as(dp26131
g9
V17034
p26132
stp26133
a((dp26134
g2
(lp26135
VThe Win32 API is a layer that runs in user mode (ring 3)
p26136
aVWindows used to also support an OS/2 and POSIX API layer but they fell into disuse and were removed
p26137
aVThe window manager is pure user mode code, no kernel calls are involved
p26138
aVOnly API calls that use kernel resources (CreateThread, VirtualAlloc, etc) will call into the "real" operating system (ntdll
p26139
aVdll) and trap into ring 0 with a software interrupt (int 0x2e)
p26140
as(dp26141
g9
V17034
p26142
stp26143
a((dp26144
g2
(lp26145
VThe Settings
p26146
aVDesigner
p26147
aVcs file doesn't contain values, only application setting property declarations
p26148
aVThe values are stored separately
p26149
aVApplication setting values go into the app
p26150
aVexe
p26151
aVconfig file, user scoped setting values go in an appdata folder that has a name generated by a hashing algorithm
p26152
aVYou'd only have trouble with the latter
p26153
aVShouldn't matter, the file won't exist when you deploy your Release build to a machine
p26154
aVIn case you mean "can I change the default value" then the answer is: not when you use the settings designer
p26155
aVYou'll have to move the setting into a separate class
p26156
aVMake it look similar to this:
p26157
aVMake sure the namespace name matches the one used in the Settings
p26158
aVDesigner
p26159
aVcs file and that you delete the setting from the Settings page
p26160
as(dp26161
g9
V17034
p26162
stp26163
a((dp26164
g2
(lp26165
VUse dual interfaces instead
p26166
aVWrite their declaration in IDL so you can create a type library with midl
p26167
aVexe
p26168
aVWhich you can then #import into the client app, that automatically generates a wrapper based on the _com_ptr_t class
p26169
aVDual interfaces are automatically generated when you use the ATL Object wizard
p26170
as(dp26171
g9
V17034
p26172
stp26173
a((dp26174
g2
(lp26175
VYour code snippets are not helpful, they cannot compile as given and don't show the real source of the error
p26176
aVReview the MSDN Library docs for C2663, it doesn't have anything to do with the argument
p26177
aVThe object pointer is the problem
p26178
aVBeware that your StringToHGlobalAnsi() call as posted is a memory leak
p26179
aVYou have to call Marshal::FreeHGlobal() on the returned IntPtr after you're done with the string
p26180
aVSomebody is going to have to copy it
p26181
as(dp26182
g9
V17034
p26183
stp26184
a((dp26185
g2
(lp26186
VTo avoid this, use Project + Properties, Build tab, scroll down, Advanced, Language Version = "C# 3
p26187
aV0"
p26188
as(dp26189
g9
V17034
p26190
stp26191
a((dp26192
g2
(lp26193
VUse the AddHandler statement to subscribe to the Click event:
p26194
aVThe sender argument of the pic_Click() method gives you a reference to the picture box back:
p26195
aVIf you need additional info about the specific control, like an index, then you can use the Tag property
p26196
as(dp26197
g9
V17034
p26198
stp26199
a((dp26200
g2
(lp26201
VWorking from the assumption that you don't want to spend a lot of money on it, go here
p26202
as(dp26203
g9
V17034
p26204
stp26205
a((dp26206
g2
(lp26207
VJust write your own version of fread()
p26208
aVPass the
p26209
aVobj or
p26210
aVlib to the linker before the CRT library and the linker will pick your definition instead of the one from the CRT library
p26211
as(dp26212
g9
V17034
p26213
stp26214
a((dp26215
g2
(lp26216
VUse the RegionInfo
p26217
aVISOCurrencySymbol property
p26218
aVFor example:
p26219
aVOutput: "USD"
p26220
as(dp26221
g9
V17034
p26222
stp26223
a((dp26224
g2
(lp26225
VYou'll need a TypeConverter to convert between the string representation of the type, as displayed in the Properties window, and the Type
p26226
aVYou are very unspecific in your question so I'll just punt an answer
p26227
aVA good candidate is the TypeListConverter class, it already does the heavy lifting
p26228
aVYou just need to derive your own and call the base constructor with a list of the Types you accept:
p26229
aVAfter you drop this control on a form, you can use the combobox for the Type property and choose between the three types
p26230
aVIf this is not suitable then you'll have to make your own TypeConverter
p26231
aVUse Reflector to have a look at TypeListConverter
p26232
aVIt isn't very big
p26233
as(dp26234
g9
V17034
p26235
stp26236
a((dp26237
g2
(lp26238
VDoing this by hand is pretty courageous
p26239
aVHaving a folder name with an extension
p26240
aVzip sounds wrong, I don't see a similar one in the existing templates
p26241
aVWatch out for the shell's habit of turning
p26242
aVzip archives into folders
p26243
aVBest thing to do is to use the documented procedure to create a project template and verify what effects it has so you can repro them accurately yourself
p26244
aVCreate a new project, using one of the existing templates as a starter
p26245
aVYou might as well make it look as close as possible to the ultimate template you want to end up with, add project items as desired
p26246
aVThen use File + Export Template
p26247
aVNext
p26248
aVFill in the text boxes, note the Output location
p26249
aVFinish
p26250
aVHave a look-see at the generated
p26251
aVzip file
p26252
as(dp26253
g9
V17034
p26254
stp26255
a((dp26256
g2
(lp26257
VYou cannot use EndOfStream reliably here
p26258
aVThe StreamReader
p26259
aVEndOfStream property will call StandardOutput
p26260
aVRead() if it doesn't have any characters buffered
p26261
aVThat Read() call will block if the process isn't sending anything to its output pipe and doesn't close it
p26262
aVWhich is pretty much guaranteed to happen since it will be waiting for input
p26263
aVEndOfStream won't return true until the process has closed its end of the output pipe and the StreamReader has consumed all its buffered characters
p26264
aVAt program termination
p26265
aVUsing BeginOutputReadLine() might be a better way to detect the "marker" line
p26266
aVBeware that the callback happens on another thread
p26267
aVAlso note that it shouldn't be necessary to wait for the process to send the marker, anything you write will be buffered until the process is ready to read it
p26268
aVBeware that the buffers are smallish, deadlock is possible
p26269
as(dp26270
g9
V17034
p26271
stp26272
a((dp26273
g2
(lp26274
VHash functions like this one are supposed to overflow
p26275
aVYou have to declare "hash" unsigned
p26276
aVIf you really need an int than simply use hash & 0x7fffffff
p26277
aVReview the Fowler-Noll-Vo algorithm, you'll find links to source code there
p26278
as(dp26279
g9
V17034
p26280
stp26281
a((dp26282
g2
(lp26283
VA UI thread has a number of characteristics that make it special:
p26284
aVWindows has a message queue associated with the thread
p26285
aVThis happens as soon as the very first window gets created on the thread
p26286
aVThe thread runs a message loop, allowing Windows to dispatch messages to the windows
p26287
aVThe message loop gets created as soon as you call Application
p26288
aVRun()
p26289
aVCOM was initialized on the thread, requesting a single-threaded apartment
p26290
aVAn STA is necessary to allow many Windows features to work properly, features that are not thread-safe by design
p26291
aVCOM ensures that these features are always called in a thread-safe manner, marshaling the call from a worker thread to the STA thread as needed
p26292
aVExamples of these features are Drag+Drop, the clipboard, the shell dialogs (OpenFileDialog etc)
p26293
aVThe thread never blocks on any operation, it stays responsive so it can dispatch Windows messages as required to keep the user interface responsive and COM marshaling requests flowing
p26294
aVMaking calls to WaitHandle
p26295
aVWaitAny() for example are explicitly forbidden and generate an exception
p26296
aVThe startup thread of a process is almost always selected as the UI thread, although that's not a hard requirement
p26297
aVThe STA state is selected by the [STAThread] attribute on the Main() method
p26298
aVYou can create another UI thread by ensuring that the above requirements are met
p26299
aVThat could look like this in a boilerplate WF app:
p26300
aVThat creates a second window, running on its own UI thread
p26301
aVNote that closing the startup form doesn't terminate the app
p26302
aVOne typical problem you have with this arrangement is that you've now got two separate windows, they are not associated with each other at all
p26303
aVThe 2nd window cannot be owned by the 1st, it has its own Z-order independent of the 1st
p26304
aVDifficult to deal with by the user
p26305
aVExcept in rare circumstances, this doesn't improve the user interface at all
p26306
as(dp26307
g9
V17034
p26308
stp26309
a((dp26310
g2
(lp26311
VWell, it is tricky, it isn't actually auto-generated code
p26312
aVThe Designer
p26313
aVcs file is generated by a project item template
p26314
aVThe Windows Forms design-time serializer only regenerates the InitializeComponent() method body and appends control declarations to the bottom of the file
p26315
aVThat doesn't really help you solve your problem
p26316
aVThe most effective fix I can think of is to simply edit the template
p26317
aVOn my machine, that's c:\u005cprogram files\u005cmicrosoft visual studio 10
p26318
aV0\u005ccommon7\u005cide\u005citemtemplatescache\u005ccsharp\u005cwindows forms\u005c1033\u005cform
p26319
aVzip\u005cform
p26320
aVdesigner
p26321
aVcs, put the attribute before the method
p26322
aVWhat you use doesn't really matter, no tool is going to expect this attribute to be there
p26323
as(dp26324
g9
V17034
p26325
stp26326
a((dp26327
g2
(lp26328
VThere's no automatic layout option for this
p26329
aVBut you can easily do it by implementing the ToolStrip
p26330
aVResize event
p26331
aVThis worked well:
p26332
aVBe sure to set the TSCB's AutoResize property to False or it won't work
p26333
as(dp26334
g9
V17034
p26335
stp26336
a((dp26337
g2
(lp26338
VAbsolutely, that's what it is all about
p26339
aVImport your solution into VS2010, Project + Properties, Application tab, change the Target Framework to
p26340
aVNET 4
p26341
ag2512
aVOpen the References node in the Solution Explorer window, select the Microsoft
p26342
aVmshtml reference and set its "Embed Interop Type" property to True
p26343
aVIt is automatically turned on for new projects that target 4
p26344
ag2512
aVThis works for any COM type library that you selected on the COM tab as well as any PIA you selected in the
p26345
aVNET tab
p26346
aVThe type library is only required at build time, you don't have to deploy the interop libraries or PIAs anymore
p26347
aVThe actual COM server must of course still be present on the target machine
p26348
aVThe new dynamic keyword and the optional and named argument features are not related, they merely make it easier to write cleaner code when working with COM servers that were designed to work with scripting languages
p26349
aVMshtml is already pretty clean, Office interop is the best example
p26350
aVAlso note that it tends to be easy to avoid taking a dependency on mshtml when you leverage the Windows Forms' HtmlDocument and HtmlElement classes
p26351
aVThat gets started by using the WebBrowser
p26352
aVDocument property
p26353
aVThey however don't wrap all mshtml features
p26354
as(dp26355
g9
V17034
p26356
stp26357
a((dp26358
g2
(lp26359
VHmm, watch out when committing to an architecture like this, they never work well in practice
p26360
aVThe first problem is the large amount of network traffic you'll create, that never scales well
p26361
aVMore seriously, you'll run into huge concurrency problems
p26362
aVBy definition, the "data changed" notification will be delivered late and there's no guarantee they'll be ordered
p26363
aVEverything works well as long as there is a long enough time delay between notifications, giving the sub-systems the chance to have a synchronized view of the data
p26364
aVBut that house of cards comes crashing down hard when the load increases and notifications start getting buffered
p26365
aVA sub-system will start making decisions on old views of the data and get out of sync with the views held by other sub-systems
p26366
aVNothing you can do about it either, you cannot "lock" across a network
p26367
aVAnd extremely hard to debug, the sync mismatches are completely random and spurious
p26368
aVPursue a centralized server approach, concurrency is much easier to deal with
p26369
as(dp26370
g9
V17034
p26371
stp26372
a((dp26373
g2
(lp26374
VI encourage you to download Reflector, you'll find a quick answer to a question like this
p26375
aVThe timer's interval is changed by TimerBase
p26376
aVChangeTimer()
p26377
aVIt takes several measures to ensure the interval update is safe and accurate
p26378
aVThe code runs in a finally block so that even a ThreadAbortException cannot mess it up
p26379
aVIt acquires a lock (m_lock member) to ensure access is serialized across threads
p26380
aVThe ChangeTimerNative() call calls into the CLR to update the native timer
p26381
aVThat method is implemented by TimerNative::CorChangeTimer(), it invokes the ChangeTimerQueueTimer() Windows API function
p26382
aVThat function is documented to be safe even when called from inside the Elapsed callback function
p26383
aVLong story short, yes: it has the behavior you are looking for
p26384
aVBeware however the inevitable race condition, the timer might already have elapsed and the threadpool thread that makes the callback may have already been scheduled to run but didn't get a chance to run yet
p26385
aVGetting the callback immediately after changing the timer is not impossible
p26386
as(dp26387
g9
V17034
p26388
stp26389
a((dp26390
g2
(lp26391
VOnly a few minor problem I'm aware of
p26392
aVA new C# project created in VS2010 will have a dependency on Microsoft
p26393
aVCSharp
p26394
aVdll, the runtime support assembly for the new "dynamic" keyword
p26395
aVWhen you change the target framework version to 3
p26396
aV5, you'll get a warning about this assembly, you have to remove it by hand
p26397
aVAlso, your code will be compiled by the new C# 4
p26398
aV0 compiler, even if you target an earlier version of the framework
p26399
aVThat could be the source of a compat problem, code that compiles differently with the 3
p26400
aV0 compiler
p26401
aVThe more common compat issue is code that shouldn't compile in 3
p26402
aV0 but did because of a compiler bug
p26403
aVNot a real problem of course, but could byte if you check in code that was written by team members that still use 3
p26404
ag2512
aVYou can force the compiler to verify that no new 4
p26405
aV0 features are used accidentally with Project + Properties, Build tab, scroll down/right, Advanced, Language Version = "C# 3
p26406
aV0"
p26407
aVIf you want to be sure then wait another couple of months and keep an eye on the feedback at connect
p26408
aVmicrosoft
p26409
aVcom
p26410
as(dp26411
g9
V17034
p26412
stp26413
a((dp26414
g2
(lp26415
VThe hardware state is your model
p26416
aVHow it gets updated is not part of the pattern, only how an update to the state affects your view
p26417
as(dp26418
g9
V17034
p26419
stp26420
a((dp26421
g2
(lp26422
VThis solution should be close
p26423
aVNot 100%, there is no easy way to find out that items were added to an empty list
p26424
aVAdd a new class to your project and paste the code shown below
p26425
aVCompile
p26426
aVDrop the new control from the top of your toolbox onto your form
p26427
aVNo additional code is needed
p26428
aVOptional additional override that ensures an item is checked when the form first shows up:
p26429
as(dp26430
g9
V17034
p26431
stp26432
a((dp26433
g2
(lp26434
VThat cannot be it, the message identifiers have not changed
p26435
aVIt would help us help you if you documented what other message you get instead or what kind of window or control you are hooking
p26436
aVThe only difference in Message relevant to WM_LBUTTONDBLCLK is that WParam and LParam fields are now 64 bits instead of 32 bits
p26437
aVHard to get that wrong though, surely you are using the ToInt32() method
p26438
as(dp26439
g9
V17034
p26440
stp26441
a((dp26442
g2
(lp26443
VSeeing a user banging away at a control that overrides her decisions is a sad sight
p26444
aVSet the control's Enabled property to False
p26445
aVIf you don't like that then change its Items property so only one item is selectable
p26446
as(dp26447
g9
V17034
p26448
stp26449
a((dp26450
g2
(lp26451
VIt isn't going to work, you already know why
p26452
aVAvoid the copy or simply store the copy back:
p26453
as(dp26454
g9
V17034
p26455
stp26456
a((dp26457
g2
(lp26458
VAnother way is a sound cue
p26459
aVControl Panel + Sound, Sound tab
p26460
aVIn the Program Events list, locate the "Microsoft Visual Studio Macros" group, assign sounds to "Build Failed" and "Build Succeeded"
p26461
as(dp26462
g9
V17034
p26463
stp26464
a((dp26465
g2
(lp26466
VThe FTP server is unhappy about the STOR command that
p26467
aVNET generates
p26468
aVBest place to look is in the log file for the server
p26469
aVTaking a wild guess: the path is unusual, you'd typical want to specify a directory name (like ftp://myhost/somedir/filename)
p26470
as(dp26471
g9
V17034
p26472
stp26473
a((dp26474
g2
(lp26475
VThe actual values for the CurrentFilters are getting serialized using BinaryFormatter and stored in a
p26476
aVresx file
p26477
aVYou almost certainly don't want this to happen
p26478
aVFor one, you'll take a dependency on the [AssemblyVersion] number of the assembly that contains your QueryFilter class
p26479
aVWhich should explain the "unable to load type" exception you get now
p26480
aVFirst find out how CurrentFilters ended up with values at design time
p26481
aVYou'll need to beware of events that run at design time
p26482
aVThe typical candidates are the constructor and the Load event
p26483
aVUse the Control
p26484
aVDesignTime property to prevent code from running
p26485
aVNext, ensure that the property value doesn't get persisted by applying an attribute:
p26486
as(dp26487
g9
V17034
p26488
stp26489
a((dp26490
g2
(lp26491
VThe service installer classes are very light-weight, they just write a few registry entries
p26492
aVYou'll have trouble finding extensive documentation on the them, there just isn't much to write about
p26493
aVBest way to learn more is to take a look at their code with Reflector
p26494
as(dp26495
g9
V17034
p26496
stp26497
a((dp26498
g2
(lp26499
VThe 2nd image is being resized from 300x83 to 250x61
p26500
aVThe original image is anti-aliased, the anti-aliasing pixels are getting lost in the resizing operation
p26501
aVThat affects the perceived image quality badly
p26502
aVThis image will only look good if it is shown with its original size
p26503
aVAn image editor that uses a high-quality bi-cubic filter might do a better job, not so sure
p26504
as(dp26505
g9
V17034
p26506
stp26507
a((dp26508
g2
(lp26509
VInternal calls end up making a call to a C++ function in the CLR
p26510
aVYou can find them back in the Rotor source code
p26511
aVLook at clr\u005csrc\u005cvm\u005cecall
p26512
aVcpp to find the mapping from the
p26513
aVNET visible name to the CLR function name
p26514
aVBeware that the source is getting dated
p26515
as(dp26516
g9
V17034
p26517
stp26518
a((dp26519
g2
(lp26520
VAsk your partner to save the source code file encoded in UTF-16 or UTF-8
p26521
aVIt is still not the default encoding for C++ source code, Unicode is slow to catch up
p26522
aVFile + Save As, click on the arrow of the Save button, Save with Encoding, choose UTF-8
p26523
aVYou should be able to do this yourself as well
p26524
aVFile + Open, select the
p26525
aVcpp file(s), click on the arrow of the Open button, Open With, select "C++ Source Code Editor (with encoding)"
p26526
aVPick the correct Chinese encoding (there are several to choose from) from the Encoding dialog box
p26527
as(dp26528
g9
V17034
p26529
stp26530
a((dp26531
g2
(lp26532
VIt's not a ListView, not a TreeView, its the enigmatic DirectUIHWnd
p26533
aVBeen around a long time, back to XP's Welcome screen
p26534
aVStill not documented
p26535
as(dp26536
g9
V17034
p26537
stp26538
a((dp26539
g2
(lp26540
VYou can use SystemParameters
p26541
aVScrollWidth
p26542
as(dp26543
g9
V17034
p26544
stp26545
a((dp26546
g2
(lp26547
VNo can do, the C++/CLI compiler didn't get updated to accept the lambda syntax
p26548
aVFairly ironic btw given the head-start that managed code had
p26549
as(dp26550
g9
V17034
p26551
stp26552
a((dp26553
g2
(lp26554
VYou've got bigger problems, Unix accepts characters in a file name than Windows does not allow
p26555
aVThis code will bomb with ArgumentException, "Illegal characters in path":
p26556
aVYou can't reliably use Path
p26557
aVCombine() for Unix paths
p26558
as(dp26559
g9
V17034
p26560
stp26561
a((dp26562
g2
(lp26563
VThere are only a few reasons I know of why Edit+Continue would be disabled in the Debug build
p26564
aVFirst and foremost is a 64-bit operating system, E+C only works for 32-bit code
p26565
aVFix that with Project + Properties, Build tab, Platform Target = x86
p26566
aVIt is also an option that might have been turned off
p26567
aVTools + Options, Debugging, Edit and Continue, Enable checkbox
p26568
aVIf this doesn't help, tell us a bit more about the kind of code you're debugging, the project template you selected when you started the project, how you got the debugger to break and a stack trace copied from the Call Stack window
p26569
as(dp26570
g9
V17034
p26571
stp26572
a((dp26573
g2
(lp26574
VI updated your question with the code snippet
p26575
aVAfter proper indenting, it is immediately clear what the problem is: you use File
p26576
aVCreate() but don't close the FileStream that it returns
p26577
aVDoing it that way is unnecessary, StreamWriter already allows appending to an existing file and creating a new file if it doesn't yet exist
p26578
aVLike this:
p26579
aVWhich uses this StreamWriter constructor
p26580
as(dp26581
g9
V17034
p26582
stp26583
a((dp26584
g2
(lp26585
VUnmanaged code is only abortable if it is an "alertable wait state"
p26586
aVIt won't be when it is burning 100% cpu cycles
p26587
aVP/Invoking TerminateThread would work, assuming you could obtain the thread handle, which
p26588
aVNET makes very difficult
p26589
aVIt won't help anyway, you'll leak the thread stack
p26590
aVAt one megabyte, you'll quickly run out of virtual memory
p26591
aVEven if this only an occasional need, you're still liable to run into major problems since the thread has mutated global program state and you don't know how to restore it
p26592
aVThe only good way to abort unmanaged code is to run it in a separate process and shoot it in the head with Process
p26593
aVKill()
p26594
aVThe operating system will clean up the shrapnel
p26595
aVYou'll need to write a little hosting program for the DLL and use one of the process interop facilities to talk to it
p26596
aVSockets, named pipes,
p26597
aVNET remoting, WCF, take your pick
p26598
as(dp26599
g9
V17034
p26600
stp26601
a((dp26602
g2
(lp26603
V is not a standard Win32 API error code
p26604
aVTypical errors returned by file related APIs that take a file name are  and
p26605
aVThe best way to figure out what error code to return is use a WDK sample as a guide
p26606
aVThe cdfs sample's  source code file for example
p26607
aVIt returns  if it cannot locate a directory,  if it cannot locate a file
p26608
as(dp26609
g9
V17034
p26610
stp26611
a((dp26612
g2
(lp26613
VUnfortunately, the 64-bit version is accurate
p26614
aVIt really is an overflow, the result of the expression is a long with the value &hffffffff
p26615
aV;  The sign bit is AND-ed off the value, it is no longer negative
p26616
aVThe resulting value cannot be converted to an integer, the maximum integer value is &h7fffffff
p26617
aV;  You can see this by adding this code to your snippet:
p26618
aVOutput: 4294967295
p26619
aVThe x64 jitter uses an entirely different way to check for overflows, it doesn't rely on the CPU overflow exception but explicitly compares the values to Integer
p26620
aVMaxValue and Integer
p26621
aVMinValue
p26622
aVThe x86 jitter gets it wrong, it optimizes the code too much and ends up making an unsigned operation that doesn't trip the CPU exception
p26623
aVFiling a bug report at connect
p26624
aVmicrosoft
p26625
aVcom is probably not worth the effort, fixing this for the x86 jitter would be a drastically breaking change
p26626
aVYou'll have to rework this logic
p26627
aVNot sure how, I don't see what you are trying to do
p26628
as(dp26629
g9
V17034
p26630
stp26631
a((dp26632
g2
(lp26633
VSure, just change your project's startup form so that form gets loaded first
p26634
aVSaves you from having to click the button to show the form, small savings though
p26635
aVProject + Properties, Application tab, change the "Startup form" setting
p26636
as(dp26637
g9
V17034
p26638
stp26639
a((dp26640
g2
(lp26641
VYour Debug toolbar doesn't look like mine
p26642
aVNo problem, you can change it
p26643
aVTools + Customize, Commands tab, click Toolbar radio, select "Debug"
p26644
aVSelect the location where you want to insert the button
p26645
aVClick Add Command, select Debug + Restart
p26646
as(dp26647
g9
V17034
p26648
stp26649
a((dp26650
g2
(lp26651
VThere's no such thing as a "
p26652
aVNET 3
p26653
aV5 method", there are only
p26654
aVNET 3
p26655
aV5 assemblies
p26656
aVAdded to the
p26657
aVNET 2
p26658
aV0 release, just like
p26659
aVNET 3
p26660
ag2512
aVThe base 2
p26661
aV0 classes and the CLR haven't changed, using a method from a type that is only available in
p26662
aVNET 3
p26663
aV5 is easily avoided by using the Target Framework version feature in Visual Studio
p26664
aVWell, that's the company line
p26665
aVIt isn't quite accurate, they actually did change the 2
p26666
aV0 assemblies in a few selected spots
p26667
aVWithout changing the [AssemblyVersion], very naughty
p26668
aVThe best example is WaitHandle
p26669
aVWait(int)
p26670
aVIt didn't exist in the original 2
p26671
aV0 release, it got added in 3
p26672
ag2447
aVThey papered this over by concurrently releasing
p26673
aVNET 2
p26674
aV0 SP1 with
p26675
aVNET 3
p26676
aV5, it does have the added method
p26677
aVAgain with
p26678
aVNET 3
p26679
aV5 SP1, concurrent with
p26680
aVNET 2
p26681
aV0 SP2
p26682
aVFwiw, these service packs don't just add missing methods, they also fix known stability and security problems
p26683
aVThere is no tool that I'm aware of that can check if your code fails when
p26684
aVNET 2
p26685
aV0 RTM
p26686
aVThe client was supposed to deploy the service packs
p26687
aVThey are hard to avoid, Windows Update pushes them
p26688
aVIf you want to support a client that refuses to deploy the updates then you'll have to test your code on a virgin
p26689
aVNET 2
p26690
aV0 install
p26691
as(dp26692
g9
V17034
p26693
stp26694
a((dp26695
g2
(lp26696
VNot sure I see the question
p26697
aVBut yeah, that can work:
p26698
as(dp26699
g9
V17034
p26700
stp26701
a((dp26702
g2
(lp26703
VThe Windows Forms designer has dedicated designer classes for most controls
p26704
aVThe designer for a ListView is System
p26705
aVWindows
p26706
aVForms
p26707
aVDesign
p26708
aVListViewDesigner, an internal class in the System
p26709
aVDesign
p26710
aVdll assembly
p26711
aVThis class gives you the ability to drag the column headers
p26712
aVA UserControl uses the System
p26713
aVWindows
p26714
aVForms
p26715
aVDesign
p26716
aVControlDesigner designer class
p26717
aVIt doesn't do anything special, just puts a rectangle around the control with drag handles
p26718
aVYou can see where this is heading: after you put your user control on a form, it is ControlDesigner that is used to design the class, ListViewDesigner is not in the picture
p26719
aVYou thus lose the ability to drag the column headers
p26720
aVAlso note that ControlDesigner doesn't give access to the controls inside the UC
p26721
aVThat's fixable however by creating your own designer
p26722
aVStart with Projects + Add Reference, select System
p26723
aVDesign
p26724
aVYou'll need to add a public property to the UC to expose the list view and apply the [DesignerSerializationVisibility] attribute to allow changed properties to be saved
p26725
aVAnd apply the [Designer] attribute to the UC class to replace the default designer
p26726
aVIt all should resemble this (using the default names and a ListView that displays "employees"):
p26727
aVThe list view in the user control can now be clicked and designed as normal
p26728
as(dp26729
g9
V17034
p26730
stp26731
a((dp26732
g2
(lp26733
VIt is not a security issue
p26734
aVIt's the fact that you are running on a 64-bit operating system
p26735
aV64-bit apps have a different view of HKLM\u005cSoftware than 32-bit apps
p26736
aV64-bit apps get the "normal" view, 32-bit apps are redirected to HKLM\u005cSoftware\u005cWow6432Node
p26737
aVThe EXE determines the bit-ness of the process, it will be different when mstest runs the code
p26738
aV32-bit, probably
p26739
aVYou'll need to create the key you are trying to read in the Wow6432Node tree
p26740
aVOr make the regular app have the same bit-ness, Project + Properties, Build tab, Platform Target = x86
p26741
aVAlso changeable on-the-fly with Corflags
p26742
aVexe
p26743
as(dp26744
g9
V17034
p26745
stp26746
a((dp26747
g2
(lp26748
VYour [InterfaceType] attribute is wrong
p26749
aVVB6 requires an IDispatch interface, it cannot handle an IUnknown interface
p26750
aVIt likes ComInterfaceType
p26751
aVInterfaceIsDual best, that produces a full type library, enables IntelliSense in the VB6 editor and is roughly a 1000 times faster than the late-bound IDispatch
p26752
as(dp26753
g9
V17034
p26754
stp26755
a((dp26756
g2
(lp26757
VThe ability to map a managed thread to a custom threading scheme was introduced in
p26758
aVNET 2
p26759
aV0 for custom CLR hosts
p26760
aVSpecifically, SQL Server
p26761
aVThey wanted to use fibers, a native feature of SQL Server
p26762
aVThey couldn't make a go of it, the project was shelved
p26763
aVThere are no CLR hosts that I'm aware of right now that actually take advantage of the feature
p26764
aVIt will never be an issue in the default CLR host, the one you get in a WPF app
p26765
aVA managed thread always maps to one OS thread and does so consistently
p26766
aVYou can rely on the value returned by GetCurrentThreadId()
p26767
aVI seriously doubt that will ever change, it would be a major breaking change
p26768
aVThis isn't likely to be true to some kind of future host, similar to Silverlight, but your code will never get close to that
p26769
as(dp26770
g9
V17034
p26771
stp26772
a((dp26773
g2
(lp26774
VHere's yet another answer you won't like
p26775
aVIt has nothing to do with your ancient version of MFC, it is a documented limitation for the list view control
p26776
aVFrom the SDK docs for the LVITEM structure's pszText member:
p26777
aVIf the structure receives item
p26778
aVattributes, pszText is a pointer to a
p26779
aVbuffer that receives the item text
p26780
aVNote that although the list-view control allows any length string to be
p26781
aVstored as item text, only the first
p26782
aV260 TCHARs are displayed
p26783
as(dp26784
g9
V17034
p26785
stp26786
a((dp26787
g2
(lp26788
VNice find, but you are taking advantage of an otherwise undocumented feature
p26789
aVIt is common for native Windows controls to not interpret control characters
p26790
aVListBox still doesn't do it for example
p26791
aVLabel doesn't expand tabs
p26792
aVEtcetera
p26793
aVUpdating the XP listview is not an option, you'll need to use custom drawing to get this right
p26794
aVUse the ListView
p26795
aVDrawItem event, there's a good example in the MSDN Library topic for it
p26796
as(dp26797
g9
V17034
p26798
stp26799
a((dp26800
g2
(lp26801
VEric Lippert recently blogged about it
p26802
aVFour blog posts no less, check it out
p26803
aVStart at part one
p26804
as(dp26805
g9
V17034
p26806
stp26807
a((dp26808
g2
(lp26809
VThere are not a lot of candidates for this problem
p26810
aVBut one: a bitmap records the resolution of the device on which it was created
p26811
aVTypical defaults are 96 or 120 dots per inch on a Windows machine
p26812
aVWPF will rescale the image on the target device so it has the same size, measured in inches rather than pixels
p26813
aVSounds like your editor is gimpy, not recording the DPI properly
p26814
aVYou can see it in mspaint
p26815
aVexe with the Properties command
p26816
as(dp26817
g9
V17034
p26818
stp26819
a((dp26820
g2
(lp26821
VThere's no point in doing it this way
p26822
aVCall one helper method asynchronously
p26823
aVIt should call the three methods you are now running asynchronously
p26824
aVSequencing them is now simple and you only have one async method to worry about
p26825
aVMore efficient too, you are not starting and switching between threads anymore
p26826
aVIt actually takes less time
p26827
as(dp26828
g9
V17034
p26829
stp26830
a((dp26831
g2
(lp26832
VYes, this is a very nearly breaking change in VS2010 and a bit of a mess
p26833
aVNew solutions created in 2010 will have two configurations, "Debug|x86" and "Release|x86"
p26834
aVWhich is different from solutions created by previous versions, "Debug|Any CPU" and "Release|Any CPU" were the defaults
p26835
aVWhen you then add an existing project created in a previous version to this VS2010 created solution, you'll get a nasty mixed bag
p26836
aVThe platform combo now shows three options, "x86", "Any CPU" and "Mixed platforms"
p26837
aVThe latter will build all projects
p26838
aVWhat is also very confuzzling is that the configuration name actually doesn't directly affect the Platform Target setting
p26839
aVIt is fixable, you can search and replace "Any CPU" with "x86" in the
p26840
aVsln and
p26841
aVvcproj files with a text editor
p26842
aVBest approach perhaps is to stay out of trouble and let VS2010 convert a VS2008 solution instead of creating a new one
p26843
aVYucky problem
p26844
as(dp26845
g9
V17034
p26846
stp26847
a((dp26848
g2
(lp26849
VIt's a driver bug
p26850
aVYour version is already 6 years old
p26851
aVDownload the latest and greatest from here
p26852
as(dp26853
g9
V17034
p26854
stp26855
a((dp26856
g2
(lp26857
VNot sure what your deployment scenario looks like, but running a debugger on a customer or production machine isn't typically very practical
p26858
aVWrite an event handler for the AppDomain
p26859
aVUnhandledException event and display the value of e
p26860
aVExceptionObject
p26861
aVToString()
p26862
aVAt a minimum, your customer can send you a screen shot
p26863
aVYou'll get the exception message and a nice stack trace, showing how your program got in trouble
p26864
aVUsually 95% good enough to see what went wrong
p26865
as(dp26866
g9
V17034
p26867
stp26868
a((dp26869
g2
(lp26870
VYes, that's accurate
p26871
aVLinkedList doesn't use an array for storage, it really is a chain of references
p26872
aVYou'll get no garbage in the Large Object Heap when you need to store a large number of elements, unlike List, and avoid trouble with address space fragmentation conking your program out early
p26873
aVBeware that it is not a substitute for List, indexing is O(n) instead of O(1)
p26874
aVBig difference, unless you always iterate the list sequentially
p26875
aVWhen you need to make shrill choices like these, it is high time to start considering a 64-bit operating system
p26876
as(dp26877
g9
V17034
p26878
stp26879
a((dp26880
g2
(lp26881
VYou are hanging the UI thread with that
p26882
aVIt won't get around to doing its normal duties, like paint the text box, until the process has exited
p26883
aVSimilarly, the BeginInvoke() delegate target cannot run until the UI thread goes idle again
p26884
aVThey'll stack up in the invoke queue, in extreme cases you'll run out of memory
p26885
aVEven after the process exits, the UI thread will be unresponsive for some time while it works on emptying the queue
p26886
aVYou don't need it here
p26887
aVIf necessary, use the Process
p26888
aVExited event instead
p26889
as(dp26890
g9
V17034
p26891
stp26892
a((dp26893
g2
(lp26894
VWebBrowser (aka Internet Explorer) has no such capabilities
p26895
aVYou'd have to host it in a window that uses the WS_EX_LAYERED style flag and use SetLayeredWindowAttributes() to make the color key match the background of the displayed HTML
p26896
aVAvoid displaying any text, it is going to look bad when the anti-aliasing pixels no longer blend the letter with the background
p26897
as(dp26898
g9
V17034
p26899
stp26900
a((dp26901
g2
(lp26902
VSounds to me like you are re-inventing the ExpandoObject class
p26903
aVConsider a collection of those for your implementation instead
p26904
as(dp26905
g9
V17034
p26906
stp26907
a((dp26908
g2
(lp26909
VYes, on a Windows server you'll be using a different kind of garbage collector
p26910
aVIt is tuned more to the needs of a server style application, it collects garbage less aggressively
p26911
aVYou can change this behavior with an app
p26912
aVconfig file, using the  element
p26913
aVThat isn't very likely to be the real problem btw, I'd guess that your app sees a more realistic pattern of usage
p26914
aVIntentionally forcing x86 mode when you've got a nice 64-bit server is something you'd want to avoid, if you can
p26915
as(dp26916
g9
V17034
p26917
stp26918
a((dp26919
g2
(lp26920
VThe debugger visualizer for Dictionary is the exact same class with the exact same behavior
p26921
aVIt is still the private Mscorlib_DictionaryDebugView class
p26922
aVUnexpanded it shows Count, expanded it shows an array of the elements
p26923
aVYour code snippet suggests that you are using a completely different Dictionary class, one that is not generic
p26924
as(dp26925
g9
V17034
p26926
stp26927
a((dp26928
g2
(lp26929
VThere is a rough equivalent of the C++ friend keyword in managed code
p26930
aVAlthough it works at the assembly level, not the class level
p26931
aVYou can use the  attribute
p26932
as(dp26933
g9
V17034
p26934
stp26935
a((dp26936
g2
(lp26937
VYou can override a form's ProcessCmdKey() method, it runs before any control on the form will see the key stroke
p26938
aVIf you really need this to be at the application level (all forms) then you should have your main form implement the IMessageFilter interface
p26939
aVFor example:
p26940
as(dp26941
g9
V17034
p26942
stp26943
a((dp26944
g2
(lp26945
VYou are getting an error because you declared the argument with the ref keyword
p26946
aVThat's not correct, Person is already a reference type and the object that VB6 is using is a variant, not a Person
p26947
aVJust omit "ref"
p26948
aVUsing Option Explicit On is a good practice in VB6 btw
p26949
aVYou are not getting IntelliSense because you probably didn't declare the interfaces with the [InterfaceType(ComInterfaceType
p26950
aVInerfaceIsDual)]
p26951
aVMicrosoft recommends against this because of the DLL Hell problems with dual interfaces
p26952
aVRequired though to get a type library to help VB6 display the IS you want
p26953
as(dp26954
g9
V17034
p26955
stp26956
a((dp26957
g2
(lp26958
VThe items you list are not tests in the traditional sense
p26959
aVYou'd need some kind of static analysis tool, similar to FxCop or StyleCop
p26960
aVI'm not aware of a product made specifically for Windows Forms that can do what you listed
p26961
aVThat usually requires massively parallel computing hardware, the kind that the new guy carries between his ears
p26962
aVDon't hesitate to run FxCop btw, you'll probably get plenty of flags if you've never subjected your code to it before
p26963
aVStyleCop is good if the new guy complains about coding standards
p26964
as(dp26965
g9
V17034
p26966
stp26967
a((dp26968
g2
(lp26969
VUsing DLLs with exports that take C++ classes as their argument is dangerous even in C++
p26970
aVIt is impossible to interop with C#
p26971
aVYou cannot use the same memory allocator and you can't call the constructor and destructor
p26972
aVNot to mention that your C++ code isn't valid, it doesn't actually return the string
p26973
aVUse a C string instead
p26974
aVMake it look like this:
p26975
aVSome notes with these code snippets:
p26976
aVThe __stdcall declarator selects the standard calling convention for DLL exports so that you don't have to use the CallingConvention property in the [DllImport] attribute
p26977
aVThe C++ code uses wchar_t, suitable to store Unicode strings
p26978
aVThis prevents loss of data when the text you get from the XML file is converted to 8-bit characters, a lossy conversion
p26979
aVSelecting the proper msgLen argument is important to keep this code reliable
p26980
aVDo not omit it, the C++ code will destroy the garbage collected heap if it overflows the "msg" buffer
p26981
aVIf you really do need to use std::string then you'll need to write a ref class wrapper in the C++/CLI language so it can convert from System
p26982
aVString to std::string
p26983
as(dp26984
g9
V17034
p26985
stp26986
a((dp26987
g2
(lp26988
VYou'll have to tweak your "real-time" requirement
p26989
aVA process can open and close hundreds of files in the time it takes to start that program
p26990
aVGiven that you can never get a truly accurate view of file usage, you might as well reduce the rate at which you start the program
p26991
aVOne immediate benefit is that you'll greatly reduce the CPU load
p26992
aVA better mousetrap is the Sysinternals' Handle utility
p26993
aVIt's a much lighter weight program
p26994
aVAnd is a console mode app, you can redirect its output so you don't have to use a file
p26995
aVAnd there's no wait cursor
p26996
aVIt also allows selecting a specific process with the -p command line argument, an option you really want to use to keep execution time down to a reasonable level
p26997
aVThis sample code worked pretty well:
p26998
aVOh, and resist the temptation to use its "close file" option
p26999
aVThat's only good if you are looking for a way to permanently destroy data on your hard drive
p27000
as(dp27001
g9
V17034
p27002
stp27003
a((dp27004
g2
(lp27005
VIt is the 1st argument that's declared wrong
p27006
aVThat throws off the stack frame and prevents the unmanaged code from properly reading the pointer for the 2nd argument
p27007
aV"long" is 64-bits, DDCFileHandle is almost certainly a pointer, 32-bits on a 32-bit operating system
p27008
aVChange the argument declaration to IntPtr
p27009
aVYou'll also need to change the declaration of the function that returns that handle
p27010
as(dp27011
g9
V17034
p27012
stp27013
a((dp27014
g2
(lp27015
VNot sure I follow, but you need to use Opcodes
p27016
aVCallVirt to call virtual methods
p27017
aVWhich should automatically invoke the overridden method
p27018
as(dp27019
g9
V17034
p27020
stp27021
a((dp27022
g2
(lp27023
VYou'll need to use the return value of Read() to determine how many bytes you actually got
p27024
aVIt doesn't have to be 512, you already found that out
p27025
aVAnd keep in mind that you are working with streams, not arrays
p27026
aVMake it look similar to this:
p27027
as(dp27028
g9
V17034
p27029
stp27030
a((dp27031
g2
(lp27032
VSolution files are pretty simple text files
p27033
aVOpen one with Notepad to have a look-see
p27034
aVYou could easily write a little program that generates them
p27035
as(dp27036
g9
V17034
p27037
stp27038
a((dp27039
g2
(lp27040
VYou are hammering a 16-bit QChar into a 8-bit hole
p27041
aVYou'll need to send and receive 2 bytes per character or restrict yourself to an 8-bit character encoding
p27042
as(dp27043
g9
V17034
p27044
stp27045
a((dp27046
g2
(lp27047
VUseful to check compiler settings as well as verifying macro value combinations
p27048
aVSome random examples:
p27049
as(dp27050
g9
V17034
p27051
stp27052
a((dp27053
g2
(lp27054
VYou are battling the rulez of SetForegroundWindow()
p27055
aVNote the long list of "it won't work" in the Remarks section
p27056
aVAllowSetForegroundWindow() is the solution
p27057
aVTo ensure that a window always overlaps another window, display it with the Show() or ShowDialog() override that takes the owner argument
p27058
aVFor example:
p27059
aVAn owned window is always shown on the top of its owner and gets minimized and closed along with its owner
p27060
aVMaking the window of another process the owner of your window is expressly forbidden by the Windows SDK
p27061
aVWindows Forms won't let you do this
p27062
aVThere is however an appcompat mode for Windows version 3 apps
p27063
aVBack then, there was no problem doing this, it didn't support threading
p27064
aVP/Invoke SetParent() on your window and pass the window handle of the window from the other process
p27065
aVIt breaks the warranty, but tends to work well
p27066
as(dp27067
g9
V17034
p27068
stp27069
a((dp27070
g2
(lp27071
VYou are forgetting about the code in the app required to make the call
p27072
aVCreating the array and filling it takes a lot more IL than just passing 3 args
p27073
as(dp27074
g9
V17034
p27075
stp27076
a((dp27077
g2
(lp27078
VThe problem is likely located in this section:
p27079
aVYou've got some code there that corrupts the heap
p27080
aVOverflowing an array is the typical cause
p27081
aVHeap corruption is rarely detected at the time the corruption happens
p27082
aVOnly later, when some code allocates or releases memory and has some basic heap health verification built in
p27083
aVLike fclose() does
p27084
as(dp27085
g9
V17034
p27086
stp27087
a((dp27088
g2
(lp27089
VI don't get the problem
p27090
aVThe extern keyword does not affect the calling convention, merely the name presented to the linker
p27091
aVA function written in C++ that is not an instance method is still __cdecl, with or without extern "C"
p27092
aVFurthermore, as long as you keep createActions() in the same source code file, these functions don't need external linkage
p27093
aVYou could declare them static or put them in an unnamed namespace to avoid collisions
p27094
as(dp27095
g9
V17034
p27096
stp27097
a((dp27098
g2
(lp27099
VIt is not a great error message
p27100
aVThe problem is that the compiler cannot generate code for the constructor call, it hasn't yet seen the definition of the Dotted class
p27101
aVC++ compilers are still single-pass compilers
p27102
aVYou cannot write the method inline, you have to move it
p27103
as(dp27104
g9
V17034
p27105
stp27106
a((dp27107
g2
(lp27108
VWell, that's not good
p27109
aVYou however haven't proven yet that the CLR's exception handling logic is completely borked
p27110
aVWhat you describe could also be explained by something detaching the debugger
p27111
aVThe Java JVM would certainly be a candidate
p27112
aVCheck if a try still works, if it does you still stand a chance to use this COM server
p27113
aVDebugging is however going to be painful
p27114
aVWith some luck, the detach happens only once
p27115
aVTry writing System
p27116
aVDiagnostics
p27117
aVDebugger
p27118
aVBreak() after the very first call to the server, click "Debug" on the dialog you'll get
p27119
aVAlso test if a null reference exception still works, that's a hardware exception that's liable to be redirected by a VM calling Windows' SetUnhandledExceptionFilter()
p27120
aVIf that can't be caught then you should not use this COM server as-is, it will destabilize your process too much
p27121
aVRunning it in a separate process and talking to it with WCF or Remoting is a desperation move that could work out
p27122
aVNeedless to say, this component vendor is violating the COM server contract badly
p27123
aVYou shouldn't have to put up with it
p27124
as(dp27125
g9
V17034
p27126
stp27127
a((dp27128
g2
(lp27129
VThe main thread of your program has been busy executing code for a minute
p27130
aVIt is not taking care of its normal duties, pumping the message loop
p27131
aVThat's illegal when you use COM servers in a worker thread: calls to their methods cannot be dispatched until your main thread goes idle again
p27132
aVIt should be readily visible, your UI should be dead as a door nail
p27133
aVWindows should have replaced your main window with a ghost that displays "Not Responding"
p27134
aVClosing the window won't work, no click events have any effect
p27135
aVWhatever your main thread is doing should be done by a worker thread instead
p27136
aVThe  class is good for that, you'll find many usage help in the MSDN Library article for it
p27137
aVUse Debug + Break All, Debug + Windows + Threads if you have no idea what the main thread is doing
p27138
aVOne more possible cause: be sure to install service pack 1 if you are using the RTM version of VS2005
p27139
as(dp27140
g9
V17034
p27141
stp27142
a((dp27143
g2
(lp27144
VYou can change this bitness of the assembly with the Corflags
p27145
aVexe utility
p27146
aVUse the Visual Studio Command Prompt shortcut, then:
p27147
aVIt isn't terribly likely to work, forcing the x86 target is often done because an assembly has a dependency on unmanaged code that's only available in 32-bit
p27148
aVTypically a COM server
p27149
aVIn that case, your only other workaround is to run the assembly in its own process
p27150
aVYou'll need to write a little hosting program whose Platform Target you force to x86
p27151
aVYou'll need to communicate with the main program using one of the process interop mechanisms supported by
p27152
aVNET
p27153
aVSockets, named pipes,
p27154
aVNET Remoting, WCF
p27155
aVBeware that this is not especially fast and it will be brittle when the code commonly dies from unhandled exceptions
p27156
as(dp27157
g9
V17034
p27158
stp27159
a((dp27160
g2
(lp27161
VYes, don't do it this way
p27162
aVSomebody might trip over the power cord
p27163
aVAlways copy a known-good copy of the database files and attach them
p27164
aVLook in the documentation for the dbase engine you use how to attach
p27165
as(dp27166
g9
V17034
p27167
stp27168
a((dp27169
g2
(lp27170
VThat's not a logical assumption
p27171
aVThe FileInfo
p27172
aVLastAccessTime property is frozen in the
p27173
aVNET specification, it is sure to outlast your C# code
p27174
aVIf there will ever be a version of Windows that for some mysterious reason doesn't support a last-accessed time stamp on a file then it will be Microsoft's burden to re-implement the property in a reasonable way
p27175
aVThe semantics of the property are frozen too, and have been for the past 17 years, there will never be a version of Windows that lets you read from a file but not update the value
p27176
aVBtw, you should also reset the FileAttributes
p27177
aVArchive bit
p27178
as(dp27179
g9
V17034
p27180
stp27181
a((dp27182
g2
(lp27183
VYou need a wee bit of Win32 API magic
p27184
aVThe tab control sends the TCM_ADJUSTRECT message to allow the app to adjust the tab size
p27185
aVAdd a new class to your project and paste the code shown below
p27186
aVCompile
p27187
aVDrop the new control from the top of the toolbox onto your form
p27188
aVYou'll get the tabs at design time so you can easily switch between pages
p27189
aVThe tabs are hidden at runtime, use the SelectedIndex or SelectedTab property to switch between "views"
p27190
as(dp27191
g9
V17034
p27192
stp27193
a((dp27194
g2
(lp27195
VThe ListView class does not support design time binding
p27196
aVAn alternative is presented in this project
p27197
as(dp27198
g9
V17034
p27199
stp27200
a((dp27201
g2
(lp27202
VPut yourself in the shoes of the compiler writer
p27203
aVA function pointer has a well defined meaning, it is a pointer to a blob of bytes that represent machine code
p27204
aVWhat do you do when the programmer dereferences a function pointer
p27205
aVDo you take the first (or 8) bytes of the machine code and reinterpret that as a pointer
p27206
aVOdds are about 2 billion to one that this won't work
p27207
aVDo you declare UB
p27208
aVPlenty of that going around already
p27209
aVOr do you just ignore the attempt
p27210
aVYou know the answer
p27211
as(dp27212
g9
V17034
p27213
stp27214
a((dp27215
g2
(lp27216
VIt is a very mature development platform, you won't have many problems
p27217
aVMaybe a little too mature, you'll need Visual Studio 2008
p27218
aVAll support for mobile dev has been removed from VS2010
p27219
aVThe future of Windows Mobile is cloudy with a chance of meatballs
p27220
aVAbout the size of an apple
p27221
aVYou'll need to invest time in learning to program in C#, that will be worthy in the long run
p27222
aVIt is a strongly object-oriented programming language, that could be a bit raw if you only ever have programmed in C before
p27223
aVAvoid comparing the Compact Framework to the full
p27224
aVNET framework, it is a very trimmed version to meet the resource demands of embedded devices
p27225
aVGetting exposure to
p27226
aVNET programming is useful in the long run, especially when you can do it on the customer's dime
p27227
as(dp27228
g9
V17034
p27229
stp27230
a((dp27231
g2
(lp27232
VThe OnBuildDone event cannot tell you what happened
p27233
aVSome projects in the solution might have built properly, some didn't
p27234
aVYou'll need OnBuildProjConfigDone instead
p27235
aVFires for each project, the Success argument tells you if it worked
p27236
as(dp27237
g9
V17034
p27238
stp27239
a((dp27240
g2
(lp27241
VThe [AssemblyVersion] and [AssemblyFileVersion] attributes play different roles
p27242
aV[AssemblyVersion] is only visible to managed code and is important for the GAC
p27243
aVWhenever a make a breaking change in the assembly's public interface you should bump this number up
p27244
aVThe compiler embeds an unmanaged resource in an assembly with the /win32res command line option
p27245
aVThis includes the VERSIONINFO resource, readable by all unmanaged code, including the shell
p27246
aVIt determines what you see when you right-click the assembly in Explorer and look at the Details property page
p27247
aVThe "File version" value shown there is set by the [AssemblyFileVersion] attribute
p27248
aVThe [AssemblyVersion] value isn't visible there, Explorer doesn't (yet) know how to read that
p27249
aVIt is up to you to decide how to use this attribute
p27250
aVThe crash indicates that there's some minimum sanity checking going on in the deployment code, never tried to get it wrong myself to see what would happen
p27251
aVMaking them the same would however make a lot of sense
p27252
aVMicrosoft uses [AssemblyFileVersion] a different way, they automatically increment it for each build and nail [AssemblyVersion] down
p27253
aVThat's a good idea and the strategy I use
p27254
aVWhat is however quite ironic is that the automatic version increment feature works exactly backwards, it can only auto-increment [AssemblyVersion]
p27255
aVSigh
p27256
as(dp27257
g9
V17034
p27258
stp27259
a((dp27260
g2
(lp27261
VThe
p27262
aVNET 3
p27263
aV5 framework doesn't include new versions of the base assemblies
p27264
aVSystem, System
p27265
aVData etc are still version 2
p27266
ag2512
ag2512
ag2512
aVOnly the added assemblies have versions 3
p27267
aV0 (like WPF and WCF) or 3
p27268
aV5 (like System
p27269
aVCore and System
p27270
aVLinq)
p27271
aVThe runtime version (the CLR) is also still 2
p27272
ag2512
aV50727
p27273
aVYou don't have a problem
p27274
as(dp27275
g9
V17034
p27276
stp27277
a((dp27278
g2
(lp27279
VYou've bombed the CLR with that code
p27280
aVImpressive
p27281
aVThe actual mishap is corruption of the garbage collected heap, it is signaled with an ExecutionEngineException
p27282
aVApparently the damage is extensive enough to prevent the CLR from executing the exception handler
p27283
aVYou can report this at connect
p27284
aVmicrosoft
p27285
aVcom
p27286
aVHowever, the bug is fixed in
p27287
aVNET 4
p27288
aV0, it generates the proper exception, ArgumentNullException, "Value cannot be null, Parameter name: method"
p27289
aVThe workaround is obvious, don't pass IntPtr
p27290
aVZero when it expects a non-null string
p27291
as(dp27292
g9
V17034
p27293
stp27294
a((dp27295
g2
(lp27296
VWell, you already found the option you need to change
p27297
aVRight-click the project in the Solution Explorer window, Properties, C/C++, Code Generation, Runtime Library = /MTd
p27298
aVThe resulting EXE only has a dependency on kernel32
p27299
aVdll, Windows
p27300
aVDon't forget to also do this for the Release build configuration
p27301
aVNow choose /MT
p27302
as(dp27303
g9
V17034
p27304
stp27305
a((dp27306
g2
(lp27307
VIt allows them to turn the trust policy knob to eleven
p27308
aVYes
p27309
aVBe sure to bump your [AssemblyVersion] when you make a breaking change
p27310
aVYes
p27311
aVTry not to argue the decision, you can't win
p27312
aVMake sure all your assemblies are strong-named, test with gacutil
p27313
aVexe
p27314
as(dp27315
g9
V17034
p27316
stp27317
a((dp27318
g2
(lp27319
VTransparencyKey is the only way to get this
p27320
aVPick the right color
p27321
aVColor
p27322
aVFuchsia has a long tradition of being the color of choice, going back to the early days of Win32 development
p27323
aVAssault your eye with it to see its merits
p27324
as(dp27325
g9
V17034
p27326
stp27327
a((dp27328
g2
(lp27329
VWeird problem, how did the reference get written like that
p27330
aVThe  is definitely wrong, get rid of that first
p27331
aVUsing references from the GAC is always wrong
p27332
aVYou'd better check if the normal reference copy of System
p27333
aVdll is still there
p27334
aVIt lives in c:\u005cwindows\u005cmicrosoft
p27335
aVnet\u005cframework\u005cv2
p27336
ag2512
aV50727\u005cSystem
p27337
aVdll
p27338
aVA virgin project created with VS2008 has the reference listed like this:
p27339
aVYou might be able to salvage the
p27340
aVvcproj file with Notepad
p27341
aVUse a
p27342
aVvcproj created on, say, another machine as a guide
p27343
as(dp27344
g9
V17034
p27345
stp27346
a((dp27347
g2
(lp27348
VThe syntax you are looking for is supported by the C++/CLI language:
p27349
aVThe first const makes the referenced object immutable, the 2nd makes the reference immutable
p27350
aVThe latter is equivalent to the readonly keyword in C#
p27351
aVAttempts to evade it produce a compile error:
p27352
aVIt is however smoke and mirrors
p27353
aVThe immutability is verified by the compiler, not by the CLR
p27354
aVAnother managed language could modify both
p27355
aVWhich is the root of the problem, the CLR just doesn't have support for it
p27356
as(dp27357
g9
V17034
p27358
stp27359
a((dp27360
g2
(lp27361
VYou can get what you want by turning off debug info generation
p27362
aVProject + Properties, Linker, Debugging, Generate Debug Info = No
p27363
aVNaturally, you only want to do this for the Release build
p27364
aVWhere the option is already set that way
p27365
as(dp27366
g9
V17034
p27367
stp27368
a((dp27369
g2
(lp27370
VThis code was probably written by a C++ programmer that used common C++ idiom to write C++/CLI
p27371
aVIt is quite wrong, passing a reference to tracking handle is only possible if the handle is stored on the stack
p27372
aVIt cannot work if the passed List<> reference is stored in a field of an object on the heap, the garbage collector can move it and make the pointer invalid
p27373
aVThe compiler will catch it and generate an error
p27374
aVThe ^ is already a reference, no additional reference is needed
p27375
aVWithout the reference, the const keyword doesn't make a lot of sense anymore either
p27376
aVNot that it ever did before, the CLR cannot enforce it
p27377
aVNot that this mattered much here, this code could not be called from any other
p27378
aVNET language
p27379
aVThey won't generate a pointer to the tracking handle
p27380
aVJust fix it, there's little point in keeping bad code like this:
p27381
aVExample of code that shows that the reference cannot work:
p27382
as(dp27383
g9
V17034
p27384
stp27385
a((dp27386
g2
(lp27387
VYou can't, not with the default CLR host
p27388
aVYou could write a custom host that uses a different AppDomainSetup
p27389
aVConfigurationFile to initialize the primary AppDomain
p27390
aVBut you'd surely don't want that pursue that, C++ and COM skillz required
p27391
aVUsing a lot of EXEs is pretty unusual
p27392
aVMost anything a EXE can do, a Thread can do as well
p27393
aVOther than preventing the main app from going down when it crashes with an unhandled exception
p27394
aVStuffing the config in a separate xml file is probably the quickest solution
p27395
as(dp27396
g9
V17034
p27397
stp27398
a((dp27399
g2
(lp27400
VI repro this behavior on converted projects
p27401
aVCan't find any docs on what these warning numbers mean, the MSDN library hasn't been updated yet
p27402
aVNevertheless, my compiler has no trouble with them
p27403
aVYour problem is almost certainly caused by your build server or scripts using an old version of vbc
p27404
aVexe
p27405
aVBe sure the one in c:\u005cwindows\u005cmicrosoft
p27406
aVnet\u005cframework\u005cv4
p27407
ag2512
aV30319 compiles the code
p27408
as(dp27409
g9
V17034
p27410
stp27411
a((dp27412
g2
(lp27413
VNo can do
p27414
aVSyntax highlighters use lexical analysis
p27415
aVIdentifiers, comments, literals, keywords
p27416
aVRecognizing that an identifier is a method, property, field requires parsing
p27417
aVParsing only works well when you've got a well-formed program
p27418
aVNot only is it slow, your program is very rarely well-formed while you are typing code
p27419
as(dp27420
g9
V17034
p27421
stp27422
a((dp27423
g2
(lp27424
VDon't include CONNECT_UPDATE_PROFILE
p27425
aVIt probably failed on the server because something else had already mapped the drive and left the "Reconnect at logon" option turned on
p27426
aVIt is on by default
p27427
aVFix by disconnecting the drive in My Computer
p27428
aVOr use WNetCancelConnection2 if you get the error
p27429
aVNow you do want to use CONNECT_UPDATE_PROFILE so it is permanently forgotten
p27430
aVWatch out for fForce, it is fairly unhealthy
p27431
aVUsing the UNC name instead of mapping drives is the best all-around strategy
p27432
aVSounds like that's something you should use if you just temporarily map a drive
p27433
as(dp27434
g9
V17034
p27435
stp27436
a((dp27437
g2
(lp27438
VYou are using this
p27439
aVAutoScrollPosition
p27440
aVWhich suggests that the panel is getting scrolled by the form
p27441
aVThat's entirely normal, all child controls inside the form are subject to getting scrolled, including your panel
p27442
aVYour code snippet indeed compensates for that
p27443
aVBy design
p27444
as(dp27445
g9
V17034
p27446
stp27447
a((dp27448
g2
(lp27449
VIt is an unnatural act
p27450
aVMenus are designed to automatically pop down when they lose the focus
p27451
aVThe context menu will take the focus, end of menu
p27452
aVMenuStrip will fight you tooth and nail, I haven't seen it done
p27453
as(dp27454
g9
V17034
p27455
stp27456
a((dp27457
g2
(lp27458
VPrinting from a service is not recommended
p27459
aVPrinter drivers tend to assume they are invoked from a desktop app and can prompt the user for boring details
p27460
aVThat will hang your service, it runs in an invisible desktop
p27461
aVSure, WPF will work fine
p27462
aVYou don't have to make a window visible
p27463
aVGet it started with a shortcut in the Startup folder
p27464
aVCards will however remain virtual if nobody logs in
p27465
as(dp27466
g9
V17034
p27467
stp27468
a((dp27469
g2
(lp27470
VThe way the SDK talks about it strongly resembles 1
p27471
aVIt is an option with CreateProcess, described as follows:
p27472
aVCREATE_NEW_CONSOLE
p27473
aVThe new process has a new console, instead of inheriting its parent's console (the default)
p27474
aVFor more information, see Creation of a Console
p27475
aVOutput however happens through handles, you'd get one with GetStdHandle()
p27476
aVPassing STD_OUTPUT_HANDLE returns the console handle, assuming output isn't redirected
p27477
aVActual output is done through WriteFile() or WriteConsole/Output()
p27478
aVIf both processes keep writing output to the handle then their output will be randomly intermingled
p27479
aVThis is otherwise indistinguishable from what would happen when two programs write to the same file handle
p27480
aVLogically, there's a screen buffer associated with a console
p27481
aVYou can tinker with it with SetConsoleScreenBufferXxx()
p27482
aVFrom that point of view you could call it shared memory
p27483
aVThe actual implementation is undiscoverable, handles abstract them away, like any Win32 API
p27484
aVIt is sure to have changed considerably in Vista with the new conhost
p27485
aVexe process
p27486
as(dp27487
g9
V17034
p27488
stp27489
a((dp27490
g2
(lp27491
VI don't see an obvious reason
p27492
aVHowever, your RunWorkerCompleted event would normally run on the UI thread
p27493
aVAnd hang it for as long as 55 seconds
p27494
aVThat cannot be desirable
p27495
aVThere isn't any reason I can think of why you'd not just loop in the DoWork method with a try/catch block
p27496
as(dp27497
g9
V17034
p27498
stp27499
a((dp27500
g2
(lp27501
VYes, you are doing something wrong
p27502
aVTrying to use C++ code that's 19 years old
p27503
aVIt depends on an old version of iostream, it has been removed from Visual Studio (and other compilers) about 10 years ago
p27504
aVTrying to get this work is not worth your time
p27505
aVYou could use the Win32 console functions instead
p27506
as(dp27507
g9
V17034
p27508
stp27509
a((dp27510
g2
(lp27511
VThis is a very strange call stack
p27512
aVThe button got disposed, its PointToScreen() method is recreating the handle
p27513
aVBut it shouldn't have been able to get the mouse-up message if it was disposed
p27514
aVOnly threading can really explain this
p27515
aVFurthermore, nothing should have been disposed yet by the time the mouse-up message arrives
p27516
aVPresumably this is a button on the dialog that closes it
p27517
aVMake sure you use the Click event, not the MouseDown event
p27518
aVAlso make sure you close the dialog by assigning its DialogResult property, not by calling Close()
p27519
aVAwkward in C++/CLI because it doesn't keep separate separate symbol tables for types and variables
p27520
aVAsk the user what kind of "enhancements" she's got running on that machine
p27521
as(dp27522
g9
V17034
p27523
stp27524
a((dp27525
g2
(lp27526
VThere's definitely been a trend towards leaner user interfaces with less doodahs
p27527
aVContext menus however are special, it is difficult to come up with good icons
p27528
aVContext menu commands are invariably verbs
p27529
aVIcons show objects, they are nouns
p27530
aVSuggesting action in an icon isn't easy to do well with so few pixels to work with
p27531
aVPersonally, I never pay attention to them, usually because I can't figure out what they mean
p27532
aVThe Visual Studio 2010 View menu is a rather good example of this
p27533
aVToo many, not distinctive enough
p27534
as(dp27535
g9
V17034
p27536
stp27537
a((dp27538
g2
(lp27539
VYes, properties in COM are implemented as methods under the hood
p27540
aVThe method name ought to be "set_Filter"
p27541
aVI reckon the real reason you are having a problem is because you are going by the VB6 declarations
p27542
aVThe VB6 Long type isn't actually a long in C#, it is an int
p27543
aVTrying to assign the property with a long value will fail
p27544
aVWriting this code in VB
p27545
aVNET could make it a lot easier, it fully supports late-bound method and property access, using the "natural" syntax similar to Java
p27546
aVAnd supports indexed properties, unlike C#
p27547
aVWrite a little wrapper assembly that you can reference in your C# project
p27548
aVIt is available in C# too since VS2010 with the new dynamic keyword
p27549
as(dp27550
g9
V17034
p27551
stp27552
a((dp27553
g2
(lp27554
VYou are making it pretty easy on an attacker by storing the Guid in a string
p27555
aVTrivial to find back in, say, the paging file
p27556
aVStore it in a Guid and kill two birds with one stone
p27557
as(dp27558
g9
V17034
p27559
stp27560
a((dp27561
g2
(lp27562
VYou'd want a rich edit control to get a message for that, EN_SELCHANGE notification
p27563
aVEM_GETSEL and EM_EXLINEFROMCHAR to map the caret position to a line number
p27564
as(dp27565
g9
V17034
p27566
stp27567
a((dp27568
g2
(lp27569
VThe VB
p27570
aVNET IDE has a different approach, inspired by the WithEvents keyword
p27571
aVNote the two combo boxes at the top of the editor window
p27572
aVYou select the (class Events) in the upper left, the event you want to subscribe in the upper right combo
p27573
aVThat auto-generates the event handler, it has the Handles keyword
p27574
aVNo help for explicit AddHandler statements that I know of
p27575
as(dp27576
g9
V17034
p27577
stp27578
a((dp27579
g2
(lp27580
VYes, this should be a problem
p27581
aVSetting e
p27582
aVCancel to true in the PrintPage event causes AbortDoc() to be called
p27583
aVFrom the SDK docs:
p27584
aVIf Print Manager was used to start the print job, calling AbortDoc erases the entire spool job, so that the printer receives nothing
p27585
aVIf Print Manager was not used to start the print job, the data may already have been sent to the printer
p27586
aVIn this case, the printer driver resets the printer (when possible) and ends the print job
p27587
aVNot actually sure what the "Print Manager" is
p27588
aVAsk at superuser
p27589
aVcom
p27590
as(dp27591
g9
V17034
p27592
stp27593
a((dp27594
g2
(lp27595
VUsing an object reference would be the logical way
p27596
aVYou are putting up a bit of an obstacle by using a static class
p27597
aVWorked around like this:
p27598
aVOr the VB
p27599
aVNET With statement:
p27600
as(dp27601
g9
V17034
p27602
stp27603
a((dp27604
g2
(lp27605
VYour code is rather thread-happy
p27606
aVThat can indeed get you in trouble when you expect them to time stuff
p27607
aVEspecially when you use BGW or thread pool threads, the scheduler only allows them to run when there are not more threads active than you have CPU cores
p27608
aVOr when threads get "stuck" for a while
p27609
aVYours get stuck
p27610
aVYou also don't seem to use them effectively, polling loops burn a lot of needless CPU cycles
p27611
aVLeverage the capabilities of the SerialPort class to avoid this:
p27612
aVYou don't need a transmit thread
p27613
aVThe serial port driver has a buffer, your Write() call will instantly return when the data fits the buffer
p27614
aVWriting from the main thread is fine
p27615
aVYou don't necessarily need a receive thread
p27616
aVSerial port already has one, it runs the DataReceived event
p27617
aVIt can bump a Timer that you started when you transmitted the data
p27618
aVSerialPort already has a ReadTimeout property
p27619
aVYou can use it in a receive thread to timeout the Read() call
p27620
aVSleep() doesn't interfere with serial ports, their drivers read data using hardware interrupts
p27621
as(dp27622
g9
V17034
p27623
stp27624
a((dp27625
g2
(lp27626
VIt is easy to avoid by using an XmlWriter to write the document
p27627
aVThe default writer automatically encodes in utf8 and generates the processing instruction:
p27628
aVOutput:
p27629
as(dp27630
g9
V17034
p27631
stp27632
a((dp27633
g2
(lp27634
VThe
p27635
aVlib file you linked is not what you think it is
p27636
aVIt is the import library for the DLL, the linker needs it so it knows what functions are implemented by oci
p27637
aVdll
p27638
aVI don't see a static version of the library available from Oracle but didn't look too hard
p27639
aVThat's pretty typical for dbase interfaces
p27640
aVYou'll need to follow the deployment instructions for oci
p27641
aVdll, "OCI Instant Client Installation Process" in this document
p27642
aVChanging the PATH, oh joy
p27643
as(dp27644
g9
V17034
p27645
stp27646
a((dp27647
g2
(lp27648
VYou'll need to P/Invoke AllocConsole() if you detect a command line argument
p27649
aVCheck my answer in this thread for the required code
p27650
aVA C# sample is further down the page
p27651
aVRepeated here because I don't trust that crummy forum site:
p27652
as(dp27653
g9
V17034
p27654
stp27655
a((dp27656
g2
(lp27657
VHow soon do you plan to graduate
p27658
aVHopefully you'll have time, Windows doesn't work this way anymore
p27659
aVYou'll need to write a keyboard filter driver using the WDK
p27660
aVIt comes with a sample implementation in the src\u005cinput\u005ckbfiltr directory
p27661
aVYou can't use the tools you're familiar with, the WDK includes a compiler and a kernel debugger
p27662
aVAvailable at no cost, go here to get started
p27663
as(dp27664
g9
V17034
p27665
stp27666
a((dp27667
g2
(lp27668
VThe problem is that const correctness as used in C/C++ is only enforced by the compiler
p27669
aVAnd readily bypassed btw
p27670
aVThe CLR actually enforces type safety in managed code, not the compiler
p27671
aVNecessarily so because the
p27672
aVNET framework supports many languages
p27673
aVThe type system and interaction rules are laid out in the CLI, a common language infrastructure that needs to serve many goals and masters
p27674
aVConst correctness is rare in current languages
p27675
aVPersonally, I know of only C++, a language that is not ported to the CLI
p27676
aVEnforcing rules on languages that have nowhere near the syntax for them is difficult
p27677
aVSomething as simple as unsigned integral types not being in the CLS left a notable mark on the design of the base assemblies
p27678
aVImmutability (real, not faked with a compiler) keeps the MSFT teams thinking
p27679
aVIt is popular, I know the C# team has been thinking about it
p27680
aVGood for concurrency, etcetera
p27681
aVEric Lippert did a 11 part blog post series on it, kinda petered out though
p27682
aVToo big for one guy and his audience
p27683
aVIf there will be a real move to getting it implemented, I trust them to think it through and make it work
p27684
aVSome day
p27685
aVSome language
p27686
as(dp27687
g9
V17034
p27688
stp27689
a((dp27690
g2
(lp27691
VThe trouble maker is the DispatcherOperation
p27692
aVInvoke() method
p27693
aVIt looks like this:
p27694
aVThe "catch everything" clause prevents the debugger from stepping in
p27695
aVSilverlight is missing something similar to the Windows Forms' Application
p27696
aVSetUnhandledExceptionMode() method
p27697
aVAnd there's no check if a debugger is running, something else Winforms does
p27698
aVThis doesn't strike me as very hard to add, I'd recommend you post a feature request at connect
p27699
aVmicrosoft
p27700
aVcom
p27701
aVMeanwhile, there is no other option available than Debug + Exceptions, tick the Thrown checkbox to force the debugger to stop when the exception is thrown
p27702
aVKeep exceptions reserved for the truly exceptional
p27703
as(dp27704
g9
V17034
p27705
stp27706
a((dp27707
g2
(lp27708
VThis works from the assumption that Win32 events are expensive
p27709
aVThey are not, there's little that I can think of that's cheaper than an event
p27710
aVA major hint that this is so is the
p27711
aVNET designers deciding that it would be a good idea to use a Win32 event to implement MRE and ARE
p27712
aVThe true cost of your replacement is the major FUD you'll experience when you've got a threading race and don't know what causes it
p27713
as(dp27714
g9
V17034
p27715
stp27716
a((dp27717
g2
(lp27718
VYou'll need to P/invoke SetForegroundWindow()
p27719
aVProcess
p27720
aVMainWindowHandle can give you the handle you'll need
p27721
aVFor example:
p27722
aVNote the ambiguity if you've got more than one copy of Notepad running
p27723
as(dp27724
g9
V17034
p27725
stp27726
a((dp27727
g2
(lp27728
VThe EXE for the 2nd project needs to have a predictable location, relative from the 1st EXE
p27729
aVGetting the absolute path for the folder that contains your first EXE is easy:
p27730
aVThen append the relative path of your 2nd EXE
p27731
aVKeeping it in the same directory as the 1st is strong recommended:
p27732
aVThe easiest way to get this to work well in the IDE as well as on the target machine is to let the IDE copy project2
p27733
aVexe
p27734
aVRight-click project1, Add Reference, Projects tab, select Project2
p27735
aVThe Copy Local property of the reference will be True so that project2
p27736
aVexe ends up in the same directory as project1
p27737
aVexe
p27738
as(dp27739
g9
V17034
p27740
stp27741
a((dp27742
g2
(lp27743
VIt has been retired, the last version I know shipped with the
p27744
aVNET 2
p27745
aV0 SDK around the VS2005 time frame
p27746
aVNo loss btw, it wasn't a great tool
p27747
aVYou now need to use the Caspol
p27748
aVexe command line tool, run it from the Visual Studio Command Prompt or directly from the framework directory (c:\u005cwindows\u005cmicrosoft
p27749
aVnet\u005cframework\u005cv2
p27750
ag2512
aV50727 for example)
p27751
aVRun caspol /
p27752
aVfor very basic command line argument help, docs are here
p27753
as(dp27754
g9
V17034
p27755
stp27756
a((dp27757
g2
(lp27758
VYes this is possible, you'll have to do part of the job that the P/Invoke marshaller does
p27759
aVLoading the DLL and finding the entry point of the exported function
p27760
aVStart by declaring a delegate whose signature matches the exported function:
p27761
aVThen use code like this:
p27762
aVLots of ways to get this wrong of course
p27763
aVDo note that you have to use the actual exported name from the DLL, you no longer get the help from the P/Invoke marshaller to help with name decoration
p27764
aVUse dumpbin
p27765
aVexe /exports on the DLL if you are not sure what the export name looks like
p27766
as(dp27767
g9
V17034
p27768
stp27769
a((dp27770
g2
(lp27771
VYou'll want to modify the manifest that gets embedded in the program
p27772
aVThis works on VS2008 and higher: Project + Add New Item, select "Application Manifest File"
p27773
aVChange the  element to:
p27774
aVThe user gets the UAC prompt when they start the program
p27775
aVUse wisely, their patience can wear out quickly
p27776
as(dp27777
g9
V17034
p27778
stp27779
a((dp27780
g2
(lp27781
VThis code is not correct, you run the risk of permanently blocking the main thread if the worker completes too soon
p27782
aVThe proper synchronization object to use here is a ManualResetEvent (or auto, doesn't matter)
p27783
aVCall its Wait() method in the main thread, its Set() method in the worker
p27784
aVAs long as it is a Thread instead of a thread pool thread, using Thread
p27785
aVJoin() would work just as well
p27786
as(dp27787
g9
V17034
p27788
stp27789
a((dp27790
g2
(lp27791
VYou could use the OleDbEnumerator class to find out what providers are available
p27792
aVNot sure what the point would be, you'll just end up showing the user an empty list of choices
p27793
aVThere is no 64-bit version of the JET provider available and there's no alternative
p27794
aVYou'll still get the call from the user, asking you to change your program
p27795
aVAs long as you want to support JET, you'll need to set the build target to x86
p27796
as(dp27797
g9
V17034
p27798
stp27799
a((dp27800
g2
(lp27801
VI worked up a similar example that fails the same way:
p27802
aVIt is a JIT optimizer bug
p27803
aVCan't quite put the finger on it, it optimizes the code heavily
p27804
aVBut it looks to me like it gets in trouble when it optimizes the boxing conversion away
p27805
aVPretty serious bug, frankly
p27806
aVThis bug has been fixed, I can no longer repro it
p27807
aVMy current version of clrjit
p27808
aVdll is 4
p27809
ag2512
aV30319
p27810
aV237 dated May 17th 2011
p27811
aVI can't tell exactly what update repaired it
p27812
aVI got a security update on Aug 5th 2011 that updated clrjit
p27813
aVdll to revision 235 with a date of Apr 12, that would be the earliest
p27814
as(dp27815
g9
V17034
p27816
stp27817
a((dp27818
g2
(lp27819
VThe handle is created when the Visible property becomes true
p27820
aVIf it was set to true in the form constructor, the most common case for controls, that will happen when the form is created, right before the Load event
p27821
aVSetting Visible to false again doesn't destroy the handle
p27822
as(dp27823
g9
V17034
p27824
stp27825
a((dp27826
g2
(lp27827
VClearly it is the compiler explicitly forbidding its use, it is not by accident
p27828
aVHmya, why
p27829
aVA workaround for a restriction in the compiler seems pretty unlikely
p27830
aVI'd guess they decided to forbid it to avoid confusion to the programmer that gets the warning
p27831
aVUnless the message was well crafted, it would be quite confusing that it would show up inconsistently, depending on the property usage
p27832
as(dp27833
g9
V17034
p27834
stp27835
a((dp27836
g2
(lp27837
VHow about an extern declaration for an array that declares the size:
p27838
aVa
p27839
aVcpp:
p27840
aVb
p27841
aVcpp:
p27842
aVThe fact that the linker doesn't catch this mismatch suggests however that Value isn't used
p27843
aVI have no easy way to see that
p27844
as(dp27845
g9
V17034
p27846
stp27847
a((dp27848
g2
(lp27849
VSure, it is a lively market
p27850
aVGoing from C++ to C# gives you something that might compile cleanly
p27851
aVMaking it actually work takes a line-by-line, "oh gawd I'll shoot myself tomorow" effort
p27852
aVYMMV
p27853
as(dp27854
g9
V17034
p27855
stp27856
a((dp27857
g2
(lp27858
VThe timeout is very short, 1 second isn't enough
p27859
aVMake time-outs at least 10 times the worst case, go for at least 20 here
p27860
aVAnd be sure to check the function return value, there's no point to continue if it returned failure
p27861
as(dp27862
g9
V17034
p27863
stp27864
a((dp27865
g2
(lp27866
VThe type library is sufficient for any language to use your server
p27867
aVThe IDL would only be useful to generate a type library, which you already supply, or to generate a C++ header file, which is much easier to generate with the #import directive
p27868
aVWhich would be one way perhaps if you really want to do this, build a small C++ program that uses #import, provide the generated
p27869
aVtlh file
p27870
as(dp27871
g9
V17034
p27872
stp27873
a((dp27874
g2
(lp27875
VWhat would be the point of hiding the error message
p27876
aVNow your customer (nor you) would not have any clue at all why your program won't run
p27877
aVA friendlier error message still doesn't solve the problem
p27878
aVInclude the
p27879
aVNET bootstrapper in your setup program so this just won't happen
p27880
as(dp27881
g9
V17034
p27882
stp27883
a((dp27884
g2
(lp27885
VBy the time you'll have this working right, you'll have re-invented a pipe
p27886
aVA socket is the better solution, that will also cover the more common scenario where the server and the client are not running on the same machine
p27887
as(dp27888
g9
V17034
p27889
stp27890
a((dp27891
g2
(lp27892
VNope, tracking roll-over requires state
p27893
aVIt can be as simple as just incrementing your own 64-bit counter on each callback
p27894
aVIt is pretty unusual to want to track time periods to a resolution as low as 1 millisecond for up to 49 days
p27895
aVYou'd have to worry that the accuracy is still there after such a long period
p27896
aVThe next step is to use the clock, GetTickCount(64), GetSystemTimeAsFileTime have a resolution of 15
p27897
aV625 milliseconds and are kept accurate with a time server
p27898
as(dp27899
g9
V17034
p27900
stp27901
a((dp27902
g2
(lp27903
VYou can get this by overriding the TraceEvent() method in your listener
p27904
aVLike this:
p27905
as(dp27906
g9
V17034
p27907
stp27908
a((dp27909
g2
(lp27910
VMouseDown is disabled too
p27911
aVThat's because mouse events are sent to the DOM
p27912
aVYou can subscribe to DOM events with the HtmlElement
p27913
aVAttachEventHandler() method
p27914
aVFor example:
p27915
as(dp27916
g9
V17034
p27917
stp27918
a((dp27919
g2
(lp27920
VBeware of shoddy benchmarks without peer review
p27921
aVThe file I/O benchmark code uses the old VB6 compatibility I/O functions, PrintLine() and LineInput()
p27922
aVYes, they are not cheap
p27923
aVThe bench mark also doesn't attempt to do anything to measure real I/O performance, it doesn't flush the file system cache
p27924
aVSomewhat understandable perhaps, that would measure the speed of the disk and every language would perform the same, within 0
p27925
aV1% or so
p27926
as(dp27927
g9
V17034
p27928
stp27929
a((dp27930
g2
(lp27931
VNo, you are probably getting an accurate result, QueryPerformanceCounter() works well for timing short intervals
p27932
aVWhat's wrong is the your expectation of the accuracy of Sleep()
p27933
aVIt has a resolution of 1 millisecond, its accuracy is far worse
p27934
aVNo better than about 15
p27935
aV625 milliseconds on most Windows machine
p27936
aVTo get it anywhere close to 1 millisecond, you'll have to call timeBeginPeriod(1) first
p27937
aVThat probably will improve the match, ignoring the jitter you'll get from Windows being a multi-tasking operating system
p27938
as(dp27939
g9
V17034
p27940
stp27941
a((dp27942
g2
(lp27943
VThis is the wrong approach, you'll need to know up front what each column in the data table represents
p27944
aVRun this program to see what can go wrong:
p27945
as(dp27946
g9
V17034
p27947
stp27948
a((dp27949
g2
(lp27950
VForms are expensive objects, they have a lot of internal state
p27951
aVCaching makes sense if creating the data is expensive
p27952
aVForms behave the exact opposite, creating their data is cheap
p27953
aVUsing cached data becomes expensive when Windows has swapped out the data to the paging file
p27954
aVWhich is very likely to happen in your case, the dialogs wouldn't be used very frequently
p27955
aVIt actually takes longer to show the dialog
p27956
aVIf your data to fill the dialog is expensive to create then cache that data, not the form
p27957
as(dp27958
g9
V17034
p27959
stp27960
a((dp27961
g2
(lp27962
VThat doesn't make a heckofalot of sense, can't repro it
p27963
aVWhat version of VS
p27964
aVAre you sure these aren't IntelliSense errors
p27965
aVAnother way to tackle it is right-clicking the file in the Explorer window, Exclude from Project
p27966
aVThen click the Show all Files icon (top of window) to make it visible again
p27967
as(dp27968
g9
V17034
p27969
stp27970
a((dp27971
g2
(lp27972
VMessage queuing is very much designed to survive disconnects
p27973
aVAnd supports routing through several machines
p27974
aVAs such, it doesn't have a way to check if a live connection is present
p27975
aVYou probably shouldn't consider MSMQ if that's a requirement, TCP would be a better mouse trap
p27976
aVYou could consider asking for acknowledgment of your message and time-out on that
p27977
aVThat's passive though
p27978
aVA heart beat is possible, but be sure to use a separate, non transactional queue
p27979
as(dp27980
g9
V17034
p27981
stp27982
a((dp27983
g2
(lp27984
VThis is by design, PipeStream
p27985
aVRead() is a blocking call
p27986
aVYou could use BeginRead() instead
p27987
aVThis makes text less than a stellar format for data of course
p27988
aVNot a real problem, use PipeTransmissionMode
p27989
aVMessage
p27990
as(dp27991
g9
V17034
p27992
stp27993
a((dp27994
g2
(lp27995
VNot quite sure what a read-only method is
p27996
aVBut ISerializable only works for binary serialization
p27997
aVA web service uses XML serialization, a parameter-less constructor is required
p27998
aVOne trick you could use is to attribute it so that client code can never use it directly:
p27999
as(dp28000
g9
V17034
p28001
stp28002
a((dp28003
g2
(lp28004
VIt is unwise to use a relative path name for a file
p28005
aVYour program's working directory might change and will then fail to find the file
p28006
aVGenerate the absolute path name of the file like this:
p28007
aVUsage:
p28008
as(dp28009
g9
V17034
p28010
stp28011
a((dp28012
g2
(lp28013
VBoth the mouse and the keyboard will be quite dead when you P/Invoke BlockInput()
p28014
aVThe three finger salute will be required
p28015
aVVisit pinvoke
p28016
aVnet for the declaration
p28017
as(dp28018
g9
V17034
p28019
stp28020
a((dp28021
g2
(lp28022
VThe reg looks okayish, only the default progid is missing
p28023
aVWin7 does have documented alternate behavior for the location of the PreviewHandlers key
p28024
aVUnfortunately the SDK docs don't say what Vista requires
p28025
aVA Vista time magazine article uses HKLM instead of HKCU
p28026
aVI bet that's it
p28027
as(dp28028
g9
V17034
p28029
stp28030
a((dp28031
g2
(lp28032
VYes, there are problems
p28033
aVYour event handlers will cause the form object to stay referenced, you have to explicitly unregister the event handlers
p28034
aVThe lambdas make this impossible, you'll have to write an explicit handler
p28035
aVThis pattern has a name, "Event Broker service"
p28036
aVIt is part of the Composite UI Application Block, published by Microsoft's Pattern and Practices team
p28037
aVBeg, borrow and steal (if not use) what you can from this
p28038
as(dp28039
g9
V17034
p28040
stp28041
a((dp28042
g2
(lp28043
VThe WF ToolTip control uses the form's RightToLeft property to determine how to align its text
p28044
aVDisplaying RTL text when you have a form that otherwise displays text left to right is an unusual requirement, not covered by the class
p28045
aVSetting the form's RightToLeft property to Yes before you display the tip isn't going to look very pleasant
p28046
aVThe alternative is to use custom drawing by setting the tool tip's OwnerDraw property to True
p28047
aVA good example for a Draw event handler is available in the MSDN Library
p28048
aVYou'll want to use TextFormatFlags
p28049
aVRightToLeft
p28050
as(dp28051
g9
V17034
p28052
stp28053
a((dp28054
g2
(lp28055
VYou probably blinked your eyes too fast to see it
p28056
aVModify your code like this:
p28057
aVPossible output:
p28058
as(dp28059
g9
V17034
p28060
stp28061
a((dp28062
g2
(lp28063
VGiven that Process
p28064
aVCloseMainWindow() works indicates that both programs run on the same machine
p28065
aVGiven that a true service cannot start programs that are visible on the desktop anymore indicates that your server program runs as a regular user app
p28066
aVIt now makes no longer any sense to have separate programs
p28067
aVSimply have the server create a visible window
p28068
aVInteraction is trivial since everything runs in one program and has access to all state of that program
p28069
aVIf the server processing gets in the way of keeping the client window alive then display that window on a thread
p28070
aVThis helper class gets the job done:
p28071
aVSample usage:
p28072
as(dp28073
g9
V17034
p28074
stp28075
a((dp28076
g2
(lp28077
VBy far the simplest solution is to just change the Size property of the picture box so that the image can be drawn without padding
p28078
aVImplementing your own Paint event handler is possible too, not exactly necessary here I presume
p28079
as(dp28080
g9
V17034
p28081
stp28082
a((dp28083
g2
(lp28084
VIt's going to be fairly high maintenance, but not impossible
p28085
aVOpen Regedit
p28086
aVexe and locate the HKCR\u005cVisualStudio
p28087
aVcsproj
p28088
aV9
p28089
aV0 key
p28090
aVAdd the Build verb, make it look similar to this:
p28091
aV[HKEY_CLASSES_ROOT\u005cVisualStudio
p28092
aVcsproj
p28093
ag28089
aV0\u005cshell\u005cBuild]
p28094
aV[HKEY_CLASSES_ROOT\u005cVisualStudio
p28095
aVcsproj
p28096
ag28089
aV0\u005cshell\u005cBuild\u005cCommand]
p28097
aV@="cmd
p28098
aVexe /k c:\u005ctemp\u005cbuild
p28099
aVbat %1"
p28100
aVThe cmd
p28101
aVexe /k command opens a console window so that you can read any error message from the build
p28102
aVThe c:\u005ctemp\u005cbuild
p28103
aVbat file ought to look similar to this:
p28104
aVYou probably also want to add the Build key to HKCR\u005cVisualStudio
p28105
aVLauncher
p28106
aVsln so you can build solutions as well
p28107
aVThat however is a bit of a version maintenance headache
p28108
as(dp28109
g9
V17034
p28110
stp28111
a((dp28112
g2
(lp28113
VIt is certainly connected to installing Resharper
p28114
aVFirst thing it does is turn IntelliSense off
p28115
aVCheck this question for help with preserving your snippets
p28116
as(dp28117
g9
V17034
p28118
stp28119
a((dp28120
g2
(lp28121
VCheck out this comparison chart, built-in code analysis support gets checked starting in the Premium column
p28122
as(dp28123
g9
V17034
p28124
stp28125
a((dp28126
g2
(lp28127
VListView has no support for this, nor can it easily be added
p28128
aVConsider using DataGridView instead
p28129
aVIts columns have a Frozen property
p28130
as(dp28131
g9
V17034
p28132
stp28133
a((dp28134
g2
(lp28135
VWindows Forms doesn't support this
p28136
aVControls must be child windows, they have their TopLevel property set to False
p28137
aVWhich confines them to their container
p28138
aVThere's only one Control-derived class that has TopLevel = true, the Form class
p28139
aVToolTip and ContextMenuStrip are top level windows too, but they are components
p28140
aVThe reason it has this restriction is that top level windows behave poorly in the designer
p28141
aVYou can however create them in code
p28142
aVCheck out my answer in this thread to see how to do that
p28143
as(dp28144
g9
V17034
p28145
stp28146
a((dp28147
g2
(lp28148
VIt is called UIPI, User Interface Privilege Isolation
p28149
aVDesigned to prevent input injection exploits from programs that run with restricted privileges
p28150
aVIt can be disabled, you'll need to do this:
p28151
aVModify the manifest, set the uiAccess attribute for the  element to true
p28152
aVStore your program's EXE in a subdirectory of c:\u005cwindows or c:\u005cprogram files
p28153
aVSign your EXE with a certificate from an valid code signing authority
p28154
aVNever actually tried this, ymmv
p28155
as(dp28156
g9
V17034
p28157
stp28158
a((dp28159
g2
(lp28160
VModal forms do exactly what "modal" means, they disable all other windows in the app
p28161
aVThat's rather important, your program is in a somewhat perilous state
p28162
aVYou've got a chunk of code that is waiting for the dialog to close
p28163
aVReally Bad Things could happen if those other windows were not disabled
p28164
aVLike the user could start the modal dialog again, now your code is nested twice
p28165
aVOr she could close the owner window of the dialog, now it suddenly disappears
p28166
aVThese are the exact kind of problems you'd run into if you call Application
p28167
aVDoEvents() inside a loop
p28168
aVWhich is one way to get a form to behave modal without disabling other windows
p28169
aVFor example:
p28170
aVThis is dangerous
p28171
aVA somewhat safer way is to create a form that should never be modal on another thread:
p28172
aVThe problem you'll have now is that this form object has a life of its own, it tends to disappear behind the window of another application, you can't make it owned by the main window
p28173
aVYou'll also have to do the typical song-and-dance with Control
p28174
aVBegin/Invoke() to deliver events to another form class
p28175
aVThese are not great solutions
p28176
aVUse modal forms the way they were designed to stay out of trouble
p28177
aVIf you don't want a modal form then simply don't make it modal, use the Show() method
p28178
aVSubscribe to its FormClosing event to know that it is about to close:
p28179
as(dp28180
g9
V17034
p28181
stp28182
a((dp28183
g2
(lp28184
VThe server implements IDispatch, the client uses it to make the calls
p28185
aVThe terms "OLE" and "ActiveX" have fallen out of favor, it is all "COM" now
p28186
aVThe technology is however exactly the same
p28187
as(dp28188
g9
V17034
p28189
stp28190
a((dp28191
g2
(lp28192
VEdit the column, edit the DefaultCellStyle property and set the WrapMode property to True
p28193
aVAnd change the DGV's AutoSizeRowMode to, say, AllCells so that a row automatically grows in height to fit the text
p28194
aVThe text in the column header and the cells will now automatically word-wrap
p28195
aVYou can use "\u005cn" to force an early wrap
p28196
as(dp28197
g9
V17034
p28198
stp28199
a((dp28200
g2
(lp28201
VOpenStore + GetStoreInfo
p28202
aVSTOREINFO gets you the used size, BytesPerSector * (NumSectors - FreeSectors)
p28203
as(dp28204
g9
V17034
p28205
stp28206
a((dp28207
g2
(lp28208
VMaybe the best way to show how pointer types and interface types are not self-describing is with an example:
p28209
aVOutput:
p28210
aVIn other words, objects declared as an interface type can only describe the class that implements them
p28211
aVPointers can only describe the type of the object they point to
p28212
as(dp28213
g9
V17034
p28214
stp28215
a((dp28216
g2
(lp28217
VYou could try this control:
p28218
as(dp28219
g9
V17034
p28220
stp28221
a((dp28222
g2
(lp28223
VThis limitation is baked into a lot of software written in C or C++
p28224
aVIncluding MSFT code, although they've been chipping away at it
p28225
aVIt is only partly a Win32 limitation, it still has a hard upper limit on the length of a file name (not path) through WIN32_FIND_DATA for example
p28226
aVOne reason that even
p28227
aVNET has length restrictions
p28228
aVThis is not going away any time soon, Win32 is still going strong and the stone-age C string won't disappear
p28229
aVYour customer will have little sympathy with it, no doubt, probably until you can show them another program that fails the same way
p28230
aVDo however make sure that your code reliably can detect the potential string buffer overflow, followed by a reasonable diagnostic
p28231
aVNo sympathy for programs bombing on heap corruption
p28232
as(dp28233
g9
V17034
p28234
stp28235
a((dp28236
g2
(lp28237
VWhen seeing questions like these, I often wonder if we wouldn't have been better off using the Java model
p28238
aVThere's an extraordinary amount of agony that
p28239
aVNET programmers suffer over that doggone IDisposable
p28240
aVAfter thousands of questions on SO (et al), it still remains poorly understood
p28241
aVIt is a memory stream
p28242
aVThere's nothing that needs to be disposed when you use memory, the garbage collector already takes care of it
p28243
aVIt is not some kind of special memory just because the class has a Dispose() method, there's only one kind
p28244
aVThe other kind is wrapped by UnmanagedMemoryStream
p28245
aVThe fact that MemoryStream inherits a do-nothing Dispose() method from Stream is a sad OOP liability
p28246
aVIt is up to you to decide to slovenly call a do-nothing method because it is there
p28247
aVOr you could take charge of your code and refuse to call methods that you know don't do anything useful now, nor will ever do anything useful for the rest of your career
p28248
aVClearly I'm in the second camp, our life-expectancy must be better
p28249
aVI hope anyway
p28250
aVThen again, this post might have knocked a day off
p28251
as(dp28252
g9
V17034
p28253
stp28254
a((dp28255
g2
(lp28256
VYou can use remote WMI and the  class
p28257
aVYou do need to have permission to execute WMI queries on that machine
p28258
aVAvoid hassle like this by working with UTC instead of local time
p28259
as(dp28260
g9
V17034
p28261
stp28262
a((dp28263
g2
(lp28264
VBypassing the printer driver and controlling the printer directly, using its native command language, is a supported scenario
p28265
aVThe P/Invoke is explained well in this KB article
p28266
aVSure you want to do this
p28267
aVIt is uncommon, to put it mildly, usually only attempted with low-cost Point-Of-Sale thermal or matrix printers
p28268
aVIf you don't like the mechanics of PrintDocument
p28269
aVPrintPage, nobody does, you could consider my code in this thread
p28270
aVNote the FormFeed method
p28271
as(dp28272
g9
V17034
p28273
stp28274
a((dp28275
g2
(lp28276
VSeeing KeyPressedEventArgs being used in your function looks really strange
p28277
aVHot keys can be implemented by P/Invoking the RegisterHotKey() API function
p28278
aVIt sends a message to your window when the hot key is pressed
p28279
aVHere's an example of a form that's invisible at start up, springs alive when you press the hot key
p28280
aVCtrl+Alt+U in this case:
p28281
aVNote that the SetForegroundWindow() function is the rub, possibly also the source of the problem you describe in your question
p28282
aVWindows doesn't permit an app to shove a window in the user's face when the user is actively using another window
p28283
aVAt least several seconds of inactivity must expire before it will allow the window to steal the focus
p28284
aVWith the given code, that is easy enough to see, the taskbar button of your form will be blinking
p28285
aVAvoid setting the ShowInTaskbar property to false
p28286
aVIt isn't necessary to do so with this code, the taskbar button won't show up until the hot key is pressed
p28287
as(dp28288
g9
V17034
p28289
stp28290
a((dp28291
g2
(lp28292
VYou are printing function addresses
p28293
aVThat's purely in the domain of the linker, the compiler doesn't do anything that's involved with creating the binary image of the program
p28294
aVOther than generating the blobs of machine code for each function
p28295
aVThe linker arranges those blobs in the final image
p28296
aVSome linkers have command line options that affect the order, it otherwise rarely matters
p28297
aVEndian-ness cannot affect the output of printf() here
p28298
aVIt knows how to interpret the bytes correctly if the pointer value was generated on the same machine
p28299
as(dp28300
g9
V17034
p28301
stp28302
a((dp28303
g2
(lp28304
VShort from just rebuilding your app so you'll be 100% sure the changed assembly is compatible with your program, you can use the  element in the app
p28305
aVexe
p28306
aVconfig file
p28307
aVWrite an event handler for AppDomain
p28308
aVCurrentDomain
p28309
aVUnhandledException and log the e
p28310
aVExceptionObject
p28311
aVToString() value to get better error reporting
p28312
as(dp28313
g9
V17034
p28314
stp28315
a((dp28316
g2
(lp28317
VThis used to be possible in VC6, it had an option to generate a makefile from a
p28318
aVdsp project file
p28319
aVNo more, the build process has changed too much to make this achievable
p28320
aVNot a real problem, you can have the makefile invoke the vcbuild
p28321
aVexe tool, it builds a
p28322
aVvcproj project
p28323
aVImportant switches you'll want to use in your makefile:
p28324
aV/clean: use that in your clean: target
p28325
aV/rebuild: use in your rebuild: target
p28326
aV/nocolor: makes build output look battleship gray like other build tools
p28327
aV/platform: selects the configuration you want to build (e
p28328
aVg: /platform:win32)
p28329
aVFor example:
p28330
aVNote that the build system got a major revision in VS2010, you'll use msbuild
p28331
aVexe instead to build the
p28332
aVvcxproj project
p28333
as(dp28334
g9
V17034
p28335
stp28336
a((dp28337
g2
(lp28338
VAssuming Windows Forms here
p28339
aVThere isn't anything in the class library that makes this especially easy
p28340
aVThe Application
p28341
aVIdle event is however useful
p28342
aVIt runs right after any mouse or keyboard input event, after all Windows notifications are processed
p28343
aVA good place to calculate button state that would otherwise be awkward to update directly from event handlers
p28344
aVHere's an example that updates the standard Copy, Cut, Paste and Undo toolbar buttons:
p28345
aVDoing the same thing with event handlers for Enter, Leave, TextChanged for every single text box in your form would be quite painful
p28346
as(dp28347
g9
V17034
p28348
stp28349
a((dp28350
g2
(lp28351
VThat's an assignment statement, not a declaration
p28352
aVStatements must be written inside a method
p28353
aVA suitable one would be the constructor for MyOuterClass:
p28354
as(dp28355
g9
V17034
p28356
stp28357
a((dp28358
g2
(lp28359
VA sample implementation of a controller:
p28360
aVYou could use it like this:
p28361
aVAlso check out the WindowsFormsApplicationBase class as a good base class for your controller
p28362
aVNice support for singleton apps and splash screens
p28363
as(dp28364
g9
V17034
p28365
stp28366
a((dp28367
g2
(lp28368
VIt is a JIT compiler implementation detail where it will allocate the
p28369
aVlocals
p28370
aVRight now, I don't know any that doesn't allocate them on a stack frame
p28371
aVThey are "allocated" by adjusting the stack pointer and "freed" by resetting it back
p28372
aVVery fast, hard to improve
p28373
aVBut who knows, 20 years from now we might all be running machines with CPU cores that are optimized to run only managed code with a completely different internal implementation
p28374
aVProbably cores with a ton of registers, the JIT optimizer already uses registers to store locals now
p28375
aVThe temporaries are emitted by the C# compiler to provide some minimum consistency guarantees in case object initializers throw exceptions
p28376
aVIt prevents your code from ever seeing a partially initialized object in a catch or finally block
p28377
aVAlso used in the using and lock statements, it prevents the wrong object from being disposed or unlocked if you replace the object reference in your code
p28378
as(dp28379
g9
V17034
p28380
stp28381
a((dp28382
g2
(lp28383
VYou'll need Marshal
p28384
aVCopyMemory() and this code
p28385
aVP/Invoking VirtualQueryEx() to ensure the memory addresses are valid would be a good idea to avoid exceptions
p28386
as(dp28387
g9
V17034
p28388
stp28389
a((dp28390
g2
(lp28391
VYour IL is simply invalid
p28392
aVThe exception isn't great but you're tinkering in the bowels of the JIT compiler
p28393
aVOpcodes
p28394
aVLdsftn does not do what you think it does, you'll need Ldsfld to load a field
p28395
aVI can't really figure out what code you're trying to write but this ought to be close
p28396
aVIt doesn't crash anyway:
p28397
aVThe best way to figure out what IL to use is to write your code in C# first, then disassemble it with Ildasm
p28398
aVexe to see what the IL looks like
p28399
as(dp28400
g9
V17034
p28401
stp28402
a((dp28403
g2
(lp28404
VI partly repro
p28405
aVI too get two distinct interop libraries but I do so on both VS2008 and VS2010
p28406
aVTake a close look at the Add Reference + COM tab, Path column
p28407
aVBoth of them refer to the same DLL, c:\u005cwindows\u005csystem32\u005chnetcfg
p28408
aVdll"
p28409
aVWell, it makes sense that the same interop library gets generated from the same DLL
p28410
aVI would guess that somebody at Microsoft decided that one of the type library names was crummy and changed the registration procedure to register it under a new name
p28411
aVAnd register it under the old name so not to break backward compatibility
p28412
aVNot sure which, but "CON" is one of those mysterious acronyms (
p28413
aVthat keeps popping up over and over again on Microsoft type library names
p28414
aV"UPNP" nails the job down better, I guess
p28415
aVThere might be a difference if you run a 64-bit operating system
p28416
aVDo pick the name that VS2010 shows
p28417
aVOtherwise, there's no point in referencing the same type library to the same COM server twice
p28418
aVOne will get the job done
p28419
as(dp28420
g9
V17034
p28421
stp28422
a((dp28423
g2
(lp28424
VThe amount of stack space used on a 32-bit x86 processor to pass arguments of various types:
p28425
aVbyte: 4 bytes
p28426
aVbool: 4 bytes
p28427
aVenum: 4 bytes
p28428
aVchar: 4 bytes
p28429
aVshort: 4 bytes
p28430
aVint: 4 bytes
p28431
aVlong: 8 bytes
p28432
aVfloat: 4 bytes
p28433
aVdouble: 8 bytes
p28434
aVdecimal: 16 bytes
p28435
aVstruct: runtime size of the structure
p28436
aVstring: 4 bytes
p28437
aVarray: 4 bytes
p28438
aVobject: 4 bytes
p28439
aVinterface: 4 bytes
p28440
aVpointer: 4 bytes
p28441
aVclass instance: 4 bytes
p28442
aVThe ones below the line are reference types, their size will double on a 64-bit processor
p28443
aVFor a static method call, the first 2 arguments that are up to 4 bytes will be passed through CPU registers, not the stack
p28444
aVFor an instance method call only one argument will be passed through registers
p28445
aVThe rest are passed on the stack
p28446
aVA 64-bit processor supports passing 4 arguments through registers
p28447
aVAs is clear from the list, the only time you should ever consider passing an argument by ref is for structures
p28448
aVThe normal guidance for this is to do so when the structure is larger than 16 bytes
p28449
aVIt isn't always easy to guess the runtime size of a structure, up to 4 fields would usually be accurate
p28450
aVLess if those fields are double, long or decimal
p28451
aVThis guidance then usually recommends turning your structure into a class, precisely for this reason
p28452
aVAlso note that there is no savings passing an argument as a byte or short intentionally, an int is the type that a 32-bit processor is happy with
p28453
aVSame for currently available 64-bit processors
p28454
aVA method return value, the real topic of your question are almost always returned in a CPU register
p28455
aVMost types fit comfortably in the eax or edx:eax registers, an FPU register for floating point values
p28456
aVThe only exceptions are large structures and decimal, they are too large to fit a register
p28457
aVThey are called by reserving space on the stack for the return value and passing a 4 byte pointer to that space as an argument to the method
p28458
as(dp28459
g9
V17034
p28460
stp28461
a((dp28462
g2
(lp28463
VDebug + Exceptions, tick the Thrown checkbox for "Common Language Runtime Exceptions"
p28464
aVThe debugger will now stop at any place an exception is thrown
p28465
as(dp28466
g9
V17034
p28467
stp28468
a((dp28469
g2
(lp28470
VThis is by design, 32-bit programs have a different view of the registry than 64-bit programs
p28471
aVThey are redirected to the HKLM\u005cSoftware\u005cWow6432Node key when they try to read a value from the HKLM\u005cSoftware hive
p28472
aVIf you build your C# program with Project + Properties, Build tab, Platform Target = Any CPU then it will run as a 64-bit program and won't get redirected
p28473
aV32-bit programs can cancel the redirection but that's not easily done with the
p28474
aVNET RegistryKey class
p28475
aVP/Invoking RegOpenKeyEx with the KEY_WOW64_64KEY option is required
p28476
aVMore info is available in this Windows SDK article
p28477
aVEDIT: this is now also available to
p28478
aVNET with the
p28479
aVNET 4 specific RegistryKey
p28480
aVOpenBaseKey() method
p28481
aVPass RegistryView
p28482
aVRegistry64 to view the registry the way a 64-bit process would
p28483
as(dp28484
g9
V17034
p28485
stp28486
a((dp28487
g2
(lp28488
VThe volatile keyword doesn't accomplish anything here
p28489
aVIt has very weak guarantees, it does not imply a memory barrier
p28490
aVYour code doesn't show another thread getting created so it is hard to guess if locking is required
p28491
aVIt is however a hard requirement if two threads can execute Update() at the same time and use the same object
p28492
aVBeware that your lock code as posted doesn't lock anything
p28493
aVEach thread would have its own instance of the "locker" object
p28494
aVYou have to make it a private field of your class, created by the constructor or an initializer
p28495
aVThus:
p28496
aVNote that there will also be a race on the SomeProperty assignment
p28497
as(dp28498
g9
V17034
p28499
stp28500
a((dp28501
g2
(lp28502
VUnmanaged code is prone to corrupt the heap
p28503
aVThe side effects of that corruption are very unpredictable, it depends on what happens afterwards with that corrupted memory
p28504
aVIt is not uncommon that nothing bad happens if the corruption is not in a crucial location
p28505
aVChanging the memory allocation pattern of your program can change that outcome
p28506
aVAll you really know right now is that the unmanaged code can't be trusted
p28507
aVDoing something about it is invariably hard, especially from a managed host program
p28508
aVYou won't get anywhere until you start writing unit tests for that unmanaged code, using unmanaged code to exercise it, and find a reproducible bomb that you could tackle with an unmanaged debugger
p28509
as(dp28510
g9
V17034
p28511
stp28512
a((dp28513
g2
(lp28514
VYes, it will keep firing when additional bytes come in until you call Read()
p28515
aVYou could use the ReceivedBytesThreshold property to delay that
p28516
aVThis is usually a bad idea, losing a byte due to an overrun error could cause communications to seize completely
p28517
aVBuffer what you Read() in the event handler yourself
p28518
aVAlso beware that this is only the known behavior of the Microsoft serial port driver
p28519
aVThe SerialPort class uses the WaitCommEvent API function, it is up to the driver to implement this
p28520
aVEspecially the plethora of USB drivers that emulate a serial port to make it easy to interface to a custom device are not created equal
p28521
as(dp28522
g9
V17034
p28523
stp28524
a((dp28525
g2
(lp28526
VA couple of bugaboos that jump out
p28527
aVThe image format is 24bpp but you are reading bytes
p28528
aVThat could sorta work if it is a pure black+white image but the left pixel would be at x - 3
p28529
aVIndexing x by 3 would also be wise
p28530
aVIndexing the row is wrong, you multiply by w, you should multiply by stride
p28531
as(dp28532
g9
V17034
p28533
stp28534
a((dp28535
g2
(lp28536
VWell, yes, that doesn't behave very gracefully
p28537
aVIt is partly fixed in
p28538
aVNET 4
p28539
aV0, the CreateDelegate() method returns null
p28540
aVThat still doesn't behave gracefully when the JIT optimizer is enabled though, it assumes that CreateDelegate cannot return null and doesn't perform a null check
p28541
aVYou'll get a FatalExecutionEngineError instead of NRE, an exception that is no longer catchable in 4
p28542
ag2512
aVI'd recommend you report the defect to connect
p28543
aVmicrosoft
p28544
aVcom
p28545
aVNot so sure they'll take you seriously, I don't know what their policy is when you intentionally bypass the safeguards
p28546
aVIt could well be that they consider the FEEE good enough
p28547
aVThe workaround is obvious, only call methods of concrete types
p28548
as(dp28549
g9
V17034
p28550
stp28551
a((dp28552
g2
(lp28553
VNot sure what limitations you mean
p28554
aVClearly this can only work on dynamically generated methods, produced by MethodBuilder
p28555
aVClass methods that were JIT compiled from IL loaded from an assembly cannot be replaced
p28556
aVA use case would be implementing a runtime for a dynamic language that supports altering the methods of already defined classes (monkey patching)
p28557
aVLanguages like Ruby, Python, Javascript etc
p28558
as(dp28559
g9
V17034
p28560
stp28561
a((dp28562
g2
(lp28563
VThat's an API function that is only available in Vista and up
p28564
aVI would guess that you are running this code on XP
p28565
aVTo avoid accidentally using API functions that are only available in later versions of Windows, you'll want to define the _WIN32_WINNT macro:
p28566
aVIf you don't set it then it typically defaults to 0x600 on later versions of the Windows SDK, selecting Vista as the target operating system
p28567
aVBtw, you'll probably have to give up on condition variables
p28568
aVThere isn't enough detail in your question to offer a suitable replacement
p28569
aVCode that uses mutexes instead shouldn't be hard to find
p28570
as(dp28571
g9
V17034
p28572
stp28573
a((dp28574
g2
(lp28575
VYes, that will look very blue, some shades of green for high intensity pixels
p28576
aVYou've got a pixel format mismatch, 32bppRgb has one byte for blue, one for green, one for red and one unused byte
p28577
aVCopying the gray image directly will set the blue byte, up to 6 bits of green
p28578
aV16bppGrayScale would be great, if only GDI+ actually supported it
p28579
aVThe problem is that no main-stream video adapter handles this format
p28580
aVYou'll need to translate the pixel values to a RGB triplet
p28581
aVTo make it look gray, you'll need to set the blue, green and red bytes to the same value
p28582
aVThat will be a lossy conversion since you need to squeeze 14 bits into 8 bits
p28583
aVThat doesn't really matter, the human eye isn't nearly good enough to be able to distinguish 16,384 distinct gray levels
p28584
aVSimply right-shift the pixel value by 6, assuming the camera produces a pixel value of 16383 for high luminosity pixels
p28585
aVEither a 24bppRgb or 32bppRgb pixel format will work, the latter will be quicker since it fits an int and you don't have to monkey with stride
p28586
aVNote that false-color images are possible too
p28587
aVYou could arbitrarily map a 14 bit gray value to a color
p28588
aVQuickest way to do this is by using a int[16384] mapping table
p28589
aVWhat you stick in the table is entirely up to you, common mappings are deep red for low intensity, violet for high intensity values
p28590
aVThat's good enough for image display
p28591
aVHowever, if you do any image processing then you'll probably want to take advantage of the camera's resolution
p28592
aVYou'll need to stay away from Bitmap
p28593
aVCheck out a graphics library vendor like LeadTools
p28594
as(dp28595
g9
V17034
p28596
stp28597
a((dp28598
g2
(lp28599
VThe error is explicit, you are trying to link libraries that were compiled with different CPU targets
p28600
aVAn executable image can only contain pure x86 (32-bit) or pure x64 (64-bit) code
p28601
aVMixing is not possible
p28602
aVYou change the target CPU by creating a new configuration for the project, only changing the linker setting isn't enough
p28603
aVBuild + Configuration Manager, Active solution platform combo on upper right, choose New and select x64
p28604
aVThat creates a new configuration with several modified project settings, most importantly the compiler that will be used
p28605
aVBeware that prior to VS2010, the 64-bit compilers are not installed by default
p28606
aVIf you don't see x64 in the platform combo then you'll need to re-run setup
p28607
aVexe and turn on the option to install the 64-bit compilers
p28608
aVThen also re-run any service pack installer you may have applied
p28609
aVA possible approach with less pain points is to use the 32-bit version of the library
p28610
as(dp28611
g9
V17034
p28612
stp28613
a((dp28614
g2
(lp28615
VThe IDE cannot handle this, but msbuild
p28616
aVexe does
p28617
aVEdit the
p28618
aVcsproj file with, say, Notepad
p28619
aVYou'll see four PropertyGroups for the settings of x86/x64 and Debug/Release
p28620
aVThe first one has an  element
p28621
aVCopy and paste it into the other 3 groups
p28622
aVAnd rename their value
p28623
as(dp28624
g9
V17034
p28625
stp28626
a((dp28627
g2
(lp28628
VYes, this is technically possible
p28629
aVYou'll need a filter driver, a device driver type of a component that injects itself ahead of the native serial port driver
p28630
aVIt gets a crack at the driver IRPs before sending them on to the regular driver
p28631
aVThis is the technique used by SysInternals' PortMon utility
p28632
aVHowever, you cannot write such a driver in C# code, the CLR cannot be loaded into ring 0
p28633
aVAt least not until the super-secret Midori project sees the light of day
p28634
aVCOM filter drivers are pretty common, check out this one for example
p28635
aVYou have to do some googling to find one that has a
p28636
aVNET wrapper though
p28637
as(dp28638
g9
V17034
p28639
stp28640
a((dp28641
g2
(lp28642
VThe
p28643
aVdbf file format dates back to the stone age of computing
p28644
aVIt never had a notion of an "empty" column value, unassigned fields would get a default value
p28645
aVSupport for nullable columns didn't come around until FoxPro
p28646
aVI reckon what you ask for isn't possible
p28647
as(dp28648
g9
V17034
p28649
stp28650
a((dp28651
g2
(lp28652
VYou should use the IPAddress class
p28653
aVIt will hassle you a bit because it tries to prevent you from taking a dependency on IP4 addresses
p28654
aVThe Address member is declared obsolete
p28655
aVHere is the workaround:
p28656
aVOutput: 0200A8C0
p28657
aVNote that the address is in proper network order (big endian)
p28658
as(dp28659
g9
V17034
p28660
stp28661
a((dp28662
g2
(lp28663
VNo, that's the GAC location for
p28664
aVNET 1
p28665
aVx through 3
p28666
ag2447
aVThe GAC for 4
p28667
aV0 is located in c:\u005cwindows\u005cmicrosoft
p28668
aVnet\u005cassembly
p28669
aVWhy it was moved isn't clear, probably to avoid trouble with projects that referenced assemblies directly from the GAC, a big no-no but it has been done
p28670
aVYes, reference assemblies live there
p28671
aVAlso in c:\u005cprogram files\u005creference assemblies
p28672
aVThey are initially verbatim copies of the assemblies stored in the GAC
p28673
aVUntil you deploy some kind of hotfix
p28674
aVKeeping them separate ensures that you build programs that target the "proper" framework assemblies, not what you happen to have stored in your GAC
p28675
aVYes, no framework assemblies are there, just build tools
p28676
as(dp28677
g9
V17034
p28678
stp28679
a((dp28680
g2
(lp28681
VYes, doesn't work
p28682
aVProbably because the child windows aren't visible yet
p28683
aVIt works fine in the Shown event:
p28684
as(dp28685
g9
V17034
p28686
stp28687
a((dp28688
g2
(lp28689
VThis is subject to the standard TCP/IP connection time-outs
p28690
aVThe same ones you see when trying to visit a web site that's off line with your browser
p28691
aVYes, you can change them by editing the registry
p28692
aVYou can make them longer
p28693
aVNot shorter
p28694
aVPerhaps you can ping it first if this often fails
p28695
as(dp28696
g9
V17034
p28697
stp28698
a((dp28699
g2
(lp28700
VString
p28701
aVReplace() is going to be horribly inefficient, you'll have to call it for each possible Cyrillic letter you'd want to replace
p28702
aVUse a Dictionary instead (no pun intended)
p28703
aVFor example:
p28704
aVNote how the bars and the Split() function are necessary in the Latin replacement because some Cyrillic letters require more than one letter for their transliteration
p28705
aVKey idea is to use a dictionary for fast lookup and a string builder for fast string construction
p28706
aVThis United Nations document might be helpful
p28707
as(dp28708
g9
V17034
p28709
stp28710
a((dp28711
g2
(lp28712
VYes, this is somewhat possible, the DTE interface supports out-of-process activation
p28713
aVHere's sample code that shows the approach:
p28714
aVThe previous to last statement shows why this isn't really practical
p28715
aVAs soon as your program stops running, the last reference count on the coclass disappears, making Visual Studio quit
p28716
as(dp28717
g9
V17034
p28718
stp28719
a((dp28720
g2
(lp28721
VRemove these try/catch blocks
p28722
aVThat ought to give you a chance to see the TimeoutException you get because you set the WriteTimeout value too low
p28723
aVSending 516 bytes at 9600 baud takes 538 milliseconds
p28724
aVYour other settings are recipes for trouble too
p28725
aVGet rid of ReceivedBytesThreshold and DiscardNull
p28726
as(dp28727
g9
V17034
p28728
stp28729
a((dp28730
g2
(lp28731
VWell, the C++/CLI compiler makes it pretty easy
p28732
aVJust write a static managed function and attribute it with __declspec(dllexport)
p28733
aVThe compiler injects a stub that automatically loads the CLR to execute the managed code
p28734
aVThat's a serviceable approach, it isn't very extensible and it won't be very fast
p28735
aVThe next step up is that you write a ref class with the [ComVisible(true)] attribute
p28736
aVAfter registering it with Regasm
p28737
aVexe, any unmanaged COM aware client can use that server
p28738
aVHosting the CLR yourself (CorBindToRuntimeEx) is usually the last choice, but the most universal one
p28739
aVExample code:
p28740
as(dp28741
g9
V17034
p28742
stp28743
a((dp28744
g2
(lp28745
VYes, it is unreasonable
p28746
aVFew programmers that are college age level + 3 to 5 years (the always preferred candidate) have ever written pure Win32 code to know what an "unmanaged resource" looks like
p28747
aVIt doesn't typically ever come up in their college years, Java is the teaching language nowadays, a language that doesn't have the same pattern
p28748
aVThere are a large number of
p28749
aVNET programmers that have written
p28750
aVNET code for years and shipped production code without ever disposing anything
p28751
aVI'd recommend other interview questions:
p28752
aVWhy does Java not need the IDisposable pattern
p28753
aVWhy do
p28754
aVNET programmers get away with never disposing anything
p28755
aVThat tests for insight rather than rote programming
p28756
aVPerhaps more appropriate for the second interview
p28757
as(dp28758
g9
V17034
p28759
stp28760
a((dp28761
g2
(lp28762
VThe
p28763
aVNET 3
p28764
aV0 System
p28765
aVSpeech
p28766
aVRecognition namespace has very elegant
p28767
aVNET wrapper classes around the SAPI SDK
p28768
aVIncluding the Grammar class to customize the recognition
p28769
aVAs usual, any
p28770
aVNET enabled language can take advantage of it, the specific language doesn't matter
p28771
as(dp28772
g9
V17034
p28773
stp28774
a((dp28775
g2
(lp28776
VYou could improve the while(true) loop to
p28777
aVA bit more graceful, short from the identifier names
p28778
as(dp28779
g9
V17034
p28780
stp28781
a((dp28782
g2
(lp28783
VThis doesn't look good
p28784
aVThe client code would have no idea why it would ever disable events on a private control that it cannot see
p28785
aVNor is there any way for it to see that a public property changed, there are no events to say that a public property changed value
p28786
aVIf it wanted to ignore change events then it would simply unsubscribe or ignore those (missing) events
p28787
aVConsider the
p28788
aVNET framework controls as a guide
p28789
aVNone of them have anything similar to an IEventHackable
p28790
as(dp28791
g9
V17034
p28792
stp28793
a((dp28794
g2
(lp28795
VIt's pretty straight forward, Convert
p28796
aVToBoolean(String) calls Boolean
p28797
aVTryParse()
p28798
aVWhich only accepts "True" or "False"
p28799
aVIf you like to widen the options then you can, there are
p28800
aVNET languages that have a more flexible type system
p28801
aVIt is well supported by the
p28802
aVNET framework:
p28803
aVAdd a reference to Microsoft
p28804
aVVisualBasic
p28805
aVdll
p28806
as(dp28807
g9
V17034
p28808
stp28809
a((dp28810
g2
(lp28811
VTools + Attach to Process allows debugging multiple processes
p28812
aVIn the "Available Processes" list just click + Shift click to select all of them
p28813
aVKeeping track of which instance you're debugging when you set a breakpoint ought to be a bit tricky
p28814
as(dp28815
g9
V17034
p28816
stp28817
a((dp28818
g2
(lp28819
VI don't see the use case, loading user controls through reflection requires knowing the type name of the control
p28820
aVEither use Assembly
p28821
aVCreateInstance if you've dynamically loaded the assembly yourself, or use the full type name with Activator
p28822
aVCreateInstance so that the CLR can determine what assembly needs to be loaded
p28823
aVIf you want to avoid specifying the user control type name then you could iterate the loaded assembly with Assembly
p28824
aVGetTypes() and look for a type that implements your interface
p28825
aVThis is only going to work well if you somehow can guarantee that the assembly contains only one control
p28826
as(dp28827
g9
V17034
p28828
stp28829
a((dp28830
g2
(lp28831
VNo can do
p28832
aVThe class that determines how an item is drawn is PropertyGridView
p28833
aVThe source code is interesting, it almost made it:
p28834
aVNope, looks like at the last minute they decided against making the method overridable
p28835
aVThe PropertyGridView class was also marked internal
p28836
aVReplacing all this code (there is a lot of it) is not a realistic option
p28837
aVCreating your own UITypeEditor for built-in types is only possible by applying the [Editor] attribute to the properties in the class you want to edit
p28838
aVThat's not a general solution
p28839
aVConsider creating your own form to make the object editable instead
p28840
as(dp28841
g9
V17034
p28842
stp28843
a((dp28844
g2
(lp28845
VWell, that doesn't look good
p28846
aVIt is the result of a Windows security problem
p28847
aVThis would not normally fail, the coclass lives in c:\u005cwindows\u005csystem32\u005cquartz
p28848
aVdll
p28849
aVThere are many possible operations that could cause the failure, including having trouble reading the registry and loading the DLL
p28850
aVPerhaps the best way to troubleshoot it is to use SysInternals' ProcMon and observe your program's actions
p28851
aVPay attention to the Result column, you should see the error there
p28852
aVThis ought to get you closer to finding out what security configuration problem might be the source
p28853
as(dp28854
g9
V17034
p28855
stp28856
a((dp28857
g2
(lp28858
VIt is a Windows error (facility 7, error code 1410), caused by RegisterClass(Ex)
p28859
aVThis sample code reproduces it:
p28860
aVLook through your code for places where the coclass uses RegisterClass(Ex)
p28861
aVIt must use UnregisterClass when the instance is destroyed
p28862
aVOr avoid registering the window class again
p28863
aVOr ignore the specific error code
p28864
as(dp28865
g9
V17034
p28866
stp28867
a((dp28868
g2
(lp28869
VThere are so many things your forgot to document:
p28870
aVwhat is your logon provider
p28871
aVAre you attached to a domain
p28872
aVare your running this from a UAC elevated command prompt
p28873
aVwhat does the real user name look like
p28874
aVIs it a system account
p28875
aVdoes the user account actually exist on your machine
p28876
aVcan you logout and logon as that user from your machine
p28877
aVdoes that also work when you disconnect from the network
p28878
aVdo you actually type this command or is it called from a
p28879
aVbat or script
p28880
aVcannot enter the password", you can't type it or it doesn't like what you typed
p28881
aVServerfault
p28882
aVcom is a good place to ask about user authentication
p28883
as(dp28884
g9
V17034
p28885
stp28886
a((dp28887
g2
(lp28888
VAtlThrow isn't terribly useful, it throws CAtlException which merely wraps an error code
p28889
aVHaving a MapViewOfFile fail is a truly exceptional problem with a low-level error code that doesn't tell you or your user much at all what actually went wrong
p28890
aVHandling the error is almost always impossible, it isn't likely that you can shrug it off and just not use a MMF
p28891
aVYou'll have to log the error and terminate your program with a very generic error
p28892
aVGetting very detailed in your error message is usually wasted effort
p28893
aV"MapViewOfFile call failed in MyClass::DoSomething() method" just doesn't mean anything at all to your user or her support staff
p28894
aVGreat for you though, something to trace the error to
p28895
aVBut you can easily automate this, without localization trouble, by using the  and  macros
p28896
aVAll that you really need to match the error to the source code
p28897
aVKeep the error message short and snappy
p28898
aVFor Windows errors, you'll want to use FormatMessage() to let Windows generate the message
p28899
aVIt will automatically be localized, the message text is standardized and googles well
p28900
aVDeriving from std::exception is okay
p28901
aVUse string resource IDs for custom messages so you can easily localize them
p28902
aVSolves the what() problem too
p28903
as(dp28904
g9
V17034
p28905
stp28906
a((dp28907
g2
(lp28908
VThe standard approach is to add the project to the solution
p28909
aVIt is then entirely automatic
p28910
as(dp28911
g9
V17034
p28912
stp28913
a((dp28914
g2
(lp28915
VGetting a large close button is fairly easy to do
p28916
aVIt is hidden well since Vista, in Win7 it is Control Panel + Personalization + Window Color, Advanced appearance settings, Item = Caption buttons, change the Size
p28917
aVYou probably won't like this much though, you'll get a rather large caption bar, lots of waste screen real estate
p28918
aVTackling this from the other end: your request is unusual
p28919
aVMost anybody that sets up a touch screen app wants to know how to prevent the user from closing the window
p28920
aVWindows Forms makes it too easy to design a bunch of forms and switch between them
p28921
aVThat isn't much of a user interface on a regular desktop, especially not here
p28922
aVYou can design your forms as user controls as well and switch them in and out of the main window as the user navigates through the UI
p28923
aVNot unlike, say, Microsoft Outlook
p28924
aVYou can even turn your existing form into a control
p28925
aVSet its TopLevel property to False, FormBorderStyle to None, Visible to true
p28926
as(dp28927
g9
V17034
p28928
stp28929
a((dp28930
g2
(lp28931
VYes, your first code snippet gives OOP purists the shivers
p28932
aVApplication
p28933
aVRun() requires a form object, you are passing the form type
p28934
aVThat this is possible is an anachronism carried over from VB6
p28935
aVIt is admittedly very bad style, it prevents programmers from understanding the difference between a type and an object
p28936
aVSomething that's crucial to understand to get ahead with object oriented programming
p28937
aVIt is also quite lethal when you start using threads
p28938
aVYour second snippet is closer to what's needed, except that it cannot work
p28939
aVYou pass an uninitialized object to Run()
p28940
aVFix:
p28941
aVOr taking advantage of VB
p28942
aVNET syntax:
p28943
aVOr since you never actually need the object in the Main method:
p28944
as(dp28945
g9
V17034
p28946
stp28947
a((dp28948
g2
(lp28949
VA similar function on Windows would be CreateStreamOnHGlobal()
p28950
aVThat however works with the IStream COM interface, it isn't a drop-in replacement for FILE
p28951
aVYou might want to take a peek at the Cygwin source code to see what they did
p28952
as(dp28953
g9
V17034
p28954
stp28955
a((dp28956
g2
(lp28957
VDelegates first
p28958
aVWhen you declare one, the compiler automatically generates three methods for the delegate type:
p28959
aVInvoke(
p28960
aV, taking the same arguments as the delegate declaration
p28961
aVBeginInvoke(
p28962
aV, AsyncCallback, object) where
p28963
aVare the declared arguments
p28964
aVEndInvoke(IAsyncResult)
p28965
aVThe Invoke() method calls the delegate target synchronously, just like a plain call
p28966
aVThe BeginInvoke() method is the asynchronous call, the target method runs on a thread-pool thread
p28967
aVThe EndInvoke() call is required after the method completes to release resources allocated for the call and to re-raise any exception that might have aborted the call
p28968
aVThe
p28969
aVNET framework contains many classes that have a BeginXxxx() method
p28970
aVThe MSDN Library refers to them as asynchronous operations, not asynchronous methods
p28971
aVThey start an operation that completes asynchronously
p28972
aVStarting with
p28973
aVNET 4
p28974
aV5 and supported by C# version 5, the asynchronous operations whose name end in Async and return a Task can be called in an await expression
p28975
aVWhen used in a method that has the async modifier
p28976
aVThis greatly simplifies dealing with asynchronous operations, important in WinRT where many common operations are asynchronous
p28977
as(dp28978
g9
V17034
p28979
stp28980
a((dp28981
g2
(lp28982
VGetSystemTime() produces a UTC time stamp with millisecond resolution
p28983
aVAccuracy however is far worse, the clock usually updates at 15
p28984
aV625 millisecond intervals on most Windows machines
p28985
aVThere isn't much point in chasing improved accuracy, any clock that provides an absolute time stamp is subject to drift
p28986
aVYou'd need dedicated hardware, usually a GPS radio clock, to get something better
p28987
aVWhich are hard to use properly on a non-realtime multi-tasking operating system
p28988
aVWorst-case latency can be as much as 200 milliseconds
p28989
as(dp28990
g9
V17034
p28991
stp28992
a((dp28993
g2
(lp28994
VIf you think a crawler could guess the product names or categories correctly to land on all pages of your site, it would be just as likely to do so with a number
p28995
aVUse the name or category ID, saves you the hassle from localizing these names as well
p28996
as(dp28997
g9
V17034
p28998
stp28999
a((dp29000
g2
(lp29001
VThis isn't normal
p29002
aVStart with Tools + Import and Export, select Reset all Settings
p29003
aVNext step is to run devenv
p29004
aVexe with the /safemode command line argument so it runs with all add-ins disabled
p29005
as(dp29006
g9
V17034
p29007
stp29008
a((dp29009
g2
(lp29010
VYes, this web page suggests that Putty gets edgy about non-interactive logons
p29011
aVIf the suggested workaround doesn't help, I recommend you ask questions about it at a Putty support forum or Superuser
p29012
aVcom
p29013
aVIt's got otherwise nothing to do with the Process class or the C# language
p29014
as(dp29015
g9
V17034
p29016
stp29017
a((dp29018
g2
(lp29019
VYes, that's possible, you want to turn "design mode" on for the document
p29020
aVAdd a reference to Microsoft
p29021
aVmshtml
p29022
aVStart a new Windows Forms project and drop a WB and a button on the form
p29023
aVMake the code look similar to this:
p29024
as(dp29025
g9
V17034
p29026
stp29027
a((dp29028
g2
(lp29029
VThe open source ICU library is very commonly used
p29030
as(dp29031
g9
V17034
p29032
stp29033
a((dp29034
g2
(lp29035
VThis isn't normal
p29036
aVThe app will die from an unhandled exception which triggers a Windows Error Report
p29037
aVI would have to guess that the target machine has WER disabled or replaced
p29038
as(dp29039
g9
V17034
p29040
stp29041
a((dp29042
g2
(lp29043
VQUWI uses a thread from the thread pool to execute the callback function
p29044
aVSuch threads are very light weight but not suitable for all types of threaded tasks
p29045
aVBasic requirements are that they need to be relatively short-lived, don't block very often and are not time critical
p29046
aVIt is all rather well explained in the SDK topic
p29047
as(dp29048
g9
V17034
p29049
stp29050
a((dp29051
g2
(lp29052
VIt's pretty easy to make one yourself
p29053
aVAdd a class, derive it from Control
p29054
aVYou'll need a Timer that keeps it going, have its Tick method call Invalidate()
p29055
aVOverride OnPaint() to draw the digits and am/pm indicator
p29056
aVYou'll want the TextRenderer
p29057
aVDrawText() overload that draws inside a rectangle to get the digits centered
p29058
aVDraw a black line through the center
p29059
aVOught to be fun
p29060
as(dp29061
g9
V17034
p29062
stp29063
a((dp29064
g2
(lp29065
VYou'll need to move the delegate declaration outside of the interface and declare it public
p29066
aVAll types used by an interface must be public when the class that implements them is public
p29067
aVNecessarily so or the client code could never assign the event
p29068
aVThus:
p29069
aVIf you limit the accessibility of the class you can use your original approach:
p29070
as(dp29071
g9
V17034
p29072
stp29073
a((dp29074
g2
(lp29075
VThe C++ is riddled with mistakes, not sure if I got it right
p29076
aVThe best thing to do is to declare DeviceIoControl() with altered argument types so that it is easy to call
p29077
aVYou also have to P/Invoke CreateFile because FileStream cannot open devices
p29078
aVIt ought to look similar to this:
p29079
as(dp29080
g9
V17034
p29081
stp29082
a((dp29083
g2
(lp29084
VYes, this is a "feature" of the Windows MDI implementation
p29085
aVDesign guides require the child form to have an icon so it is easy for the user to see what child was maximized and where to click to activate the system menu
p29086
aVThe Windows Forms designer should have disabled the "ShowIcon" property and force it True but it can't because it doesn't know yet that the form will become an MDI child
p29087
aVYou'll have to work around it
p29088
aVOne possibility is using a 1x1 icon that's transparent so it won't be visible when the child form is maximized
p29089
aVIt is however not an ideal fix, the form's caption text will be shifted to the right
p29090
aVThe path of least resistance is to simply create an icon for the form
p29091
as(dp29092
g9
V17034
p29093
stp29094
a((dp29095
g2
(lp29096
VIt is a problem with the font
p29097
aVWindows XP got shipped in non-Asian countries with fonts that only contain glyphs that were in common use in those countries
p29098
aVThat mattered 9 years ago, XP had to run on machines with very limited resources
p29099
aVIf a requested glyph is missing from a font, Windows replaces it with a square
p29100
aVShort from installing fonts that support Asian language (Control Panel + Regional and Language options), this is not going to be a problem when somebody that runs a Japanese version of Windows looks at your UI
p29101
aVShe'll have the right fonts installed
p29102
as(dp29103
g9
V17034
p29104
stp29105
a((dp29106
g2
(lp29107
VFor general machine information, you'll want to use WMI
p29108
aVIt is supported by the classes in the System
p29109
aVManagement namespace, in particular the ManagementQuery class
p29110
aVThe best way to get started on this is the WmiCodeCreator utility
p29111
aVIt lets you discover what WMI classes are available on the machine and run queries
p29112
aVBest of all, it auto-generates the C# code you need, ready to cut-and-paste into your program
p29113
aVStrongly recommended
p29114
as(dp29115
g9
V17034
p29116
stp29117
a((dp29118
g2
(lp29119
VThis could only work if JobData is a structure
p29120
aVYou're dead in the water if it is a class, you cannot create a C++ class instance in C#
p29121
aVYou don't have access to the constructor and destructor
p29122
aVThe "const" keyword is an attribute checked by the C++ compiler, it has no relevance to C# code
p29123
aVA C++ reference is a pointer under the hood, you'll get one by declaring the argument with "ref"
p29124
aVYou're likely to have a problem getting the "ShowJob" export name right, it is normally decorated by the C++ compiler
p29125
aVYou'd suppress that decoration by prefixing the function with extern "C" in the C++ code
p29126
aVIf you cannot change the C++ code then you can find the exported name by running Dumpbin
p29127
aVexe /exports on the DLL
p29128
aVPutting this all together, the declarations ought to resemble something like this:
p29129
aVLot's of guess work going on here, you'll need to verify this with your actual C++ code
p29130
aVIf the JobData argument is in fact a class then you'll need to write a ref class wrapper in the C++/CLI language
p29131
as(dp29132
g9
V17034
p29133
stp29134
a((dp29135
g2
(lp29136
VYes, there's a heuristic in the garbage collector algorithm that makes it automatically adjust the allocation strategy
p29137
aVThe most visible side-effect of this is seeing the gen 0 heap size growing as the program is running and consuming memory
p29138
aVTypically starts at 2 MB, it can get to ~8 MB if the program consumes memory rapidly
p29139
aVThe performance counters visible in Perfmon
p29140
aVexe are good for this
p29141
aVThe emphasis is very much on "automatic", this code was written with the flat-out assumption that programmers don't have enough information available to them to properly steer the algorithm
p29142
aVThe only "hooks" are stuff that the GC cannot know about, like unmanaged memory usage (GC
p29143
aVAddMemoryPressure) or the role of the program (app
p29144
aVexe
p29145
aVconfig)
p29146
aVThe details of the heuristic are not documented
p29147
aVHowever, you can glean some background info from today's publishing house for software algorithm documentation, the US Patent Office
p29148
aVMost of Microsoft's GC algorithms patents are credited to Patrick Dussud, you can easily find them back with a google query on his name
p29149
aVHere's a relevant one
p29150
as(dp29151
g9
V17034
p29152
stp29153
a((dp29154
g2
(lp29155
VWhen you expand the String Table node in the Resource View window, you should see the string tables for each individual language
p29156
aVYou add a string to each table by double-clicking them in turn
p29157
aVThe language is automatically set from the string table language
p29158
aVIf you don't see this then the
p29159
aVrc wasn't created properly originally
p29160
aVWhich is common when somebody starts editing it with a text editor
p29161
aVThe resource editor has trouble with
p29162
aVrc files that were created by hand
p29163
aVYou're kinda doomed to keep maintaining it with a text editor
p29164
aVWhich isn't particularly a real problem, the editor isn't exactly user-friendly when adding resource strings in several languages
p29165
aVAny localization expert I've ever seen doesn't bother with the resource editor
p29166
as(dp29167
g9
V17034
p29168
stp29169
a((dp29170
g2
(lp29171
VThe text box behavior is a symptom of the same problem
p29172
aVSomething is swallowing mouse down notifications
p29173
aVIt isn't explained by your code snippet
p29174
aVForms indeed swallow the mouse click that activates them, but that is a one-time behavior and is turned off by setting its TopLevel property to False
p29175
aVNot much left
p29176
aVOne candidate is the Control
p29177
aVCapture property, turned on at the MouseDown event for a button so that the button can see the MouseUp event, no matter where the mouse moved
p29178
aVThat's a one-time effect as well
p29179
aVWatch out for controls that set the Focus in a MouseDown event
p29180
aVThe other is some kind of IMessageFilter code in your form(s) that's eating WM_LBUTTONDOWN messages
p29181
as(dp29182
g9
V17034
p29183
stp29184
a((dp29185
g2
(lp29186
V%E7 is not a string that's encoded in 8859-1
p29187
aVIt looks like URL encoding
p29188
aVUse HttpUtility
p29189
aVUrlDecode(str, Encoding
p29190
aVGetEncoding("iso-8859-1"))
p29191
as(dp29192
g9
V17034
p29193
stp29194
a((dp29195
g2
(lp29196
VYou should use TextRenderer
p29197
aVMeasureText, all controls use TextRenderer to draw text in
p29198
aVNET 2
p29199
aV0 and up
p29200
aVThere is no unambiguous solution to your question, there are many possible ways to fit text in a Rectangle
p29201
aVA wide one that displays just one line is just as valid as a narrow one that displays many lines
p29202
aVYou'll have to constrain one of the dimensions
p29203
aVIt is a realistic requirement, this rectangle is shown inside some other control and that control has a certain ClientSize
p29204
aVYou'll need to decide how you want to lay it out
p29205
as(dp29206
g9
V17034
p29207
stp29208
a((dp29209
g2
(lp29210
VImplement an event handler for the list view's ItemDrag event:
p29211
aVAnd write the event handlers for the trash can:
p29212
aVYou'll have to force the AllowDrop property for the PictureBox, it isn't available in the Properties window:
p29213
as(dp29214
g9
V17034
p29215
stp29216
a((dp29217
g2
(lp29218
VThe Load event is the earliest possible moment to find out what the "normal" size of the form will be
p29219
aVAt that point, any scaling induced by AutoSizeMode and any user overrides to border and caption sizes have been applied
p29220
aVHowever, that size will only be valid if the WindowState is not set to Minimized in the designer
p29221
aVYou'll have to wait until the form is at least shown once in the Normal state
p29222
aVAlso beware that the size you'll get is faked if you run with Aero fat borders enabled
p29223
aVVista and Win7 intentionally return a window size that would be reported if earlier operating systems ran your program
p29224
aVIf this really matters, you'll have to use Editbin
p29225
aVexe to mark your program Vista compatible
p29226
aVBear traps out there, try to avoid having to ask the question
p29227
aVYou can always change the window location or size when you get the Resize event
p29228
aVIf this is only to memorize the form location and size then you'll want to use Settings
p29229
aVUse Project + Properties, Settings tab to add them
p29230
aVYou cannot use the automatic ApplicationSettings binding because you don't want to save the location and size of the form when it is minimized or maximized
p29231
aVMake it look like this:
p29232
as(dp29233
g9
V17034
p29234
stp29235
a((dp29236
g2
(lp29237
VWhile most opcodes are a single byte, there are several opcodes in current use that contain 2 bytes
p29238
aVFor example, Opcodes
p29239
aVLdLoc is encoded as 0xfe + 0x0c
p29240
aVYou can probably guess the value of Opcodes
p29241
aVPrefix1, it ix 0xfe
p29242
aVPrefix2-7 are for future extensibility
p29243
aVThey are marked as "do not use" because multi-byte opcodes already have the prefix included in their value (fields m_s1 and m_s2)
p29244
aVIf you're interested in the background info, you'll want to take a look at the Ecma-335 standard document
p29245
as(dp29246
g9
V17034
p29247
stp29248
a((dp29249
g2
(lp29250
VIf you've coded in C++ before then you must be familiar with pointers
p29251
aVAn object reference in
p29252
aVNET code and Java is a pointer under the hood
p29253
aVIt just isn't explicitly written in a syntax that makes it obvious that it is a pointer, you are supposed to memorize it
p29254
aVThe rule isn't very hard, any variable that refers to an object of a class, an array, a string or System
p29255
aVObject is a reference type and the variable is a pointer
p29256
aVAnything else is a value type and the variable contains the actual value
p29257
aVWhen you pass such a variable to a method, you are passing the pointer value
p29258
aVThe method can then modify the pointed-to object as it sees fit
p29259
aVPassing the pointer by reference doesn't make any difference, it is still the same pointer, pointing to the same object
p29260
aVThis is entirely different when you pass a value of a value type
p29261
aVIf you want the calling method to modify that value then you have to generate a pointer to that value
p29262
aVYou do so by using the "ref" keyword in the method declaration
p29263
aVThe outlier case is where you want the calling method to return a new object
p29264
aVIn other words, modify the pointer value
p29265
aVThen you have to use the ref keyword, that creates a pointer to a pointer
p29266
aVYou'd typically avoid that by having the method return the object as the method return value
p29267
as(dp29268
g9
V17034
p29269
stp29270
a((dp29271
g2
(lp29272
VI agree it is not terribly logical to not get the ThreadException event
p29273
aVIt does however work this way, a ThreadException is only raised when the message loop dispatches an event and there's an unhandled exception in the event handler
p29274
aVThe Idle event is raised when there is no message to be dispatched anymore, it follows an entirely different code path
p29275
aVYou can work around it by trapping exceptions in your Idle event handler yourself:
p29276
aVBeware that ThreadException is rather a mixed blessing if you let the user decide whether to quit or continue the program
p29277
aVAlso note that it isn't universal enough to catch all exceptions in your program, you still need AppDomain
p29278
aVCurrentDomain
p29279
aVUnhandledException to deal with exceptions raised in threads other than the UI thread or exceptions that are raised before the message loop starts running
p29280
aVIf you are doing this to make sure the user can not click "Continue" then simply use Application
p29281
aVSetUnhandledExceptionMode() to disable the ThreadException event completely
p29282
aVNow everything goes through AppDomain
p29283
aVUnhandledException
p29284
aVIt is the better way
p29285
as(dp29286
g9
V17034
p29287
stp29288
a((dp29289
g2
(lp29290
VNot sure I see the resource problem
p29291
aVThere is no notion of a "root namespace"
p29292
aVYou have the follow the C++ rules for namespace declarations, you'll have to nest them one at a time
p29293
aVFor example:
p29294
aVAnd in the
p29295
aVcpp file:
p29296
aVThere's no trouble adding resources when it is declared like this that I could find
p29297
aVBut don't add a resource, then change the namespace name
p29298
aVThe C++ IDE has no refactoring support whatsoever
p29299
aVWindows Forms development in C++/CLI isn't very popular, this would perhaps be one reason
p29300
as(dp29301
g9
V17034
p29302
stp29303
a((dp29304
g2
(lp29305
VThe keys in the Keys enumeration are virtual keys
p29306
aVThey don't turn into characters until Windows has translated them, using the currently active keyboard layout
p29307
aVWhich is a detail that varies from one machine to the next, depending on the user's preference and language
p29308
aVAnd quite likely the specific kind of mobile device your software is running on
p29309
aVAlso, many virtual keys don't produce a character, Keys
p29310
aVF1 would be an obvious example
p29311
aVTurning virtual keys into characters yourself is something you should really avoid, you are going to get it wrong
p29312
aVKeys
p29313
aVEnter is already translated by Windows, it will generate the KeyPressed event with e
p29314
aVKeyChar = '\u005cr'
p29315
aVOn most machines, anyway
p29316
aVIf you want to detect short-cut keys then you use KeyDown
p29317
aVTyping keys that produce characters require KeyPressed
p29318
as(dp29319
g9
V17034
p29320
stp29321
a((dp29322
g2
(lp29323
VYeah, it is possible, indirectly
p29324
aVThere's plenty of unmanaged code you'll use when you work with namespaces like System
p29325
aVManagement, System
p29326
aVWindows
p29327
aVMedia, System
p29328
aVDrawing
p29329
aVPrinting, System
p29330
aVIO
p29331
aVPorts
p29332
aVThat code can issue device driver calls which can trigger a bug in the device driver
p29333
aVBlue screen is next
p29334
aVObviously the real problem is not in the managed code, it is a crummy driver
p29335
aVBut to answer the question directly: no, an unhandled managed exception cannot cause a BSOD
p29336
as(dp29337
g9
V17034
p29338
stp29339
a((dp29340
g2
(lp29341
VYes, storing an assembly in the GAC requires them to be strong named
p29342
aVWhich is not the same thing as signing with a certificate
p29343
aVIt is very simple to assign a strong name: Project + Properties, Signing, check "Sign the assembly", key file = New
p29344
aVThe resulting
p29345
aVsnk file should be checked-in to your SCCS so it is always signed from the same key container
p29346
as(dp29347
g9
V17034
p29348
stp29349
a((dp29350
g2
(lp29351
VWell, it is a serious defect in the COM server you are using
p29352
aVYes, it is indirectly triggered by the CLR, the last reference count of a COM object is released when the finalizer thread runs the RCW finalizer
p29353
aVMarshal
p29354
aVReleaseComObject counts the reference count down to 0 and the COM server's IUnknown::Release() implementation method will clean up the object
p29355
aVThat's always a vulnerable time for a COM server
p29356
aVWhen it corrupted the heap earlier, a common time for this to trigger a CPU hardware fault (AV = Access Violation) is when it releases memory
p29357
aVMicrosoft put a catcher for this hardware exception in place to help diagnose the problem
p29358
aVWithout it, you'd have very little chance to figure out what happened because the finalizer runs at an unpredictable time without any of your own code actively running
p29359
aVThe fault is quite serious, you're left with a corrupted heap that's only partly cleaned up
p29360
aVIf you keep going, you'll typically just get more AVs and/or you'll leak memory
p29361
aVThe worst possible outcome, quite likely btw, is that it doesn't die afterwards but just starts generating bad data or misbehaves unpredictable, causing you to think that it is your code that is buggy
p29362
aVThere's only one party that can fix this problem, the supplier of this COM server
p29363
aVCarefully specify the machine you are running on, especially the operating system version is important, and give them a small piece of code (source included) that reproduces the exception
p29364
aVKeeping it small and highly visible is important or they'll claim it was your code that corrupted the heap
p29365
aVThey are likely to do so anyway, heap corruption is very difficult to debug
p29366
aVIf you cannot get them responsive, you'd be wise to shop for another vendor
p29367
as(dp29368
g9
V17034
p29369
stp29370
a((dp29371
g2
(lp29372
VReflector is a crucial tool for a
p29373
aVNET developer
p29374
aVIt is immediately obvious what you need to do when you use it to look at the UserControl
p29375
aVText property:
p29376
aVHo showed you what you need to do to cancel these attributes, too bad he didn't show you how he found out
p29377
aVReflector is was free, download it from redgate
p29378
aVcom or check the alternatives here : Something Better than
p29379
aVNET Reflector
p29380
as(dp29381
g9
V17034
p29382
stp29383
a((dp29384
g2
(lp29385
VIt is a low-level Windows error, code 14, ERROR_OUTOFMEMORY
p29386
aVThe error message doesn't mention "memory" because it isn't always caused by running out of memory
p29387
aVThe most typical trigger is a program exceeding its quota of kernel resources
p29388
aVLike 10,000 window handles, there are many others
p29389
aVThat's for the desktop edition btw, I don't doubt it is much lower on Windows Mobile
p29390
aVWell, the program is a piggy
p29391
aVOne possible way to trigger this error is to not call Dispose() on objects of classes that implement IDisposable
p29392
aVThat will consume kernel resources that won't be released until the garbage collector and finalizer thread run
p29393
aVWhich could take a while
p29394
aVThe SQL CE classes are certainly a candidate
p29395
aVIf you have no clue where the resource leak or over-usage is coming from then invest in a profiler that works on CF
p29396
as(dp29397
g9
V17034
p29398
stp29399
a((dp29400
g2
(lp29401
VBecause a "fixed buffer" is not a real array
p29402
aVIt is a custom value type, about the only way to generate one in the C# language that I know
p29403
aVThere is no way for the CLR to verify that indexing of the array is done in a safe way
p29404
aVThe code is not verifiable either
p29405
aVThe most graphic demonstration of this:
p29406
aVYou can arbitrarily access the stack frame in this example
p29407
aVThe standard buffer overflow injection technique would be available to malicious code to patch the function return address and force your code to jump to an arbitrary location
p29408
aVYes, that's quite unsafe
p29409
as(dp29410
g9
V17034
p29411
stp29412
a((dp29413
g2
(lp29414
VThere's nothing abstract about the object you get back
p29415
aVThere are 13 classes inside the
p29416
aVNET framework that implement XmlWriter
p29417
aVThey are all internal, you could only see their names if you'd peek at the source code with Reflector
p29418
aVNot having to know the names of those 13 classes yourself is very valuable both to you and Microsoft
p29419
aVTo you because you don't have to learn the details of picking the right one
p29420
aVTo Microsoft because they can completely change the implementation, even the name, of those classes and your code would never notice
p29421
aVThis is called the Factory Pattern
p29422
as(dp29423
g9
V17034
p29424
stp29425
a((dp29426
g2
(lp29427
VYour program is dying on an Access Violation
p29428
aVWhile there's no conclusive evidence, this most likely happened when the garbage collector or finalizer thread was running
p29429
aVWhich would make the exception uncatchable
p29430
aVThis is almost always caused by heap corruption
p29431
aVIt is very unlikely that it is the
p29432
aVNET Socket code that caused the corruption, that code has been put to the test billions of times
p29433
aVAlthough you are giving it a good work-out
p29434
aVThe much more likely cause is some kind of unmanaged code that's used by your program
p29435
aVSome kind of COM server, perhaps you P/Invoke something
p29436
aVIt could also be some sort of add-in to the machine, like a virus scanner
p29437
aVFinding the true cause is going to be difficult
p29438
aVStart with the environmental stuff, boot Windows in safe mode with network support
p29439
aVRun SysInternals' AutoRuns utility to disable stuff that gets started automatically
p29440
aVGood luck with it, you'll need it
p29441
as(dp29442
g9
V17034
p29443
stp29444
a((dp29445
g2
(lp29446
VYour approach is not going to work
p29447
aVGMail is not a regular Windows program, the kind that you can start with Process
p29448
aVStart()
p29449
aVIt is coded in Javascript and runs in your browser
p29450
aVThe login procedure is handled by Javascript
p29451
aVYou'll need a browser plug-in to tinker with GMail
p29452
aVA popular one that works on Firefox is Greasemonkey
p29453
aVLots of GMail hacks in this google query
p29454
as(dp29455
g9
V17034
p29456
stp29457
a((dp29458
g2
(lp29459
VNot sure why you'd want to do this, allowing the debugger to peek at your private parts can be pretty important while debugging
p29460
aVShort from overriding the ToString() method, consider using the [DebuggerVisualizer] attribute instead
p29461
aVQuite handy to present a birds-eye view of the object state and still allowing to drill in to the privates when you need to
p29462
as(dp29463
g9
V17034
p29464
stp29465
a((dp29466
g2
(lp29467
VYou'll want to P/Invoke AllocConsole()
p29468
aVBe sure to do so early, before using any of the Console methods
p29469
aVFind the declaration at pinvoke
p29470
aVnet
p29471
aVA really quick way to get a console: Project + Properties, Application tab, Output type = Console Application
p29472
aVFor a more permanent way to provide diagnostic output, you really want to use the Trace class
p29473
aVIt is very flexible, you can use the app
p29474
aVexe
p29475
aVconfig file to determine where the trace output goes
p29476
aVReview the MSDN Library docs for the TraceListener class
p29477
as(dp29478
g9
V17034
p29479
stp29480
a((dp29481
g2
(lp29482
VIt is intuitively obvious that Graphics cannot have a default constructor
p29483
aVYou always want what you draw to be visible somewhere
p29484
aVA default constructor could not select the destination of the drawing
p29485
aVWays to get a Graphics object:
p29486
aVGraphics
p29487
aVFromImage()
p29488
aVYou'll draw into a bitmap
p29489
aVCommon when resizing images or to create a "canvas"
p29490
aVControl
p29491
aVCreateGraphics()
p29492
aVLet's you draw directly to the screen
p29493
aVAlways wrong, instead use:
p29494
aVPaint event
p29495
aVThe e
p29496
aVGraphics argument lets you draw to the screen
p29497
aVPrintPage event
p29498
aVFor the PrintDocument class, e
p29499
aVGraphics ends up on a piece of paper
p29500
aVGraphics
p29501
aVFromHdc()
p29502
aVUse in low-level P/Invoke code, draws to a Windows' device context
p29503
aVGraphics
p29504
aVFromHwnd()
p29505
aVAs above, draws directly to a native window
p29506
aVIn summary:
p29507
aVDraw to the screen with the Paint event
p29508
aVDraw to the printer with the PrintPage event
p29509
aVDraw to a bitmap with FromImage()
p29510
as(dp29511
g9
V17034
p29512
stp29513
a((dp29514
g2
(lp29515
VYou'll have to set the  property
p29516
aVFor example:
p29517
aVThe actual color you use doesn't matter, you'll get a black rectangle with an alpha of 0
p29518
as(dp29519
g9
V17034
p29520
stp29521
a((dp29522
g2
(lp29523
VIt's pretty simple: the Contract class signals contract violations by throwing an exception
p29524
aVPutting it in a try block defeats the purpose, you're liable to catch the exception
p29525
as(dp29526
g9
V17034
p29527
stp29528
a((dp29529
g2
(lp29530
VYou cannot protect yourself against crummy USB device drivers
p29531
aVShop around for a better one
p29532
as(dp29533
g9
V17034
p29534
stp29535
a((dp29536
g2
(lp29537
VThe VB
p29538
aVNET compiler has the /langversion command line option
p29539
aVIt is supported by msbuild but not the IDE
p29540
aVSloppy, but fixable
p29541
aVOpen the
p29542
aVvbproj in, say, notepad and paste this XML, right after the Project element:
p29543
as(dp29544
g9
V17034
p29545
stp29546
a((dp29547
g2
(lp29548
VThis code is hard-baked into Common7\u005cIDE\u005cmsvb7
p29549
aVdll
p29550
aVPretty shocking, considering how totally inappropriate it is for the 99
p29551
aV99% of cases where you'd want to implement IDisposable
p29552
aVConsider using code snippets
p29553
aVYou can create your own snippets with the Snippet Editor
p29554
as(dp29555
g9
V17034
p29556
stp29557
a((dp29558
g2
(lp29559
VThis DLL function appears to take a file name and return some data from the file into a buffer
p29560
aVYou don't specify the full path to the file, "#rawdatafile#" would be a relative path
p29561
aVThe odds that this works in an asp
p29562
aVnet page are very small
p29563
aVSpecify a full path instead (like "c:\u005cblah\u005csomething
p29564
aVtxt" instead of "something
p29565
aVtxt")
p29566
aVLots of other possible failure modes
p29567
aVLike the DLL path and whether the asp
p29568
aVnet account has the necessary rights to access these files
p29569
as(dp29570
g9
V17034
p29571
stp29572
a((dp29573
g2
(lp29574
VThe  method creates a new DataSet with the same structure
p29575
aVThe  method does too, and copies the data
p29576
as(dp29577
g9
V17034
p29578
stp29579
a((dp29580
g2
(lp29581
VThe Shown event is pretty much designed for this
p29582
as(dp29583
g9
V17034
p29584
stp29585
a((dp29586
g2
(lp29587
VDateTimePicker is a native Windows control, the
p29588
aVNET class is wrapper for it
p29589
aVYes, several look-and-feel changes in that native control since Vista
p29590
aVYou should not fix behavior, the user will perceive your control to have non-standard behavior since it acts differently from all other ones shown by different programs that run on that operating system
p29591
as(dp29592
g9
V17034
p29593
stp29594
a((dp29595
g2
(lp29596
VThe CLR version is the
p29597
aVNET framework version
p29598
aVNET 3
p29599
aV0, 3
p29600
aV5 and 3
p29601
aV5 SP1 only distinguish themselves by adding assemblies to the original 2
p29602
aV0 set
p29603
aVAccordingly, the base assemblies for 3
p29604
aV5 SP1 still carry a 2
p29605
ag2512
ag2512
aV0 [AssemblyVersion]
p29606
aVYou can see this in the Add Reference dialog
p29607
as(dp29608
g9
V17034
p29609
stp29610
a((dp29611
g2
(lp29612
VThis doesn't work because ExecuteScalar returns an object
p29613
aVThat will be a boxed integer
p29614
aVIt can only be unboxed to an integer, anything else will generate a type cast exception
p29615
aVThe C# language specification doesn't waste a lot of words on it in chapter 4
p29616
ag2586
aV2:
p29617
aVAn unboxing operation to a non-nullable-value-type consists of first checking that the object instance is a boxed value of the given non-nullable-value-type, and then copying the value out of the instance
p29618
aVConverting it to a long is not wise btw
p29619
aVThere's nothing you could do with that long that wouldn't eventually produce some kind of SQL error
p29620
aVLike incrementing it yourself
p29621
as(dp29622
g9
V17034
p29623
stp29624
a((dp29625
g2
(lp29626
VNagging the user by slapping her with message boxes doesn't make for the greatest user interface
p29627
aVBut you can easily do it just by setting the min and max smaller/larger and checking the value in the ValueChanged event
p29628
as(dp29629
g9
V17034
p29630
stp29631
a((dp29632
g2
(lp29633
VDebug + Windows + Modules, find your DLL in the list
p29634
aVRight-click it and choose "Symbol Load Information"
p29635
aVIt will show you where it found the
p29636
aVpdb file
p29637
aVFinding the wrong
p29638
aVpdb is not a great explanation for your troubles btw
p29639
aVMaybe you ought to post to connect
p29640
aVmicrosoft
p29641
aVcom
p29642
aVGiving them a good repro would be essential however
p29643
as(dp29644
g9
V17034
p29645
stp29646
a((dp29647
g2
(lp29648
VThe Timer class is very relaxed about raising its Tick event
p29649
aVInternally, inside the Windows code, when the timer is due it only sets an internal flag, somewhat akin to "ought to deliver WM_TIMER"
p29650
aVThat doesn't actually happen until nothing important needs to be done by the message loop
p29651
aVAny message gets higher priority than WM_TIMER
p29652
aVWhen the Windows Forms message loop calls GetMessage(), the function checks if anything needs to be returned
p29653
aVIf the answer is "nothing" and the flag is set, it supplies WM_TIMER
p29654
aVAnd you'll get the Tick event
p29655
aVA couple of consequences from that: you can never use the Tick event to keep track of time
p29656
aVThat will inevitably fall behind
p29657
aVYou can never get the Tick event twice in a row, it doesn't catch up
p29658
aVBut relevant to your question: the message loop isn't pumping when the machine goes in stand-by, nothing special happens
p29659
as(dp29660
g9
V17034
p29661
stp29662
a((dp29663
g2
(lp29664
VIt's possible, you can use Assembly
p29665
aVLoad(byte[]) to load an assembly as well
p29666
aVThat assembly doesn't have a "loading context", you can load it repeatedly
p29667
aVManaging this is however not easy, you're bound to find out
p29668
as(dp29669
g9
V17034
p29670
stp29671
a((dp29672
g2
(lp29673
VThe
p29674
aVNET 2
p29675
aV0 SDK doesn't actually include the
p29676
aVNET 2
p29677
aV0 framework
p29678
aVIt is merely a collection of tools and header files, they are nowadays included with the Windows SDK
p29679
aVYou've already got that in the c:\u005cprogram files\u005cmicrosoft sdks directory
p29680
aVYou'll need to download and install an earlier version of
p29681
aVNET
p29682
aVUsing 3
p29683
aV5 SP1 is the best choice, the download is here
p29684
aVPick one that's appropriate for your language
p29685
as(dp29686
g9
V17034
p29687
stp29688
a((dp29689
g2
(lp29690
VI might be missing the point of your request, but the XAML editor automatically puts collapsible regions around the elements
p29691
aVNote the nodes in the left rail of the editor window
p29692
aVClick the "-" and the associated element collapses to a single line, much like a #region
p29693
as(dp29694
g9
V17034
p29695
stp29696
a((dp29697
g2
(lp29698
VWindowStyle =
p29699
aVProcessWindowStyle
p29700
aVHidden
p29701
aVComment this out so you can actually read the error message that lame produces
p29702
aVUsing a separate EXE is brittle this way, you cannot detect nor diagnose it failing to do its job
p29703
aVYou might see something from Process
p29704
aVExitCode, non-zero values are supposed to indicate failure
p29705
as(dp29706
g9
V17034
p29707
stp29708
a((dp29709
g2
(lp29710
VThis requires P/Invoke
p29711
aVProject + Add Reference, select System
p29712
aVDrawing
p29713
aVAgain for System
p29714
aVWindows
p29715
aVForms
p29716
aVAdd a new class to your project and paste this code:
p29717
as(dp29718
g9
V17034
p29719
stp29720
a((dp29721
g2
(lp29722
VThe proper one is choice #4:
p29723
aVUsing a readonly field instead of a public const is important
p29724
aVThe literal value of a const is compiled into the IL
p29725
aVIf you change the const value and recompile one assembly that uses it, you'll now have a mismatch with other assemblies that use the const as well
p29726
aVThose other assemblies will still run with the old const value
p29727
aVVery hard to diagnose
p29728
aVThis cannot happen with a readonly field, the other assemblies will always read the updated value
p29729
aVIf you use const, be sure to always make them private
p29730
as(dp29731
g9
V17034
p29732
stp29733
a((dp29734
g2
(lp29735
VA casting exception isn't easily explained by a problem with the default directory of a program
p29736
aVWhich is about all that ought to be different when you run your app from the VB6 IDE rather than directly
p29737
aVYou'll have to use a debugger to find out what's going wrong
p29738
aVLuckily that's easy when you use VB6
p29739
aVStart by opening your
p29740
aVNET project in Visual Studio
p29741
aVProject + Properties, Debug tab
p29742
aVSelect "Start external program", click the button with the dots and navigate to vb6
p29743
aVexe
p29744
aVIt should be located in c:\u005cprogram files\u005cmicrosoft visual studio\u005cvb98\u005cvb6
p29745
aVexe if you used the default install options
p29746
aVYou can set the "Command line options" setting to the path to your
p29747
aVvbp project so the IDE automatically loads it
p29748
aVNot strictly necessary
p29749
aVDebug + Exceptions, check the "Common Language Runtime Exception" Thrown check box
p29750
aVPress F5 to start the debugger
p29751
aVThe VB6 IDE will now open, load your VB6 project if necessary
p29752
aVRun the project and recreate the failure case
p29753
aVThat should cause a breakpoint in the Visual Studio debugger
p29754
aVYou may have to switch to it by hand, the taskbar button should be blinking
p29755
aVUse the normal debugging tools to find out why the exception was thrown
p29756
aVNote that you can also set breakpoints in Visual Studio, useful if you need to single-step through the code to find out what's wrong
p29757
aVWhen you press F5, the breakpoint indicator turns hollow since the DLL isn't loaded yet
p29758
aVAs soon as your VB6 project creates a class object from your
p29759
aVNET code, the DLL will be loaded (visible in the Output window) and the breakpoint indicator will turn solid
p29760
aVIf that doesn't happen then you may need to run Regasm
p29761
aVexe with the /codebase option so that the DLL in the project's bin\u005cDebug folder gets registered as the COM server
p29762
as(dp29763
g9
V17034
p29764
stp29765
a((dp29766
g2
(lp29767
VNice repro code, I had no trouble diagnosing the source of the problem
p29768
aVIt is a feature, not a bug
p29769
aVPress the arrow down key several times, then scroll the list
p29770
aVNote that it doesn't jump back now
p29771
aVWhat's going on here is that list box automatically scrolls the item with the focus back into view when it gets updated
p29772
aVThis is normally desirable behavior, you cannot turn it off
p29773
aVWorkarounds, like selecting the item you're updating, isn't going to be pretty when you update the list like this, it is going to flicker badly
p29774
aVMaybe virtual mode, I didn't try it
p29775
aVListView doesn't have this behavior, consider using it instead
p29776
aVUse View = List or Details
p29777
as(dp29778
g9
V17034
p29779
stp29780
a((dp29781
g2
(lp29782
VI've got the 90% solution, reverse-engineered from the clipboard formats and my answer in this thread
p29783
aVYou'll need to set two pieces of clipboard data
p29784
aVThe list of files, that's easy to do
p29785
aVAnd another clipboard format named "Preferred Dropeffect" that indicates whether a copy or a move of the files is requested
p29786
aVLeading to this code:
p29787
aVSample usage:
p29788
aVPressing Ctrl+V in Windows Explorer copied the files from my c:\u005ctemp directory
p29789
aVWhat I could not get going is the "cut" operation, passing false to StartCopyFiles() produced a copy operation, the original files where not removed from the source directory
p29790
aVNo idea why, should have worked
p29791
aVI reckon that the actual stream format of "Preferred DropEffects" is fancier, probably involving the infamous PIDLs
p29792
as(dp29793
g9
V17034
p29794
stp29795
a((dp29796
g2
(lp29797
VHmya, VB
p29798
aVNET always had the "dynamic" feature built in
p29799
aVThis syntax was supported forever:
p29800
aVThe dynamic keyword was C#'s way of catching up to what VB
p29801
aVNET could do for a long time
p29802
aVNevertheless, VB
p29803
aVNET version 10 did gain some additional capabilities, it is using the DLR as well
p29804
aVWhich allows you to interop with IronPython and IronRuby
p29805
aVC# copied many other VB
p29806
aVNET features
p29807
aVLike optional parameters and support for properties that take arguments
p29808
aVThe syntax is exactly the same, use the Dim keyword without As
p29809
aVYou will however have to use Option Strict Off, Option Infer On can soften that blow a bit
p29810
aVIt does show that C# adding the dynamic keyword was a pretty good move
p29811
as(dp29812
g9
V17034
p29813
stp29814
a((dp29815
g2
(lp29816
VYes, this is known behavior for ComboBox
p29817
aVAppcompat no doubt, it switches to legacy rendering mode when owner draw is enabled
p29818
aVThere is no known fix for this
p29819
aVAlso covered in this SO question
p29820
aVI have a solution however
p29821
aVThere's another native combo box control in Windows, named ComboBoxEx
p29822
aVIt is largely forgotten and not wrapped by Windows Forms
p29823
aVIt is a common control, designed to easily draw images in the dropdown list
p29824
aVIt always has owner draw turned on
p29825
aVAs luck would have it, this control doesn't flip the appcompat switch, just what you need
p29826
aVAdd a new class to your project and paste the code shown below
p29827
aVCompile
p29828
aVDrop the new control from the top of the toolbox onto your form
p29829
aVAlternatively, you'd probably just want to copy the CreateParams override into your own control
p29830
aVBeware that I did not do any extensive testing on this, I'm not 100% sure that the Window Forms ComboBox wrapper class is compatible enough with the native control
p29831
aVI also took a shortcut on the requirement to call InitCommonControlsEx, it won't work on a machine that has visual styles turned off
p29832
aVI suspect you might run into a few surprises
p29833
aVThe SDK docs for this control are here
p29834
as(dp29835
g9
V17034
p29836
stp29837
a((dp29838
g2
(lp29839
VIt is a set of managed class wrappers around the native COM interfaces
p29840
aVYou can download it here
p29841
as(dp29842
g9
V17034
p29843
stp29844
a((dp29845
g2
(lp29846
VYou cannot directly use C++ classes in managed code
p29847
aVThe chief problems are not being able to use the same memory allocator as used by the C++ code and not being able to invoke the constructor and destructor easily
p29848
aVA Microsoft employee posted a blog post to show that it is not impossible
p29849
aVI would not recommend doing this
p29850
aVCOM is a solution but that invariably requires a fairly big rewrite and good COM programming skillz
p29851
aVA managed class wrapper in the C++/CLI language is usually the best solution
p29852
aVYou could take a peek at the SWIG tool to consider auto-generating those wrapper classes
p29853
aVBeware however that this tool can easily create more problems than it solves
p29854
as(dp29855
g9
V17034
p29856
stp29857
a((dp29858
g2
(lp29859
VIt doesn't make any sense to optimize this
p29860
aVTransmitting 20 bytes at 9600 baud takes the hardware 21 milliseconds
p29861
aVAnd takes the software a few microseconds
p29862
aVFast enough to be able to update the display faster than the human eye could ever perceive by a factor of 2
p29863
aVAnd it isn't like you need the "bandwidth", there isn't any additional data that I can think of that you'd want to multiplex on the serial channel
p29864
as(dp29865
g9
V17034
p29866
stp29867
a((dp29868
g2
(lp29869
VI'll assume this is a multi-line text box and that you'll allow it to grow vertically
p29870
aVThis code worked well:
p29871
aVYou ought to do something reasonable when the text box is empty
p29872
as(dp29873
g9
V17034
p29874
stp29875
a((dp29876
g2
(lp29877
VYou are working from the assumption that an outer class would have special knowledge of the lifetime of an object so that it call Dispose() at the right time
p29878
aVThat rarely works, only the client code knows when it is done with an object
p29879
aVWith your class as written, you achieve the exact opposite goal, you'll keep the objects alive much longer than necessary
p29880
aVNot even the garbage collector could run the finalizer because you keep holding on to the object until some magic moment in time where all objects are ready to be disposed
p29881
aVThe usual term for this is "memory leak"
p29882
aVDon't do this
p29883
as(dp29884
g9
V17034
p29885
stp29886
a((dp29887
g2
(lp29888
VThe native Window control doesn't support a Padding property, you cannot convince it otherwise
p29889
aVNot a real problem
p29890
aVSimply set the BorderStyle to None and put it in a Panel whose AutoScroll property is True
p29891
aVYou'll have to set the list box size in the form's Load event because it might be rescaled
p29892
aVYuck, that looks wrong
p29893
aVOh well
p29894
as(dp29895
g9
V17034
p29896
stp29897
a((dp29898
g2
(lp29899
VThis is a stunningly common question since VS2010 got released
p29900
aVSounds to me that lots of folks didn't trust it, drug an old and forgotten XP machine out of the rubble pile, installed VS2010 on it and then flipped the "expect magic" switch when they ran pre-
p29901
aVNET 4
p29902
aV0 apps
p29903
aVNo, those apps require a app
p29904
aVexe
p29905
aVconfig file with a  element to convince them that you have verified that they will work properly on the new CLR version
p29906
aVCould be useful, you can send a message to the app vendor that you've verified that the app works well
p29907
aVThey'll appreciate that
p29908
aVIf you don't care much for being the unpaid tester then simply install
p29909
aVNET 3
p29910
aV5 SP1 on that machine
p29911
aVBtw: it will really stink perf wise, you haven't defragged the disk on that machine forever
p29912
as(dp29913
g9
V17034
p29914
stp29915
a((dp29916
g2
(lp29917
VCall the Owner's Hide() method
p29918
aVFor example:
p29919
as(dp29920
g9
V17034
p29921
stp29922
a((dp29923
g2
(lp29924
VWell, Thread
p29925
aVSleep() is blocking too
p29926
aVMuch worse, actually, because you'd have to specify a sleep time that is always safe, even if the machine is under heavy load
p29927
aVUsing ReadLine() is always better, it will be quicker and it cannot fail
p29928
aVNote that your example doesn't require the client code to wait for a response
p29929
aVIt can simply assume that the command was effective
p29930
aVAll you need is an Error event to signal that something went wrong
p29931
aVIf there is a command that requires the client code to get the response that you should offer the option to wait as well as get the result asynchronously
p29932
aVThat gives the client code options: waiting is slow but easy, async is difficult to program
p29933
aVIt is a very common pattern in the
p29934
aVNET framework, the asynchronous method name starts with "Begin"
p29935
aVCheck the MSDN Library article about it
p29936
aVYou also should consider delivering asynchronous notifications on the thread that the client code prefers
p29937
aVThe SynchronizingObject property is a good pattern for that
p29938
as(dp29939
g9
V17034
p29940
stp29941
a((dp29942
g2
(lp29943
VYou can check if the assembly is dynamic by skipping instances of AssemblyBuilder
p29944
aVYou should use Path
p29945
aVGetFileName() to isolate the name
p29946
aVBeware that this is not a very good idea since assemblies from different paths may have identical names
p29947
aVBut you seem to be stuck with this
p29948
aVThus:
p29949
aVCase sensitivity is something you should deal with as well, perhaps
p29950
as(dp29951
g9
V17034
p29952
stp29953
a((dp29954
g2
(lp29955
VYou can make your own pretty easily, the Region property makes it simple
p29956
aVAdd a new class to your project and paste the code shown below
p29957
aVCompile
p29958
aVDrop the new control from the top of the toolbox onto a form
p29959
as(dp29960
g9
V17034
p29961
stp29962
a((dp29963
g2
(lp29964
VThis is normal, non-admin user accounts do not have write access to c:\u005cprogramdata
p29965
aVOnly Read, Execute and List privileges are assigned by default
p29966
aVThis includes admin accounts with UAC enabled
p29967
aVThe AppData folder should be used to write files
p29968
aVGet the path to that folder with Environment
p29969
aVGetFolderPath()
p29970
as(dp29971
g9
V17034
p29972
stp29973
a((dp29974
g2
(lp29975
VThere's been a fair amount of flux in the WPF classes
p29976
aVNote the "Supported in" annotation at the bottom of the MSDN Library article for this method
p29977
aVYou'll need to have at least
p29978
aVNET 3
p29979
aV0 SP1 installed on that machine, the service pack that was released at the same time as
p29980
aVNET 3
p29981
ag2447
aVThere is no good way to check for this, the [AssemblyVersion] didn't change
p29982
aVThis was papered-over by relying on Windows Update automatically upgrading the
p29983
aVNET version
p29984
aVIf your customer blocks these updates then you'll have to setup a test machine that has the original
p29985
aVNET 3
p29986
aV0 release installed
p29987
aVThe workaround is simple enough, once you find them, use an overload that is available in 3
p29988
aV0 RTM
p29989
aVAsking the customer to deploy 3
p29990
aV5 SP1 would be wise
p29991
as(dp29992
g9
V17034
p29993
stp29994
a((dp29995
g2
(lp29996
VThe ScrollWindowEx() API function is optimized to do this
p29997
as(dp29998
g9
V17034
p29999
stp30000
a((dp30001
g2
(lp30002
VUse the fuslogvw
p30003
aVexe tool to find out where the CLR is searching for the assembly
p30004
as(dp30005
g9
V17034
p30006
stp30007
a((dp30008
g2
(lp30009
VIt is writing to the registry okay, just to the wrong key
p30010
aV32-bit setup programs write to HKLM\u005cSoftware\u005cWow6432Node, the set of registry keys that 32-bit programs see
p30011
aVYour app will run in 64-bit mode, it won't get redirected like that
p30012
aVYou'll need to set the target platform in your setup project
p30013
aVOr force your app to run in 32-bit mode with the Target Platform = x86 setting in the Build tab
p30014
as(dp30015
g9
V17034
p30016
stp30017
a((dp30018
g2
(lp30019
VYou would need a "master" coclass to lock in the EXE instance, similar to an "Application" interface
p30020
aVLocate the CoRegisterClassObject() call for its factory
p30021
aVAnd change the REGCLS argument to REGCLS_SINGLEUSE
p30022
aVThis will automatically unregister the class factory as soon as the first client connects to it
p30023
aVCalling CoCreateInstance() for that factory again starts a new instance of the server
p30024
aVI think
p30025
as(dp30026
g9
V17034
p30027
stp30028
a((dp30029
g2
(lp30030
VThe required character set is defined in section 2
p30031
ag2584
ag2582
aVSection 2
p30032
ag2584
ag2582
aV2 then goes on to describe the behavior of extension characters:
p30033
aVThe single-byte characters defined in $2
p30034
ag2584
aV1 shall be present
p30035
aVThe presence, meaning, and representation of any additional members is locale-specific
p30036
as(dp30037
g9
V17034
p30038
stp30039
a((dp30040
g2
(lp30041
VYou can P/Invoke VkKeyScan() to convert a typing key code back to a virtual key
p30042
aVBeware that the modifier key state is important, getting "|" requires holding down the shift key on my keyboard layout
p30043
aVYour function signature doesn't allow for this so I just made something up:
p30044
aVAlso beware of keyboard layouts that need to use dead keys (Alt+Gr) to generate typing keys
p30045
aVThis kind of code is really best avoided
p30046
as(dp30047
g9
V17034
p30048
stp30049
a((dp30050
g2
(lp30051
VOnLoad is called again because base
p30052
aVOnLayout() uses properties that will recreate the window
p30053
aVThat's not good, you'll definitely need to fix that
p30054
aVYou'll need to find out why OnLayout is getting called when the control is being disposed
p30055
aVSet a breakpoint on your OnLayout override and check out the call stack
p30056
aVPost it in your question if you can't make sense of it
p30057
as(dp30058
g9
V17034
p30059
stp30060
a((dp30061
g2
(lp30062
VNo, that's definitely a multi-line string editor
p30063
aVDon't forget to click the dropdown arrow on the edit box to invoke the editor
p30064
aVYou have to press Ctrl+Enter to get it to close the window
p30065
aVIf you don't like the way it works then you can create your own by deriving from the UITypeEditor class
p30066
as(dp30067
g9
V17034
p30068
stp30069
a((dp30070
g2
(lp30071
VThis kind of tool definitely falls in the do-it-yourself category
p30072
aVStart a new Windows Forms application
p30073
aVPaste the code shown below
p30074
aVPut a shortcut to the program on your desktop
p30075
aVTo use it, drag a file from Explorer onto the form
p30076
aVSwitch to Visual Studio and type Ctrl+V
p30077
aVThe better mousetrap is to add the file as a resource instead of hard-coding the text
p30078
as(dp30079
g9
V17034
p30080
stp30081
a((dp30082
g2
(lp30083
VEasy enough to do
p30084
aVProject + Properties, Settings tab, add a setting named "Printer"
p30085
aVThen use it like this:
p30086
aVSomebody with admin privileges will have to edit your app
p30087
aVexe
p30088
aVconfig file to set the printer name
p30089
aVGiven how likely it is for the printer name to change, I would strongly recommend you make this a User scoped setting and add an Options + Select Printer menu command to allow the user to select the printer
p30090
aVUse PrintDialog
p30091
as(dp30092
g9
V17034
p30093
stp30094
a((dp30095
g2
(lp30096
VSorry, you're a million miles from diagnosing this correctly
p30097
aVType libraries are for compilers, they are not (usually) needed at runtime
p30098
aVThe exception code you are getting shows what is going wrong
p30099
aVIt is the exception code for a managed exception
p30100
aVIn other words, your C# code is throwing an exception and it isn't being handled
p30101
aVWhich is pretty common for C# code, when it finds a problem that it doesn't know how to handle then it throws instead of plodding on generating garbage data
p30102
aVThere are two basic ways to tackle this
p30103
aVThe Q&D; approach is to use a debugger switched to managed mode and make it stop on an unhandled managed exception
p30104
aVDebug + Exception, Thrown check box, for example
p30105
aVOr you could add some diagnostics to the method itself, logging the error in a catch block for example
p30106
aVStart with Q&D;, it is almost always something silly, like FileNotFound
p30107
as(dp30108
g9
V17034
p30109
stp30110
a((dp30111
g2
(lp30112
VI got that working, once
p30113
aVMy recommendation would be 1: don't do it, 2: don't do it, 3: only use private queues and assign the workstations static IP addresses in the 192
p30114
aV168
p30115
ag22731
aVx subnet
p30116
aVEither provide each machine with a hostfile to map machine names to IP addresses or use the IP address directly in the format name
p30117
aVRelying on name resolution in a work group is hoping to win playing roulette in Vegas
p30118
as(dp30119
g9
V17034
p30120
stp30121
a((dp30122
g2
(lp30123
VOf course there's a reason, they wouldn't have provided the Collect() method otherwise
p30124
aVThey are few and far between though
p30125
aVOnly ever use it when you know that a whole bunch of long-lived objects that would have been promoted to gen #2 are ready to be collected
p30126
aVOr to release a COM object that has lots of references that you cannot possibly track should really be unloaded
p30127
aVOr to work around crummy code that doesn't call Dispose() when it should
p30128
aVIt's rare
p30129
as(dp30130
g9
V17034
p30131
stp30132
a((dp30133
g2
(lp30134
VThe focus is a bit different in
p30135
aVNET, it has very good support for generating IntelliSense info
p30136
aVDocumentation at your finger tips
p30137
aVI'm sure you're familiar with it when you used VS for a while, look up "xml documentation"
p30138
aVOff-line docs used to be covered by NDoc but the guy that supported it quit his project
p30139
aVThe Sandcastle project took up the slack
p30140
aVSeems to be a bit laggy too these days btw
p30141
as(dp30142
g9
V17034
p30143
stp30144
a((dp30145
g2
(lp30146
VA down-voting fest, I hesitate to post
p30147
aVBut Henrik is right, the very first thread is started by Windows when it launches the EXE
p30148
aVIt does a whole bunch of work, loading the CLR is one of its duties
p30149
aVAnd it runs the Main() method in your program
p30150
aVThe
p30151
aVNET framework gives very few options to configure that thread
p30152
aVOnly the [MTAThread] and [STAThread] attributes on the Main() method makes a difference, they affect how the CLR calls the CoInitializeEx() API function
p30153
aVThe stack size of the thread is in fact configurable
p30154
aVIt is one of the fields in the PE32 file format, the format used in Windows for executable images
p30155
aVUsually the C# or VB
p30156
aVNET compiler is responsible for generating that file, neither have an option to set the initial thread stack size
p30157
aVBit of an oversight
p30158
aVThey use defaults, one megabyte for a 32-bit EXE, four megabytes for a 64-bit EXE (Platform Target = x64)
p30159
aVChanging that value is possible, you can run the Editbin
p30160
aVexe utility to modify the EXE file, use the /STACK command line option
p30161
aVYou'll want to do this in a post-build step
p30162
aVBeware that this is incompatible with strong names or signing with a certificate since it modifies the EXE file
p30163
aVIt isn't a real problem btw, if you need a thread with a lot of stack space then you create one yourself in the Main() method
p30164
as(dp30165
g9
V17034
p30166
stp30167
a((dp30168
g2
(lp30169
VVery unclear, XML is a very poor substitute for a database
p30170
aVI reckon you'll want to use DataTable or DataSet to load the
p30171
aVmdb data
p30172
aVTheir WriteXml() method makes it very easy to generate the xml
p30173
as(dp30174
g9
V17034
p30175
stp30176
a((dp30177
g2
(lp30178
VSet the label's Spring property to True to get is to adjust its size automatically
p30179
aVTo get ellipses you'll need to override the painting
p30180
aVAdd a new class to your project and paste the code shown below
p30181
aVCompile
p30182
aVYou'll get the new SpringLabel control in the status strip designer dropdown list
p30183
aVYou'll need to do more work if you use the Image or TextAlign properties
p30184
as(dp30185
g9
V17034
p30186
stp30187
a((dp30188
g2
(lp30189
VYou can do this by overriding ProcessCmdKey()
p30190
aVCheck if a text box has the focus
p30191
aVFor example:
p30192
as(dp30193
g9
V17034
p30194
stp30195
a((dp30196
g2
(lp30197
VSome code to play with
p30198
aVIt supports focus, panning and scrolling
p30199
aVZooming is work-to-do, my laptop's mousepad got in the way of testing it
p30200
aVUse a timer to implement auto-scrolling at the edges
p30201
as(dp30202
g9
V17034
p30203
stp30204
a((dp30205
g2
(lp30206
VReset the ContextMenuStrip property back to (none)
p30207
aVImplement the MouseUp event handler and use ListView
p30208
aVHitTest() to find out where it was clicked
p30209
aVFor example:
p30210
as(dp30211
g9
V17034
p30212
stp30213
a((dp30214
g2
(lp30215
VYou can catch this at the form level, before the ToolStrip control grabs the key
p30216
aVOverride the form's ProcessCmdKey() method, make it look similar to this:
p30217
as(dp30218
g9
V17034
p30219
stp30220
a((dp30221
g2
(lp30222
VSounds like registry damage, HKCU\u005cSoftware\u005cMicrosoft\u005cVisualStudio\u005c10
p30223
aV0_Config perhaps
p30224
aVTry running devenv
p30225
aVexe with the /ResetSettings command line option first
p30226
aVNext is rerunning setup
p30227
aVexe and choosing the Repair option
p30228
as(dp30229
g9
V17034
p30230
stp30231
a((dp30232
g2
(lp30233
VIt is a
p30234
aVNET goodie: the public classes in a EXE can be loaded from it just like a regular class library
p30235
aVThere's no need to build it to a DLL
p30236
as(dp30237
g9
V17034
p30238
stp30239
a((dp30240
g2
(lp30241
VIt isn't exactly clear what you are asking
p30242
aVAssuming you've got bitmap files with names like "spring
p30243
aVpng" etc in your bin\u005cDebug folder, this ought to work:
p30244
as(dp30245
g9
V17034
p30246
stp30247
a((dp30248
g2
(lp30249
VIt is a common request, check out this project
p30250
aVFind others by googling "checkedcombobox"
p30251
as(dp30252
g9
V17034
p30253
stp30254
a((dp30255
g2
(lp30256
VNot likely, given your example
p30257
aVOn a 64-bit processor, the structure will fit comfortably in registers, it won't be passed through the stack
p30258
aVAlbeit not on a 32-bit processor and an instance method
p30259
aVWhen you pass by reference, you're paying for accessing the structure members, an extra pointer dereference is required
p30260
aVThis can get to be more expensive then avoiding the copy, ymmv
p30261
aVThe payoff typically starts when the structure is more than 16 bytes
p30262
aVOne reason for the common guidance to switch to a class when the structure gets larger than that
p30263
aVGiven that this completely depends on usage, you'll either have to analyze your code and read the assembly (release build of course) or use a profiler
p30264
aVThe profiler isn't that likely to show a difference
p30265
aVIt is usually pretty hard to measure a nanosecond unless you artificially do it a billion times
p30266
as(dp30267
g9
V17034
p30268
stp30269
a((dp30270
g2
(lp30271
VFirst thing you'll want to do is enable double-buffering on the TreeView so it will stop flickering
p30272
aVThat's supported since Vista but unfortunately not by Windows Forms
p30273
aVAdd a new class to your project and paste the code shown below
p30274
aVCompile
p30275
aVDrop the control from the top of the toolbox onto your form
p30276
aVKeeping your UI responsive requires a redesign of your ParseFile() method
p30277
aVAs written, it calls BeginInvoke() much too frequently
p30278
aVThat floods the UI thread with requests it cannot keep up with
p30279
aVIt doesn't get around its normal duties anymore, like painting and responding to mouse clicks
p30280
aVIt is wasted effort, the human eye cannot perceive updates that happen at a rate faster than 25 times per second
p30281
aVStore the data in a collection, BeginInvoke and pass that collection at a much slower rate
p30282
as(dp30283
g9
V17034
p30284
stp30285
a((dp30286
g2
(lp30287
VIf you don't put your ComVisible
p30288
aVNET assembly in the GAC then you have to use the /codebase option with Regasm
p30289
aVexe
p30290
as(dp30291
g9
V17034
p30292
stp30293
a((dp30294
g2
(lp30295
VYes, that can't work this way
p30296
aVThe AxHost wrapper requires its Handle to be created before it is usable
p30297
aVWhich requires it to be a child control on a form whose Show() method is called
p30298
aVYou normally get two interop wrappers from an ActiveX control, an AxBlah
p30299
aVdll which contains the AxHost wrapper and a Blah
p30300
aVdll which wraps the COM interfaces
p30301
aVYou'd only need to reference Blah
p30302
aVdll
p30303
aVWhether that will work is an open question, many ActiveX controls require a window handle to deal with thread synchronization
p30304
aVIf that doesn't work out, you'll need a host form
p30305
aVYou can keep it invisible by pasting this code into the form class:
p30306
aVYou have to call Application
p30307
aVRun() to pump the message loop
p30308
as(dp30309
g9
V17034
p30310
stp30311
a((dp30312
g2
(lp30313
VYes, that's pretty inefficient
p30314
aVA UserControl derives from ScrollableControl, just like Panel
p30315
aVSo it is capable of displaying scrollbars and scroll its content, like like Panel
p30316
aVSet its AutoScroll property to true, set AutoScrollMinSize if necessary
p30317
as(dp30318
g9
V17034
p30319
stp30320
a((dp30321
g2
(lp30322
VWell, yes, it is technically possible for TerminateProcess not to terminate the process
p30323
aVIf there's a kernel thread executing an I/O request that never ends then the process cannot exit
p30324
aVEasy to diagnose, you'll see the process in Taskmgr
p30325
aVexe's Processes tab with a handle count of one
p30326
aVVista had a CancelIo improvement to fix this, I think Raymond talked about that too
p30327
aVWhich is only very remotely associated with COM
p30328
aVGrasping at straws: an out-of-process COM server doesn't deal with TerminateProcess of a client well, Windows cannot automatically call Release() on the interface pointers
p30329
aVIt will keep running forever
p30330
aVUntil somebody calls TerminateProcess, usually the Windows shutdown code or TaskMgr
p30331
aVexe
p30332
aVDo make sure to edit your question and explain why you even asked it
p30333
as(dp30334
g9
V17034
p30335
stp30336
a((dp30337
g2
(lp30338
VYes, that's about right
p30339
aVThere is a buffer that stores the process output, usually between 1 and 4KB in the common CRT implementations
p30340
aVOne small detail: that buffer is located in the process you start, not the
p30341
aVNET program
p30342
aVNothing very special needs to happen when you redirect to a file, the CRT directly writes it
p30343
aVBut if you redirect to your
p30344
aVNET program then output goes from the buffer into a pipe
p30345
aVWhich then takes a thread switch to your program so you can empty the pipe
p30346
aVBack and forth a good 700 times
p30347
aVYes, not fast
p30348
aVEasily fixed though, call setvbuf() in the program you are running to increase the stdout and stderr output buffer sizes
p30349
aVThen again, that takes having the source code of that program
p30350
aVAnticipating a problem with that: maybe you ought to use cmd
p30351
aVexe /c to get the redirection to a file, then read the file
p30352
as(dp30353
g9
V17034
p30354
stp30355
a((dp30356
g2
(lp30357
VThe problem is located in code we cannot see, GenerateThumbnail()
p30358
aVGuessing at the way it might work, it creates a bitmap from ProductImageNormal
p30359
aVThat puts a lock on the file which prevents it from being deleted
p30360
aVYou'll have to call the bitmap's Dispose() method to release the lock
p30361
as(dp30362
g9
V17034
p30363
stp30364
a((dp30365
g2
(lp30366
VI think this is an artifact of the
p30367
aVNET 1
p30368
aV1 designer
p30369
aVBack then there was no partial keyword yet, the designer had the unenviable task to find back the InitializeComponent() method, even in code that was in the middle of being edited
p30370
aVNo help from the compiler
p30371
aVTo avoid the risk of completely interpreting code incorrectly, it had some basic rules about what that code should look like
p30372
aVAnd requiring the form class to be the first class in the file makes a lot of sense
p30373
aVIf that rule wouldn't be there, it would have to be able to parse through a class that might have very basic syntax errors, like unbalanced braces
p30374
aVSimply declaring "cannot load form" in that case wouldn't make anybody happy
p30375
aVThis requirement couldn't be lifted once the partial keyword became available, it still has to support forms that were designed in earlier versions
p30376
aVIt is the only code layout rule I know
p30377
aVThere are lots of other possible mishaps, tinkering with InitializeComponent() by hand is always a good way to get the WSOD
p30378
as(dp30379
g9
V17034
p30380
stp30381
a((dp30382
g2
(lp30383
VThe lblBrowsefoldertoputconvertedfiles is a hint perhaps
p30384
aVYou are supposed to pass the string resource name, not the name of the directory that contains the resource
p30385
aVTo do it "properly", be sure to take advantage of the My
p30386
aVResources feature
p30387
aVProceed as follows:
p30388
aVProject + Add New Item, General, Resources File
p30389
aVName it Resources
p30390
aVfr-FR
p30391
aVresx and click Add
p30392
aVThe string resource editor automatically opens
p30393
aVAdd the strings that you've got in your original string table, now using French as the language
p30394
aVCompile
p30395
aVLook in your project's bin\u005cDebug folder and verify that you now see the satellite assembly
p30396
aVIt should be stored in the fr-FR directory with the project
p30397
aVresources
p30398
aVdll name
p30399
aVTest this by dropping a button on your form and writing this code:
p30400
as(dp30401
g9
V17034
p30402
stp30403
a((dp30404
g2
(lp30405
VThat's syntax sugar, provided by the compiler
p30406
aVA more accurate representation of this statement would be:
p30407
aVwhich explains how a2 simply gets a reference to a new string object and answers your question
p30408
aVThe actual code is highly optimized because it is so common
p30409
aVThere's a dedicated opcode available for it in IL:
p30410
aVString literals are collected into a table inside the assembly
p30411
aVWhich allows the JIT compiler to implement the assignment statement very efficiently:
p30412
aVA single machine code instruction, can't beat that
p30413
aVMore so: one very notable consequence is that the string object doesn't live on the heap
p30414
aVThe garbage collector doesn't bother with it since it recognizes that the address of the string reference isn't located in the heap
p30415
aVSo you don't even pay for collection overhead
p30416
aVCan't beat that
p30417
aVAlso note that this scheme easily allows for string interning
p30418
aVThe compiler simply generates the same LDSTR argument for an identical literal
p30419
as(dp30420
g9
V17034
p30421
stp30422
a((dp30423
g2
(lp30424
VYou cannot store the instance in the managed class object and generate a pointer to it easily
p30425
aVThat's very incompatible with the garbage collector
p30426
aVIt will move managed objects around when it compacts the heap, that can happen at unpredictable times
p30427
aVTrying to pass a pointer to a userData member will generate a compiler error
p30428
aVSome workarounds: allocate the userData instance on the heap with new, store the pointer in the managed object
p30429
aVThat is however pretty inefficient, you'll need to implement a destructor and a finalizer to release it
p30430
aVDo this only if you expect to have a limited number of instances of the managed class
p30431
aVNext solution is to generate the pointer at the time of the call, using pin_ptr<>
p30432
aVThat pins the managed object in memory, preventing the garbage collector from moving it
p30433
aVNot terribly efficient of course
p30434
aVFinally, you could declare an instance of userData as a local variable in the method that makes the call and copy the one in the managed object into it
p30435
aVNo problem generating pointers to stack variables, they cannot move
p30436
aVYou are now also free to declare the structure in your managed class whichever way you want
p30437
aVAssuming this struct isn't too large, that's what I would pick
p30438
as(dp30439
g9
V17034
p30440
stp30441
a((dp30442
g2
(lp30443
VYou are working from the assumption that the debugger can track variable changes
p30444
aVIt can't
p30445
aVIt is possible with unmanaged code, the processor has dedicated debug registers that allow setting data breakpoints
p30446
aVUp to three are provided
p30447
aVIt generates a hardware interrupt when it sees a particular memory location getting written
p30448
aVThis otherwise very useful feature isn't available in managed code however
p30449
aVThe garbage collector is completely incompatible with it, it moves objects around, giving them another address
p30450
aVThe managed debugger does support a "when hit" condition on a breakpoint, allowing you to dump info to the output window
p30451
aVThat however requires a breakpoint, it cannot be triggered by a change in variable value
p30452
aVIt also really slows down code execution since the debugger actually enters a break state before executing the condition
p30453
aVThe obvious place to put such a breakpoint is in a property setter
p30454
aVWhich is what you'll need to implement this feature in code
p30455
aVYou can do anything you want in that setter, using the Trace class for example
p30456
as(dp30457
g9
V17034
p30458
stp30459
a((dp30460
g2
(lp30461
VTechnically this is possible with an IL rewriter, similar to what Postsharp does
p30462
aVHowever, given that this is a
p30463
aVNET assembly you're talking about that has a strong name, is stored in the GAC and ngen-ed, that isn't likely to ever get past the "technically possible" stage
p30464
as(dp30465
g9
V17034
p30466
stp30467
a((dp30468
g2
(lp30469
VNo fix, you'll have to make your code faster
p30470
aVThese hooks are potentially very detrimental to the user interface responsiveness, Windows makes sure that a misbehaving one gets put in the cellar
p30471
aVEven if the timeout were configurable, it would never be documented
p30472
aVThat would defeat the purpose of having a timeout in the first place
p30473
as(dp30474
g9
V17034
p30475
stp30476
a((dp30477
g2
(lp30478
VThere's no built-in support for generating messages from an HRESULT with that value
p30479
aVThe COM component needs to implement that itself, using the IErrorInfo interface
p30480
aVThe CLR interop support built into
p30481
aVNET already does that automatically, you should never need to help
p30482
aVIt automatically throws an appropriate exception when it sees a COM interface method return a failure code
p30483
aVThe Message property is initialized from IErrorInfo
p30484
aVIf you get nothing decent as a message then the COM server just doesn't supply it
p30485
aVWhich is likely for 0x800a03ec, it is a grab-bag low-level Excel error with many error causes
p30486
aVYou can find plenty of hits for it by googling "excel error 1004"
p30487
as(dp30488
g9
V17034
p30489
stp30490
a((dp30491
g2
(lp30492
VThis is an odd question
p30493
aVYou should only ever consider a custom memory allocator if you try to solve a very specific problem with the one that's built into your CRT
p30494
aVWhich should offer an immediate approach to testing this alternate allocator: see if it solves that problem
p30495
aVIf you are only doing this because it "sounds like a good idea", then don't
p30496
aVIt isn't
p30497
aVThe one built into the CRT is already heavily optimized
p30498
as(dp30499
g9
V17034
p30500
stp30501
a((dp30502
g2
(lp30503
VNo fix for this
p30504
aVBetween a rock and a hard place, you ought to assume that NULL was passed
p30505
aVThere is already a way to enable safe searching with a registry setting
p30506
as(dp30507
g9
V17034
p30508
stp30509
a((dp30510
g2
(lp30511
VThere are many excellent books available
p30512
aVMaybe you are looking for videos
p30513
aVStart at the bottom
p30514
aVYou are not going to find anything at all that will be specific to C++/CLI, just about nobody uses that language to create WF projects
p30515
as(dp30516
g9
V17034
p30517
stp30518
a((dp30519
g2
(lp30520
VYou can use Marshal
p30521
aVGetLastWin32Error() to find out what Windows error caused the exception
p30522
aVFor example:
p30523
as(dp30524
g9
V17034
p30525
stp30526
a((dp30527
g2
(lp30528
VThe compiler is finding another definition of DialogResult, probably somewhere in your code
p30529
aVSpell its name out completely to avoid the ambiguity:
p30530
as(dp30531
g9
V17034
p30532
stp30533
a((dp30534
g2
(lp30535
VThere is another consideration here
p30536
aVRegisterWindowMessage() can fail, you really need to check for that
p30537
aVUsing the 0 it returns when something is wrong is going to be horribly difficult to diagnose otherwise
p30538
aVThat knocks initializing it directly in the readonly declaration out
p30539
aVYou could use a static constructor instead
p30540
aVProblem with that is that the exception message will be buried in an InnerException
p30541
aVKinda okay perhaps since failure will be rare
p30542
aVThe best solution is a static property getter that lazily calls the API:
p30543
aVUse well-known locking patterns if this might be called from different threads
p30544
as(dp30545
g9
V17034
p30546
stp30547
a((dp30548
g2
(lp30549
VWhy is this a problem
p30550
aVSoundPlayer doesn't support playing more than one sound at the same time anyway
p30551
aVMove it to class scope, override OnFormClosing event, problem solved
p30552
as(dp30553
g9
V17034
p30554
stp30555
a((dp30556
g2
(lp30557
VIt is well supported by
p30558
aVNET on tablet PCs
p30559
aVTake a look at the Microsoft
p30560
aVInk namespace
p30561
as(dp30562
g9
V17034
p30563
stp30564
a((dp30565
g2
(lp30566
VNo can do, you've got no way to find out what DLLs the COM server might be using
p30567
aVThere isn't anything like Assembly
p30568
aVGetReferencedAssemblies() in unmanaged code
p30569
aVProcess
p30570
aVModules is about as close as you can get but there's no way to find out that the module you'll iterate was actually associated with the server instead of being loaded by, for example, OpenFileDialog or some obscure virus scanner crap
p30571
aVIf you know the DLL names and where they are located then you can use the FileVersionInfo class to obtain their unmanaged version resource info
p30572
as(dp30573
g9
V17034
p30574
stp30575
a((dp30576
g2
(lp30577
VThe CLR will always look in the GAC first
p30578
aVDon't hesitate to use gacutil
p30579
aVexe /u to remove them
p30580
aVHacking the [AssemblyVersion] would work too so that the GAC copy won't be a match
p30581
as(dp30582
g9
V17034
p30583
stp30584
a((dp30585
g2
(lp30586
VYou'll probably want a dedicated thread that handles the communications
p30587
aVYou'll need a Queue on which the client code can push a message, protect it with a ReaderWriterLockSlim
p30588
aVNo need for the DataReceived event, just call SerialPort
p30589
aVRead() directly
p30590
aVDetect timeouts with the ReadTimeout property
p30591
aVIf you get responses that need to go back to the client code then use an event
p30592
aVWatch out designing the protocol, it isn't that easy to get right
p30593
aVYou'll protect against loss of bytes with your scheme, but it is just as likely for the ACK to be lost
p30594
aVThe microcontroller will see the same command twice
p30595
aVNow you need a "message number" to suppress duplicates and a way for both ends to synchronize them
p30596
aVTake a look at RFC 916
p30597
as(dp30598
g9
V17034
p30599
stp30600
a((dp30601
g2
(lp30602
VWindows puts up a wall between processes so they cannot directly access each other's memory without going through privileged debug-like API functions like ReadProcessMemory
p30603
aVThis is what keeps the operating system stable and secure
p30604
aVBut spells doom for what you are trying to accomplish
p30605
aVYou'll need to use a file
p30606
aVIt won't be much slower than direct memory access, the file system cache takes care of that
p30607
as(dp30608
g9
V17034
p30609
stp30610
a((dp30611
g2
(lp30612
VThe
p30613
aVNET framework tries to avoid big system configuration changes from destabilizing programs
p30614
aVThis feature covers dates, times and culture info
p30615
aVIt does so by lazily retrieving the settings and caching them so they'll always return the same value
p30616
aVYou can reset that cache, call CultureInfo
p30617
aVClearCachedData() and TimeZoneInfo
p30618
aVClearCachedData()
p30619
aVYou could do this, for example, by writing an event handler for SystemEvents
p30620
aVUserPreferenceChanged
p30621
aVWhether you should do so is a bit questionable
p30622
aVIt doesn't require a reboot, just restarting the app is enough
p30623
aVFwiw: the reason DateTimePicker works differently is because it is a native Windows control
p30624
aVIt doesn't do any caching like
p30625
aVNET does
p30626
as(dp30627
g9
V17034
p30628
stp30629
a((dp30630
g2
(lp30631
VI doubt it is message handling, the message loop never sees the WM_KEYDOWN message
p30632
aVAfter trying various things unsuccessfully, I can only guess at Windows thinking your app is incompatible somehow
p30633
aVUsing SetWindowsHookEx() in your program for example
p30634
as(dp30635
g9
V17034
p30636
stp30637
a((dp30638
g2
(lp30639
VThis shows up when you press F1 in the Framework and References dialog:
p30640
aVBy default for new projects, the targeted framework is set to
p30641
aVNET Framework 4
p30642
aVThe IDE does not support modifying the targeted framework, but you can change it manually
p30643
aVIn the project file (
p30644
aVvcxproj), the default targeted framework is represented by the v4
p30645
aV0 property element
p30646
aVTo change the targeted framework, unload the project, use a text editor to open the project file, and then change the value of the property element from v4
p30647
aV0 to another version that is installed on your server
p30648
aVFor example, if you specify v3
p30649
aV5, which represents the
p30650
aVNET Framework v3
p30651
aV5, Visual Studio 2008 SP1 must be installed
p30652
aVSave and close the file, reload the project, and verify that the targeted framework is displayed in the property page
p30653
aVThat's not terribly accurate on converted projects, you'll have to add the  element yourself
p30654
aVPut it in the PropertyGroup labeled "Globals":
p30655
as(dp30656
g9
V17034
p30657
stp30658
a((dp30659
g2
(lp30660
VThe CLR provides a pretty strong guarantee for the execution of static constructors, it promises to call them only once and before any method in the class can run
p30661
aVThat guarantee is fairly tricky to implement when there are multiple threads using the class
p30662
aVTaking a peek at the CLR source code for SSCLI20, I see a fairly large chunk of code dedicated to providing this guarantee
p30663
aVIt maintains a list of running static constructors, protected by a global lock
p30664
aVOnce it gets an entry in that list, it switches to a class specific lock which ensures no two threads can be running the constructor
p30665
aVDouble-checked locking on a status bit that indicates that the constructor was already run
p30666
aVLots of inscrutable code that provides exception guarantees
p30667
aVWell, this code doesn't come for free
p30668
aVAdd it to the execution time for the cctor itself and you're looking at some overhead
p30669
aVAs always, don't let this cramp your style, this guarantee is also a very nice one that you wouldn't want to provide yourself
p30670
aVAnd measure before you fix
p30671
as(dp30672
g9
V17034
p30673
stp30674
a((dp30675
g2
(lp30676
VYou can P/Invoke SHAppBarMessage() to create a task bar
p30677
aVThe APPBARDATA
p30678
aVhWnd you'll need could simply be the Handle of a Form class
p30679
aVAnything goes as far as what you display
p30680
aVGetting the notifications you'll need to make the task bar display active windows is going to be a whole lot more difficult
p30681
aVYou'll need to use the global WH_SHELL hook, set by SetWindowsHookEx() to receive the notifications you'll need
p30682
aVYou cannot set this hook in C#, it requires an unmanaged DLL that you can inject into a process
p30683
aVYou'll find crucial help in this project
p30684
aVGetting the Windows taskbar to not do its normal job is going to be impossible unless you somehow find the undocumented information you'll need
p30685
aVMicrosoft doesn't document this for a good reason, the taskbar is an important part of the way they innovate on the Windows look-and-feel
p30686
aVQuite visible in Win7
p30687
aVThey don't want any code to take a dependency on this, they'd have a near-impossible job of keeping the next version of Windows compatible
p30688
aVI'd have to recommend you completely disable the Windows taskbar and replace it by your own
p30689
as(dp30690
g9
V17034
p30691
stp30692
a((dp30693
g2
(lp30694
VThis kind of code just cannot work reliably on a multi-tasking operating system
p30695
aVAnother thread in another process might pre-empt yours and claim the file name you are hoping to create
p30696
aVThis is otherwise easy enough to work around, just name your own files instead of relying on Windows doing it for you
p30697
aVDo so in the AppData folder so you'll minimize the risk of another process messing it up
p30698
as(dp30699
g9
V17034
p30700
stp30701
a((dp30702
g2
(lp30703
VYou'd have to dig through the msbuild
p30704
aVtarget files to find out what build rule creates this folder
p30705
aVYou might get a hint from looking at the build log if you switch it to diagnostic
p30706
aVTools + Options, Project and Solutions, Build and Run
p30707
aVA more pragmatic approach would be to just delete the folders in a post build event
p30708
aVLike:
p30709
aVEven more pragmatic is to not worry about it
p30710
as(dp30711
g9
V17034
p30712
stp30713
a((dp30714
g2
(lp30715
VYou'd need a Windows API hooking library that can call a managed code callback
p30716
aVEasyhook is one such library
p30717
aVBeware that you might out that you haven't gained anything after you're done, the file system cache already provides direct memory access to file data
p30718
as(dp30719
g9
V17034
p30720
stp30721
a((dp30722
g2
(lp30723
VIt is technically possible
p30724
aVYou'd have to host the CLR yourself so you can call the ICLRRuntimeInfo::BindAsLegacyV2Runtime() method before you create the primary AppDomain
p30725
ag3471
aVconfig file would normally be a much lower pain point unless you are already hosting
p30726
as(dp30727
g9
V17034
p30728
stp30729
a((dp30730
g2
(lp30731
VNo, a string resource is not needed, you can also set TOOLINFO
p30732
aVlpszText to a pointer to a regular string
p30733
aVConsider your usage, you probably want to use TTM_TRACKACTIVATE and TTM_TRACKPOSITION
p30734
aVBeware that this isn't really appropriate use of tool tips
p30735
aVYou'll fight the timeout
p30736
aVOnce it trips, you can't get the tip back
p30737
as(dp30738
g9
V17034
p30739
stp30740
a((dp30741
g2
(lp30742
VThis is a common mishap when you mix and match code that was built with different versions of the CRT header files
p30743
aVLots of changes between 2003 and 2008
p30744
aVSTL iterator debugging for example
p30745
aVThe RTC feature (Run-Time Error Checks) would be another, that's the source of the 0xcccccccc value you see
p30746
aVIt means "uninitialized variable"
p30747
aVYou see this because the memory layout of the struct or class is not the same
p30748
aVYou'll have to rebuild those libraries and make sure they are built with the same compiler settings
p30749
aVAlso be sure not to mix debug and release build versions
p30750
as(dp30751
g9
V17034
p30752
stp30753
a((dp30754
g2
(lp30755
VYou could use the STL/CLR library if you really prefer using STL collections
p30756
aVIt isn't exactly popular, this web page shows you why
p30757
aVUse
p30758
as(dp30759
g9
V17034
p30760
stp30761
a((dp30762
g2
(lp30763
VThe standard COM approach is to subscribe to an event that's raised by the COM server
p30764
aVUse can use the event keyword in C#, CLR interop automatically implements the COM glue that's needed
p30765
aVUse the IConnectionPoint interface in your C++ code
p30766
aVBackgrounder is here
p30767
as(dp30768
g9
V17034
p30769
stp30770
a((dp30771
g2
(lp30772
VWell, sure you'll reference the imports of that library
p30773
aVHard to write a C++ program without using the new or delete operator
p30774
aVDealing with 3rd party software that thinks it needs to override the CRT version of those operators is hard enough, impossible when it won't allow you to call them until it thinks the time is right
p30775
aVAbandon all hope or seek help from the vendor
p30776
as(dp30777
g9
V17034
p30778
stp30779
a((dp30780
g2
(lp30781
VYou can't make it faster, it is inherently an O(n) algorithm
p30782
as(dp30783
g9
V17034
p30784
stp30785
a((dp30786
g2
(lp30787
VUse SetWindowsHookEx()
p30788
aVJust eliminating keystrokes can be done with a simple WH_KEYBOARD_LL hook
p30789
aVIt is not a global hook so is easy to get right
p30790
aVGoogles very well too
p30791
as(dp30792
g9
V17034
p30793
stp30794
a((dp30795
g2
(lp30796
VYou do not want a hash
p30797
aVHashing by design allows for collisions
p30798
aVThere is no possible hashing function for the kind of strings you work with that won't have collisions
p30799
aVYou need to build a persistent mapping table to convert the string to a number
p30800
aVLogically similar to a
p30801
aVThe first string you'll add gets number 0
p30802
aVWhen you need to map, look up the string and return its associate number
p30803
aVIf it is not present then add the string and simply assign it a number equal to the count
p30804
aVMaking this mapping table persistent is what you'll need to think about
p30805
aVTrivially done with a dbase of course
p30806
as(dp30807
g9
V17034
p30808
stp30809
a((dp30810
g2
(lp30811
VThe HRESULT you get would be crucial to diagnose this
p30812
aVForced to guess: did you run Regasm
p30813
aVexe on that machine
p30814
aVRequired to make the necessary registry entries so COM can find the server
p30815
aVIt is automatic when you build in the IDE
p30816
as(dp30817
g9
V17034
p30818
stp30819
a((dp30820
g2
(lp30821
VYou can't get this done with MouseEnter/Leave events
p30822
aVThe smaller problem is that the form's Leave event may never fire if a control is close to the edge
p30823
aVThe bigger problem is that it will fire when the cursor moves into the non-client area (border, caption), you don't want to fade the form when the user tries to close or resize the window
p30824
aVThe crude but effective solution is to use a timer to check where the mouse is located:
p30825
as(dp30826
g9
V17034
p30827
stp30828
a((dp30829
g2
(lp30830
VTLP is not designed to be scrollable
p30831
aVYou'll want a FlowLayoutPanel
p30832
aVBeware that you'll usually end up with a rather large number of windows which will make your program very slow
p30833
aVPainting becomes noticeably laggy when you get more than about 50 controls in a form
p30834
aVThe best solution is a control that can display multiple items but only needs a single Window handle
p30835
aVListBox, ListView with View = Details, DataGridView are good examples of controls that can do this
p30836
aVThey also allow custom painting to tweak their view so you can get it just the way you want it
p30837
as(dp30838
g9
V17034
p30839
stp30840
a((dp30841
g2
(lp30842
VThat's possible, you'll need to use the PrivateFontCollection
p30843
aVAddMemoryFont() method
p30844
aVFor example, I added a font file named "test
p30845
aVttf" as a resource and used it like this:
p30846
aVThe memory management is a tricky btw, the MSDN docs say nothing about how long the IntPtr should remain valid
p30847
aVI just assume the font pointer needed to remain valid for the life of the app, never been disappointed
p30848
as(dp30849
g9
V17034
p30850
stp30851
a((dp30852
g2
(lp30853
VNormal COM apartment threading rules are observed
p30854
aVIf the object was created by the client in an STA apartment then your client thread need to use a marshaled interface pointer or it gets RPC_E_WRONG_THREAD
p30855
aVThe actual method call will execute on the server in its STA thread, it needs to pump a message loop for that to work
p30856
aVExecution is serialized, no locking should be needed
p30857
aVIf it lives in the MTA apartment then the method call will execute on an arbitrary RPC worker thread
p30858
aVAnd you'll need to take the usual threading precautions
p30859
as(dp30860
g9
V17034
p30861
stp30862
a((dp30863
g2
(lp30864
VWhen I use Ildasm
p30865
aVexe and look at the IL with Show Bytes turned on I see this:
p30866
aVThe token values in your dump are not the same, you seem to have a much larger program
p30867
aVBut the IL in your dump starts at offset 1, not 12
p30868
aVNot sure why it is off
p30869
as(dp30870
g9
V17034
p30871
stp30872
a((dp30873
g2
(lp30874
VI always like the idea of the Gremlins test tool, used on Palm handhelds
p30875
aVIt generated random tap events to flush out UI programming bugs
p30876
aVYou could do the same in your app, generating millions of mouse down and up events at random locations
p30877
aVYou'll need to P/Invoke PostMessage() and use Control
p30878
aVGetChildAtPoint() to generate the window handle for the WM_LBUTTONDOWN/UP messages
p30879
aVApplication
p30880
aVDoEvents() in your test loop to get the event handlers to run
p30881
as(dp30882
g9
V17034
p30883
stp30884
a((dp30885
g2
(lp30886
VI don't have a very solid explanation for the exact error message you are getting
p30887
aVBut disabling redirection is going to mess up the
p30888
aVNET framework
p30889
aVBy default, Process
p30890
aVStart() P/Invokes the ShellExecuteEx() API function to start the process
p30891
aVThis function lives in shell32
p30892
aVdll, a DLL that might have to be loaded if that wasn't previously done
p30893
aVYou'll get the wrong one when you disable redirection
p30894
aVA workaround for that is to set ProcessStartInfo
p30895
aVUseShellExecute to false
p30896
aVYou don't need it here
p30897
aVClearly, disabling redirection is a risky approach with side-effects you cannot really predict
p30898
aVThere are lots of DLLs that get demand-loaded
p30899
aVA very small helper EXE that you compile with Platform Target = Any CPU can solve your problem
p30900
as(dp30901
g9
V17034
p30902
stp30903
a((dp30904
g2
(lp30905
VThese are definitely the worst kind of hardware exceptions that you'd ever could encounter in a Windows program
p30906
aVThere is absolutely no reason that something as simple as a serial port sniffer should ever throw exceptions like that, let alone catch them and handle them
p30907
aVStill, it does and there's nothing you can do about it
p30908
aVYou can only hope and pray that this doesn't byte you in the ass some day
p30909
aVPersonally, that component would quickly end up on my thrash heap
p30910
aVThe #import statement auto-generates code from the COM type library
p30911
aVIt generates a
p30912
aVtlh file with declarations and a
p30913
aVtli file with COM method wrappers
p30914
aVThe
p30915
aVtlh file contains smart pointers (xxxxPtr) to make instantiating the COM object and calling its methods easy
p30916
aVThat's why "Goto Definition" takes you to that file
p30917
as(dp30918
g9
V17034
p30919
stp30920
a((dp30921
g2
(lp30922
VYes, you cannot get access to the
p30923
aVlnk file in that folder by default
p30924
aVYou are creating a COM object that allows you to modify the
p30925
aVlnk properties
p30926
aVAnd that requires an administrator level account with UAC turned off
p30927
aVYes, you can fix that with a manifest
p30928
as(dp30929
g9
V17034
p30930
stp30931
a((dp30932
g2
(lp30933
VAvoid making this complicated
p30934
aVA Visual Studio solution can contain as many projects as you need to build all dependencies
p30935
aVBuild + Clean will delete all binaries, Build + Build will rebuild them
p30936
aVJust make sure that Build + Clean deletes every
p30937
aVlib that you've got a dependency on
p30938
as(dp30939
g9
V17034
p30940
stp30941
a((dp30942
g2
(lp30943
VUse System
p30944
aVIO
p30945
aVFile
p30946
aVReadAllText()
p30947
as(dp30948
g9
V17034
p30949
stp30950
a((dp30951
g2
(lp30952
VActiveX controls went the way of the dodo
p30953
aVAny
p30954
aVNET component vendor sells a library that includes support for skinning
p30955
aVCheck out Telerik or DevExpress for example
p30956
as(dp30957
g9
V17034
p30958
stp30959
a((dp30960
g2
(lp30961
VThis looks like a typical honeypot giveaway, designed to commit you to the retail edition of their obfuscator
p30962
aVIt's a tough business, few play this game better than Preemptive
p30963
aVYes, using attributes is not going work for a library
p30964
aVThe only possible candidate would be a finalizer
p30965
aVAnd you do not want your code to contact some website while the finalizer thread is running
p30966
aVTake a look at the retail edition of their product
p30967
aVI bet it has a way to invoke the methods that are normally injected by their obfuscator directly
p30968
aVThe class constructor is an obvious candidate for "Setup"
p30969
aVAn event handler for the AppDomain
p30970
aVProcessExit event could be a possible location for the "Teardown" call
p30971
aVThis also might avoid having to run the obfuscator at all, not undesirable in an open source project
p30972
as(dp30973
g9
V17034
p30974
stp30975
a((dp30976
g2
(lp30977
VIt is a fuzzy term, it means "configuring the build tools to generate a binary image that's compatible with the managed runtime"
p30978
aVAn executable that can run managed code follows the standard PE32 file format
p30979
aVFamiliar to you as EXE and DLL files
p30980
aVSuch a binary image is called "assembly" in
p30981
aVNET speak
p30982
aVIts format is well documented in this Ecma standard document
p30983
aVMost build tools in common use are very specific to creating managed assemblies
p30984
aVLike csc
p30985
aVexe and vbc
p30986
aVexe, respectively the C# and VB
p30987
aVNET compilers
p30988
aVSome tools can generate either and must be run with the right command line options to get the desired end result
p30989
aVLike cl
p30990
aVexe and link
p30991
aVexe, the compiler and linker for C/C++ with built-in support for the C++/CLI language
p30992
aVThey can also create assemblies that contain a mix of managed IL and machine code
p30993
aVEspecially the latter two tools are not that easy to use to target the managed runtime
p30994
aVIt is the job of the IDE and the build system incorporated with Visual Studio to make it easy
p30995
as(dp30996
g9
V17034
p30997
stp30998
a((dp30999
g2
(lp31000
VYes, Ctrl+Z was the EOF file character for text files in ancient operating systems
p31001
aVIt is a control character that really shouldn't be present in a text file, you can't meaningful translate it
p31002
aVOpenmode::binary is about all you can do if that's required
p31003
as(dp31004
g9
V17034
p31005
stp31006
a((dp31007
g2
(lp31008
VThe Icon(string) constructor looks for a file on disk for the icon file, it doesn't look in a resource
p31009
aVConsider using the Icon(Stream) constructor instead
p31010
aVOr use Project + Properties, Resource tab, arrow on Add Resource button, Add Existing File
p31011
aVSelect your
p31012
aVico file
p31013
aVThen you'd use it like this:
p31014
as(dp31015
g9
V17034
p31016
stp31017
a((dp31018
g2
(lp31019
VBrowsing the source code, I see Page
p31020
aVxaml with at the bottom a StackPanel
p31021
aVSwap the MediaElement and the Grid inside it
p31022
as(dp31023
g9
V17034
p31024
stp31025
a((dp31026
g2
(lp31027
VIt would be wise to store your projects in a common folder so that you can use relative paths
p31028
aVThe #import directive also searches files in the same folders where it looks for #include files
p31029
aVIn the IDE, you can add them with Project + Properties, C/C++, General, Additional Include Directories
p31030
as(dp31031
g9
V17034
p31032
stp31033
a((dp31034
g2
(lp31035
VYou've probably found sample code that was originally written in Visual Basic
p31036
aVThe WParam argument for SendMessage() is documented to be a BOOL
p31037
aVIt should be either FALSE (0) or TRUE (1)
p31038
aVA quirk of VB6 is that its boolean TRUE value is -1
p31039
aVThe reason is a bit obscure and related to the way its AND and OR operators work
p31040
aVYour current code works by accident, the Windows code that interprets the message simply treats any non-zero value as "TRUE"
p31041
aVThere is a bigger problem though, your SendMessage() declaration is wrong
p31042
aVThe WParam and LParam arguments are probably declared as "int", a 32-bit value
p31043
aVOn 64-bit operating systems they are however a 64-bit value
p31044
aVOn such an operating system your SendMessage() call will fail badly
p31045
aVThere's also some odds that you are already on a 64-bit operating system and have these arguments declared as Long, the way they were declared in VB6
p31046
aVIn which case your code will fail on a 32-bit operating system
p31047
aVThe proper declaration for SendMessage:
p31048
aVAnd the proper way to send the message:
p31049
aVThat will work correctly on both 32-bit and 64-bit operating systems
p31050
as(dp31051
g9
V17034
p31052
stp31053
a((dp31054
g2
(lp31055
VYou'd normally handle this with the [StructLayout(LayoutKind
p31056
aVExplicit)] attribute on a structure declaration
p31057
aVWith separate struct declarations for the union members, in this case
p31058
aVWhich would almost work if it wasn't for the SN member
p31059
aVThe CLR won't allow you to overlay a string or array member, it would allow unrestricted access to the garbage collected heap
p31060
aVIt's a mutt of a function, manual marshaling is appropriate here
p31061
as(dp31062
g9
V17034
p31063
stp31064
a((dp31065
g2
(lp31066
VThis is normal
p31067
aVThere's an exception handler built into the Application
p31068
aVRun() method
p31069
aVIt is disabled when you debug in order to make debugging exceptions easier
p31070
aVWithout a debugger, the exception handler will display the ThreadExceptionDialog
p31071
aVAdd this statement at the top of your Main method to disable this exception handler:
p31072
as(dp31073
g9
V17034
p31074
stp31075
a((dp31076
g2
(lp31077
VThe Control
p31078
aVInvoke() method returns the value of the invoked method
p31079
aVWhich makes it easy:
p31080
aVOr a bit more explicit:
p31081
as(dp31082
g9
V17034
p31083
stp31084
a((dp31085
g2
(lp31086
VYes, implement the listview's Resize event handler and calculate the space left for the column
p31087
aVFor example:
p31088
as(dp31089
g9
V17034
p31090
stp31091
a((dp31092
g2
(lp31093
VTry running a WMI query on the Win32_SerialPort class
p31094
aVDownload WmiCodeCreator to experiment and auto-generate the C# code
p31095
as(dp31096
g9
V17034
p31097
stp31098
a((dp31099
g2
(lp31100
VThere isn't
p31101
aVThe last hex number is the hash code of the AppDomain that owns the window
p31102
aVThe digit before that starts at 0 but increases if other windows were created with the same class name
p31103
aVThe number before that is the value of the class style
p31104
aVClearly you can only guess this name correctly if you have insider knowledge of variables whose value is only accessible inside the process
p31105
aVNor can you change it
p31106
aVYou'd override the window's CreateParams property but setting the ClassName property will make Windows Forms look for an existing window class with that name
p31107
aVAnd fail to find it, bombing your program
p31108
aVNor can you override it
p31109
aVThe logic is built into a private method of the NativeWindow class
p31110
aVClearly this was not designed to make it easy to use FindWindowEx()
p31111
aVAs long as changing the source code is an option, there are far better ways to setup an inter-process communication beyond using Windows messages
p31112
aVNamed pipes, sockets, Remoting, WCF
p31113
as(dp31114
g9
V17034
p31115
stp31116
a((dp31117
g2
(lp31118
VDo you call InitCommonControlsEx
p31119
aVDetails are here
p31120
as(dp31121
g9
V17034
p31122
stp31123
a((dp31124
g2
(lp31125
VAn ApplicationSetting binding doesn't allow applying any expression to the value
p31126
aVThe simple solution is to derive your own control from Button
p31127
aVFor example:
p31128
as(dp31129
g9
V17034
p31130
stp31131
a((dp31132
g2
(lp31133
VYes, the _mm_max_epu8() intrinsic does what you want
p31134
aVChews through 16 bytes at a time
p31135
aVThe pain-point is the arrays
p31136
aVSSE2 instructions require their arguments to be aligned at 16-byte addresses
p31137
aVYou cannot get that out of the garbage collected heap, it only promises 4-byte alignment
p31138
aVEven if you trick it by calculating an offset in the array that's 16-byte aligned then you'll lose when the garbage collector kicks in and moves the array
p31139
aVYou'll have to declare the arrays in the C/C++ code, using the __declspec(align(#)) declarator
p31140
aVNow you need to copy your managed arrays into those unmanaged ones
p31141
aVAnd the results back
p31142
aVWhether you are still ahead depends on details not easily seen in your question
p31143
as(dp31144
g9
V17034
p31145
stp31146
a((dp31147
g2
(lp31148
VBut why I should write code like this
p31149
aVIndeed
p31150
aVAnd why would the compiler write code like that
p31151
aVYou've removed any chance it might have had to guess that the loop could be optimized
p31152
aVBtw, you seem to interpret the IL incorrectly, it is rebinding to obtain IEnumerable
p31153
aVCurrent, the MoveNext() call is direct and GetEnumerator() is called only once
p31154
aVWhich I think is appropriate, the next element might or might not cast to an int without problems
p31155
aVIt could be a collection of various types, each with their own binder
p31156
as(dp31157
g9
V17034
p31158
stp31159
a((dp31160
g2
(lp31161
VHmya, watch out: one IDE's flaw is another IDE's feature
p31162
aVVisual Studio's syntax coloring is purely based on lexical analysis
p31163
aVFast, simple and always accurate, no matter how completely borked the code is while you are editing it
p31164
aVTo get the Eclipse-like coloring, the editor needs to be able to parse the code so it can classify identifiers
p31165
aVThat's a much harder problem
p31166
aVMore to the point, there are changes in VS2010 that emphasize doing things exactly the opposite way
p31167
aVTo get accurate syntax coloring your preferred way, you'd be likely to focus on getting the class "super-structure" done first
p31168
aVExactly the opposite of what VS2010 is doing
p31169
aVIt lets you skip the boring details and type code
p31170
aVAnd offers refactorings that lets you automatically create the field/property/method declarations from that code
p31171
aVMicrosoft spends a lot of money researching the most effective use of their software
p31172
aVYou're liable to cut yourself off from the innovations they came up with if you try too hard getting things back the way you always did it before
p31173
as(dp31174
g9
V17034
p31175
stp31176
a((dp31177
g2
(lp31178
VThe resolution of a multimedia timer is much better than one second
p31179
aVIt can go down to 1 millisecond when you call timeBeginPeriod(1) first
p31180
aVThe timer will automatically adjust its interval for the next call when the callback is delivered late
p31181
aVWhich is inevitable on a multi-tasking operating system, there is always some kind of kernel thread with a higher priority than yours that will delay the callback
p31182
aVWhile it will work pretty well on average, worst case latency is in the order of hundreds of milliseconds
p31183
aVClearly, your requirements cannot be met by Windows by a long shot
p31184
aVYou'll need some kind of microcontroller to supply that kind of execution guarantee
p31185
as(dp31186
g9
V17034
p31187
stp31188
a((dp31189
g2
(lp31190
VThe type library only needs to be deployed if you want your client to use the component themselves when they write their own code using your COM server
p31191
aVThat's unlikely given your description of their skills
p31192
aVIf required anyway, you are better off simply deploying the
p31193
aVtlb yourself instead of auto-generating it during install
p31194
aVYour client won't have Regasm
p31195
aVexe on their machine, it is only available in the Windows SDK
p31196
aVNevertheless, registering ComVisible components is a standard capability of MSI
p31197
aVYou can create your own installer that registers the component with a Visual Studio Setup project
p31198
aVSet the Register property to "vsdrpCOM"
p31199
as(dp31200
g9
V17034
p31201
stp31202
a((dp31203
g2
(lp31204
VAll the shell dialogs, including FolderBrowserDialog, require the COM apartment for the thread to be set to STA
p31205
aVYou are probably missing the Thread
p31206
aVSetApartmentState() call:
p31207
aVBeware that you cannot set the owner of the dialog, it easily gets lost behind a window of another application
p31208
aVWhich makes showing forms or dialogs on a worker thread less than a good idea
p31209
as(dp31210
g9
V17034
p31211
stp31212
a((dp31213
g2
(lp31214
VYour question isn't very clear without a code snippet
p31215
aVYou are however doing battle with the Windows MDI implementation
p31216
aVOne thing it doesn't support is hiding a child window, it can only be minimized at best
p31217
aVWindows Forms implements the Visible property by destroying the Window handle, recreating it when the Visible property is set to True again
p31218
aVThat new instance of the window won't be maximized
p31219
aVIt also doesn't support switching the focus to a child window when the current one is maximized
p31220
aVWF's workaround for that is to force the active child window back to the Normal state
p31221
aVThe MDI model is simply not very suitable for displaying child windows in the maximized state
p31222
aVTo get a tabbed interface, use a TabControl and display UserControls on its tab pages
p31223
as(dp31224
g9
V17034
p31225
stp31226
a((dp31227
g2
(lp31228
VNo, auto-increment on the [AssemblyVersion] is supported in VS2005 and up
p31229
aVMake it look like this:
p31230
aVI have little use for this capability myself
p31231
aV[AssemblyVersion] describes the outward visible public interface for an assembly
p31232
aVThat doesn't change when I simply rebuild the assembly
p31233
aV[AssemblyFileVersion] is appropriate for tracking build numbers
p31234
aVSadly, it does not have the auto-increment capability
p31235
aVNote how the
p31236
aVNET assemblies use that version numbering strategy as well
p31237
aVAlso note this feedback item
p31238
as(dp31239
g9
V17034
p31240
stp31241
a((dp31242
g2
(lp31243
VIBM's policy towards providing updates is spelled out well in this forum thread
p31244
as(dp31245
g9
V17034
p31246
stp31247
a((dp31248
g2
(lp31249
VYou are mixing types and objects in your question which makes it hard to answer
p31250
aVCode in an AD has no trouble using types that are also used in other ADs, it simply loads the assembly
p31251
aVBut an AD has its own garbage collected heap, you cannot directly reference objects that live in another AD
p31252
aVThey need to be serialized across the AD boundary
p31253
aVYes, Remoting across an IpcChannel will do so
p31254
as(dp31255
g9
V17034
p31256
stp31257
a((dp31258
g2
(lp31259
VWe are the victim of a crummy exception message
p31260
aVLoading assemblies with Assembly
p31261
aVLoad(byte[]) that contain unmanaged code in not supported
p31262
aVThis is the subject of this feedback item
p31263
aVUPDATE: the linked feedback item is gone, deleted as part of the cleanup at VS2012 release time
p31264
aVThe only part of it could still recover is this fragment, copied from another web page:
p31265
aV\u201c[\u2026] we only allow ILOnly images to be loaded [\u2026] since anything else is not safe\u201d--
p31266
as(dp31267
g9
V17034
p31268
stp31269
a((dp31270
g2
(lp31271
VYour program would be started with a different Environment
p31272
aVCurrentDirectory
p31273
aVAlways make sure you load files with an absolute path name (i
p31274
ag9581
aVdon't use Image
p31275
aVFromFile("blah
p31276
aVjpg"))
p31277
aVTo get the absolute path to a file that's stored in the same directory as your EXE, you could use Application
p31278
aVStartupPath for example
p31279
aVOr Assembly
p31280
aVGetEntryAssembly()
p31281
aVLocation if you don't use Windows Forms
p31282
as(dp31283
g9
V17034
p31284
stp31285
a((dp31286
g2
(lp31287
VThe Control class has the Disposed event
p31288
aVYou could wire that up to detect that the control got disposed
p31289
aVIt is more reliable than the ControlAdded/Removed events since adding or removing a control doesn't automatically means it is being disposed
p31290
as(dp31291
g9
V17034
p31292
stp31293
a((dp31294
g2
(lp31295
VIt is a hangover from a SQL Server project when
p31296
aVNET 2
p31297
aV0 was being designed
p31298
aVThey pressed the CLR team really hard to break the link between the
p31299
aVNET Thread class and an operating system thread
p31300
aVThey had reason to at the time, SQL Server supports "light-weight" threads that are implemented as fibers
p31301
aVA fiber is the Windows implementation of a "co-routine", something that was popular about 15 years ago
p31302
aVThe project was a bust, they couldn't get it reliable enough
p31303
aVSadly, we are stuck with no easy way to map a Thread to a ProcessThread
p31304
aVQuite a loss
p31305
aVMaybe somebody, some day, will take advantage of the uncoupling, I haven't seen it done yet
p31306
aVThe only possible mapping you've got available now is to P/Invoke GetCurrentThreadId() inside the thread itself
p31307
aVThat returns a TID that you can match to a ProcessThread
p31308
aVId
p31309
as(dp31310
g9
V17034
p31311
stp31312
a((dp31313
g2
(lp31314
VIt's not the way it works
p31315
aVIf you give the library the option to either link the CRT statically or use the DLL version of the CRT, you'll have to have that same option on the EXE project as well
p31316
aVMixing the options will typically produce a raft of linker errors
p31317
aVEven if you manage to avoid them, disaster will strike at runtime when the functions from the
p31318
aVlib use a different memory allocator from the functions in the EXE
p31319
aVUsing the "all of them" approach makes little sense
p31320
aVAs long as you know that you'll only use static libraries and create a monolithic EXE blob then the static version of the CRT makes sense
p31321
aVMakes deploying your program easier
p31322
aVIf you are at all contemplating using DLLs some day then only the DLL version of the CRT makes sense
p31323
as(dp31324
g9
V17034
p31325
stp31326
a((dp31327
g2
(lp31328
VIn most scenarios, it involves a device driver at the operating system kernel level that pretends to implement a hardware device
p31329
aVA very common implementation is a driver that supports VPN
p31330
aVIt looks like a regular network adapter to user code
p31331
aVBut it actually transparently transmits packets across the Internet to a local area network far removed
p31332
aVAsk more questions about it at superuser
p31333
aVcom
p31334
as(dp31335
g9
V17034
p31336
stp31337
a((dp31338
g2
(lp31339
VThere are definitely low-level details they have in common
p31340
aVAn interface is a list of function pointers in both languages
p31341
aVMore commonly implemented in C++ because most compilers already implement virtual functions as a "v-table"
p31342
aVA one-to-one match with a COM dispatch table
p31343
aVWhere they start to diverge is the methods of IUnknown
p31344
aVA COM interface has the AddRef and Release methods to take care of memory managed, using reference counting
p31345
aVA non-issue in C# because the garbage collector take care of it
p31346
aVAnd COM doesn't support inheritance
p31347
aVNot an issue in C#, if you want to obtain an interface pointer then you simply cast the object reference
p31348
aVIt has to be done explicitly in COM with the IUnknown::QueryInterface() method
p31349
aVThere is some support in COM for object re-use, implemented by aggregation
p31350
aVIt is so obtuse that few ever implement it
p31351
as(dp31352
g9
V17034
p31353
stp31354
a((dp31355
g2
(lp31356
VBy far the simplest test is to check the size of an IntPtr:
p31357
aVWhich assumes you build your EXE with the default Platform Target set to "Any CPU"
p31358
aVBeware that this default changed in VS2010
p31359
as(dp31360
g9
V17034
p31361
stp31362
a((dp31363
g2
(lp31364
VThere already is a decent standard for writing registry values as strings to a file
p31365
aVIn Regedit
p31366
aVexe, use File + Export after selecting a key to see what that looks like
p31367
aVDocumentation is available in this KB article
p31368
as(dp31369
g9
V17034
p31370
stp31371
a((dp31372
g2
(lp31373
VA VS Setup project already knows how to register a ComVisible assembly
p31374
aVSet the Register property of the DLL to "vsdrpCOM"
p31375
aVNo additional post-install commands are needed
p31376
as(dp31377
g9
V17034
p31378
stp31379
a((dp31380
g2
(lp31381
VPurging the receive buffer is almost always wrong
p31382
aVSerial port communications are asynchronous by nature, you'll risk deleting good data
p31383
aVOnly if you use a master-slave protocol (the device only ever transmits when queried by the host) would allow purging
p31384
aVBut then, if the receive buffer actually has data to purge then you're ignoring a protocol violation, something you never want to just ignore
p31385
aVReliable serial port communication requires a protocol
p31386
aVA checksum to verify message integrity and ACK/NAK handshaking to recover from data corruption
p31387
aVCheck out the RATP protocol, described in RFC 916
p31388
aVWidely ignored btw but I've used it in the past
p31389
aVIts only weakness is buffered connection attempts
p31390
as(dp31391
g9
V17034
p31392
stp31393
a((dp31394
g2
(lp31395
VDAO is hopelessly antiquated, it doesn't support the engines you listed
p31396
aVOLEDB and ADO are complementary, OLEDB provides the dbase engine interface, ADO is a grab bag of the classes you'll use in your code to program the dbase interface
p31397
aVADO
p31398
aVNET in the
p31399
aVNET framework
p31400
aVFor Access you'd use the classes in the System
p31401
aVData
p31402
aVOleDb namespace, your connection string uses the ACE provider
p31403
aVFor SQL you'd best use the classes in the System
p31404
aVData
p31405
aVSqlClient namespace
p31406
aVVisit connectionstrings
p31407
aVcom for help with configuring the connection strings
p31408
as(dp31409
g9
V17034
p31410
stp31411
a((dp31412
g2
(lp31413
VWorking from the assumption that it is actually RAM you've measured: sure this is entirely normal
p31414
aVYour program is actively addressing virtual memory pages when loading a document, they'll get mapped to RAM
p31415
aVThey'll stay there until another process needs to have pages mapped to RAM
p31416
aVSome operating systems trim the working set pre-emptively, on Windows for example when the app's windows are minimized
p31417
aVIf it is actually virtual memory pages you've measured: that's normal too
p31418
aVAfter you release the memory, the heap blocks are added to the list of free blocks, ready to be used by the next memory allocation
p31419
aVIf releasing the memory happens to free an entire range of pages then the memory manager has an opportunity to unmap that range
p31420
aVIt doesn't happen often and its an implementation detail of your memory manager how aggressively it does so
p31421
as(dp31422
g9
V17034
p31423
stp31424
a((dp31425
g2
(lp31426
VThis is certainly not normal
p31427
aVWindows automatically closes any handles that are left open after the process terminates
p31428
aVThis must be a flaw in your USB device driver, although it is hard to see how it could mess this up
p31429
aVThe ones that emulate serial ports are however notoriously lousy
p31430
aVWell, nothing much you can do but hope for a driver update from the manufacturer
p31431
aVOr a device from another manufacturer
p31432
as(dp31433
g9
V17034
p31434
stp31435
a((dp31436
g2
(lp31437
VThat's pretty odd, GDI+ has nice filters
p31438
aVBe sure to set the Graphics
p31439
aVInterpolationMode property to a high quality setting
p31440
aVLeadTools is one of the leading graphics libraries, ImageMagick if you prefer open source
p31441
as(dp31442
g9
V17034
p31443
stp31444
a((dp31445
g2
(lp31446
VManaged exceptions are implemented using the regular Windows Structured Exception Handling mechanisms
p31447
aVThe exception code is 0xe0434f4d
p31448
aVWindows goes looking for an exception handler that's willing to handle the exception
p31449
aVIf the code has no active try block on the stack, or no catch block is willing to catch the managed exception then the last gasp in managed code is the AppDomain
p31450
aVUnhandledException event
p31451
aVIf that isn't implemented either than exception handling switches to unmanaged handling, an exception filter set with SetUnhandledExceptionFilter gets a shot
p31452
aVFailing that, there is always a default handler provided by Windows
p31453
aVIn normally invokes WER, the Windows Error Reporting program
p31454
aVThat offers the user a dialog to send the exception details to Microsoft
p31455
aVDon't expect anything out of that
p31456
aVBy the time it has progressed beyond AppDomain
p31457
aVUnhandledException all info about the managed exception is lost
p31458
aVNo stack trace, no exception message
p31459
aVJust the exception code, which you already know, and an exception address, which you'll have no use for because code is dynamically generated by the JIT compiler
p31460
aVBe sure to trap the exception in the last gasp stage, write an event handler for AppDomain
p31461
aVUnhandledException
p31462
aVLog the value of e
p31463
aVExcdeptionObject
p31464
aVToString() and kill the program with Environment
p31465
aVExit()
p31466
aVAlso beware the Application
p31467
aVThreadException event in Windows Forms code and Dispatcher
p31468
aVUnhandledException event in WPF code
p31469
aVThey are a back stop for exceptions that are raised while processing events on the UI thread
p31470
as(dp31471
g9
V17034
p31472
stp31473
a((dp31474
g2
(lp31475
VThe problem is with the New constraint
p31476
aVIt only promises a parameter-less constructor, the compiler cannot deduce that the DbObject type parameter may have a constructor that takes a DataRow as an argument
p31477
aVYou could perhaps extend the IDbObject interface with a property that gets/sets a DataRow
p31478
aVA class factory would be helpful
p31479
as(dp31480
g9
V17034
p31481
stp31482
a((dp31483
g2
(lp31484
VScrewing up the garbage collected heap is always a good way:
p31485
as(dp31486
g9
V17034
p31487
stp31488
a((dp31489
g2
(lp31490
VThe CLR won't know what to do with a raw interface pointer and no type info
p31491
aVYou'll need to pass a VARIANT of type VT_DISPATCH
p31492
aVThat will map to a __ComObject on the C# side, late binding is required to make calls on that reference
p31493
as(dp31494
g9
V17034
p31495
stp31496
a((dp31497
g2
(lp31498
VThe day name and month name are not properly abbreviated, they need a period
p31499
aVIf you can massage the string then you could make it work:
p31500
as(dp31501
g9
V17034
p31502
stp31503
a((dp31504
g2
(lp31505
VNot sure what to recommend here
p31506
aVThere is most definitely no memory leak here, the garbage collector releases COM reference counts
p31507
aVCOM objects are not disposable but you can release them early with Marshal
p31508
aVReleaseComObject()
p31509
aVThe trouble with doing this explicitly is that it is normally very hard to track interface references
p31510
aVIn your code snippet for example, calling ReleaseComObject on the icfMgr won't have any effect
p31511
aVThere's a hidden reference through the LocalPolicy member that will keep the interface reference alive
p31512
aVYou'd have to call ReleaseComObject on that hidden reference as well
p31513
aVI would not recommend making this a practice at all
p31514
aVGetting it wrong produces hard to diagnose failure, you're essentially back to the bad old days of explicit memory management
p31515
aVBut it is somewhat manageable in your specific example
p31516
as(dp31517
g9
V17034
p31518
stp31519
a((dp31520
g2
(lp31521
VYes, it is fine
p31522
aVIt is in fact a documented error code, although finding them is never easy
p31523
aVIt is defined in the msdao15
p31524
aVidl Windows SDK file, adErrItemNotFound (error 3265)
p31525
as(dp31526
g9
V17034
p31527
stp31528
a((dp31529
g2
(lp31530
VThe
p31531
aVNET framework defines the KnownColor enum, you could use it to convert a color value to a name
p31532
aVIt won't be a complete solution, it doesn't have "Orange Yellow"
p31533
aVBut many of the common colors are present
p31534
aVFor example:
p31535
aVUsage:
p31536
aVOutput: Yellow
p31537
as(dp31538
g9
V17034
p31539
stp31540
a((dp31541
g2
(lp31542
VNeat trick with the new keyword, that would indeed fix the problem
p31543
aVThe issue here is that COM doesn't support inheritance
p31544
aVIt is merely notational convenience in IDL to make it look like it does
p31545
aVIn reality, an interface v-table must aggregate all the "inherited" base interfaces
p31546
aVIn other words, for the IPersistFolder interface it must replicate the v-table slots for the 3 IUnknown methods and the IPersist::GetClassID method
p31547
aVThe CLR takes care of IUnknown btw
p31548
aVThe v-table that
p31549
aVNET builds is not compatible with this layout, it doesn't replicate the base class method slots
p31550
as(dp31551
g9
V17034
p31552
stp31553
a((dp31554
g2
(lp31555
VCase conversion rules in various Unicode scripts are murderously difficult, it requires large case conversion tables
p31556
aVYou cannot get this right yourself, you'll need a library
p31557
aVICU is one of them
p31558
as(dp31559
g9
V17034
p31560
stp31561
a((dp31562
g2
(lp31563
VYes, the System
p31564
aVNet classes have tracing capability built in
p31565
aVAll you have to do is configure it in your app
p31566
aVexe
p31567
aVconfig file
p31568
aVIt is explained well in this MSDN Library article
p31569
as(dp31570
g9
V17034
p31571
stp31572
a((dp31573
g2
(lp31574
VYes, it is a built-in capability of Parallel
p31575
aVFor()
p31576
aVUse one of the overloads that accepts a ParallelOptions object, set its MaxDegreeOfParallelism property
p31577
aVFor example:
p31578
as(dp31579
g9
V17034
p31580
stp31581
a((dp31582
g2
(lp31583
VThe OpenClipboard() API function, followed by EmptyClipboard() locks the clipboard until CloseClipboard is called
p31584
aVYou should probably pass a window handle of a window in the target process
p31585
aVNo idea if this will actually work
p31586
aVVisit pinvoke
p31587
aVnet for the required declarations
p31588
as(dp31589
g9
V17034
p31590
stp31591
a((dp31592
g2
(lp31593
VA TabControl can do this, works well in design mode
p31594
aVYou just need to hide the tabs at runtime
p31595
aVCheck my code in this thread
p31596
as(dp31597
g9
V17034
p31598
stp31599
a((dp31600
g2
(lp31601
VAwesome problem
p31602
aVYou are using an old version of VS, one that doesn't automatically embed a manifest in the EXE to signal Vista that your program is aware of Vista UAC policies
p31603
aVThat makes it treat your program like a legacy program, it automatically redirects file and registry access to safe locations
p31604
aVThat works pretty well for old programs, except the ones that are intended to update, patch or install programs
p31605
aVThere is no easy way for Vista to see that a program is an installer
p31606
aVOther than, you guessed it, the name of the program
p31607
aVStart by installing the Vista specific service pack for VS2005
p31608
aVYou probably also need to fix what your program is doing and make it UAC compatible
p31609
as(dp31610
g9
V17034
p31611
stp31612
a((dp31613
g2
(lp31614
VYes, CComVariant was designed to be a direct substitute for VARIANT
p31615
aVIt derives from the variant structure and adds no virtual members nor fields (and no virtual destructor) to ensure the memory layout is the same
p31616
aVLots of little helper classes like that in ATL/MFC, like CRect, CPoint etc
p31617
as(dp31618
g9
V17034
p31619
stp31620
a((dp31621
g2
(lp31622
VAny decent memory profiler will show you this information
p31623
aVYou don't really want to mess with the free CLR Profiler, it isn't worth your time, get a decent 3rd party tool
p31624
aVYou'll find them mentioned in this thread
p31625
as(dp31626
g9
V17034
p31627
stp31628
a((dp31629
g2
(lp31630
VPay attention to e
p31631
aVType in your Scroll event handler
p31632
aVIt will be ScrollEventType
p31633
aVEndScroll after the user stops dragging the thumb
p31634
as(dp31635
g9
V17034
p31636
stp31637
a((dp31638
g2
(lp31639
VUsing Marshal
p31640
aVReadInt64() will give you an immediate x 8 speed boost
p31641
aVWatch out for overshooting the Width though, you'll need ReadByte() for the last few pixels in a scan line
p31642
aVWriting this code in C# in a helper assembly is probably the quickest fix, it allows you to use a pointer
p31643
as(dp31644
g9
V17034
p31645
stp31646
a((dp31647
g2
(lp31648
VOlder version of
p31649
aVNET, maybe
p31650
aVYour HMS() function critically depends on the number of digits generated by TimeSpan
p31651
aVToString()
p31652
aVHere's a better way to format it:
p31653
as(dp31654
g9
V17034
p31655
stp31656
a((dp31657
g2
(lp31658
VJust edit the Configuration Properties + NMake + Build Command Line
p31659
aVClick the button with the dots and enter something like this:
p31660
aVRepeat for your 64-bit configuration
p31661
as(dp31662
g9
V17034
p31663
stp31664
a((dp31665
g2
(lp31666
VThis is not a warning you can ignore, it will bomb in 64-bit code
p31667
aVAn unsigned int cannot store a pointer
p31668
aVThere's no magic cast that will make this work
p31669
aVReview your code and rethink storing pointer values in an unsigned int
p31670
aVIt should probably be a void*
p31671
aVIf you  then you can use UINT_PTR
p31672
as(dp31673
g9
V17034
p31674
stp31675
a((dp31676
g2
(lp31677
VThe worker threads are all blocking on the _q
p31678
aVWaitOne() call in DoWork()
p31679
aVCalling the thread's Join() method will deadlock, the threads never exit
p31680
aVYou'll need to add a mechanism to signal to worker thread to exit
p31681
aVA ManualResetEvent, tested with WaitAny in the worker, will get the job done
p31682
aVOne debugging tip: get familiar with the Debug + Windows + Threads window
p31683
aVIt lets you switch between threads and look at their call stacks
p31684
aVYou'd have quickly found this problem by yourself
p31685
as(dp31686
g9
V17034
p31687
stp31688
a((dp31689
g2
(lp31690
VThere was a very recent release to solve x64 problems
p31691
aVGet in touch with Mike Barnett directly if you still have problems (mbarnett at microsoft dot com)
p31692
as(dp31693
g9
V17034
p31694
stp31695
a((dp31696
g2
(lp31697
VHmya, it's rather backwards: you need the attribute in C# so that you can match the structure alignment chosen by a native code compiler
p31698
aVAnd [FieldOffset] is only really needed to deal with unions
p31699
aVBut you can achieve that kind of layout pretty easily by inserting the padding yourself:
p31700
as(dp31701
g9
V17034
p31702
stp31703
a((dp31704
g2
(lp31705
VMurky, I could use a snippet
p31706
aVTell the designer that it shouldn't ever serialize the value of the property:
p31707
as(dp31708
g9
V17034
p31709
stp31710
a((dp31711
g2
(lp31712
VMembers of an interface type are always public
p31713
aVWhich requires their method implementation to be public as well
p31714
aVThis doesn't compile for example:
p31715
aVExplicit interface implementation provides a syntax that allows the method to be private:
p31716
aVA classic use for this is to hide the implementation of a base interface type
p31717
aVIEnumerable<> would be a very good example:
p31718
aVNote how the generic version is accessible, the non-generic version is hidden
p31719
aVThat both discourages its use and avoids a compile error because of a duplicate method
p31720
aVIn your case, implementing Dispose() explicitly is wrong
p31721
aVYou wrote Dispose() to allow the client code to call it, forcing it to cast to IDisposable to make the call doesn't make sense
p31722
aVAlso, calling Dispose() from a finalizer is a code smell
p31723
aVThe standard pattern is to add a protected Dispose(bool disposing) method to your class
p31724
as(dp31725
g9
V17034
p31726
stp31727
a((dp31728
g2
(lp31729
VAs clearly indicated by the error message, you got the calling convention wrong, you dropped NTAPI
p31730
aVIt should be:
p31731
aVProperly initializing myAttributes would normally be important
p31732
aVI don't see you do anything that would warrant calling the undocumented native API function
p31733
aVStick with CreateFile() as long as you can
p31734
as(dp31735
g9
V17034
p31736
stp31737
a((dp31738
g2
(lp31739
VThe GetOpenFileName() API and the Vista IFileDialog interface have no support for this
p31740
aVYou can hack the dialog as demonstrated in this magazine article
p31741
aVBeware that the article is quite dated
p31742
aVAnd that hacks like these are brittle, they may well stop working on the next version of Windows
p31743
as(dp31744
g9
V17034
p31745
stp31746
a((dp31747
g2
(lp31748
VTake a look at the Graphics
p31749
aVFillXxxx() methods
p31750
aVThe most flexible one is FillPath, it takes a GraphicsPath which in turn lets you define an arbitrary shape and fill it
p31751
as(dp31752
g9
V17034
p31753
stp31754
a((dp31755
g2
(lp31756
VNone of these methods are "event driven", you'd use them in the DataReceived event
p31757
aVWhich is called when the serial port has at least one byte of data available to read
p31758
aVNot sure what "static sized" means
p31759
aVIf the device sends a fixed number of bytes then you'd use the Read() method to read them
p31760
aVPay attention to the return value, you'll get only as many bytes as are available
p31761
aVStore them in a byte[] and append to that in the next DR event until you've got them all
p31762
aVIf the device sends characters rather than bytes then you can usually take advantage of the NewLine property
p31763
aVSet it to the character or string that terminates the response
p31764
aVA linefeed ("\u005cn") is by far the most typical choice
p31765
aVRead the response with ReadLine()
p31766
aVNo buffering is required in that case
p31767
aVYou'll get the ObjectDisposed exception when you close a form but don't ensure that the device stops sending data
p31768
aVBe sure to use only BeginInvoke in the DataReceived event, not Invoke
p31769
aVAnd don't call BeginInvoke if the form's IsDisposed property is true
p31770
as(dp31771
g9
V17034
p31772
stp31773
a((dp31774
g2
(lp31775
VWell, not sure if there's a real problem
p31776
aVBut if you set the argument to TRUE in both processes then you have to check the value of GetLastError() to check if you actually ended up having ownership
p31777
aVIt will be first-come-first serve
p31778
aVUseful perhaps only if you use a named mutex to implement a singleton process instance
p31779
as(dp31780
g9
V17034
p31781
stp31782
a((dp31783
g2
(lp31784
VThis is a fair usage warning
p31785
aVThe trouble is that the compiler cannot deduce the type argument from the method call
p31786
aVThe left side of the assignment statement is not considered
p31787
aVFor example:
p31788
aVNote how Method1 must be called by explicitly specifying the type argument
p31789
aVThat's okay but makes it harder to use the method
p31790
aVThat's why CA1002 is a usage warning
p31791
aVMethod2 doesn't have this problem, the compiler can automatically infer that the type argument must be an integer from the argument type
p31792
aVTwo possible ways you could apply this to your method:
p31793
aVor
p31794
aVNot so sure these are better solutions, although swallowing exceptions and returning null doesn't win prizes either
p31795
aVIt is up to you to make the call
p31796
as(dp31797
g9
V17034
p31798
stp31799
a((dp31800
g2
(lp31801
VIt doesn't look like a side-by-side error
p31802
aVThe exception code is STATUS_INVALID_PARAMETER, "An invalid parameter was passed to a service or function
p31803
aVThat doesn't help
p31804
aVYou'll need a debugger, probably with the Windows debugging symbols
p31805
aVMake it stop on the first-chance exception
p31806
as(dp31807
g9
V17034
p31808
stp31809
a((dp31810
g2
(lp31811
VThe ComboBox control doesn't let you easily override behavior of the MouseWheel event
p31812
aVAdd a new class to your project and paste the code shown below
p31813
aVCompile
p31814
aVDrop the new control from the top of the toolbox onto your form
p31815
aVBeware that this also disables the wheel in the dropdown list
p31816
as(dp31817
g9
V17034
p31818
stp31819
a((dp31820
g2
(lp31821
VRichTextBox is often mistaken for an editor
p31822
aVIt is technically possible, you'll need a lot of code
p31823
aVFirst order of business is to select a fixed pitch font, like Courier
p31824
aVChief problem is that you cannot use the selection feature, it always spans lines
p31825
aVYou'll have to fake it, possible by using the SelectionBackColor property
p31826
aVImplement the MouseDown and MouseMove events, check the Control
p31827
aVModifiers property to see if the ALT key is down
p31828
aVUse GetCharIndexFromPosition to see what is being selected
p31829
aVIn the move event, loop through the columns and rows that were de/selected, using the SelectionStart, SelectionLength and SelectionBackColor property to colorize characters
p31830
aVThis will flicker like a cheap motel
p31831
aVP/Invoke SendMessage() to send the WM_SETREDRAW message before and after to avoid this
p31832
aVDoing something with the selection is challenging
p31833
aVYou'll need to sub-class RTB so you can override WndProc() and detect the WM_COPY, WM_CUT, WM_PASTE messages
p31834
aVOther random problems is auto-scrolling when the mouse gets close to the top or bottom of the control and unselecting when another selection is being made
p31835
aVOr you could use a real editor, like ScintillaNET
p31836
aVAll and all, this answer is unlikely to get as many upvotes as the question
p31837
as(dp31838
g9
V17034
p31839
stp31840
a((dp31841
g2
(lp31842
VThat's not supported out of the box
p31843
aVYou'll either have to draw each letter individually (hard to get that right) or insert spaces in the string yourself
p31844
aVYou can stretch the letters by using Graphics
p31845
aVScaleTransform() but that looks fugly
p31846
as(dp31847
g9
V17034
p31848
stp31849
a((dp31850
g2
(lp31851
VIcons get no love in the
p31852
aVNET framework
p31853
aVYou'll have to use Icon
p31854
aVSave() to save the icon you got into a MemoryStream
p31855
aVWhich allows you to use the IconBitmapDecoder constructor that takes a stream
p31856
as(dp31857
g9
V17034
p31858
stp31859
a((dp31860
g2
(lp31861
VThis is documented behavior
p31862
aVFrom the Remarks section in the MSDN Library topic:
p31863
aVIf the file described in the path parameter does not exist, this method returns 12:00 midnight, January 1, 1601 A
p31864
aVD
p31865
aV(C
p31866
aVE
p31867
aVCoordinated Universal Time (UTC), adjusted to local time
p31868
aVThe exception you get when you pass an empty string is one that's generated by code that checks if the passed string is a valid path name
p31869
aVWhich is fair, that would be bug in the program
p31870
aVThe code is explicit so it wasn't done by oversight or by mistake
p31871
aVIt uses the FindFirstFile() API function to locate the file
p31872
aVIf that fails, it checks the Windows error
p31873
aVAnd explicitly ignores, the "File not found", "Path not found" and "Drive busy" errors
p31874
aVBeware that offered solutions that use File
p31875
aVExists don't actually prevent this problem
p31876
aVWindows is a multi-tasking operating system
p31877
aVYour thread may be pre-empted right after the Exists call and another process may delete the file
p31878
aVWhen your thread regains the CPU, you'll still get the bogus date
p31879
aVThe only guaranteed way to get an accurate date is to open the file first so that nobody can delete the file from under you
p31880
aVWhich I think explains why the method behaves like it does
p31881
aVThe framework designers were stuck between a rock and a hard place
p31882
aVIf they would have opened the file first, they would have risked other programs bombing on a file sharing error
p31883
aVIf they don't open the file first, they risk your program bombing randomly and infrequently
p31884
aVExtremely hard to diagnose
p31885
aVHaving to choose between two unpleasant options, they chose the one that doesn't bomb anything
p31886
aVAnyhoo, make it reliable by opening the file
p31887
as(dp31888
g9
V17034
p31889
stp31890
a((dp31891
g2
(lp31892
VYes, you want Marshal::GetFunctionPointerForDelegate()
p31893
aVYour code snippet is missing the managed function you'd want to call, I just made one up
p31894
aVYou will also have to declare the managed delegate type and create an instance of it before you can get a function pointer
p31895
aVThis worked well:
p31896
as(dp31897
g9
V17034
p31898
stp31899
a((dp31900
g2
(lp31901
VIf the assembly is not found in the GAC then the CLR will search for it in the "probing path"
p31902
aVWhich by default is only the directory that contains the EXE
p31903
aVIt only looks for a match on the assembly name and will stop searching on the first match
p31904
aVIt then checks the [AssemblyVersion] number
p31905
aVIf it doesn't match you'll get an exception, it won't keep looking for another assembly with the same name
p31906
aVWhenever you have resolution trouble, you'll want to use the Fuslogvw
p31907
aVexe utility
p31908
aVIt shows you exactly where the CLR looked and what went wrong
p31909
as(dp31910
g9
V17034
p31911
stp31912
a((dp31913
g2
(lp31914
VGDI+ is available on any Windows machine since early XP
p31915
aVIt has codecs for all popular image formats, JPEG is included
p31916
aVVery nice filters for high-quality image rescaling
p31917
aVUnrestricted image rotation
p31918
aVDraws to a CDC through the Graphics class
p31919
aVSource code for the C++ wrappers are available in the SDK gdiplusXxx
p31920
aVh header files
p31921
aVSpeed is likely to be equivalent however, rendering is software based to ensure compatibility
p31922
aVYou can  and use the C++ wrappers directly
p31923
aVThe SDK docs are here
p31924
aVThe CImage class is available in MFC, it doesn't expose all capabilities however
p31925
as(dp31926
g9
V17034
p31927
stp31928
a((dp31929
g2
(lp31930
VStart a new project from the Windows Forms Application template
p31931
aVProject + Add New Item, select Cursor File
p31932
aVDraw something
p31933
aVProject + Properties, Resources tab
p31934
aVDrag and drop the cursor onto the resource window so a resource is added
p31935
aVMake your form constructor look like this:
p31936
aVPress F5 and have a look-see at your new mouse cursor
p31937
as(dp31938
g9
V17034
p31939
stp31940
a((dp31941
g2
(lp31942
VNET 4
p31943
aV0 uses a new location of the GAC
p31944
aVIt isn't c:\u005cwindows\u005cassembly anymore, the GACed files are now stored in c:\u005cwindows\u005cmicrosoft
p31945
aVnet\u005cassembly
p31946
aVThe shell extension handler isn't available for this directory, at least on my machine, so you won't have the drag-and-drop capability in Windows Explorer anymore
p31947
aVBe sure to use the
p31948
aVNET 4
p31949
aV0 version of gacutil
p31950
aVexe so the proper directory is used
p31951
aVUse the Visual Studio Command Prompt (2010) shortcut in the Start menu
p31952
aVNote that installing assemblies into the GAC is a very unusual thing to do on a dev or test machine
p31953
aVThe GAC is a deployment detail
p31954
as(dp31955
g9
V17034
p31956
stp31957
a((dp31958
g2
(lp31959
VYes, ExpandoObject is very much designed to dynamically add properties to a "property bag"
p31960
aVThe notion of giving such a property an getter and setter is not supported however
p31961
aVMaybe that's clear if you think about it a bit: it wouldn't be a dynamic property anymore if you already know what the getter and setter should do
p31962
aVThe closest you could get is implementing the INotifyPropertyChanged event so you can detect changes
p31963
aVSome sample code:
p31964
as(dp31965
g9
V17034
p31966
stp31967
a((dp31968
g2
(lp31969
VHard to answer this without you explaining how the Nintendo emulator works
p31970
aVBut you'll have to provide the virtual key code to VkKeyScan()
p31971
aVWhich is 'J', not 'j'
p31972
aVAs long as the Shift key isn't pressed, Windows will translate that to a WM_CHAR message that generates a 'j'
p31973
aVNote that keybd_event() takes a virtual key and a scan code
p31974
aVYou are passing the scan code as the virtual key
p31975
aVFix:
p31976
as(dp31977
g9
V17034
p31978
stp31979
a((dp31980
g2
(lp31981
VJust filtering the list to avoid NREs is bad practice, it hides bugs in the client code
p31982
aVThe code is bound to malfunction without any good way to diagnose why
p31983
aVLet it bomb
p31984
aVExposing a collection object for the client code to party on isn't a very good practice either
p31985
aVDerive your class from  (does it have to be object
p31986
aVYou'll delegate the IList's methods to a private  field in your class
p31987
aVBut you can override the indexer and implement the Add method to verify that the client code isn't putting nulls in the collection
p31988
aVIf that's really necessary
p31989
as(dp31990
g9
V17034
p31991
stp31992
a((dp31993
g2
(lp31994
VIt is quirk of xcopy
p31995
aVexe, you must redirect stdin as well
p31996
aVCheck this thread for my original diagnostic
p31997
aVNo need to use cmd
p31998
aVexe btw, just call xcopy directly
p31999
as(dp32000
g9
V17034
p32001
stp32002
a((dp32003
g2
(lp32004
VThe C# IDE has an option for that, "Specific Version = False"
p32005
aVNot available in the C++/CLI IDE
p32006
aVFrankly, this is not a real problem
p32007
aVYou are probably using the [AssemblyVersion] attribute incorrectly
p32008
aVThat version is associated with the publicly visible classes in the assembly
p32009
aVIf you make any changes in the public members of those classes then you've got a potentially breaking change that can make code that has a dependency on those classes fail
p32010
aVAt that point should you change the [AssemblyVersion]
p32011
aVAnd any project that uses the assembly must get their reference assembly updated and must be recompiled
p32012
aVAn otherwise non-breaking change, like a bug fix or a tweak in the non-visible classes produces a new file that is otherwise completely compatible with any project that uses it
p32013
aVYou should update the [AssemblyFileVersion] number
p32014
aVWhich in a C++/CLI project requires updating the unmanaged Version resource
p32015
aVChanging the corresponding
p32016
aVrc file could be automated, or you could use a #define
p32017
aVNote how the
p32018
aVNET base assemblies in version 2
p32019
aV0 behaved the same way
p32020
aVTheir [AssemblyVersion] stayed at 2
p32021
ag2512
ag2512
aV0 throughout the 3
p32022
aV0, 3
p32023
aV5 and 3
p32024
aV5 SP1 releases
p32025
aVTheir file version started at 2
p32026
ag2512
aV50727
p32027
aV42
p32028
aVAnd got incremented many times over the past 5 years, up to 2
p32029
ag2512
aV50727
p32030
aV4927, give or take
p32031
aVFor the record, that VS2010 bug you linked to is not a bug
p32032
aVIt just never worked before, failure was silent
p32033
aVIt is a flaw in the C++ build system, mt
p32034
aVexe embeds the manifest after the assembly is strong named
p32035
aVAnd breaks the strong name in the process because that changes the file hash
p32036
aVVS2010 is actually an improvement, it warns about it rather than silently letting a broken strong name go through
p32037
aVYou don't have to delay-sign, only resign with -Ra in a post build event
p32038
as(dp32039
g9
V17034
p32040
stp32041
a((dp32042
g2
(lp32043
VBefore you get carried away hacking the dialog, consider a simple solution first that leverages the FileOk event
p32044
aVCreate a form named, say, frmPreview
p32045
aVGive it a constructor that takes a string
p32046
aVYou'll need a Cancel and an OK button and code to play the file
p32047
aVDisplay that form like this:
p32048
aVNow, whenever the user clicks Open, your preview form shows up
p32049
aVThe user can click Cancel and pick another file from the dialog
p32050
as(dp32051
g9
V17034
p32052
stp32053
a((dp32054
g2
(lp32055
VA 24bpp bitmap doesn't have an alpha channel
p32056
aVSupported by the PNG encoder
p32057
aVCreate a WriteableBitmap with PixelFormats
p32058
aVRgb24
p32059
as(dp32060
g9
V17034
p32061
stp32062
a((dp32063
g2
(lp32064
VYou have to de-tune the traditional C/C++ header file think a bit when you work with managed code
p32065
aVThe principal source of type declarations is the assembly metadata
p32066
aVThis is very different from the native C/C++ compilation model where you have to have a header file for types that you make visible to other modules
p32067
aVI'm going to guess that you get this C2011 error in the EXE project
p32068
aVWhere you both added a reference to the DLL project assembly (like you should) and used #include on the header file
p32069
aVLike you should not
p32070
aVThat's a guaranteed duplicate definition, #pragma once doesn't fix that
p32071
aVDon't use header files for exported type definitions
p32072
aVAlways use assembly references
p32073
as(dp32074
g9
V17034
p32075
stp32076
a((dp32077
g2
(lp32078
VYou cannot tell these programs that your file data is actually a memory mapped file
p32079
aVThat really doesn't matter, files are already memory mapped by default
p32080
aVMuch more efficiently than a MMF, file data is stored in RAM and doesn't take any space in the paging file
p32081
aVThe file system cache takes care of that
p32082
aVThink of it as a large RAM disk without actually having to pay for the RAM
p32083
aVThis works so well that there never was a need for these programs to do something else than accept their input from a file
p32084
as(dp32085
g9
V17034
p32086
stp32087
a((dp32088
g2
(lp32089
VThe article is accurate
p32090
aVIt however talks about what really goes on, not what the IL looks like that the compiler generates
p32091
aVAfter all, a
p32092
aVNET program never executes IL, it executes the machine code that's generated from the IL by the JIT compiler
p32093
aVAnd the unbox opcode indeed generates code that produces a pointer to the bits on the heap that represents the value type value
p32094
aVThe JIT generates a call to a small helper function in the CLR named "JIT_Unbox"
p32095
aVclr\u005csrc\u005cvm\u005cjithelpers
p32096
aVcpp if you got the SSCLI20 source code
p32097
aVThe Object::GetData() function returns the pointer
p32098
aVFrom there, the value most commonly first gets copied into a CPU register
p32099
aVWhich then may get stored somewhere
p32100
aVIt doesn't have to be the stack, it could be a member of a reference type object (the gc heap)
p32101
aVOr a static variable (the loader heap)
p32102
aVOr it could be pushed on the stack (method call)
p32103
aVOr the CPU register could be used as-is when the value is used in an expression
p32104
aVWhile debugging, right-click the editor window and choose "Go To Disassembly" to see the machine code
p32105
as(dp32106
g9
V17034
p32107
stp32108
a((dp32109
g2
(lp32110
VAny private reference type member will do the job
p32111
aVAs long as it is private and never gets reassigned
p32112
aVWhich knocks a delegate object out of the running, you definitely don't want to see a lock fail to do its job simply because client code that you don't control assigns an event handler
p32113
aVExtremely hard to debug
p32114
aVUsing private members that do another job is not something that scales well
p32115
aVIf you find out you need to lock another region of code while refactoring or debugging, you'll need to find another private member
p32116
aVWhich is where things can turn sour quickly: you might pick the same private member again
p32117
aVDeadlock knocking on the door
p32118
aVThis doesn't happen if you dedicate a lock object to a specific set of shared variables that need to be protected
p32119
aVAllows you to give it a good name too
p32120
as(dp32121
g9
V17034
p32122
stp32123
a((dp32124
g2
(lp32125
VHopefully never
p32126
aVBut it is the kind of code you have to write when you want the UI thread to block on synchronization objects
p32127
aVA UI thread is not permitted to block, Windows prevents you from calling WaitForMultipleObjects()
p32128
aVThe reason is that it is very likely to cause deadlock
p32129
aVThe reason for that is COM
p32130
aVCOM is everywhere in Windows, the most common examples are the clipboard, drag+drop and the shell dialogs
p32131
aVCOM marshals interface method calls made from a worker thread for COM objects that live on the STA (Single Threaded Apartment) by using the message loop
p32132
aVIf the STA thread isn't pumping messages then the call won't complete
p32133
aVAnd calls that can't complete are ingredient number one for deadlock
p32134
aVAdd a UI thread that waits for the worker thread to complete and deadlock is assured
p32135
aVYou avoid this kind of code by having a worker thread use PostMessage() to signal the UI thread that something important happened
p32136
as(dp32137
g9
V17034
p32138
stp32139
a((dp32140
g2
(lp32141
VYou forgot to update the reference in the Z class:
p32142
aVOutput: X (Updated By Y) (Updated By Z)
p32143
aVPoint to keep in mind is that the += operator for a string calls the String
p32144
aVConcat() method
p32145
aVWhich creates a new string object, it doesn't update the value of a string
p32146
aVString objects are immutable, the string class doesn't have any methods or fields that lets you change the value
p32147
aVVery different from the default behavior of a regular reference type
p32148
aVSo if you use a string method or operator, you always have to assign the return value back to a variable
p32149
aVThis is pretty natural syntax, value types behave the same way
p32150
aVYour code would be very similar if you used an int instead of a string
p32151
as(dp32152
g9
V17034
p32153
stp32154
a((dp32155
g2
(lp32156
VI don't think that's possible
p32157
aVA web page is made up of many HTTP requests and responses
p32158
aVYou'd have to download the HTML yourself with HttpWebRequest
p32159
aVIts Headers property gives you access to the response headers
p32160
as(dp32161
g9
V17034
p32162
stp32163
a((dp32164
g2
(lp32165
VThis is something you ought to refactor of course
p32166
aVAdd an event to the Form1 class and let the button1's Click event raise the event
p32167
aVAssuming this is difficult: there's a back-door through the public Controls property:
p32168
as(dp32169
g9
V17034
p32170
stp32171
a((dp32172
g2
(lp32173
VThat's not exactly a typical problem with link
p32174
aVexe
p32175
aVFirst make sure that you have the "whole program optimization" feature turned off, the /GL compiler option and /LTCG linker option
p32176
aVIf that doesn't help you'll need to gather some evidence that might pinpoint the source of the problem
p32177
aVSysInternals' ProcMon
p32178
aVexe utility is good for that
p32179
aVIf that doesn't help, check if this happens on another machine as well so you can eliminate some environment cause (like a virus scanner)
p32180
aVIf that doesn't help, you'll probably need the help from Microsoft Support
p32181
aVThey'll need your project to troubleshoot the problem, you'll get your money back if it is a MSFT bug
p32182
as(dp32183
g9
V17034
p32184
stp32185
a((dp32186
g2
(lp32187
VThis is a very persistent question in forums and programming Q+A sites
p32188
aVNever with a happy ending
p32189
aVThe B in USB means bus
p32190
aVThat is a term in computer hardware design to describe an electrical interface for electronic devices to exchange data
p32191
aVIt plays the exact same role as, say, the PCI (express) bus inside your machine
p32192
aVSince it is an electrical specification first and foremost, USB supports a very large number of types of devices
p32193
aVAnything from a wireless network adapter, modem, flash memory card to a teapot warmer
p32194
aVJust about the only kinds of devices that it doesn't handle well are ones that require a very large bandwidth, like a video adapter
p32195
aVThe USB specification has a very elegant protocol specification that describes how devices can share the bus and how they can exchange data
p32196
aVThat protocol spec however does not describe the format of the data at all, it merely defines the notion of being able to deliver chunks of bytes
p32197
aVIt is up to the device itself to give a meaning to those bytes
p32198
aVOn the machine end, you need software to interpret those bytes and make the machine do something interesting with them
p32199
aVThat requires a device driver
p32200
aVJust like your video card and your network interface card require a device driver
p32201
aVObviously a video driver is very different from a NIC driver
p32202
aVThe same is true for USB drivers, there is little commonality
p32203
aVIf you want to write software that treats USB devices similar then you need to write that at the level where they still have something in common
p32204
aVThat's at the USB controller level, you could write a filter driver that injects itself in the USB driver stack and peeks at the I/O request packets between the controller and the device driver
p32205
aVSimilar to, say, the winpcap filter driver that spies on TCP/IP traffic
p32206
aVThere isn't much of anything interesting to see though, you'd be staring at the blobs of bytes that pass back and forth
p32207
aVIt is a much bigger problem than winpcap, at least it sees bytes fly by whose meaning is documented somewhere in an RFC
p32208
aVThat's not the case for USB, the company that makes the USB device is also usually the device driver supplier
p32209
aVThey keep the internal format undocumented
p32210
aVWriting filter drivers requires pretty advanced skills, there are lots of pain points
p32211
aVLike crashing the operating system when you make a simple mistake
p32212
aVThere has also been considerable flux in the Windows Driver Model lately, USB drivers have been getting moved into ring 3 (user mode) to keep the operating system stable
p32213
aVTo get started, download the Windows WDK (aka "DDK") and read Walter Oney's books
p32214
aVPreferably all of them
p32215
as(dp32216
g9
V17034
p32217
stp32218
a((dp32219
g2
(lp32220
VYeah sure, it is that simple
p32221
aVJust sum the areas of the trapezoids formed by the data points you have
p32222
aVYou cannot make it more complicated than that
p32223
aVLooking for a library to do it is fairly pointless, you'll just write code to whack the data into the format that the library needs
p32224
aVCalculating it yourself will be less code
p32225
as(dp32226
g9
V17034
p32227
stp32228
a((dp32229
g2
(lp32230
VThis is normal on a Vista or Win7 machine
p32231
aVOr a properly secured XP machine for that matter
p32232
aVThe normal install location for programs, like c:\u005cprogram files\u005cyour company\u005cyour app, is read only for most users
p32233
aVUAC is a counter-measure to malware messing with programs
p32234
aVYou'll need to store the text file into a writable location, the AppData folder
p32235
aVIn the Setup project, right-click "File system on target machine" and select User's Application  Data Folder
p32236
aVFind that file back at runtime through Environment
p32237
aVGetFolderPath, passing Environment
p32238
aVSpecialFolder
p32239
aVApplicationData
p32240
aVOr use "User's Personal Data Folder" if the user should be able to find it back easily through the Documents folder
p32241
as(dp32242
g9
V17034
p32243
stp32244
a((dp32245
g2
(lp32246
VI repro, smells like the WF logic that hunts for a focusable item is running after the event and messes up the focus
p32247
aVThese kind of problems can be elegantly solved by running code after the event is processed by using Control
p32248
aVBeginInvoke()
p32249
aVThis worked well:
p32250
as(dp32251
g9
V17034
p32252
stp32253
a((dp32254
g2
(lp32255
VYou are using the wrong name, "global::" doesn't appear in the manifest resource name
p32256
aVA typical name would be project
p32257
aVtest
p32258
aVpng if you added the resource to the project and set its Build Action to "Embedded Resource"
p32259
aVTo avoid guessing at the name, use Ildasm
p32260
aVexe and find the
p32261
aVmresource in the manifest
p32262
aVHowever, your name suggests you added the resource in the Project + Properties, Resources tab
p32263
aVGood idea, that auto-generates a property name for the resource
p32264
aVYou'd use project
p32265
aVProperties
p32266
aVResources
p32267
aVtest to reference it
p32268
aVYou'll get an Image back, no need to use GetManifestResourceStream
p32269
aVThe project name I listed above is the default namespace name you assigned to the project
p32270
aVProject + Properties, Application tab, Default namespace setting
p32271
as(dp32272
g9
V17034
p32273
stp32274
a((dp32275
g2
(lp32276
VAdd a new class to your project and paste the code shown below
p32277
aVCompile
p32278
aVDrop the new control from the top of the tool box onto your form
p32279
aVSelect the RichText property and click the button with the dots
p32280
aVThat will start Wordpad
p32281
aVEdit your text, type Ctrl+S and close Wordpad
p32282
aVBeware that the Visual Studio designer is non-functional while Wordpad is open
p32283
as(dp32284
g9
V17034
p32285
stp32286
a((dp32287
g2
(lp32288
VMake it neither abstract nor virtual
p32289
aVAnd make the backing field private
p32290
aVThat way, a derived class cannot override it nor can it mess with it
p32291
as(dp32292
g9
V17034
p32293
stp32294
a((dp32295
g2
(lp32296
VUse a System
p32297
aVThreading
p32298
aVTimer
p32299
aVInitialize it with a period of Timeout
p32300
aVInfinite so it acts like a one-shot timer
p32301
aVWhen f() completes, call its Change() method to recharge it again
p32302
as(dp32303
g9
V17034
p32304
stp32305
a((dp32306
g2
(lp32307
VThat hasn't changed
p32308
aVView + Other Windows + Property Manager
p32309
aVNavigate the tree view there and open the configuration you want to change
p32310
aVRight-click, Add New
p32311
aVIf you don't see this menu option then use Tools + Customize, Commands tab
p32312
aVSelect
p32313
aVView" and click Add Command
p32314
aVSelect "View" in the left listbox, "Property Manager" in the right one
p32315
aVThat adds the command to your View menu
p32316
aVIt's odd that it is missing of course, could have happened when you installed VS2010 and it imported your VS2008 settings
p32317
aVYou might be missing out on other menu items
p32318
aVIf you haven't customized anything extensively then Tools + Import and Export Settings, Reset might be a good idea
p32319
as(dp32320
g9
V17034
p32321
stp32322
a((dp32323
g2
(lp32324
VThere is just about nothing that could drag down the garbage collector more than it having to second-guess that some kind of user code could be interested in finding roots that it doesn't own
p32325
aVKeeping it as snappy as possible is crucial
p32326
aVFor that matter, the only way you could ever see what is being referenced with some kind of confidence is to freeze all threads that might be allocating memory from the garbage collected heap
p32327
aVWell, that's possible, debuggers do that
p32328
aVYou already know the way Windbg does it
p32329
aVIt however wasn't designed to be a tool that was optimized to track managed objects
p32330
aVThere are other tools that were: memory profilers
p32331
aVPlenty to choose from, don't try to build your own
p32332
aVFrom the freeware (and time-wasting) CLR Profiler, to the 3rd party offerings like Ants and dotTrace and many others
p32333
aVA couple of hundred bucks to solve your problem, there is no way you can do better by yourself for less
p32334
as(dp32335
g9
V17034
p32336
stp32337
a((dp32338
g2
(lp32339
VThe OnStart() arguments are supplied when the user starts the service by hand using the sc
p32340
aVexe start command from the command line
p32341
aVOr it can be done programmatically with the ServiceControl
p32342
aVStart(string[]) method overload
p32343
aVThis is rarely useful, you probably want your service to start automatically without the requiring the user to logon
p32344
aVYes, the ImagePath registry key does support passing arguments to the
p32345
aVexe, you'll get them through the Main(string[]) entrypoint
p32346
aVUnfortunately, ServiceInstaller doesn't support this
p32347
aVA better way would be to use the registry
p32348
aVIn your installer, create the HKLM\u005cSystem\u005cCurrentControlSet\u005cservices\u005cyourServiceName\u005cParameters key and write values to it
p32349
aVAnd read them back in your service's Main or OnStart method
p32350
as(dp32351
g9
V17034
p32352
stp32353
a((dp32354
g2
(lp32355
VThe Thread
p32356
aVSetApartmentState() method is important here
p32357
aVThe Clipboard is a COM object, it is not thread-safe
p32358
aVThere are many Windows features that behave like this, Drag+Drop and the shell dialogs like OpenFileDialog are other examples
p32359
aVYou cannot set the apartment state of a threadpool thread, it is always MTA (Multi-threaded apartment)
p32360
aVYou can on a regular Thread but an additional STA requirement is that you also pump a message loop (Application
p32361
aVRun)
p32362
aVWhich gives you the exact same problem back: you cannot block or take a long time to execute code
p32363
aVThe simple solution is to do whatever takes a long time to execute on a thread
p32364
aVAnd make the Clipboard call from the UI thread
p32365
aVUse Control
p32366
aVBeginInvoke() or, better, BackgroundWorker
p32367
aVRunWorkerCompleted
p32368
as(dp32369
g9
V17034
p32370
stp32371
a((dp32372
g2
(lp32373
VThis is a very common request
p32374
aVEasy keywords, google "print datagridview"
p32375
aVHere's a decent looking one
p32376
as(dp32377
g9
V17034
p32378
stp32379
a((dp32380
g2
(lp32381
VThe first output is what you get when you draw black text on a black background, probably Color
p32382
aVTransparent
p32383
aVThe 2nd was drawn on an almost-black background
p32384
aVThe 3rd was drawn on the same background it is being displayed with
p32385
aVAnti-aliasing cannot work when on a transparent background
p32386
aVThe colors used for the anti-aliasing pixels will not blend the letter shape into the background when the text is displayed with a different background
p32387
aVThose pixels will now become very noticeable and make the text look very bad
p32388
aVNote that SmoothingMode doesn't affect text output
p32389
aVIt will look slightly less bad if you use a lower quality TextRenderingHint and a background color that's grayish with a alpha of zero
p32390
aVOnly TextRenderingHint
p32391
aVSingleBitPerPixelGridFit avoids all anti-aliasing troubles
p32392
aVGetting a perfect fix for this is very difficult
p32393
aVVista's glass effect on the window title bar uses very subtle shading to give the text a well defined background color
p32394
aVYou'd need SysInternals' ZoomIt tool to really see it
p32395
aVDrawThemeTextEx() function with a non-zero iGlowSize
p32396
as(dp32397
g9
V17034
p32398
stp32399
a((dp32400
g2
(lp32401
VThere's only one level of TopMost, you'll compete with any other program that insists on being top-most
p32402
aVTry osk
p32403
aVexe for example
p32404
aVI'm guessing it uses a WH_SHELL hook to win
p32405
as(dp32406
g9
V17034
p32407
stp32408
a((dp32409
g2
(lp32410
VI never heard the term "icon embedding" before
p32411
aVIf you are talking about the icon that's visible for a EXE or DLL in Explorer or a desktop shortcut: that's done the same way for any Windows program
p32412
aVBoth WF and WPF give the assembly an unmanaged resource with the selected icon using the /win32res compile option
p32413
aVYou can see it in Visual Studio with File + Open + File, select the EXE or DLL
p32414
aVTo create a
p32415
aVres file, first create a
p32416
aVrc file
p32417
aVYou can create one with the C++ IDE
p32418
aVRight-click the solution, Add New Project, Visual C++, Win32, Win32 Console Application
p32419
aVRight-click the Resource Files folder, Add + Resource, select Icon, Import
p32420
aVselect your file
p32421
aVRepeat as needed
p32422
aVAfter you build, you'll get a
p32423
aVres file in the project's Debug build directory
p32424
aVBack to your C# project, Project + Properties, Application tab
p32425
aVSelect the Resource File option and navigate to the
p32426
aVres file
p32427
as(dp32428
g9
V17034
p32429
stp32430
a((dp32431
g2
(lp32432
VThey are declared in the AssemblyInfo
p32433
aVcs file and embedded in the $(TargetPath)
p32434
aVYou could write a little utility to dig it out again
p32435
aVFor example:
p32436
aVPost build event ought to look something like this:
p32437
as(dp32438
g9
V17034
p32439
stp32440
a((dp32441
g2
(lp32442
VIt is removing event handlers that inspired the sugar:
p32443
aVUsing new to remove an event handler
p32444
aVYes
p32445
aVEven the full delegate constructor syntax is sugar
p32446
aVA delegate needs a Method and a Target
p32447
aVThe target is automatically assigned without you specifying it
p32448
aVIt will be "this"
p32449
aVA bit unfortunate, it hides the fact that an event subscription adds a reference to your class object that can keep it from being garbage collected
p32450
aVIt is explicit in the C++/CLI syntax:
p32451
aVwith the interesting twist that you could actually subscribe an event handling method of another object or class
p32452
aVNot that this gets a lot of use
p32453
as(dp32454
g9
V17034
p32455
stp32456
a((dp32457
g2
(lp32458
VPlease don't use CDO, it dates from an era when computers still used smoke signals to exchange emails
p32459
aVSystem
p32460
aVNet
p32461
aVMail contains everything you need, MailMessage is your friend
p32462
aVNote its  IsBodyHtml property
p32463
as(dp32464
g9
V17034
p32465
stp32466
a((dp32467
g2
(lp32468
VHard to tell what you did wrong, your code is not complete
p32469
aVThis works:
p32470
aVNote that if the tab page contains any controls then those controls will get the mouse move message, not the tab page
p32471
aVAlso note that overloading the form's OnMouseMove() method is not a good idea, even though you'll get away with it in this specific case
p32472
as(dp32473
g9
V17034
p32474
stp32475
a((dp32476
g2
(lp32477
VStarting and stopping services is a highly privileged operation, normally available only to administrators
p32478
aVEnsure that the user account you use has sufficient privileges on the target machine
p32479
aVAsk more questions about it at serverfault
p32480
aVcom
p32481
as(dp32482
g9
V17034
p32483
stp32484
a((dp32485
g2
(lp32486
VThe Windows Forms designer persists designed forms by generating code
p32487
aVLots of control properties are however difficult to express in code
p32488
aVA form's Icon property or a PictureBox' Image property for example
p32489
aVLots of bytes associated with them
p32490
aVThe
p32491
aVresx file format was optimized to store those property values
p32492
aVA secondary use for them is to be able to easily localize your UI design
p32493
aVThe designer makes it easy, it automatically generates
p32494
aVresx files for each language you support
p32495
as(dp32496
g9
V17034
p32497
stp32498
a((dp32499
g2
(lp32500
VI think it was done to provide a better internal representation for numeric values retrieved from databases
p32501
aVDbase engines have a long history of storing numbers in a decimal format (avoiding rounding errors) with an explicit specification for the number of digits in the value
p32502
aVCompare the SQL Server decimal and numeric column types for example
p32503
as(dp32504
g9
V17034
p32505
stp32506
a((dp32507
g2
(lp32508
VAs long as the fraction is zero, you can parse those strings by telling it that a decimal point is acceptable:
p32509
aVIt will however not truncate or round numbers for you, non-zero fractions throw an exception (or fail TryParse)
p32510
aVYou need to explicitly apply the type of truncation you want:
p32511
aVOr use Math
p32512
aVRound, Truncate, Ceiling
p32513
aVNote that you technically should not use double
p32514
aVParse(), a long has too many digits to be accurately represented by a double (19, double only supports 15 significant digits)
p32515
as(dp32516
g9
V17034
p32517
stp32518
a((dp32519
g2
(lp32520
VYou cannot meaningfully edit the RTF in the designer
p32521
aVI can only guess that you've used a custom designer and something is wrong with it to get a value assigned like that
p32522
aVOr you somehow managed to really confuse the Windows Forms designer
p32523
aVAnyhoo, you cannot afford to have the EditorText property serialized at all
p32524
aVThat conflicts badly with the EditorPlainText property
p32525
aVThey both set the RTF of the rich text box
p32526
aVOne with formatting, the other without
p32527
aVYou'll now get random failure, depending on which property will be set last
p32528
aVForce the designer to not serialize the value like this:
p32529
aVYou'll have to remove the control from your forms and add it back after this change
p32530
as(dp32531
g9
V17034
p32532
stp32533
a((dp32534
g2
(lp32535
VYou will leak the resources held by the thread
p32536
aVThere will be various bits of
p32537
aVNET remoting plumbing objects like the AsyncResult
p32538
aVSeveral unmanaged handles associated with the thread
p32539
aVAll peanuts compared to the one megabyte of virtual memory address space you'll leak, held by the thread stack
p32540
aVYou cannot abort the thread in any way, the leak is permanent
p32541
aVWhen you have to deal with badly behaving code like this, your only good resource is to run it in a separate process so you can get Windows to clean up the shrapnel when you shoot the process in the head with Process
p32542
aVKill()
p32543
aVEven that is not guaranteed, these kind of freezes tend to be associated with misbehaving device drivers
p32544
aVProcess
p32545
aVKill won't terminate a device driver thread
p32546
aVEasy to see: trying to abort the process with Taskmgr
p32547
aVexe will leave it running with one Handle
p32548
aVYou have some hope if that doesn't happen
p32549
as(dp32550
g9
V17034
p32551
stp32552
a((dp32553
g2
(lp32554
VYou cannot use MessageBox in your code
p32555
aVIt blocks execution, the keyboard goes dead
p32556
aVUse Console
p32557
aVWriteLine() for example, output goes to the Visual Studio Output window
p32558
aVBeware that this code won't work anymore on
p32559
aVNET 4
p32560
aV0, GetModuleHandle() will return NULL
p32561
as(dp32562
g9
V17034
p32563
stp32564
a((dp32565
g2
(lp32566
VThe Sleep() function hasn't worked this way for a long time
p32567
aVIts accuracy is determined by the multimedia timer period, something you can change by P/Invoking timeBeginPeriod()
p32568
aVUnfortunately, on my machine I've got some kind of program that sets this period to one millisecond, making sleeps accurate down to a millisecond
p32569
aVHere's some code to try for yourself:
p32570
aVOutput on my machine:
p32571
aVSleep: 999, Wait: 1003
p32572
aVwith a variability of about 5 milliseconds
p32573
as(dp32574
g9
V17034
p32575
stp32576
a((dp32577
g2
(lp32578
VI won't expect any difference
p32579
aVThe "lock" is just there to avoid the access violation you'd get when you close the memory mapped file and use the pointer to the bitmap data afterward
p32580
aVThe real cost is going to be in the code you run that whacks the bitmap bits
p32581
as(dp32582
g9
V17034
p32583
stp32584
a((dp32585
g2
(lp32586
VHard to see how this could have worked before
p32587
aVThe C++ declaration doesn't declare the calling convention, the default is __cdecl unless overridden in the C++ project with the /Gz compile option
p32588
aVYou have to tell the P/Invoke marshaller:
p32589
as(dp32590
g9
V17034
p32591
stp32592
a((dp32593
g2
(lp32594
Vlockdat->Scan0 is a pointer to the pixel data of the bitmap
p32595
aVNote that you really do care what pixel format you ask for, PixelFormatDontCare won't do
p32596
aVBecause how you use the pointer is affected by the pixel format
p32597
aVPixelFormat32bppARGB is the easiest, one pixel will be the size of an int, 4 bytes representing alpha, red, green and blue
p32598
aVAnd the stride will be equal to the width of the bitmap
p32599
aVMaking it likely that a simple memcpy() will get the job done
p32600
aVBeware the bitmaps are stored upside-down
p32601
as(dp32602
g9
V17034
p32603
stp32604
a((dp32605
g2
(lp32606
VThis is impossible to answer without knowing what compiler you use
p32607
aVYour source code is in rather poor shape if it generates so many errors
p32608
aVExpecting the full list of errors to be useful is idle hope, one bad declaration can generate a slew of other errors in code that isn't actually wrong
p32609
aVYou can only really trust the first few errors
p32610
aVChip away at it, one error at a time
p32611
aVAnd make sure that your changes don't in turn generate a whole bunch of new errors
p32612
aVWhich is what is going on by the sound of it
p32613
as(dp32614
g9
V17034
p32615
stp32616
a((dp32617
g2
(lp32618
VWell, you already know how to do it
p32619
aVNo matter what you do, it will look starkly off to a user that's used to seeing her UI designs having visual styles turned on
p32620
aVAnd tick off one that has visual impairments, something that can get you sued in the USA
p32621
aVWindows Forms already has a very good way to indicate errors, the ErrorProvider was designed to do that
p32622
as(dp32623
g9
V17034
p32624
stp32625
a((dp32626
g2
(lp32627
VPut a space after the D
p32628
as(dp32629
g9
V17034
p32630
stp32631
a((dp32632
g2
(lp32633
VNo, such magic does not exist in the
p32634
aVNET framework
p32635
aVYou'd have to write the code yourself, using Reflection to read the attribute
p32636
aVThat code will look a lot like the code you already have, just slower and with the code to read the attribute added
p32637
as(dp32638
g9
V17034
p32639
stp32640
a((dp32641
g2
(lp32642
VWindows has limited support for transparency in child windows with the WS_EX_TRANSPARENT style flag
p32643
aVThat works by Windows asking the parent of the control to draw itself to provide the background pixels
p32644
aVThe problem is that you'll see the parent, not any controls that are overlapped by your picture box
p32645
aVTo make this work, you need to overlay another form on top
p32646
aVYou can get it transparent with the TransparencyKey property
p32647
aVThe code you'll need is available in my answer in this thread
p32648
as(dp32649
g9
V17034
p32650
stp32651
a((dp32652
g2
(lp32653
VNo need to P/Invoke in C++/CLI
p32654
aVUse pin_ptr<> to pin the array
p32655
aVThat gets you a byte*, just add the offset
p32656
as(dp32657
g9
V17034
p32658
stp32659
a((dp32660
g2
(lp32661
VYou have to ask for it:
p32662
as(dp32663
g9
V17034
p32664
stp32665
a((dp32666
g2
(lp32667
VThere are a couple of fundamental things wrong in your question
p32668
aVThis is a compile time error, not a runtime error
p32669
aVNote CS0008 in the message, documented as:
p32670
aVA DLL was successfully opened for retrieving metadata but is corrupted, such that data could not be read from it
p32671
aVFor more information, see /reference (Import Metadata) (C# Compiler Options)
p32672
aVNext thing that's wrong is that this assembly clearly comes from the GAC
p32673
aVThe compiler should never reference an assembly from the GAC, reference assemblies have to be copies stored in a relevant directory
p32674
aVLike c:\u005cwindows\u005cmicrosoft
p32675
aVnet\u005cetc for the
p32676
aVNET framework assemblies
p32677
aVWhatever you did to get this error clearly voided the warranty
p32678
aVI cannot reverse-engineer what you did from your question, obfuscating the assembly name certainly did not help
p32679
as(dp32680
g9
V17034
p32681
stp32682
a((dp32683
g2
(lp32684
VThe open source ICU library has 113 lines of code for ucnv_fromUnicode_UTF8 (source/common/ucnv_u8
p32685
aVc)
p32686
aVError checking included, proper surrogate handling, some comments
p32687
aVYou should only consider using something else if you don't like the naming conventions
p32688
as(dp32689
g9
V17034
p32690
stp32691
a((dp32692
g2
(lp32693
VThis requires some crystal-ball consulting
p32694
aVThe DevicePath string looks like it comes from SP_DEVICE_INTERFACE_DETAIL_DATA
p32695
aVThat's a string that you don't own, modifying it corrupts the internal setupapi database at best, the heap at worst
p32696
aVYou'll have to copy the string into your own buffer before turning it into the root directory name
p32697
aVThis is just a theory, especially "loginErrCode" is a very strange name for what the code seems to do
p32698
aVVerify that the string you end up with at least looks similar to "F:\u005c"
p32699
as(dp32700
g9
V17034
p32701
stp32702
a((dp32703
g2
(lp32704
VIt's possible, you have to
p32705
aVload sos
p32706
aVdll in your ADPlus script
p32707
aVThis blog post shows you how
p32708
aVBeware of the questionable joys of debugging managed code from a minidump
p32709
aVIf you are running into hard-to-diagnose exceptions while it is still in QA, you'll run into it again when it goes into production
p32710
aVWith dragons breathing fire added then
p32711
aVTake care of good unhandled exception logging by writing an event handler for AppDomain
p32712
aVUnhandledException
p32713
aVLogging e
p32714
aVExceptionObject
p32715
aVToString() gives a wealth of information
p32716
as(dp32717
g9
V17034
p32718
stp32719
a((dp32720
g2
(lp32721
VThe scrollbar is in the tree view's non-client area
p32722
aVWhen the mouse moves there, it starts generating non-client messages like WM_NCMOUSEMOVE and WM_NCMOUSELEAVE
p32723
aVYou would have to sub-class the TreeView and override WndProc() to detect these message
p32724
aVThis doesn't really solve your problem though, you'll still have a hard time with edge cases
p32725
aVA low-tech approach with a Timer always works:
p32726
as(dp32727
g9
V17034
p32728
stp32729
a((dp32730
g2
(lp32731
VThere is no rule in the
p32732
aVNET Framework Guidelines that says that attributes should be exclusive to the kind of types for which it was designed or commonly used
p32733
aVRe-using them certainly helps the programmer having to memorize less class names, as long as s/he doesn't have to jump through hoops with using/Imports directives and assembly references
p32734
aVNot an issue with a Windows Forms control
p32735
aVGiving an attribute runtime behavior when it normally gets used to affect design-time behavior wouldn't be my choice however
p32736
aVIt's Infragistics, what can I say
p32737
as(dp32738
g9
V17034
p32739
stp32740
a((dp32741
g2
(lp32742
VIt doesn't come much more ickier than this
p32743
aVYou'd be forced to declare the pthread_mutex_t and pthread_cond_t structures as well
p32744
aVNot great, these are implementation details that C# code shouldn't have to bother with
p32745
aVI would recommend you use the [StructLayout(LayoutKind
p32746
aVExplicit)] so you can declare only the members that the C# code needs
p32747
aVYou'll have to write a little test program in C/C++ that uses offsetof() to find the member offsets
p32748
aVThe pointers need to be declared as IntPtr
p32749
aVYou have to marshal the pointed-to values yourself with Marshal
p32750
aVPtrToStructure()
p32751
aVNot sure how much of this is covered by Mono
p32752
as(dp32753
g9
V17034
p32754
stp32755
a((dp32756
g2
(lp32757
VIt is a WDK header file, inc\u005cddk\u005cmountmgr
p32758
ag6193
aVYou'll have to download the WDK to get it
p32759
as(dp32760
g9
V17034
p32761
stp32762
a((dp32763
g2
(lp32764
VThat's what I do
p32765
aVCan't help myself, when my brain thinks "this member should be accessible", my fingers uncontrollably start hammering p u b l i c
p32766
aVNo such problem when I declare the class though
p32767
aVOne big advantage: a refactoring that make the internal class public (or the other way around preferrably) requires changing just one word
p32768
aVAnd Microsoft did this too, mostly
p32769
as(dp32770
g9
V17034
p32771
stp32772
a((dp32773
g2
(lp32774
VThere's a bug in your code that makes it hard to debug what's going on: you start the thread before the form's Handle is created
p32775
aVThat will make BeginInvoke fail
p32776
aVFix:
p32777
aVAnyhoo, this is designed behavior
p32778
aVThe Windows Forms code that runs the BeginInvoke target looks like this:
p32779
aVIt is the exception
p32780
aVGetBaseException() call that screws up your exception message
p32781
aVWhy the Windows Forms designers chose to do this isn't quite clear to me, there is no comment with the code in the Reference Source
p32782
aVI can only guess that without it the exception would be more difficult to debug, in case it is raised by the Windows Forms plumbing code instead of the application code
p32783
aVNot a great explanation
p32784
aVThey have already said that they won't fix it, perhaps you could add your vote
p32785
aVDon't get your hopes up
p32786
aVThe workaround is to not set the InnerException
p32787
aVNot a great option of course
p32788
as(dp32789
g9
V17034
p32790
stp32791
a((dp32792
g2
(lp32793
VThere are 4 versions of the CRT link libraries present in vc\u005clib:
p32794
aVlibcmt
p32795
aVlib: static CRT link library for a release build (/MT)
p32796
aVlibcmtd
p32797
aVlib: static CRT link library for a debug build (/MTd)
p32798
aVmsvcrt
p32799
aVlib: import library for the release DLL version of the CRT (/MD)
p32800
aVmsvcrtd
p32801
aVlib: import library for the debug DLL version of the CRT (/MDd)
p32802
aVLook at the linker options, Project + Properties, Linker, Command Line
p32803
aVNote how these libraries are not mentioned here
p32804
aVThe linker automatically figures out what /M switch was used by the compiler and which
p32805
aVlib should be linked through a #pragma comment directive
p32806
aVKinda important, you'd get horrible link errors and hard to diagnose runtime errors if there was a mismatch between the /M option and the
p32807
aVlib you link with
p32808
aVYou'll see the error message you quoted when the linker is told both to link to msvcrt
p32809
aVlib and libcmt
p32810
aVlib
p32811
aVWhich will happen if you link code that was compiled with /MT with code that was linked with /MD
p32812
aVThere can be only one version of the CRT
p32813
aV/NODEFAULTLIB tells the linker to ignore the #pragma comment directive that was generated from the /MT compiled code
p32814
aVThis might work, although a slew of other linker errors is not uncommon
p32815
aVThings like errno, which is a extern int in the static CRT version but macro-ed to a function in the DLL version
p32816
aVMany others like that
p32817
aVWell, fix this problem the Right Way, find the
p32818
aVobj or
p32819
aVlib file that you are linking that was compiled with the wrong /M option
p32820
aVIf you have no clue then you could find it by grepping the
p32821
aVobj/
p32822
aVlib files for "/MT"
p32823
aVBtw: the Windows executables (like version
p32824
aVdll) have their own CRT version to get their job done
p32825
aVIt is located in c:\u005cwindows\u005csystem32, you cannot reliably use it for your own programs, its CRT headers are not available anywhere
p32826
aVThe CRT DLL used by your program has a different name (like msvcrt90
p32827
aVdll)
p32828
as(dp32829
g9
V17034
p32830
stp32831
a((dp32832
g2
(lp32833
VYou'll need a console window
p32834
aVBy far the easiest way to get one is to change a linker option: Project + Properties, Linker, System, SubSystem = Console
p32835
aVAdd a main() method:
p32836
as(dp32837
g9
V17034
p32838
stp32839
a((dp32840
g2
(lp32841
VI'm blissfully unaware of this
p32842
aVTry Tools + Options, Debugger, "Step over properties and operators" checkbox
p32843
aVIf that's not it, document the key you press
p32844
as(dp32845
g9
V17034
p32846
stp32847
a((dp32848
g2
(lp32849
VHmya, that's just not how Visual Studio was designed
p32850
aVIt is quite free from "boss override" switches, it gives its user unfettered access to configuration settings
p32851
aVWhich ought to make sense to you, a developer can do far more damage with his code than with tinkering settings
p32852
aVIf a dev intentionally changes an optimization setting then, surely, it is because he profiled the code and determined a better setting
p32853
aVAnyhoo, Visual Studio isn't just useful to the dev, it is also useful to you
p32854
aVWrite a little utility that parses the
p32855
aVvcproj file and checks if the optimization settings were overridden
p32856
aVIt is a simple
p32857
aVxml file, you'll need about 5 lines of code
p32858
aVRun it in a pre-build event on your build grunt and fail the build if you deem it inappropriate
p32859
aVDealing with the pissed-off developer cannot be automated however
p32860
as(dp32861
g9
V17034
p32862
stp32863
a((dp32864
g2
(lp32865
VFrom the SDK docs:
p32866
aVA 32-bit value whose bits correspond to access rights for the object
p32867
aVBits can be set either on or off, but the setting's meaning depends on the ACE type
p32868
aVFor example, if the bit that corresponds to the right to read permissions is turned on, and the ACE type is Deny, then the ACE denies the right to read the object's permissions
p32869
aVIf the same bit is set on but the ACE type is Allow, then the ACE grants the right to read the object's permissions
p32870
aVFrom the WinNT
p32871
aVh SDK header file:
p32872
as(dp32873
g9
V17034
p32874
stp32875
a((dp32876
g2
(lp32877
VYou cannot use a BGW to display a form, the thread does not have the proper state
p32878
aVYou'll have to use a Thread so you can call its SetApartmentState() method to switch it to STA
p32879
aVYou also need a message loop on the thread to keep the form alive, that requires a call to Application
p32880
aVRun()
p32881
aVAnd the form must be created on that thread
p32882
aVThus:
p32883
aVOne big issue with this form is that it cannot be owned by any window on your UI thread
p32884
aVGiving it the tendency to disappear behind the window of another application
p32885
aVAlso, your UI thread is still dead, its windows will ghost with the "Not Responding" message in their caption bar after a few seconds
p32886
aVThe proper way to do this is the other way around: run the time-consuming code on another thread, a BGW would be a very good choice
p32887
aVThe UI thread should display your progress form
p32888
aVBackgroundWorker
p32889
aVReportProgress is ideal to keep the progress bar updated
p32890
as(dp32891
g9
V17034
p32892
stp32893
a((dp32894
g2
(lp32895
VConsole
p32896
aVWriteLine() is meant for console mode programs
p32897
aVA nice feature of Visual Studio hosting process makes its output appear in the Visual Studio Output window while debugging for processes that don't have a console
p32898
aVThat's very useful while debugging but beware that you should remove this code (or wrap it with a #ifdef DEBUG) when you're ready to create the Release build
p32899
aVIt will otherwise add unnecessary overhead to your program
p32900
aVThis makes it less than ideal for debug tracing
p32901
aVDebug
p32902
aVWriteLine() generates tracing information if you build with the DEBUG conditional #defined
p32903
aVWhich is on by default in the Debug build
p32904
aVWhere the output ends up can be configured in the app
p32905
aVexe
p32906
aVconfig file
p32907
aVIf this config is not overridden,
p32908
aVNET automatically provides an instance of the DefaultTraceListener class
p32909
aVIt sends the Debug
p32910
aVWriteLine() text with the Windows OutputDebugString() API function to the debugger
p32911
aVThe Visual Studio debugger makes that appear in the Output window, just like Console
p32912
aVWriteLine()
p32913
aVA clear advantage of Debug
p32914
aVWriteLine() is that it generates no overhead in the Release build, the calls are effectively removed
p32915
aVIt however does not support composite formatting, you'll need String
p32916
aVFormat() for that
p32917
aVFor debug tracing, the Debug class should be your choice
p32918
as(dp32919
g9
V17034
p32920
stp32921
a((dp32922
g2
(lp32923
VStructure mapping tricks like this cannot work without the P/Invoke marshaller
p32924
aVThe internal organization of a structure is not discoverable
p32925
aVThe JIT compiler readily takes advantage of this, it swaps members if that produces a smaller memory size for the structure
p32926
aVOnly a [StructLayout] can nail it down
p32927
aVThere's another goody in the Microsoft
p32928
aVVisualBasic namespace that makes this easy to do
p32929
aVThe TextFieldParser class can readily convert strings like this with a single call
p32930
aVFor example:
p32931
aVNote that the original string you posted didn't match the structure declaration, I had to modify the field widths
p32932
aVAlso note that TextFieldParser takes any stream, it doesn't have to be a string stored in a StringReader
p32933
aVA StreamReader that reads a file would be the more typical use
p32934
as(dp32935
g9
V17034
p32936
stp32937
a((dp32938
g2
(lp32939
VThe upvoted answers propose an algorithm that will have O(n^2) complexity if the IEnumerable wasn't derived from a class that implements ICollection<>
p32940
aVA Linq query for example
p32941
aVThe Count() extension method then has to iterate all elements to count them
p32942
aVThat's not cool
p32943
aVYou only need to check if the result contains any elements:
p32944
aVThe order matters btw, make the enumeration that you expect to have the smallest number of items the argument of Intersect()
p32945
as(dp32946
g9
V17034
p32947
stp32948
a((dp32949
g2
(lp32950
VYou could edit the
p32951
aVidl file and use
p32952
aVThat's awkward however, the importlib statement must appear inside the library block
p32953
aVThis is necessary because the type library probably contains coclass definitions
p32954
aVWhat you really want is to use the import statement to import the IDL that created the type library
p32955
aVMinus the coclasses
p32956
aVIf you don't have the IDL, you can re-create it with OleView
p32957
aVexe, File + View Typelib
p32958
aVCopy and paste the interface definitions you want in your own
p32959
aVidl file, then use the import MIDL statement in your IDL
p32960
as(dp32961
g9
V17034
p32962
stp32963
a((dp32964
g2
(lp32965
VThe problem is surely that you use the already-built static
p32966
aVlib in your DLL project
p32967
aVThat cannot work, you have to rebuild the
p32968
aVlib so that the functions get the __declspec(dllexport) declarator and will be exported by the linker
p32969
aVAt that point, it just isn't all that useful anymore to create the DLL compatible version of the
p32970
aVlib in the first place
p32971
aVJust create two projects, one that creates the static
p32972
aVlib, another that creates the DLL
p32973
aVTechnically it is possible to still use the static
p32974
aVlib in your DLL project but you'll have to export the functions with a
p32975
aVdef file
p32976
aVThat can be high maintenance if the library has a lot of exports
p32977
as(dp32978
g9
V17034
p32979
stp32980
a((dp32981
g2
(lp32982
VOverriding a class' GetHashCode and Equals methods so that it will work properly in a dictionary is not a very good approach
p32983
aVThe way a dictionary behaves should be an implementation detail of the dictionary, not of whatever class is being used as a key
p32984
aVYou'll get into trouble when you want to use the class in different dictionaries with different behavior
p32985
aVOr if you don't have access to the class source code
p32986
aVA better mouse trap is to give the dictionary its own comparer
p32987
aVFor example:
p32988
as(dp32989
g9
V17034
p32990
stp32991
a((dp32992
g2
(lp32993
VThe CLR and the JIT compiler are regular Windows DLLs
p32994
aVOnly one instance of the code is loaded into virtual memory, its pages are shared by any
p32995
aVNET process
p32996
aVTheir data is private to each process
p32997
aVThe same is true for any of the assemblies in the
p32998
aVNET framework, they were ngen-ed when
p32999
aVNET was installed on the machine
p33000
aVIt is probably not true for your own code, JIT compiled code is not sharable
p33001
aVThere's rarely a point since you don't often run the same program more than once
p33002
aVJust as
p33003
aVNET automatically manages memory, so does Windows
p33004
aVJust about the only thing you can do is force your program to get swapped out to disk often by setting Process
p33005
aVMaxWorkingSet
p33006
aVThis is not wise
p33007
aVMinimizing your app's main window gets that done too
p33008
aVAs a rule of thumb, you cannot make proper decisions in your own program and guess correctly whether or not trimming the working set is wise
p33009
aVYou don't know what other processes are running and how much RAM they need
p33010
aVWindows does
p33011
as(dp33012
g9
V17034
p33013
stp33014
a((dp33015
g2
(lp33016
VBehold the wonder of Option Infer On, the compiler figures out the type of "y" automatically
p33017
aVAvailable since VS2008
p33018
aVYou'll get the error you are looking for by turning it off:
p33019
as(dp33020
g9
V17034
p33021
stp33022
a((dp33023
g2
(lp33024
VWhile referencing an EXE project and loading it at runtime as though it were a DLL is okay for pure managed code, that is not going to work out well for a C++/CLI project
p33025
aVThe CRT won't be initialized correctly, there is no DllMain() entry point that will run
p33026
aVYou'll need to create a DLL, use the CLR Class Library project template
p33027
aVWhat ever compile or link errors you'll get after that might be secondary
p33028
aVMake sure you quote them in your next question, error messages were designed to tell you what is wrong
p33029
as(dp33030
g9
V17034
p33031
stp33032
a((dp33033
g2
(lp33034
VI think you need to P/Invoke QueryDosDevice() for the drive letter
p33035
aVSubst drives will return a symbolic link, similar to \u005c
p33036
aV\u005cC:\u005cblah
p33037
aVThe \u005c
p33038
aV\u005c prefix indicates it is substituted, the rest gives you the drive+directory
p33039
as(dp33040
g9
V17034
p33041
stp33042
a((dp33043
g2
(lp33044
VNo, there's a Big difference
p33045
aVCOM has a well defined protocols for creating objects, exposing methods, managing memory, publishing type information, managing threading
p33046
aVThere is practically no language left that doesn't support using a COM server, no matter what language it was written in
p33047
aVYou will not get that from exposing your own functions directly
p33048
aVThat will likely be only usable from a program written in C/C++ (so it can read your header files), compiled with the exact same version of the C++ compiler and no lack of all kinds of interop problems
p33049
aVSomething as simple as exposing a C++ class object like std::string is not safe
p33050
aVNeither the memory layout is guaranteed to be compatible, nor is there any kind of memory ownership protocol
p33051
aVIt could well be more OOPy, COM doesn't support inheritance because OOP is so hard to get compatible at the binary level
p33052
aVThat problem requires runtime support that all code buys into, VMs like
p33053
aVNET and Java
p33054
as(dp33055
g9
V17034
p33056
stp33057
a((dp33058
g2
(lp33059
VEdit the
p33060
aVcsproj file with, say, Notepad
p33061
aVThe  elements are missing
p33062
as(dp33063
g9
V17034
p33064
stp33065
a((dp33066
g2
(lp33067
VYes, start another instance of Visual Studio
p33068
aVIt is described in detail in this MSDN library article
p33069
as(dp33070
g9
V17034
p33071
stp33072
a((dp33073
g2
(lp33074
VIt is probably a scaling problem, the XP machine may have a different video adapter DPI setting or a different system font size
p33075
aVScaling is affected by the form's AutoScaleMode and whether or not they "inherit" the container control's Font property
p33076
aVWhich it does if the Font property isn't bold in the Properties window
p33077
aVOne quick way to check if scaling works property in your Form:
p33078
aVThat scales it up
p33079
aVIt probably gets scaled down on the XP machine, use 96/125
p33080
as(dp33081
g9
V17034
p33082
stp33083
a((dp33084
g2
(lp33085
VWell, you'd have to buy into the Visual Studio extension model
p33086
aVThere are things you can do with the EnvDTE class
p33087
aVThey are however fairly limited, not good enough to do what you want to do
p33088
aVThe next stop is the unmanaged extensibility model, based on COM
p33089
aVThat requires writing unmanaged COM code, based on IVxxxx interfaces
p33090
aVAvailable to 3rd party addon developers like the company that makes Resharper
p33091
aVYou have to get a license to write that kind of code, Microsoft won't be convinced you won't crash their product until you show some kind of proof you know what you are doing
p33092
aVYou'll have to call, I think it is called the VSIP licence
p33093
aVThat's possible, obviously it has been done
p33094
aVAsk your company's legal counsel to take care of those hurdles
p33095
as(dp33096
g9
V17034
p33097
stp33098
a((dp33099
g2
(lp33100
VThankfully, that is not the way it works
p33101
aVAs long as you are manipulating text in a
p33102
aVNET program, including the TextBox
p33103
aVText property, there is only one encoding, UTF-16
p33104
aVWhen you need to work with the outside world, whether it is a file or a P/Invoked function, then you need to convert between Shift-Jis and UTF-16
p33105
aVWhich is pretty straight forward:
p33106
aVPass the value of "value" to whatever code needs the Shift-JIS encoded value
p33107
aVMake sure it is not a TextBox, it doesn't know how to display bytes, it only knows UTF-16
p33108
as(dp33109
g9
V17034
p33110
stp33111
a((dp33112
g2
(lp33113
VHmya, everybody really likes a tool that will tell them that they forgot to call Dispose()
p33114
aVProblem is: such a tool is really hard to implement
p33115
aVThe specific warning you are talking about got disabled and re-enabled a few times now
p33116
aVObviously the warning you got is nonsense, a UserControl already knows how to properly dispose its member controls
p33117
aVIt is just not something that an automated tool can easily detect
p33118
aVThe dispose call is a million miles removed from the constructor call, buried in
p33119
aVNET framework code with a couple of virtual methods and event handlers thrown in the mix
p33120
aVTo really evaluate those warnings, you'll have to switch to another tool: the one between your ears
p33121
as(dp33122
g9
V17034
p33123
stp33124
a((dp33125
g2
(lp33126
VThere's a very good way to prevent the user from renaming a group
p33127
aVHard-code the group name in your code so that it will no longer work when she messes with the name
p33128
aVAccommodating such arbitrary changes makes little sense and causes more problems than it solves
p33129
aVIf you are worried about name collisions, you could certainly add a public property that allows the client code to override the group name
p33130
as(dp33131
g9
V17034
p33132
stp33133
a((dp33134
g2
(lp33135
VYes, your drag+drop will not be permitted if your program runs with elevated permissions
p33136
aVIt is called User Interface Privilege Isolation, Vista UIPI for short
p33137
aVIt is complementary to UAC and controlled by the uiAccess attribute in the manifest entry that you'd use to elevate your process
p33138
aVAs well as a certificate and a proper install location
p33139
aVRealistically: don't elevate your program
p33140
aVIt is a security hole when restricted programs can get their objects dropped in your privileged program
p33141
aVUIPI tries to prevent that
p33142
aVBut debug your program first
p33143
as(dp33144
g9
V17034
p33145
stp33146
a((dp33147
g2
(lp33148
VYou should call qsort(pElement,
p33149
aV, not qsort(*pElement,
p33150
aVThe pElement declaration at the top of your post cannot be accurate
p33151
as(dp33152
g9
V17034
p33153
stp33154
a((dp33155
g2
(lp33156
VThe cleanest way is to simply track the lifetime of the form instance
p33157
aVDo so by subscribing the FormClosed event
p33158
aVFor example:
p33159
as(dp33160
g9
V17034
p33161
stp33162
a((dp33163
g2
(lp33164
VHard to guess what your problem might be
p33165
aVIf I apply this attribute to a Program
p33166
aVTest() method, I get this:
p33167
aVRun this through ilasm
p33168
aVexe, no problem
p33169
aVNote how the array element values (scroll the snippet window to the right to see them) are already converted into the format needed to embed them in the attribute constructor data table
p33170
aVBitConverter
p33171
aVGetBytes() can get part of that job done
p33172
aVThe Ecma document should have the required format of that data
p33173
as(dp33174
g9
V17034
p33175
stp33176
a((dp33177
g2
(lp33178
VThere's something you can do: limit the working set size of your process
p33179
aVPaste this into your Main() method:
p33180
aVThat limits the amount of RAM your process can claim, preventing other processes from getting swapped out completely
p33181
aVOther things you can do:
p33182
aVAdd more RAM, no reason to not have at least 3 Gigabytes these days
p33183
aVDefrag your paging file
p33184
aVThat requires defragging the disk first, then defrag the paging file with, say, SysInternals' pagedefrag utility
p33185
aVEspecially the latter maintenance task is important on old machines
p33186
aVA fragged paging file can dramatically worsen swapping behavior
p33187
aVCommon on XP machines that never were defragged before and have a smallish disk that was allowed to fill up
p33188
aVThe paging file fragmentation causes a lot of disk head seeks, badly affecting the odds that another process can swap itself back into RAM in a reasonable amount of time
p33189
as(dp33190
g9
V17034
p33191
stp33192
a((dp33193
g2
(lp33194
VA simple example:
p33195
as(dp33196
g9
V17034
p33197
stp33198
a((dp33199
g2
(lp33200
VNot in C
p33201
aVYou can in C++
p33202
aVA struct is just a class with all members being public by default in that language
p33203
as(dp33204
g9
V17034
p33205
stp33206
a((dp33207
g2
(lp33208
VYou more than likely identified the culprit correctly, setting CheckForIllegalCrossThreadCalls to false is great way to create random deadlock
p33209
aVThe only reason the property even exists is to allow debugging borked
p33210
aVNET 1
p33211
aVx programs
p33212
aVTo troubleshoot deadlock, you'll need to use the Debug + Windows + Threads window to switch between the various threads and look at their call stacks
p33213
aVBut given the likely nature of the source, that is going to be difficult since it is more than likely unmanaged code that does something with the message queue or SendMessage()
p33214
aVCode you didn't write and don't have source code nor debugging symbols for
p33215
aVThey also tend to be random, the next time it deadlocks might look completely different
p33216
aVWindows are fundamentally thread-unsafe objects
p33217
aVThey have a very large amount of state associated with them
p33218
aVNot just in the Windows Forms class wrappers, inside Windows itself as well
p33219
aVI trust you fixed the problem
p33220
as(dp33221
g9
V17034
p33222
stp33223
a((dp33224
g2
(lp33225
VWell, it isn't normal practice
p33226
aVYou'd want some kind of control over how the object gets serialized so that it doesn't trip you up with details that are only relevant to a PropertyGrid
p33227
aVThat's not usually hard to do:
p33228
aVProblem solved :)
p33229
as(dp33230
g9
V17034
p33231
stp33232
a((dp33233
g2
(lp33234
VRight-click the project, Add + New Item, select Text File, name it Blah
p33235
aVmc
p33236
aVEnter or paste the definitions
p33237
aVRight-click Blah
p33238
aVmc, Properties, Custom build step:
p33239
aVCommand line = mc $(InputPath)
p33240
aVOutputs = $(InputName)
p33241
aVrc
p33242
aVEdit your
p33243
aVrc file, add:
p33244
aVWorked for me, ought to be close
p33245
as(dp33246
g9
V17034
p33247
stp33248
a((dp33249
g2
(lp33250
VDrop a SerialPort from the toolbox onto your form
p33251
aVSet its properties and double-click DataReceived
p33252
aVThat takes care of the first 5 lines
p33253
aVIn the Load event handler, put the Open and Write calls, that takes care of the rest of the lines
p33254
aVDrop a TextBox on the form, set its MultiLine property to True
p33255
aVWrite this code in the DataReceived event handler:
p33256
aVFrom there, you can tinker with the form design to make it more useful
p33257
aVMaybe you want to add a Button whose Click event polls the modem again
p33258
as(dp33259
g9
V17034
p33260
stp33261
a((dp33262
g2
(lp33263
VThere is no built-in support for double buffering in the Compact Framework
p33264
aVYou can add it yourself, PictureBox already supports the Image property
p33265
aVCreate a Bitmap in the constructor and assign it to Image
p33266
aVYou don't need the Paint event anymore, the one provided by PictureBox already draws it to the screen
p33267
aVWhenever the image needs to change, create a Graphics object with Graphics
p33268
aVFromImage(), passing the PB's Image and draw your stuff
p33269
aVCall the PB's Invalidate() method to tell it that it needs to redraw the image
p33270
aVIf you still see flicker, override the PB's OnPaintBackground() method and do nothing
p33271
aVThe only other consideration is handling resizing, you'd need a larger or smaller Bitmap
p33272
aVNot so sure that would be necessary for a game
p33273
as(dp33274
g9
V17034
p33275
stp33276
a((dp33277
g2
(lp33278
VGetting the output of Console
p33279
aVWrite/Line() written to the Visual Studio Output window is a feature of the Visual Studio Hosting process
p33280
aVProject + Properties, Debug tab
p33281
aVThis will not work if you run your app without a debugger, the hosting process isn't being used
p33282
aVUsing Console
p33283
aVWriteLine for debugging isn't the greatest solution
p33284
aVThat code will still run in your Release build and take time formatting the output string
p33285
aVAnd prevent the JIT optimizer from doing a good job generating the most efficient machine code
p33286
aVOutput will fall in the bit bucket, nothing to actually write it to
p33287
aVAnd it is unnecessary, the debugger gives you much better tools to find out what is going on in your program
p33288
aVTake some time to familiarize yourself with its capabilities
p33289
aVIf you want to find out if an event handler runs, just set a breakpoint
p33290
aVSuch a breakpoint can even trace output without actually breaking
p33291
aVRight-click the red dot, click "When hit" and use the "Print message" option
p33292
as(dp33293
g9
V17034
p33294
stp33295
a((dp33296
g2
(lp33297
VYou'll create a fair amount of garbage for each call to Read(byte[])
p33298
aVThere will be 40 bytes for the MemoryStream, I stopped counting at 64 bytes for the BinaryReader
p33299
aVDispose is also normally used, although it doesn't do anything
p33300
aVWhether that overhead matters is impossible to tell from your question
p33301
aVI'd personally prefer the Read(BinaryReader) overload, not just because it is more efficient
p33302
aVThat also gives the flexibility of changing the source of the data
p33303
aVIt doesn't have to be in a byte[] anymore, you could feed it from, say, a FileStream or NetworkStream
p33304
as(dp33305
g9
V17034
p33306
stp33307
a((dp33308
g2
(lp33309
VI would strongly encourage using the normal pattern for thread-local storage, described in this MSDN article
p33310
aVWhen you use [ThreadStatic], what matters is whether or not a threadpool thread cleans up the TLS variables when it terminates
p33311
aVThere isn't any suggestion in the MSDN docs that it doesn't
p33312
aVIt wouldn't be hard to implement, it only has to call the TlsFree() API function
p33313
aVI wrote a little test app, no evidence of any leak
p33314
as(dp33315
g9
V17034
p33316
stp33317
a((dp33318
g2
(lp33319
VNo, the ThreadPool manager was designed to deal with this situation
p33320
aVIt won't let all thread pool threads run at the same time
p33321
aVIt starts off allowing as many threads to run as you have CPU cores
p33322
aVAs soon as one completes, it allows another one to run
p33323
aVEvery half second, it steps in if the active threads are not completing
p33324
aVIt assumes they are stuck and allows another one to run
p33325
aVOn a 2 core CPU, you'd now have 3 threads running
p33326
aVGetting to the maximum, 500 threads on a 2 core CPU, would take quite a while
p33327
aVYou would have to have threads that don't complete for over 4 minutes
p33328
aVIf your threads behave that way then you don't want to use threadpool threads
p33329
as(dp33330
g9
V17034
p33331
stp33332
a((dp33333
g2
(lp33334
VYou can't
p33335
aVIts a bag, it isn't ordered
p33336
aVWhen you put it back, you'll just get stuck in an endless loop
p33337
aVYou want a Set
p33338
aVYou can emulate one with ConcurrentDictionary
p33339
aVOr a HashSet that you protect yourself with a lock
p33340
as(dp33341
g9
V17034
p33342
stp33343
a((dp33344
g2
(lp33345
VI poked at this for a while, the OPENFILENAME structure has flags to control read-only behavior
p33346
aVNo luck, they are only enabled for OpenFileDialog, not SaveFileDialog
p33347
aVThe read-only check is a hard one, you cannot bypass it
p33348
aVOther than disappointing the QA group, I'd strongly recommend you protect file content with normal Windows file security settings, not the ReadOnly file attribute
p33349
as(dp33350
g9
V17034
p33351
stp33352
a((dp33353
g2
(lp33354
VIt is done through the [SettingsManageability] attribute
p33355
aVThe LocalFileSettingsProvider class checks it, the presence of the attribute appears to be enough, as long as the app isn't ClickOnce deployed
p33356
aVLooks pretty useless, the settings designer has no support for it
p33357
as(dp33358
g9
V17034
p33359
stp33360
a((dp33361
g2
(lp33362
VThat was done intentionally in designers for the MenuStrip and ToolStrip controls
p33363
aVThe subject of this feedback article
p33364
aVYou could write code instead of using the designer
p33365
aVOr consider merging strips after the InitializeComponent() call, tricky to get right
p33366
aVYour best bet is probably to avoid putting them on your base form
p33367
as(dp33368
g9
V17034
p33369
stp33370
a((dp33371
g2
(lp33372
VEast Asian machines tend to run with a larger system font size to make characters more legible
p33373
aVThe setting of Form
p33374
aVAutoScaleMode matters, so does the Form's Font vs the control's Font
p33375
aVEnsure that your form scales properly
p33376
as(dp33377
g9
V17034
p33378
stp33379
a((dp33380
g2
(lp33381
VYou can use the DrawToBitmap() method
p33382
aVMostly works, but you might have controls that don't implement it, like RTB or 3rd party controls
p33383
aVThe backup method is Graphics
p33384
aVCopyFromScreen()
p33385
as(dp33386
g9
V17034
p33387
stp33388
a((dp33389
g2
(lp33390
VThe problems with malloc and new arise when you use DLLs
p33391
aVDepending on build options, a DLL may have its own copy of the CRT
p33392
aVThat makes it use its own heap to allocate memory from, a different heap than the one used by the EXE
p33393
aVThis causes failure when memory is allocated by one module and released by another
p33394
aVVery common when you use STL
p33395
aVOne way to solve it is by compiling code with the /MD option
p33396
aVThat forces use of a shared copy of the CRT, stored in its own DLL
p33397
aVProblem solved, there's now only one allocator, using a single heap
p33398
aVThis issue also arises with COM, it allows different languages to interop
p33399
aVThey would of course never share an allocator since those language have different runtime support libraries
p33400
aVBy contract, COM code must use a single allocator provided by the COM runtime support, CoTaskMemAlloc()
p33401
aVNote that HeapAlloc() cannot solve this problem
p33402
aVIt requires a handle to a heap, returned by HeapCreate()
p33403
aVDifferent modules would have to share that handle to avoid trouble
p33404
aVUpdate: addressed in VS2012, the CRT now allocates from a shared heap, the default process heap (GetProcessHeap function)
p33405
as(dp33406
g9
V17034
p33407
stp33408
a((dp33409
g2
(lp33410
VThe reason is given in the Remarks section of the Assembly
p33411
aVLoadFile() method:
p33412
aVUse the LoadFile method to load and examine assemblies that have the same identity, but are located in different paths
p33413
aVLoadFile does not load files into the LoadFrom context, and does not resolve dependencies using the load path, as the LoadFrom method does
p33414
aVLoadFile is useful in this limited scenario because LoadFrom cannot be used to load assemblies that have the same identities but different paths; it will load only the first such assembly
p33415
aVThat's a bit dense perhaps
p33416
aVThe assembly loading context is a tricky subject blogged about at length by Suzanne Cook
p33417
aVThe ultimate effect is that when you use the types of that assembly elsewhere, you'll get the assembly loaded again and those types won't match the types from the LoadFile assembly since the assemblies have a different identity
p33418
aVAs indicated, use Load or LoadFrom to avoid this problem
p33419
as(dp33420
g9
V17034
p33421
stp33422
a((dp33423
g2
(lp33424
VDid somebody mention yet that this is a bad idea
p33425
aVThere are few reasons you wouldn't be able to see the class
p33426
aVShort from the assembly reference, there is only one good one: you forgot to declare the class public
p33427
as(dp33428
g9
V17034
p33429
stp33430
a((dp33431
g2
(lp33432
VYou are looking at the IL for the System
p33433
aVCollections
p33434
aVGeneric
p33435
aVDictionary<> class
p33436
aVThe "Dictionary" class name is the string you pass to ModuleBuilder
p33437
aVDefineType()
p33438
aVThe
p33439
aVparam attribute is generated in C# version 4 or VB
p33440
aVNET for parameters that have a default value
p33441
aVYou set it with the ParameterBuilder you get back from MethodBuilder
p33442
aVDefineParameter()
p33443
aVUse the SetConstant() method
p33444
as(dp33445
g9
V17034
p33446
stp33447
a((dp33448
g2
(lp33449
VThere are not a lot of possible failure modes here
p33450
aVAssembly
p33451
aVGetManifestResourceStream() will return null if the resource could not be found
p33452
aVThat will make the Bitmap constructor fail with the indicated exception
p33453
aVBit of a bug there, it should have thrown ArgumentNullException
p33454
aVAnyhoo, it looks like for some reason the assembly doesn't get built with the bitmap resource on your XP machine
p33455
aVDouble-check that with Ildasm
p33456
aVexe
p33457
aVDouble-click Manifest, you should see the
p33458
aVmresource with the name you ask for
p33459
aVThe better mouse trap is to add the resource with Project + Properties, Resources tab, click the arrow on the Add Resource button, Add Existing File and navigate to the file
p33460
aVYou can then reference the bitmap directly through the auto-generated property:
p33461
as(dp33462
g9
V17034
p33463
stp33464
a((dp33465
g2
(lp33466
VFiles are already buffered by the file system cache
p33467
aVYou just need to pick a buffer size that doesn't force FileStream to make the native Windows ReadFile() API call to fill the buffer too often
p33468
aVDon't go below a kilobyte, more than 16 KB is a waste of memory and unfriendly to the cpu's L1 cache (typically 16 or 32KB of data)
p33469
aV4KB is a traditional choice, even though that will exactly span a virtual memory page only ever by accident
p33470
aVIt is difficult to profile, you'll end up measuring how long it takes to read a cached file
p33471
aVWhich runs at RAM speeds, 5 gigabytes/sec and up if the data is available in the cache
p33472
aVIt will be in the cache the second time you run your test, that won't happen in a production environment too often
p33473
aVFile I/O is completely dominated by the disk drive or the NIC and is glacially slow, copying the data is peanuts
p33474
aV4KB will work fine
p33475
as(dp33476
g9
V17034
p33477
stp33478
a((dp33479
g2
(lp33480
VYes, there are multiple v-tables, one for each inherited interface
p33481
aVThe static_cast<> returns it
p33482
aVThe compiler makes sure that common methods in the inherited interfaces are shared, it fills each v-table slot with the a pointer to the same function
p33483
aVSo you only need one implementation of AddRef, Release, QueryInterface
p33484
aVJust what you want
p33485
aVNone of this is an accident
p33486
aVThis is only ever a problem when a coclass implements multiple interfaces with the same method that you don't want to give the same implementation
p33487
aVThe IConnectionPoint::Advise() method is a notorious example
p33488
aVOr was it DAdvise()
p33489
aVUnfortunately, I don't remember what it clashed with and how it was solved, it was covered by ATL Internals
p33490
aVVery good book btw
p33491
as(dp33492
g9
V17034
p33493
stp33494
a((dp33495
g2
(lp33496
VSIOF is very much a runtime artifact, the compiler and linker don't have much to do with it
p33497
aVConsider the atexit() function, it registers functions to be called at program exit
p33498
aVMany CRT implementations have something similar for program initialization, let's call it atinit()
p33499
aVInitializing these global variables requires executing code, the value cannot be determined by the compiler
p33500
aVSo the compiler generates snippets of machine code that execute the expression and assigns the value
p33501
aVThese snippets need to be executed before main() runs
p33502
aVThat's where atinit() comes into play
p33503
aVA common CRT implementation walks a list of atinit function pointers and execute the initialization snippets, in order
p33504
aVThe problem is the order in which the functions are registered in the atinit() list
p33505
aVWhile atexit() has a well defined LIFO order, and it is implicitly determined by the order in which the code calls atexit(), such is not the case for atinit functions
p33506
aVThe language specification doesn't require an order, there is nothing you could do in your code to specify an order
p33507
aVSIOF is the result
p33508
aVOne possible implementation is the compiler emitting function pointers in a separate section
p33509
aVThe linker merges them, producing the atinit list
p33510
aVIf your compiler does that then the initialization order will be determined by the order in which you link the object files
p33511
aVLook at the map file, you should see the atinit section if your compiler does this
p33512
aVIt won't be called atinit, but some kind of name with "init" is likely
p33513
aVTaking a look at the CRT source code that calls main() should give insight as well
p33514
as(dp33515
g9
V17034
p33516
stp33517
a((dp33518
g2
(lp33519
VYou are comparing apples and oranges
p33520
aVThe STL collection classes had completely different design goals
p33521
aVThey are a one-size-fits-all design to collections, you can only ever get the classes that are provided
p33522
aVThere's no way to customize a collection, the STL classes were not designed to be inherited from
p33523
aVVery different from the
p33524
aVNET ones, their core is the ICollection, IDictionary and IList interfaces
p33525
aVThe
p33526
aVNET framework contains hundreds of collection classes, customized to get their specific job done
p33527
aVThat affected the designs of their iterators as well
p33528
aVSTL iterators must provide a lot of flexibility since the collections they iterate cannot be customized
p33529
aVThere is an inherent cost associated with that
p33530
aVThere are 5 different STL iterator types, not all collection classes support all 5 different types
p33531
aVLoss of generality is never a good thing in a library design
p33532
aVWhile an argument can be made that C++ iterators are more flexible, I'll make the opposite assertion
p33533
aVThe simplicity of IEnumerator was an enabler for very valuable
p33534
aVNET features
p33535
aVThe C# yield keyword for example, it completely disassociates a collection with the behavior of an iterator
p33536
aVLinq would not have happened if it wasn't for a simple iterator type
p33537
aVCovariance support would not have been possible
p33538
aVRegarding your Edit2, no,
p33539
aVNET iterators are separate classes, just like the C++ ones
p33540
aVMake sure to understand the difference between IEnumerable (implemented by the collection) and IEnumerator (implemented by the iterator)
p33541
as(dp33542
g9
V17034
p33543
stp33544
a((dp33545
g2
(lp33546
VUserControl derives from ScrollableControl as well
p33547
aVIt should have its AutoScroll property set to true, not the TabPage
p33548
aVSet its AutoScrollMinSize property instead of its Size
p33549
as(dp33550
g9
V17034
p33551
stp33552
a((dp33553
g2
(lp33554
VYeah, is synchronous
p33555
aVBut you make bigger assumptions in this code, you assuming that creating any Graphics object is thread-safe
p33556
aVAfaik it is on the desktop version of GDI+
p33557
aVIt wouldn't be so likely on a limited resource OS like WM
p33558
aVNothing you can lock, the one used for painting is created in code you can't touch
p33559
as(dp33560
g9
V17034
p33561
stp33562
a((dp33563
g2
(lp33564
VUse the TabControl
p33565
aVDrawMode property to implement custom drawing
p33566
aVThere's a good example of a DrawItem event handler in the MSDN Library article
p33567
aVUse Graphics
p33568
aVDrawLine() or DrawImage to draw the x
p33569
aVUse the MouseUp event to detect a click on the x
p33570
aVYou'll need the GetTabRect() method to find out which tab was clicked
p33571
aVAnd narrow down the location to verify that it was near the x
p33572
as(dp33573
g9
V17034
p33574
stp33575
a((dp33576
g2
(lp33577
VIt is not a stack overflow error
p33578
aV__stack_chk_fail is called when stack frame corruption is detected
p33579
aVThe traditional way to smash the stack is a buffer overflow
p33580
aVThe code that causes it is not in your snippet, it is in the dots
p33581
aVAfter updating the question with code from a comment: both the strcpy and the sprintf calls are excellent candidates for stack corruption
p33582
aVThe buffer overflow problem I mentioned in my original answer
p33583
aVTaking a guess: nowyPiesnPlik looks very small
p33584
aVThe sprintf() function will write too many characters to the buffer and overwrite the "canary"
p33585
aVWhen the canary gets stomped on, the runtime will whistle fowl :)
p33586
aVYou could make the array bigger
p33587
aVNot a real solution, use safe alternatives for these functions, like snprintf()
p33588
aVI'll avoid mentioning strncpy()
p33589
as(dp33590
g9
V17034
p33591
stp33592
a((dp33593
g2
(lp33594
VSystem Requirements
p33595
aVSupported Operating Systems: Windows 7; Windows Vista
p33596
aVWindows Vista (x86 and x64) ENU with Service Pack 2 \u2013 all editions except Starter Edition
p33597
aVWindows 7 (x86 and x64) ENU \u2013 all editions except Starter Edition
p33598
aVInstallation requires 3 GB of free disk space on the system drive
p33599
aV2 GB RAM
p33600
aVDirectX 10 capable graphics card with a WDDM 1
p33601
aV1 driver
p33602
aVNo, I don't see XP in that list
p33603
aVClearly it is being verified by the installer, you simply won't get it installed
p33604
as(dp33605
g9
V17034
p33606
stp33607
a((dp33608
g2
(lp33609
VYou need to tell sprintf() that you pass a wide character string
p33610
aVUse the %ls specifier:
p33611
aVDo note how unproductive this is
p33612
aVYour code runs on a Unicode operating system
p33613
aVIt must convert your char[] string back to a wide string before it can send it to the debugger
p33614
aVThat's just wasted CPU cycles with a significant risk of data loss to boot
p33615
aVWhen you are in Rome, act like a Roman and use wchar_t + wsprintf()
p33616
aVAnd #define UNICODE so you'll automatically call the fast OutputDebugStringW(), the one that doesn't have to convert the string
p33617
aVThe point of using C++ is to write fast code, intentionally making is slow is pointless
p33618
as(dp33619
g9
V17034
p33620
stp33621
a((dp33622
g2
(lp33623
VOpen the
p33624
aVsln file in Notepad and change the path in the Project statement near the top of the file
p33625
aVNo need to change the path in the  elements in the
p33626
aVcsproj files, they'll get automatically updated
p33627
as(dp33628
g9
V17034
p33629
stp33630
a((dp33631
g2
(lp33632
VYes, you don't want to leave the FileStream opened
p33633
aVFor one, you won't even be able to open the file yourself after that
p33634
aVCalling Close() is good enough, but using using is probably the preferred pattern
p33635
aVThere's a much bigger problem with your code however
p33636
aVIt cannot possibly work reliably on Windows
p33637
aVA typical scenario:
p33638
aVThe File
p33639
aVOpen() call succeeds
p33640
aVYou close it
p33641
aVYour thread gets pre-empted by the Windows scheduler
p33642
aVAnother thread in another process gets a chance to run, it opens the file
p33643
aVYour thread regains the CPU and continues after the File
p33644
aVOpen() call
p33645
aVYou open the file, trusting that it will work since IsOpen() returned false
p33646
aVKaboom
p33647
aVNever write code like this, failure is extremely hard to diagnose
p33648
aVOnly ever open a file when you are ready to start reading or writing to it
p33649
aVAnd don't close it until you are done
p33650
aVExtra bonus: it is now obvious that you want to use a using statement
p33651
as(dp33652
g9
V17034
p33653
stp33654
a((dp33655
g2
(lp33656
VYou had me going on this question for a while
p33657
aVNo way
p33658
aVWay
p33659
aVProject + Properties, Debug tab, check "Enable unmanaged code debugging"
p33660
as(dp33661
g9
V17034
p33662
stp33663
a((dp33664
g2
(lp33665
V65001 means the same thing as UTF-8
p33666
aVJust use a StreamWriter, it formats text in UTF-8 by default
p33667
as(dp33668
g9
V17034
p33669
stp33670
a((dp33671
g2
(lp33672
VFont sizes are specified in points
p33673
aVOne point is 1/72 inches
p33674
aVThe problem is that this needs to jive with the rest of Windows Forms where almost anything is specified in pixels
p33675
aVThe issue is how many pixels make a point
p33676
aVThat depends on your video adapter's dots-per-inch setting
p33677
aVThe traditional setting is 96 dots per inch
p33678
aVSo if you ask for a 9 point font, you'll get one that's 9 / 72 * 96 = 12 pixels high
p33679
aVAs long as the client area of a control is at least 12 pixels high, the text displayed inside of it won't be clipped
p33680
aVThe video adapter's DPI setting can be changed however
p33681
aVThey made it kinda difficult in XP, you had to go into the Display applet's Advanced setting to do so
p33682
aVIt got a lot easier in Vista, there's a direct link to it with a nice ruler and whatnot
p33683
aVThe next common setting is 120 DPI, 125% more dots per inch
p33684
aVThat 9 point font now needs 9 / 72 * 120 = 15 pixels
p33685
aVIf the original control that displays that text is still at 12 pixels, the text is going to get clipped
p33686
aVBasically, the descenders are sheared off
p33687
aVSo to fix that, the Control
p33688
aVSize property of the controls in the form need to change
p33689
aVThey need to be scaled to accommodate the larger DPI setting
p33690
aVWindows Forms readily supports that
p33691
aVIt is the Form
p33692
aVAutoScaleMode, available since
p33693
aVNET 2
p33694
ag2512
aVWhen you set it to something else than None then automatic code inside Windows Forms kicks in that compensates for the difference between the machine that designed the form and the machine that displays the form
p33695
aVIn the 120 DPI case, it will make the form and the controls bigger
p33696
aVSo that they can display text without it getting clipped
p33697
aVBut, there's a complication
p33698
aVChanging the DPI setting is great for fonts
p33699
aVTrueType is awesome technology, capable of rendering good looking type at any size
p33700
aVBut rescaling doesn't work very well for images that contain line art
p33701
aVThey get stray extra pixels or get fuzzy when you rescale them
p33702
aVBack to fonts: clearly if you change the DPI setting of the monitor, the user would expect the fonts to follow suit
p33703
aVThat certainly worked that way back in the XP days
p33704
aVIf you change the video adapter's DPI setting, you get a prompt to reboot the operating system
p33705
aVThat was important back then because there were lots of program that used device fonts, not TrueType fonts
p33706
aVNon-scalable fonts
p33707
aVNew fonts got activated that match the DPI setting
p33708
aVA larger value for video DPI is thus matched with a larger system base font size
p33709
aVAround the same time, some kind of genius at Microsoft, since assassinated, came up with a Really Good Idea
p33710
aVPeople that live in East Asia have a writing system based on characters
p33711
aVIntricate glyphs that need lots of pixels to show the details
p33712
aV12 pixels at 96 DPI does not leave a lot of room to make a good looking Chinese or Korean glyph
p33713
aVIncreasing the DPI obviously improves that, but at the cost of having fuzzy images
p33714
aVThe Idea: increase the system base font size but don't change the video DPI
p33715
aVNow there's a new problem however: how to auto-scale the UI
p33716
aVYou can see this back in the values you can assign to the AutoScaleMode property, either Font or DPI
p33717
aVWhich one is correct for the target machine is not easily guessable
p33718
aVFont is normally the better choice since you want to make sure that text isn't clipped
p33719
aVHowever, if you want to make sure that images display at the right size, then you want DPI
p33720
aVWhen you want both then you are stuck between a rock and a hard place, one you can't get out of unless the system base font size matches the video DPI setting
p33721
as(dp33722
g9
V17034
p33723
stp33724
a((dp33725
g2
(lp33726
VIn VB6, an Integer was 2 bytes
p33727
aVUse Short in VB
p33728
aVNET
p33729
aVMove the Flush out of the For loop
p33730
aVThe rest looks okay
p33731
as(dp33732
g9
V17034
p33733
stp33734
a((dp33735
g2
(lp33736
VRemove "HKEY_LOCAL_MACHINE" from the key name, that's already covered by the LocalMachine member in your code
p33737
aVBeware that this code will not work on a regular Vista or Win7 machine, you cannot open this key for writing with UAC enabled
p33738
aVYou'd need a manifest that requires administrator privileges
p33739
aVWrite to My
p33740
aVComputer
p33741
aVRegistry
p33742
aVCurrentUser instead
p33743
aVOne more complication is registry virtualization if you run this on the 64-bit version of Windows
p33744
aV32-bit programs will read and write HKLM\u005cSoftware keys to/from HKLM\u005cSoftware\u005cWow6432Node instead
p33745
as(dp33746
g9
V17034
p33747
stp33748
a((dp33749
g2
(lp33750
VUse the type library of the ActiveX component
p33751
aVImport it with Tlbimp
p33752
aVexe to get the interop library, you probably already have it if you use this component yourself
p33753
aVImplement your own code by inheriting the interfaces in that type library
p33754
aVYour implementation must use the exact same GUIDs and ProgIDs as the ActiveX component
p33755
aVUse OleView
p33756
aVexe, File + View Typelib and select the ActiveX DLL to see the GUIDs
p33757
aVThe ProgIDs are more difficult, best thing to do is to watch how the registry is modified with the SysInternals' ProcMon utility when you register the ActiveX DLL with Regsvr32
p33758
aVexe
p33759
aVUltimately, the exact same changes need to be made by Regasm
p33760
aVexe when you register your replacement
p33761
aVAs point 2
p33762
aVSame, the registration gets unmanaged code to use yours instead
p33763
aVTo make this work out well, you really have to know what the interfaces do
p33764
aVYou cannot make this work if the ActiveX component is actually an out-of-process server (an EXE)
p33765
as(dp33766
g9
V17034
p33767
stp33768
a((dp33769
g2
(lp33770
VThe project template that you used to get the project started doesn't have very optimum settings
p33771
aVYou'll get the clutter as a result
p33772
aVIt is easily fixable
p33773
aVStart with Project + Properties, Compile tab
p33774
aVMake sure the Release build is selected, upper left combo box labeled Configuration
p33775
aVThe
p33776
aVpdb file contains debugging symbols
p33777
aVYou don't need it for the Release build although you get slightly more informative exception messages
p33778
aVThe stack trace will contain line numbers
p33779
aVYou cannot trust them for a Release build though
p33780
aVClick Advanced Compile Options, Generate debug info = None
p33781
aVThe
p33782
aVxml file contains IntelliSense info, it will be generated when you use XML Documentation in your source code
p33783
aVMeant to be used for assemblies that are referenced in another project, quite pointless for an EXE project
p33784
aVTurn off the "Generate XML documentation file" option on the Compile tab
p33785
aVThe
p33786
aVvshost
p33787
aVexe file is a helper process for debugging your app
p33788
aVIt hosts a custom version of CLR, configured differently to help with security issues while debugging
p33789
aVIt also makes the output of Console
p33790
aVWriteLine() appear in the Visual Studio Output window
p33791
aVThere's little point in having it created for the Release build
p33792
aVSelect the Debug tab and uncheck the "Enable the Visual Studio hosting process" option
p33793
aVAfter making these changes and rebuilding, you should only have the
p33794
aVexe file left in the bin\u005cRelease folder
p33795
aVThe slow startup is what's called a "cold start" of the
p33796
aVNET framework assemblies
p33797
aVIt is caused by a slow or fragmented hard drive
p33798
aVSince the DLLs were never loaded before, the disk drive needs to dig through the GAC to find the files
p33799
aVYou can probably improve it by defragging the disk
p33800
aVCold starts are never as fast as warm starts though
p33801
aVA classic trick, used by Microsoft Office and Adobe Acrobat, is to warm up the file system cache by loading their DLLs at login time
p33802
aVThey are called "optimizer" in the Startup folder or Run registry key
p33803
aVVery annoying btw, they slow down other programs
p33804
aVYou can do the same thing by writing your own little
p33805
aVNET program that doesn't do anything but create a few classes
p33806
aVPut a shortcut to it in the Startup folder
p33807
as(dp33808
g9
V17034
p33809
stp33810
a((dp33811
g2
(lp33812
VIt will be the version of IE installed on the target machine
p33813
aVThere can only be one, IE doesn't support side-by-side installation of versions
p33814
aVYou don't know for a fact your app will work without issue unless you test it on different machines that have versions 6, 7 and 8 installed
p33815
aVThis is normally the burden of the web site author
p33816
as(dp33817
g9
V17034
p33818
stp33819
a((dp33820
g2
(lp33821
VClearly the machine code the JIT compiler can generate for the first case is much more efficient
p33822
aVOne rule that really helps there is that an object can only be unboxed to a variable that has the same type as the boxed value
p33823
aVThat allows the JIT compiler to generate very efficient code, no value conversions have to be considered
p33824
aVThe is operator test is easy, just check if the object isn't null and is of the expected type, takes but a few machine code instructions
p33825
aVThe cast is also easy, the JIT compiler knows the location of the value bits in the object and uses them directly
p33826
aVNo copying or conversion occurs, all machine code is inline and takes but about a dozen instructions
p33827
aVThis needed to be really efficient back in
p33828
aVNET 1
p33829
aV0 when boxing was common
p33830
aVCasting to int
p33831
aVtakes a lot more work
p33832
aVThe value representation of the boxed integer is not compatible with the memory layout of
p33833
aVA conversion is required and the code is tricky due to possible boxed enum types
p33834
aVThe JIT compiler generates a call to a CLR helper function named JIT_Unbox_Nullable to get the job done
p33835
aVThis is a general purpose function for any value type, lots of code there to check types
p33836
aVAnd the value is copied
p33837
aVHard to estimate the cost since this code is locked up inside mscorwks
p33838
aVdll, but hundreds of machine code instructions is likely
p33839
aVThe Linq OfType() extension method also uses the is operator and the cast
p33840
aVThis is however a cast to a generic type
p33841
aVThe JIT compiler generates a call to a helper function, JIT_Unbox() that can perform a cast to an arbitrary value type
p33842
aVI don't have a great explanation why it is as slow as the cast to , given that less work ought to be necessary
p33843
aVI suspect that ngen
p33844
aVexe might cause trouble here
p33845
as(dp33846
g9
V17034
p33847
stp33848
a((dp33849
g2
(lp33850
VThere is only one option available in VS to get output in a different window: Tools + Options, Debugger, General, "Redirect all Output Window text to the Immediate Window"
p33851
aVThat however is not likely to do what you want it to do
p33852
aVThere are no good options available to get output into a VS window
p33853
aVThe only mechanism is the Windows OutputDebugString() API function which lets the debugger see messages
p33854
aVThat's already being used by the DefaultTraceListener
p33855
aVThe Visual Studio hosting process supports redirecting Console
p33856
aVWrite/Line() output to the Output window
p33857
aVThe mechanism by which it works is unclear to me, other than that the hosting process is a custom hosted version of the CLR
p33858
aVNot something you'd want tackle, assuming it is even possible to replace it
p33859
aVBy far the most practical approach is to simply create your own window to display trace output, using your own trace listener
p33860
aVEasy enough to do with a Windows Forms form class that contains a multiline TextBox
p33861
aVHow practical that is depends on the nature of your main EXE
p33862
aVOr trace to a file and use a file viewer that's smart enough to see updates to the file
p33863
aVI use Far
p33864
aVOh, and there's SysInternals' DebugView utility
p33865
aVIt snoops on OutputDebugString() text
p33866
as(dp33867
g9
V17034
p33868
stp33869
a((dp33870
g2
(lp33871
VNo happy answers here
p33872
aVThe URL element is there only for F1 help
p33873
aVThe Assembly element must be a simple name or a fully qualified assembly name
p33874
aVThe bigger obstacle is that the  element still has not been implemented in the C# IDE
p33875
aVIt is the subject of this old feedback item
p33876
aVIt is closed as "Postponed" which offers some hope that this will actually work some day
p33877
aVThey may actually make absolute path names work
p33878
aVAdd your vote to the feedback item, they do pay attention to that
p33879
as(dp33880
g9
V17034
p33881
stp33882
a((dp33883
g2
(lp33884
VWell, you've got a Big Problem
p33885
aVThat exception is raised by the CLR when it detects that the garbage collected heap integrity is compromised
p33886
aVHeap corruption, the bane of any programmer that ever wrote code in an unmanaged language like C or C++
p33887
aVThose languages make it very easy to corrupt the heap, all it takes is to write past the end of an array that's allocated on the heap
p33888
aVOr using memory after it has been released
p33889
aVOr having a bad value for a pointer
p33890
aVThe kind of bugz that managed code was invented to solve
p33891
aVBut you are using managed code, judging from your question
p33892
aVWell, mostly, your code is managed
p33893
aVBut you are executing lots of unmanaged code
p33894
aVAll the low-level code that actually makes a HttpWebRequest work is unmanaged
p33895
aVAnd so is the CLR, it was written in C++ so is technically just as likely to corrupt the heap
p33896
aVBut after over four thousand revisions of it, and millions of programs using it, the odds that it still suffers from heap cooties are very small
p33897
aVThe same isn't true for all the other unmanaged code that wants a piece of HttpWebRequest
p33898
aVThe code you don't know about because you didn't write it and isn't documented by Microsoft
p33899
aVYour firewall
p33900
aVYour virus scanner
p33901
aVYour company's Internet usage monitor
p33902
aVLord knows whose "download accelerator"
p33903
aVIsolate the problem, assume it is neither your code nor Microsoft's code that causes the problem
p33904
aVAssume it is environmental first and get rid of the crapware
p33905
aVFor an epic environmental FEEE story, read this thread
p33906
as(dp33907
g9
V17034
p33908
stp33909
a((dp33910
g2
(lp33911
VThis string is retrieved from the HKCR\u005cCLSID{guid}\u005cInfoTip registry value
p33912
aVHow to whack the registry into shape is explained very well in this MSDN Library article, not much I can add to that
p33913
as(dp33914
g9
V17034
p33915
stp33916
a((dp33917
g2
(lp33918
VThe notion of "copying" attributes is out
p33919
aVHowever, you can do something meaningful in the code that checks if the attribute is applied
p33920
aVYou could use another attribute that tells the code that it should use another type to verify for the [Required] attribute
p33921
aVFor example:
p33922
aVWhich you'd use like this:
p33923
aVThe code that checks for the attribute could look like this:
p33924
aVNote how this code allows the attribute provider to be chained
p33925
as(dp33926
g9
V17034
p33927
stp33928
a((dp33929
g2
(lp33930
VExactly what it says, a button wants a bitmap, not an icon
p33931
aVYou can use Icon
p33932
aVToBitmap() but the resulting bitmap usually looks pretty bad
p33933
aVUse a good image editor to get a better result, Visual Studio has one
p33934
aVAdd the resulting bitmap to your resources
p33935
as(dp33936
g9
V17034
p33937
stp33938
a((dp33939
g2
(lp33940
VRegex is not the right choice here
p33941
aVYou ultimate do need to convert a string to a date or time
p33942
aVUse DateTime
p33943
aVTryParse() so you are always sure that if the validation allows it then the conversion will work as well
p33944
as(dp33945
g9
V17034
p33946
stp33947
a((dp33948
g2
(lp33949
VYour bigger concern here should be reliability
p33950
aVIf you use worker processes instead of threads, especially when those processes run on other machines, the odds for failure significantly increase
p33951
aVThat kind of failure can be very difficult to deal with, it is hard to recover from a process dying on an unhandled exception or somebody tripping over a power cord
p33952
aVAvoid committing to an architecture that significantly complicates the code but might never actually be used
p33953
aVThis will be much easier to do when you use threads
p33954
aVThat can still scale in the long run, many-core CPUs are the future
p33955
aVWCF is otherwise the correct technology to use
p33956
as(dp33957
g9
V17034
p33958
stp33959
a((dp33960
g2
(lp33961
VThat's the job of an IL verifier
p33962
aVPEVerify
p33963
aVexe in the Windows SDK's bin directory
p33964
aVIt verifies the IL in the method bodies and flags unsafe IL
p33965
aVPointers, mostly
p33966
aVYou'll get a fairly big list if you let it loose on the system
p33967
aVdll assembly
p33968
aVNote that it refuses to verify mscorlib
p33969
aVdll, you're pretty stuck if that's the one you care about
p33970
aVCopying and renaming it doesn't help
p33971
as(dp33972
g9
V17034
p33973
stp33974
a((dp33975
g2
(lp33976
VYes, no problem
p33977
aVYou'll get a different IAsyncResult for each call to BeginInvoke()
p33978
aVThere's no state associated with the started thread in the delegate object itself
p33979
as(dp33980
g9
V17034
p33981
stp33982
a((dp33983
g2
(lp33984
VHere's a small test program that you can use to discover installed voices:
p33985
aVOutput on my machine: Microsoft Anna - English (United States)
p33986
aVWhich is the one and only default voice that's shipped with Windows afaik
p33987
aVWhich would of course explain why changing gender and age doesn't have an effect on your machine
p33988
as(dp33989
g9
V17034
p33990
stp33991
a((dp33992
g2
(lp33993
VNo such guarantee is documented, albeit that it is likely
p33994
aVYou are supposed to use CObject::IsKindOf()
p33995
as(dp33996
g9
V17034
p33997
stp33998
a((dp33999
g2
(lp34000
VUse the System::Media::SoundPlayer class instead
p34001
aVIt has a Stream property, assign your "s" variable to it, then call the Play() method
p34002
as(dp34003
g9
V17034
p34004
stp34005
a((dp34006
g2
(lp34007
VThere have been recent updates to ILMerge to fix several VS2010 compatibility problems
p34008
aVAnd there's a new command line option to target
p34009
aVNET 4
p34010
ag2512
aVDownload the latest and greatest
p34011
as(dp34012
g9
V17034
p34013
stp34014
a((dp34015
g2
(lp34016
VYou need to tell the linker to link the C runtime library as well as the Windows kernel32
p34017
aVlib and user32
p34018
aVlib import libraries
p34019
aVThe latter two require the Windows SDK to be installed
p34020
aVThe compiler you are using is pretty obscure
p34021
aVYou'll need to read the small print in its manuals to figure out how to configure it properly so that the linker links those libraries
p34022
aVIf you cannot sort this out by yourself or find somebody familiar with this IDE, I'd recommend you download the free Microsoft Visual Studio Express C++ edition
p34023
aVIt takes care of a lot of those gritty details with project templates that presets a lot of compiler and linker settings
p34024
aVYou'd want the Win32 Console Application template
p34025
as(dp34026
g9
V17034
p34027
stp34028
a((dp34029
g2
(lp34030
VThat's not going to fly
p34031
aVThere's a rather serious impedance mismatch between the classes in the System
p34032
aVCodeDom, like CodeStatement et al, and the structure of a native C++ program
p34033
aVThere's no way to model something as basic as a non-class member function, not supported in managed code
p34034
aVOr the notion of #including header files
p34035
aVOr single-pass compilation
p34036
aVEtcetera
p34037
as(dp34038
g9
V17034
p34039
stp34040
a((dp34041
g2
(lp34042
VYes, no problem
p34043
aVIt is actually somewhat documented but hard to find
p34044
aVThe MSDN docs for the C++ libraries aren't great
p34045
aVIt returns an interior pointer, that's not suitable for conversion to a const wchar_t* yet
p34046
aVYou have to pin the pointer so the garbage collector cannot move the string
p34047
aVUse pin_ptr<> to do that
p34048
aVYou can use Marshal::StringToHGlobalUni() to create a copy of the string
p34049
aVUse that instead if the wchar_t* needs to stay valid for an extended period of time
p34050
aVPinning objects too long isn't very healthy for the garbage collector
p34051
as(dp34052
g9
V17034
p34053
stp34054
a((dp34055
g2
(lp34056
VIt isn't documented anywhere that I know of, but yes, you can safely assume so
p34057
aVIt would be quite disruptive if it didn't, daylight transitions happen twice a year
p34058
aVIt is documented for the equivalent kernel function, KeDelayExecutionThread's Interval argument:
p34059
aVSpecifies the absolute or relative time, in units of 100 nanoseconds, for which the wait is to occur
p34060
aVA negative value indicates relative time
p34061
aVAbsolute expiration times track any changes in system time; relative expiration times are not affected by system time changes
p34062
as(dp34063
g9
V17034
p34064
stp34065
a((dp34066
g2
(lp34067
VWell, the MSDN article you linked explains it clearly: you cannot prevent Windows from shutting down if your app is running on Vista or Win7
p34068
aVPrompting the user is not going to work, the dialog will be inaccessible
p34069
aVYou will have to consider an app design that deals with this
p34070
as(dp34071
g9
V17034
p34072
stp34073
a((dp34074
g2
(lp34075
VIt's not much of a choice
p34076
aVIf you have a solution with both projects then there's no point in not using a project reference
p34077
aVIf your solution doesn't have the project then you have to use an assembly reference
p34078
aVSo the real question should probably be: do I create a solution with both projects
p34079
aVYes, as long as the project is still in the debug stage and liable to require bug fixes
p34080
as(dp34081
g9
V17034
p34082
stp34083
a((dp34084
g2
(lp34085
VOverflow checking is very much a runtime feature, the compiler has little to do with it
p34086
aVMaybe it helps if you take a look at Ecma 335, the standards document that describes what IL opcodes are available
p34087
aVThere are 4 groups of opcodes that have a form that allows for an overflow check:
p34088
aVadd vs add
p34089
aVovf, add two numbers
p34090
aVsub vs sub
p34091
aVovf, subtract two numbers
p34092
aVmul vs mul
p34093
aVovf, multiply two numbers
p34094
aVconv vs conv
p34095
aVovf, convert a 1, 2, 4 or 8 byte integral
p34096
aVAll of these exist in a signed an unsigned variety
p34097
aVThe first 3 are obviously directly related to the corresponding operator
p34098
aVThe conv opcode is generated by a cast in your source code
p34099
aVAll that the C# compiler does when it compiles code bracketed by the checked keyword is to switch to the
p34100
aVovf varieties of these opcodes when it emits the IL
p34101
aVIt is the job of the JIT compiler to actually generate the machine code that performs the overflow check
p34102
aVSome behavior might be evident from this:
p34103
aVthe checked keyword has no effect on literals, their value is directly evaluated by the compiler and produces no IL
p34104
aVThis could technically be done but the compiler currently doesn't do this
p34105
aVNot great but too breaking to get fixed today
p34106
aVthe conv
p34107
aVr4 opcode that double to float has no
p34108
aVovf version, only integral conversions have them
p34109
aVAvoid thinking of "integrals" in the mathematical sense
p34110
aVIn compiler terms it means "integer type"
p34111
as(dp34112
g9
V17034
p34113
stp34114
a((dp34115
g2
(lp34116
VThe Control
p34117
aVInvoke() method doesn't consume any handles
p34118
aVHowever, this code is clearly called from a thread
p34119
aVA Thread does consume handles, 5 of them
p34120
aVThe Thread class doesn't have a Dispose() method, although it ought to have one
p34121
aVThat was probably by design, it would be very difficult to call reliably, impossibly so for threadpool threads
p34122
aVThe 5 handles that a thread requires are released by the finalizer
p34123
aVYour program will require ever increasing amounts of handles if the finalizer never runs
p34124
aVNot getting the finalizer to run is quite unusual
p34125
aVYou would have to have a program that starts a lot of threads but doesn't allocate a lot of memory
p34126
aVThis tends to only happen in static tests
p34127
aVYou can diagnose this condition with Perfmon
p34128
aVexe, use the
p34129
aVNET memory performance counters and check if gen #0 collections are being done
p34130
aVIf this happens in a production program then you'll have to call GC
p34131
aVCollect() yourself to avoid a runaway handle leak
p34132
as(dp34133
g9
V17034
p34134
stp34135
a((dp34136
g2
(lp34137
VThat's a 90% no, the debugger in VS2010 was changed pretty dramatically
p34138
aVI got slapped any time I tried to mix and match, although I never tried it with the remote debugger
p34139
aVThat half hour you waited for this answer should have been enough to explore the 10% chance
p34140
aVLet us know what you found out, that's sorta the point of this web site
p34141
as(dp34142
g9
V17034
p34143
stp34144
a((dp34145
g2
(lp34146
VYes, no problem
p34147
aVClick on the control, Ctrl+X to cut it to the clipboard
p34148
aVClick on the 2nd toolstrip, Ctrl+V to paste it from the clipboard
p34149
as(dp34150
g9
V17034
p34151
stp34152
a((dp34153
g2
(lp34154
VYou need to pass a pointer to the value member to keep scanf() happy
p34155
aVFix:
p34156
aVPerhaps one lesson to learn from this is to never mix up data entry code with data structure modification code
p34157
aVBtw: please don't use unnecessary parentheses
p34158
aVYou'll never learn the precedence rules if you do
p34159
as(dp34160
g9
V17034
p34161
stp34162
a((dp34163
g2
(lp34164
VUnfortunately, creating easily recognizable UI components that don't leave the user guessing what just popped up is considered an asset, not a liability
p34165
aVMy mom thinks so anyway
p34166
aVYou certainly can do something else, the "popup toaster" window was popular for a while
p34167
aVYou'll get no help from NotifyIcon, just create your own topmost form
p34168
aVAnything goes
p34169
aVI wrote some code for this thread, might be helpful
p34170
as(dp34171
g9
V17034
p34172
stp34173
a((dp34174
g2
(lp34175
VNot a problem
p34176
aVNET 4
p34177
aV0 is the first version in a long time that installs side-by-side with previous versions of the framework
p34178
aVNET 2
p34179
aV0 was previous-to-last one that supported this, installing
p34180
aVNET 3
p34181
aV0 or 3
p34182
aV5 would replace it
p34183
aVAlthough the term "improve it" would be more appropriate
p34184
as(dp34185
g9
V17034
p34186
stp34187
a((dp34188
g2
(lp34189
VThat's a bit strange
p34190
aVThe point of creating a control is to have something visible in the UI, something the user can interact with
p34191
aVUseless controls should be readily apparent in the UI
p34192
aVIf that's not clearly observable from the UI then these controls either set their Visible property to false or their Location property to a value to keeps it out of view
p34193
aVSomething to look for
p34194
aVThe only other way you've got is to open the Designer
p34195
aVcs file, located the list of control variable names and right-click them one by one
p34196
aVSelect "Find all references" and if you don't see a source code file listed other than the designer file listed then it might be a candidate for deletion
p34197
aVYou next have to check their event handlers, same way
p34198
as(dp34199
g9
V17034
p34200
stp34201
a((dp34202
g2
(lp34203
VWell, what do you prefer
p34204
aVDo you want to use a library that has been put to the test by billions of hack attacks, found wanting but patched up
p34205
aVOr do you prefer some obscure library that hasn't been exposed to such attacks
p34206
aVYet
p34207
aVThere is zero security in obscurity
p34208
as(dp34209
g9
V17034
p34210
stp34211
a((dp34212
g2
(lp34213
V"Shutdown" asks for a Windows shutdown without turning off the power
p34214
aVAdditional docs are available with the MSDN Library article for ExitWindowsEx()
p34215
aVNote how the flag values are a one-to-one mapping with the WMI method flags
p34216
aVNot an accident
p34217
as(dp34218
g9
V17034
p34219
stp34220
a((dp34221
g2
(lp34222
VYou will need to set a WH_MOUSE_LL mouse hook with SetWindowsHookEx() so that you can monitor the mouse messages regardless of which program has the focus
p34223
aVSample C# code is available here
p34224
aVExtend the MouseMessages declaration to add the messages generated for your extra mouse messages
p34225
aVThe middle button down message is 0x207, X-button is 0x20b
p34226
aVYou may have to experiment a bit to see what message is actually generated for your mouse
p34227
aVFrom there, simply jump the cursor by assigning the Cursor
p34228
aVPosition property
p34229
aVThe Screen class gives you the location of the screens
p34230
aVDon't buy a 3rd monitor
p34231
as(dp34232
g9
V17034
p34233
stp34234
a((dp34235
g2
(lp34236
VIt is simply an ulong in C#, no need to jump through the LayoutKind
p34237
aVExplicit hoop
p34238
aVThe union was necessary because C and C++ compilers didn't have a native 64-bit type in the olden days
p34239
as(dp34240
g9
V17034
p34241
stp34242
a((dp34243
g2
(lp34244
VThat's because you use the
p34245
aVNET 4
p34246
aV0 version of gacutil
p34247
aVexe
p34248
aVIt stores the assembly in a different GAC, the one in c:\u005cwindows\u005cmicrosoft
p34249
aVnet\u005cassembly
p34250
aVWhere all
p34251
aVNET 4
p34252
aV0 assemblies are stored
p34253
aVThere is no shell extension handler for that one, the folders are visible as-is
p34254
aVYou can have a look-see with Windows Explorer,
p34255
aVyou'll see the internal structure of the GAC folders
p34256
aVYou shouldn't have any trouble finding your assembly back, the GAC isn't particularly complicated
p34257
aVIf the assembly is intended to be used by an app that targets an earlier version of
p34258
aVNET then you should use the
p34259
aVNET 2
p34260
aV0 version of gacutil
p34261
aVexe, stored in C:\u005cProgram Files\u005cMicrosoft SDKs\u005cWindows\u005cv6
p34262
aV0A\u005cbin
p34263
as(dp34264
g9
V17034
p34265
stp34266
a((dp34267
g2
(lp34268
VMenuStrip is a complete rewrite of the MainMenu component
p34269
aVIt doesn't rely on the stock implementation of menus as provided by Windows, allowing you to customize the menu look-and-feel to a much larger degree
p34270
aVBy popular demand, that answers the "what were they thinking" question
p34271
aVToolStrip was a similar replacement for ToolBar
p34272
aVThere is no compelling reason to stop using MainMenu if you prefer the way it works
p34273
aVSomething that drives UI designer nuts about MenuStrip is that it doesn't faithfully reproduce the new menu theme in Windows 7, MainMenu does since it leaves the rendering up to Windows
p34274
aVSimply add the MainMenu component back to the toolbox
p34275
aVRight-click it, Choose Items
p34276
as(dp34277
g9
V17034
p34278
stp34279
a((dp34280
g2
(lp34281
VThere are no set thresholds, they dynamically change as the garbage collector learns more about the program's allocation pattern
p34282
aVThere is no way for you to discover the current threshold, nor to change it
p34283
aVFrom casual observation, it appears workstation GC starts out with a 2 megabyte gen 0 heap
p34284
aVWhich can grow to over 8 megabytes
p34285
aVServer GC is quite different from workstation, it normally uses larger thresholds and multiple threads to collect garbage
p34286
aVAgain, nothing you could discover, other than by observing the performance counters in Perfmon
p34287
aVexe
p34288
as(dp34289
g9
V17034
p34290
stp34291
a((dp34292
g2
(lp34293
VWrong kind of tool, Expression Encoder is a transcoder
p34294
aVIt requires a video format as input and encodes it to a different output format
p34295
aVYou'll need to create a video of the screen first
p34296
aVCapturing a screen shot is easy enough, Graphics
p34297
aVCopyFromScreen() can do that
p34298
aVGenerating a video would require doing this repeatedly and writing to a simple format like AVI
p34299
aVThe code here could help
p34300
aVDoing this fast enough so you capture enough frames per second is the ultimate challenge
p34301
aVIf that was easy then the companies that sell Jingo and Camtasia would quickly be out of business
p34302
as(dp34303
g9
V17034
p34304
stp34305
a((dp34306
g2
(lp34307
VThis looks like a very webby kind of question, I'll assume you are talking about ComboBox
p34308
aVYes, there's something you can do with its DrawMode property
p34309
aVWhen you set it to OwnerDrawFixed then you can implement a DrawItem event handler and draw the dropdown items just the way you want them
p34310
aVThere's a very good example in the MSDN Library topic for that event
p34311
aVYou'll need to do extra work to also get it displayed properly in the text box portion of the combo box
p34312
aVShouldn't be a problem, you don't need columns for that
p34313
aVPerhaps you can separate the items with a distinctive character, one that you can also use in your DrawItem event to find the column text back
p34314
as(dp34315
g9
V17034
p34316
stp34317
a((dp34318
g2
(lp34319
VI see few happy answers here
p34320
aVThe notion of an app using 12 year old technology needing to install updates is an odd one and just not well supported on modern machines
p34321
aVA common solution like reg-free COM is out, I think, not compatible with COM+
p34322
aVIt is also pretty strange that a bug-fix style update would need to re-register components
p34323
aVHave you verified that this is actually required
p34324
aVExtending on that theme, how often do you actually change GUIDs in deployments
p34325
aVTaking charge of the registration yourself rather than leaving it up to the components themselves should be workable when the keys don't constantly change
p34326
aVCould be as easy as capturing the registration with SysInternals' ProcMon utility, compose a
p34327
aVreg file that sets HKCU keys instead
p34328
aVBeyond that, you really do need to gain the right to registry keys that are not writable
p34329
aVIf you can't get the okay from the customer then consider asking for a scheduled task that installs updates
p34330
aVThey can get access, provided the sys admin allows it
p34331
as(dp34332
g9
V17034
p34333
stp34334
a((dp34335
g2
(lp34336
VReference immutability is a popular feature request
p34337
aVToo bad its is so dramatically non CLS compliant
p34338
aVVery few languages have this notion, I only know of C++ (but don't get out much)
p34339
aVThe key problem that this needs to be enforced by the CLR
p34340
aVC++ doesn't need to enforce this at runtime, only a C++ compiler is required to ensure that const contracts are observed
p34341
aVIt has no support at all for language interop, beyond a bolt-on like COM
p34342
aVThis won't fly in
p34343
aVNET, there's little point in declaring a reference immutable and have that verified by the compiler when another language can stomp all over it because it doesn't have the syntax to express immutability
p34344
aVI reckon we'll get it some day, not Real Soon
p34345
as(dp34346
g9
V17034
p34347
stp34348
a((dp34349
g2
(lp34350
V"Calling a form" doesn't mean anything, I guess you'd only want to Show() it
p34351
aVCreating a form on a worker thread is never a good idea
p34352
aVEven if you do get the thread state right (STA and message loop), you'll have hard-to-solve Z-order and modality problems
p34353
aVSimply use Control
p34354
aVInvoke to run code on the UI thread
p34355
aVIt should create the form and call its Show() method
p34356
as(dp34357
g9
V17034
p34358
stp34359
a((dp34360
g2
(lp34361
VSetting up a page to generate a STATUS_GUARD_PAGE_VIOLATION with VirtualProtectEx() and the PAGE_GUARD flag is a documented procedure
p34362
aVThe exception can be generated only once for a page so there's no danger you'll die while processing the exception
p34363
aVI don't do anything special for the exception but that doesn't proof too much, getting this exception would be extraordinarily rare
p34364
aVNever seen it once in any of our crash reports
p34365
aVThe feature is really meant for generating stack overflow exceptions
p34366
aVWhich you really do need to handle specially since you have so little stack left
p34367
aVI assume that's where the warning came from that you mention in your question
p34368
aVIt will however never generate a page guard exception, that's handled at kernel level before getting translated to a stack overflow
p34369
as(dp34370
g9
V17034
p34371
stp34372
a((dp34373
g2
(lp34374
VEven Regex might be overkill, although it certainly will get the job done
p34375
aVIt is a very simple text format to parse, string
p34376
aVStartsWith() and string
p34377
aVIndexOf() to find the colon would work well
p34378
as(dp34379
g9
V17034
p34380
stp34381
a((dp34382
g2
(lp34383
VYou can parse it with DateTimeOffset
p34384
aVFor example:
p34385
aVOutput: 1/11/2009 1:18:44 AM
p34386
as(dp34387
g9
V17034
p34388
stp34389
a((dp34390
g2
(lp34391
VThis can be a disadvantage of a UserControl
p34392
aVYou have to re-publish the events and the properties of one or more of its embedded controls
p34393
aVConsider the alternative: if this UserControl only contains a ListBox then you are much better off simply inheriting from ListBox instead of UserControl
p34394
aVAnyhoo, you'll need to re-fire the SelectedIndexChanged event
p34395
aVAnd surely you'll need to be able to let the client code read the currently selected item
p34396
aVThus:
p34397
as(dp34398
g9
V17034
p34399
stp34400
a((dp34401
g2
(lp34402
VWindows time stamps are always recorded in UTC
p34403
aVThey will only be converted to local time in whatever GUI program you use to look at the data, like Event Viewer or Explorer (for file times)
p34404
aVThis behavior is important to avoid random failure on daylight saving time transitions
p34405
as(dp34406
g9
V17034
p34407
stp34408
a((dp34409
g2
(lp34410
VHashing tables are amortized O(1) for lookup
p34411
aVCan't do better than that, O(1/n) algorithms are perpetual motion devices
p34412
aVThere are only two things that make them behave poorly:
p34413
aVA poor hashing function that causes many collisions
p34414
aVThe worst one will degenerate lookup to O(n)
p34415
aVYou'll have no trouble with strings, they hash really well
p34416
aVString
p34417
aVGetHashCode() does a terrific job
p34418
aVA collection that is heavily mutated with many removed items that were added early
p34419
aVThis can causes many empty hash buckets that need to be skipped by iterators
p34420
aVDegradation to O(n) is technically possible although quite rare
p34421
aVA simple workaround is to rebuild the collection by reassigning the reference (like table = new HashSet(table); )
p34422
aVThese kind of problems are rare
p34423
aVYou don't design for them up front (other than the hash function), you start considering them only when you detect perf problems with the program
p34424
as(dp34425
g9
V17034
p34426
stp34427
a((dp34428
g2
(lp34429
VThis is standard behavior for the Window
p34430
aVShowDialog() call
p34431
aVOther windows will be disabled
p34432
as(dp34433
g9
V17034
p34434
stp34435
a((dp34436
g2
(lp34437
VNo problem getting a repro for this simply by setting the properties from the PropertyGrid
p34438
aVBehaves this way both in Win7 and Windows XP
p34439
aVThis is broken behavior documented in this feedback article
p34440
aVAs indicated, Microsoft is not considering a fix
p34441
aVOne possible workaround is to disable autocomplete in a DropDown event handler and re-enable it in a DropDownClosed event handler
p34442
as(dp34443
g9
V17034
p34444
stp34445
a((dp34446
g2
(lp34447
VYou are doing everything right as near as I can tell
p34448
aVVerify your assumptions by running Dumpbin
p34449
aVexe /exports on the DLL
p34450
aVThat shows the actual name of the exported function, it has to match the Alias in the VB6 declaration
p34451
aVThe only other failure mode I can think of is VB6 loading the wrong DLL
p34452
aVIt has to be present in a directory listed on the PATH if you want to use it from the VB6 IDE
p34453
aVVerify by running "where gpib-32
p34454
aVdll" from the command line
p34455
as(dp34456
g9
V17034
p34457
stp34458
a((dp34459
g2
(lp34460
VThat's not the way it works
p34461
aVAny thread in a managed program can execute managed code, including ones that were originally started as an unmanaged thread
p34462
aVWhich most are, the main thread and any threadpool thread starts life executing purely unmanaged code
p34463
aVIt thunks into managed code though the kind of gateway provided by Marshal
p34464
aVGetDelegateForFunctionPointer()
p34465
aVSeeing dozens of (otherwise inactive) threads is not unusual
p34466
aVThey typically are threadpool threads and threads started by COM servers
p34467
aVNET is missing the plumbing you'd need to use Thread
p34468
aVManagedThreadId on those threads
p34469
aVThat's intentional, a logical
p34470
aVNET thread doesn't have to be a physical operating system thread
p34471
aVAlthough there's no host in current use where that's not the case
p34472
aVYou will have to avoid having to ask the question
p34473
as(dp34474
g9
V17034
p34475
stp34476
a((dp34477
g2
(lp34478
VI need to remove an item in that enumerator
p34479
aVAs long as this is a single item that's not a problem
p34480
aVThe rule is that you cannot continue to iterate after modifying the collection
p34481
aVThus:
p34482
as(dp34483
g9
V17034
p34484
stp34485
a((dp34486
g2
(lp34487
VThey are in msvcr90
p34488
aVdll
p34489
aVDon't forget that these are C++ operators, the name mangling algorithm does quite a job on them
p34490
aVCopied from the dumpbin /exports output:
p34491
aVI used the undname
p34492
aVexe utility to convert the mangled name back
p34493
aVThere are several overloads present as well
p34494
as(dp34495
g9
V17034
p34496
stp34497
a((dp34498
g2
(lp34499
VThe AddRange() call is wrong, you want to pass a negative value so you'll get the remainder of the file
p34500
aVFrom the MSDN Library article:
p34501
aVIf range is positive, the range is from the start of the data to range
p34502
aVIf range is negative, the range is from range to the end of the data
p34503
aVI can't see how EndPosition is being initialized, that could be wrong too
p34504
as(dp34505
g9
V17034
p34506
stp34507
a((dp34508
g2
(lp34509
VThis is only relevant in VS2010
p34510
aVThere is only one version present of the
p34511
aVNET assemblies for
p34512
aVNET 2
p34513
aV0 through 3
p34514
aV5SP1
p34515
aVYour project will simply reference the one and only version of such an assembly
p34516
aVThe Framework Target setting just prevents you from adding references to assemblies that are not present in the selected version
p34517
aVThat's very different in VS2010 since it supports
p34518
aVNET 4
p34519
ag2512
aVThat is a version that can be installed side-by-side with previous versions of
p34520
aVNET
p34521
aVYour list of assembly reference now do change if you select between
p34522
aVNET 4
p34523
aV0 and an earlier version in your Framework Target setting
p34524
aVIt is subtle, only the Version property in the Property Grid changes
p34525
as(dp34526
g9
V17034
p34527
stp34528
a((dp34529
g2
(lp34530
VTechnically: yes
p34531
aVPractically: no
p34532
aVIDirectSound8 is a COM interface, they are very conveniently wrapped in
p34533
aVNET with a interop library
p34534
aVAn RCW
p34535
aVThat RCW manages the reference counts on the underlying COM coclass object
p34536
aVAn RCW does not implement IDisposable, even though it very much hangs on to an unmanaged resource
p34537
aVThe reason it doesn't is because it is almost impossible to implement IDisposable correctly
p34538
aVA COM coclass implements multiple interfaces, creating one adds to the reference count
p34539
aVYou would have to be 100% sure that all of those interface pointers are no longer in use before a dispose would be safe
p34540
aVThat's very hard to do, those pointers get created in unexpected ways
p34541
aVLike using an indexed property of one of the interfaces, the intermediate interface pointer is never visible in your code
p34542
aVThis is not a real problem, the garbage collector takes care of the reference counts, the finalizer gets the job done
p34543
aVIt is just that it takes a bit longer for the object to be released
p34544
aVStandard GC behavior
p34545
aVUnfortunately out-of-process COM servers have observable side-effects, programmers tend to get annoyed when the process doesn't disappear from the TaskMgr processes list at the instant their code stops using the interfaces
p34546
aVMany, many "Excel/Word doesn't quit" questions here and at the forums
p34547
aVIf you want to implement it anyway then you can do so by calling Marshal
p34548
aVFinalReleaseComObject() in your Dispose() implementation
p34549
aVJust beware of the significantly increased risk for failure, getting that call wrong produces very hard to diagnose failure
p34550
aVNot quite unlike deleting an object in native code and still having a pointer to it
p34551
aVIf it is actually a "heavy" object that must be released instantly then GC
p34552
aVCollect() + GC
p34553
aVWaitForPendingFinalizers() gets the job done too with much less risk of getting it wrong
p34554
aVWith side-effects of course
p34555
as(dp34556
g9
V17034
p34557
stp34558
a((dp34559
g2
(lp34560
VThat's fine but you have to move this statement to the constructor
p34561
aVDouble-buffering requires setup, Windows Forms has to create a buffer, that must be done before the paint event runs
p34562
aVThe constructor is ideal
p34563
as(dp34564
g9
V17034
p34565
stp34566
a((dp34567
g2
(lp34568
VThat error is 0x80070005 in hex
p34569
aVFacility 7 = Windows, error code 5 = Access Denied
p34570
aVThe user account used to run this code doesn't have sufficient rights
p34571
aVCreating scheduled tasks is a privileged operation
p34572
aVTalk to the server admin about getting the rights to do this
p34573
as(dp34574
g9
V17034
p34575
stp34576
a((dp34577
g2
(lp34578
VYes, it is the default packing of 8 which moves the ullArgument member up to get it aligned properly
p34579
aVThere are 4 padding bytes there to get it from offset 28 to 32
p34580
aVAnd 4 padding bytes at the end to ensure that an array of structures still has that member aligned properly
p34581
as(dp34582
g9
V17034
p34583
stp34584
a((dp34585
g2
(lp34586
VThat's already the default behavior for a WH_KEYBOARD_LL hook
p34587
aVThe callback is called in the same thread that called SetWindowsHookEx()
p34588
aVThat thread must also pump a message loop for this to work properly, automatic when you use your UI thread
p34589
aVAnd the callback code doesn't need to be present in a DLL either, it is not a global hook that requires DLL injection
p34590
aVNo extra work needs to be done
p34591
as(dp34592
g9
V17034
p34593
stp34594
a((dp34595
g2
(lp34596
VPreventing a control from redrawing is fairly pointless
p34597
aVYou'll get a hole where a control was supposed to appear, your user won't have any use for that hole
p34598
aVIt redraws slowly simply because you have too many controls
p34599
aVYou can only get it to redraw faster by using less controls
p34600
aVOr by using controls that can display multiple items in one window, like ListBox, ListView, TreeView, DataGridView
p34601
aVNote that your specific issue is fixed in Vista and Windows 7
p34602
aVThe Aero theme uses off-screen buffering for windows
p34603
aVWhich means that windows don't need to repaint themselves anymore when they are obscured by another window
p34604
aVYou will however still get slow redraws when the user minimizes the window and restores it
p34605
as(dp34606
g9
V17034
p34607
stp34608
a((dp34609
g2
(lp34610
VIt depends on the assembly in which the base form is declared
p34611
aVIf that's another assembly than the one in which the derived form lives then Friend cannot work
p34612
aVMembers declared Friend are only accessible inside the same assembly
p34613
aVProtected is the proper access modifier here
p34614
aVIt ensures that it doesn't matter in what assembly the derived form is declared
p34615
aVAnd ensures that only derived form classes can access the dataset
p34616
as(dp34617
g9
V17034
p34618
stp34619
a((dp34620
g2
(lp34621
VJust set the form's DoubleBuffered property to true in the constructor or the Properties window
p34622
aVYou have to draw in the Paint event, using CreateGraphics() is never correct
p34623
aVCall Invalidate() or Update() if something happens that would require the window to be repainted
p34624
as(dp34625
g9
V17034
p34626
stp34627
a((dp34628
g2
(lp34629
VThe only program I know is Visual Studio
p34630
aVYou can easily create your own program by using the ResXResourceWriter class
p34631
as(dp34632
g9
V17034
p34633
stp34634
a((dp34635
g2
(lp34636
VForms that have the TransparencyKey or Opacity property set are so-called layered windows
p34637
aVThey are shown using the "overlay" feature of the video adapter
p34638
aVWhich make them being able to have their transparency effects
p34639
aVCapturing them requires turning on the CopyPixelOperation
p34640
aVCaptureBlt option in the CopyFromScreen overload that accepts the CopyPixelOperation argument
p34641
aVUnfortunately, this overload has a critical bug that prevents this from working
p34642
aVIt doesn't validate the value properly
p34643
aVStill not fixed in
p34644
aVNET 4
p34645
ag2512
aVThere is no other good fix but fall back to using P/Invoke to make the screen shot
p34646
aVHere's an example:
p34647
as(dp34648
g9
V17034
p34649
stp34650
a((dp34651
g2
(lp34652
VThe file contains an alternate data stream that indicates that the content was retrieved from the Internet and is not secure
p34653
aVThis is a feature of the NTFS file system, one that's unfortunately well hidden because Explorer has no support for showing their content
p34654
aVYou can see them from the command prompt with the DIR /R command option
p34655
aVAnd type their content with TYPE filename:streamname
p34656
aVAnd delete them with DELETE filename:streamname
p34657
aVOther tricks is to copy the file to a file system that doesn't support alternate data streams, that slices them off the file
p34658
aVA flash drive for example
p34659
aVOr a zip utility
p34660
aVLater versions of Windows, I think starting with Win7, has built-in support for this in Explorer
p34661
aVRight-click the file, Properties and click "Unblock"
p34662
as(dp34663
g9
V17034
p34664
stp34665
a((dp34666
g2
(lp34667
VIt has nothing to do with the Zoom tool
p34668
aVIt is just the only tool that is available for this image format
p34669
aVIt is a documented restriction in the Visual Studio image editor:
p34670
aVUsing the Image Editor, you can view 32-bit images, but you cannot edit them
p34671
aVYou'll have to either use another graphics editor or switch to a 24bpp image format
p34672
as(dp34673
g9
V17034
p34674
stp34675
a((dp34676
g2
(lp34677
VMinimize Visual Studio, you'll find the dialog back
p34678
aVThis is a focus issue, triggered because you display the dialog in the Load event
p34679
aVWhen the dialog closes, there is no window left in your app that can receive the focus
p34680
aVYour Load event hasn't finished running so the app's main window isn't yet visible
p34681
aVWindows has to find a window to give the focus to and will select one from another program
p34682
aVLike Visual Studio
p34683
aVWhen you display the dialog again, it cannot steal the focus back because Visual Studio has acquired it
p34684
aVSo the dialog appears behind Visual Studio's main window, out of view
p34685
aVYou'll have to fix this by allowing your main window to become visible
p34686
aVAnd call dialog
p34687
aVShowDialog(this) to be completely sure
p34688
aVYou could use the Shown event, for example
p34689
as(dp34690
g9
V17034
p34691
stp34692
a((dp34693
g2
(lp34694
VYou can't make this reliable
p34695
aVRichTextBox allows continuous scrolling where only a portion of a line is in view
p34696
aVListBox does not
p34697
aVThe line numbers will not line up with the lines most of the time
p34698
aVUse a real text editor, like ScintillaNET
p34699
aVIt supports showing line numbers
p34700
as(dp34701
g9
V17034
p34702
stp34703
a((dp34704
g2
(lp34705
VThe exported name probably doesn't match what you think it looks like
p34706
aVUse dumpbin
p34707
aVexe /exports on the DLL to see the actual exported name
p34708
aVUse extern "C" to suppress name mangling
p34709
aVAlso, you have to declare this function __stdcall, that's what your Delphi declaration said
p34710
aVThe default is __cdecl
p34711
aVThat will fail when you start passing arguments
p34712
as(dp34713
g9
V17034
p34714
stp34715
a((dp34716
g2
(lp34717
VIt is an out-of-process COM component, that's the problem
p34718
aVCompletely in violation of Windows SDK requirements as laid out in SetParent()
p34719
aVOnce its window gets the focus, the message loop in the acroread
p34720
aVexe process gets all the messages, your message filter cannot see any messages anymore
p34721
aVTechnically it is fixable by using SetWindowsHookEx() to inject a DLL into the process and monitor messages with WH_GETMESSAGE
p34722
aVBut you can't write such a DLL in the C# language
p34723
aVMajor suck, I know
p34724
aVThere never seems to be any lack of it with that program
p34725
as(dp34726
g9
V17034
p34727
stp34728
a((dp34729
g2
(lp34730
VYou can create your own DGV derived class and override the GetClipboardContent() method
p34731
aVWhich allows you to format the string in a way that's compatible with Excel
p34732
aVSomething like this:
p34733
aVUntested
p34734
as(dp34735
g9
V17034
p34736
stp34737
a((dp34738
g2
(lp34739
VYou would paste this into your form's code to use it
p34740
aVThis however permanently disables the close button
p34741
aVDoing it dynamically requires very different code, you have to modify the system menu
p34742
aVPaste this code into your form and use the CloseEnabled property in your logic:
p34743
as(dp34744
g9
V17034
p34745
stp34746
a((dp34747
g2
(lp34748
VCheck out the linker options
p34749
aVLinkers usually have an option to generate a map file
p34750
aVWhich is a list of functions linked into the final image and where they came from
p34751
aVSounds like you are using gcc, use the -map option
p34752
as(dp34753
g9
V17034
p34754
stp34755
a((dp34756
g2
(lp34757
Vit is an awkward target for tool vendors
p34758
aVIn most shops, the help is authored by professional writers that don't have any use for Visual Studio in their day-to-day activities
p34759
aVThird party authoring tools like RoboHelp is their preferred weapon of choice
p34760
aVThe VS2005 SDK tool you probably saw was HelpStudio Lite, a product of Innovasys
p34761
aVThere is no version available that integrates with VS2010 and judging from a forum post they have no intention of releasing one
p34762
aVTheir Document X
p34763
aVproduct however does, sounds like what you ought to take a look at
p34764
aVThe eval version is available for download from here
p34765
as(dp34766
g9
V17034
p34767
stp34768
a((dp34769
g2
(lp34770
VNtCreateFile() is already a user-mode function
p34771
aVThe driver version is ZwCreateFile()
p34772
aVIt is in fact documented, the declaration is available in the winternl
p34773
aVh SDK header file
p34774
aVWhat's missing however is the import library for ntdll
p34775
aVdll, you have to use LoadLibrary and GetProcAddress to get the entrypoint for the function
p34776
aVOther than the trouble of calling it, the usual caveat is that these native API functions can change without notice in the next version of Windows
p34777
as(dp34778
g9
V17034
p34779
stp34780
a((dp34781
g2
(lp34782
VYou do this with events
p34783
aVForm3 should have a public property that exposes the value and an event that it fires when the value changes
p34784
aVForm2 should subscribe to the event so it can track changes
p34785
aVRepeat to let Form1 know
p34786
aVThis de-couples the classes, Form3 doesn't have to know anything about Form2 nor Form1, only that somebody might be interested in the property value
p34787
aVRefactoring these parent form classes cannot break Form3
p34788
aVNote how the Windows Forms control classes work the same way
p34789
as(dp34790
g9
V17034
p34791
stp34792
a((dp34793
g2
(lp34794
VNo such property exists
p34795
aVThere are bigger issues, this also needs to work after you deploy your solution
p34796
aVThe working directory then is not going to be a "solution" directory, there isn't one on the target machine
p34797
aVYou are much better off working from the assumption that the working directory is the same as the EXE directory
p34798
aVThat will be the default both while debugging and on the target machine
p34799
aVYou have full control over the location of the EXE file with a linker setting
p34800
aVAnd you can protect yourself from a shortcut running your program with another working directory by obtaining the EXE directory in your code so you can generate an absolute path
p34801
aVUse GetModuleFileName(), pass NULL to get the path to the EXE file
p34802
aVAnother standard solution is to copy any kind of resources the EXE needs to a folder that's relative from the build output folder
p34803
aVYou do this with a Pre-Build event, make the command line look similar to this:
p34804
aVNote how the /d option ensures that copying is only done if the Testing folder content changed
p34805
as(dp34806
g9
V17034
p34807
stp34808
a((dp34809
g2
(lp34810
VThis behavior is a consequence of the design of IL, the intermediate language generated by all
p34811
aVNET compilers
p34812
aVWhile it supports the short integer types (byte, sbyte, short, ushort), it has only a very limited number of operations on them
p34813
aVLoad, store, convert, create array, that's all
p34814
aVThis is not an accident, those are the kind of operations you could execute efficiently on a 32-bit processor, back when IL was designed and RISC was the future
p34815
aVThe binary comparison and branch operations only work on int32, int64, native int, native floating point, object and managed reference
p34816
aVThese operands are 32-bits or 64-bits on any current CPU core, ensuring the JIT compiler can generate efficient machine code
p34817
aVYou can read more about it in the Ecma 335, Partition I, chapter 12
p34818
aV1 and Partition III, chapter 1
p34819
ag2447
as(dp34820
g9
V17034
p34821
stp34822
a((dp34823
g2
(lp34824
VIt is enabled with WNDCLASSEX
p34825
aVstyle
p34826
aVTurn on the CS_DROPSHADOW style
p34827
aVI think this only works on top-level windows
p34828
as(dp34829
g9
V17034
p34830
stp34831
a((dp34832
g2
(lp34833
VSeveral problems:
p34834
aVYour declaration is wrong, the last 2 parameters are IntPtr, not int
p34835
aVYou should use PostMessage, not SendMessage
p34836
aVYou are sending to the wrong window
p34837
aVThe edit window of Notepad is a child window
p34838
aVYou are forgetting to send WM_KEYUP
p34839
aVThe actual letter you get will depend on the state of the Shift key
p34840
aVThe neck shot: Vista and Win7 UIPI (User Interface Privilege Isolation) prevents a restricted process from injecting messages into an elevated process
p34841
as(dp34842
g9
V17034
p34843
stp34844
a((dp34845
g2
(lp34846
VA COM coclass can implement multiple interfaces but each individual interface must implement a v-table with pointers to all of the methods brought in by its 'base' interfaces
p34847
aVAt a minimum IUnknown
p34848
aVIf it, say, implements IPersistFile then it must provide an implementation of the three IUnknown methods as well as IPersist::GetClassID
p34849
aVAnd the IPersistFile specific methods
p34850
aVWhich happens to match the behavior of most C++ compilers when they implement non-virtual multiple inheritance
p34851
aVThe compiler sets up individual v-tables for each inherited (pure abstract) class
p34852
aVAnd fills it with method pointers so that one common class method implements all methods that the interfaces have in common
p34853
aVIn other words, no matter how many interfaces are implemented, they all are serviced by one class method like QueryInterface, AddRef or Release
p34854
aVExactly the way you'd want it to work
p34855
aVHaving one implementation of AddRef/Release makes reference counting simple to keep the coclass object alive, no matter how many different interface pointers you hand out
p34856
aVQueryInterface is trivial to implement, a simple cast provides the interface pointer to a v-table with the correct layout
p34857
aVVirtual inheritance is not required
p34858
aVAnd most likely would break COM because the v-tables no longer have the required layout
p34859
aVWhich is tricky for any compiler, review the /vm options for the MSVC compiler for example
p34860
aVThat COM so uncannily is compatible with the typical behavior of a C++ compiler is not an accident
p34861
aVBtw, this all hits the fan when a coclass want to implement multiple interfaces that have a method name in common that isn't meant to do the same thing
p34862
aVThat's a pretty big oops and hard to deal with
p34863
aVMentioned in ATL Internals (DAdvise
p34864
aV, I sadly forgot the solution
p34865
as(dp34866
g9
V17034
p34867
stp34868
a((dp34869
g2
(lp34870
VYes, this is expected behavior if you disable all your windows
p34871
aVWindows goes looking for another window to set the focus to and it will select a window of another application if necessary and make that window the foreground window
p34872
aVYour windows will disappear behind it
p34873
aVSetting your form's TopMost property to True is not a real fix, you'll still lose if another application's window is top-most as well
p34874
aVThe real fix is to not set your form's Enable property to False but to disable the controls on that form
p34875
aVEasiest way to do that is to put a panel on that form and move all controls in to it
p34876
aVSet its Dock property to Fill
p34877
aVSet the panel's Enable property to False, all controls will be disabled as well
p34878
aVBut not the window
p34879
aVBtw: don't use UDP for important messages
p34880
as(dp34881
g9
V17034
p34882
stp34883
a((dp34884
g2
(lp34885
VPostThreadMessage is less than ideal here
p34886
aVGetting the thread ID is indeed a problem since your service will have to run more than one thread
p34887
aVOne to implement the service, another to pump a message loop that's required to read the messages
p34888
aVCreateToolHelp32Snapshot() can enumerate the threads but you will still not know which of those two threads is the one that's pumping
p34889
aVUse a named pipe instead
p34890
aVCall CreateNamedPipe() in your service, use message mode and give the pipe a name prefixed with "Global\u005c" so that it is visible in the user session
p34891
aVThe user code can connect to the pipe using the well-known pipe name
p34892
aVYou can send whatever you want across the pipe but you will have to avoid pointers since they won't be valid in the service process
p34893
aVSame kind of problem as the message marshaling
p34894
aVOther possibilities are a socket, very similar to a pipe but using a well-known port number instead of a name, and out-of-process COM
p34895
aVUsing COM is an advantage if you have complex objects that need to be marshaled across the process boundary
p34896
aVAvoid it if you don't have COM skillz though
p34897
as(dp34898
g9
V17034
p34899
stp34900
a((dp34901
g2
(lp34902
VYou cannot access the file directly
p34903
aVCommon Internet protocols like HTTP or FTP require you to download the file, update it locally and send it back
p34904
aVThat's rather tricky to get right if multiple clients are making updates to the file, data loss is impossible to avoid
p34905
aVThe better mouse trap here, if not for security concerns, is to use VPN so the client can tunnel into the local network
p34906
aVYou now only need to make the file available through a network share, the client can open the file as normal with a UNC path (like )
p34907
aVAsk more questions about this at serverfault
p34908
aVcom
p34909
as(dp34910
g9
V17034
p34911
stp34912
a((dp34913
g2
(lp34914
VThe COM interop layer in the CLR already frees the variant after copying its value into an object
p34915
aVEven if you would want to call Marshal
p34916
aVFreeCoTaskMem() you can't, you cannot get a reference to the original variant
p34917
aVYou didn't say how you concluded that you've got a memory leak
p34918
aVDon't use Taskmgr
p34919
aVexe, it will give you the wrong impression
p34920
aVMake sure you've got a real leak by calling this method millions of times in a small test program
p34921
aVIf memory usage doesn't grow without bound and eventually cause OOM then you don't have a real leak
p34922
aVIf it does crash then suspect the COM server of the leak
p34923
aVLike allocating both the string and the array but returning only one of them
p34924
as(dp34925
g9
V17034
p34926
stp34927
a((dp34928
g2
(lp34929
VThe constructor argument is not an alias for the field
p34930
aVIt hides the field name, this code won't work:
p34931
aVBy using the "this
p34932
aVprefix, you can tell the compiler to assign the argument value to the field
p34933
aVIt is a very common pattern, avoids having to come up with another name for the argument
p34934
aVOr do something awkward like prefixing the field name with, say, an underscore
p34935
as(dp34936
g9
V17034
p34937
stp34938
a((dp34939
g2
(lp34940
s(dp34941
g9
V17034
p34942
stp34943
a((dp34944
g2
(lp34945
VI suspect that the Bitmap resolution will override the property
p34946
aVUse Bitmap
p34947
aVSetResolution()
p34948
as(dp34949
g9
V17034
p34950
stp34951
a((dp34952
g2
(lp34953
VThat's not okay, you are copying a pointer instead of the pointed-to value
p34954
aVA deep copy is required
p34955
as(dp34956
g9
V17034
p34957
stp34958
a((dp34959
g2
(lp34960
VFrom the SDK docs:
p34961
aVCreating a Vertical Toolbar
p34962
aVThe key to creating a vertical toolbar
p34963
aVis to include CCS_VERT in the window
p34964
aVstyle, and to set the TBSTATE_WRAP
p34965
aVstyle for each button
p34966
aVEmphasis added
p34967
as(dp34968
g9
V17034
p34969
stp34970
a((dp34971
g2
(lp34972
VDrop the "ref" keywords in the declaration, they are not correct
p34973
aVThat the C++ code doesn't crash with an AV is a bit mysterious
p34974
aVThe [MarshalAs] attribute on the strings is unnecessary
p34975
as(dp34976
g9
V17034
p34977
stp34978
a((dp34979
g2
(lp34980
VTry Tools + Import and Export + Reset
p34981
aVThis will restore the menus to their factory settings
p34982
aVThis may be necessary when you just installed a new version of VS, as in this case, it imports the menus of the previous version of VS so everything looks familiar
p34983
aVThat is not always desirable
p34984
aVIf that doesn't pan out then the next step is to run devenv
p34985
aVexe with the /safemode command line option to ensure this isn't an add-in that's causing problems
p34986
as(dp34987
g9
V17034
p34988
stp34989
a((dp34990
g2
(lp34991
VGacutil
p34992
aVexe won't be available on the target machine
p34993
aVNot a problem, MSI can get the job done
p34994
aVRight-click "File System on Target Machine", Add, GAC
p34995
aVRight-click that added folder, Add, Project Output
p34996
aVThat ensures the assembly is gac-ed
p34997
aVIt can also register the assembly like Regasm
p34998
aVexe does
p34999
aVSet the Register property of the project output reference to vsdrpCOM
p35000
as(dp35001
g9
V17034
p35002
stp35003
a((dp35004
g2
(lp35005
VIf you use SysInternals' ZoomIt utility, you can see that this is simply two lines
p35006
aVA dark gray one above a white one
p35007
aVDrawing lines is simple enough with Graphics
p35008
aVDrawLine(), you just need to make sure you pick a dark color that work well with the form's BackColor
p35009
aVThat isn't always battleship gray if the user selected another theme
p35010
aVWhich makes the GroupBox trick fall flat
p35011
aVThis sample code is serviceable:
p35012
aVNote the use a button1 in this code, there to make sure the line is drawn at the right height, even when the form is rescaled
p35013
aVPick your own control as a reference for the line
p35014
as(dp35015
g9
V17034
p35016
stp35017
a((dp35018
g2
(lp35019
VStrings are immutable, you cannot pass it directly, even if you pin it
p35020
aVMore seriously, you will have to deal with the possibility that the function returns a larger string
p35021
aVThe function is unsafe by design since you cannot prevent it from returning a path string that's too large
p35022
aVNot much you can do about that I suppose, but you will have to use a buffer that's at least large enough for common path strings
p35023
aVThis code will get the job done:
p35024
aVThe curly braces look odd perhaps, it ensures that the managed string doesn't stay pinned for too long
p35025
as(dp35026
g9
V17034
p35027
stp35028
a((dp35029
g2
(lp35030
VYou need to prevent the form from closing
p35031
aVIf you don't, the form will be disposed and becomes unusable
p35032
aVYou can do this by implementing the FormClosing event:
p35033
aVTo make it a singleton, just keep track of the life time of the form in your main form class:
p35034
as(dp35035
g9
V17034
p35036
stp35037
a((dp35038
g2
(lp35039
VIt is kinda interesting how Qt has evolved into an all-compassing framework that makes the programmer that uses it believe that anything that is useful has to start with the letter Q
p35040
aVVery dot-netty
p35041
aVQt is just a class library that runs on top of the language, it doesn't preclude using everyday libraries that get a job done
p35042
aVEspecially when that's a library that has little to do with presenting a user interface, the job that Qt does so well
p35043
aVThere are many libraries that get lexical analysis and parsing done well
p35044
aVThat starts with Lex and Yacc, Flex and Bison next, etcetera
p35045
aVYou only have to Qt enable it for error messages, they readily support that
p35046
as(dp35047
g9
V17034
p35048
stp35049
a((dp35050
g2
(lp35051
VYou do this with a project property sheet
p35052
aVI typed up an answer recently to show how to use them
p35053
as(dp35054
g9
V17034
p35055
stp35056
a((dp35057
g2
(lp35058
VIt is a warning level 4 message, falling in the category "this may byte you in the ass some day"
p35059
aVSupport for calling methods with default parameter values without specifying the value is spotty in the
p35060
aVNET languages
p35061
aVVB
p35062
aVNET always had it, C# just acquired it in version 4
p35063
aVC++/CLI does not support it and surely never will
p35064
aVWhich is notable because the C++ language does support it
p35065
aVA C++/CLI programmer could well be surprised by this, thus the warning
p35066
aVThere isn't much you can do about the warning, the code for the dataset is auto-generated
p35067
aVIt is otherwise utterly benign, if you call the method without supplying a value for the argument with the default value then you'll get a compiler error
p35068
aVJust turn the warning off with #pragma warning(disable:4564) or Project + Properties, C/C++, Advanced, Disable Specific Warnings
p35069
as(dp35070
g9
V17034
p35071
stp35072
a((dp35073
g2
(lp35074
VThis is normal behavior for performance counters
p35075
aVThey are global "objects" that exist even if no process is generating data for them
p35076
aVYou can, for example, select one of the
p35077
aVNET perf counters even if not a single
p35078
aVNET program is running on the machine
p35079
aVIf the counter is actively generating data even if you don't have a process running anymore that updates its value then you may have selected an inappropriate CounterType
p35080
aVReview the InstanceLifetime property to see if the Process value is appropriate for your counter
p35081
as(dp35082
g9
V17034
p35083
stp35084
a((dp35085
g2
(lp35086
VA Windows handle is an IntPtr in C#
p35087
aVIf your code created the handle then you should use one of the SafeHandle derived classes to wrap it so it is guaranteed to be released
p35088
aVAvoids having to write a finalizer
p35089
as(dp35090
g9
V17034
p35091
stp35092
a((dp35093
g2
(lp35094
VYou probably ought to try to find out why double-click isn't getting fired
p35095
aVAnswering your question: you'll indeed need a timer whose Interval you set to the double-click time:
p35096
as(dp35097
g9
V17034
p35098
stp35099
a((dp35100
g2
(lp35101
VI'm pretty sure that should work as-is
p35102
aVJust make sure that you pass a true 2-dimensional array, not a jagged array
p35103
aVIn other words, pass arr[,] not arr[][]
p35104
as(dp35105
g9
V17034
p35106
stp35107
a((dp35108
g2
(lp35109
VA couple of reasons you could need a manifest
p35110
aVFirst and foremost, you need one to tell Windows that your program is aware of UAC policies
p35111
aVThat requires a manifest that contains the  element
p35112
aVIf that is missing, Windows will treat your program as a legacy program and redirect unsafe access to the registry and the file system
p35113
aVWrites to privileged registry keys are redirected to HKCU
p35114
aVFile writes to privileged directories are redirected to isolated storage
p35115
aVYou'll need a manifest if your program is using DLLs that are stored in the Windows side-by-side cache
p35116
aVThat is pretty unlikely to be the case if you still use VS6
p35117
aVWinSxS is used for the MFC and CRT libraries by VS2005 and VS2008 programs
p35118
aVBut not VS2010, by popular demand from MSFT customers
p35119
aVYou'll need a manifest if you want to enable visual themes for your application
p35120
aVRequired to load the modern version of the common controls from comctl32
p35121
aVdll version 6
p35122
aV0, stored in the side-by-side cache rather than the legacy version stored in system32
p35123
aVAnd you need a manifest if you use registry-free COM, the manifest entries replace what is normally written to the registry, allowing for local deployment of in-process COM servers
p35124
aVMost of this is automated in the modern versions of Visual Studio
p35125
as(dp35126
g9
V17034
p35127
stp35128
a((dp35129
g2
(lp35130
VThe declaration is wrong, the wParam and lParam arguments are IntPtr, not long
p35131
aVThere is a complication because you are trying to send strings
p35132
aVWhat matters if the target window is Unicode enabled or not
p35133
aVThere are two versions of SendMessage, SendMessageA() and SendMessageW()
p35134
aVThe former needs to be used if the program is dated and uses 8-bit character strings rather than UTF-16 encoded strings
p35135
aVYou can find out by using Spy++
p35136
aVUse the finder tool to select the window of the application
p35137
aVIn the General property tab, you'll see "Window proc"
p35138
aVIt will say (Unicode) if the window is Unicode enabled
p35139
aVIf you don't see it then the strings have to be translated to 8-bit characters
p35140
aVTo generate the string pointers you need to pass, you can use Marshal
p35141
aVStringToHGlobalAnsi or StringToHGlobalUni (respectively 8-bit and Unicode)
p35142
aVYou can however play a trick to let the P/Invoke marshaller translate the string for you
p35143
aVSaves you the hassle of having to free the strings after the call
p35144
aVFor the Ansi version, you can declare the API function like this:
p35145
aVAnd the Unicode version like this:
p35146
aVOne final note: this will not work as-is if the window belongs to another application, you'll crash it
p35147
aVThe pointer values you pass are only valid in your own process, not in the C++ process
p35148
aVTo work around that, you have to allocate memory in the target process so that the pointer is valid
p35149
aVThat requires OpenProcess to get a handle to the process, VirtualAllocEx() to allocate memory in the target process, big enough to store the string, WriteProcessMemory to write the string
p35150
aVNow you can call SendMessage(), use a version that is declared with IntPtr for the wParam and lParam arguments, pass the value you got from VirtualAllocEx
p35151
aVNext use VirtualFreeEx() to release the memory and CloseHandle to clean up
p35152
aVOr keep the memory around for the next time if you do this often
p35153
aVQuite a lot of P/Invoke to get wrong there
p35154
aVNot to mention security issues, WriteProcessMemory requires admin privileges, UAC elevation is required
p35155
as(dp35156
g9
V17034
p35157
stp35158
a((dp35159
g2
(lp35160
VIt is a tricky subject and I don't know enough about it
p35161
aVWhat I do know is that it is relevant in Remoting scenarios
p35162
aVBy passing True, you can avoid communication from blocking until the wait is resolved and allow other messages to be dispatched
p35163
aVYes, avoids deadlock but can cause synchronization problems
p35164
aVThis argument to WaitOne() has caused so much confusion and FUD that
p35165
aVNET 2
p35166
aV0 SP1 had a compatibility breaking change
p35167
aVThey added the WaitOne(int) and WaitOne(TimeSpan) overloads to avoid having to guess at the proper value of the exitContext argument
p35168
aVWhich should normally be False
p35169
as(dp35170
g9
V17034
p35171
stp35172
a((dp35173
g2
(lp35174
VThere's a known file handle leak bug in the
p35175
aVNET framework source stepping feature
p35176
aVEasy to avoid by turning the option off in Tools + Options + Debugger
p35177
aVThat is however unlikely to be your problem if you never got the debugger going
p35178
aVIt is quite unclear why Visual Studio would be interested at all in the build output, let alone load and lock it
p35179
aVMaybe you opened the
p35180
aVexe once
p35181
aVDelete the hidden
p35182
aVsuo file in the solution directory to be sure
p35183
aVThere isn't any feedback report on connect
p35184
aVmicrosoft
p35185
aVcom that matches your issue, I'd recommend you start your own one
p35186
aVThey'll need something reproducible for them to take a look at it, make sure you include a sample project that exhibits this behavior
p35187
as(dp35188
g9
V17034
p35189
stp35190
a((dp35191
g2
(lp35192
VYou must have been reading earlier from that BufferedStream
p35193
aVIt is getting its bytes from a NetworkStream
p35194
aVThose are one-way, you can either only read from or only write to them, depending how they were created
p35195
aVPost the code that created the NetworkStream if you need more help
p35196
as(dp35197
g9
V17034
p35198
stp35199
a((dp35200
g2
(lp35201
VDebug + Other Windows + Modules
p35202
aVFind your DLL in the list and right-click it
p35203
aVThe Symbol Load Information menu item tells you where it looked for the
p35204
aVpdb file and which one it actually used
p35205
as(dp35206
g9
V17034
p35207
stp35208
a((dp35209
g2
(lp35210
VIf C++ is a requirement then you'll have to write COM code
p35211
aVA bit unjoyful compared to VB
p35212
aVNET code, but there are very good examples available in the MSDN library, you just need to adapt the query
p35213
aVBeware that the example you linked to does not return a serial number of the device itself, just the file system on the device
p35214
aVWhich is as good as it is going to get it, USB devices don't have serial numbers
p35215
aVFile system serial numbers are trivial to duplicate, in case you are contemplating this to write some kind of licensing enforcement scheme
p35216
aVIf that's important then you should use a USB device that was designed for that purpose
p35217
aVA dongle
p35218
aVImpossible to crack
p35219
aVAnd C++ code to verify the license will be available from the manufacturer
p35220
as(dp35221
g9
V17034
p35222
stp35223
a((dp35224
g2
(lp35225
VAt runtime, no
p35226
aVThe only edit option it has is the LabelEdit property
p35227
aVSet it to true to allow the user to edit the ListViewItem
p35228
aVText property of existing items
p35229
as(dp35230
g9
V17034
p35231
stp35232
a((dp35233
g2
(lp35234
VYeah, that won't work
p35235
aVImplement a message handler for WM_GETMINMAXINFO to allow the borders of the window to fall off the screen
p35236
aVBeware that if you didn't set the linker's /SUBSYSTEM option to say that your program is made for Vista or Win7 (version 6,0) then Aero will lie to you when you use GetWindowRect()
p35237
aVThe value you get back is based on thin (legacy) borders
p35238
as(dp35239
g9
V17034
p35240
stp35241
a((dp35242
g2
(lp35243
VIt is a guarantee provided by the CLR that this will work properly, even when the class is used by multiple threads
p35244
aVThis is specified in Ecma 335, Partition II, section 10
p35245
ag2447
ag2586
aV3:
p35246
aVThere are similar, but more complex, problems when type initialization takes place in a multi-threaded system
p35247
aVIn these cases, for example, two separate threads might start attempting to access static variables of separate
p35248
aVtypes (A and B) and then each would have to wait for the other to complete initialization
p35249
aVA rough outline of an algorithm to ensure points 1 and 2 above is as follows:
p35250
ag2582
aVAt class load-time (hence prior to initialization time) store zero or null into all static fields of the type
p35251
ag2584
aVIf the type is initialized, you are done
p35252
ag2584
ag2582
aVIf the type is not yet initialized, try to take an initialization lock
p35253
ag2584
ag2584
aVIf successful, record this thread as responsible for initializing the type and proceed to step 2
p35254
ag2586
ag2584
ag2584
ag2582
aVIf not successful, see whether this thread or any thread waiting for this thread to complete already holds
p35255
aVthe lock
p35256
ag2584
ag2584
ag2584
aVIf so, return since blocking would create a deadlock
p35257
aVThis thread will now see an incompletely initialized
p35258
aVstate for the type, but no deadlock will arise
p35259
ag2584
ag2584
aV3 If not, block until the type is initialized then return
p35260
ag2584
aV3 Initialize the base class type and then all interfaces implemented by this type
p35261
ag2584
aV4 Execute the type initialization code for this type
p35262
ag2584
aV5 Mark the type as initialized, release the initialization lock, awaken any threads waiting for this type to be
p35263
aVinitialized, and return
p35264
aVTo be clear, that's the algorithm they propose for a CLR implementation, not your code
p35265
as(dp35266
g9
V17034
p35267
stp35268
a((dp35269
g2
(lp35270
VYou can do this by trapping the WM_NCHITTEST message that Windows sends to see what area of the window got clicked
p35271
aVYou can fool it by returning HTCAPTION and it will dutifully perform the mouse actions you'd normally get when clicking the caption of a window
p35272
aVIncluding moving the window
p35273
aVPaste this code into your form:
p35274
as(dp35275
g9
V17034
p35276
stp35277
a((dp35278
g2
(lp35279
VTray icons are not windows, you cannot find them with FindWindowsEx
p35280
aVYou might find them with TB_GETBUTTON
p35281
aVThe buck stops at trying to find hidden icons, they are just not there
p35282
aVRevealing hidden icons is implemented differently in different versions of Windows, but they are dynamically created when you reveal them
p35283
aVThere is no API to enumerate them
p35284
as(dp35285
g9
V17034
p35286
stp35287
a((dp35288
g2
(lp35289
VJust rotate it back by the same angle, negative
p35290
aVNote that you could consider using the System
p35291
aVDrawing
p35292
aVMatrix class
p35293
aVIt has a RotateAt() method
p35294
aVUse the TransformPoints() method to apply the rotation
p35295
aVAnd the Invert() method to create a matrix that maps points back
p35296
as(dp35297
g9
V17034
p35298
stp35299
a((dp35300
g2
(lp35301
VThis is not readily available, you'd have to P/Invoke GetWindowPlacement
p35302
aVThe best approach is to only record the window size if the form is in the proper state
p35303
aVFor example:
p35304
as(dp35305
g9
V17034
p35306
stp35307
a((dp35308
g2
(lp35309
VOlder versions of Office used to support OLE Embedding, allow you to display their content in a web browser of the DsoFramer control
p35310
aVThose days are over, DsoFramer is no longer available and Office version ~2007 opens documents in their own program
p35311
aVYou cannot make this work anymore
p35312
as(dp35313
g9
V17034
p35314
stp35315
a((dp35316
g2
(lp35317
VThis is entirely normal, assemblies that contain IL code always are packaged in a DLL that has a 32-bit header
p35318
aVSame thing you get with Project + Properties, Build tab, Platform Target = Any CPU
p35319
aVKeep in mind: pure
p35320
aVNET assemblies only contain data, no code
p35321
aVWhether the JIT compiler translates the IL to 32-bit or to 64-bit code is determined by the bitness of the startup EXE
p35322
as(dp35323
g9
V17034
p35324
stp35325
a((dp35326
g2
(lp35327
VNo, this is very bad, a control should never depend on having a specific parent
p35328
aVDo it the same way any Windows Forms control does it: if something interesting happens that a parent might be interested in then raise an event:
p35329
aVConsider putting the event raising code in a private setter for the Status property
p35330
as(dp35331
g9
V17034
p35332
stp35333
a((dp35334
g2
(lp35335
VYou need to consider what code would be required if setting up the plumbing to raise the event in the first place would be expensive (like SystemEvents) or when preparing the event arguments would be expensive (like the Paint event)
p35336
aVThe Visual Basic style of event handling doesn't let you postpone the cost of supporting such an event
p35337
aVYou cannot override the add/remove accessors to delay putting the expensive plumbing in place
p35338
aVAnd you cannot discover that there might not be any event handlers subscribed so that burning the cycles to prepare the event arguments is a waste of time
p35339
aVNot an issue in C#
p35340
aVClassic trade-off between convenience and control
p35341
as(dp35342
g9
V17034
p35343
stp35344
a((dp35345
g2
(lp35346
VRunning 32-bit unmanaged code in a 64-bit process is not possible
p35347
aVOr the reverse
p35348
aVThe options you have available:
p35349
aVForce the EXE to run in x86 mode with the Target Platform setting in the Build tab
p35350
aVRecompile the C++ DLL in x64 mode
p35351
aVThat's often possible without too many hassles, provided you have the source code and not a dependency on some 3rd party code that is only available in 32-bits
p35352
aVRun the C++ DLL in a surrogate process that is forced to run in 32-bit mode
p35353
aVYou'll need to use an interprocess communication mechanism to get your 64-bit process to talk to the 32-bit surrogate
p35354
aVNamed pipes, sockets,
p35355
aVNET Remoting, WCF are typical choices in
p35356
aVNET
p35357
aVThe 3rd option can give you the most bang for your buck but it can be slow if there's a lot of data exchanged and tends to be fragile
p35358
aVIt can be difficult to deal with failure of the surrogate process
p35359
as(dp35360
g9
V17034
p35361
stp35362
a((dp35363
g2
(lp35364
VI would have to guess your real question is "can it be done automatically
p35365
aVNo, you have to create a project for each assembly
p35366
aVQuite a maintenance and deployment nightmare with no easily conceivable advantages
p35367
as(dp35368
g9
V17034
p35369
stp35370
a((dp35371
g2
(lp35372
VTake a look at c:\u005cprogram files\u005cmsbuild\u005cmicrosoft
p35373
aVcpp\u005cv4
p35374
aV0\u005cmicrosoft
p35375
aVbuildsteps
p35376
aVtargets
p35377
aVIt contains the GenerateTargetFrameworkMonikerAttribute target, that's the one that generates the file
p35378
aVThe Condition element determines when it runs, GenerateTargetFrameworkAttribute is the value
p35379
aVThat will always be true if the project settings ask for a /clr build
p35380
aVThe comment in the target is very misleading, the hoopla about precompiled header files has nothing to do with the purpose of the target
p35381
aVGuessing why the TargetFrameworkAttribute is needed is harder, the MSDN Library article for it gives no hint
p35382
aVI think it is required because, unlike the C# and VB
p35383
aVNET languages, it is technically possible in C++/CLI to link
p35384
aVobj and
p35385
aVlib files that were compiled with different settings for the target framework version
p35386
aVThat would be bad
p35387
aVIf this guess is accurate then it would have to be the linker that enforces this attribute value and you should get some kind of linker error or warning when you try to mix and match
p35388
aVLNK4221 is common and has no teeth, you can ignore it
p35389
aVSuppressing the helper
p35390
aVcpp would require editing the
p35391
aVtargets file, I would not recommend that
p35392
as(dp35393
g9
V17034
p35394
stp35395
a((dp35396
g2
(lp35397
VIt doesn't only not block the main window, it is also very likely to disappear behind it
p35398
aVThat's a direct consequence of it running on a different thread
p35399
aVWhen you don't specify an owner for the message box then it goes looking for one with the GetActiveWindow() API function
p35400
aVIt only considers windows that use the same message queue
p35401
aVWhich is a thread-specific property
p35402
aVLosing a message box is quite hard to deal with of course
p35403
aVSimilarly, MessageBox only disables windows that belong to the same message queue
p35404
aVAnd thus won't block windows created by your main thread
p35405
aVFix your problem by letting the UI thread display the message box
p35406
aVUse Dispatcher
p35407
aVInvoke or leverage either the ReportProgress or RunWorkerCompleted events
p35408
aVDoesn't sound like the events are appropriate here
p35409
as(dp35410
g9
V17034
p35411
stp35412
a((dp35413
g2
(lp35414
VThis is a rather horrific feature inherited from VB6, a language that allowed this construct
p35415
aVIt is not allowed in a pure OOP language, referencing a member of an object requires an object name, not a type name
p35416
aVThe VB
p35417
aVNET team went through some trouble to make this work in the VB
p35418
aVNET language
p35419
aV"Form1" in this statement is in fact an object reference, one that gets auto-generated by the compiler
p35420
aVSomething that goes horribly wrong when that name is used in threads btw
p35421
aVBut this won't fly in the C# language, you have to supply an object reference
p35422
aVYou will have to re-factor the code so the ClassFoo object has that reference
p35423
aVSomething like this:
p35424
aVThis is probably going to cause some pain while you are learning C#
p35425
aVThe Q&D; workaround for this is to use Application
p35426
aVOpenForms
p35427
aVAvoid using it if you prefer to byte the bullet
p35428
as(dp35429
g9
V17034
p35430
stp35431
a((dp35432
g2
(lp35433
VNot sure I understand the hang-up
p35434
aVThe server calls ConnectNamedPipe to wait for a client connection
p35435
aVNo data needs to be sent
p35436
aVNor can it be sent, you cannot issue a ReadFile until a client is connected
p35437
aVNote that the SDK sample uses this as well
p35438
aVIf the server disconnects ungracefully (without notifying the client with some kind of message so it can close its end of the pipe) then the client will get an error, ERROR_PIPE_NOTCONNECTED (I think)
p35439
aVThere's little reason to rely on that for a normal shutdown, you need to do something reasonable when the pipe server process crashed and burned unexpectedly
p35440
aVBeware that pipes are tricky to get right due to their asynchronous nature
p35441
aVGetting errors that are not actually problems is common and you'll need to deal with it
p35442
aVMy pipe code deals with these errors:
p35443
aVConnectNamedPipe: ERROR_PIPE_CONNECTED on connection race, ignore
p35444
aVFlushFileBuffers: race on pipe closure, ignore all errors
p35445
aVWaitNamedPipe: ERROR_FILE_NOT_FOUND if the timeout expired, translate to WAIT_TIMEOUT
p35446
aVCreateFile: ERROR_PIPE_BUSY if another client managed to grab the pipe first, repeat
p35447
as(dp35448
g9
V17034
p35449
stp35450
a((dp35451
g2
(lp35452
VWell, there's something there
p35453
aVI see a colored bar next to my code, usually green, between the left rail that you can click to set breakpoints and the vertical line with +/- nodes to allow collapsing regions
p35454
aVFrom 10,000 feet I suppose it could resemble a "minimap"
p35455
aVHaven't figured out what exactly it means yet though
p35456
aVMaybe I haven't zoomed small enough yet
p35457
aVSee it
p35458
as(dp35459
g9
V17034
p35460
stp35461
a((dp35462
g2
(lp35463
VAgreed with @tlayton
p35464
aVHaving dabbled a bit in parsers myself, I can attest that generating good error messages for syntax errors that confuse the parser's sense of scope can be very hard to do
p35465
aVThis particular case is however close to a defect
p35466
aVThe irony is that in VS2010, the compiler still generates the same lousy error message but the IntelliSense parser actually catches it:
p35467
aVThat's borked
p35468
aVYou can report it at connect
p35469
aVmicrosoft
p35470
aVcom
p35471
aVLet me know if you don't want to take the time, I'll report it (MVP duty)
p35472
as(dp35473
g9
V17034
p35474
stp35475
a((dp35476
g2
(lp35477
VThis is standard behavior for any Windows GUI application, screen updates don't happen until the UI thread goes idle so that Windows can deliver the Paint event
p35478
aVOne of the absolute worst things you could do is calling Application
p35479
aVDoEvents()
p35480
aVYes, that will deliver the Paint event
p35481
aVBut it also allows your user to close the form
p35482
aVThat produces a Big Kaboom when the control you are trying to update is suddenly not there anymore
p35483
aVYour loop is still running, but the form isn't there anymore
p35484
aVWhat you must have noticed is that the progress bar actually updated but the CheckedListBox did not
p35485
aVThat's because ProgressBar often is used to show progress when the code is in a loop, so it makes sure that when you change the Value property, it immediately paints itself without waiting for Windows to tell it that it needs to be repainted
p35486
aVDirty trick, very confusing
p35487
aVBut you can take advantage of that trick as well, it is easy
p35488
aVModify your code like this:
p35489
aVThe Update() method means "paint yourself when necessary"
p35490
aVIt is, you changed the check state of an item
p35491
aVNever does the Big Kaboom thingy on you, the user can't suddenly make the control disappear
p35492
aVIf SOME_FUNCTION() takes a long time, like more than 10 x 0
p35493
aV3 seconds or so, then you should start thinking about using threads
p35494
as(dp35495
g9
V17034
p35496
stp35497
a((dp35498
g2
(lp35499
VThe Permanent property only ensures that the file doesn't get deleted during uninstall
p35500
aVTo prevent overwriting the file, you need to use the Condition property
p35501
aVGet this started with View + Editor, Launch Conditions
p35502
aVRight-click "Search Target Machine" and select Add File Search
p35503
aVSet the Filename and Folder, note the property name (default "FILEEXISTS1")
p35504
aVNow go back to the file properties and set the Condition property to NOT FILEEXISTS1 so that the file only gets deployed when it doesn't already exist
p35505
aVYou can refine by date, if necessary
p35506
aVMake sure you test this before sending it off to the customer
p35507
as(dp35508
g9
V17034
p35509
stp35510
a((dp35511
g2
(lp35512
VIt of course makes zero sense that the columns would be re-ordered when the table is brand new
p35513
aVAnd that the order looks correct when you look at the table structure
p35514
aVThere's only one good explanation: whatever program you are using to look at the table has memorized the column order from a previous run
p35515
aVAnd puts the new columns at the end
p35516
aVThis would be a very common and desirable feature, allowing the user to get back the view of the table just like it was the last time she looked at it
p35517
aVThe layout data has to be stored in private data of the program, the
p35518
aVdbf file format cannot store it
p35519
aVThis is just a display artifact, it cannot affect proper operation in any way
p35520
as(dp35521
g9
V17034
p35522
stp35523
a((dp35524
g2
(lp35525
VThe Click and MouseClick events are only generated by a left-click
p35526
aVIf you want to detect right-clicks then you have to implement the MouseDown or MouseUp event
p35527
as(dp35528
g9
V17034
p35529
stp35530
a((dp35531
g2
(lp35532
VI'll guess that you are actually talking about a shell extension handler and the IShellIconOverlayIdentifier interface
p35533
aVYes, the IsMemberOf method will be called frequently
p35534
aVYou have to keep it snappy or the user will experience poor behavior in Explorer if your code needs a lot of time to query a dbase
p35535
aVNo, you cannot assume that the next call will pass a path to points to the same folder as the previous one, merely that it is likely to do so
p35536
aVTo flush your cache, you probably get reasonable behavior if you see that the folder name has changed from the previous call
p35537
aVAnother strategy is to keep track of the age of the cached item
p35538
aVThrow out old ones when the cache fills up
p35539
aVThis will help when the user switches back and forth between folders, not an uncommon operation
p35540
as(dp35541
g9
V17034
p35542
stp35543
a((dp35544
g2
(lp35545
VWell, with r+ you will ask for write access to the file
p35546
aVA privilege that is harder to come by, do triple-check that the user account indeed has the write privilege in the folder
p35547
aVBut sounds like you already checked that
p35548
aVThe next consideration is sharing
p35549
aVThe fopen() function is quite inappropriate on modern multitasking operating systems, it allows any process to access the opened file and both read and write to it
p35550
aVThat rarely comes to a good end, especially write sharing can only produce garbage if the processes don't negotiate access to the file
p35551
aVThat's why there's an fopen_s() in the Microsoft CRT, it makes sure that write sharing is denied
p35552
aVIt is very rare that you'd want to allow it
p35553
aVWhen you pass "r" then read sharing is allowed
p35554
aVWhen you pass "r+" then no sharing is allowed
p35555
aVThat can fail if some other process already has the file opened for reading
p35556
aVYou need to find that other process
p35557
aVThe SysInternals' Handle utility can help you find it
p35558
aVAlso consider that it might be your own program
p35559
aVIn general, take charge of controlling the sharing yourself, use the _wfsopen() function instead
p35560
aVNote that there's no secure version for it because none is needed
p35561
as(dp35562
g9
V17034
p35563
stp35564
a((dp35565
g2
(lp35566
VThis is not the proper way to let the user input this specific data
p35567
aVYou've got a list of valid entries available from your database
p35568
aVPut them in a ComboBox so the user doesn't have to guess and can't get it wrong
p35569
as(dp35570
g9
V17034
p35571
stp35572
a((dp35573
g2
(lp35574
VI should think that "Senior" means that the candidate has been programming with
p35575
aVNET for at least 5 years
p35576
aVVerify this by asking questions about
p35577
aVNET 1
p35578
aVx features that were obsoleted by
p35579
aVNET 2
p35580
ag2512
aVLike the System
p35581
aVCollection namespace classes
p35582
as(dp35583
g9
V17034
p35584
stp35585
a((dp35586
g2
(lp35587
VYou cannot appreciate what kind of problems threading can cause unless you've debugged a three-way deadlock
p35588
aVOr spent a month chasing a race condition that happens only once a day
p35589
aVSo, go ahead and jump in with both feet and make all the kind of mistakes you need to make to learn to fear the Beast and what to do to stay out of trouble
p35590
as(dp35591
g9
V17034
p35592
stp35593
a((dp35594
g2
(lp35595
VLook at the location of the  element in the project file that imports PostSharp
p35596
aVtargets
p35597
aVThere are normally three  elements in the project file
p35598
aVOne for general settings, one for Debug only settings and one for Release only settings
p35599
aVMove the  element if it is in the Release group, it should appear after the Import element for Microsoft
p35600
aVCSharp
p35601
aVtargets
p35602
as(dp35603
g9
V17034
p35604
stp35605
a((dp35606
g2
(lp35607
VThis is not the proper way to embed version info in your program
p35608
aVYou should use a Version resource
p35609
aVView + (Other Windows) + Resource View
p35610
aVAdd Resource + Version and fill in the FILEVERSION and PRODUCTVERSION properties
p35611
aVAfter you build, you can see that version when you right-click the DLL or EXE in Explorer
p35612
aVInnoSetup should be able to see it too, not sure
p35613
aVIf you need this info at runtime (About box or something like that) then use the FileVersionInfo class
p35614
as(dp35615
g9
V17034
p35616
stp35617
a((dp35618
g2
(lp35619
VThis is an artifact of Windows support for old DOS 8
p35620
aV3 filenames
p35621
aVFiles with an extension like
p35622
aVcorxxx get mapped to a 8
p35623
aV3 name like Blah~1
p35624
aVcor
p35625
aVAnd will match your wildcard
p35626
aVNothing you can do but double-check the filename you get
p35627
aVUse Path
p35628
aVGetExtension()
p35629
as(dp35630
g9
V17034
p35631
stp35632
a((dp35633
g2
(lp35634
VI see it
p35635
aVIt happens because TabControl draws itself partly by asking the parent control to draw itself inside its own window
p35636
aVNecessary because the tabs don't cover the full width of the control, they "stick out"
p35637
aVIf the BackgroundImage is slow to draw, you'll see a flicker between the background being drawn and the tabs drawn on top of that
p35638
aVThis is going to be hard to fix, TabControl doesn't support any kind of double buffering
p35639
aVYou can only minimize the effect by making the BackgroundImage efficient to draw
p35640
aVYou need to do so by making the image exactly the size of the panel's ClientSize so that the image doesn't have to be resized
p35641
aVAnd create that bitmap with the PixelFormat32bppPArgb pixel format, it is usually 10 times faster than the other ones
p35642
aVThere's one magic cure available, windows have a style flag that enables double-buffering for the entire window, including its child controls
p35643
aVSupported since XP but some side-effects have been reported
p35644
aVPaste this code into your form, it fixes the TabControl flicker:
p35645
aVBut beware that the visual style renderer for TabControl has one rather major incompatibility with this style flag
p35646
aVIf your tabs overflow and you get the selection arrows then it goes bananas and starts rendering the tabs over and over again, producing a very high rate of flicker
p35647
as(dp35648
g9
V17034
p35649
stp35650
a((dp35651
g2
(lp35652
VDid you actually tell the linker that it should link the corresponding
p35653
aVlib file
p35654
aVThe project templates only link the most popular
p35655
aVlib files, kernel32
p35656
aVlib, user32
p35657
aVlib etc
p35658
aVIf you use an "unusual" API function then you must also tell the linker to link the import library
p35659
aVProject + Properties, Linker, Input, Additional Dependencies
p35660
aVIf you don't know what
p35661
aVlib is needed then look in the SDK documentation for the API function
p35662
aVThe
p35663
aVlib file is listed at the bottom of the article
p35664
aVAnother thing you can do is use a #pragma in your source code to tell the linker to link with a
p35665
aVlib
p35666
aVFor example:
p35667
as(dp35668
g9
V17034
p35669
stp35670
a((dp35671
g2
(lp35672
VThere is not
p35673
aVYes, GetFileType() tells it that stdout is no longer a char device, _isatty() return false so the CRT switches the output stream to buffered mode
p35674
aVImportant to get reasonable throughput
p35675
aVFlushing output one character at a time is only acceptable when a human is looking at them
p35676
aVYou would have to relink the programs you are trying to redirect with a customized version of the CRT
p35677
aVI don't doubt that if that was possible, you wouldn't be messing with this in the first place
p35678
aVPatching GetFileType() is another un-sane solution
p35679
as(dp35680
g9
V17034
p35681
stp35682
a((dp35683
g2
(lp35684
VThat's the mistake
p35685
aVDouble-buffering can only work if you draw into the buffer
p35686
aVThe one that e
p35687
aVGraphics references
p35688
aVFix:
p35689
aVBeware that Panel doesn't have double-buffering turned on by default
p35690
aVYou'll need to derive your own
p35691
aVPaste this into a new class:
p35692
aVCompile
p35693
aVDrop it from the top of the toolbox
p35694
as(dp35695
g9
V17034
p35696
stp35697
a((dp35698
g2
(lp35699
VI repro with this C++/CLI snippet:
p35700
aVClearly this is a bug in the C++/CLI compiler
p35701
aVI don't see it reported at connect
p35702
aVmicrosoft
p35703
aVcom
p35704
aVDoing so yourself probably isn't worth the effort, the language is in maintenance mode
p35705
aVPossible workarounds are editing the source code of xUnit to assign AllowMultiple again or to create your own InlineDataFixedAttribute that inherits InlineDataAttribute
p35706
as(dp35707
g9
V17034
p35708
stp35709
a((dp35710
g2
(lp35711
VYou can't
p35712
aVFunction keys cannot work with stdin, an app has to call ReadConsoleInput() to be able to detect them
p35713
aVThat no longer works when you start the process without a console window
p35714
as(dp35715
g9
V17034
p35716
stp35717
a((dp35718
g2
(lp35719
VYou might be misinterpreting its behavior
p35720
aVIf it crashes right away then it is implemented in a safe manner
p35721
aVI can attest that this was not common behavior for free() many moons ago
p35722
aVThe typical CRT implementation back then did no checking at all
p35723
aVFast and furious, it would simply corrupt the heap's internal structure, messing up the allocation chains
p35724
aVWithout any diagnostic at all, the program would then misbehave or crash long after the heap corruption took place
p35725
aVWithout having any hint why it misbehaved that way, the code that crashed wasn't actually responsible for the crash
p35726
aVA heisenbug, very difficult to troubleshoot
p35727
aVThis is not common anymore for modern CRT or OS heap implementations
p35728
aVThis kind of undefined behavior is very exploitable by malware
p35729
aVAnd it makes your life a wholeheckofalot easier, you'll quickly find the bug in your code
p35730
aVIt has kept me out of trouble for the past few years, haven't had to debug untraceable heap corruption in a long time
p35731
aVGood Thing
p35732
as(dp35733
g9
V17034
p35734
stp35735
a((dp35736
g2
(lp35737
VYou can see the implicitly linked DLL dependencies with Dumpbin /imports
p35738
aVOr the static view as provided by Dependency Walker
p35739
aVHowever, VB6 programs typically have a heavy dependency on COM components and they get demand-loaded while the program runs
p35740
aVThose components need to be registered before the program can load and use them
p35741
aVTo see that, you'll need a utility that shows how the program is using the registry
p35742
aVNothing in the VS6 toolbox for that, you can use SysInternals' ProcMon utility
p35743
aVPay attention to the program trying to open keys in the HKLM\u005cSoftware\u005cClasses\u005cCLSID registry key, that's where COM components are registered
p35744
aVYou should see it fail to find that key, from which you can determine the CLSID
p35745
aVThat still doesn't really get you anywhere because that's just an opaque number, it doesn't tell you the name or location of the DLL
p35746
aVUse Regedit
p35747
aVexe on a machine on which the program runs correctly
p35748
aVLocate that key, the LocalServer32 value tells you which DLL or OCX implements the COM component
p35749
as(dp35750
g9
V17034
p35751
stp35752
a((dp35753
g2
(lp35754
VI don't really see the problem, DataColumn, DataTable and DataSet have an ExtendedProperties member that allows you to attach arbitrary metadata
p35755
aVYour RawXxx readers can all assume that the data is eventually going to end up in a SQL database so they can all agree on naming these metadata items
p35756
aVOn the receiving end, you would only have to deal with a missing metadata item
p35757
as(dp35758
g9
V17034
p35759
stp35760
a((dp35761
g2
(lp35762
VThe primary way to register COM components is by their CLSID, a fixed size 16 byte number
p35763
aVA GUID
p35764
aVYou can publish a ProgID, that's useful to COM clients that need to use late binding
p35765
aVLike scripting languages
p35766
aVI have no idea if there's a length limit to ProgIDs, there isn't one defined in the COM infrastructure
p35767
aVMaybe the scripting language has one
p35768
aVI know you are using VB6, there's no need for a ProgID at all
p35769
aVIt prefers early binding (new ClassName, not CreateObject)
p35770
aVWhich is a good idea because late bound calls are about 10,000 times slower
p35771
aVAnyhoo, if you want to specify a ProgId then use the  attribute
p35772
aVThe normal format is AppName
p35773
aVClassName, something that should rarely test any kind of length limit
p35774
as(dp35775
g9
V17034
p35776
stp35777
a((dp35778
g2
(lp35779
VYou didn't paste the error message correctly
p35780
aVThe error code should be 0xC0000135, STATUS_DLL_NOT_FOUND
p35781
aVInstall
p35782
aVNET Compact Framework on the device
p35783
as(dp35784
g9
V17034
p35785
stp35786
a((dp35787
g2
(lp35788
VFrom the JIT compiler's point of view, there is no difference between a static and an instance method
p35789
aVThe machine code for them is very similar, it gets stored in the same kind heap
p35790
aVThe only difference is that an instance method has an extra argument
p35791
aVThat extra argument needs to be passed when the method is called
p35792
aVThat can cost an extra machine code instruction but not that often
p35793
aVThe CPU register (ECX) frequently already has the correct value
p35794
aVThere is a difference if an instance method has more than one argument on x86 or more than three on x64, an extra argument has to be passed on the stack rather than through a CPU register
p35795
aVOne extra instruction
p35796
aVWorst case, you are looking at a bit less than a nanosecond
p35797
aVThat's going to be hard to measure, the usual problem with micro-optimizations
p35798
as(dp35799
g9
V17034
p35800
stp35801
a((dp35802
g2
(lp35803
VA form already has TopLevel set to true
p35804
aVYou want TopMost
p35805
aVP/Invoking SetParent() would be best but getting the window handle you need might not be that easy
p35806
aVMaybe Process
p35807
aVGetCurrentProcess()
p35808
aVMainWindowHandle
p35809
as(dp35810
g9
V17034
p35811
stp35812
a((dp35813
g2
(lp35814
VIt is a TaskDialog
p35815
aVIt is wrapped in a managed class by the Windows API Code Pack
p35816
aVLots of other Vista and Win7 specific goodies in there as well
p35817
as(dp35818
g9
V17034
p35819
stp35820
a((dp35821
g2
(lp35822
VYou are pretty close
p35823
aVDon't forget to restore the SelectionColor:
p35824
aVBtw: keep your code clean
p35825
aVA message handler for an rtb should not be named txtXxxx
p35826
aVThese little details will screw you up sooner or later (it did for me, looking for the wrong reason)
p35827
aVAlso move the keyword initialization out of the method
p35828
as(dp35829
g9
V17034
p35830
stp35831
a((dp35832
g2
(lp35833
VFrom what I've seen over the past several years:
p35834
aVWTL is on a lifeline
p35835
aVAbandoned by Microsoft, picked up by fans and there were several very dedicated followers
p35836
aVVery clean, but the learning curve is steep and the fan base dwindling
p35837
aVThe Yahoo group is not very active
p35838
aVI can't recommend it
p35839
aVMFC got another lease on life when MSFT released the feature pack
p35840
aVRather extensive and a bit un-MFC-ish, it has strong support for skinning, docking layouts and ribbons
p35841
aVI thought it was going to be wildly popular but never did see a lot of devs jumping on it
p35842
aVMSDN forum questions have been sparse
p35843
aVIf you have an existing MFC codebase then definitely take a look
p35844
aVAnother MFC refresh for VS2010 with Win7 features added, it does stay the company's base UI solution
p35845
aVwxWidgets is still around
p35846
aVNo personal experience, but Lord, the few practitioners I've heard from are bitching up a storm
p35847
aVReal bitter stuff too
p35848
aVQt has been around for quite a while but picked up stream considerably, especially in the last year
p35849
aVWhomever uses it really likes it
p35850
aVIt is moving beyond the confines of a UI class library as well, their users are looking actively for solutions to common programming tasks that start with the letter Q
p35851
aVThat's a powerful vote of confidence
p35852
aVBut if you are on a Microsoft stack, none of these class libraries is where the real UI development is at
p35853
aVWPF is the elephant in the room, it's capabilities are a hundred miles beyond what's listed above
p35854
aVIts ability to break device and paradigm boundaries are powerful, writing code that runs on a desktop as well as a web browser as well as a phone is hard to beat
p35855
aVBut C++ is not part of that
p35856
as(dp35857
g9
V17034
p35858
stp35859
a((dp35860
g2
(lp35861
VThe Edit and Continue feature is preventing you from editing files if the debugger hasn't stopped the program
p35862
aVThe simple workaround is Debug + Break All, you should then be able to edit the files, your changes will be immediately effective provided your changes do not violate the restrictions imposed by E+C
p35863
aVThis is the most efficient work flow
p35864
aVThe heavy-handed approach is to disable Edit and Continue
p35865
aVTools + Options, Debugger, Edit and Continue, uncheck the Enable check box
p35866
as(dp35867
g9
V17034
p35868
stp35869
a((dp35870
g2
(lp35871
VEven if you could download the DLL (you can't), it is not going to help you
p35872
aVTo create your own ribbon for use in your own application you must create a ribbon markup file
p35873
aVThat file needs to be compiled by UICC
p35874
aVEXE, a tool that is only available in the Windows 7 SDK
p35875
aVWithout that tool, you cannot create your own ribbon
p35876
aVDownloading the SDK is required
p35877
aVNote that the SDK version that comes with VS2010 is not good enough, it is a sub-set of the SDK and does not include uicc
p35878
aVexe
p35879
as(dp35880
g9
V17034
p35881
stp35882
a((dp35883
g2
(lp35884
VThe snipping tool effect isn't difficult to implement in Windows Forms
p35885
aVAdd a new form to your project and name it "SnippingTool"
p35886
aVMake the code look like this:
p35887
aVUsage:
p35888
as(dp35889
g9
V17034
p35890
stp35891
a((dp35892
g2
(lp35893
VIf the question is "can I convert a serialized list to a dictionary without writing code" then the answer is no
p35894
aVThere isn't much wrong with what you are doing now
p35895
aVYou could consider a dictionary that supports XML serialization so you don't have to convert it to a list first
p35896
aVHere's one:
p35897
as(dp35898
g9
V17034
p35899
stp35900
a((dp35901
g2
(lp35902
VYes, this is possible with the IFileOperation shell interface, available since Vista
p35903
aVA managed class wrapper for this COM interface is available in this magazine article
p35904
aVFall back on your existing code if it also needs to run on earlier versions of Windows
p35905
as(dp35906
g9
V17034
p35907
stp35908
a((dp35909
g2
(lp35910
VYes, that cannot work
p35911
aVCalling DoDragDrop() turns mouse control over to the Windows D+D logic, that's going to interfere with normal mouse handling
p35912
aVYou need to delay starting the D+D until you see the user actually dragging
p35913
aVThis ought to solve the problem:
p35914
as(dp35915
g9
V17034
p35916
stp35917
a((dp35918
g2
(lp35919
VYou are probably missing real life problems that can be solved with this
p35920
aVEmbarrassingly parallel problems are uncommon
p35921
as(dp35922
g9
V17034
p35923
stp35924
a((dp35925
g2
(lp35926
VSet the TextBox
p35927
aVScrollBars property to Vertical
p35928
aVThat gives the text box a scrollbar that scrolls the text
p35929
aVMake sure the TextBox fit the TabPage so you don't get a scrollbar in the tab page
p35930
aVYou could set the TextBox
p35931
aVDock property to Fill for example
p35932
aVThat wasn't it I guess, maybe you are talking about the mouse wheel
p35933
aVAdd a new class to your project and paste the code shown below
p35934
aVCompile
p35935
aVDrop the new control from the top of the toolbox onto your form, replacing your existing text boxes
p35936
as(dp35937
g9
V17034
p35938
stp35939
a((dp35940
g2
(lp35941
VAll processors I know generate a hardware trap for this
p35942
aVWhich is handled by the operating system and reflected into the user mode code with an OS dependent mechanism (signal, exception, etc)
p35943
aVWhich the runtime picks up and translates into a Java or
p35944
aVNET exception
p35945
as(dp35946
g9
V17034
p35947
stp35948
a((dp35949
g2
(lp35950
VIt is well specified in the C# Language Specification, chapter 7
p35951
ag2588
ag2586
aV2, "Better function member":
p35952
aVOtherwise, if MP is applicable in its normal form and MQ has a params array and is applicable only in its expanded form, then MP is better than MQ
p35953
aVOtherwise, if MP has fewer declared parameters than MQ, then MP is better than MQ
p35954
aVThis can occur if both methods have params arrays and are applicable only in their expanded forms
p35955
aVFwiw, the C# Language Specification is a very readable document and can help you resolve these puzzles by yourself
p35956
aVYou have it on your machine, find it back in the Visual Studio install directory (like c:\u005cprogram files\u005cmicrosoft visual studio 9
p35957
aV0) in the vc#\u005cspecifications\u005c1033 subdirectory
p35958
aVAnother good one is the Ecma-335 standard document, freely available as a PDF download
p35959
aVIt specifies the behavior of the CLR and the JIT compiler, great material to understand why C# (and the CLR) do what they do
p35960
aVRecommended
p35961
as(dp35962
g9
V17034
p35963
stp35964
a((dp35965
g2
(lp35966
VThe Validating event was made to do that
p35967
aVDrop an ErrorProvider control on your form so you can subtly remind the user that she did something wrong
p35968
aVThe event also allows you to format the text box text the way that make sense
p35969
aVLike this:
p35970
as(dp35971
g9
V17034
p35972
stp35973
a((dp35974
g2
(lp35975
VIt is a terrible class to act as a key in a Dictionary
p35976
aVThe only reasonable way to implement GetHashCode() is by using its CopyTo() method to copy the bits into a byte[]
p35977
aVThat's not great, it creates a ton of garbage
p35978
aVBeg, steal or borrow to use a BitVector32 instead
p35979
aVIt has a good implementation for GetHashCode()
p35980
aVIf you've got more than 32 bits then consider spinning your own class so you can get to the underlying array without having to copy
p35981
as(dp35982
g9
V17034
p35983
stp35984
a((dp35985
g2
(lp35986
VYes, this is by design
p35987
aVThe Form class keeps track of the restore bounds itself, necessary so it can properly reposition the window after it was re-created
p35988
aVWindows Forms often recreates the window on-the-fly to implement property setters for properties that can only be specified by CreateWindowEx()
p35989
aVLike ShowInTaskbar
p35990
aVThe private RestoreWindowBoundsIfNecessary() method puts the window back, it will run when the window is restored
p35991
aVFrom what I can tell, the restore bounds are latched just before the window is minimized or maximized
p35992
aVIf you want to modify the restore position while the window is min/maximized then you'll have to use MoveWindow to move it where you want it to go after restoring the window
p35993
aVOught to produce some flicker
p35994
as(dp35995
g9
V17034
p35996
stp35997
a((dp35998
g2
(lp35999
V17 years is a really long time ago
p36000
aVForget everything it says about GlobalAlloc and LocalAlloc
p36001
aVThe SysInternals' VMMap utility does a similar job, it is excellent
p36002
as(dp36003
g9
V17034
p36004
stp36005
a((dp36006
g2
(lp36007
VYou are going too fast
p36008
aVThere a three types and three properties here, you'll need to use GetType and GetProperty three times
p36009
as(dp36010
g9
V17034
p36011
stp36012
a((dp36013
g2
(lp36014
VA cast is not going to work, it will turn your 8-bit character string into Chinese
p36015
aVFix:
p36016
as(dp36017
g9
V17034
p36018
stp36019
a((dp36020
g2
(lp36021
VThose keys don't produce a WM_CHAR message
p36022
aVYou'll need WM_VKEYTOITEM to see them
p36023
as(dp36024
g9
V17034
p36025
stp36026
a((dp36027
g2
(lp36028
VSigh, exhausting isn't it
p36029
aVAvoid all this by using the recommended Create() method:
p36030
as(dp36031
g9
V17034
p36032
stp36033
a((dp36034
g2
(lp36035
VThere's little reason to be afraid of deadlocks, they are easy to detect
p36036
aVYour program stops running, dead giveaway
p36037
aVWhat you really should be terrified of is threading races, the kind of bug you'll get when you don't lock when you should
p36038
aVVery hard to diagnose
p36039
aVUsing lock is fine, just make sure you use the exact same locking object in any code that touches that list
p36040
aVLike the code that adds or removes items from that list
p36041
aVIf that code runs on the same thread that iterates the list then you don't need a lock
p36042
aVGenerally, the only chance for deadlock here is if you have code that relies on the thread state, like Thread
p36043
aVJoin(), while it is also holding that locking object
p36044
aVWhich ought to be rare
p36045
aVYes, iterating a copy of the list is always thread-safe, as long as you use a lock around the ToArray() method
p36046
aVNote that you still need the lock, no structural improvement
p36047
aVThe advantage is that you'll hold the lock for a short amount of time, improving concurrency in your program
p36048
aVThe disadvantages are its O(n) storage requirements, only having a safe list but not protecting the elements in the list and the tricky problem of always having a stale view of the list content
p36049
aVEspecially the last problem is subtle and hard to analyze
p36050
aVIf you cannot reason out the side-effects then you probably shouldn't consider this
p36051
aVDo make sure to treat the ability of foreach to detect a race as a gift, not a problem
p36052
aVYes, an explicit for(;;) loop is not going to throw the exception, it is just going to malfunction
p36053
aVLike iterating the same item twice or skipping an item completely
p36054
aVYou could avoid having to re-check the number of items by iterating it backwards
p36055
aVAs long as other thread(s) are only calling Add() and not Remove() that would behave similarly to ToArray(), you'll get the stale view
p36056
aVNot that this will work in practice, indexing the list is not thread-safe either
p36057
aVList<> will reallocate its internal array if necessary
p36058
aVThis just won't work and malfunction in unpredictable ways
p36059
aVThere are two points of view here
p36060
aVYou can be terrified and follow common wisdom, you'll get a program that works but might not be optimal
p36061
aVThat's wise and keeps the boss happy
p36062
aVOr you can experiment and find out for yourself how skewing the rules gets you in trouble
p36063
aVWhich will make you happy, you'll be a much better programmer
p36064
aVBut your productivity is going to suffer
p36065
aVI don't know what your schedule looks like
p36066
as(dp36067
g9
V17034
p36068
stp36069
a((dp36070
g2
(lp36071
VUsing dialogs in an MDI application is quite normal, it doesn't violate MDI conventions
p36072
aVJust don't make it a MDI child window
p36073
aVThat's bad because you cannot make it modal
p36074
aVAnd if you make it non-modal then confuzzling things happen when the user minimizes the window
p36075
aVJust use the ShowDialog(owner) or Show(owner) method (respectively modal and non-modal) and pass the MDI parent as the owner
p36076
aVThe dialog will always be on top of the child windows
p36077
aVYou typically do want StartPosition = Manual and set Location so you can be sure it starts up at an appropriate position within the parent frame
p36078
as(dp36079
g9
V17034
p36080
stp36081
a((dp36082
g2
(lp36083
VYou are reading raw binary data from a process, that will be a string only by accident
p36084
aVIf it is a string at all, it is definitely not going to be encoded in UTF8
p36085
aVThat's a format that you'd only ever see in files or data sent across the Internet
p36086
aVThe in-memory representation of strings are ASCII or UTF-16
p36087
aVBut start out dumping this data in the same kind of format the debugger uses in the Debug + Windows + Memory 1 window
p36088
aVYou can find the code to do so in this post
p36089
as(dp36090
g9
V17034
p36091
stp36092
a((dp36093
g2
(lp36094
VNot a problem, VC has a C89 compatible C compiler
p36095
aVIt autodetects the language from the file name extension, a
p36096
aVc file will be compiled as C
p36097
aVOr you force it by right-clicking the file, Properties, C/C++, Advanced, Compile As = /TC
p36098
aVAvoid that
p36099
aVWhen you start out with the Win32 Console Application project template then you'll need to make a few changes
p36100
aVThe template was designed assuming you'd use C++
p36101
aVRight-click stdafx
p36102
aVcpp, Rename to stdafx
p36103
aVc
p36104
aVRepeat on the project's
p36105
aVcpp file
p36106
aVEverything will now be compiled as C, including support for precompiled headers
p36107
aVThere's something to be said for starting in C++ right away btw
p36108
aVMaybe a good topic for another question
p36109
as(dp36110
g9
V17034
p36111
stp36112
a((dp36113
g2
(lp36114
VThe RegionInfo class is your primary resource
p36115
aVIt includes currency names (ISO, English and native) and two and three letter region names
p36116
as(dp36117
g9
V17034
p36118
stp36119
a((dp36120
g2
(lp36121
VI don't see any code for that class
p36122
aVBut it almost certainly uses the RegisterHotKey() API function
p36123
aVWhich works for keyboard keys, not mouse buttons
p36124
aVTo globally trap mouse button events you need to use SetWindowsHookEx, using a WH_MOUSE_LL hook
p36125
aVThat googles really well, you'll find many examples
p36126
as(dp36127
g9
V17034
p36128
stp36129
a((dp36130
g2
(lp36131
VNo, that's the correct way to do it
p36132
aVThis worked exactly as it should, something you can work from perhaps:
p36133
as(dp36134
g9
V17034
p36135
stp36136
a((dp36137
g2
(lp36138
VThe View
p36139
aVNextError and View
p36140
aVPreviousError commands work just fine to jump between errors detected by IntelliSense on my machine
p36141
aVNot sure what your problem might be, do verify that these errors are listed in the Error List window
p36142
aVTapping your foot a few times to allow the IntelliSense parser to catch up might be necessary
p36143
as(dp36144
g9
V17034
p36145
stp36146
a((dp36147
g2
(lp36148
VJust read a line from the SR before you pass it to the CSVReader constructor
p36149
aVFor example:
p36150
as(dp36151
g9
V17034
p36152
stp36153
a((dp36154
g2
(lp36155
VThe problem is your message loop, it burns 100% CPU cycles because you use PeekMessage()
p36156
aVWindows knows how to keep the hook alive even if you don't poll for messages, use GetMessage() to solve your problem
p36157
aVUsing Sleep(1) will solve your problem too but is not necessary here
p36158
as(dp36159
g9
V17034
p36160
stp36161
a((dp36162
g2
(lp36163
VThis is because you've got them in a Folder in the solution
p36164
aVThe pragmatic solution is to simply add them to the solution root, the actual location of the file doesn't matter
p36165
aVThat perhaps creates a wee bit of clutter in your Solution Explorer window
p36166
aVIf that's unacceptable then a pre-build event that uses xcopy /d is the workaround
p36167
as(dp36168
g9
V17034
p36169
stp36170
a((dp36171
g2
(lp36172
VSelect the
p36173
aVmdf in the Solution Explorer window
p36174
aVIn the Properties window, change Copy to Output Directory to "Copy if newer"
p36175
as(dp36176
g9
V17034
p36177
stp36178
a((dp36179
g2
(lp36180
VYou are passing a 0 for the last argument of MapViewOfFile()
p36181
aVThat argument is named dwNumberOfBytesToMap
p36182
aVSince you picked zero, the entire 2 gigabytes is going to be mapped
p36183
aVThis cannot work in 32-bit mode, there is not nearly enough virtual memory available
p36184
aVThe ptr value will be NULL, any attempt to write through the pointer is going to generate an AV
p36185
aVYou'll need to map sections of the file
p36186
as(dp36187
g9
V17034
p36188
stp36189
a((dp36190
g2
(lp36191
VYou are going down into a pretty deep rabbit hole
p36192
aVWriting your own C# language parser is a task that can keep you occupied for a long time, with a pay-off that enhances your skill as a programmer but doesn't turn the boss' frown upside-down
p36193
aVYou are re-inventing a wheel
p36194
aVThe DataSet designer built into Visual Studio already does what you're trying to do
p36195
aVIt could be argued that it is the wrong wheel, the fans of NHibernate will certainly think so
p36196
aVThey generate the dbase schema from the C# class declarations
p36197
aVRescue your plan by considering that modifying an existing C# class that models the dbase is not necessary
p36198
aVJust re-generate the class from scratch every time you compile
p36199
aVIt normally only takes a fraction of a second
p36200
aVThe compiler will dutifully warn you when there's a breaking change
p36201
aVThat's how the Settings designer and the Resource designer work
p36202
as(dp36203
g9
V17034
p36204
stp36205
a((dp36206
g2
(lp36207
VThere's a WF bug that will double the glyphs if you create the MDI child form in the parent's constructor
p36208
aVHere's an example:
p36209
aVMove the child form creation code to the Load event to avoid this
p36210
as(dp36211
g9
V17034
p36212
stp36213
a((dp36214
g2
(lp36215
VP/Invoke AnimateWindow() to get transitions
p36216
aVVisit pinvoke
p36217
aVnet for the required declarations
p36218
as(dp36219
g9
V17034
p36220
stp36221
a((dp36222
g2
(lp36223
VUsing ref is simply wrong, your IUnknown is already passed as a pointer since it is an interface
p36224
aVPassing ref would be equivalent to IUnknown**
p36225
as(dp36226
g9
V17034
p36227
stp36228
a((dp36229
g2
(lp36230
VMSCommLib is an ancient VB6 control
p36231
aVI don't have it either anymore, even though I installed the VB6 runtime support on this machine
p36232
aVYou'd have to dig up an old VB6 installer somewhere, no idea where to look
p36233
aVMaybe you can get it from an old machine, copy mscomm32
p36234
aVocx into your c:\u005cwindows\u005csystem32 folder and register it with RegSvr32
p36235
aVexe
p36236
aVTime to switch to System
p36237
aVIO
p36238
aVPorts
p36239
aVSerialPort perhaps
p36240
as(dp36241
g9
V17034
p36242
stp36243
a((dp36244
g2
(lp36245
VExact same answer as your other question, this time it is msmapi32
p36246
aVocx
p36247
aVReview this Support Statement article for more details, note that these controls are in the "supported, but install yourself" block
p36248
as(dp36249
g9
V17034
p36250
stp36251
a((dp36252
g2
(lp36253
VThe best you can get out the Win32 API is one millisecond with timeBeginPeriod and timeSetEvent
p36254
aVMaybe your HAL can do better but that's academic, you cannot write device driver code in C#
p36255
as(dp36256
g9
V17034
p36257
stp36258
a((dp36259
g2
(lp36260
VIt is called Compound Files, part of the Structured Storage API
p36261
aVYou start with StgOpenStorageEx()
p36262
aVIt buys you little for a Word
p36263
aVdoc file, the streams themselves have a sophisticated binary format
p36264
aVTo really read the document content you want to use automation, letting Word read the file
p36265
aVThat's rarely done in C++ but that project shows you how
p36266
as(dp36267
g9
V17034
p36268
stp36269
a((dp36270
g2
(lp36271
VThe FlowLayoutPanel control does this automatically
p36272
aVJust put the group boxes inside of it
p36273
as(dp36274
g9
V17034
p36275
stp36276
a((dp36277
g2
(lp36278
VTools + Options, Projects and Solutions, Build and Run
p36279
aVThe setting "On Run, when projects are out of date" is relevant
p36280
aVYou'll probably want "Always build"
p36281
aVThe setting for the next one has "Do not launch" as the only sane option
p36282
as(dp36283
g9
V17034
p36284
stp36285
a((dp36286
g2
(lp36287
VYes, you can do that by using the XmlSerializer constructor that takes a XmlAttributesOverrides object
p36288
aVProviding your own XmlRootAttribute is explicitly supported
p36289
aVIt is all well explained in the MSDN Library topic
p36290
as(dp36291
g9
V17034
p36292
stp36293
a((dp36294
g2
(lp36295
VBeware that fractions like these cannot be accurately represented in floating point
p36296
as(dp36297
g9
V17034
p36298
stp36299
a((dp36300
g2
(lp36301
VKeep your eyes on the ball, the warning you get is for a managed C++ assembly
p36302
aVAnd the platform target setting for an unmanaged DLL is of no consequence, it won't use any
p36303
aVNET references while being built
p36304
aVYes, they could not make the platform target setting editable in the C++ IDE, the VS2008 tool chain is required to build C++/CLI assemblies for 3
p36305
ag2447
aVThis blog post explains the workaround
p36306
aVYou can upvote this feedback article if you're unhappy with that
p36307
as(dp36308
g9
V17034
p36309
stp36310
a((dp36311
g2
(lp36312
VYou forgot an important one:
p36313
aVthe lunatic that will maintain your code some day will find out where you live and hurt you
p36314
as(dp36315
g9
V17034
p36316
stp36317
a((dp36318
g2
(lp36319
VYou need to implement a message handler for WM_MINMAXINFO
p36320
as(dp36321
g9
V17034
p36322
stp36323
a((dp36324
g2
(lp36325
VThe C# language supports this with escapes:
p36326
aVBut that isn't available in VB
p36327
aVNET
p36328
aVBeware that you almost certainly don't want to use Chr(), that is meant for legacy code that works with the default code page
p36329
aVYou'll want ChrW() and pass the Unicode codepoint
p36330
aVYou're specific example is not a problem, &H0030; is the code for "0" so you can simply put it directly in the string literal
p36331
aVYou can use the Charmap
p36332
aVexe utility to copy and paste glyphs that don't have an easy ASCII code
p36333
as(dp36334
g9
V17034
p36335
stp36336
a((dp36337
g2
(lp36338
VIt is a low-level Windows error
p36339
aVCould be a bug in Crystal Reports, could be a bug in the printer driver, could be environmental with some kind of misbehaving system add-on
p36340
aVYou'll never find out which it is if you don't have the source code for these large chunks of code so you can debug it
p36341
aVYou don't and you can get it
p36342
aVIt is not a bug in your code, ask the IT staff to get that user another machine
p36343
aVIf that doesn't help then you'll have to bounce this to Crystal Decisions (or whatever they are called these days)
p36344
aVThis is otherwise a standard IT matter
p36345
as(dp36346
g9
V17034
p36347
stp36348
a((dp36349
g2
(lp36350
VIt is whatever user account was used to configure the service
p36351
aVCould be anything, it is up to the system admin to pick these accounts
p36352
aVWhich of course means that you can not reliably use it to detect whether your code runs in a service
p36353
aVYou should let the service that uses your DLL tell you that it is a service, it always knows
p36354
aVAuto-detecting is tricky, GetProcessWindowStation() ought to be a lead
p36355
aVCall GetUserObjectInformation on the returned handle with the UOI_FLAGS flag and check if you get USEROBJECTFLAGS
p36356
aVdwFlags = WSF_VISIBLE
p36357
aVThere could be some degenerate cases with RDP I suppose but you can see if a user has odds of seeing process output
p36358
as(dp36359
g9
V17034
p36360
stp36361
a((dp36362
g2
(lp36363
VIt is an age-old bug in the visual styles renderer for the native Windows tab control
p36364
aVIt only supports tabs at the top, the Microsoft programmer that worked on it was run over by a bus before she could finish the job, I guess
p36365
aVThe only thing you can do about it is selectively turn off visual styles for the control
p36366
aVAdd a new class to your project and paste the code shown below
p36367
aVCompile
p36368
aVDrop the new control from the top of the toolbox onto your form, replacing the original
p36369
as(dp36370
g9
V17034
p36371
stp36372
a((dp36373
g2
(lp36374
VStructs are difficult to deal with in a PropertyGrid because they are value types
p36375
aVAssigning a field or a property of a struct has no effect, the entire struct value needs to be assigned
p36376
aVNote how Font is a class, setting individual Font properties in the grid is not a problem
p36377
aVFont has a TypeConverter (System
p36378
aVDrawing
p36379
aVFontConverter) which takes a string and converts it to a Font
p36380
aVThat's why you can edit the Font value directly instead of having to expand the node and edit individual properties
p36381
aVIt also has a UITypeEditor, System
p36382
aVDrawing
p36383
aVDesign
p36384
aVFontEditor, which presents the dialog when you click the button with the dots
p36385
aVWhich is what you probably need to do for your property if you want to use to pick from predefined styles
p36386
aVA good example of a UITypeEditor for a struct is System
p36387
aVDrawing
p36388
aVDesign
p36389
aVColorEditor, use Reflector to have a look at the class
p36390
aVTo just expose the properties you need a TypeConverter, a good example of one for a struct type is System
p36391
aVDrawing
p36392
aVPointConverter
p36393
as(dp36394
g9
V17034
p36395
stp36396
a((dp36397
g2
(lp36398
VWell, looks like your
p36399
aVconfig file isn't working
p36400
aVThat could happen when you try to debug the VB6 application from the VB6 IDE, the CLR will look in the wrong directory for the
p36401
aVconfig file
p36402
aVThe ultimate tool you need to troubleshoot this is fuslogvw
p36403
aVexe, it shows you where the CLR looked for the assembly
p36404
as(dp36405
g9
V17034
p36406
stp36407
a((dp36408
g2
(lp36409
VEditing my answer, the original one was incorrect
p36410
aVYes, the Path
p36411
aVNormalizePath() method went through some major changes in
p36412
aVNET 4
p36413
ag2512
aVI managed to get this debugged with the Reference Source and found a comment in the source code that explains its behavior:
p36414
aVThat's the exception that is tripped by your code
p36415
aVIt looks screwy because the code appears to check the directory name length which is obviously not close to 255 chars in your code
p36416
aVHowever, the comment explains why your path is rejected, the file name part of the path is 259-3 = 256 characters
p36417
aVOne too many
p36418
aVI was not previously aware of this restriction and am a bit doubtful that all versions of Windows have this restriction
p36419
aVAll I've seen documented that there's indeed a maximum length of the directory name (path minus filename)
p36420
aVThere are other comments in the code that suggest that there is an off-by-one bug in Windows 2000, that might have something to do with it
p36421
aVAnyhoo, you can see this for yourself by changing
p36422
aVAnd now a path string of 259 chars is accepted
p36423
aVIn other words, this behavior should only ever byte if the path name refers to the drive root folder
p36424
aVNot a place where you ever should store files
p36425
aVGiven the comment in the source code, this change was quite intentional and should be regarded as a feature, not a bug
p36426
aVNevertheless, I posted a comment to the feedback article you started
p36427
aVI'm still not buying it completely
p36428
aVUpdate: okay I'm sold on it
p36429
aVI tried creating such a file using C++ on Win7 and it failed
p36430
aVFiles in the root directory indeed cannot have path names longer than 258 chars
p36431
aVThe restriction appears to be induced by a component of the path (subdirectory name, file name) not allowed to be longer than 255 chars
p36432
aVThe
p36433
aVNET 4
p36434
aV0 behavior is entirely correct
p36435
as(dp36436
g9
V17034
p36437
stp36438
a((dp36439
g2
(lp36440
VIt is explicit in chapter 3
p36441
aV3 of the Visual Basic 9
p36442
aV0 Language Specification:
p36443
aVRegion directives group lines of source code but have no other effect on compilation
p36444
aVThe entire group can be collapsed and hidden, or expanded and viewed, in the integrated development environment (IDE)
p36445
aVThese directives are special in that they can neither start nor terminate within a method body
p36446
aVOr in other words: you cannot do it because the specification says so
p36447
aVAs to why it was specified like this, I reckon it has something to do with the age-old IDE feature that VB has had for as long as I can remember: Tools + Options, Text Editor, Basic, VB Specific, Show procedure line separators
p36448
aVThat's just a guess, probably not a very good one
p36449
as(dp36450
g9
V17034
p36451
stp36452
a((dp36453
g2
(lp36454
VThe more traditional message loop looks like this:
p36455
aVIt is a pretty big hint to what you'd want to do before dispatching the message: catch messages that ought to be intercepted and treated specially before the window sees them
p36456
aVKeyboard shortcuts are a classic example, they need to be detected no matter what window has the focus
p36457
aVAny GUI class library exposes it with a virtual method named something like App
p36458
aVPreProcessMessage, a virtual function that can be overridden so your program can implement its own shortcuts and whatnot
p36459
as(dp36460
g9
V17034
p36461
stp36462
a((dp36463
g2
(lp36464
VExpecting us to debug such an issue from pseudo code is not realistic
p36465
aVUse FlushFileBuffers to ensure all data in the pipe is written
p36466
as(dp36467
g9
V17034
p36468
stp36469
a((dp36470
g2
(lp36471
VSending WM_KEYDOWN/UP is troublesome
p36472
aVThe application itself already translates the WM_KEYDOWN message into WM_CHAR, using the state of the modifier keys (Shift, Alt, Ctrl) and the keyboard layout
p36473
aVNeither of which you can control, you'll get the wrong character, randomly
p36474
aVJust send WM_CHAR messages, set the wparam to the character code
p36475
aVNo need to worry about lparam, few apps ever use it
p36476
as(dp36477
g9
V17034
p36478
stp36479
a((dp36480
g2
(lp36481
VI repro this
p36482
aVThe exception message is bogus, that's common for GDI+ exceptions
p36483
aVThe source of the problem is the jpeg codec, GetEncoderParameterList() queries it for the list of parameters it supports
p36484
aVThe list it gets back contains one bad entry, the NumberOfValues is 0
p36485
aVThat causes Marshal
p36486
aVAllocHGlobal() to return a NULL, misinterpreted as an out-of-memory exception, which is turn is misinterpreted as a "Bitmap region is already locked" exception
p36487
aVUgh, GDI+ sure is a mess
p36488
aVThis problem is almost certainly specific to GDI+ version 1
p36489
aV10, the version that first shipped with Vista
p36490
aVCould be Win7 specific too, I've seen several forum posting about problems with the JPEG codec on that operating system
p36491
aVWell, nothing you can do about it until the next Windows service pack becomes available, if then
p36492
aVTo address your specific query, no, probably not
p36493
aVThe list of encoder parameters that GDI+ knows about is listed in the GdiPlusImaging
p36494
aVh SDK header file
p36495
aVThe only one that's close is "EncoderChrominanceTable", available as Encoder
p36496
aVChrominanceTable
p36497
aVGuid in the
p36498
aVNET framework
p36499
aVNo idea if that's close to what you are looking for
p36500
aVYou should really consider the WPF JpegBitmapEncoder class, a major improvement over GDI=
p36501
as(dp36502
g9
V17034
p36503
stp36504
a((dp36505
g2
(lp36506
s(dp36507
g9
V17034
p36508
stp36509
a((dp36510
g2
(lp36511
VThere is an implicit race condition in CreateThread: you cannot obtain the thread ID until after the thread started running
p36512
aVIt is entirely unpredictable when the call returns, for all you know the thread might have already completed
p36513
aVIf the thread causes any interaction in the rest of that process that requires the TID then you've got a problem
p36514
aVIt is not an unsolvable problem if the API doesn't support starting the thread suspended, simply have the thread block on a mutex right away and release that mutex after the CreateThread call returns
p36515
aVHowever, there's another use for CREATE_SUSPENDED in the Windows API that is very difficult to deal with if API support is lacking
p36516
aVThe CreateProcess() call also accepts this flag, it suspends the startup thread of the process
p36517
aVThe mechanism is identical, the process gets loaded and you'll get a PID but no code runs until you release the startup thread
p36518
aVThat's very useful, I've used this feature to setup a process guard that detects process failure and creates a minidump
p36519
aVThe CREATE_SUSPEND flag allowed me to detect and deal with initialization failures, normally very hard to troubleshoot
p36520
as(dp36521
g9
V17034
p36522
stp36523
a((dp36524
g2
(lp36525
VComboBox auto-sizes to fit the font
p36526
aVTurning that off is not an option
p36527
aVIf you want it bigger then give it a bigger font
p36528
as(dp36529
g9
V17034
p36530
stp36531
a((dp36532
g2
(lp36533
VCopy MuskOx
p36534
aVexe and Kctc
p36535
aVdll to the target machine
p36536
aVRun installutil
p36537
aVexe to get it registered, its available in c:\u005cwindows\u005cmicrosoft
p36538
aVnet\u005cframework\u005cv2
p36539
ag2512
aV50727
p36540
as(dp36541
g9
V17034
p36542
stp36543
a((dp36544
g2
(lp36545
VThe FileVersionInfo class is useful here
p36546
aVThe [AssemblyProduct] attribute gets compiled into the unmanaged version info resource
p36547
aVThis code works on any
p36548
aVexe:
p36549
as(dp36550
g9
V17034
p36551
stp36552
a((dp36553
g2
(lp36554
VYou'd need Visual Studio 2002, it targeted
p36555
aVNET 1
p36556
ag2512
aVThat edition didn't last long, Visual Studio 2003 and
p36557
aVNET 1
p36558
aV1 quickly followed
p36559
aVYour project should have good odds opening and running properly on that edition
p36560
aVOdds get lower once you move to VS 2005/8 and
p36561
aVNET 2
p36562
aV0+
p36563
aVIf you don't have VS2002 then you can obtain a license through an MSDN Library subscription
p36564
aVAn auction site like Ebay is a cheaper alternative
p36565
as(dp36566
g9
V17034
p36567
stp36568
a((dp36569
g2
(lp36570
VJust changing the [AssemblyVersion] of the debug version would be the quick fix
p36571
aVRunning gacutil
p36572
aVexe to temporarily remove the assembly from the GAC would be another
p36573
as(dp36574
g9
V17034
p36575
stp36576
a((dp36577
g2
(lp36578
VIt doesn't work the way you think it does
p36579
aVBy assigning the SelectedIndex property, you don't select the dropdown list item, you set the text in the text box portion of the combo box
p36580
aVThe drop down list responds to that by selecting the list item that matches the text box text
p36581
aVProblem is: it does so in a case-insensitive way
p36582
aVYou can easily see this for yourself by setting the 2nd item to, say, "D"
p36583
aVThat fixes it
p36584
aVOr set the first item to "b", now the first item gets selected
p36585
aVNo, there's no easy fix for that
p36586
aVThe hard one is to obtain the handle to the listbox control in the dropdown event with CB_GETCOMBOBOXINFO, then sending it the LB_SETSEL message
p36587
aVThe pragmatic fix is to not make the list items differ only by case
p36588
aVTends to confuse the user anyway
p36589
as(dp36590
g9
V17034
p36591
stp36592
a((dp36593
g2
(lp36594
VNo there's not
p36595
aVThe type library merely describes the interfaces, it is used by a compiler
p36596
aVWhether an oop or inproc server is used is a runtime detail, determined by the dwClsContext argument for CoCreateInstance()
p36597
aVA COM server can support both, although that's not exactly common
p36598
aVYou'd always know enough about the server to know what CLSCTX value to pass
p36599
aVIf you really want to find out you can always read it back from the registry by opening the CLSID key
p36600
aVLook for LocalServer32 vs InprocServer32
p36601
as(dp36602
g9
V17034
p36603
stp36604
a((dp36605
g2
(lp36606
VThe code is littered with time bombs
p36607
aVThat starts with FileSaveBox where you pass a string buffer but don't tell the function how long the buffer is
p36608
aVAdd copious amounts of _swprintf, wcscpy and wcscat calls, none of which checks if the buffer may overrun and the RTC error is easily explained
p36609
aVYou know how to use wcspcy_s and wcscat_s, make it consistent
p36610
as(dp36611
g9
V17034
p36612
stp36613
a((dp36614
g2
(lp36615
VThe garbage collector gets lifetime hints from the JIT compiler
p36616
aVIt thus knows that at the GC
p36617
aVCollect() call there are no more possible references to the local variables and that they therefore can be collected
p36618
aVReview GC
p36619
aVKeepAlive()
p36620
aVWhen a debugger is attached, JIT optimization is disabled and the lifetime hint gets extended to the end of the method
p36621
aVMakes debugging a lot simpler
p36622
aVI wrote a much more detailed answer about this, you'll find it here
p36623
as(dp36624
g9
V17034
p36625
stp36626
a((dp36627
g2
(lp36628
VThat doesn't convert it
p36629
aVIt produces a single character if tmp contains English text
p36630
aVAnd a common saying from the land of Jibber if it contains Arabic text
p36631
aVConverting from UTF-16, as used by OLE Automation and the DBGrid you are using to 8-bit characters cannot be done with a cast, it requires a conversion function
p36632
aVLike WideCharToMultiByte or OLE2A
p36633
aVSuch a conversion will only reproduce legible text when the code page for the thread matches the character set used in the string
p36634
aVWhich, if the grid shows Arabic and either your thread or the code page you convert to is English produces nothing but a bunch of question marks
p36635
aVIf you don't want to Unicode-enable your code then you can't switch between character sets on the fly
p36636
aVThe operating system you are running this code on has supported it for the past 17 years
p36637
as(dp36638
g9
V17034
p36639
stp36640
a((dp36641
g2
(lp36642
VIn the C# language, nested classes have no special relationship with the class in which they are nested
p36643
aVIt is a completely different type
p36644
aVThere is only one good reason you'd ever do this: you can declare the class private
p36645
aVWhich helps you to create a little worker class to get a job done on behalf of the outer class, a class that is completely invisible from the outside
p36646
aVVery useful, you cannot otherwise declare a private class at outer class scope, the best you can do is internal
p36647
aVWhat follows is that it in no way plays a role in the inheritance of the outer class
p36648
aVA class you derive from the outer has no visibility to the nested class inside the base class at all
p36649
aVWhich was the intention, declaring it private was the reason to nest it in the first place
p36650
aVPunt: if you need that class in the derived one just declare it internal or public
p36651
as(dp36652
g9
V17034
p36653
stp36654
a((dp36655
g2
(lp36656
VYes, asynchronous requests can often be handled without the expense of a thread
p36657
aVThe operating system has special support for them, features like overlapped I/O and completion ports
p36658
aVWhat they essentially do is leverage the expense of a kernel thread, one that's needed anyway because a driver needs to be able to handle multiple requests from multiple user mode programs
p36659
aVThe
p36660
aVNET framework readily takes advantage of that in its BeginXxx() methods
p36661
aVUsing threadpool threads is cheap too, but you are subject to the behavior of the threadpool scheduler
p36662
aVWhich doesn't much like starting more TP threads then there are cores
p36663
aVTP threads should never be used for code that can stay blocked for a while, pretty typical for CS tasks like making a connection
p36664
aVError handling is very difficult in asynchronous code
p36665
aVYou typically have very little context when the EndXxxx() method raises an exception
p36666
aVIt happens on a callback thread, very far away from the main logic
p36667
aVOkay when you can shrug "didn't happen, lets log it", total bedlam and redrum when the program's state depends on it
p36668
aVAlways choose synchronous mode in the latter case
p36669
as(dp36670
g9
V17034
p36671
stp36672
a((dp36673
g2
(lp36674
VGetThreadTimes() provides this info
p36675
aVVery hard to use however since it requires a handle to the thread, something the
p36676
aVNET framework doesn't let you do
p36677
aVThe simple solution is to start a Stopwatch inside the thread function and Stop() it at its completion
p36678
as(dp36679
g9
V17034
p36680
stp36681
a((dp36682
g2
(lp36683
VThe check box size is hardcoded inside Windows Forms, you cannot mess with it
p36684
aVOne possible workaround is to draw a check box on top of the existing one
p36685
aVIt is not a great solution since auto-sizing cannot work anymore as-is and text alignment is muddled, but it is serviceable
p36686
aVAdd a new class to your project and paste the code shown below
p36687
aVCompile
p36688
aVDrop the new control from the top of the toolbox onto your form
p36689
aVAdjust the size of the control so you get the desired box size and ensure it is wide enough to fit the text
p36690
as(dp36691
g9
V17034
p36692
stp36693
a((dp36694
g2
(lp36695
VThe managed code cannot free the memory, it doesn't have access to the allocator built into the CRT
p36696
aVYou could use CoTaskMemAlloc() to allocate the buffer instead, the managed code can call Marshal
p36697
aVFreeCoTaskMem()
p36698
aVYou'd have to declare the buffer pointer argument as "ref IntPtr" or declare the return type of the function as IntPtr
p36699
aVWhich gives the managed code the hassle of converting it to a managed byte array
p36700
aVThis is not pretty, these problems disappear when you write the code in C++/CLI or write a COM server
p36701
as(dp36702
g9
V17034
p36703
stp36704
a((dp36705
g2
(lp36706
VThe P/Invoke marshaller finds an entrypoint in a DLL by using LoadLibrary() and GetProcAddress()
p36707
aVAnd knows how to convert a C# declaration to the equivalent of a delegate declaration
p36708
aVDoing this yourself has no advantage beyond maybe a wee bit of efficiency
p36709
aVWhich you'd better measure, it is no slamdunk
p36710
as(dp36711
g9
V17034
p36712
stp36713
a((dp36714
g2
(lp36715
VThe problem is your program's startup thread
p36716
aVIt creates the COM object, starts a thread, then exits
p36717
aVAs part of the cleanup of that main thread,
p36718
aVNET calls CoUninitialize() and that's the end of the COM object
p36719
aVGetting that error is the expected result
p36720
aVThere's just no point in letting your main startup thread exit like that
p36721
aVLet it do the work now done by your own thread, problem solved
p36722
as(dp36723
g9
V17034
p36724
stp36725
a((dp36726
g2
(lp36727
VLook at the exception's InnerException property
p36728
aVThat tells you what really went wrong
p36729
aVIf that doesn't help, update your question with its message and stacktrace
p36730
as(dp36731
g9
V17034
p36732
stp36733
a((dp36734
g2
(lp36735
VThis doesn't work because MessageBox uses a proportionally spaced font, the letter M is much wider than the letter l
p36736
aVJust like it is in this message your are reading now
p36737
aVYou can only expect alignment like this to work if it is displayed with a fixed-pitch font
p36738
aVChanging the message box font is not appropriate, it is a system setting
p36739
aVYou can get it somewhat better by using tabs:
p36740
aVbut it isn't fool-proof if the field size approaches the tab size
p36741
aVUse a ListView with View = Details instead
p36742
as(dp36743
g9
V17034
p36744
stp36745
a((dp36746
g2
(lp36747
VUse the RichTextBox
p36748
aVGetFirstCharIndexFromLine() method to find out where to insert the text
p36749
aVFor example:
p36750
as(dp36751
g9
V17034
p36752
stp36753
a((dp36754
g2
(lp36755
VA structure is a value type, it cannot be Nothing
p36756
aVThe Nullable type can solve your problem, put a question mark after the type name to make it short and snappy
p36757
aVHere's an example:
p36758
as(dp36759
g9
V17034
p36760
stp36761
a((dp36762
g2
(lp36763
VIt's available, assuming you've already written the
p36764
aVcpp file
p36765
aVUse File + New + Project From Existing Code
p36766
aVYou'll get a point-and-click wizard with a bunch of questions that need to be answered
p36767
aVI reckon you'll use this a few times, then discover it is just simpler to start a new project from scratch with the Win32 Console Application template
p36768
aVJust add your
p36769
aVcpp to the project's Source Files folder
p36770
as(dp36771
g9
V17034
p36772
stp36773
a((dp36774
g2
(lp36775
VI recommend taking a look at it with Spy++
p36776
aVEverything is composed from standard Windows controls, heavily nested
p36777
aVThe drop-down is implemented as, drumroll, a combo box
p36778
aVIt is a largely forgotten customized one, named ComboBoxEx
p36779
aVI've never seen a
p36780
aVNET wrapper for it, probably because it does a job that's easily implemented by the plain old ComboBox wrapper in Windows Forms
p36781
aVJust set its DrawMode property to OwnerDrawFixed and implement the DrawItem event to show the icon and the text
p36782
aVThere's a very good example available in the MSDN Library article for it
p36783
as(dp36784
g9
V17034
p36785
stp36786
a((dp36787
g2
(lp36788
VIt more than likely just isn't a HMENU
p36789
aVCustom menu implementations are common, the one Window provides is dated and inflexible
p36790
aVCompare to Windows Forms' MenuStrip for example
p36791
aVOf course, that blows a gaping hole in your approach
p36792
as(dp36793
g9
V17034
p36794
stp36795
a((dp36796
g2
(lp36797
VYes, the NXCOMPAT flag is turned on by the standard
p36798
aVNET language compilers since
p36799
aVNET 2
p36800
aV0 SP1
p36801
aVASLR is essentially automatic in
p36802
aVNET programs by virtue of the JIT compiler
p36803
aVWhere it will place the JIT compiled machine code is unpredictable
p36804
aVAlbeit that it will likely be repeatable on the exact same machine with the exact same revision number of the CLR and the exact same flow of the startup code and the exact same DLLs getting injected into the process
p36805
aVNot easily targetable by malware though
p36806
aVThe ngen-ed
p36807
aVNET assemblies support ASLR since the
p36808
aVNET 3
p36809
aV5 SP1 release
p36810
aVASLR protects against known unpatchable security flaws
p36811
aVThe security flaw has to exist first, uncommon in verifiable code
p36812
as(dp36813
g9
V17034
p36814
stp36815
a((dp36816
g2
(lp36817
VNET framework versioning went foobar after
p36818
aVNET 2
p36819
ag2512
aVAn app targets a CLR version, it does so with the assembly metadata for the EXE
p36820
aVAnd there are currently four of them, 1
p36821
aV0, 1
p36822
aV1, 2
p36823
aV0 and 4
p36824
ag2512
aVNot counting special ones like used by the Compact Framework, Silverlight, Micro Framework
p36825
aVFramework versions 2
p36826
aV0, 2
p36827
aV0SP1, 2
p36828
aV0SP2, 3
p36829
aV0, 3
p36830
aV5 and 3
p36831
aV5SP1 all target the same CLR version, 2
p36832
ag2512
aV50727
p36833
aVWhat's different between these releases is that they have additional assemblies available in later versions
p36834
aVThe kind that support features like WPF, WCF and LINQ
p36835
aVThey are additive, just more goodies added to something that was already pretty solid
p36836
aVYou never really have to guess what version of the framework your program needs, just open the References node in the Solution Explorer window and look at the assembly version numbers
p36837
aVOr set the Target Framework property in your project and work your way up until the compiler stops complaining
p36838
aVBack to your original question: the version you give your own
p36839
aVNET app is entirely up to you
p36840
aVEdit the [AssemblyVersion] attribute in the AssemblyInfo
p36841
aVcs file
p36842
as(dp36843
g9
V17034
p36844
stp36845
a((dp36846
g2
(lp36847
VYes, QUWI but also a delegate type's BeginInvoke() method
p36848
aVAnd employed by a few classes, BackgroundWorker is the best known example
p36849
aVWhich under the hood merely uses delegate's BeginInvoke()
p36850
aVI/O completion threads are a very low-level Windows feature to get code to run quickly when an I/O request completes
p36851
aVMost visible from the ReadFileEx() function's last argument, there are others
p36852
aVThe managed equivalent is exposed through ThreadPool
p36853
aVBindHandle()
p36854
aVIt is the job of
p36855
aVNET classes to get that right
p36856
aVJust a few use it: FileStream, PipeStream, FileSystemWatcher, Socket, SerialPort's internal worker thread and some WCF channel support classes
p36857
aVI'm personally not a big fan of getting these config details exposed in the API, especially the I/O completion thread ones
p36858
aVIt's a bit of a cop-out by the BCL team, some FUD on their end
p36859
aVThese settings affect the entire program, the defaults are already quite generous
p36860
aVTinkering with them is roughly equivalent to calling GC
p36861
aVCollect()
p36862
aVIf you ever manage to find a good reason to change them, that better be when stuck in a hellhole with only one hour left to catch the plane back home
p36863
aVBeen there :)
p36864
as(dp36865
g9
V17034
p36866
stp36867
a((dp36868
g2
(lp36869
VWell, there's a specific Windows API function for enumerating child windows: EnumChildWindows()
p36870
aVPass the parent window handle and a callback
p36871
aVThere has to be some "special" about the child window you want to find
p36872
aVCounting them down in the callback could suffice
p36873
aV"Previous-to-last" is very possible too, just needs two variables
p36874
as(dp36875
g9
V17034
p36876
stp36877
a((dp36878
g2
(lp36879
VThere are two considerations here
p36880
aVFirst off, header files are not nearly as important in managed code as they are in native C or C++
p36881
aVManaged code compilers read declarations from the assembly metadata, you don't (and shouldn't) write C++/CLI type declarations that need to be visible in other modules in header files
p36882
aVGetting them from the metadata makes your types available to any
p36883
aVNET language
p36884
aVBut the real reason is because of the way the form designer works in the C++ IDE
p36885
aVIt is a code generator, driven by the controls you drop on a form or user control and the properties you set in the Properties window
p36886
aVThere is a very awkward problem if that code generator needs to generate code in two separate files
p36887
aVNot so much the generating bit, but removing code when you alter the design of the form
p36888
aVGetting the files out of sync produces difficult to diagnose compile errors from auto-generated code
p36889
aVIt is a lot more likely to happen than you might think btw, the code generator needs to work with source code files that are in the process of being edited
p36890
aVVery difficult, the code might not parse at all
p36891
aVThe C++ IDE uses the original approach taken by the version 1
p36892
aV1 C# and VB
p36893
aVNET designers, everything goes in one file
p36894
aVWhich is unpleasant of course, declarations and code shouldn't be mixed
p36895
aVThat was solved in those designers for version 2
p36896
aV0 by adding support to the C# and VB
p36897
aVNET languages for partial classes
p36898
aVThat however didn't happen for C++/CLI
p36899
aVNot sure why, the C++/CLI team always looked resource constrained compared to those other teams
p36900
aVIt also doesn't have any kind of refactoring support, which is very important to rename methods when the class name changes
p36901
aVKeeping the methods inline avoids the problem
p36902
aVAnyhoo, you can get your code in the
p36903
aVcpp file but you have to do it yourself
p36904
aVCut+paste gets it done, but you'll also have to edit the class name back into the method declarations
p36905
aVThis is high maintenance, consider if it is worth the effort
p36906
aVAlso consider whether you really want to use C++/CLI for the UI, it is an uncommon choice
p36907
as(dp36908
g9
V17034
p36909
stp36910
a((dp36911
g2
(lp36912
VThe
p36913
aVNET TreeView class heavily customizes mouse handling for the native Windows control in order to synthesize the Before/After events
p36914
aVUnfortunately, they didn't get it quite right
p36915
aVWhen you start clicking fast, you'll generate double-click messages
p36916
aVThe native control responds to a double-click by toggling the checked state for the item, without telling the
p36917
aVNET wrapper about it
p36918
aVYou won't get a Before/AfterCheck event
p36919
aVIt's a bug but they won't fix it
p36920
aVThe workaround is not difficult, you'll need to prevent the native control from seeing the double-click event
p36921
aVAdd a new class to your project and paste the code shown below
p36922
aVCompile
p36923
aVDrop the new control from the top of the toolbox, replacing the existing one
p36924
as(dp36925
g9
V17034
p36926
stp36927
a((dp36928
g2
(lp36929
VYes, this code cannot work on a 64-bit operating system
p36930
aVThe casts are wrong, so is the declaration of the MEMORY_BASIC_INFORMATION
p36931
aVThis ought to be closer, untested since I'm not close to an x64 machine right now:
p36932
as(dp36933
g9
V17034
p36934
stp36935
a((dp36936
g2
(lp36937
VPaste this into your popup form class, it prevents it from being activated when shown:
p36938
as(dp36939
g9
V17034
p36940
stp36941
a((dp36942
g2
(lp36943
VA simple example, drop a CheckBox on the form:
p36944
aVCalling Invalidate() is the key to erasing the original drawing, it forces the form to be repainted
p36945
aVThe default OnPaintBackground method implemented by the base class turns everything back to battleship gray
p36946
as(dp36947
g9
V17034
p36948
stp36949
a((dp36950
g2
(lp36951
VI see it, you've got a problem
p36952
aVThe IDL declaration is
p36953
aVWell, that's technically possible, the caller would have to pass a pointer to a buffer of TCHAR that's large enough to store the returned string
p36954
aVThat is massively odd though, strings are almost always handled as BSTR in COM interfaces
p36955
aVTCHAR* would be an accident waiting to happen when the caller doesn't pass a buffer that's large enough
p36956
aVAnd TCHAR will be just plain wrong when the client program is compiled without UNICODE in effect
p36957
aVThis has to be a bug, it should have been BSTR*
p36958
aVOr TCHAR**, a bit of a long shot
p36959
aVAnother thing that's really odd is that they assigned DispIDs to the methods but didn't inherit the interface from IDispatch
p36960
aVThat's just plain pointless
p36961
aVI don't think this was written by a MSFT programmer that knew what he was doing
p36962
aVThe type library importer would indeed have no choice but to pick ushort as the return type, there is no way for it to guess that it is actually an array of characters
p36963
aVThere's is no MIDL attribute on the argument that says it is an array, another thing that's really odd and hinting that the argument really is a BSTR*
p36964
aVPatching the import library is technically possible, you'd have to decompile it, edit the
p36965
aVil and put it back together with ilasm
p36966
aVexe
p36967
aVOf course, you cannot really do this to the standard PIA, you'd have to give up on that
p36968
aVNo happy answers here, this is just plain wrong
p36969
aVPerhaps you can ping connect
p36970
aVmicrosoft
p36971
aVcom to see what they think about it
p36972
aVAlthough they are liable to close it as "external", in which case Microsoft Support is your only real recourse
p36973
as(dp36974
g9
V17034
p36975
stp36976
a((dp36977
g2
(lp36978
VA value of -1 means "download has completed", as documented in the MSDN Library article for the property
p36979
aVThus:
p36980
aVOr you might want to use -1 to hide the progress bar
p36981
as(dp36982
g9
V17034
p36983
stp36984
a((dp36985
g2
(lp36986
VThe proper way to do this is by telling Windows that your thread needs to have the display active
p36987
aVCommonly used by video players
p36988
aVP/Invoke the SetThreadExecutionState() API function, pass ES_DISPLAY_REQUIRED
p36989
aVAnd ES_SYSTEM_REQUIRED to keep the machine from shutting down automatically
p36990
aVVisit pinvoke
p36991
aVnet for the required declarations
p36992
as(dp36993
g9
V17034
p36994
stp36995
a((dp36996
g2
(lp36997
VYou can't, the colors used to draw disabled controls are system colors
p36998
aVA disabled ComboBox is a Label
p36999
aVSo put a Label underneath the ComboBox and instead of disabling it, hide it
p37000
as(dp37001
g9
V17034
p37002
stp37003
a((dp37004
g2
(lp37005
VYou probably have the wrong mental image of a pipe
p37006
aVIt has two ends, each represented by a different handle
p37007
aVYes, CloseHandle has to be called twice to make the pipe instance disappear
p37008
aVBut since they are different handles, that can never cause any problem
p37009
aVAlso note that handle instances are process specific
p37010
aVEven if they have the same value in both processes, they do not reference the same pipe endpoint
p37011
as(dp37012
g9
V17034
p37013
stp37014
a((dp37015
g2
(lp37016
VYeah, that's not going to work like that
p37017
aVAny attempt you'd make in your code to cast to the dynamically loaded type will make your program have a non-dynamic dependency on the assembly
p37018
aVYou should use an interface type
p37019
aVDeclare that type, with all the properties and methods you'd want to have available in your main program, in a separate assembly
p37020
aVBoth your main program and your plug-in will have a dependency on it
p37021
aVThe dynamic type should inherit it to provide the implementation
p37022
aVYou can now cast the return value of CreateInstance to that interface type
p37023
as(dp37024
g9
V17034
p37025
stp37026
a((dp37027
g2
(lp37028
VSince your assembly is mixed-mode, it potentially can call managed code from the unmanaged machine code in the assembly
p37029
aVWith the new in-process side-by-side CLR version support in
p37030
aVNET 4
p37031
aV0, the runtime doesn't know which CLR version needs to be provided when that happens
p37032
aVYou have to tell it that with an app
p37033
aVexe
p37034
aVconfig file that should look like this:
p37035
as(dp37036
g9
V17034
p37037
stp37038
a((dp37039
g2
(lp37040
VWhether a file exists is normally a pre-condition, you'd use Contract
p37041
aVRequires()
p37042
aVEnabling contract verification is optional and not normally turned on in the Release build
p37043
aVWhich makes your test disappear
p37044
aVFrankly, you shouldn't write code like this
p37045
aVAny attempt to use the file will generate an exception, it will be more informative than your version
p37046
aVIt includes the name of the file that could not be found
p37047
aVMore to the point, File
p37048
aVExists() is unreliable on a multi-tasking operating system
p37049
aVThe thread could be pre-empted right after the Exists() call and another thread in another process could delete the file
p37050
aVAnd you'll have a heisenbug on your hands: you'll get a FileNotFound exception, even though you tested that it existed
p37051
aVMy call: just delete the statement
p37052
aVIt causes more problems than it solves
p37053
as(dp37054
g9
V17034
p37055
stp37056
a((dp37057
g2
(lp37058
VI'll assume you meant Arial
p37059
aVThat font is not available in a default Windows install, you got it by installing Microsoft Office
p37060
aVIf you want to use it, you'll have purchase a license from the type foundry (Agfa Monotype, probably) and deploy it with your installer
p37061
aVIf my memory still serves me, it was 95 bucks for 15 installs
p37062
aVDo note that using a font like this is rarely necessary in practice
p37063
aVThe common Windows fonts will have the glyphs that a local user needs to read text in her local language
p37064
aVYou would only need a full font implementation if, say, a Russian user would want to use the Chinese localization for some reason
p37065
aVBe sure to test your app by installing it on the local language versions of Windows that you target
p37066
aVYou can get those versions through an MSDN subscription
p37067
as(dp37068
g9
V17034
p37069
stp37070
a((dp37071
g2
(lp37072
VAfter rubbing my crystal ball for a while, it concluded that you are using the
p37073
aVNET Tlbimp
p37074
aVexe utility to convert the type library to a
p37075
aVNET interop class
p37076
aVIt has a bug, it gets the identifier casing wrong if there's a symbol in the type library with the same name but different case
p37077
aVLike a method declaration earlier in the type library that takes an argument named "type"
p37078
aVAny identifier named "Type" in the rest of the type library will get converted to "type"
p37079
aVAn improved version of the utility is available here
p37080
as(dp37081
g9
V17034
p37082
stp37083
a((dp37084
g2
(lp37085
VIt is a bit hard to see what would be wrong with round-robin
p37086
aVAssumption: what you really want to do is re-use the same hardware device as soon as it is available
p37087
aVSo make that work, let each consumer thread negotiate what device to use
p37088
aVShould be simple with a  protected by a lock to indicate which device is available
p37089
as(dp37090
g9
V17034
p37091
stp37092
a((dp37093
g2
(lp37094
VWell, it ought to be rare since it is so troublesome
p37095
aVBut yes, plug-ins tend to be loaded by LoadFrom()
p37096
aVNever by LoadFile(), that's asking for real trouble
p37097
aVThe trouble is that you cannot really predict what's going to happen with the assemblies that the plug-in depends on
p37098
aVGetting those resolved properly is a crapshoot
p37099
aVThe solution you should favor is a
p37100
aVconfig file so that you can use Load() and probing paths are predictable
p37101
as(dp37102
g9
V17034
p37103
stp37104
a((dp37105
g2
(lp37106
VYou would use My
p37107
aVComputer
p37108
aVNetwork
p37109
aVUploadFile() in a VB
p37110
aVNET app
p37111
aVThe How-To article is here
p37112
as(dp37113
g9
V17034
p37114
stp37115
a((dp37116
g2
(lp37117
VI cannot imagine you getting a warning from these declarations
p37118
aVBut yes, EnumChildWindows is wrong and impossible to use in a VB
p37119
aVNET program
p37120
aVFix:
p37121
aVThe cch argument of GetWindowText is wrong, it is Integer
p37122
aVThe rest are good
p37123
aVPinvoke
p37124
aVnet is a reasonable decent resource for these declarations
p37125
aVOr you could use the P/Invoke Interop Assistant tool
p37126
aVNeither of them are perfect, only SO is
p37127
as(dp37128
g9
V17034
p37129
stp37130
a((dp37131
g2
(lp37132
VNo repro, they don't come from the macro
p37133
aVConsider some kind of Visual Studio add-on as the source of the problem
p37134
as(dp37135
g9
V17034
p37136
stp37137
a((dp37138
g2
(lp37139
VSure, just use the panel's DrawToBitmap() method
p37140
aVIt isn't 100% reliable, there might be controls on the panel that don't support it
p37141
aVLike RichTextBox, WebBrowser or some kind of 3rd party ActiveX control
p37142
as(dp37143
g9
V17034
p37144
stp37145
a((dp37146
g2
(lp37147
VA standard Windows Forms trick is to delay running code until all event side-effects have been completed
p37148
aVYou delay running code with the Control
p37149
aVBeginInvoke() method
p37150
aVThis will fix your problem:
p37151
as(dp37152
g9
V17034
p37153
stp37154
a((dp37155
g2
(lp37156
VYou are generating 16-bit code, you have to break into a museum to find better tooling
p37157
aVTry Borland's, maybe the debugger included with Turbo C
p37158
as(dp37159
g9
V17034
p37160
stp37161
a((dp37162
g2
(lp37163
VStandard operation for programs that want to avoid losing everything:
p37164
aVRename original file
p37165
aVCreate new file with original name
p37166
aVWrite and close file
p37167
aVNo problems: delete file from step 1
p37168
aVIf something goes wrong, the renamed file is restored
p37169
aVYour other editor would corrupt the original if something goes wrong while writing
p37170
as(dp37171
g9
V17034
p37172
stp37173
a((dp37174
g2
(lp37175
VCOM has no rules regarding interface identity, only of object identity
p37176
aVThe first rule of QI says that a QI on IID_Unknown on two interface pointers must return the same pointer if they are implemented by the same object
p37177
aVYour QI implementation does this correctly
p37178
aVWithout a guarantee for interface identity, a COM method cannot assume that it gets the same IUnknown pointer passed that it will retrieve when it calls QI on that pointer
p37179
aVSo if object identity needs to be proven then a separate QI is required
p37180
as(dp37181
g9
V17034
p37182
stp37183
a((dp37184
g2
(lp37185
VYes, it can be edited
p37186
aVTools + Customize, Command tab
p37187
aVSelect Context Menu and pick "Project and Solution Context Menus | Project"
p37188
as(dp37189
g9
V17034
p37190
stp37191
a((dp37192
g2
(lp37193
VUse Task Manager's Processes tab, not the Applications tab
p37194
aVThe latter one only lists processes that have a window
p37195
aVAlso consider that the process simply exited quickly after starting it
p37196
as(dp37197
g9
V17034
p37198
stp37199
a((dp37200
g2
(lp37201
VYou are showing exceptions that the debugger suffers when it tries to display the list instance
p37202
aVIt isn't going help either you or us to diagnose the problem, you'll need to take a look at the exception that the code generates
p37203
aVIf that doesn't help, post what you see in the exception's message and stack trace properties
p37204
aVThe InnerException is most important, in case it isn't null
p37205
aVThis kind of mishap is usually caused by heap corruption btw
p37206
as(dp37207
g9
V17034
p37208
stp37209
a((dp37210
g2
(lp37211
VNo such option in Visual Studio
p37212
aVJust about the only thing you could do is calling a Thread object's Suspend() method right after creating it
p37213
aVThis cannot work for threadpool threads
p37214
aVThe compiler is going to nag you when you do this, Suspend() is an obsolete method
p37215
aVIt was abused back in the
p37216
aVNET 1
p37217
aVx days to synchronize threads, something it cannot do reliably
p37218
aVWhich is of course exactly what you are doing
p37219
aVThe particular problem you create by doing this is that you are just no longer debugging the app in a way that's at all representative for how it works in production
p37220
aVYou'll hide threading race bugs
p37221
aVDebugging threading bugs can be very difficult
p37222
aVJust about the only reasonable approach is using tracing
p37223
aVWhich in itself changes code execution timing, making bugs disappear
p37224
aVAfter debugging this for a week or so, step back and ask yourself whether the program is using too many threads and has become unmaintainable
p37225
as(dp37226
g9
V17034
p37227
stp37228
a((dp37229
g2
(lp37230
VNo idea what "feeding" might mean
p37231
aVUse Marshal::PtrToStringUni() to convert the string
p37232
aVIf the window that receives this message was created with CreateWindowExA() then you need Marshal::PtrToStringAnsi()
p37233
as(dp37234
g9
V17034
p37235
stp37236
a((dp37237
g2
(lp37238
VThis method cannot be called safely from a native C++ application either
p37239
aVIt returns a pointer to an array on the stack frame
p37240
aVAny call to another function will overwrite that stack frame and corrupt the array
p37241
aVThis probably works by accident in a C++ program right now because there is no function call after obtaining the return value of this function
p37242
aVThis kind of luck is no longer available when the P/Invoke marshaller sits in between
p37243
aVYou will have to redesign the C++ function
p37244
aVYou should give it arguments that allows the caller to pass its own buffer to be filled with the result
p37245
aVFor example:
p37246
aVCall this in C# code by passing a StringBuilder for the output argument, properly initialized with a sufficient Capacity to receive the string
p37247
aVThe outputSize argument ensures that the C++ function can avoid writing past the end of the buffer and corrupt the garbage collected heap
p37248
aVDon't ignore it
p37249
as(dp37250
g9
V17034
p37251
stp37252
a((dp37253
g2
(lp37254
VThis is an unusual thing to do, the
p37255
aVNET ListView wrapper wouldn't handle it
p37256
aVYou could try recreating the native Windows control to reset it
p37257
aVNot sure it this will have side-effects, you'd have to try
p37258
aVAdd a new class to your project and paste the code shown below
p37259
aVCompile
p37260
aVDrop the new control from the top of the toolbox, replacing your original
p37261
as(dp37262
g9
V17034
p37263
stp37264
a((dp37265
g2
(lp37266
VI'll guess that you are running your code on Windows XP or Vista/Win7 with Aero turned off
p37267
aVClosing a form does not make the pixels on the screen disappear instantly
p37268
aVThe Windows window manager sees that the window for the form got destroyed and that this revealed parts of other windows underneath it
p37269
aVIt will deliver a WM_PAINT message to let them know that they need to repaint the parts of the window that got revealed
p37270
aVThis will not work properly if one or more of those windows isn't actively pumping a message loop
p37271
aVThey can't see the WM_PAINT message
p37272
aVThey won't repaint themselves, the pixels of the closed form will remain on the screen
p37273
aVFind out why these windows are not responding
p37274
aVHopefully it is your window and the debugger can show you what the UI thread is doing
p37275
aVMake sure it isn't blocking on something or stuck in a loop
p37276
aVAfter seeing the edit: there's indeed blocking going on, of a different kind
p37277
aVThe MessageBox
p37278
aVShow() call is modal, it prevents the VisibleChanged event from completing
p37279
aVThat delays the closing of the form
p37280
aVUse System
p37281
aVDiagnostics
p37282
aVDebug
p37283
aVWriteLine() or Console
p37284
aVWriteLine() to get diagnostics in a Window Forms app
p37285
aVYou'll see it in the Output window
p37286
aVOr simply use a debugger breakpoint
p37287
as(dp37288
g9
V17034
p37289
stp37290
a((dp37291
g2
(lp37292
Vlines = File
p37293
aVReadAllLines(args[1] + "\u005cChat
p37294
aVlog")
p37295
aVLength;
p37296
aVThere's your problem
p37297
aVThat method opens the file, reads all the lines and closes it again
p37298
aVIt uses "normal" file share settings when opening the file, FileShare
p37299
aVRead
p37300
aVThat denies write access to any other process that also has the file opened
p37301
aVThat cannot work here, you've already have the file opened with write access
p37302
aVThe 2nd process cannot deny it
p37303
aVThe IOException is the result
p37304
aVYou cannot use File
p37305
aVReadAllLines() as-is here, you need to open a FileStream with FileShare
p37306
aVReadWrite, pass it to a StreamReader and read all lines
p37307
aVBeware the very troublesome race potential you've got here, there's no guarantee that the last line you'll read is a complete line
p37308
aVGetting only a \u005cr and not the \u005cn at the end of the line is a particularly tricky issue
p37309
aVThis will strike randomly and infrequently, the hardest bugs to troubleshoot
p37310
aVMaybe your Flush() call fixes it, I've never been brave enough to put this to the test
p37311
as(dp37312
g9
V17034
p37313
stp37314
a((dp37315
g2
(lp37316
VYour declaration is wrong
p37317
aVA VB6 Integer is 16-bits for historical reasons, a C int is 32-bits
p37318
aVUse Long instead
p37319
as(dp37320
g9
V17034
p37321
stp37322
a((dp37323
g2
(lp37324
VUsing the [CoClass] attribute is quite unusual, you'd usually rely on Tlbimp
p37325
aVexe or adding a COM reference to get the type library converted into an interop class automatically
p37326
aVAvoids mistakes and versioning problems
p37327
aVBut if it works, what the hey
p37328
aVYes, you'll need to get that COM server deployed and installed on the target machine
p37329
aVThat could be as simple as just copying the
p37330
aVocx file and registering it with Regsvr32
p37331
aVexe
p37332
aVBut it is rarely that simple, the
p37333
aVocx file might have a dependency on other DLLs that would have to be copied and/or registered as well
p37334
aVIt is best to use the vendor's installer
p37335
aVFind out what is needed with a virgin test machine or a VM
p37336
as(dp37337
g9
V17034
p37338
stp37339
a((dp37340
g2
(lp37341
VYou got only one shot at this, which is all you need
p37342
aVThe setup
p37343
aVexe program for your app will run with admin privileges
p37344
aVWrite a custom action to get that file created
p37345
aVI'll avoid talking about the merits of security through obscurity
p37346
aVOr the enormous trouble you'll get into when an important client suddenly can't use mission critical software anymore because of a hardware upgrade
p37347
as(dp37348
g9
V17034
p37349
stp37350
a((dp37351
g2
(lp37352
VYou cannot convince the IDE to make it absolute
p37353
aVPossible solutions:
p37354
aVUse a post-build event to xcopy the build output
p37355
aVIt won't make the path relative if the output directory is on another drive
p37356
aVYou could use the SUBST command to map a drive letter like z: to a folder on c: and fool the IDE that way
p37357
aVRun msbuild
p37358
aVexe directly on the build machine
p37359
aVUse the /p command line option to force the OutDir property to another value
p37360
aVSolution 3 is probably best since you can make it specific to the build machine without tinkering with the project files and make the devs' lives difficult
p37361
aVThe command should look similar to this:
p37362
aVBeware that the output directory name must end with a trailing backslash
p37363
as(dp37364
g9
V17034
p37365
stp37366
a((dp37367
g2
(lp37368
VYes, this is a bit of a mess you'll get into when you let the VS2010 project converter import a project from a previous version
p37369
aVWho doesn't
p37370
aVThe old IDEs used Debug|Any CPU and Release|Any CPU as the default configuration names
p37371
aVVS2010 really prefers setting the Platform Target to x86 because the IDE works so much better when you do
p37372
aVAnd uses Debug|x86 and Release|x86 as the default configuration names
p37373
aVWhich produces the mix when you import an old project
p37374
aVAnd an extra set of configurations (mixed platforms) you didn't ask for to deal with the mess
p37375
aVYuck
p37376
aVYou cannot remove them either, the Remove button is disabled in the Configuration Manager
p37377
aVThese are just names btw that are not actually representative for the Platform Target setting
p37378
aVYou can change the setting, it doesn't magically change the configuration name
p37379
aVYuck
p37380
aVYou cannot fix this in the IDE
p37381
aVYou'd have to edit the
p37382
aVsln and the
p37383
aVvcproj files to get rid of the extra configurations and edit the names of the ones you want to keep
p37384
aVOr just keep "Mixed Platforms" as your default configuration and ignore the rest
p37385
aVJust set the Platform Target to what you need, it doesn't have to match the configuration name
p37386
as(dp37387
g9
V17034
p37388
stp37389
a((dp37390
g2
(lp37391
VThe size of the system base font matters as well
p37392
aVWhich is indeed something you can change on XP
p37393
aVThis will invoke the form's auto-scaling logic, designed to ensure that the controls grow larger to fit the larger font size
p37394
aVThis is by design, controlled by the form's AutoScaleMode property
p37395
aVDon't change it, rescaling is important
p37396
aVJust make sure the form layout still looks good, use properties like Anchor and Dock, controls like TableLayoutPanel, FlowLayoutPanel
p37397
aVOr the Resize event for tricky ones
p37398
aVPaste this into your form to test this logic without having to change system settings:
p37399
as(dp37400
g9
V17034
p37401
stp37402
a((dp37403
g2
(lp37404
VUse SafeArrayAccessData to access the array elements
p37405
aVThere is a sample snippet in the MSDN Library article for it that also works with strings
p37406
aVThe elements should be BSTR, just wcscpy() into a wchar_t[]
p37407
as(dp37408
g9
V17034
p37409
stp37410
a((dp37411
g2
(lp37412
VWell, it is not because you used the unsafe keyword
p37413
aVIt is because you wrote code that compiled because you used unsafe
p37414
aVYes, peverify will balk at such code
p37415
aVit is the very nature of unsafe
p37416
aVYou can't have your cake and eat it too here
p37417
as(dp37418
g9
V17034
p37419
stp37420
a((dp37421
g2
(lp37422
VYes, the ChDir command can be important
p37423
aVIt helps Windows find any DLLs that whatever
p37424
aVxll depends on
p37425
aVThe reason it doesn't solve your problem is that FileSystem
p37426
aVChDir() changes the working directory for your test program, not for Excel
p37427
aVNot a wholeheckofalot you can do
p37428
aVDeploying the xll do a directory that's on the system's PATH will solve it
p37429
aVA pragmatic solution is to just run that macro
p37430
as(dp37431
g9
V17034
p37432
stp37433
a((dp37434
g2
(lp37435
VVisual Assist is rumored to have IntelliSense support
p37436
aVThey don't advertise it, which is mighty strange
p37437
aVBetter try to eval version to check
p37438
aVOther than that, I don't doubt that most devs replace the missing support in VS2010 with VS2008
p37439
as(dp37440
g9
V17034
p37441
stp37442
a((dp37443
g2
(lp37444
VpowerPoint
p37445
aVPresentations
p37446
aVOpen(
p37447
aVNote the use of the Presentations object
p37448
aVCOM uses manual memory management based on reference counting, every COM interface has an AddRef() and a Release() method
p37449
aVThe AddRef call is automatic when you obtain an object
p37450
aVWhen you're done with it you have to call the Release() method
p37451
aVUsing the Presentations object here adds a reference to the Presentations object
p37452
aVWhich in turn adds a reference to the internal application object
p37453
aVThat's very incompatible with memory management in the
p37454
aVNET framework
p37455
aVIt is automatic, the garbage collector takes care of it
p37456
aVWhich it does for COM objects too, the interop wrapper has a finalizer, it decrements the reference count when it sees that no
p37457
aVNET references are left on the COM object
p37458
aVPerhaps you see where this is going: PowerPoint cannot exit until all object references are released
p37459
aVWhich cannot happen until the garbage collector runs and the finalizer thread completed
p37460
aVYour call to the Quit() method does not make the garbage collector run
p37461
aVOnly GC
p37462
aVCollect() + GC
p37463
aVWaitForPendingFinalizers can do that
p37464
aVYou can also take the manual approach
p37465
aVIt requires Marshal
p37466
aVReleaseComObject()
p37467
aVDoing this is difficult to get right, note that you don't have a reference to the Presentations object stored anywhere in your code
p37468
aVYou'd have to completely rewrite your code to keep track of these references so you can call ReleaseComObject() on them
p37469
aVI cannot recommend this
p37470
aVIf you really really want PowerPoint to quit then the better way is to make sure all your references are null and call GC
p37471
aVCollect() and GC
p37472
aVWFPF
p37473
aVI cannot recommend this either
p37474
aVIt will quit, eventually
p37475
aVDon't worry about it
p37476
as(dp37477
g9
V17034
p37478
stp37479
a((dp37480
g2
(lp37481
VNope, there's is only one value for SelectionStart and SelectionLength
p37482
aVYes, you can use the SelectionBackColor and SelectionColor properties to colorize the text that matches
p37483
aVYou'll find sample code in my answer in this thread
p37484
as(dp37485
g9
V17034
p37486
stp37487
a((dp37488
g2
(lp37489
VWhat makes you think it needs be strong named
p37490
aVThis is not a requirement for reg-free COM, nor does the example given in the blog post use a strong-named assembly
p37491
as(dp37492
g9
V17034
p37493
stp37494
a((dp37495
g2
(lp37496
VYou could use an ApplicationContext instead
p37497
aVThat gets you the necessary message loop that will keep a form alive, once you decide to create one
p37498
aVMake your Program class look similar to this:
p37499
aVBeware that the app will not close automatically when you close the last window
p37500
aVCalling ExitThread explicitly is required
p37501
as(dp37502
g9
V17034
p37503
stp37504
a((dp37505
g2
(lp37506
VExact equivalent with standard WF controls: how to keep the text of one text box in sync with another:
p37507
aVNecessary ingredients: an event on your user control that is fired when something interesting happens
p37508
aVAnd public properties
p37509
as(dp37510
g9
V17034
p37511
stp37512
a((dp37513
g2
(lp37514
VYou've got a chicken-and-egg problem
p37515
aVTo make some kind of guess, you need to know the size of the image
p37516
aVYou don't know the size until you loaded it
p37517
aVIt isn't really helpful anyway
p37518
aVWhether you get OOM really depends on how fragmented the virtual memory address space has gotten
p37519
aVAnd that is not easy to find out in Windows
p37520
aVThe HeapWalk() API function is required and that's an unhealthy function to use
p37521
aVCheck out the small print in the MSDN library article for it
p37522
aVEspecially bad in a managed program, don't use it
p37523
aVNote that this OOM exception is not the same kind of OOM you'd get when you used up too much managed memory
p37524
aVIt is actually a GDI+ exception and you can easily recover from it
p37525
aVJust catch the exception and display a "Sorry, couldn't do it" message
p37526
aVIf you do know the size of front somehow then you can pretty safely assume up front that width * height * 4 > 550 MB is not going to work in a 32-bit program
p37527
aVThis limit goes down quickly after running for a while
p37528
as(dp37529
g9
V17034
p37530
stp37531
a((dp37532
g2
(lp37533
VAttach the debugger after you got the program started
p37534
aVThis ensures any side-effects, like the startup directory, the hosting process and JIT optimization cannot be affected by the debugger
p37535
aVStart your program
p37536
aVTools + Attach to Process
p37537
as(dp37538
g9
V17034
p37539
stp37540
a((dp37541
g2
(lp37542
VIt isn't often that I can post the exact same answer within 2 minutes
p37543
aVCopy-and-paste:
p37544
aVI'm going to be a bit blunt about this
p37545
aVThe
p37546
aVNET framework design is overall rather excellent
p37547
aVEasy to learn, few surprises, no fat
p37548
aVBut not everything is great
p37549
aVSystem
p37550
aVConfiguration has a very high suck factor
p37551
aVBetween an absurdly complicated object model and an implementation that was paralyzed by security concerns, it inevitably becomes a PITA when you try to extend it beyond the point-and-click settings designer
p37552
aVJust don't go there
p37553
aVUsing XML serialization to load/save your own configuration class(es) is a wholeheckofalot easier than battling that borked design
p37554
as(dp37555
g9
V17034
p37556
stp37557
a((dp37558
g2
(lp37559
VI'm going to be a bit blunt about this
p37560
aVThe
p37561
aVNET framework design is overall rather excellent
p37562
aVEasy to learn, few surprises, no fat
p37563
aVBut not everything is great
p37564
aVSystem
p37565
aVConfiguration has a very high suck factor
p37566
aVBetween an absurdly complicated object model and an implementation that was paralyzed by security concerns, it inevitably becomes a PITA when you try to extend it beyond the point-and-click settings designer
p37567
aVJust don't go there
p37568
aVUsing XML serialization to load/save your own configuration class(es) is a wholeheckofalot easier than battling that borked design
p37569
as(dp37570
g9
V17034
p37571
stp37572
a((dp37573
g2
(lp37574
VYes, it is a wee bit sad that it works that way
p37575
aVIt made a lot of sense at the time, now 10 years ago already
p37576
aVWindows Forms was targeted to be a replacement for VB6, the dominant point-and-click UI designer at the time
p37577
aVAnd Form_Load was important in VB6, that's where you customized the form view
p37578
aVThat wasn't really appropriate from the get-go, the Form class has a true-blooded constructor
p37579
aVAnd you can set control properties in the constructor before the actual native Window control gets created
p37580
aVThere's a ton of code in WF to make that work
p37581
aVCode that the designer relies on, it sets these properties before the Load event fires
p37582
aVIt is very efficient to do so, many controls get a lot slower when they need to be updated after their window is created
p37583
aVLike ListView and TreeView
p37584
aVThere are few reasons to not use the constructor yourself, like the designer does, especially since the C# IDE doesn't try to hide the constructor
p37585
aVExcept one: you need the Load event when you write the kind of code that requires knowing the actual form size
p37586
aVThat size isn't known until the window actually gets created, the Load event is the earliest after that
p37587
aVThat ought to be rare
p37588
aVAnd of course, if you do want to use Load then you override OnLoad instead of using the Load event
p37589
aVThat would be another one
p37590
as(dp37591
g9
V17034
p37592
stp37593
a((dp37594
g2
(lp37595
VYou need to use the DllImport's CallingConvention property
p37596
aVCdecl is required here since you didn't declare the C function as __stdcall
p37597
aVYou don't need [MarshalAs], the values you use are already the default
p37598
aVThus:
p37599
as(dp37600
g9
V17034
p37601
stp37602
a((dp37603
g2
(lp37604
VThe only other workaround is resetting the IDE state that Visual Studio maintains for a solution
p37605
aVThat does get corrupted sometimes and can have all kinds of weirdo effects
p37606
aVDelete the hidden
p37607
aVsuo file in the solution directory
p37608
as(dp37609
g9
V17034
p37610
stp37611
a((dp37612
g2
(lp37613
VYour app is simply consuming the quota of handles that Windows imposes
p37614
aVBy default it is 10,000 handles, trying to create another window will fail with "Error creating window handle"
p37615
aVMaybe those limits are lower for a VM or TS install, not sure
p37616
aVThe upper limit is rather enormous and you should never have any trouble staying far away from it
p37617
aVIn Task Manager, use View + Select Columns and tick USER objects, GDI object and Handles
p37618
aVAny of these columns growing without bound is a sure sign of a bug in your code, like not disposing forms or controls
p37619
aVConsuming more memory is a side-effect of this leak
p37620
as(dp37621
g9
V17034
p37622
stp37623
a((dp37624
g2
(lp37625
VI don't think it works that way
p37626
aVYou get a reference to the build engine through Task
p37627
aVBuildEngine property
p37628
aVThen simply call its LogMessageEvent to generate a message
p37629
aVThe BuildMessageEventArgs
p37630
aVImportance determines whether or not the message will actually be visible, based on the verbosity setting
p37631
aVThis is consistent with other logging APIs
p37632
as(dp37633
g9
V17034
p37634
stp37635
a((dp37636
g2
(lp37637
VGetPrivateProfileInt() is one of those innocent looking Windows API functions that has a ton of code behind it
p37638
aVThere's a mass of appcompat code, designed to allow Win3 programs to run on modern versions of Windows
p37639
aVOne of the side-effects is that it is incredibly slow, it took about 50 msec the last time I profiled it
p37640
aVLooks like you found a flaw in it
p37641
aVFor all I know, it might actually be designed appcompat behavior
p37642
aVEmulating the way this API worked 18 years ago
p37643
aVI have no clue of course if that's accurate
p37644
aVThe very best thing you can do is stop using it
p37645
aVA possible workaround is to open the file first so that your program blocks until the service is up and running
p37646
as(dp37647
g9
V17034
p37648
stp37649
a((dp37650
g2
(lp37651
VSeeing those "u" characters after the empty bracketed value is creepy
p37652
aVBut looking at the CRT source code, that could be explained by a bug in the dumping code, it doesn't seem to zero-terminate the string when the memory block is 0 bytes (valbuff variable in dbgheap
p37653
aVc)
p37654
aVAllocating zero bytes is otherwise a supported scenario
p37655
aVAnd your code not de-allocating it isn't quite mysterious either perhaps
p37656
aVIf you can get the number before the "normal block" output stable then you can assign _crtBreakAlloc() in your initialization code to force a breakpoint
p37657
aVOr you could set a conditional breakpoint on the CRT debug allocator
p37658
aVTrace into a malloc or new call to find it
p37659
as(dp37660
g9
V17034
p37661
stp37662
a((dp37663
g2
(lp37664
VYour P/Invoke declarations are all wrong, using "int" where IntPtr is required
p37665
aVThis code is indeed going to bomb on a 64-bit version of Windows
p37666
aVGet them fixed by getting the proper declarations from pinvoke
p37667
aVnet
p37668
as(dp37669
g9
V17034
p37670
stp37671
a((dp37672
g2
(lp37673
VIt is better, CloseHandle() doesn't flush the file system cache write buffers
p37674
aVBeware of the cost, it can take a long time to get the data to the disk
p37675
aVThe FILE_FLAG_NO_BUFFERING option for CreateFile allows you to avoid flushing
p37676
aVBut it is very expensive and difficult to get right due to the limitations on the written data
p37677
as(dp37678
g9
V17034
p37679
stp37680
a((dp37681
g2
(lp37682
VYes, it is a system setting
p37683
aVUse SystemInformation
p37684
aVHorizontalScrollBarHeight and SystemInformation
p37685
aVVerticalScrollBarWidth
p37686
as(dp37687
g9
V17034
p37688
stp37689
a((dp37690
g2
(lp37691
VDelete the hidden
p37692
aVsuo file in your solution directory
p37693
as(dp37694
g9
V17034
p37695
stp37696
a((dp37697
g2
(lp37698
VYes, that won't work
p37699
aVThe probing path for devenv
p37700
aVexe (Visual Studio) is not going to include the current project build directory
p37701
aVThe common7\u005cide\u005cdevenv
p37702
aVexe
p37703
aVconfig on my machine adds the PublicAssemblies and PrivateAssemblies subdirectories in common7\u005cide to the probing path
p37704
aVYou could copy your assemblies there
p37705
as(dp37706
g9
V17034
p37707
stp37708
a((dp37709
g2
(lp37710
VThis is common enough in the
p37711
aVNET framework as well
p37712
aVExamples are System
p37713
aVWindows
p37714
aVDataFormats and System
p37715
aVNet
p37716
aVWebRequestMethods
p37717
aVHttp
p37718
aVYou'd want the readonly variety:
p37719
as(dp37720
g9
V17034
p37721
stp37722
a((dp37723
g2
(lp37724
VI don't get it, why a complete rebuild
p37725
aVYou are just changing the implementation, the interface and coclass GUIDs as well as the interface definition should not change
p37726
aVThat's all that COM clients know about a COM server
p37727
aVIf you do change an interface definition then you have to assign new GUIDs
p37728
aVVery hard rule in COM, skipping it buys enormous DLL Hell
p37729
aVYes, that requires a complete rebuild
p37730
as(dp37731
g9
V17034
p37732
stp37733
a((dp37734
g2
(lp37735
VSetWaitableTimer() supports two ways to set the due time
p37736
aVA positive value sets absolute time, it will be affected by the clock
p37737
aVA negative value sets relative time, it will not be affected by the clock
p37738
aVYou want the latter
p37739
aVAny
p37740
aVNET timer will not be affected by the clock
p37741
aVNot even the time zone or DateTime
p37742
aVNow changes
p37743
aVCheck out CultureInfo
p37744
aVClearCachedData()
p37745
aVUsing System
p37746
aVThreading
p37747
aVTimer ought to be a good managed replacement
p37748
as(dp37749
g9
V17034
p37750
stp37751
a((dp37752
g2
(lp37753
VThese are fonts that are appropriate for East Asian languages when the text is displayed vertically
p37754
aVThe preferred traditional reading direction for Japanese, Chinese and Korean
p37755
aVThe glyphs in the font are rotated so that after you create a rotated font, the character displays the right way
p37756
aVThis wikipedia article is excellent, also mentions the @
p37757
as(dp37758
g9
V17034
p37759
stp37760
a((dp37761
g2
(lp37762
VThis is exactly how COM works
p37763
aVAvoiding re-inventing this wheel if you already target the Win32 API
p37764
aVUsing smart pointers to store COM interface pointers is very common in Windows programming, their destructor calls the Release() method
p37765
aVTake a peek at the MSDN docs for _com_ptr_t and CComPtr for ideas
p37766
as(dp37767
g9
V17034
p37768
stp37769
a((dp37770
g2
(lp37771
VNah, that cannot be accurate
p37772
aVNeither ShellExecuteEx nor CreateProcess can block
p37773
aVIt is surely the next statement in your code, the one you didn't post
p37774
aVI'd guess at Process
p37775
aVWaitForExit()
p37776
aVNote that it has an overload that accepts a timeout
p37777
aVNot that it will work reliably, Word is a single-instance process
p37778
aVUsing Microsoft
p37779
aVOffice
p37780
aVInterop
p37781
aVWord is the better mousetrap
p37782
aVThe Application
p37783
aVDocument
p37784
aVOpen() method accepts an OpenAndRepair argument
p37785
as(dp37786
g9
V17034
p37787
stp37788
a((dp37789
g2
(lp37790
VYes they do
p37791
aVStart a command prompt and use DIR /R
p37792
aVYou'll see the alternate data stream in the file
p37793
aVThe one that says: "don't trust this file, it came from an untrusted source"
p37794
aVYou can delete them with the filename:streamname syntax
p37795
aVCheck if that's okay with your customer first
p37796
aVI don't know many that are thrilled about EXEs getting downloaded and bypassing normal security rulez
p37797
as(dp37798
g9
V17034
p37799
stp37800
a((dp37801
g2
(lp37802
VYou need an instance of a Stream derived class to provide the Stream implementation
p37803
aVMemoryStream is the ticket:
p37804
aVwhere "bin" is your Binary instance
p37805
as(dp37806
g9
V17034
p37807
stp37808
a((dp37809
g2
(lp37810
VYes, there is one
p37811
aVThe only one I'm aware of that prevents a control from showing up in the toolbox if the class is in the same project
p37812
aVTools + Options, Windows Forms Designer, General, AutoToolboxPopulate should be set to True
p37813
aVThe default value
p37814
as(dp37815
g9
V17034
p37816
stp37817
a((dp37818
g2
(lp37819
VProject + Properties, Build tab, scroll down, Advanced
p37820
aVYou can change the Language Version to "C# 3
p37821
aV0" if you prefer to maintain source code compatibility
p37822
aVBut yes, you are using the C# 4
p37823
aV0 compiler in VS2010, regardless of the target
p37824
aVNET version you use
p37825
aVThe output of the compiler, IL, hasn't changed in
p37826
aVNET 4
p37827
ag2512
aVNo, you can't use dynamic, it requires a
p37828
aVNET 4
p37829
aV0 only support assembly (Microsoft
p37830
aVCSharp
p37831
aVdll)
p37832
as(dp37833
g9
V17034
p37834
stp37835
a((dp37836
g2
(lp37837
VRewrite, I've since figured out where it comes from
p37838
aVWindows misbehaves when an exception is raised in a 32-bit process when it runs on a 64-bit version of Windows
p37839
aVIt swallows any exception raised by code that runs in response to a Windows message that's triggered by the 64-bit windows manager
p37840
aVLike WM_SHOWWINDOW, the message that causes the Load event to get raised
p37841
aVThe debugger plays a role because when it is active, normal exception trapping in a Winforms app is turned off, allowing the debugger to stop on an exception
p37842
aVThat doesn't happen in this scenario because Windows swallows the exception first, preventing the debugger from seeing it
p37843
aVI've written about this problem more extensively in this answer, along with possible workarounds
p37844
as(dp37845
g9
V17034
p37846
stp37847
a((dp37848
g2
(lp37849
VAgreed, this has to be a user account privilege issue
p37850
aVEnumeration needs to get started by calling the native OpenSCManager() API function
p37851
aVThis is a very privileged function, the SDK docs note that administrator access is required
p37852
aVYou would have to configure the service and give it an admin login
p37853
aVSounds like you already tried this
p37854
aVWorry about UAC a bit, then ask more questions about it at serverfault
p37855
aVcom, presumed home of the security experts
p37856
as(dp37857
g9
V17034
p37858
stp37859
a((dp37860
g2
(lp37861
VDispatcherUnhandledException is raised only by the UI thread and only if an exception was raised while running an event
p37862
aVThere's a bit of a tradition to handle these kind of exceptions specially, Windows Forms has it too with Application
p37863
aVThreadException (poorly named, nothing to do with threads)
p37864
aVThe reason is that there is a minor chance to handle the exception and keep the program alive since UI event handlers don't always mutate the state of program too dramatically
p37865
aVThis takes large helpings of wishful thinking
p37866
aVWindows Forms takes this to an extreme, it displays a ThreadExceptionDialog that has a Continue button, allowing the user to ignore the exception
p37867
aVWPF does not do that, you'd have to write a dialog like that yourself
p37868
aVWhich is why the event is there
p37869
aVThe default action of DispatcherUnhandledException is to not catch the exception
p37870
aVSo you're okay to ignore it, AppDomain
p37871
aVUnhandledException will fire next
p37872
as(dp37873
g9
V17034
p37874
stp37875
a((dp37876
g2
(lp37877
VYes, Project + Properties, Settings tab was designed to do this
p37878
aVAdd your settings here, change the Scope to Application
p37879
aVThat generates a app
p37880
aVexe
p37881
aVconfig file in your build direcctory, deploy it along with your EXE
p37882
aVUse Properties
p37883
aVSettings
p37884
aVDefault
p37885
aVSettingName in your code to obtain the setting value
p37886
aVYour user will normally need admin privileges to edit the
p37887
aVexe
p37888
aVconfig file on the target machine to change the setting value
p37889
aVThe small print: settings do not work well for DLL assemblies, you have to merge the
p37890
aVconfig files by hand
p37891
aVWhen using the debugger, settings are retrieved from the app
p37892
aVvshost
p37893
aVexe
p37894
aVconfig file
p37895
aVThe
p37896
aVsettings file is a helper file used by the IDE, ignore it
p37897
aVResx files store resources, they get compiled and embedded in a binary form in an assembly
p37898
aVThey are not editable by the user
p37899
as(dp37900
g9
V17034
p37901
stp37902
a((dp37903
g2
(lp37904
VWell, your dialog HWND is a singleton so it isn't the end of the world
p37905
aVBut yes, the standard way this is done is by passing an opaque pointer to the code that gets the job done
p37906
aVCompare with the lParam argument of EnumWindows() for example, the callback gets that pointer back
p37907
aVWhether a control repaints itself immediately is an implementation detail
p37908
aVI only know of progress bar doing this
p37909
aVYou could call UpdateWindow on the dialog window handle to get any pending paint updates flushed to the screen
p37910
aVThe all-around better mouse trap is to perform long running tasks on a worker thread
p37911
aVAvoids Windows displaying the "Not Responding" ghost window, avoids timeouts on broadcast messages and numerous potential deadlock problems
p37912
aVBut tends to be tricky to get right, you cannot update the window directly from the worker thread
p37913
as(dp37914
g9
V17034
p37915
stp37916
a((dp37917
g2
(lp37918
VYou had me going there for a bit, that indeed looks completely bass-ackwards
p37919
aVThere is however something else going on
p37920
aVThe Stack<> class has a debugger visualizer, named System_StackDebugView<>
p37921
aVIt is an internal class, you'd have to look with Reflector to see it
p37922
aVThat visualizer has an Items property, that's what you look at when you expand the node in the debugger
p37923
aVThat Items property uses Stack<>
p37924
aVToArray()
p37925
aVWhich looks like this:
p37926
aVYup, backwards
p37927
as(dp37928
g9
V17034
p37929
stp37930
a((dp37931
g2
(lp37932
VThe size passed to wcsncpy_s() is the buffer size, not the number of characters the buffer can store
p37933
aVIt includes the zero terminator
p37934
aVYou need to add 1
p37935
as(dp37936
g9
V17034
p37937
stp37938
a((dp37939
g2
(lp37940
VSize = New System
p37941
aVDrawing
p37942
aVSize(300, 24)
p37943
aVThere's your problem, you made the panel too small
p37944
aVThe first radio button's Location is at (77, 139), you'll have to set the panel's height to at least 139 + 17 = 156 to see it in full
p37945
aVHere's a trick to get this kind of code right
p37946
aVIn the Solution Explorer window, locate the "Show All Files" icon and click it
p37947
aVThat shows all files in your solution
p37948
aVA node appears next to your form
p37949
aVClick it and double-click the
p37950
aVDesigner
p37951
aVvb file
p37952
aVLocate the InitializeComponent() method
p37953
aVObserve how this code changes as you drop controls on the form and set their properties
p37954
aVCopy and paste code from this
p37955
aVUsing a UserControl can also be useful
p37956
as(dp37957
g9
V17034
p37958
stp37959
a((dp37960
g2
(lp37961
VYeah, it's possible
p37962
aVYou'll need a bunch of P/Invoke declarations to use code like this:
p37963
aVVisit pinvoke
p37964
aVnet or use the P/Invoke Interop Assistant to get the declarations you need to use this code
p37965
as(dp37966
g9
V17034
p37967
stp37968
a((dp37969
g2
(lp37970
VYes, it is odd, have cursed at it myself several times
p37971
aVEqually odd is that the Split() overloads that take a string were not available in
p37972
aVNET 1
p37973
ag22731
aVWell, odder perhaps
p37974
aVMaybe some "not too many overloads
p37975
aVparalysis here
p37976
aVThe StringSplitOptions and Count arguments can generate a combinatorial number of them
p37977
aVFix it with an extension method:
p37978
aVAnd add the ones you need if you also want to cover StringSplitOptions and Count :)
p37979
as(dp37980
g9
V17034
p37981
stp37982
a((dp37983
g2
(lp37984
VI don't understand why you'd be fretting about the RTF getting convoluted
p37985
aVYes it will
p37986
aVBut it isn't your burden to deal with it, a Microsoft programmer did that a while ago, having to write the code to render convoluted RTF
p37987
aVIt works well and is entirely opaque to you
p37988
aVYes, it isn't going to be super-fast
p37989
aVBut what the hey, you're emulating a 80x25 display that used to run at 9600 baud
p37990
aVCompletely replacing the control to try to make it optimal makes little sense and is going to be a major undertaking
p37991
as(dp37992
g9
V17034
p37993
stp37994
a((dp37995
g2
(lp37996
VYou're making it difficult
p37997
aVThe Irony and Common Compiler Infrastructure libraries available at Codeplex
p37998
aVcom are out, they are targeted to compilers implemented in managed code
p37999
aVThe next option is using the unmanaged metadata interfaces, like IMetaDataAssemblyEmit, IMetaDataAssemblyImport, IMetaDataEmit2
p38000
aVThese COM interfaces are however declared in the cor
p38001
aVh SDK header file, suitable only for consumption by a C/C++ program
p38002
aVThere is no type library available for them
p38003
aVShort from painstakingly copying the interface declarations, you'd need some kind of tool to convert these to Delphi declarations
p38004
aVNot sure if that exists
p38005
as(dp38006
g9
V17034
p38007
stp38008
a((dp38009
g2
(lp38010
VThis is normal, a screen-shot like this gives you exactly what you are looking at on your monitor
p38011
aVIncluding the taskbar
p38012
aVYou will need to restrict the area you capture to the bounds of the window you want to capture
p38013
aVUse GetWindowRect() and adjust the size of the bitmap and the arguments you pass to BitBlt() accordingly
p38014
aVPrintWindow can only work if the target window implements the WM_PRINT and WM_PRINTCLIENT message
p38015
aVEasy to implement but often overlooked
p38016
as(dp38017
g9
V17034
p38018
stp38019
a((dp38020
g2
(lp38021
VCOM has no concept of a constructor
p38022
aVCOM objects are created with the CoCreateInstance() API function, it has no way to pass any kind of arguments to the class factory
p38023
aVWhile many languages support making their classes visible to COM clients (like
p38024
aVNET's [ComVisible] attribute), only their parameterless constructor will ever be called
p38025
as(dp38026
g9
V17034
p38027
stp38028
a((dp38029
g2
(lp38030
VThe VS2010 option named "Embed Interop Type" only works for COM interop libraries
p38031
aVNot sure what "Windows7ProgressBar" might mean but it certainly doesn't sound much like an interop type
p38032
aVThe native COM interface name is ITaskbarList4
p38033
aVPerhaps you are trying to embed a class wrapper for this interface, that won't work
p38034
aVConsider using the ILMerge tool to combine assemblies
p38035
as(dp38036
g9
V17034
p38037
stp38038
a((dp38039
g2
(lp38040
VIt still does this, here's what I get when I ask it to implement IDisposable:
p38041
aVThis is controlled by an option: Tools + Options, Text Editor, C#, Advanced, "Surround generated code with #region" check box
p38042
aVIf that's on, the default, then look for some kind of add-in disabling or replacing that functionality
p38043
as(dp38044
g9
V17034
p38045
stp38046
a((dp38047
g2
(lp38048
VThe Add Reference dialog can only work for DLLs that contain metadata (managed code) or a type library (a COM server)
p38049
aVYour DLL doesn't fit that bill, you can only use the [DllImport] attribute in C# code to use the P/Invoke marshaller to call an unmanaged DLL entrypoint
p38050
aVThat can not be a native C++ class, like you are trying to do, there is no reliable mechanism for managed code to allocate unmanaged memory and call the constructor (and destructor) of a native C++ class
p38051
aVShort from the difficulty of finding the constructor and destructor code, there is no way for the P/Invoke marshaller to know the size of the object
p38052
aVThe C++ language doesn't generate the metadata necessary to know this required information
p38053
aVIf you want to pursue P/Invoke then write an plain global function, decorated with extern "C", __declspec(dllexport) and (optionally) __stdcall
p38054
aVIf you want to export a C++ class then the only avenue is using the C++/CLI language and write a "ref class" wrapper for the native C++ class
p38055
aVOr you could write a COM coclass, the universal glue in Windows
p38056
aVVery well supported by
p38057
aVNET, probably not something you want to pursue if you never wrote COM code before
p38058
aVATL is the best way to get one going
p38059
as(dp38060
g9
V17034
p38061
stp38062
a((dp38063
g2
(lp38064
VYou can turn a form into a child control:
p38065
aVWhich essentially turns it into a UserControl
p38066
as(dp38067
g9
V17034
p38068
stp38069
a((dp38070
g2
(lp38071
VYou'll need to install the 64-bit version
p38072
aVDownload from here
p38073
aVThe generic solution is to force your program to run in 32-bit mode
p38074
aVProject + Properties, Compile tab, scroll down, Advanced Compile Options, Target CPU = x86
p38075
as(dp38076
g9
V17034
p38077
stp38078
a((dp38079
g2
(lp38080
VThat's code page 709
p38081
aVDifficult,
p38082
aVNET doesn't support it
p38083
aVBest thing to do is to using code page 1256, the Windows code page for Arabic, then translate the bytes using this conversion table (also available as a webpage):
p38084
as(dp38085
g9
V17034
p38086
stp38087
a((dp38088
g2
(lp38089
VWith large matrices like this, the CPU cache becomes the limiting factor
p38090
aVWhat's hyper-important is how the matrix is stored
p38091
aVAnd the benchmark code is comparing apples and oranges
p38092
aVThe C++ code used jagged arrays, the C# code uses two-dimensional arrays
p38093
aVRewriting the C# code to use jagged arrays as well doubled its speed
p38094
aVRewriting the matrix multiply code to avoid the array index boundary check seemed pointless, nobody would use code like this for real problems
p38095
as(dp38096
g9
V17034
p38097
stp38098
a((dp38099
g2
(lp38100
VNo, this isn't okay
p38101
aVIt causes deadlock when the BGW has a RunWorkerCompleted event handler
p38102
aVThat handler cannot run until the main thread goes idle and re-enters the message loop
p38103
aVThe IsBusy property will stay True until that event handler completes
p38104
aVYou have a time-out on the WaitOne call so at least your program won't hang completely
p38105
aVBut when WaitOne() returns, the BGW is not yet completed, the RWC event handler hasn't run yet
p38106
aVThe only practical alternative is for the RWC event handler to do whatever needs done when the cancellation is complete
p38107
as(dp38108
g9
V17034
p38109
stp38110
a((dp38111
g2
(lp38112
VYes, it will fire twice
p38113
aVOnce because the previously selected item became unselected, again for the newly selected item
p38114
aVYou just have to make sure you see the selection event:
p38115
as(dp38116
g9
V17034
p38117
stp38118
a((dp38119
g2
(lp38120
VIt is Microsoft's burden to keep the COM interfaces compatible
p38121
aVIt is required in COM, a published interface can never change
p38122
aVThey've done an astonishing job over the years, it must have been difficult
p38123
aVBut you'll have to pick some kind of version of the PIA to target and avoid using interfaces that became available in later editions
p38124
aVIt is up to you to find out how far you want to go back, we don't know what interfaces you use
p38125
aVDownload it from MSFT and select it in the Add Reference dialog
p38126
aVOffice XP is the earliest, you'd have to generate your own if you want 2000
p38127
as(dp38128
g9
V17034
p38129
stp38130
a((dp38131
g2
(lp38132
VSigh, this an age old problem with USB serial port emulators
p38133
aVSerial ports are devices that date from the stone age
p38134
aVThey used to be screwed into the bus, no way to remove them while a program is using it without drawing sparks and billowing smoke
p38135
aVStone age also includes the lack for any kind of plug-and-play support so that a program could detect that the device is suddenly gonzo
p38136
aVUnfortunately, the majority of the crummy device drivers that emulate them just make them disappear, even though a program has the port opened
p38137
aVThis works just about as well as jerking a flash drive out of the socket when Windows is writing files to it
p38138
aVThere's a background worker thread that waits for notifications from the device driver so that it can generate the DataReceived, ErrorReceived and PinChanged events
p38139
aVThat thread suffers a heart attack when the device suddenly disappears
p38140
aVYou can't catch that, it is a thread that was started by the SerialPort class, you can't wrap it with try/catch
p38141
aVBy popular demand, Microsoft did something about it in
p38142
aVNET 4
p38143
ag2512
aVNot actually sure what happens in that release
p38144
aVIf you're stuck on an earlier release, the only reasonable thing you can do is tape a sign next to the USB slot: "Don't remove while in use
p38145
aVWhich inevitably makes somebody unplug the device at least twice to see what happens
p38146
aVAfter which they get bored with that and leave you in peace
p38147
aVThe very unreasonable workaround is an app
p38148
aVexe
p38149
aVconfig file with this content:
p38150
aVDon't use it
p38151
as(dp38152
g9
V17034
p38153
stp38154
a((dp38155
g2
(lp38156
VThe fun() function is in the global namespace
p38157
aVYou need a prototype:
p38158
as(dp38159
g9
V17034
p38160
stp38161
a((dp38162
g2
(lp38163
VIt is impossible to guess why it fails if you don't find out why
p38164
aVReadFile returns FALSE when it fails
p38165
aVYou should then call GetLastError() to get a diagnostic
p38166
aVNever ignore Windows API return values
p38167
aVAt the very least assert them
p38168
as(dp38169
g9
V17034
p38170
stp38171
a((dp38172
g2
(lp38173
VDouble-click the App
p38174
aVxaml file in Solution Explorer
p38175
aVYou can add the Startup event
p38176
aVIts e
p38177
aVArgs property gives you access to the command line arguments
p38178
as(dp38179
g9
V17034
p38180
stp38181
a((dp38182
g2
(lp38183
VIt is a very low-level COM error, RPC_E_CALL_REJECTED, "Call was rejected by callee"
p38184
aVThat doesn't help much, but clearly Excel isn't very happy with your code
p38185
aVA very good candidate is this statement:
p38186
aVLose that, it doesn't do anything useful
p38187
aVCreating the Application object first is always required
p38188
as(dp38189
g9
V17034
p38190
stp38191
a((dp38192
g2
(lp38193
VThe default is already the current culture as initialized by Windows
p38194
aVSo using CultureInfo
p38195
aVCurrentCulture explicitly is just a waste of time
p38196
aVAny decent serialization format (including binary serialization and XML serialization) will serialize a DateTime in a culture invariant way
p38197
aVUsing a culture that is not the default is very dangerous
p38198
aVA thread will always be started with the default culture as specified by Windows and configured by the user when she installed Windows
p38199
aVNET starts threadpool threads all the time and you'll risk getting a culture in that thread that is different from your main thread
p38200
aVWhich can cause all manner of subtle problems
p38201
aVLike having a SortedList that suddenly isn't sorted anymore
p38202
as(dp38203
g9
V17034
p38204
stp38205
a((dp38206
g2
(lp38207
VJust keep track of them
p38208
aVA dictionary is the natural collection object
p38209
aVFor example:
p38210
as(dp38211
g9
V17034
p38212
stp38213
a((dp38214
g2
(lp38215
VAdd-ins often turn off the Visual Studio features so they can replace them
p38216
aVAnd of course don't restore them when you uninstall them, so you're pretty much forced to keep using them if you can't figure out how to undo the setting changes
p38217
aVTools + Import and Export, Reset might be your best shot
p38218
aVAs long as you haven't customized VS yourself
p38219
aVThe specific setting is Tools + Options, Text Editor, C#, Advanced, "Underline errors in editor" check box
p38220
as(dp38221
g9
V17034
p38222
stp38223
a((dp38224
g2
(lp38225
VOdd choices for a UI
p38226
aVAnyhoo, there is no reason whatsoever to wait for SelectedIndexChanged to process the file
p38227
aVYou might as well do it as soon as the file is selected
p38228
aVIt will work better, the tab control becomes more responsive
p38229
aVIf you wait until the event then the control will be frozen for a while as your UI thread is busy iterating the
p38230
aVzip file
p38231
aVThe user will not consider this desirable
p38232
aVMakes the MVC implementation a lot simpler too, whatever it might look like
p38233
aVExtra bonus is that you now no longer depend on the TabControl and can use whatever controls are best for the job
p38234
as(dp38235
g9
V17034
p38236
stp38237
a((dp38238
g2
(lp38239
VYes, it is awkward
p38240
aVVisual Studio 6 could do this but that got lost in later releases
p38241
aVIt isn't that easy to implement, how managed code returns a value is an implementation detail of the JIT compiler
p38242
aVIt is kinda obvious for simple return value types like Integer or objects but it gets convoluted when a method returns a structure or decimal
p38243
aVThere isn't really anything wrong with storing it in a variable first, the JIT optimizer will get rid of that variable in most cases
p38244
aVBut yes, it looks fugly in the source code
p38245
aVThere is one trick you could use if the return value type is simple, like an integer
p38246
aVSet a breakpoint on the End Function statement, then use Debug + Windows + Registers to display the CPU register values
p38247
aVThe EAX register contains the value
p38248
aVRight-click the window and choose Floating point
p38249
aVThe ST0 register contains a floating point return type value in 32-bit mode
p38250
aVNot great, but something to get by when in a pinch
p38251
as(dp38252
g9
V17034
p38253
stp38254
a((dp38255
g2
(lp38256
VIt depends on the language you use
p38257
aVIn C#, you should declare the argument with the "ref" keyword
p38258
aVIn VB
p38259
aVNET you should use the ByRef keyword
p38260
aVAnd you need to call it by passing a variable, not a constant
p38261
aVSomething like this:
p38262
as(dp38263
g9
V17034
p38264
stp38265
a((dp38266
g2
(lp38267
VShort from a permission problem, the odds are pretty good that the file actually got created but that you just can't find it back
p38268
aVYou are not giving a full path name for the file (like ) which means that it will be created in the current working directory of the COM client app
p38269
aVWhich is guaranteed to be not the same directory where your COM server is located
p38270
aVYou'll need to specify the full path
p38271
aVIn Windows, that should be a directory that you have guaranteed write access to
p38272
aVUse SHGetFolderPath() to get the path to the appdata folder
p38273
aVOr set aside a fixed directory name for logging (not recommended)
p38274
as(dp38275
g9
V17034
p38276
stp38277
a((dp38278
g2
(lp38279
VYou are not using the Windows Forms WebBrowser control
p38280
aVI think you got the COM wrapper for ieframe
p38281
aVdll, its name is AxWebBrowser
p38282
aVVerify that by opening the References node in the Solution Explorer window
p38283
aVIf you see AxSHDocVw then you got the wrong control
p38284
aVIt is pretty unfriendly, it just gives you an opaque interface pointer for the Document property
p38285
aVYou'll indeed only get the default object class members
p38286
aVLook in the toolbox
p38287
aVPick WebBrowser instead of "Microsoft Web Browser"
p38288
as(dp38289
g9
V17034
p38290
stp38291
a((dp38292
g2
(lp38293
VDocumentCompleted will fire for each frame in the web page
p38294
aVThe hard way is to count off the frames, shows you how to access the DOM:
p38295
aVThe easy way is to check the URL that completed loading:
p38296
as(dp38297
g9
V17034
p38298
stp38299
a((dp38300
g2
(lp38301
VIt isn't clear from the docs what ConvertBSTRToString() uses to determine the current locale
p38302
aVBut you can be pretty sure that it is not the CRT locale as set by setlocale()
p38303
aVYou almost certainly need to call SetThreadLocale()
p38304
aVUse WideCharToMultiByte() to make it less of a guess
p38305
as(dp38306
g9
V17034
p38307
stp38308
a((dp38309
g2
(lp38310
VThey are not interchangeable
p38311
aVYou can only use a Unicode escape in an identifier name:
p38312
aVBut in a string or char literal it doesn't make a heck of a lot of difference
p38313
aVI prefer \u005cu myself because the escape code has a fixed number of digits, \u005cx is variable
p38314
aVBut easy enough to avoid mistakes
p38315
aVAlso note /U to pick codepoints from the upper planes
p38316
as(dp38317
g9
V17034
p38318
stp38319
a((dp38320
g2
(lp38321
VA CRC has the same flaw as any hashing function: an equal CRC value does not proof that the images are identical
p38322
aVYour program will randomly, but infrequently, display the wrong image
p38323
aVYou need something else
p38324
aVLike the filename from which you retrieved the bitmap
p38325
as(dp38326
g9
V17034
p38327
stp38328
a((dp38329
g2
(lp38330
VThose are LCID values, not sure what LID means
p38331
aVYou can get them out of GetLocaleInfoEx(), available in Vista and up
p38332
aVYou need to pass a locale name like "en-US", necessary to nail down the language locale
p38333
aVFor example:
p38334
aVOutput: LCID = 0409
p38335
as(dp38336
g9
V17034
p38337
stp38338
a((dp38339
g2
(lp38340
VIt is a non-issue
p38341
aVWindows has been a native Unicode operating system for the past 17 years, long before XP was released
p38342
aVDavid Cutler's brain child, NT 3
p38343
aV1, was Unicode from day one
p38344
aVIn the unlikely case that your program lands on a Window 9x machine, there's still an API layer that can translate your UTF-16 strings to 8-bit chars
p38345
aVThere's no point left in using TCHAR for new code development
p38346
as(dp38347
g9
V17034
p38348
stp38349
a((dp38350
g2
(lp38351
VYour C# declaration is wrong
p38352
aVA VB6 "Long" is 32-bits for historical reasons
p38353
aVThat's an int on the C# side
p38354
aVWith the stack frame wrong, you have no odds of getting the "result" argument passed correctly
p38355
aVIt ought to be a SafeArray of Variants, object[] in C#
p38356
as(dp38357
g9
V17034
p38358
stp38359
a((dp38360
g2
(lp38361
VWriting single-instance apps is tricky
p38362
aVYou don't have to, the
p38363
aVNET framework already supports them really well
p38364
aVProject + Add Reference, select Microsoft
p38365
aVVisualBasic
p38366
aVOpen your project's Program
p38367
aVcs file and make it look like this:
p38368
as(dp38369
g9
V17034
p38370
stp38371
a((dp38372
g2
(lp38373
VUnlucky guess
p38374
aVEither the Enter or the Activated event will solve your problem
p38375
aVIn Windows Forms programming, you'd typically want to avoid the GotFocus and LostFocus events
p38376
aVThey are often hidden in the designer, but not consistently
p38377
aVRespectively, the Enter and Leave events are their replacements, they are generated from the logical state of the UI instead of the raw Windows messages
p38378
aVMakes a difference when using Validating and MDI
p38379
aVActivated is the "natural" one since the actual focus moves to a child control of that form
p38380
as(dp38381
g9
V17034
p38382
stp38383
a((dp38384
g2
(lp38385
VIt sure doesn't look like a vector you're leaking
p38386
aVNote that the string is readable, that's at least one hint
p38387
aVIf you can get the number between the curly braces stable ("{173}") then you can get a breakpoint when the memory is allocated
p38388
aVPut this in your main() function:
p38389
aVUse  if necessary
p38390
aVRepeat for 174 to find the other one
p38391
as(dp38392
g9
V17034
p38393
stp38394
a((dp38395
g2
(lp38396
VIt is not a COM server
p38397
aVYou have to use P/Invoke to use this DLL
p38398
aVThe instructions are available in the source code file, it gives the VB6 declarations:
p38399
aVWhich you'll have to translate to the corresponding VB
p38400
aVNET or C# [DllImport] declaration
p38401
aVUse "int" instead of Long in those declarations
p38402
aVFor example:
p38403
aVEtcetera
p38404
as(dp38405
g9
V17034
p38406
stp38407
a((dp38408
g2
(lp38409
VYou are printing the content of a
p38410
aVjpg file as a C string
p38411
aVIt isn't a string, it won't be zero-terminated correctly
p38412
aVYou'll get some kind of rendition of the bytes in the
p38413
aVjpg, followed by a random number of characters
p38414
aVUntil it blunders into a zero somewhere
p38415
aVApparently quickly enough to prevent your program crashing
p38416
as(dp38417
g9
V17034
p38418
stp38419
a((dp38420
g2
(lp38421
VIt works by accident right now, those components have probably captured the mouse
p38422
aVYou need to pass the mouse pointer coordinates in the 2nd and 3rd arguments
p38423
aVThus:
p38424
as(dp38425
g9
V17034
p38426
stp38427
a((dp38428
g2
(lp38429
VIt is a chord, you cannot detect it without memorizing having seen the first keystroke of the chord
p38430
aVThis works:
p38431
as(dp38432
g9
V17034
p38433
stp38434
a((dp38435
g2
(lp38436
VProject + Properties, Debug tab, tick "Enable unmanaged code debugging"
p38437
aVThis still won't make it easy, but at least you can look at the unmanaged stack frames when it bombs
p38438
aVMake sure you've got the
p38439
aVpdb files for the Qt code
p38440
as(dp38441
g9
V17034
p38442
stp38443
a((dp38444
g2
(lp38445
VI'm not familiar enough with Jing to know exactly what it uses
p38446
aVBut there are two basic techniques
p38447
aVOne is as you mention, capture the screen and display it in a topmost borderless form
p38448
aVThe Vista/Win7 Snipping tool works that way
p38449
aVYou'll find the code you need to get this started it in my answer in this thread
p38450
aVThe other, perhaps more likely to be used by Jing, is similar to what Spy++ does, allowing the user to move the mouse and draw a selection rectangle around the window
p38451
aVIts advantage is that it can deal with windows resizing or disappearing while you've got the tool running
p38452
aVYou implement it by using a topmost form the size of the screen that has its TransparencyKey property set to the value of the BackColor
p38453
aVFuchsia is a popular choice
p38454
aVYou can draw on this form with the OnPaint() method, the drawing appears on top of all the windows
p38455
aVYou'd need some P/Invoke (GetWindow) to iterate the underlying windows in their Z-order to know which window the user is pointing at
p38456
aVGetWindowRect() to get the window rectangle
p38457
aVPlus some hassle to deal with Aero lying about the border size
p38458
aVYou can find sample code to get you started on that technique in my answer in this thread
p38459
as(dp38460
g9
V17034
p38461
stp38462
a((dp38463
g2
(lp38464
VYou need to get the handle of the installer window
p38465
aVNot so sure how to get it, but Process
p38466
aVGetCurrentProcess()
p38467
aVMainWindowHandle ought to give you good odds
p38468
aVThen create a NativeWindow to wrap the handle so you can use it as the owner
p38469
aVLike this:
p38470
as(dp38471
g9
V17034
p38472
stp38473
a((dp38474
g2
(lp38475
VThis will produce a runtime error in the app that tries to access the operating system resource
p38476
aVWindows error 5, ERROR_ACCESS_DENIED
p38477
aVIf you don't get any diagnostic in the app's log file, an event in the Application event log or an explicit managed exception that tells you what went wrong then you'll be looking for a needle in a haystack
p38478
as(dp38479
g9
V17034
p38480
stp38481
a((dp38482
g2
(lp38483
VIt is the job of the JIT compiler to generate the machine code
p38484
aVIt will do so based on the architecture of the processor it runs on
p38485
aVYes, it will use SSE instructions when appropriate, the x64 JITter uses them heavily
p38486
aVIf you want to use SSE2 in your code then you'll have to compile it separately without /clr
p38487
aVOr use the #pragma managed directive to switch to machine code generation so you can use the intrinsics
p38488
as(dp38489
g9
V17034
p38490
stp38491
a((dp38492
g2
(lp38493
VC++/CLI doesn't support anonymous delegates, that's an exclusive C# feature
p38494
aVYou need to write the delegate target method in a separate method of the class
p38495
aVYou'll also need to declare the delegate type, MethodInvoker can't do the job
p38496
aVMake it look like this:
p38497
as(dp38498
g9
V17034
p38499
stp38500
a((dp38501
g2
(lp38502
VThe extra indirection is not allowed
p38503
aVYou'd have to write the ContextMenuManager class like this:
p38504
aVNow you can use "Handles _ctx
p38505
aVClick"
p38506
aVThere's certainly value in hiding the implementation details of ContextMenuManager so the extra code may well be worth it
p38507
aVYes, AddHandler doesn't have this restriction
p38508
as(dp38509
g9
V17034
p38510
stp38511
a((dp38512
g2
(lp38513
VI don't see how this code could repro the problem
p38514
aVAfter looper increments to 45, it should be about done consuming any memory
p38515
aVThe generic diagnostic is that a program very rarely manages to consume all possible available virtual memory
p38516
aVIt will die first on finding a chunk of contiguous bytes inside the heap that's large enough to store the string stream buffer
p38517
aVIt is called address space fragmentation, there isn't anything you can do about it
p38518
aVYour Sleep() call will certainly not do anything useful, consolidating allocated heap blocks requires a garbage collector
p38519
aVAnother pretty standard trap is using TaskMgr
p38520
aVexe to diagnose memory usage
p38521
aVIt normally displays the working set, the amount of virtual memory that's mapped to RAM
p38522
aVThat's usually only a fraction of the amount of virtual memory your program consumes and cannot give a true measure of how much virtual memory your program has consumed
p38523
aVOr tell you anything about address space fragmentation for that matter
p38524
aVThe SysInternals' VMMap utility can show you how your program is using virtual memory
p38525
as(dp38526
g9
V17034
p38527
stp38528
a((dp38529
g2
(lp38530
VSounds to me like the debugger is using the wrong
p38531
aVpdb file
p38532
aVTools + Options, Debugging, General, ensure that "Require source files to exactly match the original version" is checked
p38533
aVWhile debugging with a breakpoint active, use Debug + Windows + Modules and right-click your executable in the list
p38534
aVClick "Symbol Load Information" to find out where the debugger found the
p38535
aVpdb file
p38536
aVAnother possible mishap is that this class is defined in a separately compiled executable, like a DLL, which was compiled with incompatible settings
p38537
aVSo that the layout of the object no longer matches
p38538
aVThat's not that likely in this case
p38539
as(dp38540
g9
V17034
p38541
stp38542
a((dp38543
g2
(lp38544
VA ListBox is not designed to be a container control
p38545
aVIts scrollbar cannot scroll the controls
p38546
aVIt is in general something you want to avoid, putting a lot of controls in, say, a Panel whose AutoScroll property is True will make your UI unresponsive
p38547
aVControls are expensive objects
p38548
aVTake a look at the ListBox
p38549
aVDrawItem event
p38550
aVYou can draw your own item and make it look just the way you want it with the Graphics class methods
p38551
aVAnd it is very cheap
p38552
aVThere's a very good example in the MSDN Library article for the event
p38553
as(dp38554
g9
V17034
p38555
stp38556
a((dp38557
g2
(lp38558
VIt is because the C# team members are all skilled C++ programmers
p38559
aVAnd know how incipient this particular bug is:
p38560
aVIt is a lot more common then you might think
p38561
aVThe derived class is always declared in another source code file
p38562
aVYou don't typically get this wrong right away, it happens when you refactor
p38563
aVNo peep from the compiler, the code runs pretty normal, just doesn't do what you expect it to do
p38564
aVYou can look at it for an hour or a day and not see the bug
p38565
aVThis can never happen in a C# program
p38566
aVEven managed C++ adopted this syntax, breaking with native C++ syntax intentionally
p38567
aVAlways a courageous choice
p38568
aVIntelliSense takes the sting out the extra verbiage
p38569
aVThere's a lot of syntax tweaks in C# that resemble this kind of bug avoidance syntax
p38570
aVEDIT: and the rest of the C++ community agreed and adopted the override keyword into the new C++11 language specification
p38571
as(dp38572
g9
V17034
p38573
stp38574
a((dp38575
g2
(lp38576
VIt is because control validation is the default for the Binding class
p38577
aVYou might want to change the Binding
p38578
aVDataSourceUpdateMode property to DataSourceUpdateMode
p38579
aVOnPropertyChanged so a value is only assigned when the user changes the combo box selection
p38580
as(dp38581
g9
V17034
p38582
stp38583
a((dp38584
g2
(lp38585
VJust implement the FormClosing event
p38586
aVCancel the close and hide the form unless it was triggered by the notify icon's context menu
p38587
aVFor example:
p38588
as(dp38589
g9
V17034
p38590
stp38591
a((dp38592
g2
(lp38593
VSounds like you use MSVC, Debug + Windows + Registers
p38594
aVLook at the value of ESP before and after the call
p38595
aVIf it doesn't match then first change the calling convention in the function pointer declaration (did you do that right
p38596
aVIf it still doesn't match then it is __stdcall and you haven't guessed the arguments you need to pass correctly
p38597
aVOr the function could just clobbers the stack frame, it isn't impossible
p38598
aVPosting your function pointer declaration that shows the real arguments would probably help diagnose this better
p38599
as(dp38600
g9
V17034
p38601
stp38602
a((dp38603
g2
(lp38604
VYes, msvsmon
p38605
aVexe will be used when you debug a 64-bit program
p38606
aVSince Visual Studio is completely 32-bit, the remote debugger is needed to bridge the divide
p38607
aVThere isn't any reason to assume that the slowdown is caused by it being a remote debugger
p38608
aVWorking mightily to find and load the
p38609
aVpdb files would be likely
p38610
aVOr accidentally having the mixed-mode debugging option turned on so the debugger is also seeing all unmanaged DLL loads and finding symbols for them
p38611
aVThese are just guesses of course
p38612
as(dp38613
g9
V17034
p38614
stp38615
a((dp38616
g2
(lp38617
VThe JIT compiler is keenly aware that it generates code for a proxy
p38618
aVYou can have a look-see with the SSCLI20 source code, clr\u005csrc\u005cvm\u005cjithelpers
p38619
aVcpp, search for "proxy"
p38620
as(dp38621
g9
V17034
p38622
stp38623
a((dp38624
g2
(lp38625
VThis is probably because you don't use the ShowDialog(owner) overload
p38626
aVYou should fret a little bit about the exact reason that ShowDialog() cannot find an owner by itself and picked the desktop window instead
p38627
aVIt isn't healthy
p38628
aVI cannot guess why from your post
p38629
aVSee what explicitly setting the owner buys you
p38630
aVOh, this will happen when the dialog runs on its own thread
p38631
aVIn which case ShowDialog(owner) is going to bomb
p38632
as(dp38633
g9
V17034
p38634
stp38635
a((dp38636
g2
(lp38637
VThis is pure operating system behavior
p38638
aVThe dialog lives in the shell, the
p38639
aVNET wrapper class is a very thin one around GetOpenFileName()
p38640
aVI don't know much about XP x64, except that it was training wheels for Vista x64
p38641
aVIt wasn't done with several COM servers not yet translated to x64
p38642
aVAnd that it didn't get the SP3 update sounded iffy to me
p38643
aVYou can assume that your customer is unlikely to see the same problem
p38644
aVI'm not close to one right now to verify that
p38645
as(dp38646
g9
V17034
p38647
stp38648
a((dp38649
g2
(lp38650
VWell, it seems convinced there's not actually an active try block on the stack
p38651
aVBut double-check that the Debug + Exceptions, Thrown check boxes are off
p38652
aVAlso make sure you've got the Debug configuration selected and verify Tools + Options, Debugging, General, "Require source files to exactly match the original version" is ticked
p38653
as(dp38654
g9
V17034
p38655
stp38656
a((dp38657
g2
(lp38658
VSounds to me like that stack frame was blown
p38659
aVTrivial to do with a buffer overflow, just copy a large string in a small char[] for example
p38660
aVThat wipes out the return address
p38661
aVThe code just keeps running until the return, then bombs when it pops a bad address off the stack
p38662
aVOr worse, if the address happens to be valid
p38663
aVThe debugger cannot display anything meaningful since it cannot walk the stack to show you how the code got to the crash location
p38664
aVThe actual crash location doesn't tell you anything
p38665
aVTuff as nails to debug
p38666
aVYou have to get it reproducible and you need either stepping or tracing to find the last known-good function
p38667
aVThe one that produces the crash after stepping out of it is the one with the bug
p38668
aVYou can actually see the statement that does the damage, the debugger call stack suddenly goes catatonic
p38669
aVIf you can't get a consistent repro then a thorough code review is all that's left
p38670
aVYou can justify the time by calling it a "security review"
p38671
aVGood luck with it
p38672
as(dp38673
g9
V17034
p38674
stp38675
a((dp38676
g2
(lp38677
VYou need to prevent the native control from seeing the mouse click so it won't unselect an item
p38678
aVAdd a new class to your project and paste the code shown below
p38679
aVCompile
p38680
aVDrop it from the top of the toolbox onto your form, replacing the existing one
p38681
as(dp38682
g9
V17034
p38683
stp38684
a((dp38685
g2
(lp38686
VThere is no real difference
p38687
aVIt is just a project template, it helps you get all the project settings right
p38688
aVYes, the assembly references are one of the biggies
p38689
aVI don't have it installed to check, but you can use, say, notepad to look at the
p38690
aVvcproj file to see what settings are overridden from their default
p38691
as(dp38692
g9
V17034
p38693
stp38694
a((dp38695
g2
(lp38696
VIt is missing
p38697
aVYou could fix it by using the [importidl] attribute in your code
p38698
aVAttributed programming was a bit of a mistake, it got essentially deprecated when it was removed as an option for the ATL Project wizard in VS2008
p38699
aVFor long term maintenance of your code base consider removing it
p38700
aVYou can use the auto-generated
p38701
aVidl as a way to get that started
p38702
as(dp38703
g9
V17034
p38704
stp38705
a((dp38706
g2
(lp38707
VIt is UB
p38708
aVA good way to make it crash is to use it as a base class of a derived class that uses multiple inheritance
p38709
aVYMMV
p38710
as(dp38711
g9
V17034
p38712
stp38713
a((dp38714
g2
(lp38715
VIf you can get it to run, yes
p38716
aVCompiling with /MDd (the default) requires distributing the debug version of the dynamic CRT
p38717
aVIt is not a redistributable component, shipping it anyway is a license violation
p38718
aVYou could get around it by compiling with /MTd
p38719
aVOf course, your user will have no idea what "Debug assertion failed" means and won't understand why Ignore doesn't work
p38720
aVBest avoided
p38721
as(dp38722
g9
V17034
p38723
stp38724
a((dp38725
g2
(lp38726
VIt doesn't force a context switch, only Sleep(1) does that
p38727
aVBut if there's any other thread from any process ready to run and has a higher priority then Sleep(0) will yield the processor and let it run
p38728
aVYou can see this by running an endless loop that calls Sleep(0), it will burn 100% CPU cycles on one core
p38729
aVI don't understand why you don't observe this behavior
p38730
aVThe best way to keep the system responsive is by giving your thread a low priority
p38731
as(dp38732
g9
V17034
p38733
stp38734
a((dp38735
g2
(lp38736
VPerf takes a nose-dive on x86 and x64 cores when a member straddles a cache line boundary
p38737
aVThe common compiler default is 8 byte packing which ensures you're okay on long long, double and 64-bit pointer members
p38738
aVSSE2 instructions require an alignment of 16, the code will bomb if it is off
p38739
aVYou cannot get that out of a packing pragma, the heap allocator for example will only provide an 8-byte alignment guarantee
p38740
aVFind out what your compiler and CRT support
p38741
aVSomething like __declspec(align(16)) and a custom allocator like _aligned_malloc()
p38742
aVOr over-allocate the memory and tweak the pointer yourself
p38743
as(dp38744
g9
V17034
p38745
stp38746
a((dp38747
g2
(lp38748
VUnicode solves a lot of problems, but not that one
p38749
aVUnicode is just a different encoding for a character, 1, 2 or 4 bytes, they are still stored in a plain array
p38750
aVYou can use infinite strings when you find a machine with infinite memory
p38751
as(dp38752
g9
V17034
p38753
stp38754
a((dp38755
g2
(lp38756
VExponential back-off is the common choice here I think
p38757
aVLike the strategy that TCP uses to try to make a connection: double the timeout on each failed attempt
p38758
aVPrevents your program from flooding the event log with repeated failure notifications before somebody notices that something is wrong
p38759
aVWhich can take a while
p38760
aVHowever, using the task scheduler certainly doesn't help
p38761
aVYou really ought to reprogram it so your program isn't consuming machine resource needlessly
p38762
aVBut using the ITaskService interface from
p38763
aVNET isn't that easy
p38764
aVCheck out this project
p38765
as(dp38766
g9
V17034
p38767
stp38768
a((dp38769
g2
(lp38770
VYou might have noticed that the HResult property is not accessible
p38771
aVThe workaround is to use the Marshal
p38772
aVGetLastWin32Error() method to get the native Windows error code
p38773
aVLike this:
p38774
aVError code 32 is named ERROR_SHARING_VIOLATION in the SDK
p38775
as(dp38776
g9
V17034
p38777
stp38778
a((dp38779
g2
(lp38780
VThe native Windows DTP control is quite primitive
p38781
aVIt doesn't support anything like HitTest() as supported by ListView and TreeView
p38782
aVTrying to guess where the mouse is located from the mouse position is dangerous, DTP is sensitive to format overrides in the Control Panel's Region settings
p38783
aVDon't try to make this work
p38784
as(dp38785
g9
V17034
p38786
stp38787
a((dp38788
g2
(lp38789
VThe C::func() method doesn't promise that it won't modify the object, it only promises that it won't modify its argument
p38790
aVFix:
p38791
aVOr make it a static function
p38792
aVWhich sure sounds like it should be when it takes a C object as an argument
p38793
as(dp38794
g9
V17034
p38795
stp38796
a((dp38797
g2
(lp38798
VDid you actually create a
p38799
aVrtf in the proper format or did you just rename a text file
p38800
aVYou'll need either Wordpad or Microsoft Word to create one
p38801
aVWordpad is the better choice, it is likelier to create RTF in a format that the rich text box fully supports
p38802
as(dp38803
g9
V17034
p38804
stp38805
a((dp38806
g2
(lp38807
VUse the MouseMove event
p38808
aVCall the HitTest() method
p38809
as(dp38810
g9
V17034
p38811
stp38812
a((dp38813
g2
(lp38814
VYou have to add the reference
p38815
aVIf you don't then the compiler will complain and tell you to add the reference
p38816
aVUsing Reflection hacks should be a very distant second choice, it merely makes your code slow and still doesn't remove the runtime dependency on the DLL
p38817
as(dp38818
g9
V17034
p38819
stp38820
a((dp38821
g2
(lp38822
VUse the Bitmap::FromHBITMAP() method
p38823
aVThen just Save() it
p38824
as(dp38825
g9
V17034
p38826
stp38827
a((dp38828
g2
(lp38829
VRunning the test 20 times in a row, ensuring that JIT optimization is enabled in the Release build:
p38830
aVYes, the JITter is that good at inlining property accessors
p38831
aVPerf is a non-issue and should never be considered
p38832
as(dp38833
g9
V17034
p38834
stp38835
a((dp38836
g2
(lp38837
VIt is possible because of metadata in an assembly, put there by the compiler
p38838
aVAnd an extensive API that allows reading that data
p38839
aVAnd the essential Object
p38840
aVGetType() method and typeof keyword
p38841
aVNone of which is available in a C or C++ compiler
p38842
aVYou could hack around this a bit with RTTI and reading the debug symbol file
p38843
aVI doubt it's worth the effort
p38844
as(dp38845
g9
V17034
p38846
stp38847
a((dp38848
g2
(lp38849
VAny Windows Forms control has a Paint event, you don't have to derive your own class
p38850
aVBut sure, you can, it helps partitioning the code
p38851
aVJust pick a base class that already provides most of what you need
p38852
aVSet the DoubleBuffered property to true in the constructor and override OnPaint
p38853
as(dp38854
g9
V17034
p38855
stp38856
a((dp38857
g2
(lp38858
VThose are device fonts, a relic from the Windows 3
p38859
aV0 days before TrueType became available
p38860
aVThey contain bitmaps of (typically) 256 glyphs in a certain character set at fixed pre-selected point sizes
p38861
aVThey are not scalable beyond those fixed sizes
p38862
aVNope, neither GDI+ nor WPF supports them
p38863
aVYou'd have to fall back to raw GDI to still use them
p38864
aVThe file format isn't complicated, it would be technically possible to lift the bitmaps out of the file
p38865
aVI'm not aware of existing code, although I'm sure somebody did
p38866
aVSome kind of legacy font editor for example
p38867
as(dp38868
g9
V17034
p38869
stp38870
a((dp38871
g2
(lp38872
VImprove your app's unhandled exception handling
p38873
aVWrite an event handler for AppDomain
p38874
aVCurrentDomain
p38875
aVUnhandledException and log the value of e
p38876
aVExceptionObject
p38877
aVToString()
p38878
aVOr use a debugger
p38879
as(dp38880
g9
V17034
p38881
stp38882
a((dp38883
g2
(lp38884
VThe problem is not completely because of your code, it is how you look at the text
p38885
aVThe only way that your text editor can know that the file contains Unicode is by the required BOM
p38886
aVYou didn't write one
p38887
aVUse "ccs=UTF-16LE" in the _wfopen() mode string
p38888
aVThere's a similar problem with the console, it cannot display UTF-16 encoded characters
p38889
aVIt only handles 8-bit characters, you'd have to use UTF-8 encoding and SetConsoleOutputCP()
p38890
aVAnother problem is the  macro
p38891
aVThat's still an 8-bit character string
p38892
aVYou have to use the %hs format specifier
p38893
as(dp38894
g9
V17034
p38895
stp38896
a((dp38897
g2
(lp38898
VWell, it's technically possible
p38899
aVYou have to redirect the mouse message yourself, that requires a bit of P/Invoke
p38900
aVPaste this code into your inner UserControl class:
p38901
aVThis is best avoided btw
p38902
aVThe parent control should probably just subscribe to the inner control's mouse events
p38903
as(dp38904
g9
V17034
p38905
stp38906
a((dp38907
g2
(lp38908
VThis cannot work by design
p38909
aVAn int is a value type
p38910
aVThe GetValue() method returns a copy of the int
p38911
aVYou'll increment that copy, not the original
p38912
aVReflection doesn't have any way to get a reference to a value type value
p38913
as(dp38914
g9
V17034
p38915
stp38916
a((dp38917
g2
(lp38918
VSplitContainer
p38919
aVPanel2
p38920
aVBounds gives you the rectangle of the portion of the right-hand side panel that's visible
p38921
as(dp38922
g9
V17034
p38923
stp38924
a((dp38925
g2
(lp38926
VBlend effects are easy to get going by using the ColorMatrix class
p38927
aVThere's a good example available in my answer in this thread
p38928
aVA simple way to get a blur is to resize the image, making it smaller, then redraw it back, making it larger
p38929
aVThe Graphics
p38930
aVInterpolationMode property affects the type of blur you'll get
p38931
aVThose are quicky do-it-yourself solutions
p38932
aVAny decent graphics library has these kind of operations built-in
p38933
aVYou probably want something free, check out ImageMagick
p38934
aVNET
p38935
as(dp38936
g9
V17034
p38937
stp38938
a((dp38939
g2
(lp38940
VNot quite sure I follow
p38941
aVBut if you want erase something that was drawn on top of an image then you can erase by drawing the image back
p38942
aVThat's easy to do if you use the TextureBrush class
p38943
aVI think you need the TextureBrush(Image, Rectangle) overload to create it
p38944
aVPass the background image as the first argument, the bounding rectangle of that image as the second argument
p38945
as(dp38946
g9
V17034
p38947
stp38948
a((dp38949
g2
(lp38950
VYuck, that's fugly
p38951
aVThis can only work well if MyProgram
p38952
aVexe is a console mode application
p38953
aVRequired to get input/output redirection working
p38954
aVIt probably works in the debugger because of the Visual Studio hosting process
p38955
aVP/Invoking AllocConsole in your program would solve the issue
p38956
aVI'll guess you don't particularly care for that console window, you'd have to rewrite that interface
p38957
aVUsing named pipes would solve it
p38958
aVRealistically, it doesn't make any sense to run the solver as a separate process
p38959
aVTake a look at C++/CLI to get ahead
p38960
as(dp38961
g9
V17034
p38962
stp38963
a((dp38964
g2
(lp38965
VYou can use a brush that's made from a Color that has an alpha of 0 (Color
p38966
aVFromArgb)
p38967
aVSince the RGB values don't really matter anymore, you might as well use Brushes
p38968
aVTransparent
p38969
aVMake a single pixel transparent by drawing a rectangle of 1x1 with Graphics
p38970
aVFillRectangle()
p38971
aVBitmap
p38972
aVMakeTransparent() is another way to quickly make an arbitrary background color transparent
p38973
as(dp38974
g9
V17034
p38975
stp38976
a((dp38977
g2
(lp38978
VDocumented in the C# language specification, chapter 2
p38979
ag2588
aV4:
p38980
aVNothing for int, byte, sbyte, short, ushort
p38981
as(dp38982
g9
V17034
p38983
stp38984
a((dp38985
g2
(lp38986
VThere are only two real alternatives: put the DLL in the same folder as the EXE or put it in the working directory for the EXE
p38987
aVThe latter being not much of an option since you'd have to create a shortcut to make the default working directory different from the directory that contains the EXE
p38988
aVNot putting the DLL in the same directory as the EXE only makes sense if you want to share the DLL with other applications
p38989
aVTo avoid the inevitable DLL hell this causes, you'd need to store the DLL in the side-by-side cache
p38990
aVThe tooling you need to create the manifest and embed it in the EXE and the installer you'd need to deploy the DLL to the target machine are probably hard to come by with your tool chain
p38991
aVIt is very rarely done anyway
p38992
as(dp38993
g9
V17034
p38994
stp38995
a((dp38996
g2
(lp38997
VIt is a side-effect of interpolation when you use extreme magnification
p38998
aVYou'll need something like this:
p38999
as(dp39000
g9
V17034
p39001
stp39002
a((dp39003
g2
(lp39004
VIt is easy if you know that your program was started from the CD
p39005
aVJust read the program location back:
p39006
as(dp39007
g9
V17034
p39008
stp39009
a((dp39010
g2
(lp39011
VWriting a wrapper for the IntPtr could certainly work
p39012
aVBut it is unnecessary if the memory should stay valid as long as the item is stored in the dictionary
p39013
aVIf that's the case, it is much easier on the client code if you create your own directory, one that automatically frees the memory when an item is removed from the dictionary
p39014
aVNo need for the client to call Dispose() for each item, that's always an advantage
p39015
aVTo do this, derive your own class from  and IDisposable
p39016
aVYou can simply delegate most of the method calls to a private dictionary
p39017
aVYou'll want a custom Add() to allocate the memory, Delete to release it
p39018
aVAnd implement Dispose() and the finalizer to clean up
p39019
aVThe code is kinda ugly though:
p39020
aVAllocCoTaskMem is the better allocator btw, it doesn't have the legacy baggage
p39021
as(dp39022
g9
V17034
p39023
stp39024
a((dp39025
g2
(lp39026
VErm, turning a form into a child control takes some surgery
p39027
aVYou have to set its TopLevel property to false, hide the border, make it visible
p39028
aVI don't see it in the code snippet, is MainTab actually a form
p39029
aVAnyhoo, you cannot use the Focus() method on a control until it is visible
p39030
aVOdds are good that it isn't visible yet in your code snippet
p39031
aVUse the Select() method instead
p39032
aVSay:
p39033
aVOr just set the TabIndex property of the first control that should get the focus to 0 in the designer
p39034
as(dp39035
g9
V17034
p39036
stp39037
a((dp39038
g2
(lp39039
VWell, it would be a mistake
p39040
aVI'm going to guess your are a former C/C++ programmer, std::list is king
p39041
aVOn the surface, it is incredibly frugal with memory, can't make a list possibly more efficient than only allocating the memory you need, right
p39042
aVYes, LinkedList does that
p39043
aVBut no, it is incredibly incompatible with the way CPU caches work, they really like arrays and hate pointers
p39044
aVPut the garbage collector on top of that, so quite capable of packing memory
p39045
aVThe read-them-and-weep benchmarks are here
p39046
aVStark
p39047
as(dp39048
g9
V17034
p39049
stp39050
a((dp39051
g2
(lp39052
VI repro the problem
p39053
aVThere are several mistakes in the code, the font name is "Arial", you should not adjust rect
p39054
aVWidth, you forget to call Dispose() on the fonts, brushes and regions
p39055
aVBut they don't explain the behavior
p39056
aVThere's something wrong with the clipping area that prevents the text from being properly updated
p39057
aVI don't see where that occurs, the Graphics object state is okay
p39058
aVGraphics
p39059
aVDrawString() is a very troubled method, you should really avoid it
p39060
aVAll Windows Forms controls, including ListBox, use TextRenderer
p39061
aVDrawText()
p39062
aVThat solves the  problem when I use it
p39063
aVI know measuring is more difficult, you could work around that by displaying the IP address at a fixed offset
p39064
aVLooks better too, they'll line up in a column that way
p39065
aVIt flickers because you use e
p39066
aVDrawBackground()
p39067
aVThat erases the existing text, you draw the text right back on it
p39068
aVI don't think double-buffering is going to fix that, you'd have to draw the entire item so you don't have to draw the background
p39069
aVTricky if you can't get the exact size of the text with the large font, a workaround is to draw into a bitmap first
p39070
as(dp39071
g9
V17034
p39072
stp39073
a((dp39074
g2
(lp39075
VYes, you are running afoul with the SystemEvents class
p39076
aVThat class creates a hidden window that listens to system events
p39077
aVParticularly the UserPreferenceChanged event, a lot of controls use that event to know when they need to repaint themselves because the system colors were changed
p39078
aVProblem is, the initialization code that creates the window is very sensitive to the apartment state of the thread that calls it
p39079
aVWhich in your case is wrong, you didn't call Thread
p39080
aVSetApartmentState() to switch to STA
p39081
aVThat's very important for threads that display a UI
p39082
aVBeware that your workaround isn't actually a fix, the system events will be raised on the wrong thread
p39083
aVYour splash thread instead of the UI thread of your program
p39084
aVYou'll still get random and extremely hard to diagnose failure when an actual system event gets fired
p39085
aVMost infamously when the user locks the workstation, the program deadlocks when it is unlocked again
p39086
aVI think calling Thread
p39087
aVSetApartmentState() should fix your problem
p39088
aVNot 100% sure, these UI thread interactions are very difficult to analyze and I haven't gotten this wrong yet
p39089
aVNote that
p39090
aVNET already has very solid support for splash screens
p39091
aVIt definitely gets details like this right
p39092
as(dp39093
g9
V17034
p39094
stp39095
a((dp39096
g2
(lp39097
VAh, so that's what that other thread was about
p39098
aVThere's a much better way to accomplish this, CopyFileEx() also supports a progress callback
p39099
aVThat callback allows you to update the UI to show progress
p39100
aVAnd it allows you to cancel the copy, just return PROGRESS_CANCEL from the callback
p39101
aVVisit pinvoke
p39102
aVnet for the callback delegate declaration you'll need
p39103
as(dp39104
g9
V17034
p39105
stp39106
a((dp39107
g2
(lp39108
VThese kind of "could this work" APIs don't exist on a multi-tasking operating system
p39109
aVThey are inherently unreliable, like checking if a file is locked
p39110
aVSuch a test could return "not locked", then your thread could be pre-empted and another thread in another process could lock the file
p39111
aVWhen your thread regains the CPU, you'll find out that the file is locked, even though the test said it wasn't
p39112
aVThe only way to do this is to actually perform the operation, then look for an error to indicate it wasn't possible
p39113
aVAn exception in C#, use the try statement to catch the IOException
p39114
aVNot that easy to deal with, but at least NTFS allows you to rename or move a file that is locked
p39115
as(dp39116
g9
V17034
p39117
stp39118
a((dp39119
g2
(lp39120
VTo make code like this work in C++ you typically must provide a copy constructor for the Widget class
p39121
aVCopying objects in C++ is pretty common, it is often required if you store objects in a collection
p39122
aVIt is however a source of horrid heap corruption bugs, the default copy constructor implemented by the compiler isn't always appropriate
p39123
aVIt aliases pointers, copying the pointer value instead of the pointed-to value
p39124
aVA shallow copy instead of a deep copy
p39125
aVThat blows up badly when the destructor of the class deletes the pointed-to object, like it should, leaving the pointer in the copy pointing to garbage
p39126
aVThe C# language doesn't have this behavior, it does not implement a copy constructor
p39127
aVIt is very rarely required anyway, the garbage collector avoids the need to make copies
p39128
aVVery notable in any benchmark on collection classes
p39129
aVYou certainly can create your own copy constructor, you just have to implement it explicitly:
p39130
aVAnd create the copy explicitly as well:
p39131
aVWhich perhaps also makes it clearer that there's a non-zero cost to making those copies
p39132
aVIf you want a widget to have value behavior automatically then make it a struct, not a class
p39133
aVWhen passed without the "ref" keyboard, the runtime now automatically makes the copy
p39134
aVIt does a memberwise copy
p39135
aVIt is shallow, just like the default C++ copy constructor
p39136
aVBut without the pointer aliasing problem, the garbage collector solves that
p39137
aVBut with the shallow copy problem
p39138
aVWhich most C# programmers tackle with "I tried that before, didn't work out well
p39139
aVLet's not do that again"
p39140
aVGood advice, you shouldn't do that in C++ code either
p39141
aVIt's expensive and error prone and you better know what you're doing
p39142
aVMaybe that's trivializing the problem a bit too much
p39143
aVSorry
p39144
as(dp39145
g9
V17034
p39146
stp39147
a((dp39148
g2
(lp39149
VThe problem is in the Elapsed event handler, it checks if the mutex exists with Mutex
p39150
aVOpenExisting()
p39151
aVSure it exists
p39152
aVYou are not actually checking if it is signaled
p39153
aVThat takes calling its WaitOne(0) method
p39154
aVAlso beware that creating a form in a Timer
p39155
aVElapsed event is quite inappropriate
p39156
aVThat event runs a threadpool thread, it is not at all suitable to act as a UI thread
p39157
aVIt has the wrong COM state ([STAThread] and Thread
p39158
aVSetApartmentState), a property you cannot change on a threadpool thread
p39159
aVUse a regular Form
p39160
aVTimer instead so that the form gets created on program's UI thread
p39161
aVEdit: also beware of the inevitable race, the timer could create the User form one microsecond before the Admin form closes
p39162
aVIn other words, you'll have a User form without an Admin form, the one condition you wrote this code to prevent
p39163
aVIs that appropriate
p39164
aVTrying forms in different processes to affect each other is a bad idea
p39165
as(dp39166
g9
V17034
p39167
stp39168
a((dp39169
g2
(lp39170
VJust call AllocConsole to create your own console window
p39171
aVYou can use the normal console mode CRT functions to read and write from/to it
p39172
aVA more GUI friendly approach would be to just create a window with a multi-line readonly Edit control with a fixed-pitch font
p39173
as(dp39174
g9
V17034
p39175
stp39176
a((dp39177
g2
(lp39178
VWow, that's awesome
p39179
aVI would give my left pinkie if I knew how to turn on that option on demand
p39180
aVIt isn't C++ syntax btw, it is C++/CLI, the managed language version of C++
p39181
aVDo you have any C++/CLI code in your project
p39182
aVYou are also debugging a 64-bit program, that uses a very different debugger
p39183
aVThe debugging 'experience' is usually much better if you force the debug build of your program to run in 32-bit mode
p39184
aVProject + Properties, Build tab, Platform target = x86
p39185
aVAlso enables Edit+Continue
p39186
aVThere's a post-SP1 hotfix for the VS2008 debugger
p39187
aVIt fixes many debugger problems
p39188
as(dp39189
g9
V17034
p39190
stp39191
a((dp39192
g2
(lp39193
VThat's expensive if sX is an int (can't tell)
p39194
aVTruncate boxShiftX/Y to an int before entering the loop
p39195
as(dp39196
g9
V17034
p39197
stp39198
a((dp39199
g2
(lp39200
VI repro
p39201
aVThis DLL was built targeting
p39202
aVNET 4
p39203
ag2512
aVYou cannot use it in a project that targets anything else but the full 4
p39204
ag2512
aVNET framework
p39205
aVEither targeting a lower version or the client profile will produce this error
p39206
as(dp39207
g9
V17034
p39208
stp39209
a((dp39210
g2
(lp39211
VYou are looking for the problem at the wrong end of the wire
p39212
aVPay a visit to the dba, bring gifts, work out a way to get notified about server reboots
p39213
as(dp39214
g9
V17034
p39215
stp39216
a((dp39217
g2
(lp39218
VFire up notepad
p39219
aVexe and open the
p39220
aVsln file
p39221
aVAnd start Windows Explorer, navigate to the solution directory
p39222
aVObserve how the
p39223
aVsln file content matches the solution structure
p39224
aVEdit the entries, make the corresponding change with Explorer
p39225
aVBackup first
p39226
as(dp39227
g9
V17034
p39228
stp39229
a((dp39230
g2
(lp39231
VNo, it cannot see disabled screens
p39232
aVYou'd have to use a low-level hardware query, the kind that are supported by WMI and the System
p39233
aVManagement class
p39234
aVI'd guess at Win32_VideoController, Availability member
p39235
aVUse the WMI Code Creator tool to experiment with the query and get the code you want to use in your program
p39236
as(dp39237
g9
V17034
p39238
stp39239
a((dp39240
g2
(lp39241
VThe "execution directory" is only relevant to your process, not the csc
p39242
aVexe process
p39243
aVJust generate the full path for the assembly reference
p39244
aVEasy to do with System
p39245
aVReflection
p39246
aVAssembly
p39247
aVGetEntryAssembly()
p39248
aVLocation
p39249
as(dp39250
g9
V17034
p39251
stp39252
a((dp39253
g2
(lp39254
VMost likely because of a threading race
p39255
aVThey are very sensitive to timing and the timing in the Debug build will be different
p39256
aVYou can use a tool like CHESS to exercise bugs like that
p39257
aVBut use Tools + Attach to Process first
p39258
aVDebug + Break All, Debug + Windows + Threads and look at the thread call stacks
p39259
aVYou might be able to see the cause of the race or deadlock
p39260
as(dp39261
g9
V17034
p39262
stp39263
a((dp39264
g2
(lp39265
VIt is an oversight in the RichTextBox class
p39266
aVOther controls, like ListBox, support the BeginUpdate and EndUpdate methods to suppress painting
p39267
aVThose methods generate the WM_SETREDRAW message
p39268
aVRTB in fact supports this message, but they forgot to add the methods
p39269
aVJust add them yourself
p39270
aVProject + Add Class, paste the code shown below
p39271
aVCompile and drop the control from the top of the toolbox onto your form
p39272
aVOr P/Invoke SendMessage directly before/after you update the text
p39273
as(dp39274
g9
V17034
p39275
stp39276
a((dp39277
g2
(lp39278
VA COM server advertises the threading model it requires with a registry entry named ThreadingModel
p39279
aVSingle threaded is the default if the registry key is missing or when it is set to "Apartment"
p39280
aVRegasm
p39281
aVexe sets this key to "Both"
p39282
aVWhich means that your server is declared to be compatible with both STA threads and MTA threads
p39283
aVSomewhat in keeping with
p39284
aVNET code in general, it supports threading but with the requirement that you have to take care of thread-safety
p39285
aVChanging this is very awkward, you have to write your own registration procedure and annotate it with the [ComRegisterFunction] attribute
p39286
aVThe simple approach is leave the key set to "Both" and to check the apartment state in your class constructor
p39287
aVUse Thread
p39288
aVGetCurrentThread()
p39289
aVGetApartmentState()
p39290
aVIf you get MTA then throw an exception to tell the client that you don't support multi-threading
p39291
aVLots of
p39292
aVNET classes do this
p39293
as(dp39294
g9
V17034
p39295
stp39296
a((dp39297
g2
(lp39298
VIt is a poor choice for a file location
p39299
aVThat directory belongs to Windows, it isn't suitable for your own apps
p39300
aVFor one, you'll need admin privileges to open files in that directory
p39301
aVYou don't get that without a manifest to trigger the UAC prompt
p39302
aVFor another, that directory is virtualized on the x64 version of Windows
p39303
aVA 32-bit app trying to access files there will be redirected to c:\u005cwindows\u005csyswow64
p39304
aVI could have been more accurate if you posted the stack trace
p39305
aVBut, just don't do it
p39306
as(dp39307
g9
V17034
p39308
stp39309
a((dp39310
g2
(lp39311
VYou'll need to use TextRenderer
p39312
aVMeasureText to calculate required height of the label
p39313
aVThis should be close:
p39314
aVFrom there, set the form's ClientSize property to fit the label
p39315
as(dp39316
g9
V17034
p39317
stp39318
a((dp39319
g2
(lp39320
VThe exception won't be "unobserved" in that sample snippet
p39321
aVNot until the garbage collector gets rid of the Task instances
p39322
aVYou'd have to rewrite it like this:
p39323
aVDon't do this, use Task
p39324
aVWait()
p39325
as(dp39326
g9
V17034
p39327
stp39328
a((dp39329
g2
(lp39330
VYes, there is
p39331
aVInstead of hacking the registry, use the documented SetUserDefaultUILanguage() API function
p39332
aVFrom the remarks section of that API:
p39333
aVThe new LANGID will not take effect until the device is reset
p39334
aVCan't get around that
p39335
aVShouldn't be a problem, users don't change their native language frequently
p39336
as(dp39337
g9
V17034
p39338
stp39339
a((dp39340
g2
(lp39341
VEdit: I didn't realize it is an API function
p39342
aVYou cannot declare the function returning a structure
p39343
aVThe P/Invoke marshaller will deallocate the memory for the structure with CoTaskMemFree()
p39344
aVDoesn't work, it wasn't allocated with CoTaskMemAlloc()
p39345
aVThe heap manager in XP and 2003 is forgiving, it just ignores the faulty release request
p39346
aVBut not the one in Vista and 2008, it bombs the program because it obviously is using memory incorrectly
p39347
aVImportant because these kind of memory shenanigans are security problems
p39348
aVYes, by declaring the return type as IntPtr, you avoid the P/Invoke marshaller releasing the memory
p39349
aVWhich is appropriate, the API function really does return a pointer, not a structure
p39350
aVMarshal
p39351
aVPtrToStructure is required to marshal the pointed-to structure to a managed struct
p39352
aVThe security APIs are in general troublesome like this
p39353
aVThe notion of a security API returning a pointer into internal kernel security structure does boggle the mind a bit
p39354
as(dp39355
g9
V17034
p39356
stp39357
a((dp39358
g2
(lp39359
VYou'd have to reinstall
p39360
aVNET 1
p39361
aV1, not Visual Studio
p39362
as(dp39363
g9
V17034
p39364
stp39365
a((dp39366
g2
(lp39367
VWhat I'd like to be able to do is identify what threads are doing what
p39368
aVYou cannot make this work
p39369
aVThere are ways to enumerate the threads in a process, like the managed Process
p39370
aVThreads property or the native Thread32First/Next but you don't get nearly enough info about the threads to know what they do
p39371
aVAnd most certainly not to shut them down cleanly
p39372
aVFurther complicated by the
p39373
aVNET framework using threads for its own purposes, like the debugger thread and the finalizer thread and a smattering of threadpool threads
p39374
aVYou can kill these threads rudely with TerminateThread, albeit that killing the finalizer thread will crash the program immediately, but that's no different from rudely terminating the process with Environment
p39375
aVExit()
p39376
aVWith the caveat that nothing is cleaned-up nicely
p39377
aVWindows will clean up most of the shrapnel though
p39378
aVThis should not normally be a problem
p39379
aVYou know what threads you started, there should also be a mechanism to ask them to shut down
p39380
aVThat's normally done by signaling an event, something that's tested in thread's main loop
p39381
aVWaiting on the thread handle confirms that the thread indeed exited
p39382
aVAfter which you can close the windows
p39383
aVBut that's probably plumbing that's missing, you'll have to add it
p39384
aVIf the current native C++ code has no mechanism to take care of thread shutdown then you've got a fairly big problem
p39385
aVI'll guess that maintaining this native C++ code is the real problem
p39386
aVYou may have to hire a gun to get this done
p39387
as(dp39388
g9
V17034
p39389
stp39390
a((dp39391
g2
(lp39392
VWell, technically an out-of-process server fits the bill, uses pipes and rpc
p39393
aVBut this is going to give you a headache (rearranging the verbiage):
p39394
aVBut if the semantics of the communication are intimate enough, exchanging complex internal data structures
p39395
aVThis is a legal question, which ultimately judges will decide
p39396
aVWithout defining what "intimate enough" means
p39397
aVReminds me of supreme justice's remark: "I can't define porn, but I know it when I see it
p39398
aVThat ought to be relatively cheap, asking an opinion about intimate software interfaces is going to be a lot more expensive
p39399
aVIf you use it, make sure you won't ever be wildly successful
p39400
as(dp39401
g9
V17034
p39402
stp39403
a((dp39404
g2
(lp39405
VThis is a bug introduced by the Vista version of the native TreeView control
p39406
aVIt responds to a double-click by automatically toggling a check box
p39407
aVBut without raising the BeforeCheck and AfterCheck events
p39408
aVThe Windows Forms TreeView class wrapper wasn't updated to deal with this problem
p39409
aVThe fix is simple enough, you need to prevent the native control from seeing the double-click
p39410
aVAdd a new class to your project and paste the code shown below
p39411
aVCompile
p39412
aVDrop the new control from the top of the toolbox onto your form, replacing the existing tree view
p39413
as(dp39414
g9
V17034
p39415
stp39416
a((dp39417
g2
(lp39418
VUse can use the token pasting operator, like this:
p39419
as(dp39420
g9
V17034
p39421
stp39422
a((dp39423
g2
(lp39424
VUse the [Category] attribute to group properties so that the user can click the "Categorized" icon in the Properties window to arrange them
p39425
aVWithin a category, the names will still be sorted alphabetically
p39426
aVThe PropertyGrid
p39427
aVPropertySort property does have a setting for it (PropertySort
p39428
aVCategorized vs PropertySort
p39429
aVCategorizedAlphabetical) but the IDE's Properties window doesn't have an icon to choose between them
p39430
as(dp39431
g9
V17034
p39432
stp39433
a((dp39434
g2
(lp39435
VVisit pinvoke
p39436
aVnet for these declarations
p39437
aVOr use the PInvoke Interop Assistant
p39438
as(dp39439
g9
V17034
p39440
stp39441
a((dp39442
g2
(lp39443
VIt is an option
p39444
aVTools + Options, Text Editor, C#, Formatting, "Automatically format on paste" check box
p39445
as(dp39446
g9
V17034
p39447
stp39448
a((dp39449
g2
(lp39450
VIt is clearly stated in the MSDN Library article for svcutil
p39451
aVexe:
p39452
aVValues: c#, cs, csharp, vb,
p39453
aVvisualbasic, c++, cpp
p39454
aVDefault: csharp
p39455
aVShort form: /l
p39456
aVNote:   The switch only supports C++
p39457
aVfor the code provider that ships with
p39458
aVVisual Studio 2005 SP1
p39459
aVI think that came with the
p39460
aVNET 2
p39461
aV0 SDK back then
p39462
aVNot otherwise a problem, the language hasn't changed since then
p39463
aVWhy not use csharp
p39464
aVBeing able to painlessly mix languages in
p39465
aVNET is one of its great assets
p39466
as(dp39467
g9
V17034
p39468
stp39469
a((dp39470
g2
(lp39471
VJust the INT jumps out as trouble
p39472
aVThat's a macro, you'd need like  to define it
p39473
aVIt is very unlikely to be anything else but a regular int
p39474
aVThe "extern" is superfluous, any compiler would ignore it
p39475
as(dp39476
g9
V17034
p39477
stp39478
a((dp39479
g2
(lp39480
VThe first line doesn't do anything
p39481
aVI imagine what you really want to do is create an Offer, not a ListViewItem:
p39482
aVThen when you need to retrieve an item from the ListView, cast it back to an Offer:
p39483
as(dp39484
g9
V17034
p39485
stp39486
a((dp39487
g2
(lp39488
VThe decision is made when your
p39489
aVexe is loaded
p39490
aVThe 32BIT flag in the assembly metadata header will determine whether the 32-bit or the 64-bit of the CLR is loaded
p39491
aVAnd, most significantly, the x86 or the x64 JIT compiler
p39492
aVAfter that, the JIT compiler generates the proper flavor of machine code, regardless of the bitness of any of the DLLs that are loaded afterward
p39493
aVThus, only the target platform setting for the EXE matters
p39494
as(dp39495
g9
V17034
p39496
stp39497
a((dp39498
g2
(lp39499
VMemory
p39500
aVIt can be cached, that's the job of ngen
p39501
aVexe
p39502
aVIt generates a
p39503
aVni
p39504
aVdll version of the assembly, containing machine code and stored in the GAC
p39505
aVWhich automatically gets loaded afterward, bypassing the JIT step
p39506
aVBut that has little to do with why your program starts faster the 2nd time
p39507
aVThe 1st time you have a so-called "cold start"
p39508
aVWhich is completely dominated by the time spent on finding the DLLs on the hard drive
p39509
aVThe second time you've got a warm start, the DLLs are already available in the file system cache
p39510
aVDisks are slow
p39511
aVAn SSD is an obvious fix
p39512
aVFwiw: this is not a problem that's exclusive to managed code
p39513
aVLarge unmanaged programs with lots of DLLs have it too
p39514
aVTwo canonical examples, present on most dev machines are Microsoft Office and Acrobat Reader
p39515
aVThey cheat
p39516
aVWhen installed, they put an "optimizer" in the Run registry key or the Startup folder
p39517
aVAll that these optimizers do is load all the DLLs that the main program uses, then exit
p39518
aVThis primes the file system cache, when the user subsequently uses the program, it will start up quickly since its warm start is fast
p39519
aVPersonally, I find this extraordinarily annoying
p39520
aVBecause what they really do is slow down any other program that I may want to start after logging in
p39521
aVWhich is rarely Office or Acrobat
p39522
aVI make it a point to delete these optimizers, repeatedly if necessary when a blasted update puts it back
p39523
aVYou can use this trick too, but use it responsibly please
p39524
as(dp39525
g9
V17034
p39526
stp39527
a((dp39528
g2
(lp39529
VThe custom setup options are not nearly fine-grained enough to allow you to leave the big chunks like the IDE out
p39530
aVIt isn't just the SDK that's used, at least the VC subdirectory needs to be there
p39531
aVAnd bits of Common7, also the folder that contains the IDE
p39532
aVRename the folders, delete them later if it works out
p39533
as(dp39534
g9
V17034
p39535
stp39536
a((dp39537
g2
(lp39538
VNot quite sure what you mean, OpenFileDialog is a
p39539
aVNET class
p39540
aVAssuming native: you can set the OPENFILENAME
p39541
aVlpfnHook member to a callback function
p39542
aVThat gives you notifications like CDN_FILEOK and CDN_FOLDERCHANGE
p39543
aVGives you a preview of what was selected before the dialog closes and a way to cancel it
p39544
as(dp39545
g9
V17034
p39546
stp39547
a((dp39548
g2
(lp39549
VYou'll need a smarter parser
p39550
aVWhen you see an expression whose value isn't being used then you need to emit a POP
p39551
as(dp39552
g9
V17034
p39553
stp39554
a((dp39555
g2
(lp39556
VThis problem becomes trivial if you do it the other way around
p39557
aVHave the UI thread read whatever values are required, then let it start the thread, passing those values
p39558
aVThreadPool
p39559
aVQueueUserWorkItem is ideal for this
p39560
as(dp39561
g9
V17034
p39562
stp39563
a((dp39564
g2
(lp39565
VYou don't need a BGW if you use the OnPacketArrival event
p39566
aVMakes it easy to stop, just call StopCapture()
p39567
aVThe other way, GetNextPacket() does need a BGW
p39568
aVYou have to open the device with a read timeout that short enough so you can see the CancellationPending flag quick enough
p39569
aVYou'll also have to deal with the overhead of getting it displayed on your UI, ReportProgress is not cheap
p39570
aVAnd freezes the UI when you call it more often than ~1000 times per second
p39571
aVI wonder if we're talking about the same library
p39572
as(dp39573
g9
V17034
p39574
stp39575
a((dp39576
g2
(lp39577
s(dp39578
g9
V17034
p39579
stp39580
a((dp39581
g2
(lp39582
VUse
p39583
aVRight-click your project, Add Reference, select
p39584
as(dp39585
g9
V17034
p39586
stp39587
a((dp39588
g2
(lp39589
VImagine the uproar that would cause
p39590
aV"But the compiler can figure out an expression should be evaluated as long, why can't the runtime do it
p39591
aVAnd that's not going to happen, way too expensive
p39592
aVIt is essential that the compiler evaluates expressions the same way as the runtime
p39593
aVIf that wasn't the case, editing a constant expression and replacing a constant with a variable could suddenly cause runtime failure
p39594
aVHard to diagnose failure at that, non-constant expressions are unchecked by default
p39595
as(dp39596
g9
V17034
p39597
stp39598
a((dp39599
g2
(lp39600
VThe
p39601
aVNET framework version numbering got to be a mess after 2
p39602
ag2512
aVAn assembly does not target a
p39603
aVNET framework version, it targets a CLR version
p39604
aVAnd the CLR version for framework versions 2
p39605
aV0, 3
p39606
aV0, and 3
p39607
aV5 was the same, 2
p39608
ag2512
aV50727
p39609
aVWhich is why it looked like you could mix versions in VS2008
p39610
aVBut you were seeing the [AssemblyVersion] of an assembly, which has nothing to do with the CLR version
p39611
aVUnfortuntely, the CLR version isn't visible in the Properties window, you'd have to run Ildasm
p39612
aVexe to see it in the metadata
p39613
aVBut you can safely assume that any assembly version between 2
p39614
ag2512
ag2512
aV0 and 3
p39615
ag2447
ag2512
aV0 targets CLR version 2
p39616
ag2512
aV50727
p39617
aVThat ended with
p39618
aVNET 4
p39619
aV0, it got a new CLR version, 4
p39620
ag2512
aV30319
p39621
aVWhat the MSDN blurb is telling you that when you target CLR version 2
p39622
aV0 then you cannot use assemblies that target 4
p39623
ag2512
aVThe version 2
p39624
aV0 CLR doesn't know how to read the metadata of a
p39625
aVNET 4
p39626
aV0 assembly, the format was changed
p39627
aVThe only workaround is to force the EXE to load the 4
p39628
aV0 version of the CLR, even though it asks for 2
p39629
ag2512
aV50727
p39630
aVYou do that with an app
p39631
aVexe
p39632
aVconfig file, it should look like this:
p39633
aVAnd a bit of testing that it still works correctly, Microsoft used v4
p39634
aV0 to fix several old bugs in 2
p39635
aV0 that couldn't easily be fixed without taking the risk to break old code that relied on the buggy behavior
p39636
as(dp39637
g9
V17034
p39638
stp39639
a((dp39640
g2
(lp39641
VNo, the DLR Codeplex source is not what's in the
p39642
aVNET 4
p39643
aV0 framework
p39644
aVNot directly anyway
p39645
aVI'm seeing big chunks of it back in the System
p39646
aVCore
p39647
aVdll assembly, System
p39648
aVDynamic namespace
p39649
aVTo what degree that moved code is identical to the DLR source is hard to guestimate
p39650
aVIt looks identical at a cursory glance but you'd need a fine-toothed comb to be sure
p39651
aVThe 4
p39652
aV0 source code is available from the Reference Source, just not in a format that makes it easy to run a diff on the source code files
p39653
aVA spot-check on ExpandoClass
p39654
aVcs shows they are very nearly identical with just an added (unnecessary) using directive in the 4
p39655
aV0 version
p39656
aVGiven the amount of work done on the DLR previously, I would estimate the changes to be relatively minor
p39657
aVNote that there is an intermediary layer between the calls generated by the compiler and the DLR
p39658
aVIt goes through the classes in the Microsoft
p39659
aVCSharp
p39660
aVdll assembly first, the binder for the C# language
p39661
aVExactly where that binder ends and the DLR begins is very hard to reverse engineer
p39662
aVThe binder code is not easy to read and does a lot of work
p39663
aVCalls to methods in the System
p39664
aVDynamic namespace are interwoven
p39665
aVAnd its source code is not available from the Reference Source
p39666
aVGiven the amount of code in the binder, my answer to your question "are all operations on the dynamic type dispatched to the DLR" would be: no, probably not all of them
p39667
as(dp39668
g9
V17034
p39669
stp39670
a((dp39671
g2
(lp39672
VYes, recreating a bitmap in code that runs while painting is usually far too expensive and slows down the painting too much
p39673
aVKeeping a copy of the bitmap solves the speed problem, at the expensive of needing more memory
p39674
aVNote that the standard Control
p39675
aVBackgroundImage property is available for this, consider using it
p39676
aVYou just need to add the code that updates that property (and calls Invalidate) when the conditions change that require a different background image
p39677
aVDrawing is automatic
p39678
aVSecondary efficiency considerations are pre-scaling the bitmap to exactly fit the control's ClientSize, avoids having to rescale the bitmap at painting time
p39679
aVBig savings there, especially when the bitmap is large
p39680
aVBut requires overriding the OnResize method so you can re-generate the scaled bitmap
p39681
aVWhen that slows down the painting too much while resizing the form then you need to wire the form's ResizeEnd event
p39682
aVAnd creating the bitmap in the Format32bppPArgb pixel format, it draws about 10 times faster on most video adapters compared to any other format
p39683
as(dp39684
g9
V17034
p39685
stp39686
a((dp39687
g2
(lp39688
VIt is a K&R; legacy
p39689
aVFixing it would break a million programs
p39690
as(dp39691
g9
V17034
p39692
stp39693
a((dp39694
g2
(lp39695
VYour form's Paint event will run
p39696
aVThat doesn't mean all windows will be fully painted, but you can sleep less
p39697
aVListening for the notification message by overriding WndProc() may work, not sure when it is sent
p39698
aVWM_DWMCOMPOSITIONCHANGED is message 0x31e
p39699
aVI suspect it will be sent too soon, all windows probably have to repaint themselves next
p39700
aVThe only way to be sure is to enumerate the windows with EnumWindows and call UpdateWindow
p39701
aVVisit pinvoke
p39702
aVnet for the P/Invoke declarations you'll need
p39703
aVSleep() will work too but there's no way to guess an amount that's guaranteed to work everywhere
p39704
as(dp39705
g9
V17034
p39706
stp39707
a((dp39708
g2
(lp39709
VThe problem is a combination of FileMode
p39710
aVOpenOrCreate and the type of the ViewerRecord members
p39711
aVOne or more of them isn't of a fixed size type, probably a string
p39712
aVThings go wrong when the file already exists
p39713
aVYou'll start writing data at the start of the file, overwriting existing data
p39714
aVBut what you write only overwrites an existing record by chance, the string would have to be the exact same size
p39715
aVIf you don't write enough records then you won't overwrite all of the old records
p39716
aVAnd get into trouble when you read the file, you'll read part of an old record after you've read the last written record
p39717
aVYou'll get junk for a while
p39718
aVMaking the record a fixed size doesn't really solve the problem, you'll read a good record but it will be an old one
p39719
aVWhich particular set of old records you'll get depends on how much new data you wrote
p39720
aVThis should be just as bad as reading garbled data
p39721
aVIf you really do need to preserve the old records then you should append to the file, FileMode
p39722
aVAppend
p39723
aVIf you don't then you should rewrite the file, FileMode
p39724
aVCreate
p39725
as(dp39726
g9
V17034
p39727
stp39728
a((dp39729
g2
(lp39730
VThey are the same
p39731
aVSimilar to "unsigned" and "unsigned int"
p39732
aVYes, in C++ there's an overload for abs() that takes a long argument
p39733
aVlabs() is necessary for C programmers, they can only use the abs() function that takes an int
p39734
aVThe C language doesn't support function overloading
p39735
as(dp39736
g9
V17034
p39737
stp39738
a((dp39739
g2
(lp39740
VYes, the C++/CLI compiler makes this easy to do
p39741
aVIt automatically generates a "thunk" that ensures that the CLR gets loaded when an unmanaged program calls an exported function
p39742
aVBest demonstrated with an example
p39743
aVStarting with the C# code, create a new project from the Class Library project template
p39744
aVYou'll have to write a static method, necessary because C code doesn't know anything about classes
p39745
aVHere's a simple example:
p39746
aVRight-click the solution name in the Solution Explorer window, Add + New Project
p39747
aVSelect Visual C++, CLR, Class Library
p39748
aVRight-click the new project, Properties, Common Properties, Framework and References, click Add New Reference
p39749
aVProjects tab, select your C# project
p39750
aVOpen the
p39751
aVcpp file and write code like this:
p39752
aVBuild
p39753
aVThis DLL can now be used by your unmanaged code, it can call the "method" function
p39754
aVBoth this DLL and your C# DLL need to be copied to the directory of the unmanaged program
p39755
aVBeware that there's overhead in calling this method
p39756
aVThe thunk that the C++/CLI compiler generates does a fair amount of work to ensure that the CLR is loaded and initialized
p39757
aVDebugging is going to be unfun (use Debugger
p39758
aVBreak()) and uncaught managed exceptions will crash your program with a very poor diagnostic
p39759
as(dp39760
g9
V17034
p39761
stp39762
a((dp39763
g2
(lp39764
VYes, which means that no matter what syntax sugar you use, the conversion is going to require O(n) time and O(n) storage
p39765
aVYou cannot cast the list to avoid re-creating it
p39766
aVIf that was possible, client code could add an element of BaseT1 to the list, violating the promise that list only contains objects that are compatible with T1
p39767
aVThe only way to get ahead is to return an interface type that cannot change the list
p39768
aVWhich would be  in this case
p39769
aVAllowing you to iterate the list, nothing else
p39770
aVThat conversion is automatic in
p39771
aVNET 4
p39772
aV0 thanks to its support for covariance
p39773
aVYou'll have to write a little glue code in earlier versions:
p39774
as(dp39775
g9
V17034
p39776
stp39777
a((dp39778
g2
(lp39779
VThat's not a TreeView, it's a ListView with View = LargeIcons
p39780
aVTreeView isn't a great control as a drop target since it hides sub-nodes
p39781
aVBut you can solve both problems by implementing the DragOver event
p39782
aVTest where the mouse is at and expand and select the node:
p39783
as(dp39784
g9
V17034
p39785
stp39786
a((dp39787
g2
(lp39788
VI'm going to guess you are using a debugging tool that let's you take a look at the managed heap
p39789
aVLike Windbug
p39790
aVexe with sos
p39791
aVdll
p39792
aVYes, you'll see an instance of the Functions class object after the final Release() call
p39793
aVIt is a managed object that follows normal garbage collection rules
p39794
aVIt won't be collected until the garbage collector runs
p39795
aVIt will be, as long as you keep running managed code that allocates memory
p39796
as(dp39797
g9
V17034
p39798
stp39799
a((dp39800
g2
(lp39801
VBecause the C# language specification says so
p39802
aVChapter 13
p39803
ag2588
aV7:
p39804
aVLike a non-abstract class, an abstract class must provide implementations of all members of the interfaces that are listed in the base class list of the class
p39805
aVWhy the C# designers chose to specify the language like this is probably best answered by Eric Lippert
p39806
aVI'd personally guess at reducing the odds that unintended method hiding occurs, producing error messages that are very hard to interpret
p39807
aVI would personally have been more comfortable requiring the use of the overrides keyword for the interface method implementation
p39808
aVBut they chose not to
p39809
as(dp39810
g9
V17034
p39811
stp39812
a((dp39813
g2
(lp39814
VThe string is surrounded by double quotes
p39815
aVYes, that's not a valid character in a path
p39816
aVYou should probably tackle it at the source, but you can strip them out with:
p39817
as(dp39818
g9
V17034
p39819
stp39820
a((dp39821
g2
(lp39822
VAlways document the error message you get
p39823
aVBeing forced to guess: if you get an error in line #82, complaining about an invalid character (0x2e), then open the file in a text editor, put the cursor after the
p39824
aVand press Enter so the line is terminated with a line feed
p39825
as(dp39826
g9
V17034
p39827
stp39828
a((dp39829
g2
(lp39830
VYou need to use CopyPixelOperation
p39831
aVSourceCopy | CopyPixelOperation
p39832
aVCaptureBlt to also capture layered windows
p39833
aVUnfortunately this doesn't work, they fumbled the argument validation code
p39834
aVThe unhappy alternative is to P/Invoke the required code
p39835
aVHere's a sample form that does that:
p39836
as(dp39837
g9
V17034
p39838
stp39839
a((dp39840
g2
(lp39841
VUnless you are planning to use your app on the Space Shuttle, I cannot come up with a good reason to burn a resource as expensive as a thread on this task
p39842
aVA Windows Forms Timer is fine
p39843
aVDo reduce the Interval to, say, a second as long as you haven't received a good measurement so the user won't have to wait so long
p39844
aVOnce you do, increase the Interval
p39845
aVAlthough I doubt it makes much difference
p39846
as(dp39847
g9
V17034
p39848
stp39849
a((dp39850
g2
(lp39851
VSounds to me like you are talking about a callback function
p39852
aVA function pointer:
p39853
as(dp39854
g9
V17034
p39855
stp39856
a((dp39857
g2
(lp39858
VThe question is very unclear, it isn't obvious to me how the getter and the snippet below it are related
p39859
aVBut yes, property accessors are normally heavily optimized
p39860
aVNot by the C# compiler, by the JIT compiler
p39861
aVFor one, they are often inlined so you don't pay for the cost of a method call
p39862
aVThat will only happen if the getter doesn't contain too much code and doesn't monkey with locks and exception handling
p39863
aVYou can help the JIT compiler to optimize the common case with code like this:
p39864
aVThis will inline the common case and allow the creation method to remain un-inlined
p39865
aVThis gets typically compiled to three machine code instructions in the Release build (load + test + jump), about a nano-second of execution time
p39866
aVIt is a micro-optimization, seeing an actual perf improvement would be quite rare
p39867
aVDo note that the given sample code is not thread-safe
p39868
aVAlways write correct code rather than fast code first
p39869
as(dp39870
g9
V17034
p39871
stp39872
a((dp39873
g2
(lp39874
VThe SerialPort class is a very thin wrapper around the Win32 serial port API, hard to see how another wrapper could improve your life
p39875
aVThere are wrappers available from the
p39876
aVNET 1
p39877
aVx days, it didn't support serial ports
p39878
aVHere is one from MSDN magazine
p39879
aVBut you're just as likely to have the same problems
p39880
aVOne way that written commands could get lost is by the device throwing away received bytes (or losing them) when it has turned off the RTS signal off
p39881
aVYou fix that by setting the Handshake property to RequestToSend
p39882
aVOne way that things can go wrong with reading commands is to get the Read() call wrong
p39883
aVIt will return an arbitrary number of bytes, as many as are available in the receive buffer
p39884
aVPay attention to the return value, it tells you how many bytes were actually read
p39885
aVThe only guarantee is that it will at least be 1 and never more than count
p39886
aVThe SysInternals' PortMon utility can help you troubleshoot communications, it gives you a raw view of what the device driver sees
p39887
aVCompare with, say, Hyperterminal or another known-good program
p39888
as(dp39889
g9
V17034
p39890
stp39891
a((dp39892
g2
(lp39893
VLambda expression, C# version 3 feature
p39894
aVDon't use this code
p39895
aVA message box needs a parent window, something it can make sure to be on top of
p39896
aVIt can normally find a parent by itself by iterating the windows that were created on the same thread
p39897
aVNot in this case though, there are no other windows, it has to pick the desktop window as the parent
p39898
aVThat will go wrong badly when the user is working in an app window or switches focus to another app, the message box disappears behind the foreground window
p39899
aVThere is no obvious way for the user to tell that it is there, she'll just loses sight of it
p39900
aVIt could be hours, if not days, before she finds it back
p39901
aVThat thread is meanwhile consuming resources badly, you would probably never consider it if you knew that this message box requires a megabyte of memory
p39902
aVIn extreme cases, you'll crash the program with OOM
p39903
aVThe common alternative in Windows UI programming is a balloon tooltip provided by a NotifyIcon
p39904
aVOr your own form with the TopMost property set to True so it cannot easily get lost
p39905
aVAlso allows you to control the position, important for "non-modal" notifications that should not get in the way
p39906
aVSet that form's ShowWithoutActivation property to true in the form constructor so it doesn't steal the focus
p39907
as(dp39908
g9
V17034
p39909
stp39910
a((dp39911
g2
(lp39912
VUse TryParseExact()
p39913
aVFollowed by DateTime
p39914
aVToString() to convert
p39915
aVFor example:
p39916
aVTest case:
p39917
as(dp39918
g9
V17034
p39919
stp39920
a((dp39921
g2
(lp39922
VMinidump debugging was supposed to be majorly improved in VS2010
p39923
aVHaven't seen a lot of evidence for it myself yet, mixed-mode debugging looks as awkward as it was before when I did some quick tests
p39924
aVDon't take my word for it though
p39925
aVNative-only is however never going to show you a managed call stack
p39926
aVTackle this at the source
p39927
aVWrite an event handler for AppDomain
p39928
aVCurrentDomain
p39929
aVUnhandledException and register it in your Main() method
p39930
aVLet it display the value of e
p39931
aVExceptionObject
p39932
aVToString() in, say, a message box
p39933
aVThat gets you the managed stack trace of the exception
p39934
aVWhile that message box is displayed you could also snap the minidump, ought to get you closer to the crash location
p39935
aVThe particular exception you are getting is however definitely pointing to native C/C++ code
p39936
aVA buffer overflow that is corrupting the stack
p39937
aVMake sure you have the
p39938
aVpdb files for any native code your app uses
p39939
aVAnd setup the Microsoft symbol server so you get a good native stack trace from the minidump
p39940
aVEdit: the fact that you don't get UnhandledException raised definitely points to stack integrity checking in the CRT
p39941
aVIt was designed to not raise an exception but terminate the program immediately
p39942
aVNecessary behavior because the stack is compromised, the code cannot assume that it can be unwound safely
p39943
aVGiven the crash location, it is likely that this check is actually done in the CLR code
p39944
aVI know this wasn't done in previous CLR versions but that might be different in the CLR version included with
p39945
aVNET 4
p39946
ag2512
aVThis is going to make it quite difficult to get a managed stack trace
p39947
aVThere's a lot you can reverse-engineer from the unmanaged stack trace, as long as you setup the symbol server so that you'll get identifier names from the CLR stack frames
p39948
aVPost that stack trace in your question if you want help interpreting it
p39949
aVA bug in the CLR code is not unlikely btw, you may want to consider calling Microsoft Support
p39950
aVThey will however need a consistent repro
p39951
aVThey may make do with that all important stack trace if the repro is hard to come by
p39952
aVSetup the symbol server to get a good unmanaged stack trace
p39953
aVEasy in VS2010: Tools + Options, Debugging, Symbols, tick "Microsoft Symbol Servers"
p39954
as(dp39955
g9
V17034
p39956
stp39957
a((dp39958
g2
(lp39959
VThe Beep function was wrapped by QBasic's Play command
p39960
aVLots of Google hits on that one, this was the top selection
p39961
aVWriting the code to translate the Play string could make this a bit more interesting than copy-paste
p39962
aVThe syntax is described here
p39963
as(dp39964
g9
V17034
p39965
stp39966
a((dp39967
g2
(lp39968
VThe C# language syntax hides it, but a key properly of an interface method implementation is that it is a virtual method
p39969
aVIt is hidden, you don't actually use the virtual (or overrides) keyword when you write the implementation method
p39970
aVIt has to be virtual, that's how interfaces are implemented under the hood
p39971
aVWhen you cast an object to an interface type, the runtime generates a pointer to the virtual method table section that contains the pointers to the interface method implementations
p39972
aVWhat follows, given that virtual methods are the polar opposite of static methods, is that an interface declaration can never contain a static method
p39973
aVStatic methods don't have method table entries
p39974
as(dp39975
g9
V17034
p39976
stp39977
a((dp39978
g2
(lp39979
VThe Lines property is what you want to use
p39980
aVParsing the Text property yourself requires more code and doesn't make it faster
p39981
aVWrite a better question if you have a reason to look for an alternative
p39982
as(dp39983
g9
V17034
p39984
stp39985
a((dp39986
g2
(lp39987
VYou should override OnProcessCmdKey() instead
p39988
aVIt runs early, ensuring that no control could steal the keystroke
p39989
as(dp39990
g9
V17034
p39991
stp39992
a((dp39993
g2
(lp39994
VMSDN library links notoriously change constantly
p39995
aVThere's little reason to believe that this will stop happening, it is likely that the comment in the link will go dead
p39996
aVFrankly, documenting framework classes in your source code is not very useful
p39997
aVAny
p39998
aVNET programmer knows how to look them up
p39999
as(dp40000
g9
V17034
p40001
stp40002
a((dp40003
g2
(lp40004
VNot your problem, it is a bug in the build system
p40005
aVThe dlldata
p40006
aVc file doesn't get deleted using a regular build either
p40007
aVThere aren't enough diagnostics available in the msbuild
p40008
aVlog files to see what target fumbles this
p40009
aVI'm guessing it has something to do with the  item in the Microsoft
p40010
aVCppClean
p40011
aVtargets file
p40012
aVI recommend you report this problem at connect
p40013
aVmicrosoft
p40014
aVcom
p40015
as(dp40016
g9
V17034
p40017
stp40018
a((dp40019
g2
(lp40020
VYes, that's a problem
p40021
aVAt issue is that the code is executing in Visual Studio, not your app
p40022
aVThe probing path that's used to find dependent assemblies will only include private directories of VS (Common7\u005cIDE\u005cPrivateAssemblies and PublicAssemblies), not the build directory of your project
p40023
aVYou can make it find OCShell
p40024
aVdll by copying it into one of those directories, but the unmanaged DLL is going to have to be put in a directory that Window will search when looking for DLLs
p40025
aVWhich, other than the Windows side-by-side cache which requires a manifest, is limited to a directory on the system PATH environment variable
p40026
aVThese are not pleasant options
p40027
aVThe best thing to do is to ensure that the code in these DLLs cannot execute at design time
p40028
aVYou do so by using the DesignMode property, bypass calls if it is True
p40029
aVThat needs to be done in at least the constructor and the Load event
p40030
aVOther events can run as well
p40031
aVAlso greatly minimizes the odds that you'll crash Visual Studio because of a bug in the unmanaged code
p40032
aVIf this impacts the design-time view of the control then you may need to write a designer to make up for that
p40033
as(dp40034
g9
V17034
p40035
stp40036
a((dp40037
g2
(lp40038
VWell, it is okay but it is not going to work well in practice
p40039
aVPictureBox is a window, when snakes overlap each other, you'll obscure part of them with a rectangle
p40040
aVYou'll essentially see one snake in a rectangle with bits of other snakes peeking out past that rectangle
p40041
aVUse the form's Paint event to draw the snakes, don't use a control
p40042
as(dp40043
g9
V17034
p40044
stp40045
a((dp40046
g2
(lp40047
VYou're close, but you have probably used the 64-bit version of the ODBC administrator to configure the DSNs
p40048
aVThe DSN configuration is stored in the registry and 32-bit and 64-bit processes have different views of the registry
p40049
aVRun c:\u005cwindows\u005csyswow64\u005codbcad32
p40050
aVexe instead
p40051
aVI think
p40052
aVAsk more questions about it at serverfault
p40053
aVcom
p40054
as(dp40055
g9
V17034
p40056
stp40057
a((dp40058
g2
(lp40059
VThe expression &this; has no meaning when the structure is present in unmanaged memory
p40060
aVThere is no way to allocate it there
p40061
aVA key property of managed structures is that their memory layout is not discoverable and is not compatible with the unmanaged view of that structure
p40062
aVThe CLR rearranges fields as it sees fit to get the minimum size while aligning members
p40063
aVIt will in fact swap fields if a later one can fit in the padding
p40064
aVYou cannot get past Marshal
p40065
aVPtrToStructure to convert an unmanaged struct to its managed version
p40066
aVMarshal
p40067
aVSizeOf is only accurate for the unmanaged layout
p40068
as(dp40069
g9
V17034
p40070
stp40071
a((dp40072
g2
(lp40073
VUse the "zzz" format specifier to get the UTC offset
p40074
aVFor example:
p40075
aVOutput:
p40076
aV2009-12-31 19:01:01 GMT-06:00
p40077
aVI'm in the CDT timezone
p40078
aVMake sure the DateTime is unambiguously DateTimeKind
p40079
aVUtc
p40080
aVAvoid "GMT", it is ambiguous for daylight saving
p40081
as(dp40082
g9
V17034
p40083
stp40084
a((dp40085
g2
(lp40086
VYou can't
p40087
aVThe only other way to run elevated without the user's consent is as a scheduled task
p40088
as(dp40089
g9
V17034
p40090
stp40091
a((dp40092
g2
(lp40093
VThis is a sad moment in most any usability study, seeing the subject banging away at the mouse and keyboard and not understanding why it doesn't work
p40094
aVBut you can get it if you really want to
p40095
aVThe trick is to put a picture box in front of the control that shows a bitmap of the controls in their previously enabled state
p40096
aVThey'll never figure out they are clicking on a bitmap instead of the actual controls
p40097
aVBest done with a Panel so you can easily disable controls as a group
p40098
aVAdd a new class to your project and paste the code shown below
p40099
aVCompile
p40100
aVDrop the new control from the top of the toolbox onto your form
p40101
aVAnd put the controls inside it that should be disabled
p40102
aVEverything else is automatic, just set the Enabled property to false and the user won't know what happened:
p40103
as(dp40104
g9
V17034
p40105
stp40106
a((dp40107
g2
(lp40108
VYes, this is a known Windows security concern, known as a "handle recycle attack"
p40109
aVIt is technically possible to walk the undocumented kernel handle table, inject code in the process that owns the handle and call CloseHandle() to close the file handle
p40110
aVVery hard to exploit, you need admin rights to do this
p40111
aVMuch better ways to screw up a process if you have that right
p40112
aVWhat results is more of a Denial Of Service attack, one that randomly fecks up the machine with no way to find out how it happened
p40113
aVThe process is not aware that the file handle was closed, it didn't close it, and just keeps writing to the handle
p40114
aVThe written data falls into the bit bucket
p40115
aVIgnoring the return value of WriteFile() is pretty standard in most unmanaged programs
p40116
aVUntil the process opens another handle to write to, say, a database
p40117
aVHandles are recycled, it can get the same handle value back
p40118
aVNow the process is writing the normal database data, intermixed with the data that was supposed to go in the now-closed file
p40119
aVHilarity ensues when anybody tries to read the data back from that database
p40120
aVOr whatever other resource got destroyed, it's random
p40121
aVYou are kinda covered though, nobody will be able to figure out that it was your program that destroyed the machine
p40122
as(dp40123
g9
V17034
p40124
stp40125
a((dp40126
g2
(lp40127
VThe files that you are legally entitled to redistribute are listed in the redist
p40128
aVtxt file in your Visual Studio install directory
p40129
aVYes, the
p40130
aVNET installers, like dotNetFx35setup
p40131
aVexe are included in that list
p40132
aVYou could perhaps send a copy of that file to your client
p40133
aVIt's not a true installer, it is a bootstrapper that downloads the actual bits from a Microsoft server
p40134
aVWhich is a wise approach, you definitely don't want to distribute a version that predates the last security update
p40135
aVDoesn't happen often, but there was one for 3
p40136
aV5 SP1 just two months ago
p40137
aVClients do not like getting stuff installed that has documented security issues
p40138
aVFrankly, including anything in your installer that includes
p40139
aVNET bits is starting to make less and less sense
p40140
aVEspecially for
p40141
aVNET 4
p40142
ag2512
aVIt is small, ~55 MB vs ~350 MB for
p40143
aVNET 3
p40144
aV5 SP1
p40145
aVBy virtue of its prerequisites, it requires a recent Windows service pack
p40146
aVXP SP3 for example
p40147
aVYou definitely don't want to get in the business of distributing Windows service packs
p40148
aVState your software's prerequisites clearly, requiring
p40149
aVNET to be pre-installed is defensible, just as requiring a minimum Windows version and SP level
p40150
aVEspecially with a client that hassles you
p40151
as(dp40152
g9
V17034
p40153
stp40154
a((dp40155
g2
(lp40156
VYes, IsWow64Process is annoyingly useless
p40157
aVIt really means "is 32-bit emulation enabled" and that returns false if you run on a 32-bit operating system, it doesn't need any emulation
p40158
aVYou'll only get a good value out of it if you know for a fact that you're running on a 64-bit operating system
p40159
aVWhich is tricky to find out
p40160
aVThe IntPtr
p40161
aVSize == 8 test proofs that you run 64-bit, but it doesn't proof that it is definitely not a 64-bit operating system
p40162
aVThe 64-bit version of the framework might not have been installed
p40163
aVOr your code might be running from an
p40164
aVexe that had the Platform Target forced to x86
p40165
aVWhich is not uncommon for code that's interested in bitness
p40166
aVYou'll need to P/Invoke GetNativeSystemInfo()
p40167
aVIf that throws (or GetProcAddress returns IntPtr
p40168
aVZero), you know for a fact that it is a 32-bit operating system
p40169
aVIf it doesn't, inspect the value of SYSTEM_INFO
p40170
aVwProcessorArchitecture
p40171
aVIt will be 9 for x64, 6 for Titanium, 0 for x86
p40172
aVSo if you get 9, then use IsWow64Process
p40173
aVVisit pinvoke
p40174
aVnet for the declarations
p40175
aVNote that the new
p40176
aVNET 4
p40177
aV0 Environment
p40178
aVIs64BitOperatingSystem is flawed the same way
p40179
as(dp40180
g9
V17034
p40181
stp40182
a((dp40183
g2
(lp40184
VMixed-mode debugging can be hit and miss, mostly miss
p40185
aVFirst check that you've actually have mixed-mode debugging enabled
p40186
aVFrom a C# project, it is Project + Properties, Debug, Enabled unmanaged code debugging check box
p40187
aVNext, mixed-mode debugging is not enabled for 64-bit processes
p40188
aVIf you run on a 64-bit operating system, make sure you force the
p40189
aVexe to run in 32-bit mode
p40190
aVProject + Properties, Build tab, Platform Target = x86
p40191
aVNext verify where the debugger looked for the
p40192
aVpdb files
p40193
aVFrom the Debug + Windows + Modules window, right-click the DLL and select "Symbol load information"
p40194
aVFinal gasp is to use __debugbreak() in the unmanaged code
p40195
as(dp40196
g9
V17034
p40197
stp40198
a((dp40199
g2
(lp40200
VVisual Studio has no feature that allows re-ordering already written code
p40201
aVThat's the domain of add-ons
p40202
aVResharper has a "Reordering type members" feature but that's only supported for C#, not for VB
p40203
aVNET code
p40204
aVNArrange seems to be able to do this
p40205
aVNo idea, never used it myself
p40206
as(dp40207
g9
V17034
p40208
stp40209
a((dp40210
g2
(lp40211
VNest the loops
p40212
aVI cannot reverse-engineer the actual declarations from the snippet, but something like this:
p40213
as(dp40214
g9
V17034
p40215
stp40216
a((dp40217
g2
(lp40218
VYou are down to arrays, Stack, Queue and ArrayList
p40219
aVThere is no lack of type safety, these classes throw an InvalidCastException when the programmer got it wrong
p40220
aVThis is not a problem, tons of code have been written in
p40221
aVNET 1
p40222
aVx without generics and these kind of bugs flush out quickly
p40223
aVThe table you linked to doesn't show the large number of standard helper classes that are missing
p40224
aVThat could make development awkward when you get started and haven't gotten a feel yet for what's available
p40225
aVJust in the beginning, you'll pick up fast
p40226
aVThe fact that it is so small also makes it quick to master
p40227
as(dp40228
g9
V17034
p40229
stp40230
a((dp40231
g2
(lp40232
VThis is an internal error in the tool
p40233
aVThere's isn't much you can do about it, although it sounds like you found a temporary workaround
p40234
aVIt is possible that it resolves itself when you keep working on the source code
p40235
aVAlbeit that would require a glass that's half full
p40236
aVYou can report the bug at connect
p40237
aVmicrosoft
p40238
aVcom, they'll need a small sample of your code that can reproduce the bug for them
p40239
as(dp40240
g9
V17034
p40241
stp40242
a((dp40243
g2
(lp40244
VWith a user name like "ieplugin" the answer would probably be No
p40245
aVCOM servers don't have
p40246
aVlib files
p40247
aVFor regular DLLs, the
p40248
aVlib file is produced by the linker, not the compiler
p40249
aVThe /IMPLIB option generates them
p40250
as(dp40251
g9
V17034
p40252
stp40253
a((dp40254
g2
(lp40255
VYou can have your cake and eat it too if you first check if output was redirected
p40256
aVHere's a little helper class that contains the P/Invoke voodoo:
p40257
aVUsage:
p40258
as(dp40259
g9
V17034
p40260
stp40261
a((dp40262
g2
(lp40263
VSafeWaitHandle is the appropriate one
p40264
aVA process handle is in fact a waitable handle
p40265
aVYou can call WaitForSingleObject() on it and it will block until the process terminates
p40266
aVThe ReleaseHandle method calls CloseHandle(), as required
p40267
aVAre you sure that the Process class doesn't already do what you need
p40268
as(dp40269
g9
V17034
p40270
stp40271
a((dp40272
g2
(lp40273
VUnicode text is always encoded
p40274
aVPopular encodings are UTF-8, UTF-16 and UTF-32
p40275
aVOnly the latter has a fixed size for a glyph
p40276
aVUTF-16 uses surrogates for codepoints in the upper planes, such a glyph uses 2 wchar_t
p40277
aVUTF-8 is byte oriented, it uses between 1 and 4 bytes to encode a codepoint
p40278
aVUTF-8 is an excellent choice if you need to transcode the text to a byte oriented stream
p40279
aVA very common choice for text files and HTML encoding on the Internet
p40280
aVIf you use Windows then you can use WideCharToMultiByte() with CodePage = CP_UTF8
p40281
aVA good alternative is the ICU library
p40282
aVBe careful to avoid byte encodings that translate text to a code page, such as wcstombs()
p40283
aVThey are lossy encodings, glyphs that don't have a corresponding character code in the code page are replaced by
p40284
as(dp40285
g9
V17034
p40286
stp40287
a((dp40288
g2
(lp40289
VIt is a generic term for a piece of adapter code that fundamentally changes the execution environment
p40290
aVI saw it first being used during the 16-bit to 32-bit Windows transition, a thunk was used to allow code that was running in 16-bit mode to call 32-bit code
p40291
aVSomething similar for ATL thunks
p40292
aVIt knows how to turn a Windows callback, a pure C execution environment with nothing but a window handle to distinguish the context, into a virtual method call on a class object
p40293
aVThe thunk takes care of mapping the window handle to the ATL class instance that wraps it, and translate the message number to the corresponding virtual method
p40294
as(dp40295
g9
V17034
p40296
stp40297
a((dp40298
g2
(lp40299
VThe Win32 API already has a function to do this, WideCharToMultiByte() with CodePage = CP_UTF8
p40300
aVSaves you from having to rely on another library
p40301
aVYou cannot normally use the result with wcout
p40302
aVIts output goes to the console, it uses an 8-bit OEM encoding for legacy reasons
p40303
aVYou can change the code page with SetConsoleCP(), 65001 is the code page for UTF-8 (CP_UTF8)
p40304
aVYour next stumbling block would be the font that's used for the console
p40305
aVYou'll have to change it but finding a font that's fixed-pitch and has a full set of glyphs to cover Unicode is going to be difficult
p40306
aVYou'll see you have a font problem when you get square rectangles in the output
p40307
aVQuestion marks are encoding problems
p40308
as(dp40309
g9
V17034
p40310
stp40311
a((dp40312
g2
(lp40313
VYou OnMessage event handler runs on a background thread
p40314
aVThat's common with socket oriented code
p40315
aVLots of problems with that thread, it doesn't run a message loop and it exits
p40316
aVTwo reasons that make the form go catatonic
p40317
aVYou'll have to marshal the form creation method call to the UI thread
p40318
aVThat's normally done with Control
p40319
aVBeginInvoke()
p40320
aVA bit tricky in your case since you don't have an obvious Form object to act as the BeginInvoke provider
p40321
aVYou'll have to monkey with             System
p40322
aVThreading
p40323
aVSynchronizationContext
p40324
aVCurrent
p40325
aVPost()
p40326
aVI'll leave that as an exercise, using a main window instead of a ApplicationContext would be the easier route
p40327
as(dp40328
g9
V17034
p40329
stp40330
a((dp40331
g2
(lp40332
VThere's nothing special about msbuild, it uses standard file time stamp based checking to see if the target needs to be rebuilt
p40333
aVAs long as none of the source code files in the project have an updated time stamp then it will skip the project
p40334
aVIt isn't clear from your question what you might do to mess this up
p40335
aVHopefully you keep your unit test code in a separate project
p40336
aVYou can get diagnostics to see why msbuild decides to rebuild a target
p40337
aVTools + Options, Project and Solutions, Build and Run, change "MSBuild project build output verbosity" to Diagnostic
p40338
as(dp40339
g9
V17034
p40340
stp40341
a((dp40342
g2
(lp40343
VYes, that sounds like trouble
p40344
aVWPF depends on lots of mixed-mode code written in C++/CLI, glue for Milcore
p40345
aVI know that
p40346
aVNET 4
p40347
aV0 has several interop assemblies for WPF that have names imprinted with the
p40348
aVNET version number
p40349
aVUgly stuff, it looked like they were battling versioning problems badly when I first noticed them
p40350
aVI'm guessing that your useLagecyV2RuntimeActionPolicy is messing this up, getting the wrong assembly loaded
p40351
aVNot a great answer of course, but these are grungy details that are probably only known to the WPF group at Microsoft
p40352
aVTry to get a hold of them by filing a feedback report at connect
p40353
aVmicrosoft
p40354
aVcom
p40355
aVGood luck, I suspect you'll need it
p40356
aVThe "by design" hammer is easily swung with issues like this
p40357
aVBtw: if you don't actually have your own mixed-mode C++/CLI assemblies that made you use that config element then be sure to remove it and work out an alternative solution
p40358
as(dp40359
g9
V17034
p40360
stp40361
a((dp40362
g2
(lp40363
g3471
aVjpeg file is just a bag o' bytes without a JPEG decoder
p40364
aVThere's one built into the Bitmap class, it does a fine job decoding
p40365
aVjpeg files
p40366
aVThe result is a Bitmap object, you can't get around that
p40367
aVAnd it supports resizing through the Graphics class as well as the Bitmap(Image, Size) constructor
p40368
aVBut yes, making a
p40369
aVjpeg image smaller often produces a file that's larger
p40370
aVThat's an unavoidable side-effect of Graphics
p40371
aVInterpolation mode
p40372
aVIt tries to improve the appearance of the reduced image by running the pixels through a filter
p40373
aVThe Bicubic filter does an excellent job of it
p40374
aVLooks great to the human eye, doesn't look so great to the JPEG encoder
p40375
aVThe filter produces interpolated pixel colors, designed to avoid making image details disappear completely when the size is reduced
p40376
aVThese blended pixel values however make it harder on the encoder to compress the image, thus producing a larger file
p40377
aVYou can tinker with Graphics
p40378
aVInterpolationMode and select a lower quality filter
p40379
aVProduces a poorer image, but easier to compress
p40380
aVI doubt you'll appreciate the result though
p40381
as(dp40382
g9
V17034
p40383
stp40384
a((dp40385
g2
(lp40386
VThe error code (0x80080005) is CO_E_SERVER_EXEC_FAILURE, "Server execution failed"
p40387
aVIn other words, something went wrong when COM tried to start Excel
p40388
aVexe
p40389
aVPretty basic problem that has way too many possible causes
p40390
aVCheck the Windows event log for a possible better diagnostic
p40391
aVThe usual next step is reinstalling Office
p40392
as(dp40393
g9
V17034
p40394
stp40395
a((dp40396
g2
(lp40397
VThe first part is normal, the console window cannot respond to close requests while the debugger has a the process in break mode
p40398
aVDebug + Stop Debugging should terminate the program
p40399
aVThere's however an issue that's specific to XP and earlier, a process cannot terminate if a kernel thread is executing an I/O request for the process
p40400
aVYou can see this condition from Taskmgr
p40401
aVexe, Processes tab
p40402
aVView + Select Columns and tick "Handles"
p40403
aVYou've got a zombie process when you see it show 1 handle in use
p40404
aVNot so sure how you get out of the condition, it is rather specific to the I/O request that isn't completing
p40405
aVHaving ditched XP a long time ago, I vaguely remember killing devenv
p40406
aVexe to solve the problem
p40407
aVWindows 7 is nice, recommended
p40408
as(dp40409
g9
V17034
p40410
stp40411
a((dp40412
g2
(lp40413
VI haven't yet mastered the art of reverse-engineering code from a screenshot
p40414
aVI'm guessing that you don't dispose the previous user control when you select a new one
p40415
aVAllowing the tool tip to stay visible
p40416
aVUse code like this:
p40417
aVAnd call SelectView() from the TreeView's AfterSelect event handler
p40418
as(dp40419
g9
V17034
p40420
stp40421
a((dp40422
g2
(lp40423
VSilverlight integration in VS2010 isn't that smooth yet
p40424
aVThe build tools are still in beta
p40425
aVThe "
p40426
aVNET Framework Target" setting has no effect and they forgot to disable it
p40427
aVSilverlight runs on its own CLR version
p40428
aVYou normally get prompted for the Silverlight runtime version when you create a new project
p40429
aVYou can change it afterward with Project + Properties, Silverlight tab, "Target Silverlight Version" combobox
p40430
aVYou won't find 4
p40431
aV0 in this combobox if you didn't install it yet
p40432
aVThat's done separate, after you install VS2010
p40433
aVDownload location is here
p40434
as(dp40435
g9
V17034
p40436
stp40437
a((dp40438
g2
(lp40439
VThe problem with wofstream is that it accepts the wide string for the open() method but does not actually write wide characters to the file
p40440
aVYou have to be explicit about that and imbue() it with a locale that has a codecvt with the encoding you want
p40441
aVImplementation of such a codecvt that produces a UTF encoding is still spotty,  here's an example that uses Boost
p40442
as(dp40443
g9
V17034
p40444
stp40445
a((dp40446
g2
(lp40447
VFrom the documentation of the TextBoxBase
p40448
aVUndoLimit property:
p40449
aVThe number of actions stored in the undo queue
p40450
aVThe default is \u20131, which
p40451
aVmeans the undo queue is limited to the
p40452
aVmemory that is available
p40453
aVYou found that limit
p40454
aVSet it to a reasonably small value
p40455
aVIt otherwise doesn't normally make a lot of sense to display logging information in a TextBox
p40456
aVIt is really meant to allow the user to enter text
p40457
aVPerhaps TextBlock is a better choice
p40458
aVUPDATE: in
p40459
aVNET 4
p40460
aV5, the default of -1 was changed to 100 to avoid this kind of runaway memory usage
p40461
as(dp40462
g9
V17034
p40463
stp40464
a((dp40465
g2
(lp40466
VThe JPEG compression algorithm is quite unsuitable for the kind of image you are capturing
p40467
aVIt works well for photos, it behaves poorly on images containing fine lines
p40468
aVThe slight artifacts the compression produces makes it a lot harder to properly scan the barcode
p40469
aVYou don't see the Kleenex box because you are writing the raw image bytes
p40470
aVYou need to use an image encoder
p40471
aVI recommend you use the PngBitmapEncoder class
p40472
aVGifBitmapEncoder should work too since you don't need a lot of colors, it makes smaller files
p40473
aVA code snippet that shows how to use an encoder is available here
p40474
as(dp40475
g9
V17034
p40476
stp40477
a((dp40478
g2
(lp40479
VCalling the dialog template editor a "designer" would be rather a stretch
p40480
aVIt hasn't changed in the past 15 years or so, neither has the underlying API
p40481
aVAn API that doesn't support PNGs, only BMPs
p40482
aVGetting PNG support is possible, GDI+ is available on any Windows version since 2000
p40483
aVBut you have to code it yourself
p40484
aVThis is a solved problem, there are excellent class libraries available for UI development, along with tooling to do what you want to do
p40485
aVQt is one of them if you want to stick with C++
p40486
as(dp40487
g9
V17034
p40488
stp40489
a((dp40490
g2
(lp40491
VA TableLayoutPanel was designed to provide this kind of scaling support
p40492
aVYou'll need three rows with the middle one Absolute and the top and bottom Percent
p40493
aVDock fill the controls in the rows, the rest is automatic
p40494
as(dp40495
g9
V17034
p40496
stp40497
a((dp40498
g2
(lp40499
VIf you'd keep one panel's size fixed, there is no logical way to move the splitter
p40500
aVSince you can't move the splitter, it just doesn't make sense to use a SplitContainer anymore
p40501
aVUse two Panel controls
p40502
as(dp40503
g9
V17034
p40504
stp40505
a((dp40506
g2
(lp40507
VXilinx is in the business of selling FPGA chips
p40508
aVSuch a chip is going to worthless to you without the tooling you need to create the logic design and burn the chip
p40509
aVThe tooling used to be quite expensive but is available for free for low-to-medium end chips (as pointed out in the comments)
p40510
aVGoogle "Verilog" and "FPGA programming"
p40511
aVThe essential difference between a FPGA and your Arduino is that you program hardware on a FPGA, software on an Arduino
p40512
as(dp40513
g9
V17034
p40514
stp40515
a((dp40516
g2
(lp40517
VThere's a lot more to acquiring a lock than a simple CPU instruction
p40518
aVThe cost of trying to acquire it and not getting it is very high
p40519
aVDocumented to be somewhere between 2000 and 10,000 machine instructions
p40520
aVThe higher number for thread context switches to a thread in another process, that requires reloading the virtual memory page translation tables
p40521
aVA very common strategy that makes sense on multi-core CPUs is a spin-wait
p40522
aVThe code goes into a tight loop, burning CPU cycles heavily, trying to acquire the lock
p40523
aVThe exact amount of time it spends in this loop is technically a tunable item, but doesn't make much difference in practice
p40524
aVAnyhoo, it is the job of the CLR and the compiler is to hide the implementation details
p40525
aVOne core class that does this is the Monitor class
p40526
aVIt is used when you use the lock statement in C# for example, the compiler automatically translates that to a Monitor
p40527
aVEnter call, auto-generating a try and finally block, the finally block executes the Leave() method
p40528
aVThe implementation of these methods is in the CLR
p40529
aVThere's a fairly good chunk of code there, another thing it does is dealing with a "fairness"
p40530
aVWhich makes sure that threads cannot starve, trying to acquire the lock
p40531
aVThat code is written in C++, still pretty far removed from raw CPU instructions
p40532
aVIt ultimately boils down to the actual code that implements the actual lock
p40533
aVYes, that's written in assembly, at least in the shared source version of the CLR
p40534
aVThat code lives in the PAL (Platform Adapter Layer), the x86 version of it looks like this:
p40535
aVThe cmpxchng CPU instruction with the lock prefix is the typical one to implement locks
p40536
aVYour xadd is covered too though, used for Interlocked
p40537
aVAdd:
p40538
aVBut that isn't typically used for locks
p40539
aVIf you want to see this for yourself, download the SSCLI20 source code and have a look-see at clr\u005csrc\u005cwm\u005ci386\u005casmhelpers
p40540
aVasm
p40541
aVWhether that is actually used in the currently shipping version of the CLR is an open question
p40542
aVIt's pretty core, so somewhat likely
p40543
aVThe Monitor method implementations are in clr\u005cvm\u005csyncblk
p40544
aVcpp, AwareLock class
p40545
aVI'm pretty sure that the SSCLI20 version of it is not what's running on your machine, they've been tinkering with the "fairness" algorithm
p40546
as(dp40547
g9
V17034
p40548
stp40549
a((dp40550
g2
(lp40551
VNot really, a
p40552
aVresx file behaves like a dictionary
p40553
aVDictionaries are unordered collections, you find stuff back through the key value, the order is unimportant
p40554
aVTechnically you can, with a text editor
p40555
as(dp40556
g9
V17034
p40557
stp40558
a((dp40559
g2
(lp40560
VBeing off towards the right tends to be explainable by the value of the  property
p40561
aVA value produced by the printer driver
p40562
aVPrinter drivers are however typically not very good at guessing what the actual paper route through the printer might look like
p40563
aVThat's mechanical, pinch rollers, tray alignment and whatnot
p40564
aVSoftware and Mechanical engineers don't have lunch together often enough
p40565
aVBut a software engineer can almost always fix a mechanical engineer's problem
p40566
aVYou'll need an Options dialog to allow the user to fix the mechanical engineer's problem
p40567
aVUse the value in  call
p40568
as(dp40569
g9
V17034
p40570
stp40571
a((dp40572
g2
(lp40573
VYou are right of course
p40574
aVGetting a stack overflow in C/C++ code is pretty easy to do:
p40575
aVThe 4 to make sure it blows in 64-bit mode as well
p40576
aVBut arrays are reference types in managed code
p40577
aVThey get allocated on the heap, not the stack
p40578
aVIn C# code, you would have to allocate a value type as a local variable to gobble up stack space
p40579
aVAnd the only value type type that qualifies to get you anywhere with that is a struct
p40580
aVThat's hard, you'd have to declare a struct that has a quarter of a million members, give or take
p40581
aVThe only possible way to get one of those is a struct that was auto-generated from some kind of tool and a huge dbase scheme
p40582
aVThat just doesn't happen
p40583
aVSurely the problem is located in your dbase provider
p40584
aVInvariably written in C or C++
p40585
aVAnd doing something nasty like using _alloca() to blow the stack
p40586
aVThe "stackalloc" keyword in C#
p40587
aVI'll avoid mentioning the editbin
p40588
aVexe utility with the /stack argument to increase the size of the main thread stack, you shouldn't have to monkey with that
p40589
aVTalk to your dbase provider provider
p40590
as(dp40591
g9
V17034
p40592
stp40593
a((dp40594
g2
(lp40595
VYeah, that doesn't work
p40596
aVHere's a class that improves it somewhat:
p40597
aVCompile and drop it from the top of the toolbox onto your form
p40598
aVIt however cannot fix the fundamental problem, the "Show window content while dragging" option
p40599
aVThat's a system option, it will be turned on for later versions of Windows
p40600
aVWhen it is on, Windows itselfs scrolls the content of the panel, then asks the app to draw the part that was revealed by the scroll
p40601
aVThe OnScroll method overrides that, ensuring that the entire window is repainted to keep the background image in place
p40602
aVThe end-result is not pretty, you'll see the image doing the "pogo", jumping up and down while scrolling
p40603
aVThe only fix for this is turning the system option off
p40604
aVThat's not a practical fix, users like the option and it affects every program, not just yours
p40605
aVIf you can't live with the pogo then you'll have to give up on the transparency
p40606
as(dp40607
g9
V17034
p40608
stp40609
a((dp40610
g2
(lp40611
VDon't copy system DLLs from your Win7 machine to the XP machine, that can't work
p40612
aVIt would have been easier if you named the file, I would guess at wiaaut
p40613
aVdll, the WIA Automation provider
p40614
aVIt probably just isn't installed on the XP machine
p40615
aVAsk the client to install this download on the machine
p40616
aVYou don't need reg-free COM, these are system components
p40617
as(dp40618
g9
V17034
p40619
stp40620
a((dp40621
g2
(lp40622
VBuild + Configuration Manager, select Release in the upper left combo
p40623
aVClose
p40624
aVNow use Project + Properties, Build tab and verify Platform Target
p40625
as(dp40626
g9
V17034
p40627
stp40628
a((dp40629
g2
(lp40630
VI'd recommend you deal with this the way Windows Forms does it internally:
p40631
as(dp40632
g9
V17034
p40633
stp40634
a((dp40635
g2
(lp40636
VThat doesn't work if Slice
p40637
aVIndex as an integer
p40638
aVYou need to cast it to double to get a floating point division
p40639
aVFor example:
p40640
aVor do it like this:
p40641
aVWhich ensures the division cannot truncate to 0 like your original expression did
p40642
aVContrary to everybody's advice, a ProgressBar does paint itself when you change the Value property
p40643
aVAlthough your window still goes catatonic
p40644
as(dp40645
g9
V17034
p40646
stp40647
a((dp40648
g2
(lp40649
VIt's not an assembly, it's a COM component
p40650
aVProject + Add Reference, Browse tab, select c:\u005cwindows\u005csystem32\u005cshdocvw
p40651
aVdll
p40652
aVIn Windows 7 pick shdocvw
p40653
aVtlb in the same directory instead
p40654
aVThis generates the interop library for the COM component with the SHDocVw namespace
p40655
aVWebBrowser_V1 is one of the types you'll get from that
p40656
as(dp40657
g9
V17034
p40658
stp40659
a((dp40660
g2
(lp40661
VUsing RegisterAssembly() is very unusual
p40662
aVOne thing that could go wrong here is that the installer is running in 32-bit mode
p40663
aVWhich would make RegisterAssembly() register the COM server in the wrong registry section
p40664
aVNo need to do this, just set the Register property for the file to COM in the setup project
p40665
as(dp40666
g9
V17034
p40667
stp40668
a((dp40669
g2
(lp40670
VIt would be a COM interface for images, IPicture or IPictureDisp, probably
p40671
aVYou could use the AxHost
p40672
aVGetPictureFromIPicture or GetPictureFromIPictureDisp static method to make the conversion
p40673
as(dp40674
g9
V17034
p40675
stp40676
a((dp40677
g2
(lp40678
VThere's nothing that stops the FlowLayoutPanel from shrinking to nothing
p40679
aVYou'll at least have to set its AutoSize property to True as well
p40680
as(dp40681
g9
V17034
p40682
stp40683
a((dp40684
g2
(lp40685
VThe only way IE9 could install side-by-side is when it uses new GUIDs for the interfaces and coclasses
p40686
aVWhich means that you cannot use WebBrowser, it has the GUIDs hard-coded
p40687
aVThere's one other option, using the AxHost wrapper
p40688
aVRight-click the toolbox, Choose Items, select the COM Components tab and locate IE9 in the list
p40689
aVNo idea what it might be called, the old name was "Microsoft Web Browser", serviced by c:\u005cwindows\u005csystem32\u005cieframe
p40690
aVdll
p40691
aVYou'll have to make do without the friendly WebBrowser and HtmlDocument wrapper classes
p40692
as(dp40693
g9
V17034
p40694
stp40695
a((dp40696
g2
(lp40697
VStep #6 is wrong
p40698
aVNET assemblies with [ComVisible] types are registered with Regasm
p40699
aVexe
p40700
aVUse the /codebase command line option if you don't want to install the DLL into the GAC
p40701
aVThe /tlb command line option creates the type library, you can use that in your VB6 project
p40702
as(dp40703
g9
V17034
p40704
stp40705
a((dp40706
g2
(lp40707
VNot sure what you are doing, or why you are doing this, but somewhere along the way you lost the blah_i
p40708
aVc source code file that midl
p40709
aVexe generates
p40710
aVIt contains the GUIDs of the interfaces, coclasses and type library, the ones that the linker is complaining about
p40711
aVIf you can't find it back, search for MIDL_DEFINE_GUID in the *
p40712
aVc files
p40713
aVEdit: I see the problem now, you renamed the blah_i
p40714
aVc to blah_i
p40715
aVcpp
p40716
aVThat's wrong, the file contains C declarations
p40717
aVThe compiler mangles the identifiers differently when it is compiled as C++ code
p40718
aVRename it back to
p40719
ag36104
aVOr use the /Tc compile option
p40720
as(dp40721
g9
V17034
p40722
stp40723
a((dp40724
g2
(lp40725
VI repro, Win7
p40726
aVI don't see an obvious workaround for it beyond making these forms owned so they don't need a taskbar button
p40727
aVThat the Windows window manager allows disabled windows to become active is quite odd
p40728
aVThis doesn't get put to test often, very unusual to have one app take so many taskbar buttons
p40729
as(dp40730
g9
V17034
p40731
stp40732
a((dp40733
g2
(lp40734
VThis is not appropriate UI design
p40735
aVPresenting choices like this requires Radio buttons
p40736
aVYou can disable or hide choices in another group box if they are not available due to an earlier selection
p40737
as(dp40738
g9
V17034
p40739
stp40740
a((dp40741
g2
(lp40742
VNot necessary
p40743
aVThese dialogs have a Dispose() method only because they inherit one from the Component class
p40744
aVThey don't override the method since they don't actually have anything to dispose
p40745
aVAll the system resources they use get released when the dialog closes
p40746
aVThe Component
p40747
aVDispose() implementation doesn't do any disposing either, it just makes sure that the component is removed from a IContainer collection
p40748
aVThis is otherwise an implementation detail of these dialog wrappers
p40749
aVOther components do normally have use for Dispose(), ToolTip being a good example
p40750
aVThe auto-generated Dispose method for a form makes sure that this happens, check out the "components" field in the form's Designer
p40751
aVcs source code file
p40752
aVWhich is why Component has a Dispose method that doesn't do anything important by default
p40753
aVThere's one teeny advantage to avoiding dropping the component on the form, it allows the
p40754
aVNET wrapper class for the dialog to be garbage collected
p40755
aVBut the kilobyte or so that saves is a micro-optimization
p40756
aVTake this at face value: if early disposing these class objects would have been important, Microsoft wouldn't have made them components
p40757
as(dp40758
g9
V17034
p40759
stp40760
a((dp40761
g2
(lp40762
VTiming this code isn't really possible
p40763
aVYou'll only get realistic timing results if you run the Release version of the code
p40764
aVWhich also kicks in the JIT optimizer
p40765
aVAnd it is smart enough to see that "pt" isn't actually used anywhere, it removes all code that assigns it
p40766
aVYou'll end up with the exact same time and still not know anything
p40767
aVTo force the JIT optimizer to actually emit the assignment code, you have to do something with "pt"
p40768
aVLike:
p40769
aVBut now you'll be timing how long Console
p40770
aVWriteLine() takes instead of finding out anything about the efficiency of the assignment
p40771
aVWhat's worthy in this case however is to look at the machine code that's generated
p40772
aVHere's an annotated version of what my x86 JIT compiler generated in the Release build with the optimizer enabled:
p40773
aVThe [elided] section is the Console
p40774
aVWriteLine() call
p40775
aVLook closely at the machine code instructions:
p40776
aVIt is the exact same code
p40777
aVThe JIT compiler is cool that way
p40778
aVIf you ask it to do the same job it generates the same code
p40779
aVThe common advice is to code for clarity instead of efficiency
p40780
aVWhile such a statement isn't often verified, it is often accurate
p40781
as(dp40782
g9
V17034
p40783
stp40784
a((dp40785
g2
(lp40786
VNative images are the files generated by ngen
p40787
aVexe
p40788
aVIt contains pre-compiled machine code for an assembly, so that the JIT compiler isn't needed
p40789
aVAll
p40790
aVNET framework assemblies are ngen-ed
p40791
aVThey have the
p40792
aVni
p40793
aVdll filename extension
p40794
aVYou are typically not interested in them if you are trying to troubleshoot an assembly resolution problem
p40795
aVBut you can see them getting loaded if you choose "Native Images" instead of "Default"
p40796
as(dp40797
g9
V17034
p40798
stp40799
a((dp40800
g2
(lp40801
VWrong MSDN page
p40802
aVThat one talks about suppressing warnings produced by the Code Analysis tool
p40803
aVVery different animal from the VB
p40804
aVNET compiler
p40805
aVTo suppress compiler warnings, use Project + Properties, Compile tab, Warning configurations section
p40806
aVLocate the specific warning message you want to disable, change the notification setting from "Warning" to "None"
p40807
aVThe "Disable all warnings" checkbox is the big hammer solution
p40808
as(dp40809
g9
V17034
p40810
stp40811
a((dp40812
g2
(lp40813
VShowing progress is often desirable
p40814
aVBut you do need to be able to measure progress to make that meaningful
p40815
aVGuessing that you meant DataSet
p40816
aVReadXml(), that class doesn't have any kind of ProgressChanged event that you could use to let the user know how far the job got along
p40817
aVNor can you guess up front how long it is going to take
p40818
aVExecution time is roughly proportional to the size of the
p40819
aVxml file but the exact proportion is impossible to guess accurately
p40820
aVAll you can do is let the user know "I'm busy, don't expect anything for a while"
p40821
aVThe hourglass cursor has been the standard way of doing so for the past 20 years
p40822
aVYou can get fancier with an animation
p40823
aVWhich is all that a ProgressBar in marquee mode really is
p40824
aVIt doesn't help the user at all
p40825
aVAlbeit that it has a slight bit of information added: "the operating system hasn't crashed"
p40826
aVUseful 20 years ago
p40827
aVYou can create your own animation
p40828
aVDo animated GIFs work on CF
p40829
aVIf not, you can flip bitmaps yourself
p40830
aVYou do however take on an additional burden, you have to keep the animation animating
p40831
aVThat requires that you run the ReadXml() call on another thread so that the UI thread is available to keep the image updated
p40832
aVNo BackgroundWorker in CF, you'll have to spin that thread up yourself
p40833
as(dp40834
g9
V17034
p40835
stp40836
a((dp40837
g2
(lp40838
Vthe function uses an Automation type not supported in Visual Basic
p40839
aVThe buck stops there, there is no equivalent of parameter arrays in VB6
p40840
aVDrop the ParamArray keyword
p40841
aVThe VB6 code has to pass an array of Variants
p40842
aVUnpleasant, consider redesigning your class
p40843
as(dp40844
g9
V17034
p40845
stp40846
a((dp40847
g2
(lp40848
VThe C++ standard library has no such support
p40849
aVYou need an operating system API to do this
p40850
aVIf this is Windows then you'd use CreateToolhelp32Snapshot(), followed by Process32First and Process32Next to iterate the running processes
p40851
aVBeware of the inevitable race condition, the process could have exited by the time you found it
p40852
as(dp40853
g9
V17034
p40854
stp40855
a((dp40856
g2
(lp40857
VIt is an internal WMI error, WBEMESS_E_REGISTRATION_TOO_BROAD, "The provider registration overlaps with the system event domain
p40858
aVThat's about a good an error message as you'd ever get out of COM
p40859
aVStriking how much better the
p40860
aVNET exception messages are
p40861
aVAnyhoo, I'm fairly sure that what it means is "you are asking for WAY too many events"
p40862
aVYou'll have to be more selective in your query, use the WHERE clause
p40863
aVLike:
p40864
aVSELECT * FROM RegistryTreeChangeEvent
p40865
aVWHERE Hive='HKEY_LOCAL_MACHINE' AND
p40866
aV'RootPath='SOFTWARE\u005cMicrosoft'
p40867
aVPrompted by Giorgi, I found the MSDN page that documents the problem:
p40868
aVThe following is an example of an incorrect registration
p40869
aVSELECT * FROM RegistryTreeChangeEvent
p40870
aVWHERE hive = hkey_local_machine" OR
p40871
aVrootpath ="software"
p40872
aVBecause there is no way to evaluate the possible values for each of the properties, WMI rejects with the error WBEM_E_TOO_BROAD any query that either does not have a WHERE clause or if the WHERE clause is too broad to be of any use
p40873
as(dp40874
g9
V17034
p40875
stp40876
a((dp40877
g2
(lp40878
VIt is simply done with the Windows VirtualProtect() API function
p40879
aVIt changes the virtual memory page attributes
p40880
aVFrom PAGE_READWRITE so the JIT compiler can write the machine code to PAGE_EXECUTE_READ so it can be executed
p40881
aVNo special privileges are required to do so since the page is owned by the process that also runs the JIT compiler
p40882
as(dp40883
g9
V17034
p40884
stp40885
a((dp40886
g2
(lp40887
VNo, 12 years of IntelliSense evolution prevents this from working
p40888
aVThe XML documentation comments generates an
p40889
aVxml file that IntelliSense can pick up
p40890
aVIn VB6/A, documentation is present in the type library with the helpstring attribute
p40891
aVFor example:
p40892
aVGetting the same from your [ComVisible] class library requires the [Description] attribute
p40893
aVNote this answer for a quirk about the way it works for properties
p40894
as(dp40895
g9
V17034
p40896
stp40897
a((dp40898
g2
(lp40899
VSingle-threaded COM components have a hard requirement that you create them on an STA thread
p40900
aVWhich you create by using the [STAThread] attribute on your Main() method and by pumping a message loop
p40901
aVSuch as the one created by Application
p40902
aVRun()
p40903
aVYou can now call such a component from a worker thread or a timer callback
p40904
aVCOM ensures that the single-threaded requirement for the component is met and marshals that call to the STA thread
p40905
aVDefeating what you were trying to accomplish, all calls to the component run on only one thread
p40906
aVYou'll make it slower, not faster
p40907
aVMarshaling the call is not fast
p40908
aVThere is no secret sauce here, you cannot magically turn a component that explicitly stated that it doesn't support threading into a threaded component
p40909
aVNor is it uncommon, the vast majority of COM components, or for that matter
p40910
aVNET components, do not support threading
p40911
aVThe difference between COM and
p40912
aVNET components is that COM does something about it
p40913
ag3471
aVNET component will typically just malfunction on some kind of threading race without a diagnostic
p40914
as(dp40915
g9
V17034
p40916
stp40917
a((dp40918
g2
(lp40919
VNo, what you are seeing is the MulticastDelegate class optimizing the general case in which there's only one target method
p40920
aVWith just one, it can store the target in the base class' (Delegate) _methodBase and _target fields
p40921
aVWhen there's more than one then it has to create a list to store the targets
p40922
aVNow it uses its _invocationList field so it can store as many targets as needed
p40923
aVIn other words, _invocationCount will never be 1
p40924
aVYou can see this by expanding "base" in the debugger
p40925
as(dp40926
g9
V17034
p40927
stp40928
a((dp40929
g2
(lp40930
VStructs have been troublesome beasts in computer engineering for a very long time
p40931
aVTheir memory layout is very hardware dependent
p40932
aVTo make them efficient, their members must be aligned so the CPU can read and write their values quickly without having to multiplex the bytes to fit the memory bus width
p40933
aVEvery compiler has its own strategy of packing the members, often directed by, for example, the #pragma pack directive in a C or C++ program
p40934
aVWhich is okay, but rather a problem in interop scenarios
p40935
aVWhere one chunk of code may make different assumptions about the structure layout than another chunk, compiled by a different compiler
p40936
aVYou can see this back in COM,
p40937
aVNET's grandfather solution to interop programming
p40938
aVCOM has very poor support for handling structs
p40939
aVIt doesn't support them as a native automation type but has a workaround through the IRecordInfo interface
p40940
aVWhich lets a program discover the memory layout at runtime through an explicit declaration of the structure in a type library
p40941
aVWhich works okay, but is quite inefficient
p40942
aVThe
p40943
aVNET designers made a very courageous, and correct, decision to solve this problem
p40944
aVThey made the memory layout of a struct completely undiscoverable
p40945
aVThere is no documented way to retrieve the offset of a member
p40946
aVAnd by extension, no way to discover the size of the struct
p40947
aVEverybody's favorite answer, use Marshal
p40948
aVSizeOf() is not in fact the solution
p40949
aVThat returns the size of struct after it is marshaled, the size you'd need to pass to, say, Marshal
p40950
aVAllocCoTaskMem() before you call Marshal
p40951
aVStructureToPtr
p40952
aVThat arranges and aligns the struct members according to the [StructLayout] attribute that's associated with the struct
p40953
aVNote that this attribute isn't required for structs (like it is for classes), the runtime implements a default one which uses the declared order for the members
p40954
aVOne very nice side-effect of the layout being undiscoverable is that the CLR can play tricks with it
p40955
aVWhen packing the members of the struct and aligning them, the layout can get holes that don't store any data
p40956
aVCalled padding bytes
p40957
aVGiven that the layout is undiscoverable, the CLR can actually use the padding
p40958
aVIt moves a member if it is small enough to fit such a hole
p40959
aVYou'll now actually get a struct whose size is smaller than what would normally be required given the declared structure layout
p40960
aVAnd, notably, Marshal
p40961
aVSizeOf() will return the wrong value for the structure size, it returns a value that's too large
p40962
aVLong story short, there's no general way to get an accurate value for the structure size programmatically
p40963
aVThe best thing to do is to just not ask the question
p40964
aVMarshal
p40965
aVSizeOf() will give you a guesstimate, assuming the structure is blittable
p40966
aVIf you need an accurate value for some reason then you could look at the generated machine code of a method that declares a local variable of the structure type and compare it to the same method without that local variable
p40967
aVYou'll see the difference in the stack pointer adjustment, the "sub esp, xxx" instruction at the top of the method
p40968
aVOf course, it will be architecture dependent, you'll typically get a larger structure in 64-bit mode
p40969
as(dp40970
g9
V17034
p40971
stp40972
a((dp40973
g2
(lp40974
VYes, this was popular back in the Windows 3
p40975
aVx days
p40976
aVYou don't see this anymore because it is so difficult to make look good on modern Windows versions
p40977
aVThe trouble is the way text is rendered, ClearType rendering requires a well defined background color to get the anti-aliasing pixels to work well
p40978
aVThat's hard to come by on a progress bar, especially the Vista and Win7 version with the traveling high-light note
p40979
aVYou'd have to make your own Label control
p40980
aVMake it transparent by overriding CreateParams and turning on the WS_EX_TRANSPARENT style
p40981
aVAlso override OnPaint to draw the text, you will have to change e
p40982
aVGraphics
p40983
aVTextRenderingHint to turn off anti-aliasing
p40984
aVThe result isn't pretty
p40985
as(dp40986
g9
V17034
p40987
stp40988
a((dp40989
g2
(lp40990
VThis is of course not caused by having the _DEBUG symbol defined or compiling the code in the debug configuration
p40991
aVThe added debugging code runs whether or not the debugger is attached to the program
p40992
aVThe debugger doesn't normally affect code execution, it stays out of the way by calling WaitForDebugEvent
p40993
aVWhich blocks it, until the operating system tells it that something noteworthy happened
p40994
aVThat can trigger a bunch of code in the debugger that can slow down your program
p40995
aVYou can see the events listed in the DEBUG_EVENT structure documentation
p40996
aVAnnotating them a bit beyond the documentation: the debugger steps in and can slow down your program when:
p40997
aVThe program loads or unloads a DLL
p40998
aVLots of stuff happens during load, the debugger goes hunting for a debug symbol file (
p40999
aVpdb)
p41000
aVIt may contact a symbol server to download it
p41001
aVAny breakpoints that were set in the DLL source code will get activated
p41002
aVThis can be quite slow, but the effect is temporary and generally only slows down the startup
p41003
aVYou can see the load/unload notification in the Output window
p41004
aVThe program raises an exception
p41005
aVThis activates the debugger at the moment the exception is raised, a "first chance notification"
p41006
aVWhich can be very helpful, you can use the Debug + Exception, Thrown checkbox to make the debugger stop when the exception is raised
p41007
aVYou can see the notification message in the Output window
p41008
aVThis does slow down code that raises and catches exceptions tremendously and is quite likely the source of your slowdown
p41009
aVNever use exceptions for flow control
p41010
aVA thread starts running or terminates
p41011
aVAgain, a notification message is printed to the Output window
p41012
aVYou'd have to create a lot of threads to make this slow down your program
p41013
aVWhen your program uses OutputDebugString() for tracing purposes
p41014
aVVisible in the Output window
p41015
aVAnother good candidate for a slow down, output falls in the bit bucket if no debugger is attached
p41016
aVYou shouldn't have any trouble diagnosing this as the cause, the obvious side-effect is seeing a lot of messages in the Output window
p41017
aVWhen the program hits a breakpoint
p41018
aVNot a lot of reasons to be stumped by that one
p41019
aVBut you can set breakpoints that slow down the program a lot yet don't cause a debugger break
p41020
aVParticularly the Conditional breakpoint, Hit counter, Filter and the When Hit operation will be slow
p41021
aVUse Debug + Windows + Breakpoints to review the breakpoints that are defined
p41022
as(dp41023
g9
V17034
p41024
stp41025
a((dp41026
g2
(lp41027
VNo, this has nothing to do with the FPU
p41028
aVThe VB6 runtime is ab/using that floating point exception to implement its own exception handling
p41029
aVThe On Error statement, I'm sure you're familiar with it
p41030
aVWhy on Earth they chose to re-use a hardware exception code has always been mysterious to me, that tidbit is lost in 15 odds years of Visual Basic design
p41031
aVIt doesn't byte because the FPU is initialized by the VB6 runtime with that exception masked
p41032
aVAnyhoo, the diagnostic is that your VB6 code is crashing with an unhandled exception
p41033
aVTo find out what is going on, be sure to run the code from the VB6 debugger
p41034
aVAlso make sure you check your Debug + Exceptions dialog, the Thrown boxes should be off
p41035
aVPress F5 to let the exception be handled the normal way
p41036
aVIt ought to go kaboom after that
p41037
aVFrom MarkJ's helpful link:
p41038
aVAnother exception that you will commonly see is c000008f
p41039
aVIf you look the number up then you will find that it is a floating point inexact result exception
p41040
aVIt is used in a different meaning here \u2013 since we don\u2019t generate real floating point inexact result exceptions, they can safely be thrown to indicate VB errors of the normal trappable type
p41041
as(dp41042
g9
V17034
p41043
stp41044
a((dp41045
g2
(lp41046
VYou'll have to create threads to make that work
p41047
aVCalling Thread
p41048
aVSetApartmentState() is required to make them STA threads
p41049
aVNot so sure this will come to a good end, neither Windows Forms nor WPF has any support for arbitrating windows in separate app domains
p41050
aVMaybe it will work
p41051
as(dp41052
g9
V17034
p41053
stp41054
a((dp41055
g2
(lp41056
VYes that's your problem
p41057
aVThe form you create will be dead as a doornail, your thread isn't pumping a message loop
p41058
aVEven if you could make it work, you'd still have a significant problem
p41059
aVPushing a message box in the user's face cannot work reliably
p41060
aVThe user will be banging away at, say, a Word document and pressed the space bar just as the message box pops up
p41061
aVTo immediately disappear
p41062
aVAll that the user notices is a slight flash and a space that's mysteriously missing from the document
p41063
aVYou really ought to use a NotifyIcon to pop up notifications like this
p41064
aVIts ShowBalloonTip method is the standard way to deliver background info
p41065
aVYou could create your own Form class to show something custom
p41066
aVIt's important that it doesn't steal the focus to avoid the flash-and-gone problem mentioned above
p41067
aVYou'd need to create a dedicated thread to avoid the message loop problem
p41068
aVSomething like this:
p41069
aVWhere frmNotify is the notification form, something like this:
p41070
as(dp41071
g9
V17034
p41072
stp41073
a((dp41074
g2
(lp41075
VYou could remove the tab page from the TabControl
p41076
aVTabPages collection and store it in a list
p41077
aVFor example:
p41078
as(dp41079
g9
V17034
p41080
stp41081
a((dp41082
g2
(lp41083
VBad practice vote from me
p41084
aVIf you do want to assign a value, set it to (void*)0xdeadbeef
p41085
aVCheck what your CRT can do first though
p41086
aVA decent debug allocator will set freed memory to a pattern that's likely to cause a bomb when the pointer is used after it was freed
p41087
aVAlbeit that it isn't guaranteed
p41088
aVBut then not changing the pointer value is the better (and faster) solution
p41089
as(dp41090
g9
V17034
p41091
stp41092
a((dp41093
g2
(lp41094
VThe obvious approach is to check the codepoints with TextBox
p41095
aVText
p41096
aVToCharArray()
p41097
aVHewbrew glyphs are codepoints 0x0580 through 0x05ff with supplementals 0xfb1d through 0xfb4f
p41098
aVPlus the arabic digits
p41099
aVNot being a native speaker, I would however assume that Latin characters can appear when spelling trade mark names, foreign words and acronyms
p41100
aVNote the use of "RSS" in this page
p41101
aVWhich put a pretty big hole in any attempt to verify the text
p41102
as(dp41103
g9
V17034
p41104
stp41105
a((dp41106
g2
(lp41107
VThis could be a very long answer, talking about the many subtle differences between machine code generated by a C compiler vs the machine code generated by the JIT compiler from a managed program
p41108
aVLong enough to really require a book, but such books have already been written
p41109
aVAnything by Jeffrey Richter for example
p41110
aVI'll keep it short and snappy, because all those subtle differences boil down to the One Rule:
p41111
aVManaged code is code that allocates memory from the garbage collected heap
p41112
as(dp41113
g9
V17034
p41114
stp41115
a((dp41116
g2
(lp41117
VYes, this is a documented problem with the debugger in VS2008 SP1
p41118
aVThere's a hotfix available that fixes this particular problem, as well as several debugger issues when debugging multi-threaded code
p41119
aVRecommended, download is here
p41120
as(dp41121
g9
V17034
p41122
stp41123
a((dp41124
g2
(lp41125
VYou could set the FlowDirection property to RightToLeft
p41126
as(dp41127
g9
V17034
p41128
stp41129
a((dp41130
g2
(lp41131
VRandomly typing in "COM Inspector" in Google produced this link
p41132
aVLooks good, no personal experience
p41133
aVRun this query yourself to find others
p41134
as(dp41135
g9
V17034
p41136
stp41137
a((dp41138
g2
(lp41139
VYes, there's a standard protocol, formulated by the Scale Manufacturer Association
p41140
aVThe spec download is here
p41141
aVWhether your actual scales follow that standard is an open question, check the small print in the datasheet or programming manual for them
p41142
aVIt is rarely a real problem, these protocols are easy with simple command/response strings
p41143
as(dp41144
g9
V17034
p41145
stp41146
a((dp41147
g2
(lp41148
VUse Fuslogvw
p41149
aVexe to troubleshoot this problem
p41150
aVIt shows you where the CLR looked for the assembly
p41151
as(dp41152
g9
V17034
p41153
stp41154
a((dp41155
g2
(lp41156
VModify your code by adding one line to the method:
p41157
aVIf my guess is right, you'll now see two forms
p41158
aVOne with the enabled label
p41159
aVNope, you can't create a reference to an existing form with the new operator
p41160
aVYou have to store that reference when you create the form so you can reuse it later
p41161
as(dp41162
g9
V17034
p41163
stp41164
a((dp41165
g2
(lp41166
VThis has try/catch abuse written all over it
p41167
aVAny of the conditions you mention for which you need a catch are actually bugs in your program
p41168
aVYou cannot fix a bug with a catch block, you can only hide the bug
p41169
aVThe user is still going to be pretty miffed about it, she can't use her old data anymore
p41170
aVThe end-result is the same whether you add a bunch of exception handling code or not: she's going to uninstall your update and send you a nasty email
p41171
aVIf for some reason it is acceptable that your update cannot read old data files anymore then tackle this at the root
p41172
aVAdd, say, a version number to the data so you can easily detect that the file is no longer usable
p41173
aVNo need to use an exception anymore
p41174
aVOr if it is easier to unwind the logic, you just need a single exception type
p41175
aVLeaving all other exceptions for which they were intended: "there's something really wrong here, let's not try to plod on"
p41176
as(dp41177
g9
V17034
p41178
stp41179
a((dp41180
g2
(lp41181
VDon't do this
p41182
aVIt doesn't look good
p41183
aVBut most of all, you'll never be sure that some kind of problem you'll have later isn't caused by this code
p41184
aVAnd you need all the help you can get to diagnose the inevitable threading races you'll run into sooner or later
p41185
aVThe really crappy kind of bugs, those that strike only once in a while and never repro when you try to debug the issue
p41186
aVThe less code that can be the source of such a problem, the better
p41187
aVYou tagged this with C# 4
p41188
aV0, the
p41189
aVNET 4
p41190
aV0 framework has excellent classes in the System
p41191
aVCollections
p41192
aVConcurrent namespace
p41193
aVThe BlockingCollection class was made to do what you're trying to do
p41194
aVIt hasn't just been verified and endlessly tested to never be subject to threading races, it has been engineered to not suffer from the hard threading problems
p41195
aVLike deadlock, starvation, priority inversion, lock convoys
p41196
aVThe kind of crap that makes you lose your hair
p41197
aVDisclaimer: I don't have a lot of hair left
p41198
as(dp41199
g9
V17034
p41200
stp41201
a((dp41202
g2
(lp41203
VTwo ways to handle this
p41204
aVYou need to make a list of prerequisites for your app
p41205
aVYou at least need to specify the minimum Windows version that you are willing to support
p41206
aVAnd you can add the requirement that the Windows install has the
p41207
aVNET framework version you need
p41208
aVThe vast majority of machines will meet this requirements list
p41209
aVOr you could create a Setup project for your app
p41210
aVThe bootstrapper that installs
p41211
aVNET will automatically be added, takes about 5 minutes to get this done
p41212
aVNot supported by the Express edition
p41213
as(dp41214
g9
V17034
p41215
stp41216
a((dp41217
g2
(lp41218
VThat cannot work in the general case, although it is not obvious where that WndProc is located
p41219
aVWindows is not going to supply the "this" pointer that an instance method needs when it makes the callback
p41220
aVYou are getting away with it right now because you don't access any members of the Form class in your Form::WndProc() method
p41221
aVIt works by accident without the virtual keyword but that luck will quickly run out once you start touching members
p41222
aVThat will bomb with an AccessViolation exception
p41223
aVYou need to make the Form::WndProc() method a static method
p41224
aVMaking it virtual is going to require you writing code that maps the HWND to a Form instance
p41225
aVThis is a pretty standard feature of any class library that wraps the Win32 API
p41226
aVThere's lots of value in not having to re-invent that wheel
p41227
as(dp41228
g9
V17034
p41229
stp41230
a((dp41231
g2
(lp41232
VThe calling convention for the function pointer is wrong
p41233
aVMake it look like this:
p41234
as(dp41235
g9
V17034
p41236
stp41237
a((dp41238
g2
(lp41239
VIt isn't clear from your description what your code looks like
p41240
aVBut heads up on your next problem after you get this one fixed: transparency effects for controls do not work in Windows Forms when controls overlap
p41241
aVYou'll see the background of the parent, you won't see the content of the picture box that's overlapped by your moving card
p41242
aVThis isn't a problem with WPF, it has a very different rendering model
p41243
aVBut as long as you want to stick with Windows Forms, you need to make this work with the form's OnPaint() event
p41244
aVDraw the card table, then the stock, then draw the moving card
p41245
aVWhen the card moves, call Invalidate() to force the form to be repainted, now showing the card in its new position
p41246
aVIn other words, don't fix your current problem
p41247
aVRedesign your program
p41248
as(dp41249
g9
V17034
p41250
stp41251
a((dp41252
g2
(lp41253
VYou are not going to be able to use it as long as it doesn't show up in the COM tab
p41254
aVThe regsvr32
p41255
aVexe utility is for DLLs, this however sounds like an EXE
p41256
aVIf it is a DLL then it needs to be registered with the 32-bit version of regsvr32
p41257
aVexe, the one in c:\u005cwindows\u005csyswow64
p41258
aVIf it is an EXE then the normal way to get it to register itself is by running it with the /regserver command line option
p41259
aVMumble
p41260
aVexe /RegServer
p41261
aVAdditionally, if this is a DLL or an EXE for which you don't have a 64-bit proxy/stub then you'll have to force your app to run in 32-bit mode
p41262
aVProject + Properties, Build tab, Platform Target = x86
p41263
aVIf all else fails, you really do need support from the vendor of this program
p41264
aVSurely they'll have an update available that is verified to work properly on 64-bit operating systems
p41265
aVIf they are no longer around, running this in a virtual machine is always a possibility
p41266
as(dp41267
g9
V17034
p41268
stp41269
a((dp41270
g2
(lp41271
VIt's got a COM automation layer, find it back in your Project + Add Reference, COM tab list
p41272
aVAPI documentation is here
p41273
aVDefinitely consider using System
p41274
aVNet
p41275
aVMail
p41276
aVSmtpClient instead
p41277
as(dp41278
g9
V17034
p41279
stp41280
a((dp41281
g2
(lp41282
VAs noted, a 32-bit integer can exist in two varieties
p41283
aVFour bytes anywhere in memory or a CPU register (not just the stack), the fast version
p41284
aVAnd it can be embedded in System
p41285
aVObject, the boxed version
p41286
aVThe declaration for System
p41287
aVInt32 is compatible with the latter
p41288
aVWhen boxed, it has the typical object header, followed by 4 bytes that stores the value
p41289
aVAnd those 4 bytes map exactly to the m_value member
p41290
aVMaybe you see why there's no conflict here: m_value is always the fast, non-boxed version
p41291
aVBecause there is no such thing as a boxed boxed integer
p41292
aVBoth the language compiler and the JIT compiler are keenly aware of the properties of an Int32
p41293
aVThe compiler is responsible for deciding when the integer needs to be boxed and unboxed, it generates the corresponding IL instructions to do so
p41294
aVAnd it knows what IL instructions are available that allows the integer to be operated on without boxing it first
p41295
aVReadily evident from the methods implemented by System
p41296
aVInt32, it doesn't have an override for operator==() for example
p41297
aVThat's done by the CEQ opcode
p41298
aVBut it does have an override for Equals(), required to override the Object
p41299
aVEquals() method when the integer is boxed
p41300
aVYour compiler needs to have that same kind of awareness
p41301
as(dp41302
g9
V17034
p41303
stp41304
a((dp41305
g2
(lp41306
VThis will happen when your control executes code while it is being used in the designer
p41307
aVIt does, stuff like the constructor, Load event, Paint event, etcetera will run when you drop the control on a form in Visual Studio
p41308
aVYou need to use the DesignMode property to prevent this code from running, and crashing, when the current working directory is wrong
p41309
aVIt will be wrong in the designer, the working directory is Visual Studio's, not the app's in which it will eventually be used
p41310
aVOr use absolute paths, not relative paths
p41311
aVIf that doesn't help, how to debug design time problems is explained here
p41312
as(dp41313
g9
V17034
p41314
stp41315
a((dp41316
g2
(lp41317
VUnfortunately you picked a bad example
p41318
aVThe x86 JIT compiler doesn't inline methods that return float
p41319
aVNot 100% sure why, I think it does to avoid consistently problems when the float is converted to an 80-bit floating point value in the FPU
p41320
aVInternal precision is 80-bits but those extra bits are sliced off when the 80-bit value is truncated back to a 32-bit value when it is flushed back to memory
p41321
aVKeeping the value in the FPU too long prevents this truncation from happening and changes the calculation result
p41322
aVIf you replace float by double and compile this code:
p41323
aVThen this machine code is generated when the JIT optimizer is enabled:
p41324
aVNot only did it inline the functions, it was able to evaluate the expressions at compile time
p41325
aVAnd directly passes the result by calling Console
p41326
aVWriteLine(8
p41327
aV0)
p41328
aVPretty good huh
p41329
aVUse double, not float
p41330
as(dp41331
g9
V17034
p41332
stp41333
a((dp41334
g2
(lp41335
VThis is possible by overriding WndProc() and catch the WM_ERASEBKGND message
p41336
aVThe control shown below does this
p41337
aVYou will however quickly find out why the Windows Forms TreeView class doesn't do this
p41338
aVWith the "smooth scrolling" system option turned on, you get very ugly artifacts
p41339
aVNot mentioning the lack of node text transparency
p41340
aVNo, there's no fix for that, only a complete replacement of the control that doesn't depend on the native Windows control can solve this problem
p41341
aVNot something you should normally consider, unless it is from a very reputable component vendor
p41342
as(dp41343
g9
V17034
p41344
stp41345
a((dp41346
g2
(lp41347
VThis is by design, an assembly stores metadata and IL, information that's language neutral
p41348
aVSo that you can easily mix and match code written in different languages
p41349
aVVery nice
p41350
aVNET feature
p41351
aVThe are hints though
p41352
aVA VB
p41353
aVNET programmer is likely to use VB
p41354
aVNET specific language features that are implemented in a helper assembly in the
p41355
aVNET framework
p41356
aVLike the My namespace and conversion operators like CType
p41357
aVOpen the assembly with Ildasm
p41358
aVexe and look at the manifest for the
p41359
aVassembly directives
p41360
aVIf you see one for Microsoft
p41361
aVVisualBasic then the odds are very high that this was written in VB
p41362
aVNET
p41363
aVIf it is missing then good odds for C#, although not conclusive
p41364
aVIf you look at the class list and see  at the top then you know for sure it was written in C++/CLI
p41365
aVMake sure you don't actually care about this
p41366
as(dp41367
g9
V17034
p41368
stp41369
a((dp41370
g2
(lp41371
VThe error code is STATUS_INVALID_IMAGE_FORMAT, "Mumble is either not designed to run on Windows or it contains an error
p41372
aVTry installing the program again using the original installation media or contact your system administrator or the software vendor for support
p41373
aVWhich is a bit outdated perhaps for the 64-bit version of Windows, the 90% odds are that your 32-bit program is trying to load a 64-bit DLL
p41374
aVThere's a lot that Windows does to prevent that from ever happening
p41375
aVFile system virtualization ensures that DLL loads from c:\u005cwindows\u005csystem32 are redirected to c:\u005cwindows\u005csyswow64, home of the 32-bit DLLs
p41376
aVRegistry virtualization ensures that COM servers are matched with the bit-ness of the COM client
p41377
aVThere's something you do that bypasses these counter-measures
p41378
aVMaybe you used SetDllDirectory()
p41379
aVOr you copied DLLs to the same folder as your EXE
p41380
aVOr you are hoping that the system's PATH environment variable helps your program find the right DLL
p41381
aVSomething like that, it isn't otherwise clear from your question
p41382
aVThere ought to be a record of it in the Windows event log (not 100% sure)
p41383
aVIf all else fails, SysInternals' ProcMon utility can show you what file it is trying to load
p41384
as(dp41385
g9
V17034
p41386
stp41387
a((dp41388
g2
(lp41389
VThat's a very poorly documented question
p41390
aVThe 80% odds: you are using a SQL-Lite version that contains native 32-bit code
p41391
aVThe regular version
p41392
aVProject + Properties, Build tab, Platform Target = x86
p41393
as(dp41394
g9
V17034
p41395
stp41396
a((dp41397
g2
(lp41398
VIt serves the exact same purpose as a name
p41399
aVA COM client can ask the system to create a COM object using a simple identifier (CoCreateInstance)
p41400
aVThat identifier has the scope of the full machine
p41401
aVDifferent chunks of code written by programmers that don't know each other and work for different companies live at that scope
p41402
aVThe problem with names is that people suck at picking good names
p41403
aVThe odds that one programmer picks the exact same name as another programmer, 3000 miles away and 5 years ago are high
p41404
aVNames like "Record", "Database" etc would be popular choices
p41405
aVEvident at this website too, lot's of users named "Jason" or "Mike"
p41406
aVThey don't mind, they know their own name when they review their profile
p41407
aVContext
p41408
aVImpossible for me to find them back though when they send me an email with just their user name, following up on a question with a generic subject string
p41409
aVGetting a name collision and COM creating the wrong object is disastrous
p41410
aVThe program stops working because it is getting a completely wrong object
p41411
aVFinding out why is difficult, the error message sucks
p41412
aVActually fixing the problem is impossible
p41413
aVCalling programmer B and ask him in the friendliest possible way to "pick a different name, somebody already picked yours" doesn't work
p41414
aVAutomatic response is "call programmer A instead"
p41415
aVThis is not a problem when you use a GUID instead of a name
p41416
aVThey are Globally Unique IDs
p41417
aVThe odds of getting a collision are astronomically small
p41418
as(dp41419
g9
V17034
p41420
stp41421
a((dp41422
g2
(lp41423
VThis is standard Windows User32 rendering behavior
p41424
aVThe form and most of the controls are individual windows
p41425
aVThey each get a WM_PAINT message to tell them that they need to paint themselves, those messages are delivered one-by-one to each window, in Z-order
p41426
aVWhen a control is slow to paint itself, that gets to be noticeable
p41427
aVThe unpainted rectangle of that control, and the ones after it, are visible for a brief moment
p41428
aVStandard double-buffering techniques available in Windows Forms cannot solve this problem, you'd have to double-buffer the entire form
p41429
aVThat's possible, my answer in this thread shows you how
p41430
as(dp41431
g9
V17034
p41432
stp41433
a((dp41434
g2
(lp41435
VMaking a control aware of its parent is normally a bad idea
p41436
aVThere however is a dedicated method to detect the parent BackColor changing, so it's okay:
p41437
as(dp41438
g9
V17034
p41439
stp41440
a((dp41441
g2
(lp41442
VNote that the windows also show up in the Alt+Tab bar
p41443
aVYou need to change the window style flags by overriding the CreateParams property
p41444
aVHere's a full example:
p41445
as(dp41446
g9
V17034
p41447
stp41448
a((dp41449
g2
(lp41450
VYou can get one with CreateDC for the display:
p41451
aVCleanup with DeleteDC()
p41452
aVIt is only used to initialize the palette for bitmaps with indexed format
p41453
aVNULL might work if you don't use such a format, never tried it
p41454
aVThen there's GDI+,  and the Bitmap class
p41455
as(dp41456
g9
V17034
p41457
stp41458
a((dp41459
g2
(lp41460
VThere's more, what if your library method is called from a worker thread
p41461
aVYou didn't tell why you need to know, preventing a good answer
p41462
aVOne approach is that the app that uses your library never has any trouble knowing whether its console or WPF
p41463
aVExpose a property to allow it to tell you
p41464
aVAnother is using events so the app can simply implement the event handler to its liking
p41465
aVDependency Injection is another
p41466
as(dp41467
g9
V17034
p41468
stp41469
a((dp41470
g2
(lp41471
VLook in the License
p41472
aVtxt file, stored in the Microsoft Visual Studio 2010 - XXX subdirectory of the install directory
p41473
aVSection 3
p41474
aVIt used to be spelled out plainly in previous editions but the license text has changed significantly in the VS2010 Ultimate RTM edition
p41475
aVNot to mention it has been formatted in an impossible-to-read way
p41476
aVI cannot tell anymore if I'm entitled to use it for my own products, and I've got the retail edition
p41477
aVGood luck
p41478
as(dp41479
g9
V17034
p41480
stp41481
a((dp41482
g2
(lp41483
VThere's no compelling reason to not just simply iterate the text boxes and calculate the result
p41484
aVThis code runs at human time, she can't tell the difference between a microsecond and millisecond
p41485
aVNow you can have one Leave event handler for all text boxes
p41486
aVTextChanged would work too, but is a wee disorienting
p41487
as(dp41488
g9
V17034
p41489
stp41490
a((dp41491
g2
(lp41492
VA cache without an expiration policy is a memory leak
p41493
aVWhatever policy you come up with is going to affect the Add() method
p41494
aVYou have to wrap that method to initialize stuff that lets your expiration logic work
p41495
aVYou can't just let the client code manipulate the collection directly
p41496
aVSo, yes, create a class wrapper
p41497
as(dp41498
g9
V17034
p41499
stp41500
a((dp41501
g2
(lp41502
VYes, it is used by anybody that compiles a program that doesn't run with the desktop version of the CLR
p41503
aVLike Silverlight or the Micro Framework
p41504
aVThey have their own mscorlib
p41505
aVdll, of course with System
p41506
aVObject defined
p41507
aVHere's the compiler command line of a sample Silverlight project:
p41508
as(dp41509
g9
V17034
p41510
stp41511
a((dp41512
g2
(lp41513
V"Memory usage" as displayed by tools like Taskmgr
p41514
aVexe or ProcExp
p41515
aVexe tells you squat about the actual memory in use by a program
p41516
aVWhen virtual memory is released by the garbage collector, the free space is almost never returned to the operating system
p41517
aVIt gets added to a list of free blocks, ready for re-use by the next allocation
p41518
aVThe odds that the free blocks coalesce back into a range of pages that can be freed are quite small
p41519
aVThis is never a real problem, this is virtual memory
p41520
aVAnother way to make you feel good quickly is to minimize the main window of the program
p41521
aVThat trims the working set, the amount of RAM in use
p41522
as(dp41523
g9
V17034
p41524
stp41525
a((dp41526
g2
(lp41527
VYou could store the original position in the Tag property
p41528
aVSome logic is required because neither page 1 nor 3 might be present
p41529
aVThis ought to be close:
p41530
as(dp41531
g9
V17034
p41532
stp41533
a((dp41534
g2
(lp41535
VI'm fairly sure it uses normal registry file associations
p41536
aVThe HKCR\u005cVisualStudio
p41537
aVcs
p41538
aV10\u005cDefaultIcon key value is C:\u005cProgram Files\u005cMicrosoft Visual Studio 10
p41539
aV0\u005cVC#\u005cVCSPackages\u005ccsproj
p41540
aVdll,1  The 2nd icon in the file with size 16x16 is indeed the icon I see in in the Solution Explorer window
p41541
aVBackup the key value and change it to your own icon
p41542
aVRestart VS
p41543
as(dp41544
g9
V17034
p41545
stp41546
a((dp41547
g2
(lp41548
VIt isn't predefined because it is expensive
p41549
aVIf you know your list is short then just implement the obvious overrides
p41550
aVIf not, you'll have to come up with some kind of heuristic for at least GetHashCode
p41551
aVSay, GetHashCode of only the first couple of elements xor-ed together with the Length
p41552
as(dp41553
g9
V17034
p41554
stp41555
a((dp41556
g2
(lp41557
VThere can only ever be one base class, no MI in
p41558
aVNET, Type
p41559
aVBaseType
p41560
aVThere can be many interfaces, Type
p41561
aVGetInterfaces()
p41562
aVGluing them together in your preferred format is up to you
p41563
as(dp41564
g9
V17034
p41565
stp41566
a((dp41567
g2
(lp41568
VThe CLR maintains several heaps associated with an AppDomain, collectively called "loader heaps"
p41569
aVThey are distinct from the garbage collected heap since they don't contain collectable objects, mostly type related data
p41570
aVThe kind of data that's around for the lifetime of an AppDomain
p41571
aVSpace for static variables is allocated in one of them, the HighFrequencyHeap
p41572
aVThe JIT compiler makes the allocation, the code it generates directly references the memory location
p41573
aVBackground info is in this MSDN Magazine article
p41574
as(dp41575
g9
V17034
p41576
stp41577
a((dp41578
g2
(lp41579
VSome background info on this behavior: Bitmap uses a memory-mapped file to access the pixels in the bitmap
p41580
aVThat's a very basic facility in the Windows API, it allows very efficient mapping of memory to file data
p41581
aVData is read from the file only when the program read the memory, the virtual memory pages don't take any space in the Windows paging file
p41582
aVThe exact same mechanism is used to load
p41583
aVNET assemblies
p41584
aVIt is the memory mapping that puts a lock on the file
p41585
aVWhich is basically why assemblies are locked when they are used in a
p41586
aVNET program
p41587
aVThe Image
p41588
aVDispose() method releases the lock
p41589
aVFighting the lock often indicates that you are forgetting to dispose your bitmaps
p41590
aVVery important, forgetting to call Dispose() doesn't often cause problems for
p41591
aVNET classes, except for Bitmap since it can need so much (unmanaged) memory
p41592
aVYes, FromStream() prevents the class from making this optimization
p41593
aVThe cost is significant, you'll need double the memory when the bitmap is loaded
p41594
aVThis will be a problem when the bitmap is large, you're skirting OOM when the program has been running for a while (fragmenting the address space) and its not running on a 64-bit operating system
p41595
aVDefinitely avoid doing this if the bitmap's Width x Height x 4 >= 45 MB, give or take
p41596
aVSome code, you don't have to jump through the CopyStream hoop:
p41597
aVNote that you don't want to dispose the MemoryStream, you'll get a hard to diagnose "generic error" when the bitmap gets used if you do
p41598
aVCaused by the Image class lazy-reading the stream
p41599
as(dp41600
g9
V17034
p41601
stp41602
a((dp41603
g2
(lp41604
VACTIVEOBJECT_WEAK is your problem here
p41605
aVFrom the RegisterActiveObject docs:
p41606
aVWeak registration keeps a pointer to the object in the running object table, but does not increment the reference count
p41607
aVConsequently, when the last external connection to a weakly registered object disappears, OLE releases the object's stub, and the object itself is no longer available
p41608
aVWhich is exactly what's happening in your program
p41609
aVTrivially solve the problem with ACTIVEOBJECT_STRONG
p41610
as(dp41611
g9
V17034
p41612
stp41613
a((dp41614
g2
(lp41615
VThe background color for a tool tip is a system color setting, you cannot reasonably change that setting
p41616
aVYou can alter the appearance yourself by setting the ToolTip
p41617
aVDrawMode property
p41618
aVA good example of the Draw event handler you'll need is in the MSDN library topic for that event
p41619
aVThe next obstacle is definitely the harder one
p41620
aVThe tooltip control that displays tips for nodes is built into the native Windows control, you cannot replace it
p41621
aVYou'll have to give up on the TreeNode
p41622
aVToolTipText property and store it elsewhere
p41623
aVLike the Tag property, or generate it on-the-fly
p41624
aVThen you need to wire into the TreeView's MouseMove event and use its HitTest() method to find out where the mouse is located
p41625
aVToggle a Timer's Enabled property when the mouse is moved
p41626
aVUse the Tick event to call the ToolTip
p41627
aVShow() method
p41628
aVAnd wire MouseLeave to turn everything off
p41629
aVQuite possible, falls in the "when there's a will, there's a way" category
p41630
as(dp41631
g9
V17034
p41632
stp41633
a((dp41634
g2
(lp41635
VYou are correct, swapping the declarations is required to keep MIDL happy
p41636
aVOleView
p41637
aVexe indeed won't generate declarations in the original order
p41638
aVI think it groups them by kind, the way the type lib is organized
p41639
aVThe message you are getting is just a warning, not an error
p41640
aVIt is caused by having an alias for the structure name that's different
p41641
aVYou can safely ignore it because code won't use the "tagImportFileResult" identifier
p41642
aVBut you can get rid of it by making the tag name the same as the typedef name:
p41643
aVHere's a KB article on the subject
p41644
as(dp41645
g9
V17034
p41646
stp41647
a((dp41648
g2
(lp41649
VThere's a typo in your code
p41650
aVFix:
p41651
aVPicking good names avoid half the bugs
p41652
aVI'd recommend "devices"
p41653
as(dp41654
g9
V17034
p41655
stp41656
a((dp41657
g2
(lp41658
VYou'd need to use ReadConsoleOutput()
p41659
aVBeware of the ambiguity in a coordinate like (10, 5)
p41660
aVIt could be relative from the console window upper-left corner
p41661
aVOr from the screen buffer
p41662
aVYou'd probably need to make the buffer size the same as the window size to avoid this
p41663
aVSetConsoleScreenBufferSize()
p41664
aVThese console functions are not wrapped by the C-runtime
p41665
aVThe SDK documentation is quite decent, start here
p41666
as(dp41667
g9
V17034
p41668
stp41669
a((dp41670
g2
(lp41671
Vwith foreign characters for example 'Felvid\u0192k Ma'
p41672
aVThat's where your real trouble starts, there's little you can do afterwards to fix this problem
p41673
aVIt isn't clear how you got the string, but it was created from the http stream without paying attention to the web page encoding
p41674
aVHttpResponse
p41675
aVContentEncoding for example
p41676
aVOnce you get this right, everything else is simple
p41677
aVNo need to convert anything, what you write to the dbase is the actual text
p41678
aVIf you cannot figure this out, be sure to update your question with details that describe how you got the _html string value
p41679
as(dp41680
g9
V17034
p41681
stp41682
a((dp41683
g2
(lp41684
VProject + Properties, Build tab, Platform Target = x86
p41685
aVYour C/C++ DLL was compiled in 32-bit mode
p41686
aVBut your C# program is running on a 64-bit version of Windows and will run in 64-bit mode
p41687
aVThat mix don't match
p41688
aVCreating a 64-bit version of you DLL is another solution
p41689
aVBuild + Configuration Manager, Platform combo, New, x64
p41690
as(dp41691
g9
V17034
p41692
stp41693
a((dp41694
g2
(lp41695
VThere is no clean solution for this
p41696
aVYour panel trick doesn't work either, it will be completely missed when the user moves the mouse quickly
p41697
aVPunt
p41698
aVOnce you get MouseEnter, start a 200 msec Timer
p41699
aVIn the Tick event, check if the mouse is still hovering the tree view
p41700
aVFor example:
p41701
aVThe Application
p41702
aVIdle event works too btw, just a wee bit more awkward
p41703
as(dp41704
g9
V17034
p41705
stp41706
a((dp41707
g2
(lp41708
VSome code to get you started
p41709
aVThe key is to respond to the WM_SIZING message, it allows you to change the window rectangle
p41710
aVThis sample is crude, you really want to pay attention to which corner or edge is being dragged by the user, available from m
p41711
aVWParam
p41712
aVThe user interface will never be great, you can't really do anything reasonable when the user drags a corner
p41713
aVMaking your form's layout flexible enough so you don't care about aspect ration is the real solution
p41714
aVDisplaying a scrollbar when the content doesn't fit pretty much lets the user do the Right Thing automatically
p41715
as(dp41716
g9
V17034
p41717
stp41718
a((dp41719
g2
(lp41720
VThere's something else going on
p41721
aVThe benchmark is critically dependent on the
p41722
aVNET Platform Target you select
p41723
aVI do repro the results for
p41724
aVNET 4
p41725
aV0 but
p41726
aVNET 3
p41727
aV5 is consistently faster on the generated version, regardless of the build type
p41728
aVGuessing what might have changed in 4
p41729
aV0 to make it so much slower is too difficult, this is not easy code to analyze
p41730
aVAnd expression tree support has significantly changed
p41731
aVI recommend you post feedback to connect
p41732
aVmicrosoft
p41733
aVcom, do expect a "by design" response
p41734
aVHopefully annotated
p41735
as(dp41736
g9
V17034
p41737
stp41738
a((dp41739
g2
(lp41740
VOnce a form contains a child control that can receive the focus (in other words, not a picture box) then the form can no longer receive the focus
p41741
aVAnd thus won't get keyboard messages anymore, they'll go to the control with the focus
p41742
aVA quick fix is to set the form's KeyPreview property to True
p41743
as(dp41744
g9
V17034
p41745
stp41746
a((dp41747
g2
(lp41748
VThere is very little point in targeting the client profile for
p41749
aVNET 4
p41750
ag2512
aVThe download is 41MB, the full version is 48MB, only 15% bigger
p41751
aVUnfortunately it is the default in VS2010, just change it with Project + Properties, Application tab, Target framework combo
p41752
aVThe client profile does make a lot of sense if you target 3
p41753
aV5, the full install is ~350 MB
p41754
aVThe huge difference is explained by the prerequisites,
p41755
aVNET 4
p41756
aV0 requires at least XP SP3 or Vista SP1
p41757
aVBut 3
p41758
aV5 installs on any version of Windows > 2000
p41759
aVThe 3
p41760
aV5 installer thus contains lots of the required updates for unmanaged Windows components used by
p41761
aVNET
p41762
aVThe web installer lessens that blow considerably btw
p41763
as(dp41764
g9
V17034
p41765
stp41766
a((dp41767
g2
(lp41768
VIt's an easy call
p41769
aVGetting a NULL pointer when none is expected is a clear sign of a bug in the program or a severely compromised program state
p41770
aVEither of which is going to require the programmer to do something about it
p41771
aVThrowing an exception will only ever work out well if it isn't caught
p41772
aVIf it is caught you lose very important diagnostic information, it throws away the all-important call stack that helps you find out how it got into that state
p41773
aVIf it is not caught then there's no appreciable difference between the C++ exception and the hardware exception
p41774
aVThe risk that the exception might be caught somewhere demands that you don't throw an exception and just let it die
p41775
aVThis consideration is very different for a runtime environment that can produce the call stack after the exception is caught
p41776
aVCommon in managed environments, not in native C/C++
p41777
as(dp41778
g9
V17034
p41779
stp41780
a((dp41781
g2
(lp41782
VThis is a normal side-effect of resampling the image with the InterpolationMode set to a high quality value, like Bicubic
p41783
aVThis subtly alters the pixel values of just about every pixel, especially since jpeg decompression produces subtle noise in the image
p41784
aVBarely visible to the human eye, quite visible to the resampling filter
p41785
aVGiving the jpeg encoder a much harder time compressing the image
p41786
aVOnly starting out with a non-compressed image format, like PNG, can improve the outcome
p41787
as(dp41788
g9
V17034
p41789
stp41790
a((dp41791
g2
(lp41792
VThat requires overriding the control's IsInputKey() method
p41793
aVQuite a bit of additional surgery is required to let the picture box get the focus in the first place
p41794
aVStart by adding a new class to your project, make it look similar to this:
p41795
aVThis ensures that the control can get the focus and can be tabbed to
p41796
aVNext, you'll have to undo the attributes for the TabStop and TabIndex properties so the user can set the tab order:
p41797
aVNext, you have to make it clear to the user that the control has the focus so she'll know what to expect when operating the cursor keys:
p41798
aVAnd finally you override IsInputKey() so that the control can see the arrow keys:
p41799
aVCompile
p41800
aVDrop the new control from the top of the toolbox onto your form
p41801
as(dp41802
g9
V17034
p41803
stp41804
a((dp41805
g2
(lp41806
VIt doesn't matter what it returns
p41807
aVEither value will map to the same folder, file system virtualization will always map it to (x86) for a 32-bit app
p41808
as(dp41809
g9
V17034
p41810
stp41811
a((dp41812
g2
(lp41813
VFrom the Registers window, select the EAX register value and hit Ctrl+C
p41814
aVDebug + Windows + Memory + Memory 1
p41815
aVIn the Address text box, type 0x, Ctrl+V, type +12
p41816
aVThe +12 skips the System
p41817
aVObject header
p41818
aVYou should have little trouble reading it on the right if it contains ASCII characters, ignore the nulls
p41819
as(dp41820
g9
V17034
p41821
stp41822
a((dp41823
g2
(lp41824
VYour code is correct, you've implemented it exactly like it is documented in the MSDN library
p41825
aVYou'll need to take a second look though
p41826
aVReason what happens when the destructor (aka finalizer) runs
p41827
aVThe disposing argument will be false, the protected Dispose method does nothing
p41828
aVThis is entirely normal, finalizers should only ever release unmanaged resources
p41829
aVYou don't have any
p41830
aVIt is extraordinary rare to ever have an unmanaged resource in your own code
p41831
aVThey belong in the nice wrapper classes available in
p41832
aVNET to turn an unmanaged operating resource into a nice managed class
p41833
aVIf you find yourself thinking you need a finalizer, you'll be wrong 99
p41834
aV99% of the time
p41835
aVEven if you do wrap an unmanaged resource, you should use one of the SafeHandle wrappers
p41836
aVAnd rely on their finalizers
p41837
aVOkay, you want to get rid of the destructor
p41838
aVIt isn't healthy to leave it in, it keeps the object in memory longer than necessary
p41839
aVWhen you do, you'll cut it down to:
p41840
aVWhich is the boiler-plate implementation of most any Dispose() method, just call the Dispose method of members of the class
p41841
aVYou can completely omit it if you don't have any members with a Dispose() method
p41842
aVNext, you do misunderstand how the Dispose() method gets called
p41843
aVIt is not automatic
p41844
aVWhich is the point of having it in the first place, releasing resources automatically is already taken care of by the garbage collector
p41845
aVThe Dispose() method is there for you to call, either with the using statement or calling it directly
p41846
aVSo that you can release the resource early instead of waiting for the garbage collector finalizer thread to get around to it
p41847
aVWhich can take a while
p41848
aVCall it when you know that your program won't be using the object anymore
p41849
aVIf your DataSet is actively used by the form then you cannot dispose it until the form closes
p41850
aVCall the class' Dispose() method in a FormClosed event handler
p41851
aVOr, better, open the form's Designer
p41852
aVcs file, cut-and-paste the Dispose() method you find in there and move it to the form's source code file
p41853
aVAnd add the dispose call
p41854
aVI know that's a bit confuzzling, but the only time it's okay to edit the designer file
p41855
as(dp41856
g9
V17034
p41857
stp41858
a((dp41859
g2
(lp41860
VIt is a wrapper for the native Windows button control as well
p41861
aVIn a nutshell:
p41862
aV0x00f5 = BM_CLICK: run OnClick()
p41863
aV0x2111 = BN_CLICKED notification : run OnClick()
p41864
aVa bunch of workarounds to deal with OwnerDraw
p41865
aVYou don't have to worry about any of this since you don't wrap a native button and don't need owner draw
p41866
aVDo make sure you implement IButtonControl so your button behaves properly when Enter and Escape is pressed and it is selected as the form's Accept/CancelButton
p41867
aVNot strictly necessary, but it is automatic when you inherit from ButtonBase instead of Control
p41868
as(dp41869
g9
V17034
p41870
stp41871
a((dp41872
g2
(lp41873
VIt's pretty straight-forward, just call DoDragDrop in a MouseDown event
p41874
aVYou'll need actual files on disk for this to work
p41875
as(dp41876
g9
V17034
p41877
stp41878
a((dp41879
g2
(lp41880
VWindows doesn't send the mouse scroll message to the control that's hovered, it goes to the control with the focus
p41881
aVYou already know how to fix the focus
p41882
aVThis behavior is getting unintuitive because of the way browsers and Office programs work
p41883
aVYou'll find code to alter this in my answer in this thread
p41884
aVBeware that it works on any window in your app
p41885
aVYou'll have to add filtering on the handle value if that's undesirable
p41886
as(dp41887
g9
V17034
p41888
stp41889
a((dp41890
g2
(lp41891
VRunning the 64-bit version of Windows 7
p41892
aVUsing the 32-bit version of gflags
p41893
aVexe
p41894
aVYou can also edit the registry directly
p41895
aVAn example
p41896
aVreg file for notepad
p41897
aVexe:
p41898
as(dp41899
g9
V17034
p41900
stp41901
a((dp41902
g2
(lp41903
VWell, it is certainly not unheard of for services to remove access rights so that even an administrator cannot open the process
p41904
aVA service has enough privileges to do so, DRM components like audiodg
p41905
aVexe readily do so
p41906
aVA mouse pad helper doesn't strike me as something that would require such protection
p41907
aVBut what the hey, why would anybody ever need to mess with a mouse pad helper
p41908
as(dp41909
g9
V17034
p41910
stp41911
a((dp41912
g2
(lp41913
VUse the MessageBox
p41914
aVShow() overload that takes a MessageBoxDefaultButton argument
p41915
aVOr just invert the question
p41916
as(dp41917
g9
V17034
p41918
stp41919
a((dp41920
g2
(lp41921
VThere's a pretty fundamental difference, push vs pull
p41922
aVThe pull model (yield) being the harder one to implement from the instrument interface view
p41923
aVBecause you'll have to store data until the client code is ready to pull
p41924
aVWhen you push, the client may or may not store, as it deems necessary
p41925
aVBut most practical implementations in multi-threading scenarios need to deal with the overhead in the inevitable thread context switch that's required to present data
p41926
aVAnd that's often done with pull, using a thread-safe bounded queue
p41927
as(dp41928
g9
V17034
p41929
stp41930
a((dp41931
g2
(lp41932
VThe separation goes all the way back to the disk, the metadata for a file is stored in a distinct location from the file data
p41933
aVA "directory entry" in Windows
p41934
aVIt is otherwise the job of the operating system to maintain this data
p41935
aVThose dates are automatically updated when you create or write the file
p41936
aVRead them back in a program with the FileInfo class
p41937
as(dp41938
g9
V17034
p41939
stp41940
a((dp41941
g2
(lp41942
VOf course, you should always pick ONE, it is much more readable
p41943
aVThat it is faster by a fraction of a nanosecond isn't an accident, readable code often is
p41944
as(dp41945
g9
V17034
p41946
stp41947
a((dp41948
g2
(lp41949
VYou don't need a variable, you could iterate the MdiChildren collection to see if the form is already opened
p41950
aVFor example:
p41951
aVThe VB
p41952
aVNET-centric solution:
p41953
as(dp41954
g9
V17034
p41955
stp41956
a((dp41957
g2
(lp41958
VNo, generics were specifically designed to make code faster
p41959
aVJust as fast as hard-coding the types
p41960
aVQuicker than the alternative, using Object, since you can avoid boxing value types and don't have to cast
p41961
aVA delegate call is slower than a direct method call
p41962
aVBut it is still very, very fast
p41963
aVYou'd have to call it a billion times to notice the difference
p41964
aVAre you aware of the BinaryFormatter class
p41965
aVIt already does this
p41966
as(dp41967
g9
V17034
p41968
stp41969
a((dp41970
g2
(lp41971
VThat's okay, but you don't store a reference to the CustomContext object you created
p41972
aVThere's thus no way to call its ExitThread method
p41973
aVTweak it like this:
p41974
aVNow you can simply call Program
p41975
aVQuit() to stop the message loop
p41976
aVCheck my answer in this thread for a better way to implement a single-instance app
p41977
aVThe WindowsFormsApplicationBase class also offers the ShutdownStyle property, probably useful to you instead of ApplicationContext
p41978
as(dp41979
g9
V17034
p41980
stp41981
a((dp41982
g2
(lp41983
VException code: 0xe053534f
p41984
aVAlways inspiring when the problem has something to do with this site's name
p41985
aVMicrosoft programmers often pick exception codes that can be decoded to a 3 letter acronym
p41986
aVThe exception code for a C++ exception is 0xe04d5343, the last 3 hex bytes decode to "MSC", Microsoft C++
p41987
aVThe exception code for a managed exception is 0xe0434f4d, "COM+" which was the early name for
p41988
aVNET
p41989
aVGive your exception the same treatment and you'll get "SSO"
p41990
aVWhich means "soft stack overflow"
p41991
aVThat is the exact same thing as a regular stack overflow, except that the system can predict it up front
p41992
aVIt knows that, if it completes the call, the program will bomb because there is not enough stack space left
p41993
aVExactly why your app is bombing on a stack overflow isn't clear from the info you provided
p41994
aVYou'll have to debug it
p41995
as(dp41996
g9
V17034
p41997
stp41998
a((dp41999
g2
(lp42000
VBackspace is an important editing key for the user, don't mess with it
p42001
aVPress Tab to move forward, Shift+Tab to move backward
p42002
aVYour user is likely to already know this shortcut
p42003
as(dp42004
g9
V17034
p42005
stp42006
a((dp42007
g2
(lp42008
VYou have a dependency on a component that won't be available by default, you have to install it
p42009
aVExpression Encoder comes in two versions
p42010
aVThe free version is available for download from here
p42011
aVDo note the restrictions, it doesn't support smooth streaming or encode to H
p42012
aV264
p42013
aVFollow the link in the download page to the retail edition if this is a problem
p42014
aVJust installing Blend on the machine would probably solve it too, but that would surely be a "security" problem as well
p42015
as(dp42016
g9
V17034
p42017
stp42018
a((dp42019
g2
(lp42020
VIt is bombing trying to compile the XAML in the project
p42021
aVIgnore the remark about ReflectionOnlyAssemblyResolve event in the message, that's just it trying to be helpful to solve the problem
p42022
aVThe real issue is that it simply cannot find the assembly
p42023
aVThat's to be expected, Microsoft
p42024
aVWindows
p42025
aVDesign
p42026
aVExtensibility is a Visual Studio assembly, stored in the Common7\u005cIDE\u005cPublicAssemblies folder
p42027
aVIt could only be found if that folder is in the probing path, it surely won't be if you run msbuild
p42028
aVexe from a build tool
p42029
aVNot sure what to recommend, you'll have to find out where that dependency comes from
p42030
aVThat probably ought to start at the
p42031
aVxaml file content, search for the assembly name
p42032
aVAlso verify that the problem reproduces when you run msbuild
p42033
aVexe from the Visual Studio Command Prompt
p42034
as(dp42035
g9
V17034
p42036
stp42037
a((dp42038
g2
(lp42039
VLike most bin-packing problems this one looks like an NP-hard problem to me
p42040
aVWith 2 rectangles, there are 8
p42041
aV(= 40320) possible arrangements you need to consider
p42042
aVThree rectangles produces 12
p42043
aVpossibilities, a cool 480 million
p42044
aVYou'll need an heuristic to make this computable
p42045
aVBeyond favoring the outer edges of the rectangles closest to the bounding rectangle, I don't see a good one
p42046
aVYou'd need tighter requirements on the resulting rectangles you accept, the number of them isn't going to help
p42047
aVGlad this is not my problem :)
p42048
as(dp42049
g9
V17034
p42050
stp42051
a((dp42052
g2
(lp42053
VYes, this is a problem with the app or camera that originated the image
p42054
aVThe EXIF standard has horrible support for text, it has to be encoded in ASCII
p42055
aVThat only ever works out well when the photographer speaks English
p42056
aVNo doubt the software that encoded the image is ignoring this requirement
p42057
aVWhich is what the PropertyItem class is doing as well, it encodes a string to byte[] with Marshal
p42058
aVStringToHGlobalAnsi(), which assumes the system's default code page
p42059
aVThere's no obvious fix for this, you'll get mojibake when the photo was made too far away from your machine
p42060
as(dp42061
g9
V17034
p42062
stp42063
a((dp42064
g2
(lp42065
VYou are assuming that the memory usage should not increase
p42066
aVWrong assumption, that's just not how either the
p42067
aVNET garbage collector or the Windows heap manager work
p42068
aVBoth of them work efficiently by using memory that's available for use instead of constantly releasing and reallocating memory
p42069
aVLet it run for a week
p42070
aVMight go quicker if you make the Interval smaller
p42071
aVAlso minimize the form for spectacular effects
p42072
as(dp42073
g9
V17034
p42074
stp42075
a((dp42076
g2
(lp42077
VWord will prompt the user when there's a minor problem with the document
p42078
aVThat prompt will be displayed on the desktop for services in your case, where nobody can hear it scream
p42079
aVAnd preventing the Open() method call from completing
p42080
aVBe sure to set the OpenAndRepair argument of the Open() method to True so this is dealt with automatically without prompting the user
p42081
as(dp42082
g9
V17034
p42083
stp42084
a((dp42085
g2
(lp42086
VYes, this is a bug introduced by the Vista version of the native TreeView control
p42087
aVWhen it sees the double-click event, it will automatic toggle the check state of the item
p42088
aVWithout telling the
p42089
aVNET TreeView wrapper about it, the Before/AfterCheck event won't run
p42090
aVThis hasn't been fixed in the
p42091
aVNET wrapper and probably never will
p42092
aVWorking around this bug requires preventing the native control from seeing the double-click message
p42093
aVAdd a new class to your project and paste the code shown below
p42094
aVCompile
p42095
aVDrop the new control from the top of the toolbox onto your form, replacing the existing TreeView
p42096
as(dp42097
g9
V17034
p42098
stp42099
a((dp42100
g2
(lp42101
VThe accuracy of timeGetTime() is variable, based on the last used timeBeginPeriod
p42102
aVIt will never be better than one millisecond
p42103
aVQueryPerformanceCounter is variable too, depending on hardware support
p42104
aVIt will never be worse than about a microsecond
p42105
aVNeither of them have notable overhead, QPC is probably a bit heavier
p42106
aVWhether that's significant to you is quite unclear from your question
p42107
aVI doubt it, but measure
p42108
aVWith QPC
p42109
as(dp42110
g9
V17034
p42111
stp42112
a((dp42113
g2
(lp42114
VThe linked source code is missing the sources
p42115
aVinc file which makes it difficult to get this built with a recent version of the WDK
p42116
aVThe included
p42117
aVbat files are quite useless, they can only work on the author's machine
p42118
aVI got a clean build using the following steps with WDK version 6001
p42119
aV18002:
p42120
aVunzip the
p42121
aVcab file to c:\u005ctemp\u005cdvorak
p42122
aVnavigate to WDK's src\u005cinput\u005clayout folder
p42123
aVcopy the sources
p42124
aVinc file to c:\u005ctemp
p42125
aVedit kbddvp
p42126
aVc and comment the #define WIN32_LEAN_AND_MEAN directive
p42127
aVStart + All Programs, Windows Driver Kits, WDK xxx
p42128
aVxxx, Build Environments, Windows Vista, blabla x86 free
p42129
aVPick your own here
p42130
aVcd c:\u005ctemp\u005cdvorak
p42131
aVnmake
p42132
aVDoesn't take long, clean build
p42133
aVNo actual test, being equipped with two left hands
p42134
aVThe sources
p42135
aVinc file you need:
p42136
as(dp42137
g9
V17034
p42138
stp42139
a((dp42140
g2
(lp42141
VThere is an enormous amount of code that runs when you assign a Label's Text property
p42142
aVBoth in the
p42143
aVNET framework and in Windows itself
p42144
aVVery nice of Windows Forms to not force you to write that kind of code, or even see it
p42145
aVBut it is there and the golden rule for enormous amounts of code is that it is enormously not thread-safe
p42146
aVThere is no GUI framework in the world that is
p42147
aVCold hard rule is that you must only ever touch the properties of a control on the thread that created it
p42148
aVWhich is what Control
p42149
aVBegin/Invoke() helps you do
p42150
aVWhat you ended up with is however quite fugly
p42151
aVThere's no benefit to BeginInvoke for each individual label
p42152
aVYou only need one, a single method that sets all labels
p42153
aVIt will be not only cleaner, but also a lot less expensive
p42154
aVYour delegate declaration should look like
p42155
aVwhere Mumble is the class of the AddressItems[0] element
p42156
aVUsing the BackgroundWorker class usually makes you write code like that automatically
p42157
aVRecommended
p42158
as(dp42159
g9
V17034
p42160
stp42161
a((dp42162
g2
(lp42163
VControl vendors can't make any money with controls like that
p42164
aVHere's some code to get your started:
p42165
as(dp42166
g9
V17034
p42167
stp42168
a((dp42169
g2
(lp42170
VThe error message indicates that it can actually open the file, but then finds the file empty or corrupted
p42171
aVRenaming the folder ensures that the user
p42172
aVconfig file gets recreated, that will indeed solve the problem
p42173
aVIf you can't find it back then there's something pretty icky going on with your file system
p42174
aVHigh time to run a thorough disk scan
p42175
aVDon't quite remember how for XP, chkdsk
p42176
aVexe or scandisk
p42177
aVexe, something like that
p42178
aVAsk at superuser
p42179
aVcom
p42180
as(dp42181
g9
V17034
p42182
stp42183
a((dp42184
g2
(lp42185
VWell, this is just the way it works
p42186
aVYou've only declared the static member in the
p42187
aVh file
p42188
aVThe linker needs to be able to find exactly one definition of that static member in the object files it links together
p42189
aVYou can't put the definition in the
p42190
aVh file, that would generate multiple definitions
p42191
as(dp42192
g9
V17034
p42193
stp42194
a((dp42195
g2
(lp42196
VYeah, it is a bit out-of-place today
p42197
aVIt is the managed declaration of the COM interface type
p42198
aVAlso present, note ComTypes
p42199
aVIExpando and InteropServices
p42200
aVUCOMIExpando
p42201
aVCore interfaces for scripting runtimes to implement property bags
p42202
aVIn particular for Javascript, check this thread
p42203
aVMicrosoft had high hopes for JScript, it was a primary language supported along-side C#, VB
p42204
aVNET and Managed C++
p42205
aVThat didn't work out
p42206
aVForgotten, but not quite dead
p42207
aVThe ExpandoObject class is back in
p42208
aVNET 4
p42209
ag2512
as(dp42210
g9
V17034
p42211
stp42212
a((dp42213
g2
(lp42214
VYes, this cannot work by design
p42215
aVThe base
p42216
aVMethodA() call makes a non-virtual call to a virtual method
p42217
aVThe compiler has little trouble emitting the IL for this in the non-dynamic case since it knows what specific method needs to be called
p42218
aVThat's not the case for dynamic dispatch
p42219
aVIt is the job of the DLR to figure out which specific method needs to be called
p42220
aVWhat it has to work with is the MethodTable of the Derived class
p42221
aVThat table does not contain the address of the base class' MethodA method
p42222
aVIt was overwritten by the override
p42223
aVAll it can possibly do is call the Derived
p42224
aVMethodA() method
p42225
aVWhich violates the base keyword contract
p42226
as(dp42227
g9
V17034
p42228
stp42229
a((dp42230
g2
(lp42231
VAt the very minimum, you'll have to declare your variable with the volatile keyword
p42232
aVBut the best way to do it is to use an event
p42233
aVCreateEvent() to initialize it, SetEvent() to signal the stop condition, WaitForSingleObject() with a 0 timeout to test it
p42234
as(dp42235
g9
V17034
p42236
stp42237
a((dp42238
g2
(lp42239
VYou probably forgot to deploy the runtime support DLLs or copied the Debug build of your program
p42240
aVFor a small program like this without DLLs that export C++ classes or pointers it is better to link the static version of the CRT
p42241
aVProject + Properties, C/C++, Code Generation, /MTd
p42242
aVRepeat for the Release configuration, now choose /MT
p42243
as(dp42244
g9
V17034
p42245
stp42246
a((dp42247
g2
(lp42248
VThis is the ExecutionEngineException from the earlier
p42249
aVNET days
p42250
aVYou cannot catch it in
p42251
aVNET 4
p42252
aV0, AppDomain
p42253
aVUnhandledException won't run
p42254
aVThe generic diagnostic for this exception is that the integrity of the garbage collected heap was compromised
p42255
aVA typical trigger is unmanaged code writing past the end of a buffer
p42256
aVOr it can be environmental, virus scanners have a knack to cause this problem
p42257
aVEspecially Symantec security products
p42258
aVWhich is somewhat likely in your case, given that the ports aren't being closed automatically when your service terminates
p42259
aVIt is also technically possible for a bug in the CLR to cause this
p42260
aVI'd thus recommend:
p42261
aVInspect your source code base and thoroughly review any unmanaged code that's used
p42262
aVContact vendors of 3rd party components and ask about known heap corruption problems
p42263
aVReview the configuration of the machine on which this code runs
p42264
aVDisable add-ons where possible, temporarily disable anything that isn't strictly necessary to run your service
p42265
aVRetarget your project to the
p42266
aVNET 3
p42267
aV5 SP1 framework
p42268
as(dp42269
g9
V17034
p42270
stp42271
a((dp42272
g2
(lp42273
VIt is pretty unlikely that it is actually the loading that's slow
p42274
aVThe constructor is usually fast, regardless of how many controls you create
p42275
aVIf you have a Load event handler, you can easily measure how long it takes with the Stopwatch class or a profiler
p42276
aVNo, the most common reason for perceived slowness in forms with a lot of controls is simply the long time it takes to paint the controls
p42277
aVThat happens pretty quickly, you start noticing with 50 controls
p42278
aVWhich is about as many child windows as Microsoft Outlook uses
p42279
aVThe time it takes for each control to paint itself is pretty predictable
p42280
aVThe more intricate its look, the longer it takes
p42281
aVA simple test you can do is watching how long it takes when you minimize, then restore the form
p42282
aVIf that's slow too then it is painting that's the bottleneck
p42283
aVNothing much you can do to make this magically faster
p42284
aVOther than just using less controls
p42285
aVA Label for example is particularly expensive for the job it does, you can replace it with a line of code in the OnPaint method
p42286
aVComponent vendors like Telerik specialize in selling controls that don't use a window
p42287
as(dp42288
g9
V17034
p42289
stp42290
a((dp42291
g2
(lp42292
VYeah, there's something you can do
p42293
aVCall SetUnhandledExceptionFilter() in your main() method to register a callback
p42294
aVIt will be called when nobody volunteers to handle the exception, just before the Microsoft WER dialog shows up
p42295
aVActually doing something in that callback is fraught with trouble
p42296
aVThe program has died with, invariably, something nasty like an AccessViolation exception
p42297
aVWhich often is tripped by heap corruption
p42298
aVTrying to do something like displaying a message box to let the user know is troublesome when the heap is toast
p42299
aVDeadlock is always lurking around the corner too, ready to just lock up the program without any diagnostic at all
p42300
aVThe only safe thing to do is to have a helper process that guards your main process
p42301
aVWake it up by signaling a named event in your callback
p42302
aVGive it the exception info it needs with a memory-mapped file
p42303
aVThe helper can do pretty much anything it wants when it sees the event signaled
p42304
aVIncluding showing a message, taking a minidump
p42305
aVAnd terminating the main process
p42306
aVWhich is exactly how the Microsoft WerFault helper works
p42307
as(dp42308
g9
V17034
p42309
stp42310
a((dp42311
g2
(lp42312
VYou must test the code the way it will ultimately run on the client's machine
p42313
aVIn most sane deployment scenarios that will be code compiled in the Release configuration
p42314
as(dp42315
g9
V17034
p42316
stp42317
a((dp42318
g2
(lp42319
VYou don't have a DoMethod(Base item) method
p42320
aVOverloading is not polymorphic
p42321
aVThis is normally done by using a virtual method:
p42322
as(dp42323
g9
V17034
p42324
stp42325
a((dp42326
g2
(lp42327
VYes, that's difficult, the class names are auto-generated
p42328
aVYou can't use FindWindowEx(), you have to iterate the controls with EnumChildWindows() and GetClassName()
p42329
aVYou could adapt the source code for the Managed Spy tool to make all this a lot easier and cleaner
p42330
as(dp42331
g9
V17034
p42332
stp42333
a((dp42334
g2
(lp42335
VThat's certainly possible, merely awkward
p42336
aVYou can always get a reference to a control back from the Controls collection or the sender argument of an event
p42337
aVIt's Parent property gives you the tab page
p42338
aVEtcetera
p42339
aVYes, a  would work
p42340
aVBut also the TabControl
p42341
aVTabPages property
p42342
as(dp42343
g9
V17034
p42344
stp42345
a((dp42346
g2
(lp42347
VI can't even get the scrollbar to show up
p42348
aVRight/bottom anchors don't work well when auto-sizing layout
p42349
aVSet the AutoScrollMinSize property to an appropriate value, that also ensures you've got enough margin to the right of the button
p42350
as(dp42351
g9
V17034
p42352
stp42353
a((dp42354
g2
(lp42355
VWell, kinda
p42356
aVIf you make it look like this:
p42357
as(dp42358
g9
V17034
p42359
stp42360
a((dp42361
g2
(lp42362
VThe thread pool manager makes sure that only as many threads are allowed to execute as you have CPU cores
p42363
aVAs soon as one completes, another one that's waiting in the queue is allowed to execute
p42364
aVTwice a second, it re-evaluates what's going on with the running threads
p42365
aVIf they don't complete, it assumes they are blocked and allows another waiting thread to run
p42366
aVOn the typical two-core CPU, you'll get two threads running right away, the 3rd thread starts after one second, the 4th thread after 1
p42367
aV5 second, etcetera
p42368
aVWell, there's your second
p42369
aVThe Q&D; fix is to use ThreadPool
p42370
aVSetMinThreads(), but that's the sledgehammer solution
p42371
aVThe real issue is that your program is using thread pool threads for long-running tasks
p42372
aVEither because they execute a lot of code or because they block on some kind of I/O request
p42373
aVThe latter being the more common case
p42374
aVThe way to solve it is to not use a thread pool thread for such a blocking thread but use the Thread class instead
p42375
aVDon't do this if the threads are actually burning CPU cycles, you'll slow everything down
p42376
aVEasy to tell, you'll see 100% cpu load in Taskmgr
p42377
aVexe
p42378
as(dp42379
g9
V17034
p42380
stp42381
a((dp42382
g2
(lp42383
VWell, that doesn't make any sense of course
p42384
aVIf the fDone flag is set to TRUE, there's no way it can stay inside the loop and keep calling PeekMessage()
p42385
aVNor can PeekMessage() block
p42386
aVBlowing the stack frame could have an effect like that, but that's not indicated here and always an explanation of last resort
p42387
aVThe more likely explanation is that this code gets repeatedly executed from the top
p42388
aVMaybe by you calling it from the window procedure
p42389
aVYes, that can get you in an endless loop easily if you don't call DispatchMessage()
p42390
aVThe WM_PAINT message is an obvious candidate, it will just keep firing without letup if you don't call Begin/EndPaint()
p42391
aVThis is just a theory of course, can't know for sure without knowing how this code is getting called
p42392
as(dp42393
g9
V17034
p42394
stp42395
a((dp42396
g2
(lp42397
VYes, using Disposing() is fine
p42398
aVIf the client code messes this up so it doesn't get called then it has much bigger problems due to the handle leak
p42399
aVNote that these kind of "reverse events" are awkward
p42400
aVIf you know that the event source always out-lives the consumer then a callback can be to more appropriate solution
p42401
aVAn example interface declaration:
p42402
aVNote how listening to the Disposed event allows the manager to automatically remove the control from the registered controls list
p42403
aVThe client control can no longer mess this up by forgetting to override Disposing
p42404
aVOn a language change, simply iterate the list and call the SetText() method
p42405
aVAlso note that you now can register multiple callbacks for the same control, in case a control has more than one translatable string
p42406
aVWhich now also allows you to specify the key for the string in the Register method and supply the translation as an argument for SetText()
p42407
aVEtcetera
p42408
as(dp42409
g9
V17034
p42410
stp42411
a((dp42412
g2
(lp42413
VAgreed, this is heavy handed:
p42414
aVWPF uses the exact same mechanism to implement this as Windows Forms, layered windows
p42415
aVThere is no obvious reason it wouldn't work the same way in WPF
p42416
aVThe code snippet, lifted from Window
p42417
aVcs, simply rules it out
p42418
aVThere is however one hint from the UsesPerPixelOpacity property:
p42419
aVWhen you enable per-pixel opacity, the system no longer draws the non-client area
p42420
aVThis is because the intended purpose of UsesPerPixelOpacity is to show non-rectangular top-level UI that works in interoperation scenarios, and showing the rectangular non-client area defeats that purpose
p42421
aVinteroperation scenarios", I guess
p42422
as(dp42423
g9
V17034
p42424
stp42425
a((dp42426
g2
(lp42427
VIt's a bit too much code to wrestle through
p42428
aVI however see you use methods like Remove() and Clear() without you ever calling the Dispose() method for a tab page
p42429
aVThese pages get "parked" and will keep using system resources
p42430
aVRun Taskmgr
p42431
aVexe, Processes tab, View + Select Columns, tick User32 objects
p42432
aVYou'll probably see this number going up without bound as your code is leaking the Handle for the tab page and all of its controls
p42433
as(dp42434
g9
V17034
p42435
stp42436
a((dp42437
g2
(lp42438
VAn Interrupt gate is special because the IF flag is automatically cleared
p42439
aVA Call gate is special because it doesn't get activated through an interrupt vector
p42440
aVA task gate is special because it automatically saves the processor state
p42441
aVFour distinct behaviors, having four names for them is convenient
p42442
as(dp42443
g9
V17034
p42444
stp42445
a((dp42446
g2
(lp42447
VYou are hopelessly mixing up the terms Form and UserControl, making it very hard to give a good answer
p42448
aVThey are very different beasts, you can't turn a UC into a form
p42449
aVIt is a client window, not a top-level window
p42450
aVI suspect that has something to do with your problem but the generic diagnostic is that somebody is overriding OnLoad and not calling base
p42451
aVOnLoad()
p42452
aVYes, OnLoad may be called from code in InitializeComponent()
p42453
aVIt isn't very healthy since OnLoad will run before the constructor is finished, but it is supported
p42454
aVThis will happen when you touch a property that requires the Handle to be created
p42455
aVThe call stack should show you which particular property assignment did this, just double-click the line in the call stack
p42456
as(dp42457
g9
V17034
p42458
stp42459
a((dp42460
g2
(lp42461
VYou simply cannot make this reliable
p42462
aVTaskmgr shoots you in the head without recourse
p42463
aVThe more obvious failure modes are some kind of nasty CLR problem like ExecutionEngineException
p42464
aVAnd the simple stuff like somebody tripping over the power cord
p42465
aVSolve this by setting a persisted flag at normal shutdown, after the Application
p42466
aVRun() call, that indicates "data is known-good"
p42467
aVAlways check at startup if the previous run was bad (missing the flag) so you can clean up the shrapnel
p42468
as(dp42469
g9
V17034
p42470
stp42471
a((dp42472
g2
(lp42473
VThis is auto-generated code from a project template
p42474
aVThe only real fix is to alter the template or edit the Designer
p42475
aVcs source code file
p42476
aVThe template is in Common7\u005cIDE\u005cItemsTemplate(Cache)\u005cCSharp\u005cWindows Forms\u005cxxxx\u005cForm
p42477
aVzip\u005cform
p42478
aVdesigner
p42479
aVcs
p42480
aVEditing it will of course only fix the problem for future projects
p42481
aVEditing auto-generated code isn't normally the greatest idea, but you'll get away with it in this particular case
p42482
as(dp42483
g9
V17034
p42484
stp42485
a((dp42486
g2
(lp42487
VIDisposable has nothing to do with events, it was designed to release unmanaged resources
p42488
aVYou would normally only have a problem with an event handler preventing an object from getting garbage collected if the event source out-lives the event consumer
p42489
aVSounds like, in your case, they'll both get collected at the same time, no need to unregister the event
p42490
aVHowever, if the event source always out-lives the consumer then you have a problem
p42491
aVYou'll need some kind of trigger to unregister the event handler
p42492
aVIf the consumer already implements Dispose() then that could be the place to unregister the handler
p42493
aVIf not then you should really consider using a plain callback method instead of an event
p42494
as(dp42495
g9
V17034
p42496
stp42497
a((dp42498
g2
(lp42499
VThis has to be an ambiguity problem, the compiler sees a different definition of IDataObject when compiling FooUserControl
p42500
aVWhich is easy to do, the System
p42501
aVWindows
p42502
aVForms namespace already has an IDataObject interface
p42503
aVPick a different name or type the full namespace name
p42504
as(dp42505
g9
V17034
p42506
stp42507
a((dp42508
g2
(lp42509
VThere's no black magic available here
p42510
aVYou actually need to run a program on the remote machine to get that balloon
p42511
aVEasy to do with the NotifyIcon class
p42512
aVSending a message to that program is simple enough with TcpListener and TcpClient
p42513
as(dp42514
g9
V17034
p42515
stp42516
a((dp42517
g2
(lp42518
VYou are not going to get help converting the form class to a partial class
p42519
aVThere really isn't any need to, the designer still supports the old style
p42520
aVIf editing the form layout doesn't automatically insert the property assignment then just paste it in yourself, just before the ClientSize assignment
p42521
aVTry it out on a sample project first, just drop a button on the form and look at the Designer
p42522
aVcs file content
p42523
aVIt ought to resemble:
p42524
aVYou can try it out to see if the form scales properly without having to reboot your machine by pasting this in your form's code:
p42525
aVTinkering with layout properties might be necessary to make it look good
p42526
as(dp42527
g9
V17034
p42528
stp42529
a((dp42530
g2
(lp42531
VYou cannot lock a variable
p42532
aVThe subject of intensive research, STM is a promising candidate but nobody has yet written an operating system that uses it
p42533
aVNo, you can only block code that tries to access that variable
p42534
aVWhich is typically done with a mutex
p42535
as(dp42536
g9
V17034
p42537
stp42538
a((dp42539
g2
(lp42540
VUse Math
p42541
aVAtan2() to calculate the angle
p42542
aVConvert from radians to degrees by multiplying by 180 / Math
p42543
aVPi
p42544
aVGetting the center of rotation for RotateTransform() is the critical step to get the text aligned properly with the line
p42545
aVr * Math
p42546
aVCos(angle) for the X-offset from the line start point, r * Sin(angle) for the Y-offset where r is the offset from the line start point
p42547
aVAdjust by the font's Height to get it above the line
p42548
as(dp42549
g9
V17034
p42550
stp42551
a((dp42552
g2
(lp42553
VRight-click the project and select "Open Folder in Windows Explorer"
p42554
aVSimply double-click the EXE
p42555
aVYou can click the Show All Files icon in the Solution Explorer window to navigate to the build directory in VS instead of Explorer
p42556
as(dp42557
g9
V17034
p42558
stp42559
a((dp42560
g2
(lp42561
VYou did in fact delete the directory
p42562
aVBut the directory won't be physically removed from the file system until the last handle that references it is closed
p42563
aVAny attempt to open it in between (like you did with GetDirectories) will fail with an access denied error
p42564
aVThe same mechanism exists for files
p42565
aVReview FileShare
p42566
aVDelete
p42567
as(dp42568
g9
V17034
p42569
stp42570
a((dp42571
g2
(lp42572
VWhat you see when you use Debug + Windows + Disassembly when debugging a C# program is a good guide for these terms
p42573
aVHere's an annotated version of it when I compile a 'hello world' program written in C# in the Release configuration with JIT optimization enabled:
p42574
aVRight-click the window and tick the "Show Code Bytes" to get a similar display
p42575
aVThe column on the left is the machine code address
p42576
aVIts value is faked by the debugger, the code is actually located somewhere else
p42577
aVBut that could be anywhere, depending on the location selected by the JIT compiler, so the debugger just starts numbering addresses from 0 at the start of the method
p42578
aVThe second column is the machine code
p42579
aVThe actual 1s and 0s that the CPU executes
p42580
aVMachine code, like here, is commonly displayed in hex
p42581
aVIllustrative perhaps is that 0x8B selects the MOV instruction, the additional bytes are there to tell the CPU exactly what needs to be moved
p42582
aVAlso note the two flavors of the CALL instruction, 0xE8 is the direct call, 0xFF is the indirect call instruction
p42583
aVThe third column is the assembly code
p42584
aVAssembly is a simple language, designed to make it easier to write machine code
p42585
aVIt compares to C# being compiled to IL
p42586
aVThe compiler used to translate assembly code is called an "assembler"
p42587
aVYou probably have the Microsoft assembler on your machine, its executable name is ml
p42588
aVexe, ml64
p42589
aVexe for the 64-bit version
p42590
aVThere are two common versions of assembly languages in use
p42591
aVThe one you see is the one that Intel and AMD use
p42592
aVIn the open source world, assembly in the AT&T; notation is common
p42593
aVThe language syntax is heavily dependent on the kind of CPU for which is was written, the assembly language for a PowerPC is very different
p42594
aVOkay, that tackles two of the terms in your question
p42595
aV"Native code" is a fuzzy term, it isn't uncommonly used to describe code in an unmanaged language
p42596
aVInstructive perhaps is to see what kind of machine code is generated by a C compiler
p42597
aVThis is the 'hello world' version in C:
p42598
aVI didn't annotate it, mostly because it is so similar to the machine code generated by the C# program
p42599
aVThe printf() function call is quite different from the Console
p42600
aVWriteLine() call but everything else is about the same
p42601
aVAlso note that the debugger is now generating the real machine code address and that it is a bit smarter about symbols
p42602
aVA side effect of generating debug info after generating machine code like unmanaged compilers often do
p42603
aVI should also mention that I turned off a few machine code optimization options to make the machine code look similar
p42604
aVC/C++ compilers have a lot more time available to optimize code, the result is often hard to interpret
p42605
aVAnd very hard to debug
p42606
aVKey point here is there are very few differences between machine code generated from a managed language by the JIT compiler and machine code generated by a native code compiler
p42607
aVWhich is the primary reason why the C# language can be competitive with an native code compiler
p42608
aVThe only real difference between them are the support function calls
p42609
aVMany of which are implemented in the CLR
p42610
aVAnd that revolves primary around the garbage collector
p42611
as(dp42612
g9
V17034
p42613
stp42614
a((dp42615
g2
(lp42616
VWell, that doesn't make much sense with the code snippets you posted
p42617
aVBut extraordinary problems like this require extraordinary explanations
p42618
aVThe System
p42619
aVTimers
p42620
aVTimer class is a horrid timer
p42621
aVThe condition you see, getting the Elapsed event called while the timer is stopped, is inevitable in most any use for it
p42622
aVThe problem is that it raises the Elapsed event by using ThreadPool
p42623
aVQueueUserWorkItem()
p42624
aVThat thread is subject to the vagaries of the thread pool scheduler and the Windows thread scheduler
p42625
aVQUWI does not guarantee that the thread will run right away
p42626
aVInstead, the thread goes in a queue in the "ready to run" state
p42627
aVThe TP scheduler removes it from that queue only when it deems the time right to run a thread
p42628
aVWhich for one means that it will be stuck for a while if it already has as many threads running as your machine has CPU cores
p42629
aVOnly when threads don't complete will it allow more threads to run
p42630
aVThat takes a while, these scheduling decisions only run twice a second
p42631
aVThe Windows thread scheduler plays a role as well
p42632
aVWhen the machine is loaded, having many threads ready to run then it can take a while before the Elapsed thread gets a turn
p42633
aVWhat is especially nasty about this problem is that such a race is heavily dependent on what else is going on in your program or on the machine
p42634
aVRuns fine on your dev machine, malfunctions unpredictably in production when the Elapsed event finally manages to run, even though the timer got stopped a long time ago
p42635
aVAlso note that this can build up
p42636
aVYou are particularly vulnerable to that because you stop the timer in the Elapsed event
p42637
aVWhen the TP threads just don't manage to get scheduled, the timer just keeps calling QUWI, addding more TP threads, without your code able to stop the timer
p42638
aVWell, guesses, but it does explain the problem
p42639
aVEither the synchronous timer in your UI library or System
p42640
aVThread
p42641
aVTimer should fix it
p42642
aVDo try to use the single-shot version of the latter
p42643
aVA time-out is a fixed time, it shouldn't have to be counted
p42644
as(dp42645
g9
V17034
p42646
stp42647
a((dp42648
g2
(lp42649
VYou've most likely got some unmanaged code in your project that changed the FPU control word, switching it to single precision mode
p42650
aVThe debugger evaluates the expression on its own thread, it didn't get messed with
p42651
aVThat unmanaged code is typically DirectX
p42652
aVReview its CreateDevice() function with the D3DCREATE_FPU_PRESERVE option
p42653
aVIf you didn't write this code then you'll have to talk to your software vendor
p42654
aVOne trick that might work is intentionally throwing and catching an exception, not 100% sure
p42655
as(dp42656
g9
V17034
p42657
stp42658
a((dp42659
g2
(lp42660
VThat creates an array of IUnknown interface pointers
p42661
aVSafeArrayPut() makes sure to increase the reference count of the interface pointer by calling IUnknown::AddRef() since it stores a copy of the pointer in the array
p42662
aVYou can see how that goes kaboom
p42663
aVCreate an array of integers instead
p42664
aVFix:
p42665
as(dp42666
g9
V17034
p42667
stp42668
a((dp42669
g2
(lp42670
VThe serialization code can't work properly, you forgot to reset the stream back to the beginning
p42671
aVThe better mouse trap:
p42672
aVThe deserialization code can similarly be simplified:
p42673
aVAnd you don't need GetObjectData()
p42674
as(dp42675
g9
V17034
p42676
stp42677
a((dp42678
g2
(lp42679
VIt's difficult to get ahead, string hashing functions are O(n)
p42680
aVString comparison is O(n) as well, with a smaller Oh
p42681
aVYou would only be ahead if you can store the hash values you compute and use them repeatedly
p42682
aVFor both
p42683
aVSimple sample C hash functions are here
p42684
as(dp42685
g9
V17034
p42686
stp42687
a((dp42688
g2
(lp42689
VJust add a pre-build event and use "echo" to display the string in the Output window
p42690
as(dp42691
g9
V17034
p42692
stp42693
a((dp42694
g2
(lp42695
Vbut the developers left before I started
p42696
aVthe hard drive failed and there is no backup available
p42697
aVI can't get it to build in either without dozens of errors
p42698
aVThis has software project disaster written all over it
p42699
aVYou were probably hired in a last ditch attempt to rescue the investment by throwing meat at the problem
p42700
aVYou're the meat
p42701
aVThe odds are very low you'll be able to rescue it when even the original devs have given up on it
p42702
aVYou'll need to get a commitment from the management team to have any chance at all to bring this to a good end
p42703
aVInsist on the following:
p42704
aVThey should hire at least one of the original principal engineers for a ridiculously high consultancy fee, calibrated so that No
p42705
aVis not an option
p42706
aVThey should hire a data recovery company to get the info off the failed disk
p42707
aVThey should purchase all the original tools used to build the product
p42708
aVIf they are no longer available from the vendor then look at an auction site, like ebay
p42709
aVDo not waste your time with trial versions
p42710
aVIf you see any hesitation in them committing to these steps, get the hell out of there
p42711
as(dp42712
g9
V17034
p42713
stp42714
a((dp42715
g2
(lp42716
VI don't see an obvious way this would fail
p42717
aVYou said you merged the library sections but you didn't say you copy-pasted the interface declarations from the other
p42718
aVidl
p42719
aVThat would be an obvious, but unlikely, explanation
p42720
aVOne failure mode is when the client app uses the type library to marshal interface pointers across apartment boundaries or out-of-process
p42721
aVThat however requires registry keys in HKCR\u005cInterfaces
p42722
aVNET doesn't create them, you'd have to do that yourself
p42723
aVYou'd know if you did, not much of an explanation either
p42724
as(dp42725
g9
V17034
p42726
stp42727
a((dp42728
g2
(lp42729
VIf the first call to Read() returns 0 then Stream
p42730
aVCopyTo() isn't going to work either
p42731
aVWhile this points to a problem with GZipStream, it is very unlikely that it has a bug like this
p42732
aVFar more likely is that something went wrong when you created the compressed data
p42733
aVLike compressing 0 bytes first, followed by compressing the real data
p42734
as(dp42735
g9
V17034
p42736
stp42737
a((dp42738
g2
(lp42739
VThe problem is that you're using cmd
p42740
aVexe
p42741
aVOnly its console window will be hidden, not the console window for the process you ask it to start
p42742
aVThere's little point in using cmd
p42743
aVexe, unless you are trying to execute some of the commands it implements itself
p42744
aVLike COPY
p42745
aVYou can still suppress the window if you need cmd
p42746
aVexe, you'll have to use the /B option for Start
p42747
aVType start /
p42748
aVat the command prompt to see options
p42749
aVNot that it helps, you can't use START COPY
p42750
aVThere's a specific quirk in xcopy
p42751
aVexe that might throw you off as well
p42752
aVIt does not execute if you don't also redirect the input
p42753
aVIt just fails to run without diagnostic
p42754
as(dp42755
g9
V17034
p42756
stp42757
a((dp42758
g2
(lp42759
VI'm surprised this works at all, non-console mode apps routinely ignore the requested WindowStyle
p42760
aVTry notepad
p42761
aVexe for example
p42762
aVBut yes, this would be a flaw in IE
p42763
aVThe Process class has otherwise no powers beyond just passing the requested window style to the started process
p42764
aVThe process gets this request through the nShowCmd() argument of WinMain()
p42765
aVThere is a feedback channel for IE at Connect
p42766
aVBut they will only accept reports for IE9 and you have to apply
p42767
aVTrying to duck IE6 hate mail, I'd guess
p42768
as(dp42769
g9
V17034
p42770
stp42771
a((dp42772
g2
(lp42773
VBookmarks are poorly supported in Visual Studio extensibility interfaces
p42774
aVThere is no way to enumerate them
p42775
aVOnly Clear/Set/Next/PreviousBookmark methods are available
p42776
aVNot good enough to do what you want to do
p42777
as(dp42778
g9
V17034
p42779
stp42780
a((dp42781
g2
(lp42782
VWell, doesn't make a lot of sense
p42783
aVBut you are running with a very different dbase provider
p42784
aVThe 64-bit versions of them are relatively new and might not have gone through the same kind of rigorous testing and optimization as their 32-bit versions
p42785
aVStill, a program like this should always block on the queue read and the dbase write
p42786
aVI/O is always slow, much slower than raw code
p42787
aVOnly when the thread blocks on an I/O request will it use less than 100% of the CPU cycles
p42788
aVDo make sure that it isn't throwing and catching exceptions frequently
p42789
aVThat's expensive and easily gobbles up all CPU resources
p42790
aVVisible while debugging in the Output window
p42791
as(dp42792
g9
V17034
p42793
stp42794
a((dp42795
g2
(lp42796
VGoogle  + , keywords that google well
p42797
aVThat sets a low-level keyboard hook
p42798
aVIt is not a global hook so can work in a VB
p42799
aVNET program
p42800
as(dp42801
g9
V17034
p42802
stp42803
a((dp42804
g2
(lp42805
VNeither merging nor automating builds has a lot to do with MSBuild
p42806
aVYou'd need ILMerge and, say, CruiseControl
p42807
aVNET
p42808
as(dp42809
g9
V17034
p42810
stp42811
a((dp42812
g2
(lp42813
VI assume you mean the
p42814
aVNET and COM tabs in the Add Reference dialog
p42815
aVThere is no difference if your machine is setup properly
p42816
aVWhich it is if you see Excel listed in the
p42817
aVNET tab
p42818
aVThat means you've got the Office PIA installed on your machine, either reference will pick that PIA
p42819
aVThat PIA also needs to be installed on the target machine
p42820
as(dp42821
g9
V17034
p42822
stp42823
a((dp42824
g2
(lp42825
VThis will happen when the dialog closes and Windows cannot find any window in your app that isn't disabled
p42826
aVForced to move the focus somewhere, it will pick a window of another app to give the focus to
p42827
aVYour form will disappear behind it
p42828
aVExactly why your main form is disabled when this happens isn't clear
p42829
aVThe color change certainly suggests you are changing the Enabled property of the form
p42830
aVEverything turns battle-ship gray when you do that
p42831
aVSetting Enabled back to true after the dialog closes doesn't work, it's too late
p42832
aVJust don't tinker with Enabled, the ShowDialog() method already disables other windows
p42833
as(dp42834
g9
V17034
p42835
stp42836
a((dp42837
g2
(lp42838
VShort from mis-behaving shell extensions, this is normal
p42839
aVSFD will change the current working directory of your program to the directory that contains the file selected by the user
p42840
aVAnd that puts a lock on the directory
p42841
aVYou avoid this by setting the RestoreDirectory property to True
p42842
as(dp42843
g9
V17034
p42844
stp42845
a((dp42846
g2
(lp42847
VMFC uses the sane approach in its CMFCToolBar::OnGetButtonText() implementation, it assumes the caller knows it should allocate N+1 and uses lstrcpy() to copy the text
p42848
as(dp42849
g9
V17034
p42850
stp42851
a((dp42852
g2
(lp42853
VThis is a macro that's normally declared in a Windows SDK header, BaseTsd
p42854
aVh header file
p42855
aVWhen compiling in 32-bit mode, it is defined as you showed
p42856
aVWhen compiling in 64-bit mode it is defined as
p42857
aVwhich is an MSVC compiler extension to declare 32-bit pointers in a 64-bit code model
p42858
aVThere's also a 64-bit flavor for 32-bit code:
p42859
aVYou'd use it if you write a 64-bit program and need to interop with structures that are used by 32-bit code in another process
p42860
aVFor example:
p42861
as(dp42862
g9
V17034
p42863
stp42864
a((dp42865
g2
(lp42866
VThe CLR doesn't require it, it is an implementation detail of the language
p42867
aVC# and VB
p42868
aVNET perform the test
p42869
aVC++/CLI is a notable managed language that permits it
p42870
aVAs long as the instance method doesn't reference any class members then nothing goes wrong
p42871
aVIf is does, NullReferenceException will be raised as normal, merely giving you a hard time finding out why
p42872
as(dp42873
g9
V17034
p42874
stp42875
a((dp42876
g2
(lp42877
VThis isn't possible in WinForms, transparency effects don't work for overlapping controls
p42878
aVThe best you could do is overlapping forms so you can use the Opacity and TransparencyKey properties
p42879
aVA far more practical approach is to use one PictureBox in which you display a composite image
p42880
aVSuch an image is easy to create with the ColorMatrix class
p42881
aVYou'll find sample code in my answer in this thread
p42882
as(dp42883
g9
V17034
p42884
stp42885
a((dp42886
g2
(lp42887
VYou could edit the project templates with, say, Notepad
p42888
aVThey are located in
p42889
aVEdit the
p42890
aVcsproj file in the
p42891
aVzip archive and add
p42892
aVto the Debug and/or Release PropertyGroup
p42893
aVOr consider upgrading to VS2010, x86 is now the default
p42894
as(dp42895
g9
V17034
p42896
stp42897
a((dp42898
g2
(lp42899
VThe _getch() function won't return until the user presses a typing key on the keyboard
p42900
aVIf this function is called from your program's main thread then this will stall the UI thread
p42901
aVIt won't pump the message loop, your UI freezes when it no longer processes input events nor paints the windows
p42902
aVAfter a couple of seconds Windows puts the ghost window in place with "Not Responding" in the title bar
p42903
aVWhile calling _getch() from a background thread will solve the problem, that's probably not going to be convenient
p42904
aVYou can use _kbhit() to check if a keystroke is available
p42905
aVCalling _getch() after _kbhit() returns true won't block
p42906
aVProbably not convenient either
p42907
aVTrying to pump the message loop while _kbhit() returns false would technically be a solution, if it wasn't for the message loop living in the wrong code
p42908
aVNote that you can type Ctrl+S in the console window to pause output, Ctrl+Q resumes it again
p42909
aVYou'll still block the UI thread but at least you'll do it knowingly
p42910
as(dp42911
g9
V17034
p42912
stp42913
a((dp42914
g2
(lp42915
VThere are a lot of bad p/invoke declarations on the Internet
p42916
aVThey typically started life in VB6
p42917
aVIn that language, Integer is 16 bits and Long is 32 bits
p42918
aVGoes back to VB1 which ran on 16-bit operating systems
p42919
aVThey don't work properly in VB
p42920
aVNET or C#
p42921
aVThe stack imbalance MDA was specifically designed to catch such bad declarations, but it is an option (Debug + Exceptions)
p42922
aVThe actual call tends to work if there is only one argument or when passing a lot of zeros
p42923
aVThe odds that code keeps running properly after the call is, unfortunately, not bad either
p42924
aVThe stack pointer value corrects itself when the method returns
p42925
aVYou can get some really screwy problems though
p42926
as(dp42927
g9
V17034
p42928
stp42929
a((dp42930
g2
(lp42931
VGetting a form to cover the taskbar requires it to be borderless
p42932
aVYou'll need to detect the window state change in the OnResize event
p42933
aVSomething like this:
p42934
aVThere's a flaw, it won't restore to the exact same size
p42935
aVNo easy fix for that
p42936
as(dp42937
g9
V17034
p42938
stp42939
a((dp42940
g2
(lp42941
VThe days of programs modifying or creating global registry keys are over and done with
p42942
aVIt still works on your XP box because you login as an administrator
p42943
aVVista, Win7 and Windows 2008 have UAC to prevent anybody (ie malware) messing with the registry, even when logged on with an admin account
p42944
aVYou can add a manifest to your program to invoke the UAC prompt, but that's entirely unpractical for unit tests
p42945
aVRework your unit test to write to the HKEY_CURRENT_USER hive instead
p42946
aVThe same consideration probably applies to the program for which you wrote the tests
p42947
as(dp42948
g9
V17034
p42949
stp42950
a((dp42951
g2
(lp42952
VThe struct stat structure does not contain any file permission info on Windows
p42953
aVWindows security is far more convoluted, you'd need GetFileSecurity() to retrieve the DACL for the file
p42954
aVThat's rarely done in a Windows program, you'd typically let Windows evaluate the effective permissions and deal with the "you can't do it" error return
p42955
aVERROR_ACCESS_DENIED from GetLastError()
p42956
as(dp42957
g9
V17034
p42958
stp42959
a((dp42960
g2
(lp42961
V1: No, it's used
p42962
aVEcma-335, partition II, chapter 6
p42963
ag2584
aV3 on the
p42964
aVfile directive:
p42965
aVThe bytes after the
p42966
aVhash specify a hash value computed for the file
p42967
aVThe VES shall recompute this hash value prior to accessing this file and shall generate an exception if it does not match
p42968
aVThe algorithm used to calculate this hash value is specified with
p42969
aVhash algorithm (see clause 6
p42970
ag2584
ag2582
aV1)
p42971
aV2: Only if strong name validation is enabled
p42972
aVNote that this is off by default since
p42973
aVNET 3
p42974
aV5 SP1 in full trust scenarios
p42975
aVYou'd have to explicitly enable it with caspol
p42976
aVexe
p42977
aV3: assuming "strongly named", then no validation is possible
p42978
as(dp42979
g9
V17034
p42980
stp42981
a((dp42982
g2
(lp42983
VThat's STATUS_INVALID_IMAGE_FORMAT, Windows isn't happy about the DLL it needs to load
p42984
aVThat's almost always caused by trying to load a 32-bit DLL in a 64-bit program
p42985
aVOr a 64-bit in a 32-bit program
p42986
aVIf you converted this VB6 code to VB
p42987
aVNET then you probably need to force it to run in 32-bit mode
p42988
aVProject + Properties, Compile tab, scroll down, Advanced Compile Options, Target CPU = x86
p42989
as(dp42990
g9
V17034
p42991
stp42992
a((dp42993
g2
(lp42994
VIt's the kind of syntax you'd find in the C language, frowned upon there as well but not uncommon
p42995
aVWritten out:
p42996
aVIt depends on the bitmap format if this will work out well
p42997
aVNot commonly, the code resets the alpha of the pixels to zero
p42998
aVProducing a black image
p42999
as(dp43000
g9
V17034
p43001
stp43002
a((dp43003
g2
(lp43004
VAny practical
p43005
aVidl file should start with
p43006
aVWhich declares essential types
p43007
aVLike HRESULT and VARIANT
p43008
aVEtcetera
p43009
as(dp43010
g9
V17034
p43011
stp43012
a((dp43013
g2
(lp43014
VWindows doesn't use signals
p43015
aVYou should get the std::badalloc exception when you run out of memory
p43016
aVWhich, when uncaught, will automatically run the terminate() function
p43017
aVThe exception is visible in the Output window
p43018
as(dp43019
g9
V17034
p43020
stp43021
a((dp43022
g2
(lp43023
VNot sure I see how this could happen
p43024
aVJust make sure that the overlay is displayed with Show(owner) so that it is always on top and that it has the exact same Size and Location as the overlayed form
p43025
aVYou'll find sample code for such an overlay in my answer in this thread
p43026
as(dp43027
g9
V17034
p43028
stp43029
a((dp43030
g2
(lp43031
VYou can find out by p/invoking the Windows FileType() API function
p43032
aVHere's a helper class:
p43033
aVUsage:
p43034
aVUPDATE: these methods were added to the Console class in
p43035
aVNET 4
p43036
ag2447
aVWithout attribution I might add :(  Simply use the corresponding method instead of this helper class
p43037
as(dp43038
g9
V17034
p43039
stp43040
a((dp43041
g2
(lp43042
VHmm, heavy duty implementation details of a 12 year old compiler
p43043
aVWhen you use __declspec(dllexport) on a class, the linker exports the members of the class
p43044
aVNot the vtable
p43045
aVThat gets reconstructed in the client of the class when the compiler parses the class declaration in the header file
p43046
aVThe linker fills in that local vtable with the exported members addresses
p43047
aVWould it work better if the compiler simply exported the vtable from the DLL
p43048
aVMaybe, but exporting such implementation details is awfully brittle
p43049
aVThe fear of painting yourself into a corner that you cannot get out of because of backwards compatibility is a strong motivator, I imagine
p43050
as(dp43051
g9
V17034
p43052
stp43053
a((dp43054
g2
(lp43055
VBy popular demand, this was addressed in
p43056
aVNET 4
p43057
ag2512
aVThere are two critical changes in the internal SerialStream and EventRunner classes
p43058
aVThe SerialStream
p43059
aVDispose(bool) method avoids touching the serial port when the Windows API returns an access denied error, indicating that the port disappeared
p43060
aVThis will prevent the Dispose() method and the finalizer from crashing
p43061
aVThe EventRunner
p43062
aVCallEvents() method avoids throwing an uncatchable exception if an attempt to clear a serial port error fails
p43063
aVWhich would happen when the emulator is yanked out of the slot while it is in use
p43064
as(dp43065
g9
V17034
p43066
stp43067
a((dp43068
g2
(lp43069
VWell, it is possible by using the CustomTabOffsets property (unreliable) or the DrawItem event
p43070
aVAnd implementing the MouseDown event to find out if that particular 'column' was clicked
p43071
aVBut there's little point, a ListView control with View = Details gives you the same functionality
p43072
as(dp43073
g9
V17034
p43074
stp43075
a((dp43076
g2
(lp43077
VThere is no point in building managed assemblies (DLLs) with any other platform target than Any CPU
p43078
aVWhich will make them work properly either way
p43079
aVIf you do in fact have a dependency on unmanaged 32-bit or 64-bit code then you must set the the target platform for the EXE project
p43080
aVOnly that setting has any effect, the DLLs are forced to follow suit
p43081
aVThis is will clearly solve your problem
p43082
aVIn addition, the metadata in the assembly is not dependent on the platform target setting
p43083
as(dp43084
g9
V17034
p43085
stp43086
a((dp43087
g2
(lp43088
VIterating processes is very expensive on Windows
p43089
aVThere's a better way to do it with WMI, Win32_ProcessStartTrace class
p43090
aVIt also automatically solves your problem since it will only tell you about new processes getting started
p43091
aVAnd doesn't need a thread
p43092
aVYou'll find the code you need in this answer
p43093
as(dp43094
g9
V17034
p43095
stp43096
a((dp43097
g2
(lp43098
VIn Visual Studio: File + Open + File, type c:\u005cwindows\u005csystem32\u005cuser32
p43099
aVdll
p43100
aVOpen the String Table node and double click String Table
p43101
aVScroll down to 800
p43102
aVMicrosoft takes a pretty no-nonsense stance against relying on these resource IDs
p43103
aVGiven the number of programmers who've done what you're contemplating, it is however unlikely they can ever change these numbers
p43104
aVYou'll need to P/Invoke LoadLibrary() and LoadString()
p43105
aVHowever, your ultimate downfall on this plan is Vista/Win7 Ultimate with MUI language packs
p43106
aVWhich allows the user to switch between languages without updating the resource strings in the DLLs
p43107
aVSuch an edition will always have English strings
p43108
as(dp43109
g9
V17034
p43110
stp43111
a((dp43112
g2
(lp43113
VWrong question
p43114
aVIf you are not sure then make sure by running it again
p43115
aVIt's quick
p43116
aVBut if you really want to you could do something like this:
p43117
as(dp43118
g9
V17034
p43119
stp43120
a((dp43121
g2
(lp43122
VA good way is to derive from TcpClient and override the Disposing(bool) method:
p43123
aVWhich won't work if the other code created the instance
p43124
aVThen you'll have to do something desperate like using Reflection to get the value of the private m_CleanedUp member
p43125
aVOr catch the exception
p43126
aVFrankly, none is this is likely to come to a very good end
p43127
aVYou really did want to write to the TCP port
p43128
aVBut you won't, that buggy code you can't control is now in control of your code
p43129
aVYou've increased the impact of the bug
p43130
aVTalking to the owner of that code and working something out is by far the best solution
p43131
as(dp43132
g9
V17034
p43133
stp43134
a((dp43135
g2
(lp43136
VNo, that works fine since Controls
p43137
aVAdd() changes the Parent property
p43138
aVWhich automatically removes it from the tab page it was on before
p43139
aVA control instance can only have one parent
p43140
aVThe more straight-forward approach is to simply not put the control on a tab page but leave it parented to the form which a lower Z-order so it is always on top of the tab control
p43141
aVThe only problem with that is that the designer will hassle you
p43142
aVIt automatically sucks the control into the tab page when you move it on top of the tab control
p43143
aVOne trick to fix that is to leave it off the tab control and change its Location property in the form constructor
p43144
as(dp43145
g9
V17034
p43146
stp43147
a((dp43148
g2
(lp43149
VRuntime environments like VB6 and
p43150
aVNET treat COM as a first-class citizen and do not require the plumbing that midl
p43151
aVexe provides
p43152
aVA VB6 class is automatically a COM coclass that implements IDispatch
p43153
aVNET has attributes like [ComVisible]
p43154
aVTheir runtime environments implements the glue needed
p43155
aVNo such glue in C++, you have to write it yourself
p43156
aVOr leverage a class library like ATL
p43157
aVIt does however allow moving beyond the confines of oleauto, like implementing interfaces that derive from IUnknown and creating custom marshallers
p43158
as(dp43159
g9
V17034
p43160
stp43161
a((dp43162
g2
(lp43163
VWell, not really
p43164
aVThe set of types compatible with oleauto is rather restrictive so it isn't particularly surprising that there's a one-to-one mapping with managed (value) types
p43165
aVBut important oleauto types like VARIANT, SAFEARRAY, IDispatch* and HRESULT have no direct mapping
p43166
aVThat they actually can be mapped to, respectively, object, System
p43167
aVArray, __ComObject and System
p43168
aVException is thanks to the COM interop built into the CLR
p43169
aVThat's cold hard code that is not in any way prescribed by the CTS
p43170
as(dp43171
g9
V17034
p43172
stp43173
a((dp43174
g2
(lp43175
VThe  element was already present in your 3
p43176
aV5 project
p43177
aVIt's associated with the assembly  and only present on assemblies that are not available in
p43178
aVNET 2
p43179
ag2512
aVI don't buy much stock in the single mention of it in MSDN, I don't see how batch building has anything to do assembly references
p43180
aVNor is it used in any of the 3
p43181
aV5 MSBuild
p43182
aVtarget files
p43183
aVI think the IDE simply uses it to put the warning icon next to the reference in the References node when you change the Target Framework to a version less than what's needed to support the assembly
p43184
aVThere are other elements like this in a project file that don't affect MSBuild but have an effect in the IDE
p43185
aVLike  and  in the  element
p43186
as(dp43187
g9
V17034
p43188
stp43189
a((dp43190
g2
(lp43191
VNothing you could enforce at the designer level, there is no "I'm done designing" trigger
p43192
aVBut certainly at runtime, just throw an exception at the earliest possible moment:
p43193
aVYou could make it more subtle if you implement the OnPaint() method
p43194
aVAnd simply e
p43195
aVGraphics
p43196
aVDrawText a reminder
p43197
aVCall Invalidate() in the property setter
p43198
aVThis works at design time
p43199
as(dp43200
g9
V17034
p43201
stp43202
a((dp43203
g2
(lp43204
VIt doesn't compile because the original declaration in objbase
p43205
aVh didn't have the __declspec(dllexport) attribute
p43206
aVYou cannot add it in the definition
p43207
aVWon't help anyway, the name decoration isn't appropriate
p43208
aVMichael showed you what to do about that
p43209
as(dp43210
g9
V17034
p43211
stp43212
a((dp43213
g2
(lp43214
VIt's okay I guess, you won't lose any points for this
p43215
aVI don't care much for the term "best practice", it is not a common practice
p43216
aVA lot of programs are written with localization in mind, there's several billion potential customers that don't understand a word of English
p43217
aVNo standard C++ solution for that, just common practices on your platform
p43218
aVLike string resources
p43219
as(dp43220
g9
V17034
p43221
stp43222
a((dp43223
g2
(lp43224
VIt is a Windows error
p43225
aVThe mapping to OOM isn't the greatest idea, the description for error code 14 is "Not enough storage is available to complete this operation"
p43226
aVThe most typical cause is exceeding a quota imposed by Windows on a process
p43227
aVLike opening too many sockets or using too much memory from the kernel pool
p43228
aVYou'll need to find out what resource is being consumed
p43229
aVOne place to start is Taskmgr
p43230
aVexe, Processes tab
p43231
aVView + Select Columns and tick Handles, User32 Objects and GDI Objects
p43232
aVHandles being the likely one in this case
p43233
aVCorrelate the increase of this value with the execution of your code
p43234
as(dp43235
g9
V17034
p43236
stp43237
a((dp43238
g2
(lp43239
VSeveral problems
p43240
aVFor one, you don't actually store a VARIANT in the array
p43241
aVThis is ultimately not going anywhere, a SafeArray cannot store references to managed objects
p43242
aVThe garbage collector moves objects around, it cannot see references held by unmanaged code so it cannot update the reference
p43243
aVAt best, you could create an array of VT_UNKNOWN or VT_DISPATCH
p43244
aVBut you can't get the COM interface pointer for these managed objects, they are not [ComVisible]
p43245
aVWhen you fix that, you'd use Marshal
p43246
aVGetIDispatchForObject() or Marshal
p43247
aVGetIUnknownForObject() to get the interface pointer to store in the array
p43248
as(dp43249
g9
V17034
p43250
stp43251
a((dp43252
g2
(lp43253
VYes, the safe CRT functions will abort your program with status code 0xc0000417 when they detect a problem
p43254
aVHowever, they will do this immediately, the function will not return
p43255
aVWhich means that you are looking at the wrong source code for this problem
p43256
aVIt isn't the _ultoa_s() call that's bombing your program
p43257
aVIt's another function call, somewhere else in your code
p43258
aVI can't help you find it of course
p43259
aVBut the debugger should give you a good idea, look at the call stack when it breaks
p43260
as(dp43261
g9
V17034
p43262
stp43263
a((dp43264
g2
(lp43265
VThe HRESULT value is very relevant
p43266
aVNote the 'facility code' in 0x80131500, 13 indicates the source of error is managed code
p43267
aVYou already got the friendly translation for 1500
p43268
aVIn other words, the managed code threw an exception and it wasn't handled
p43269
aVThat's not uncommon of course, managed code very commonly throws exceptions
p43270
aVEspecially NullReferenceException, the one you triggered
p43271
aVDebugging this isn't that easy since you are running managed code in an unmanaged process
p43272
aVNot quite sure what the proper procedure is for IIS, normally it's done with Tools + Attach to Process
p43273
aVThe best way to tackle this is to isolate the code, write some unit tests
p43274
aVOther than that, the MachineBuilding variable strikes me as a good candidate for NRE
p43275
aVYou didn't initialize it
p43276
aVBtw: it has nothing to do with the registration
p43277
aVThat produces a very different kind of error
p43278
as(dp43279
g9
V17034
p43280
stp43281
a((dp43282
g2
(lp43283
VHmya, this is quite a bit beyond "click"
p43284
aVYou'd have to write a shell extension
p43285
aVDoing this in C# was quite off limits until
p43286
aVNET 4
p43287
aV0 because of the CLR version injection problem
p43288
aVUnmanaged programs (say, Notepad) would get the CLR injected in them when they use a shell dialog, like FolderBrowser or OpenFileDialog
p43289
aVWhich could cause subsequent code to fail that requires another version of the CLR
p43290
aVThat's solved, CLR 4
p43291
aV0 supports in-memory side-by-side operation of multiple CLR versions
p43292
aVWhat isn't solved is the complexity of the code you'd need to write
p43293
aVShell extensions require COM code
p43294
aVThe hard kind, interfaces that derive from IUnknown
p43295
aVTo even get started, you need to write masses of declarations for the COM interfaces
p43296
aVYou can't get them out of the SDK declarations, they are only usable by a C++ program
p43297
aVAnd it is very error prone, C# doesn't support multiple inheritance, the feature you'd need to declare COM interfaces that are derived from other interfaces
p43298
aVLast but not least, debugging this kind of code is a nightmare
p43299
aVThis is an essential Windows process you're tinkering with
p43300
aVMaking a mistake leaves you with an unusable shell
p43301
aVRebooting starts that same borked shell
p43302
aVWell, black-belt skills required
p43303
aVI imagined that the availability of
p43304
aVNET 4
p43305
aV0 should have jump-started some projects that provide friendly managed wrappers
p43306
aVI just haven't seen any yet
p43307
aVTake that as a sign as well
p43308
as(dp43309
g9
V17034
p43310
stp43311
a((dp43312
g2
(lp43313
VA delay that long is almost always associated with network time-outs
p43314
aVUse the trouble-shooting strategy demonstrated by Mark Russinovich in this blog post
p43315
as(dp43316
g9
V17034
p43317
stp43318
a((dp43319
g2
(lp43320
VIt isn't
p43321
aVIt has several options for memory statistics (use View + Columns) and the version matters but the default view shows the working set
p43322
aVHow much of the virtual memory your program uses is actually in RAM
p43323
aVThat's a statistical number that can change very quickly
p43324
aVJust minimize the main window of your app for example
p43325
aVThe VM size it can show isn't great either
p43326
aVThat number includes free heap blocks
p43327
aVGetting actual memory in use is very tricky, read the small print in the SDK article for HeapWalk
p43328
aVIt is useless for leak detection, unless you leak gobs of it
p43329
as(dp43330
g9
V17034
p43331
stp43332
a((dp43333
g2
(lp43334
VYou'd have to implement your own scripting host
p43335
aVDon't know much about it, ought to be challenging in C#
p43336
aVStart reading here
p43337
as(dp43338
g9
V17034
p43339
stp43340
a((dp43341
g2
(lp43342
VNo, you can definitely trust the GC
p43343
aVYou can't trust DLLs that you didn't write that start threads that call Socket
p43344
aVReceive()
p43345
aVYou'll have to tackle this by talking to the owner of the DLL code
p43346
aVIf you actually created the thread yourself then set its IsBackground property to true
p43347
as(dp43348
g9
V17034
p43349
stp43350
a((dp43351
g2
(lp43352
VApplication
p43353
aVRun() automatically creates an ApplicationContext
p43354
aVYou can get a reference to it with the Application
p43355
aVApplicationContext property
p43356
aVCall its ExitThread() method to force the message loop to terminate
p43357
aVCreating your own and passing it to Run() is also possible, no real advantage that I can think of
p43358
aVOther than it serving as a base class for your controller
p43359
aVThe Run() method call logically belongs in your controller as well
p43360
as(dp43361
g9
V17034
p43362
stp43363
a((dp43364
g2
(lp43365
VWrong MemoryStream method
p43366
aVGetBuffer() returns the underlying buffer, it is always larger (or exactly as large) as the data in the stream
p43367
aVVery efficient because no copy needs to be made
p43368
aVBut you need the ToArray() method here
p43369
aVOr use the Length property
p43370
as(dp43371
g9
V17034
p43372
stp43373
a((dp43374
g2
(lp43375
VWideCharToMultiByte seems the more logical route
p43376
aVIt can handle strings that aren't zero-terminated and produces a terminated one
p43377
aVAnd it tries to do something meaningful with codepoints that don't have a character in the system code page
p43378
aVThen just strcmp()
p43379
as(dp43380
g9
V17034
p43381
stp43382
a((dp43383
g2
(lp43384
VYou need to make the console screen buffer the same size as the console window
p43385
aVGet the window size with GetConsoleScreenBufferInfo, srWindow member
p43386
aVSet the buffer size with SetConsoleScreenBufferSize()
p43387
as(dp43388
g9
V17034
p43389
stp43390
a((dp43391
g2
(lp43392
VYeah, you're overdoing it
p43393
aVNothing good is going to happen when you throw an exception, any exception, that program isn't magically going to start running when you do
p43394
aVOnly bad things might happen, like some code actually catching that exception and trying to continue
p43395
aVOr nobody catching it and getting a Windows Error Report dialog
p43396
aVMight as well put up a message box and call it a day with Environment
p43397
aVExit()
p43398
aVOf course, it could be more useful to the user if you actually start that program if you find it isn't running
p43399
as(dp43400
g9
V17034
p43401
stp43402
a((dp43403
g2
(lp43404
VYou'll have to override WndProc() to intercept the mouse messages
p43405
aVLike this:
p43406
as(dp43407
g9
V17034
p43408
stp43409
a((dp43410
g2
(lp43411
VYou would need to P/Invoke GetFontUnicodeRanges()
p43412
aVNot easy to do because the font needs to be selected in the device context, that requires more p/invoke
p43413
aVBut most of all, it isn't the right thing to do
p43414
aVYou should rely on Windows' automatic font linking, it finds another font if necessary to supply the glyph
p43415
aVThe feature is described in this article
p43416
as(dp43417
g9
V17034
p43418
stp43419
a((dp43420
g2
(lp43421
VHmya, I've seen problems with NAudio like this before
p43422
aVIt uses mmsystem in a way that makes deadlock pretty common
p43423
aVNot so sure it deserves the blame, it uses the API in a documented way
p43424
aVJust a way that rarely is put to the test
p43425
aVAudio drivers are also a common source of trouble, the cut-throat competition doesn't seem to leave much money for a good software engineer
p43426
aVUnplugging devices while they are in use is always a problem, works about as well as jerking a flash drive out of the USB slot while it is being written to
p43427
aVOr unplugging a USB serial port emulator while the port is open
p43428
aVThe urge to unplug devices while they are used seems irresistible
p43429
aVAlbeit that they'll get bored with it after trying it a few times
p43430
aVMaybe Larry Osterman may have some input, he worked on the audio layer a lot
p43431
aVHe posts here, you could leave a message at his blog to direct him to this question
p43432
aVBeyond that, you'll need to find a way to get the NAudio author to work together with Microsoft Support
p43433
aVOr tackle this yourself, source code is provided for a reason
p43434
aVGood luck
p43435
as(dp43436
g9
V17034
p43437
stp43438
a((dp43439
g2
(lp43440
VThe biggie: Tools + Options, Debugging, General, Supress JIT optimization on module load
p43441
aVYou want that off if you want to debug release code and get comparable perf
p43442
aVThat does however make it harder to debug your code, the JIT optimizer will store local variables in CPU registers (Watch won't work) and reorder and inline code (stepping acts weird)
p43443
aVThen there's the DebuggableAttribute, automatically generated by the compiler
p43444
aVIts IsJITOptimizerEnabled and IsJITTrackingEnabled properties matter
p43445
aVFor one, they work to keep local variables alive just a wee bit longer than necessary, preventing the garbage collector from collecting references that you might want to inspect in the debugger
p43446
aVEasy to avoid, just debug the Release build instead of the Debug build
p43447
aVThen there is specific stuff that happens in your program that wakes up the debugger and make it steal CPU cycles:
p43448
aVwhen your program throws an exception
p43449
aVThe debugger gets a shot at it before it is thrown
p43450
aVCalled a "first chance notification", you see it in the Output window
p43451
aVThat's what makes the Debug + Exceptions dialog work
p43452
aVSlows down the exception processing a lot
p43453
aVwhen your program loads or unloads a DLL
p43454
aVLots of stuff happens at load time, the debugger tries to find symbols for the DLL
p43455
aVChecks if any breakpoints need to be activated
p43456
aVAnd displays a notification in the Output window
p43457
aVThis typically only makes the startup of your program slow, especially when you've got mixed-mode debugging turned on
p43458
aVwhen you use the Trace class with the DefaultTraceListener, Debug
p43459
aVWrite/Line() method or Console
p43460
aVWrite/Line with the hosting process enabled
p43461
aVThe output appears in the Output window, slows down these calls a lot
p43462
aVwhen a thread in your program is started or stops
p43463
aVVisible in the Output window
p43464
aVGetting this to slow down your program would be a design mistake
p43465
aVThat's about it, the debugger stays out of the way and lets your code run at full speed as long as it doesn't do what's listed above
p43466
aVRuntime environments like ASP
p43467
aVNET and Silverlight are special and probably have additional overhead
p43468
aVSo does debugging an Any CPU program on a 64-bit operating system, that requires the remote debugger because VS is 32-bit only
p43469
as(dp43470
g9
V17034
p43471
stp43472
a((dp43473
g2
(lp43474
VIt doesn't say
p43475
aVThe only thing that makes sense to me is that it indicates that the table corresponding with a bit in the vector is in fact sorted
p43476
aVChapter 22 only says "certain tables are required to be sorted", leaving enough room to allow other tables, perhaps added in the future, to be optionally sorted
p43477
as(dp43478
g9
V17034
p43479
stp43480
a((dp43481
g2
(lp43482
VA user control is a container for other controls
p43483
aVHaving hundreds of them probably means you have multiple hundreds of windows in your project
p43484
aVA window is a very expensive operating system object
p43485
aVThey start to noticeably drag down painting perf when you have more than 50 or so
p43486
aVThe comparison to Outlook is apt
p43487
aVThat's a good sized chunk of a program
p43488
aVIt has less than 50 windows
p43489
aVEasy to see with Spy++
p43490
aVThe difference is OnPaint
p43491
aVMicrosoft wrote a lot of code, they didn't drop a lot of controls on a form
p43492
as(dp43493
g9
V17034
p43494
stp43495
a((dp43496
g2
(lp43497
VWell, you are having trouble with the one compiler that tries very hard to crash your program on purpose
p43498
aVIt's called "Run-time error checks", the /RTC option compile option
p43499
aVYou can turn it off to make it behave like those other ones
p43500
aVOr you could pursue the "something's wrong here" angle
p43501
aVIt's well documented in the MSDN Library article for /RTC
p43502
as(dp43503
g9
V17034
p43504
stp43505
a((dp43506
g2
(lp43507
VYou'll have to give it a different [AssemblyVersion]
p43508
aVWhich ultimately makes sense, if the version numbers are the same then there's no reason that the GAC version wouldn't be good
p43509
as(dp43510
g9
V17034
p43511
stp43512
a((dp43513
g2
(lp43514
VUse CreateToolhelp32Snapshot and Process32First/Next to iterate the running processes
p43515
aVFiguring out which one you'd want to abort if there's more than one instance of the process is of course not really possible
p43516
as(dp43517
g9
V17034
p43518
stp43519
a((dp43520
g2
(lp43521
VMany paints will take place on the same image
p43522
aVWindows fires the Paint event whenever part of the control needs to be repainted
p43523
aVLike when you drag another window across the PB
p43524
aVOr minimize and restore the form
p43525
aVIn other words, Paint doesn't tell you that the image changed
p43526
aVYou'll need to derive your own class from PictureBox and override the Image property
p43527
aVThe setter will be called when the image is changed
p43528
as(dp43529
g9
V17034
p43530
stp43531
a((dp43532
g2
(lp43533
VIt is not impossible
p43534
as(dp43535
g9
V17034
p43536
stp43537
a((dp43538
g2
(lp43539
VI think the primary reason is that
p43540
aVNET exception messages are localized
p43541
aVThe actual message text needs to be retrieved from a string resource
p43542
aVBetter to put that kind of code in one place so that nobody will fumble the string resource name
p43543
aVThe idea of using a factory so that the actual exception type can be tweaked strikes me as less than useful
p43544
aVDoing so can break a lot of client code that, for whatever reason, tries to catch that exception
p43545
aVOnce you ship code that throws a specific exception, you're pretty much stuck with it
p43546
aVChoose wisely :)
p43547
as(dp43548
g9
V17034
p43549
stp43550
a((dp43551
g2
(lp43552
VProject + Properties, Debugging, untick "Enable the Visual Studio hosting process"
p43553
aVI can't discover what it is doing
p43554
aVAs soon as I tick the "Enabled unmanaged code debugging" option to try to get a peek at these threads, they no longer get started
p43555
aVNo clue
p43556
aVBut I'm sure it's for our benefit :)
p43557
as(dp43558
g9
V17034
p43559
stp43560
a((dp43561
g2
(lp43562
VI know of one good use for this: you have to do this to declare a COM interface that's derived from another COM interface
p43563
aVIt is touched upon in this magazine article
p43564
aVFwiw, the author completely misidentifies the source of the problem, it has nothing to do with an 'inheritance tax'
p43565
aVCOM simply leverages the way a typical C++ compiler implements multiple inheritance
p43566
aVThere's one v-table for each base class, just what COM needs
p43567
aVThe CLR doesn't do this, it doesn't support MI and there's only ever one v-table
p43568
aVInterface methods are merged into the v-table of the base class
p43569
as(dp43570
g9
V17034
p43571
stp43572
a((dp43573
g2
(lp43574
VYeah, this doesn't work in practice
p43575
aVFirst for a technical reason, a typical low-fragmentation heap implementation doesn't make large free blocks available for small allocations
p43576
aVBut the real problem is that you don't know why you ran out of virtual memory space
p43577
aVAnd if you don't know why then there's nothing you can do to prevent that extra memory from being consumed very rapidly and still crash your program with OOM
p43578
aVWhich is very likely to happen, you've already consumed close to two gigabytes, that extra 5 MB is a drop of water on a hot plate
p43579
aVAny kind of scheme that switches the app into 'emergency mode' is very impractical
p43580
aVYou'll have to abort running code so that you can stop, say, loading an enormous data file
p43581
aVThat requires an exception
p43582
aVNow you're back to what you already had before, std::badalloc
p43583
as(dp43584
g9
V17034
p43585
stp43586
a((dp43587
g2
(lp43588
VThe first syntax cannot work, that's C# syntax sugar that C++/CLI doesn't have
p43589
aVThe problem with the 2nd snippet is that the delegate type doesn't match the signature of your event handler
p43590
aVThe delegate was declared like this:
p43591
aVYou'll have to change your method signature to:
p43592
aVHow you're supposed to get a reference to the frame is not clear from your snippets
p43593
aVI'd guess at a property on the class
p43594
as(dp43595
g9
V17034
p43596
stp43597
a((dp43598
g2
(lp43599
VFileDrop is standard, covered by the DataFormats class
p43600
aVShell IDList and FileName/W are common for Windows Explorer
p43601
aVThe rest of them are all custom
p43602
aVBy their names, it sounds like they enhance the D+D feedback when you drag to other Microsoft apps, like Media Player
p43603
aVThis stuff is poorly documented, possibly intentional
p43604
as(dp43605
g9
V17034
p43606
stp43607
a((dp43608
g2
(lp43609
VThis makes little sense
p43610
aVIf your app can run as a 32-bit process and doesn't need the extra virtual memory space then there's just no point in ever running it as a 64-bit process
p43611
aVNor can you easily control it
p43612
aVIt requires changing a value in the
p43613
aVexe header
p43614
aVThe Corflags
p43615
aVexe utility can do this, but you cannot distribute it
p43616
aVHacking the headers yourself is technically possible but very fugly
p43617
aVThe ultimate obstacle is that you don't typically have the write access that's required to modify the
p43618
aVexe file on a properly secured machine (ie UAC)
p43619
aVIf you really, really need to do this then just deploy two copies of the
p43620
aVexe
p43621
aVWhich you can do by writing a very puny bootstrapper
p43622
aVexe
p43623
aVAll it needs to do is Assembly
p43624
aVLoad() the main
p43625
aVexe and call its Program
p43626
aVMain() method
p43627
aVBuild two versions of it
p43628
as(dp43629
g9
V17034
p43630
stp43631
a((dp43632
g2
(lp43633
VMe
p43634
aVpleaseWaitFrm
p43635
aVClose()
p43636
aVThat's an illegal call, you are not allowed to close a form from another thread
p43637
aVNot sure how you got away with it, that should raise an IllegalOperationException when you run with a debugger
p43638
aVReview your code and delete any assignment to the Control
p43639
aVCheckForIllegalCrossThreadCalls property
p43640
aVThis exception you're getting is a clear side-effect of this
p43641
aVYou must use Control
p43642
aVInvoke() to get the dialog closed
p43643
aVThis automatically solves your problem, the delegate target cannot execute until the dialog is loaded
p43644
aVLeverage the BackgroundWorker class, it makes this easy
p43645
aVYou can close the dialog in a RunWorkerCompleted event handler
p43646
as(dp43647
g9
V17034
p43648
stp43649
a((dp43650
g2
(lp43651
VSounds like your device is picky about the voltage levels
p43652
aVRS-232 doesn't nail that down very well, allowing anywhere between +/- 5V to +/- 28V
p43653
aVMost devices are happiest with +/- 12V, a standard voltage available in desktop machines
p43654
aVLaptops however are always on the low end, +/- 5V typ
p43655
aVNot much you can do about it
p43656
aVTo test this theory, eliminate the possibility that this is induced by your code and make sure it works with a null modem
p43657
aVConnect TxD to RxD so that you receive what you send
p43658
aVThen use Hyperterminal or Putty
p43659
aVIf the latter fails to see the device as well then it's a hardware problem
p43660
as(dp43661
g9
V17034
p43662
stp43663
a((dp43664
g2
(lp43665
VConstants have no meaning in IL
p43666
aVThey are compiled by the compiler, it emits their literal value into the IL
p43667
aVYou are playing the role of the compiler when you use Reflect
p43668
aVEmit, you have emit the value yourself
p43669
aVWhich isn't a real problem, you can just declare the const in your own code
p43670
aVAnd emit the ldc or ldstr opcode whenever the const needs to be used
p43671
as(dp43672
g9
V17034
p43673
stp43674
a((dp43675
g2
(lp43676
VRun MoMA, the Mono Migration Analyzer
p43677
aVIt will tell you what the problems are
p43678
as(dp43679
g9
V17034
p43680
stp43681
a((dp43682
g2
(lp43683
VYou are not close to diagnosing the problem
p43684
aVDumpbin
p43685
aVexe doesn't show you anything that it wouldn't show for any managed assembly
p43686
aVNor is this a problem that's specific to mixing CLR dependencies
p43687
aVUse fuslogvw
p43688
aVexe to find out what dependency is missing
p43689
as(dp43690
g9
V17034
p43691
stp43692
a((dp43693
g2
(lp43694
VThe problem here of course is that you've only got one event handler for all events
p43695
aVYes, you'll need to create one handler for one event so you can have an event specific bit of data, like the name
p43696
aVBy far the cleanest way to do so is by using a lambda expression
p43697
aVBut you'll need the Sub variety, that requires VB
p43698
aVNET version 10 (VS2010)
p43699
aVFor prior versions, a dynamic method could indeed solve your problem
p43700
aVAlbeit quite painful to get going
p43701
aVWrite the code in VB
p43702
aVNET first, use Ildasm
p43703
aVexe to find out what IL you need to generate
p43704
as(dp43705
g9
V17034
p43706
stp43707
a((dp43708
g2
(lp43709
VTo be clear,
p43710
aVNET was very much intended to be a replacement for COM
p43711
aVAnd that worked out well, it's been very successful
p43712
aVBut COM is everywhere in Windows, you can't shake a stick at a typical program and not run into COM somewhere
p43713
aVThat starts with the very first bit of code in any
p43714
aVNET GUI program, [STAThread]
p43715
aVThere is lots and lots of stuff in Windows that hasn't gotten the friendly
p43716
aVNET wrapper yet
p43717
aVThat isn't always needed, the CLR has excellent support for COM interop
p43718
aVQuite visible from the Add Reference dialog, the COM tab is filled with goodies
p43719
aVBut what you see in that list are components that were specifically engineered to be easy to use from any runtime environment
p43720
aVThey implement a subset of COM called "OLE Automation"
p43721
aVAutomation is a very restricted subset, it works so well because what you actually can do is limited
p43722
aVThere are however gobs of code that don't fit that subset
p43723
aVThe kind for which you can't find a type library
p43724
aVWithout the type library you're screwed in
p43725
aVNET
p43726
aVThe most visible component with that issue is the shell
p43727
aVWindows Explorer
p43728
aVWriting a shell extension in managed code is hard
p43729
aVThe issue is that COM interface declarations were originally designed to work well on a compiler that implements multiple inheritance
p43730
aVC++ specifically
p43731
ag3471
aVNET interface declaration does not map well to a COM interface if that COM interface was derived from another COM interface
p43732
aVThe CLR generates the wrong v-table
p43733
aVThis is touched upon in this MSDN magazine article, albeit that the author's conclusion is quite wrong
p43734
aVYou can write COM interface declarations in a
p43735
aVNET language and implement them
p43736
aVIt is just that you get no help at all from the SDK
p43737
aVAnd that you'll need to know COM pretty well to get them right
p43738
aVUMDF fits this model too, its interfaces are derived from IUnknown
p43739
aVNo type library
p43740
aVNo managed wrapper that I know of
p43741
aVYou could write your code in C# but you'll have to write all the interface declarations yourself
p43742
aVRealistically, only C++ applies here
p43743
aVYes, you'll need to learn COM
p43744
as(dp43745
g9
V17034
p43746
stp43747
a((dp43748
g2
(lp43749
VYou are doing battle with the designer for TLP
p43750
aVIt is a custom one, as you can clearly see by the way it behaves in design mode
p43751
aVUsing the InitLayout() method to initialize the TLP is not correct, it's too late
p43752
aVYou should do it in the constructor instead
p43753
aVBut that still won't get you what you want, the TLP designer hard-codes the number of rows and columns when it initializes to 2x2
p43754
aVAnd it can't handle code changing it at design time (like you did in InitLayout), there are no events to listen to
p43755
aVYou will have to give up on that designer
p43756
aVShould be okay since you already initialize the TLP the way you want it
p43757
aVUse the [Designer] attribute to fall back to ControlDesigner
p43758
aVIf that's hardship for your control then you will have to create your own designer
p43759
aVUse Reflector to look at the internal TableLayoutPanelDesigner class to get a start on that
p43760
aVBeware that it isn't a simple designer
p43761
aVYou see those property assignments in InitializeComponent because the [DefaultValue] attribute on those properties declares a different default
p43762
aVYou can fix that by adding a private ShouldSerializeRowCount (and ColumnCount) method to your class
p43763
aVReturn false to prevent the property from being serialized
p43764
as(dp43765
g9
V17034
p43766
stp43767
a((dp43768
g2
(lp43769
VIt is a named mutex so it is visible and can be opened in other processes
p43770
aVWindows uses a simple reference count on the handle
p43771
aVIf you don't Dispose() it explicitly yourself then the finalizer will do it
p43772
aVIf your program bombs hard and never executes the finalizer then Windows will do it when it cleans up the resources used by your program
p43773
aVThat will automatically decrement the reference count
p43774
aVIf that counts down to zero (no other processes have a handle open on it) then the kernel object is released
p43775
aVIn other words: you don't have a problem no matter how badly things turn out
p43776
aVThe actual mutant object lives in the kernel memory pool
p43777
aVYou can see it with the SysInternals' WinObj tool
p43778
as(dp43779
g9
V17034
p43780
stp43781
a((dp43782
g2
(lp43783
VA terabyte disk is a hundred bucks
p43784
aVHard to run out of space these days
p43785
aVSure, storing the data in binary saves space
p43786
aVBut there's a cost, you'll have a lot less choices to get the data out of the file again
p43787
aVCheck what your operating system can do
p43788
aVWindows supports automatic compression on folders for example, the file content get zipped by the file system without you having to do anything at all
p43789
aVCompression rates should compete well with raw binary data
p43790
as(dp43791
g9
V17034
p43792
stp43793
a((dp43794
g2
(lp43795
VThere's no generic solution to this, you can't just interrupt a thread and deliver a notification to be processed
p43796
aVThat causes horrible re-entrancy problems and large servings of deadlock
p43797
aVA notification can only be processed when the thread is in a quiescent state
p43798
aVAn operating system usually has services available that make it possible
p43799
aVIn Windows this is typically done by posting a message to the message queue
p43800
aVRead by the message loop, which is the 'idle' state for a UI thread
p43801
aVOr by leveraging asynchronous procedure calls, fired when the thread is blocking and explicitly allowed APCs to run
p43802
aVBut you cut this off by requiring a non-platform specific solution
p43803
aVIn which case you're pretty much doomed to re-invent an OS feature
p43804
aVYou'll need a thread-safe queue that you poll in the thread that needs to receive the notification
p43805
aVA message queue, read by a message loop
p43806
as(dp43807
g9
V17034
p43808
stp43809
a((dp43810
g2
(lp43811
VIt is a quirk of Internet Explorer, it starts multiple processes for one session
p43812
aVKilling one of them can cause all of them to exit
p43813
aVYou probably see the "process has exited" exception
p43814
aVDo it like this instead:
p43815
as(dp43816
g9
V17034
p43817
stp43818
a((dp43819
g2
(lp43820
VYou tend to battle floating point round-off with the Graphics class, all transformations are calculated with single precision FP
p43821
aVYou avoid it by scaling your model instead of letting Graphics do it
p43822
as(dp43823
g9
V17034
p43824
stp43825
a((dp43826
g2
(lp43827
VYes, you do it in your message loop
p43828
aVAt the exact location where a traditional message loop has the TranslateAccelerator() call
p43829
aVWhich performs the same kind of operation, catching short-cut keystrokes and turning them into WM_COMMAND messages
p43830
aVA typical class library implements this with a "PreProcessMessage" method
p43831
as(dp43832
g9
V17034
p43833
stp43834
a((dp43835
g2
(lp43836
VNormal events are not responsive enough, since the backend call somehow consumes so much time
p43837
aVThat's not how it works
p43838
aVUnderstand the "message loop" is pretty important, be sure to read up on it
p43839
aVIn a nutshell, Windows can only tell your program that a button was clicked when the main thread of program is idle
p43840
aVYour main thread should always be idle, ready to jump into action when some bit of work needs to be done
p43841
aVLike painting your form or processing a keystroke
p43842
aVOr doing something when the user clicks the Cancel button
p43843
aVWhich means that something else needs to do the heavy lifting
p43844
aVA thread
p43845
aVBy far the best way to get started in the troublesome world of threading is the BackgroundWorker class
p43846
aVIt has a CancelAsync() method, explicitly designed to do what you want to do
p43847
aVBe sure to review the code sample provided in the MSDN Library article for this method
p43848
as(dp43849
g9
V17034
p43850
stp43851
a((dp43852
g2
(lp43853
VThis is really rather fundamental to the way the stack works
p43854
aVTo reason it out for yourself, imagine how you'd implement a recursive function
p43855
as(dp43856
g9
V17034
p43857
stp43858
a((dp43859
g2
(lp43860
VUsing Dumpbin
p43861
aVexe /exports bass
p43862
aVdll reveals this line in the output:
p43863
aVNote how it doesn't have an "s" at the end
p43864
aVWrong [DllImport] declaration in your code, probably
p43865
as(dp43866
g9
V17034
p43867
stp43868
a((dp43869
g2
(lp43870
VIt is a side-by-side configuration problem
p43871
aVYour program contains a manifest that states what DLL it needs from the SxS cache
p43872
aVAnd Windows can't find it
p43873
aVStart by looking at the Windows event log, it will tell you what DLL couldn't be found
p43874
aVThis is more typically a VS2008 problem, its DLL version of the CRT libraries are stored in the side-by-side cache
p43875
aVLike msvcrt90
p43876
aVdll
p43877
aVMaybe you didn't quite manage to get the code converted to your new build environment
p43878
aVWhich is odd, embedding the manifest is an explicit build step
p43879
aVDo check that you don't have a
p43880
aVmanifest file in your build directory
p43881
aVThis hoopla got retired in VS2010 btw
p43882
aVVS2010 Express could be your 3rd attempt
p43883
as(dp43884
g9
V17034
p43885
stp43886
a((dp43887
g2
(lp43888
VYup, that's how transparency works
p43889
aVNot just to the eye of the user, also to what the mouse sees from its left eye
p43890
aVHas to work that way, major user confusion if it didn't, no option to change it
p43891
aVThe workaround is to show a fake version of the desktop
p43892
aVA screen shot
p43893
aVJust what the ever popular Windows Snipping Tool does
p43894
aVSample code is in this thread
p43895
as(dp43896
g9
V17034
p43897
stp43898
a((dp43899
g2
(lp43900
VNot so sure what this is about and exactly what you saw on your machine
p43901
aVThere are however two distinct versions of the CLR on your machine
p43902
aVMscorwks
p43903
aVdll and mscorsvc
p43904
aVdll
p43905
aVThe former is the one you get when you run your program on a work station, the latter on one of the server versions of Windows (like Windows 2003 or 2008)
p43906
aVThe work station version is kind to your local PC, it doesn't gobble all machine resources
p43907
aVYou can still read your email while a GC is going on
p43908
aVThe server version is optimized to scale on server level hardware
p43909
aVLots of RAM (GC doesn't kick in that quick) and lots of CPU cores (garbage gets collected on more than one core)
p43910
aVYour quoted article probably talks about the server version
p43911
aVYou can select the server version on your workstation, use the  element in your
p43912
aVconfig file
p43913
as(dp43914
g9
V17034
p43915
stp43916
a((dp43917
g2
(lp43918
VYou cannot change Application
p43919
aVUnhandledExceptionMode after Application
p43920
aVRun() was called, so clearly that's not the one that's going to catch the exception
p43921
aVWhich leaves AppDomain
p43922
aVUnhandledException
p43923
aVYes, the debugger will break on the exception before that event is raised
p43924
aVNice feature, allows you to debug the exception reason
p43925
aVJust press F5 to continue execution to trigger the event handler
p43926
aVThere's no evidence of you using the debugger in the 2nd screen shot, looks like you started it with Ctrl+F5
p43927
as(dp43928
g9
V17034
p43929
stp43930
a((dp43931
g2
(lp43932
VI know I will have to implement something that will keep the hook alive
p43933
aVNo, that's not a concern
p43934
aVA global hook requires a DLL with the callback
p43935
aVThat DLL gets injected in all running processes
p43936
aVIt will stay loaded in the process until you call UnHookWindowsHookEx() or the process terminates, whichever comes first
p43937
aVDo note that you can also hook the keyboard with WH_KEYBOARD_LL
p43938
aVThat's not a global hook, Windows will switch context to your program and make the callback
p43939
aVIt is much easier to use since you don't need an IPC mechanism with the injected DLL that the global hook requires
p43940
aVThe low level hook stays active until you unhook, the thread that owns the message queue terminates or your process terminates, whichever comes first
p43941
as(dp43942
g9
V17034
p43943
stp43944
a((dp43945
g2
(lp43946
VProject + Properties, Build tab, "Conditional compilation symbols" box
p43947
as(dp43948
g9
V17034
p43949
stp43950
a((dp43951
g2
(lp43952
VYes, that's not the right way to do it
p43953
aVGraphics
p43954
aVDpix will return the resolution of the printer, commonly 600 dots per inch
p43955
aVBut what you draw is resolution independent
p43956
aVSo that you don't have to do anything special when the user selects another printer with, say, a 300 dpi resolution
p43957
aVImportant because otherwise your document would be twice as large and no longer fit the paper
p43958
aVThe resolution independent mapping is determined by Graphics
p43959
aVPageUnit
p43960
aVThe default is Display which makes one pixel 0
p43961
aV01 inches
p43962
aVIn other words, to get a 2 by 2 inch printout, you simply use a rectangle of 200 x 200
p43963
aVYou can change the PageUnit if you really want to, Inches is one of the settings
p43964
aVYou'd then use a 2x2 rectangle
p43965
aVYou of course then have to use the Graphics method overloads that take a PointF and a RectangleF, the integer versions won't work well
p43966
aVThe default (Display) is convenient because it makes what you draw on the screen about the same size as what you draw on the printer
p43967
aVBecause a common resolution for the display is 96 dpi, close enough to 1 pix == 0
p43968
aV01"
p43969
aVAllowing you to re-use code that draws stuff to the screen to draw to the printer as well
p43970
as(dp43971
g9
V17034
p43972
stp43973
a((dp43974
g2
(lp43975
VStart + Run, Charmap
p43976
aVexe
p43977
aVIn the "Search for" box type "two", Search
p43978
aVShould be the 2nd character
p43979
aVClick it, Select, Copy
p43980
aVSwitch to your code or report and hit Ctrl+V
p43981
as(dp43982
g9
V17034
p43983
stp43984
a((dp43985
g2
(lp43986
VWell, it's a feature that's built into the C++/CLI compiler, called C++ Interop
p43987
aVThere's a lot less black magic involved that you might think
p43988
aVThe JIT compiler generates the exact same kind of machine code as your C++ compiler generates
p43989
aVAll of the
p43990
aVNET value types have a direct equivalent in C++ so no conversion is needed
p43991
aVIt does not automatically handle reference types, you have to do that yourself
p43992
aVpin_ptr<>, typically
p43993
aVAll that it really does is inject a bit of code that handles the transition from a managed stack frame to an unmanaged stack frame
p43994
aVThat code puts a special "cookie" on the stack, recognized by the garbage collector
p43995
aVWhich prevents it from blundering into the unmanaged frames and mis-identify unmanaged pointers as object references
p43996
aVThere's not much to that code, takes about 5 nanoseconds in the Release build, give or take
p43997
as(dp43998
g9
V17034
p43999
stp44000
a((dp44001
g2
(lp44002
VIt's one of those very nice features of the JIT compiler: it only compiles code that is actually executed
p44003
aVDead code in the DLL will never be used
p44004
aVIt won't even be loaded in memory
p44005
aVYou can shave, say, 10 KB from the VM size of your program
p44006
aVThat saves 0
p44007
aV0005% on a 32-bit machine
p44008
aVDon't bother
p44009
as(dp44010
g9
V17034
p44011
stp44012
a((dp44013
g2
(lp44014
VThe ToolStripItem
p44015
aVSelect() method runs on MouseEnter
p44016
aVCall this
p44017
aVInvalidate() to force a repaint
p44018
as(dp44019
g9
V17034
p44020
stp44021
a((dp44022
g2
(lp44023
VYou can't
p44024
aVThis static method really does live in the assembly that has the base type
p44025
aVThe best you could do is use an instance method (omit the static keyword) so the code has access to the this reference
p44026
aVThe this
p44027
aVGetType() expression gives you the derived type
p44028
aVIts Assembly property gives you the assembly that contains the derived type
p44029
as(dp44030
g9
V17034
p44031
stp44032
a((dp44033
g2
(lp44034
V"Specific Version" is only relevant when you compile, it has no effect at runtime
p44035
aVWhen set to False, the IDE won't complain when the [AssemblyVersion] of the reference assembly has changed
p44036
aVWhich is not that great an idea, you ought to be aware of the changes you might have to make in your code because the assembly changed
p44037
aVThe CLR will not look for any version of an assembly in the GAC
p44038
aVOnly a exact match is accepted
p44039
aVThat's the default policy, you can override it with a  in the app's
p44040
aVconfig file
p44041
aVAfaik, there isn't a provider for SQL Server that's specific to the SQL Server version number
p44042
aVNot quite sure about that
p44043
as(dp44044
g9
V17034
p44045
stp44046
a((dp44047
g2
(lp44048
VIf you didn't create the BGW instance on the UI thread then its RunWorkerCompleted event is going to run on an arbitrary threadpool thread
p44049
aVAny exception you throw on that thread is uncatchable and will terminate your app with a last gasp through AppDomain
p44050
aVUnhandledException
p44051
aVIn this case, there just isn't much use for BGW anymore
p44052
aVIt is only nice to ensure that its events run on the UI thread
p44053
aVYou might as well use MethodInvoker
p44054
aVBeginInvoke()
p44055
aVYou'll need to think this through a bit and decide exactly what you're going to do when a bit of code off on some worker thread fails to do its job
p44056
aVDealing with such a mishap is generally not possible and letting the program crash and burn is the right thing to do
p44057
aVIf you do want some kind of way to notify the user and try to keep the program stumbling along then you really ought to create the BGW instance on the UI thread
p44058
aVAnd use, say, MessageBox
p44059
aVShow() in the RunWorkerCompleted event handler
p44060
aVBe sure to recover your program state when you do this, you almost certainly need a catch clause in DoWork() to clean up the shrapnel
p44061
as(dp44062
g9
V17034
p44063
stp44064
a((dp44065
g2
(lp44066
VThat looks wrong to me, the 2nd argument should have been annotated as
p44067
aVFrom the SAL Annotations documentation:
p44068
aVOptional Option
p44069
aVDescribes if the buffer itself is optional
p44070
aVThese annotations can be applied to values in the Parameters layer, Return Value layer, or Pre / Post layer
p44071
aV(none)
p44072
aVThe pointer to the buffer must not be NULL
p44073
aVopt_
p44074
aVThe pointer to the buffer might be NULL
p44075
aVIt will be checked before being dereferenced
p44076
as(dp44077
g9
V17034
p44078
stp44079
a((dp44080
g2
(lp44081
VYou can't handle problems like this with exceptions
p44082
aVYou could have a top-level catch block that catches the exception and hope that not too much state of the program got irrecoverably munched to try to keep the program alive
p44083
aVStill doesn't make the user happy, that query she is waiting for still doesn't run
p44084
aVEnsuring that changes don't destabilize a critical business app requires organization
p44085
aVPeople that sign-off on the changes and verify that they work as intended before it is allowed into production
p44086
aVQA
p44087
as(dp44088
g9
V17034
p44089
stp44090
a((dp44091
g2
(lp44092
VThis context menu is baked into Windows, there is no documented way to alter it
p44093
aVNor is there a message that you could trap to hack the menu
p44094
aVReplacing it is certainly an option, check my answer in this thread for sample code
p44095
aVBe careful with this, stuff gets added to this menu in different Windows versions
p44096
aVLike "Insert Unicode character" in Win7
p44097
aVYou definitely want to avoid this if it is likely that your product will run in an Eastern Asian country
p44098
as(dp44099
g9
V17034
p44100
stp44101
a((dp44102
g2
(lp44103
VLook in the
p44104
aVrc file of your project with a text editor
p44105
aVYou'll see something like this:
p44106
aVNote the GUID in braces
p44107
aVFire up regedit
p44108
aVexe on your old machine and navigate to
p44109
aVThere will be enough hints there to find the component you need install
p44110
aVThe InprocServer32 key points to the DLL
p44111
as(dp44112
g9
V17034
p44113
stp44114
a((dp44115
g2
(lp44116
VThis answer is "\u005cu2122" by Hans Passant\u2122
p44117
aVUse the charmap
p44118
aVexe applet and copy/paste the character in your string literal
p44119
as(dp44120
g9
V17034
p44121
stp44122
a((dp44123
g2
(lp44124
VWell, don't hesitate to make it your source, that's how most programs get started
p44125
aVIf you prefer slow build times then use Project + Properties, C/C++, Precompiled headers, Create/Use = Not
p44126
aVLook around a bit to get the lay of the land
p44127
aVPress F1 if something looks mysterious
p44128
as(dp44129
g9
V17034
p44130
stp44131
a((dp44132
g2
(lp44133
VDon't try to guess at this and write the code to tell you
p44134
aVAdd an event handler for AppDomain
p44135
aVCurrent
p44136
aVUnhandledException and display the value of e
p44137
aVExceptionObject
p44138
aVToString()
p44139
as(dp44140
g9
V17034
p44141
stp44142
a((dp44143
g2
(lp44144
VVery obscure error
p44145
aVThe term "ordinal" is however strongly associated with a DLL
p44146
aVA DLL contains a list of exported functions as well as a list of imported functions
p44147
aVOther DLLs that it has a dependency on
p44148
aVThese exports and imports usually have a name, but that's not required
p44149
aVThey always have a number, the number is the "ordinal"
p44150
aVTo start diagnosing this, use the SDK's Dumpbin
p44151
aVexe tool
p44152
aVRun this first:
p44153
aVand look at the list of exports
p44154
aVYou should see the ordinal as well as the name
p44155
aVIf that all checks out, run
p44156
aVto get a list of the dependencies
p44157
aVOdds are good that it has a dependency on a function in another DLL by number that this DLL doesn't have
p44158
aVSomething like that anyway
p44159
aVYou can probably make it less laborious by using the DependencyWalker tool
p44160
aVIf the first step fails then something went drastically wrong when the DLL was built
p44161
aVIf the second step fails then you're probably looking at some kind of DLL Hell problem
p44162
as(dp44163
g9
V17034
p44164
stp44165
a((dp44166
g2
(lp44167
VThat requires a hook set by SetWindowsHookEx, WH_SHELL
p44168
aVThe callback gets notifications like HSHELL_WINDOWACTIVATED and HSHELL_WINDOWCREATED so that you can know what's happening with the top-level windows
p44169
aVCheck out the SDK article for "ShellProc" for the full list of notifications you can get
p44170
aVJust about all of them are relevant to implementing your own taskbar
p44171
aVThat was the good news
p44172
aVThe bad news is that WH_SHELL is a global hook
p44173
aVIt requires a DLL that can be injected into another process
p44174
aVProblem is, you can't write that DLL in managed code
p44175
aVInjecting managed code into an unmanaged process is not possible
p44176
aVBack to good news again, somebody has solved that problem and has created an unmanaged DLL that is injectable and can interop with managed code
p44177
aVThe project is here
p44178
aVNo idea how good it is
p44179
aVI suspect it might not be quite UAC proof
p44180
as(dp44181
g9
V17034
p44182
stp44183
a((dp44184
g2
(lp44185
VYou'll need a
p44186
aVconfig file for your
p44187
aVexe so that the probing path is changed
p44188
aVA subdirectory is no problem, just use the  element, its privatePath attribute is a relative folder name
p44189
aVBeware however that you'll get little help from the IDE to put the DLL in that spot
p44190
aVYou'll need a post build event that creates the folder if necessary and xcopy's the DLL there
p44191
aVSomething like this:
p44192
as(dp44193
g9
V17034
p44194
stp44195
a((dp44196
g2
(lp44197
VIt is a heavy duty implementation detail
p44198
aVBut most C++ compilers I know don't try to do anything special to differentiate a C function from a non-instance C++ function
p44199
aVJust the plain olden cdecl calling convention for both
p44200
aVKinda important because the CRT implementation, with functions like printf(), are just as usable by a C compiler as they are by the C++ compiler from the same vendor
p44201
aVNobody wants to maintain two versions of it
p44202
as(dp44203
g9
V17034
p44204
stp44205
a((dp44206
g2
(lp44207
VI've got a dormant brain cell from reading Petzold 15 years ago that just sprang back to life
p44208
aVThe DC from CreateDC() is restricted
p44209
aVGood for getting info about the display device, measurement, that sort of stuff
p44210
aVNot good to use as a regular painting DC
p44211
aVYou almost certainly need GetDC()
p44212
as(dp44213
g9
V17034
p44214
stp44215
a((dp44216
g2
(lp44217
VReview the
p44218
aVhtml file for details
p44219
aVThe prottest sample app that exercise the driver is available in the src\u005cnetwork\u005cndis\u005cndisprot\u005c60\u005ctest directory
p44220
aVShows you how to use the Read/WriteFile and DeviceIoControl functions
p44221
as(dp44222
g9
V17034
p44223
stp44224
a((dp44225
g2
(lp44226
VQuote from the MSDN article:
p44227
aVMinimum and maximum timeout values are enforced by the operating system and are typically 10 and 30 seconds, respectively, however this can vary depending on the operating system
p44228
aVTimeout values that are too large or too small are adjusted to the appropriate minimum or maximum value
p44229
aVIn addition, if the user does not appear to be using the computer (no keyboard or mouse events are occurring) then the system does not count this time towards the timeout
p44230
as(dp44231
g9
V17034
p44232
stp44233
a((dp44234
g2
(lp44235
VYes, absolutely, this is not safe
p44236
aVIf the threadpool is busy, it can take seconds before the delegate target will start running
p44237
aVThe second call to FireAndForget can easily run, say, OnActivityFinished again because the delegate call got scheduled before the 1st one completed
p44238
aVThe race is there even if the TP isn't busy and you call FaF frequently
p44239
aVThere is no easy way to avoid the race that I see
p44240
as(dp44241
g9
V17034
p44242
stp44243
a((dp44244
g2
(lp44245
VIt is up to you to manage the lifetime of the COM object
p44246
aVAs long as you have a live pointer to the interface, you have to have at least one AddRef() call on the interface
p44247
aVThe final Release() call will delete the object and the pointer goes stale
p44248
aVUsing it afterwards will crash your program randomly, usually with an AV
p44249
aVThere is no way to detect if it is stale
p44250
aVYou could set m_pServer to NULL when you make your final Release() call
p44251
as(dp44252
g9
V17034
p44253
stp44254
a((dp44255
g2
(lp44256
VIt's easy to see if you translate the query comprehension to its corresponding Linq extension methods
p44257
aVThe return type of OrderBy() is IOrderedEnumerable<>
p44258
aVWhere() returns IEnumerable<>
p44259
aVWhat your first expression does is first sort all of the Points, then select only the ones that match the where clause
p44260
aVThe last operation applied is Where, thus the expression type is IEnumerable<>
p44261
aVWhich one is more efficient depends largely on the Linq provider you use
p44262
aVMy money is on sorting last
p44263
aVAlthough I'd guess that the provider is smart enough to order the operations in the best order
p44264
aVYou might want to check that
p44265
as(dp44266
g9
V17034
p44267
stp44268
a((dp44269
g2
(lp44270
VWell, your code bombed Word
p44271
aVThat doesn't happy very often, but Word is rather a large beast and probably contains thousands of bugs that haven't been found yet
p44272
aVYou'll get no help from the exception itself, it happens inside the core code
p44273
aVEven if you did have the source code for Word, you'd probably still have a helluva time finding out exactly what went wrong
p44274
aVWord is supported, you can call Microsoft Support
p44275
aVAfter you went through the outer support layers, you'll eventually get a support engineer assigned to your problem that knows Word well and can diagnose the cause
p44276
aVTo get through those outer layers, it is very important that you have a good repro available
p44277
aVThe simplest program that can trip this crash on any machine
p44278
aVOnce you got that, have your credit card ready and call them
p44279
aVThey'll give you a URL to upload your repro code
p44280
aVBe sure to stay in touch with them as your case traverses the support levels, you need to be proactive to ensure they stay on the case
p44281
aVCount on several weeks if it needs to get all the way
p44282
aVYou'll get your money back if they determine it is a bug in Word instead of your code
p44283
aVFwiw, working on getting the simple repro is usually a good way to find out what, if anything, is wrong with your code
p44284
aVGood luck
p44285
as(dp44286
g9
V17034
p44287
stp44288
a((dp44289
g2
(lp44290
VI'm fairly sure that running out of memory does not force a garbage collection
p44291
aVThat probably sounds incredibly unintuitive to you but I think this was done for a good reason
p44292
aVIt prevents the program from entering a death-spiral where it constantly tries to find more space and getting all objects firmly lodged into gen #2
p44293
aVFrom which it is very hard to recover again
p44294
aVThe true argument you pass to GetTotalMemory() forces a full garbage collection
p44295
aVI would guess that this happens to free up enough space in the Large Object Heap to satisfy the memory allocation
p44296
aVThis will of course work only once
p44297
aVIf your program just keeps running, gobbling up memory beyond the 1
p44298
aV5 gigabytes or so that it has already consumed then OOM is just around the corner again
p44299
aVThis time without any way to recover
p44300
aVSurviving an OOM requires drastic measures
p44301
aVYou'll need a good memory profiler to find out what's really going on
p44302
aVUnmanaged C++ in your project is always a fertile source of memory leaks
p44303
aVThe unmanaged kind, always hard to trouble-shoot
p44304
as(dp44305
g9
V17034
p44306
stp44307
a((dp44308
g2
(lp44309
VYou will have to add a manifest to your program (or edit the existing one) to turn DPI Virtualization off
p44310
aVIt should look like this:
p44311
aVThat's not unlikely to cause several new problems
p44312
aVEverything you'd want to know about this is covered very well in this MSDN Library article
p44313
as(dp44314
g9
V17034
p44315
stp44316
a((dp44317
g2
(lp44318
VBckg
p44319
aVdll is not a COM component, it doesn't have a type library
p44320
aVAll you can eke out of it is the names of the exported functions
p44321
aVDumpbin
p44322
aVexe /exports shows this:
p44323
aVRemoveKibitzer sounds very interesting
p44324
aVAnyhoo, you can't reverse-engineer the arguments of these functions from the dump
p44325
aVMessageHandler and ProcessMessage would typically be your ultimate nemesis with just no way to figure out exactly what kind of messages are processed and handled
p44326
aVThis is a no-go
p44327
aVPublic service message for anyone interested in running the superior XP version on Vista or Win7: after copying the c:\u005cprogram files\u005cmsn gaming zone\u005cwindows folder, run zClientm /regserver at the command prompt to get it installed
p44328
as(dp44329
g9
V17034
p44330
stp44331
a((dp44332
g2
(lp44333
VIt is probably too late to talk you out of this, but this does not work
p44334
aVThreading races are caused by subtle timing issues between threads
p44335
aVYou can never diagnose timing related problems with logging
p44336
aVHeisenbergian, just logging alters the timing of a thread
p44337
aVEspecially the kind you are contemplating
p44338
aVInfamously, there's plenty of software that shipped with logging kept turned on because it would nosedive with it turned off
p44339
aVFlushing out threading bugs is hard
p44340
aVThe kind of tool that works is one that intentionally injects random delays in code
p44341
aVMicrosoft CHESS is an example, works on native code too
p44342
as(dp44343
g9
V17034
p44344
stp44345
a((dp44346
g2
(lp44347
VI cannot do it in form closing
p44348
aVYou have to do it from your FormClosing event handler
p44349
aVPay attention to the e
p44350
aVCloseReason value
p44351
aVFwiw, the 'security requirements' are a pipe dream with System
p44352
aVReflection in a programmer's arsenal
p44353
aVYou'll have to setup a sandbox to prevent that
p44354
as(dp44355
g9
V17034
p44356
stp44357
a((dp44358
g2
(lp44359
VYeah, this cannot work
p44360
aVYou are bypassing the printer driver with this code, you would have to generate print commands in the name language of the printer
p44361
aVPCL, Postscript are common printer control languages
p44362
aVBut anything goes, manufacturers often create their own custom variety
p44363
aVLooks like you are sending PDF, I don't know any printer that uses PDF as its native control language
p44364
aVMaybe such a printer exists, clearly the one you have doesn't
p44365
aVI can't really guess why you'd use a Webforms class in a service, hard to provide an alternative
p44366
aVPrinting from a service is a bad idea in general, printer drivers are far too happy to put up "change the toner" prompts
p44367
aVShown on an invisible desktop
p44368
as(dp44369
g9
V17034
p44370
stp44371
a((dp44372
g2
(lp44373
VIf you don't see it in Tools + Customize for "Debug | Windows" then you won't ever see it
p44374
aVUse Add Command
p44375
aVOr Tools + Import/Export, Reset
p44376
as(dp44377
g9
V17034
p44378
stp44379
a((dp44380
g2
(lp44381
VYou can't dig the native interface pointer out of the RCW
p44382
aVBut you can call Marshal
p44383
aVGetComInterfaceForObject(), should be good as long as you ask for the right interface
p44384
aVFrom there, you can Marshal
p44385
aVReadIntPtr() to get the v-table entries
p44386
aVOffset 0 is QueryInterface, 4 is AddRef, 8 is Release, 12 is the first interface method, etc
p44387
aVDouble that for x64 code
p44388
aVMarshal
p44389
aVGetComSlotForMethodInfo() is an option
p44390
aVActually calling the method requires Marshal
p44391
aVGetDelegateForFunctionPointer(), you need to declare the delegate with the exact signature of the COM interface method
p44392
aVThat won't be the signature it has when you call this method normally, it is the [PreserveSig] signature
p44393
aVIn other words, a function that returns HRESULT and a ref argument if it returns a value
p44394
aVOpportunities to bomb your program are plentiful
p44395
aVAfter update: you need Marshal
p44396
aVGetFunctionPointerForDelegate and Marshal
p44397
aVWriteIntPtr to patch the v-table slot entry
p44398
as(dp44399
g9
V17034
p44400
stp44401
a((dp44402
g2
(lp44403
VNah, threads don't silently terminate, they make a loud kaboom sound
p44404
aVAt the very least you'll see the thread exit notification in the Output window
p44405
aVThe Process
p44406
aVStart() method blocking would be another explanation, albeit that there's no explanation for it
p44407
aVYou're snippet is far too short to come up with a decent diagnostic
p44408
aVSomething environmental perhaps
p44409
aVYour stack trace helps, ShellExecuteOnSTAThread() does in fact perform a blocking Thread
p44410
aVJoin() on a little helper thread
p44411
aVThis thread is necessary to call the native ShellExecuteEx() API function, it can only be called from an STA thread
p44412
aVIt has a flaw though, an STA thread must also pump a message loop
p44413
aVThis little helper doesn't
p44414
aVThat this causes a problem on your machine still points to an environmental problem, some kind of system add-on that hijacks the ShellExecuteEx() call
p44415
aVAnd counts on running a real STA thread
p44416
aVYou should be able to find that helper thread back in the Debug + Windows + Threads window
p44417
aVIt should contain "ShellExecuteFunction" on the stack
p44418
aVThe kind of 'system add-on' that pulls stunts like this are virus scanners, for example
p44419
aVYou should be able to find that alienware back in the Debug + Windows + Modules window after you checked the "Enable unmanaged debugging" in the project's Debugging tab
p44420
aVThe workaround to use UseShellExecute = false is quite acceptable here btw
p44421
aVJust the fact that your machine is kinda messed up, by the looks of it, isn't of course
p44422
as(dp44423
g9
V17034
p44424
stp44425
a((dp44426
g2
(lp44427
VGood news: EM_STREAMOUT helps you retrieve the RTF, the kind that has the formatting
p44428
aVBad news: you cannot make that work without injecting a DLL into the process since it requires a callback
p44429
aVYou can't make that work in C#, native C/C++ is required
p44430
aVI know, not helpful
p44431
as(dp44432
g9
V17034
p44433
stp44434
a((dp44435
g2
(lp44436
VIt's documented in this MSDN page:
p44437
aV(SSF_SHOWALLOBJECTS)
p44438
aVThe state of the Show hidden files and folders option
p44439
aV(SSF_SHOWSYSFILES)
p44440
aVThe state of the Do not show hidden files and folders option
p44441
aV(SSF_SHOWSUPERHIDDEN)
p44442
aVThe state of the Hide protected operating system files option
p44443
as(dp44444
g9
V17034
p44445
stp44446
a((dp44447
g2
(lp44448
VYou'll see a rectangle if the font you use doesn't contain the glyph
p44449
aVYou know that's not the case, Tahoma definitely has the 
p44450
aVWhich means that the real problem is that you didn't real the file correctly
p44451
aVYou'll need to find out how the text in the file is encoded
p44452
aVYou know it isn't UTF8, that's the default for StreamReader
p44453
aVYour next guess probably ought to be:
p44454
as(dp44455
g9
V17034
p44456
stp44457
a((dp44458
g2
(lp44459
VThe real issue here is: what's your standard for naming variables that hold a reference
p44460
aVI always pick good variables names without fail, I like Id :)  The framework classes heavily favor plain Id
p44461
as(dp44462
g9
V17034
p44463
stp44464
a((dp44465
g2
(lp44466
VYou probably came across the sample code in the MSDN doc page for ComVisibleAttribute
p44467
aVYeah, that's bogus
p44468
aVFrom that same page, emphasis mine:
p44469
aVSetting the attribute to false  on a specific type hides that type and its members
p44470
aVHowever, you cannot make members of a type visible if the type is invisible
p44471
aVSetting the attribute to false on a type prevents that type from being exported to a type library; classes are not registered; interfaces are never responsive to unmanaged QueryInterface calls
p44472
aVBad example code
p44473
as(dp44474
g9
V17034
p44475
stp44476
a((dp44477
g2
(lp44478
VThe argument will appear as Char* on the C# side
p44479
aVThat requires unsafe code, like this:
p44480
aVIt makes very little sense to expose the LPCOLESTR to other managed code
p44481
aVThis method really should accept a String^ and convert to wchar_t* internally
p44482
as(dp44483
g9
V17034
p44484
stp44485
a((dp44486
g2
(lp44487
VEach AD will have to register its own AssemblyLoad event
p44488
aVYou will obviously miss at least the 1st assembly you load into it
p44489
aVThe idea of a "process-side" event is murky, these event handlers cannot share anything since each AD has its own garbage collected heap
p44490
aVI guess you could serialize info back to the primary AD
p44491
as(dp44492
g9
V17034
p44493
stp44494
a((dp44495
g2
(lp44496
VThread::intermediateThreadProc() is a little helper function in the CLR that's used as the thread start function for any thread started by the CLR
p44497
aVFind it back in the SSCLI20 source, src\u005cvm\u005cthreads
p44498
aVcpp
p44499
aVSeeing this run on another thread is to be expected
p44500
aVCleanup code runs when the appdomain gets unloaded
p44501
aVThe CLR logic for it is mighty complicated, but it looks like it will run when the appdomain runs the finalizer thread for the last time to clean up the heap
p44502
aVYou can assume that all managed objects are dead and there are no other threads running
p44503
aVBeware that your code is subject to the two second finalizer thread timeout
p44504
as(dp44505
g9
V17034
p44506
stp44507
a((dp44508
g2
(lp44509
VUnusual
p44510
aVYou need to find the greatest common divisor and divide width and height by it
p44511
aVThe algorithm is by Euclid and is two thousand three hundred years old
p44512
aVDetails are here
p44513
as(dp44514
g9
V17034
p44515
stp44516
a((dp44517
g2
(lp44518
VYou make a dot-matrix printer fast by bypassing the driver for it
p44519
aVThe driver will use the graphics mode of the printer, works well for the kind of output generated by Windows programs but is very slow
p44520
aVYou will however now need to send the native print commands to the printer for special effects, usually control characters or escape sequences
p44521
aVFont size support tend to be limited, usually just double-height
p44522
aVBut that really depends on the specific printer
p44523
aVTo learn what to send to the printer you will need to obtain the programming manual from the vendor
p44524
as(dp44525
g9
V17034
p44526
stp44527
a((dp44528
g2
(lp44529
VYou're okay, no need to worry
p44530
aVA memory barrier is required to flush any pending writes to memory
p44531
aVThere's an implicit one with any lock statement
p44532
aVControl
p44533
aVBegin/Invoke() needs to take a lock to protect the list of pending delegates so that's sufficient
p44534
aVThe volatile requirement is a harder one, mostly because its exact semantics are so poorly documented
p44535
aVOn x86/x64 hardware it merely prevents the JIT compiler from caching the value of a variable in a CPU register
p44536
aVThis is not an issue in your case because the delegate target points to a method
p44537
aVVariables are not cached across methods if the methods are not inlined
p44538
aVYour delegate target cannot be inlined
p44539
as(dp44540
g9
V17034
p44541
stp44542
a((dp44543
g2
(lp44544
VChicken and egg problem
p44545
aVYou need a little bootstrapper assembly that you can load in the new AppDomain
p44546
aVWith a well-known class that loads the CodeDom generated assembly and gets it going
p44547
aVDoing this with GenerateInMemory is pretty pointless, you would have to serialize that into the new AppDomain
p44548
aVThat's just a bunch of overhead, might as well load it from disk, it is there anyway
p44549
aVAnd it is already in memory
p44550
aVThe file system cache's memory
p44551
aVLoading it will be very fast since it doesn't actually have to be read off the disk
p44552
as(dp44553
g9
V17034
p44554
stp44555
a((dp44556
g2
(lp44557
VYeah, mspdbsrv
p44558
aVexe would be a hangup
p44559
aVIt is a service required to arbitrate access to the program database to allow concurrent compilation
p44560
aVCan't get a service going without getting the registry entries right
p44561
aVThis did not improve in VS2010
p44562
aVIt has an entirely new build system, based off MSBuild
p44563
aVThere's a ton of stuff that needs to be set just right in the registry
p44564
aVPretty unlikely to get that right and trouble-free without using the installer
p44565
aVTakes half an hour or so, not worth your time
p44566
as(dp44567
g9
V17034
p44568
stp44569
a((dp44570
g2
(lp44571
VCDO is hopelessly obsolete, you really need to consider switching to System
p44572
aVNet
p44573
aVMail
p44574
aVThe specific problem sounds like a file locking issue
p44575
aVQuacks like a bug in CDO, it would open the attachment to compose the email message but forgets to close the file when the SMTP server balks
p44576
aVThis bug is probably exacerbated by the way
p44577
aVNET deals with COM servers, like CDO
p44578
aVThe COM object doesn't get released until the garbage collector runs
p44579
aVWhich can take a while, especially when your program doesn't do anything significant after trying to send the email
p44580
aVA workaround for that is calling Marshal
p44581
aVReleaseComObject() on the CDO object
p44582
aVTends to not work when you have other CDO interface references in your program, those references tend to be hidden
p44583
aVGC
p44584
aVCollect() + GC
p44585
aVWaitForPendingFinalizers() is the big hammer, after you nulled any object reference
p44586
aVBut, really, use System
p44587
aVNet
p44588
aVMail
p44589
as(dp44590
g9
V17034
p44591
stp44592
a((dp44593
g2
(lp44594
VThe Module keyword in VB
p44595
aVNET primarily exists for compatibility with VB6 and earlier
p44596
aVBack then, most VB code was procedural with free-standing non-class Subs and Functions
p44597
aVThe language acquired the Class keyword somewhere around VB4
p44598
aVNot true classes in the OOP sense, it didn't support inheritance
p44599
aVA feature missing from the underlying COM architecture
p44600
aVIt doesn't fit very well with the execution model provided by the CLR
p44601
aVThere is no support for free functions, every method must be a member of a class
p44602
aVThe VB
p44603
aVNET compiler emulates modules by declaring a class, the module procedures become Shared methods of that class
p44604
aVYou can see this with Ildasm
p44605
aVexe:
p44606
aVNote how it is private, so that code can't get a reference to it, and sealed, so that no code can derive a class from a module
p44607
aVThe C# compiler does the exact same thing with a "static class", the CLR doesn't have a notion of static classes either
p44608
aVThere are plenty of good reasons for static classes, the idea of "Module" isn't obsolete
p44609
aVYou could accomplish the same by declaring a NotInheritable Class in VB
p44610
aVNET code, having only Shared methods
p44611
aVThe VB
p44612
aVNET compiler however doesn't enforce methods to be Shared like the C# compiler does and doesn't allow you to declare the class private
p44613
aVAs such, a Module is just fine
p44614
as(dp44615
g9
V17034
p44616
stp44617
a((dp44618
g2
(lp44619
VYou could do it with the CImage::Load(IStream*) function
p44620
aVYou can get the IStream from CreateStreamOnHGlobal() or create your own
p44621
aVBeware that using the file is actually the superior solution
p44622
aVCImage creates a memory-mapped file to demand-load the pixels from the image
p44623
aVWhen you load from memory you need double the memory and you'll put pressure on the paging file
p44624
aVAnd you'll run into trouble if the image is large
p44625
as(dp44626
g9
V17034
p44627
stp44628
a((dp44629
g2
(lp44630
VNobody uses code like this, it has serious numerical stability issues
p44631
aVUsing LU-decomp is a good approach, many libraries available for it
p44632
aVNumerical Recipes, if you have to
p44633
as(dp44634
g9
V17034
p44635
stp44636
a((dp44637
g2
(lp44638
VUsing the undname
p44639
aVexe utility, that symbol demangles to
p44640
aVWhich makes the proper declaration:
p44641
as(dp44642
g9
V17034
p44643
stp44644
a((dp44645
g2
(lp44646
VThe debug DLLs are provided in the vc\u005cDebug_NonRedist subdirectory
p44647
aVProperly deploying them is explained in this MSDN Library article
p44648
as(dp44649
g9
V17034
p44650
stp44651
a((dp44652
g2
(lp44653
VDoesn't make sense, a program that was targeted for CLR version 2
p44654
ag2512
aV50727 won't automatically run with
p44655
aVNET 4
p44656
ag2512
aVAn explicit
p44657
aVconfig file entry is required
p44658
aVGiven your client's prowess with
p44659
aVconfig files, this might be something that she in fact did, then found out there was trouble
p44660
as(dp44661
g9
V17034
p44662
stp44663
a((dp44664
g2
(lp44665
VYou are exposing yourself to the implementation details of the JIT-compiler
p44666
aVThe exact time it will throw the exception for the missing assembly depends on how eagerly it translates the IL into machine code
p44667
aVI know the Microsoft jitter is truly just-in-time, it compiles one method at a time, just before it is about to execute
p44668
aVAlthough this is affected by whether or not a debugger is attached
p44669
aVYou're dead in the water if Mono, say, compiles the entire class
p44670
aVThe jitter will throw before Main() can start
p44671
aVMaybe it will work better if you put Main2() in another class
p44672
aVThe best thing to do is just have an assembly available, a dummy if necessary
p44673
as(dp44674
g9
V17034
p44675
stp44676
a((dp44677
g2
(lp44678
VYou need to be careful here
p44679
aVIt is very easy to get completely bogus test results on code like this, results that never repro in real use
p44680
aVThe problem is the file system cache, it will cache the data you read from a file
p44681
aVThe trouble starts when you run your test over and over again, tweaking the code and looking for improvements
p44682
aVThe second, and subsequent times you run the test, the data no longer comes off the disk
p44683
aVIt is still present in the cache, it only takes a memory-to-memory copy to get it into your program
p44684
aVThat's very fast, a microsecond or so of overhead plus the time needed to copy
p44685
aVWhich runs at bus-speeds, at least 5 gigabytes per second on modern machines
p44686
aVYour test will now reveal that you spend a lot of time on allocating the buffer and processing the data, relative from the amount of time spent reading the data
p44687
aVThis will rarely repro in real use
p44688
aVThe data won't be in the cache yet, now the sluggy disk drive needs to seek the data (many milliseconds) and it needs to be read off the disk platter (a couple of dozen megabytes per second, at best)
p44689
aVReading the data now takes a good three of four magnitudes of time longer
p44690
aVIf you managed to make the processing step twice as fast, your program will actually only run 0
p44691
aV05% faster
p44692
aVGive or take
p44693
as(dp44694
g9
V17034
p44695
stp44696
a((dp44697
g2
(lp44698
VThis looks like a race in the CLR's implementation of the timer
p44699
aVI need to wave my hands at the exact cause, I don't really understand how it can go wrong
p44700
aVAt least from looking at the SSCLI20 source code (clr\u005csrc\u005cvm\u005cwin32threadpool
p44701
aVcpp), there's a good chance that this is no longer accurate with the currently shipping code
p44702
aVI can repro the problem easily by setting a breakpoint at the Change() call but not when I let the code run without a break
p44703
aVIt behaves like it calculates the due time from the last observed value returned by GetTickCount() instead of the current value
p44704
aVAdding 0xfffffffe to that stale value then calculates a time that already expired
p44705
aVThe tick count only has 32-bits of resolution
p44706
aVI think the real race is in the calculation of how long to SleepEx() to wait for the next time due event, but that's a guess
p44707
aVIt is possible that this race can occur also if you don't use the debugger to pause the timer thread
p44708
aVAlthough it would probably be rare
p44709
aVI'd have to recommend you stay away from any value close to 0xfffffffe to be sure this won't happen
p44710
aVNo hardship there, sleeping for 24 days is not less efficient than sleeping for 49 days :)  Implement longer intervals by counting sleep periods yourself
p44711
as(dp44712
g9
V17034
p44713
stp44714
a((dp44715
g2
(lp44716
VYou could try testing the mouse state with code like this:
p44717
aVI cannot test it on my machine with Win7, right-clicking the balloon just dismisses it and displays the context menu of the taskbar
p44718
aVWhich is your ultimate nemesis I'd say
p44719
as(dp44720
g9
V17034
p44721
stp44722
a((dp44723
g2
(lp44724
VSource code templates are located in subdirectories of VC\u005cVCWizards\u005cAppWiz\u005cMFC
p44725
aVLook in Application\u005ctemplates\u005cxxxx*
p44726
aVcpp for example; xxxx is your locale ID (1033 = USA)
p44727
as(dp44728
g9
V17034
p44729
stp44730
a((dp44731
g2
(lp44732
VChange the e
p44733
aVEffect assignment to DragDropEffects
p44734
aVCopy
p44735
aVDouble-check that the event assignment is still there, click the lightning bolt icon in the Properties window
p44736
aVSample code is available in this thread
p44737
aVNote that you can cast to string[] directly
p44738
as(dp44739
g9
V17034
p44740
stp44741
a((dp44742
g2
(lp44743
VThe GraphicsPath class is made to do this
p44744
aVKeep a list of them along with the image
p44745
aVDraw the image first, then Graphics
p44746
aVDrawPath() to draw the regions on top of the image
p44747
aVHit testing is simple with GraphicsPath
p44748
aVIsVisible()
p44749
aVIterate the list in reverse order so overlaps work
p44750
as(dp44751
g9
V17034
p44752
stp44753
a((dp44754
g2
(lp44755
VSome sample code to try out:
p44756
aVSet a breakpoint on the indicated line
p44757
aVWhen it breaks, use Debug + Windows + Memory + Memory 1
p44758
aVRight click the window and choose "4-byte Integer"
p44759
aVIn the Address box, type &locker
p44760
aV;  The 2nd word is the thread ID of the thread that owns the lock
p44761
aVStep past the lock statement to see it change
p44762
aVBeware that the number is the managed thread ID, not the operating system thread ID that you see in the Debug + Windows + Threads window
p44763
aVThat kinda sucks, you probably should add some logging to your program that dumps the value of ManagedThreadId so you have a way to match the value to a thread
p44764
as(dp44765
g9
V17034
p44766
stp44767
a((dp44768
g2
(lp44769
VThere isn't much to it, you'll only be interested in the exception code and address
p44770
aVIf the exception is an EXCEPTION_ACCESS_VIOLATION then you also want to dump the first two ExceptionInformation values
p44771
aVThe first one indicates the operation (0=read, 1=write, 8=data execution prevention), the second one gives the fault address
p44772
as(dp44773
g9
V17034
p44774
stp44775
a((dp44776
g2
(lp44777
VThere isn't much point in trying to read from the array when it is empty
p44778
aVJust check for that:
p44779
as(dp44780
g9
V17034
p44781
stp44782
a((dp44783
g2
(lp44784
VRepeatedly opening and closing the port is not recommended
p44785
aVCheck the Remarks section in the MSDN Library article for SerialPort
p44786
aVClose()
p44787
aVThere's a background thread that needs to shut down before a port can be opened again, that takes time
p44788
aVThe amount of time is not predictable
p44789
aVThe Close() method can easily deadlock if the DataReceived event handler is currently running
p44790
aVThe most typical way to get the deadlock is calling Control
p44791
aVInvoke() in the event handler
p44792
aVMake sure you don't use any code in the event handler that blocks or requires a thread context switch
p44793
aVUsing BeginInvoke() is fine
p44794
aVNot being able to kill the program is caused by a problem in the serial port device driver
p44795
aVStart Taskmgr
p44796
aVexe, Process tab, View + Select Columns and tick "Handles"
p44797
aVIf after killing the program, you see the Handles column showing 1 then the serial port driver is hanging on to an I/O request that it doesn't complete
p44798
aVThe process cannot terminate until all its kernel mode threads are exited
p44799
aVThere's little you can do about that particular problem, other than hoping for a driver update or switching to another vendor
p44800
aVEspecially USB serial port emulators are notorious for having lousy device drivers
p44801
aVYou get rid of a troublemaker like that by taking it out the parking lot and running it over with your car several times
p44802
aVAnother typical problem with USB emulators is that they are so easy to disconnect while they are in use
p44803
aVThat works about as well as jerking a flash drive out of the socket while Windows is writing to it
p44804
aVIt would also be a good way to get the device driver hung
p44805
aVNET versions prior to version 4
p44806
aV0 suffer from a heart attack in a background thread when the device suddenly disappears
p44807
aVShort from upgrading, a small sign next to the connector that says "Do not disconnect while in use
p44808
aVis a practical workaround
p44809
aVThey will anyway but get bored with it after a couple of times
p44810
as(dp44811
g9
V17034
p44812
stp44813
a((dp44814
g2
(lp44815
VUse the documentation first so you know what the property means
p44816
aVExperiment with the WMI Code Creator tool
p44817
as(dp44818
g9
V17034
p44819
stp44820
a((dp44821
g2
(lp44822
VPut it back with Tools + Customize
p44823
aVSelect Edit, then click and drag "Find in Files" to the menu
p44824
aVTools + Import and Export, Reset is the sledgehammer solution
p44825
as(dp44826
g9
V17034
p44827
stp44828
a((dp44829
g2
(lp44830
VI don't like this solution much
p44831
aVIt does however work:
p44832
as(dp44833
g9
V17034
p44834
stp44835
a((dp44836
g2
(lp44837
VIt has to be slow, there's no other way
p44838
aVThe CPU core is either running at full bore or it is turned off by a HALT instruction
p44839
aVFrom which it is woken up again by an interrupt
p44840
aVThe effective CPU load is an average calculated over a period, typically one second
p44841
aVThe amount of time it was running divided by the period
p44842
aVIf you make the period shorter then the calculated value gets less accurate
p44843
aVMake it too short and the number will just jump between 0 and 100
p44844
aVYou cannot change the sample rate in the WMI query afaik
p44845
aVYou can get quicker (and noisier) updates by reading the performance counter directly
p44846
aVYou'll find sample code in my answer in this thread
p44847
as(dp44848
g9
V17034
p44849
stp44850
a((dp44851
g2
(lp44852
VForce your
p44853
aVexe to run in 32-bit mode
p44854
aVProject + Properties, Build tab, Platform Target = x86
p44855
aVAvoid getting confused by the project's Platform setting, it doesn't actually have to match the real setting
p44856
aVWhich is Project + Properties, Build tab, Platform Target
p44857
aVBit of a mess there
p44858
as(dp44859
g9
V17034
p44860
stp44861
a((dp44862
g2
(lp44863
VTo prevent the window from being shown, paste this code into your form:
p44864
aVBeware that the Load event won't run until you explicitly make your form visible so move any code you've got there inside the if statement
p44865
aVNot getting the DocumentCompleted event to run is usually caused by not running a message loop (Application
p44866
aVRun)
p44867
aVWebBrowser requires one, and a thread that's marked with [STAThread], in order to fire its events
p44868
aVThe message loop is very important for COM components
p44869
aVIs it also important to prevent the invisible form from stealing focus, with the code below:
p44870
aVand
p44871
as(dp44872
g9
V17034
p44873
stp44874
a((dp44875
g2
(lp44876
VProper UI design requires disabling the menu item when it isn't functional
p44877
aVA side-effect is that it will no longer steal the keystroke, just what you want
p44878
aVThe Application
p44879
aVIdle event is handy for that
p44880
as(dp44881
g9
V17034
p44882
stp44883
a((dp44884
g2
(lp44885
VNice demonstration of what goes wrong when you use members of a control or form on a background thread
p44886
aVWinforms usually catches this but there's a bug in the Invalidate() method code
p44887
aVChange it like this:
p44888
aVto trip the exception
p44889
aVThe other panel is slower because lots of its Invalidate() calls are getting canceled by the paint event
p44890
aVWhich is just slow enough to do so
p44891
aVClassic threading race
p44892
aVYou cannot call Invalidate() from a worker thread, the synchronous timer is an obvious solution
p44893
as(dp44894
g9
V17034
p44895
stp44896
a((dp44897
g2
(lp44898
VAbsolutely
p44899
aVIt never gets released automatically, it is unmanaged memory
p44900
as(dp44901
g9
V17034
p44902
stp44903
a((dp44904
g2
(lp44905
VIt doesn't matter, a free function in a namespace achieves the same
p44906
aVThe syntax for calling it is identical
p44907
as(dp44908
g9
V17034
p44909
stp44910
a((dp44911
g2
(lp44912
VI answered this in your previous question, controls like WebBrowser need a message loop
p44913
aVThere is no message loop in a console app
p44914
as(dp44915
g9
V17034
p44916
stp44917
a((dp44918
g2
(lp44919
VThere are two versions of Regasm
p44920
aVexe on an x64 machine
p44921
aVSounds like you used the 32-bit version, it only adds registry keys to the 32-bit view of the registry (HKLM\u005cSoftware\u005cWow6432Node)
p44922
aVTo make it work for code that runs in 64-bit mode you'll have to also register it for 64-bit code
p44923
aVAnd of course your
p44924
aVNET component must not have any dependencies on 32-bit unmanaged code
p44925
aVThe 64-bit version is located in c:\u005cwindows\u005cmicrosoft
p44926
aVnet\u005cframework64
p44927
aVOr use the 32-bit version of the vbscript engine
p44928
as(dp44929
g9
V17034
p44930
stp44931
a((dp44932
g2
(lp44933
VHmm, x64 code, no assembly hacks at your disposal unless you use ml64
p44934
aVexe
p44935
aVThere's one intrinsic that ought to help here, _ReturnAddress() gives you the code location of the call to your __penter() function
p44936
aVThe instruction after it btw
p44937
aVThat should be enough to help you identify the caller
p44938
as(dp44939
g9
V17034
p44940
stp44941
a((dp44942
g2
(lp44943
VYour compiler will already align the members of objects and structures that will be stored in the pool
p44944
aVUsing the default packing that's appropriate for your architecture, usually 8 for a 32-bit core
p44945
aVYou just need to make sure that the address you generate from your pool is aligned accordingly
p44946
aVWhich on a 32-bit operating system ought to be a multiple of 8 bytes
p44947
aVMis-aligning the objects can be very expensive when they cross a CPU cache line boundary
p44948
aVA double that straddles two cache lines takes as much as three times as long to be read or written
p44949
as(dp44950
g9
V17034
p44951
stp44952
a((dp44953
g2
(lp44954
VWell, a file is often treated as a stream as well
p44955
aVThat's why the primary class to open files is called FileStream
p44956
aVBut there's a specific operating system feature that can make dealing with image files a lot more efficient
p44957
aVIt is called 'memory mapped files', a feature that maps the content of a file directly to memory
p44958
aVThere's some smoke and mirrors involved, but it essentially makes the file directly available without having to read it
p44959
aVThe memory you need to store the file data doesn't take space in the paging file
p44960
aVVery efficient, you'll get it for free when you use FromFile() or the Bitmap(string) constructor for an image in the
p44961
aVbmp format
p44962
aVLoading an image from a stream tends to require twice the amount of memory, always a problem with big images
p44963
as(dp44964
g9
V17034
p44965
stp44966
a((dp44967
g2
(lp44968
VSet the column Size Type to Percent instead of Absolute
p44969
aVSelect the panel, click the little arrow glyph in the upper right corner, Edit Rows and Columns
p44970
as(dp44971
g9
V17034
p44972
stp44973
a((dp44974
g2
(lp44975
VTimeSpan has no formatting options at all before
p44976
aVNET 4
p44977
aV0, you'd have to convert it to DateTime through the Ticks property
p44978
aVNothing remotely close in DateTime
p44979
aVString(format) formatting options though, you'll have to write it yourself
p44980
aVIn
p44981
aVNET 4
p44982
aV0, TimeSpan acquired a ToString(format) override
p44983
aVCustom formatting strings are described here
p44984
aVYour 3rd requirement is going to need code
p44985
as(dp44986
g9
V17034
p44987
stp44988
a((dp44989
g2
(lp44990
VYour English is hard to decode but it sure sounds like you are on the wrong track with this
p44991
aVThe GAC is a deployment detail
p44992
aVYou'll have no trouble putting an assembly in the GAC with your Setup project
p44993
aVThat assembly does not belong in the GAC on your dev machine
p44994
aVTo add the reference, simply use the Add Reference dialog and use either the Project or Browse tab
p44995
aVIf your assembly is intended to be used by another programmer so that she can use your product in her own project then you need to deploy your assembly twice
p44996
aVIt needs to go into the GAC and a copy of the assembly needs to go in a dedicated folder so your client can add the reference to it in her own project
p44997
aVThe c:\u005cprogram files\u005creference asssemblies directory is a good place to put it
p44998
aVPutting it in the GAC for her is optional btw, it isn't that commonly done
p44999
aVI think most programmers would prefer that you don't do this, unless you work for a Big Company that needs to automatically distribute security updates
p45000
aVPutting it in the GAC just makes it harder for your client to write her own Setup project since she has to run yours first
p45001
as(dp45002
g9
V17034
p45003
stp45004
a((dp45005
g2
(lp45006
VYes, this is built-in behavior for Control
p45007
aVInvoke()
p45008
aVIt only marshals the deepest nested InnerException back to the caller
p45009
aVNot so sure why they did this, beyond avoiding reporting exceptions that were raised by the marshaling code and would confuzzle the reader
p45010
aVIt was done explicitly, you cannot change the way it works
p45011
aVBut keep your eyes on the ball, the real problem is that the string indeed cannot be found in the dictionary
p45012
aVThe reason for that is that your background thread runs with a different culture from your UI thread
p45013
aVDifferent cultures have different string comparison rules
p45014
aVYou either need to give your dictionary a different comparator (StringComparer
p45015
aVInvariantCulture) or you should switch your background thread to the same culture as your UI thread
p45016
aVDealing with a non-system default culture in your UI thread can be difficult, all other threads will be started with the system default
p45017
aVEspecially threadpool threads are troublesome, you don't always control how they get started
p45018
aVAnd culture is not part of the Thread
p45019
aVExecutionContext so doesn't get forwarded
p45020
aVThis can cause subtle bugs, like the one you ran into
p45021
aVOther nastiness is, say, SortedList which suddenly becomes unsorted when read by a thread that uses a different culture
p45022
aVUsing the system default culture is strongly recommended
p45023
aVIts what your user is likely to use anyway
p45024
as(dp45025
g9
V17034
p45026
stp45027
a((dp45028
g2
(lp45029
VCOM+ was Microsoft's offering in the battle for the middle tier that raged in the late nineties
p45030
aVA set of extensions built on top of COM with typical middleware duties like componentizing modules across machines and getting them to work together in a transaction-safe way
p45031
aVCORBA was another one, now also largely forgotten
p45032
aVThe only thing it really accomplished was to make Java a significant force
p45033
as(dp45034
g9
V17034
p45035
stp45036
a((dp45037
g2
(lp45038
VYou used to compile your code with a very old version of the Windows SDK
p45039
aVVC6 is even older than Windows XP, the operating system that added the SendInput() API function
p45040
aVYou could work around your problem with
p45041
aVBut you then cannot use any APIs that were added after Windows 2000
p45042
aVProbably not a real problem considering how old your code is
p45043
aVMove ahead by just renaming INPUT or by putting your class in its own namespace
p45044
as(dp45045
g9
V17034
p45046
stp45047
a((dp45048
g2
(lp45049
VThat sounds a lot like DPI Virtualization at work
p45050
aVIt normally kicks in beyond 120 DPI but you probably got it from turning off XP scaling
p45051
aVUnless a program has the DPIAware element in its manifest, Vista/Win7 will get the program to render its output into a memory buffer and draw that buffer rescaled to match the selected DPI
p45052
aVThe rescaling makes the font edges look fuzzy since the anti-aliasing pixels no longer fit the LCD pixel grid
p45053
aVMost programs require this because they are simply DPI un-aware, programmed to count on the video adapter set to 96 DPI
p45054
aVYou'll get trouble like text that no longer fits the control, images that are too small and unsizable windows the size of a postage stamp
p45055
aVVista is the first version of Windows that tries to do something about this age-old problem, hopefully opening the door to high-resolution LCD panels
p45056
aVGetting to 300 DPI isn't going to happen otherwise, it is high time
p45057
aVEspecially for WPF
p45058
aVAsk more questions about this at superuser
p45059
aVcom
p45060
as(dp45061
g9
V17034
p45062
stp45063
a((dp45064
g2
(lp45065
VNot sure what you're trying to prove with this code
p45066
aVJust write an exception handler for AppDomain
p45067
aVCurrent
p45068
aVUnhandledException and log or display the value of e
p45069
aVExceptionObject
p45070
aVToString()
p45071
aVIf you are contemplating actually handling the exception then you've got an entirely different kettle of fish to fry
p45072
aVYou've got a bit of code that runs and dies at a random spot
p45073
aVYou don't really know how far it got along and how much of your program state got altered by that thread
p45074
aVHandling an exception requires restoring the program state, undoing whatever the thread did
p45075
aVWhatever event handler you write to process the "it bombed" event cannot possibly guess what needs to be done to restore state, it doesn't know nearly enough about the thread
p45076
aVIt only knows that it didn't work
p45077
aVRestoring state needs to be done by the thread itself
p45078
aVHandling the "it bombed" event is difficult in itself
p45079
aVThe client code cannot even display a message box, it will easily disappear behind your main window
p45080
aVUpdating the UI directly is not permitted
p45081
aVThe call needs to be marshaled to the UI thread
p45082
aVThe best way is to leave it up to the client code to decide how it want to be notified
p45083
aVThe FileSystemWatcher
p45084
aVSynchronizingObject property is a good pattern
p45085
as(dp45086
g9
V17034
p45087
stp45088
a((dp45089
g2
(lp45090
VUse the Image
p45091
aVPropertyItems property on the source image to get the list of metadata items
p45092
aVLoop through the list, calling Image
p45093
aVSetPropertyItem on the destination image
p45094
aVYou should normally avoid resizing and re-compressing a jpeg image, working from an uncompressed original is best to maintain quality and avoid artifacts
p45095
as(dp45096
g9
V17034
p45097
stp45098
a((dp45099
g2
(lp45100
VThe only difference in a interface method call is that it is guaranteed to be a virtual method call
p45101
aVIt would be optional on a direct class instance method call, depending on whether you declared it virtual or not
p45102
aVIn practice it makes no difference, the VB
p45103
aVNET compiler uses the same trick as the C# compiler
p45104
aVIt makes an indirect call even if the method isn't virtual, useful for its implicit null reference check
p45105
aVOnly a static method call could be cheaper
p45106
aVThere's no point in worrying about this
p45107
as(dp45108
g9
V17034
p45109
stp45110
a((dp45111
g2
(lp45112
VYou can't create a TV tuner in software
p45113
aVCPUs are still many orders of magnitude too slow to decode the TV signal from the carrier frequency
p45114
aVHardware is required, Hauppauge is in the business of TV tuner cards
p45115
as(dp45116
g9
V17034
p45117
stp45118
a((dp45119
g2
(lp45120
VThere's no point in using Control
p45121
aVInvokeRequired, you know that it always is
p45122
aVThe Elapsed event is raised on a threadpool thread, never the UI thread
p45123
aVWhich makes it kinda pointless to use a System
p45124
aVTimers
p45125
aVTimer, just use the System
p45126
aVWindows
p45127
aVForms
p45128
aVTimer
p45129
aVNo need to monkey with Control
p45130
aVBegin/Invoke, you can't crash your program with an ObjectDisposedException when the event is raised just as the user closes the form
p45131
as(dp45132
g9
V17034
p45133
stp45134
a((dp45135
g2
(lp45136
VLooks to me like they fumbled the schema
p45137
aVSave the
p45138
aVwsdl to a file and open it in a text editor
p45139
aVAdd two lines to the header so it looks like this:
p45140
aVThe two added lines are indented, note that the angle bracket was moved
p45141
aVThen just load the service reference from the file
p45142
as(dp45143
g9
V17034
p45144
stp45145
a((dp45146
g2
(lp45147
VLook at the assembly manifest with Ildasm
p45148
aVexe:
p45149
aVThat's the Release version
p45150
aVThe debug build values are ( 01 00 07 01 00 00 00 00 )
p45151
aVYet another wrinkle is that the debugger can disable the JIT optimizer
p45152
aVThat's a configurable option in VS, Tools + Options, Debugging, General, "Suppress JIT optimization on module load"
p45153
aVYou want that off if you're debugging the Release build and want comparable perf
p45154
aVIt makes debugging more challenging, stepping acts weird as the optimizer rearranges and inlines code and you often cannot inspect the values of local variables because they are stored in CPU registers
p45155
as(dp45156
g9
V17034
p45157
stp45158
a((dp45159
g2
(lp45160
VThat's not possible, you don't have the Me variable to know the type of the class
p45161
aVTo avoid creating the illusion that it might be possible, you should write it like this:
p45162
as(dp45163
g9
V17034
p45164
stp45165
a((dp45166
g2
(lp45167
VYou'll need a Timer
p45168
as(dp45169
g9
V17034
p45170
stp45171
a((dp45172
g2
(lp45173
VIt makes no difference whatsoever, it's the exact same P/Invoke marshaller that gets the job done
p45174
aVThe Declare statement assumes different defaults, like CharSet, so watch out if you intend to swap them
p45175
aVThe most typical cause of random DLL search issues is getting Environment
p45176
aVCurrentDirectory changed
p45177
aVLike when you use OpenFileDialog
p45178
aVKeep the DLL (and its dependencies) in the same directory as your EXE to avoid this
p45179
as(dp45180
g9
V17034
p45181
stp45182
a((dp45183
g2
(lp45184
VIt does the same thing as running Regasm
p45185
aVexe with the /tlb and /codebase options
p45186
aVThe /codebase option is probably the one you forgot
p45187
aVRegasm likes assuming you put the DLL in the GAC
p45188
aVWhich is indeed a good way to avoid DLL Hell, always a COM problem
p45189
aVBut not very appropriate on your dev machine, you don't want to pollute the GAC whlie developing and testing the code
p45190
aVUsing the wrong version of Regasm
p45191
aVexe on a 64-bit machine is another way to get in trouble, there are usually 4 versions on your machine
p45192
aVBe sure to distinguish the 32-bit and 64-bit versions (c:\u005cwindows\u005cmicrosoft\u005cframework vs framework64), they write different registry keys
p45193
aVYou want to pick the one that's compatible with the client app
p45194
aVUsing both is okay too,
p45195
aVNET code can run in either mode, but pretty unusual
p45196
aVAnd distinguish between the v2
p45197
ag2512
aV50727 (
p45198
aVNET 2
p45199
aV0 through 3
p45200
aV5SP1) and the v4
p45201
aV0 versions
p45202
aVPicking the right Visual Studio Command Prompt is half the battle
p45203
as(dp45204
g9
V17034
p45205
stp45206
a((dp45207
g2
(lp45208
Vto warrant a single thread
p45209
aVWell, you already answered your own question :)  Events like FormClosing and a timer's Tick event all run on a single thread
p45210
aVThere is no way for a timer to "break" into a thread and run the Tick event, your thread is busy doing the cleanup stuff
p45211
aVThe Tick event won't run until your thread goes idle again when it completes running the event handler and re-enters the message loop
p45212
aVBut before that happens, the form will destroy itself, disposing all its controls and components
p45213
aVThat puts an end to any opportunity for a timer's Tick event to run
p45214
aVThere's no need to explicitly Stop() it
p45215
aVThis won't be the case for a System
p45216
aVTimers
p45217
aVTimer or other asynchronous components like BackgroundWorker
p45218
aVIt is very important that you stop these before your form closes
p45219
aVIf you don't then your code will typically bomb on an ObjectDisposedException
p45220
aVEspecially System
p45221
aVTimers
p45222
aVTimer is very hard to stop, it can schedule the thread that calls the Elapsed event handler a microsecond before the user closes the form
p45223
aVBig Kaboom when that happens
p45224
aVDon't use it
p45225
as(dp45226
g9
V17034
p45227
stp45228
a((dp45229
g2
(lp45230
VThe Prepare() method was designed to make the query run more efficiently
p45231
aVIt is entirely up to the provider to implement this
p45232
aVA typical one creates a temporary stored procedure, giving the server an opportunity to pre-parse and optimize the query
p45233
aVThere's a couple of ways code like this could leak memory
p45234
aVOne is a typical
p45235
aVNET detail, a practical implementation of an IDbCommand class always has a Dispose() method to release resources explicitly before the finalizer thread does it
p45236
aVI don't see it being used in your snippet
p45237
aVBut pretty unlikely in this case, it is very hard to consume all memory without ever running the garbage collector
p45238
aVYou can tell from Perfmon
p45239
aVexe and observe the performance counters for the garbage collector
p45240
aVThe next candidate is more insidious, you are using a big chunk of native code
p45241
aVDbase providers are not that simple
p45242
aVThe FOSS kind tends to be designed to allow you to get the bugs out of them
p45243
aVSource code is available for a reason
p45244
aVPerfmon
p45245
aVexe again to diagnose that, seeing the managed heaps not growing beyond bounds but private bytes exploding is a dead giveaway
p45246
aVIf you don't feel much like debugging the provider you could just comment the statement
p45247
as(dp45248
g9
V17034
p45249
stp45250
a((dp45251
g2
(lp45252
VWell, it did consider the DLL version
p45253
aVA type library can only have a major and a minor version number
p45254
aVYou'll need to bump your DLL version to, say, 4
p45255
ag2582
ag22731
ag22731
aVThis is otherwise appropriate behavior
p45256
aVOne hard rule of COM is that you must change the GUIDs if you make a change to a publicly visible interface
p45257
aVNot doing so causes the worst kind of DLL Hell, the kind that crashes the client app without any good way to diagnose the reason
p45258
aVThat's no longer a revision change, that's a non-so-minor version change
p45259
aVThe clients of the COM server have to be rebuilt
p45260
aVIf you didn't actually change a public interface then having a type library version of 4
p45261
aV0 is still quite appropriate
p45262
aVIt didn't change
p45263
as(dp45264
g9
V17034
p45265
stp45266
a((dp45267
g2
(lp45268
VEncapsulate the info in classes
p45269
aVWorks well in any language, works well in COM too
p45270
as(dp45271
g9
V17034
p45272
stp45273
a((dp45274
g2
(lp45275
VI'll just cough up the MSDN Library article titled "How to: Migrate to /clr:safe
p45276
aVVisual C++ can generate verifiable components with using /clr:safe, which causes the compiler to generate errors for each non-verifiable code construct
p45277
aVThe following issues generate verifiability errors:
p45278
aVNative types
p45279
aVEven if it isn't used, the declaration of native classes, structures, pointers, or arrays will prevent compilation
p45280
aVGlobal variables
p45281
aVFunction calls into any unmanaged library, including common language runtime function calls
p45282
aVA verifiable function cannot contain a static_cast Operator for down-casting
p45283
aVThe static_cast operator can be used for casting between primitive types, but for down-casting, safe_cast or a C-Style cast (which is implemented as a safe_cast) must be used
p45284
aVA verifiable function cannot contain a reinterpret_cast operator (or any C-style cast equivalent)
p45285
aVA verifiable function cannot perform arithmetic on an interior_ptr
p45286
aVIt may only assign to it and dereference it
p45287
aVA verifiable function can only throw or catch pointers to reference types, so value types must be boxed before throwing
p45288
aVA verifiable function can only call verifiable functions (such that calls to the common language runtime are not allowed, include AtEntry/AtExit, and so global constructors are disallowed)
p45289
aVA verifiable class cannot use Explicit
p45290
aVIf building an EXE, a main function cannot declare any parameters, so GetCommandLineArgs must be used to retrieve command-line arguments
p45291
aVMaking a non-virtual call to a virtual function
p45292
aVAlso, the following keywords cannot be used in verifiable code:
p45293
aVunmanaged and pack pragmas
p45294
aVnaked and align __declspec modifiers
p45295
aV__asm
p45296
aV__based
p45297
aV__try and __except
p45298
aVI reckon that will keep you busy for a while
p45299
aVThere is no magic wand to wave to turn native C++ into verifiable code
p45300
aVAre you sure this is worth the investment
p45301
as(dp45302
g9
V17034
p45303
stp45304
a((dp45305
g2
(lp45306
VReturning a reference is a C++ term
p45307
aVAn example that demonstrates the syntax:
p45308
aVC# doesn't have this capability, it is quite incompatible with the notion of a garbage collector
p45309
aVC++ implements this under the hood by actually returning a pointer
p45310
aVThis falls flat when the garbage collector moves the underlying internal array, the pointer becomes invalid
p45311
aVIt is not much of a problem because variables of an object are already true references in managed code, much like the C++ notion of a reference
p45312
aVBut not value types, they are copied
p45313
aVYou'd use an indexer in this specific example:
p45314
as(dp45315
g9
V17034
p45316
stp45317
a((dp45318
g2
(lp45319
VYou need to forget about using a thread, that's only going to deliver D+D notifications to the windows that were created on that thread
p45320
aVWhich will not be your controls
p45321
aVI can't do much with a "code is sucks" diagnostic
p45322
aVThe DoDragDrop() call itself will indeed block until the mouse button is released
p45323
aVAnother message loop, internal to COM code will take over and deliver the Windows messages
p45324
aVTimer and paint messages should be delivered as normal
p45325
aVA diagnostic is very hard to come by until you post some repro code
p45326
as(dp45327
g9
V17034
p45328
stp45329
a((dp45330
g2
(lp45331
VYes, the message box responds to the key down event
p45332
aVSo should your TextBox
p45333
aVUse the KeyDown event instead, problem solved
p45334
aVAlso solves the annoying BEEP the user normally hears
p45335
as(dp45336
g9
V17034
p45337
stp45338
a((dp45339
g2
(lp45340
VGetCursorPos() returns the mouse position
p45341
aVScreenToClient() is usually next
p45342
aVThat works for polling the mouse
p45343
aVA more typical approach in a game loop is calling PeekMessage() inside the loop so you can see the WM_MOUSEMOVE message
p45344
aVMore efficient because you don't burn any time worrying about the mouse when the user isn't moving it
p45345
aVOr using some class library to implement the game, mouse handling is always part of it
p45346
as(dp45347
g9
V17034
p45348
stp45349
a((dp45350
g2
(lp45351
VYou cannot do this by letting the process you start creating a named object
p45352
aVThat's an inherent race condition, it takes time for the process to get started
p45353
aVBoth programs need to call CreateMutex at some point before trying to create the 3rd process with an agreed-upon name
p45354
aVThen they need to call WaitForSingleObject() with a zero wait time to try to acquire the mutex
p45355
aVWhomever gets it is the one that should call CreateProcess()
p45356
aVMore work is needed after this to deal with this 3rd process terminating
p45357
as(dp45358
g9
V17034
p45359
stp45360
a((dp45361
g2
(lp45362
VYes, Explorer uses the exact same API as FileSystemWatcher uses
p45363
aVThere's just one, ReadDirectoryChangesW() as you found out
p45364
aVWhat you found strongly suggest that Win7 is optimizing the disk write that would be needed to update the directory entry for the file
p45365
aVDelaying it until the last possible moment, when the file is closed
p45366
aVThere's an interesting correlation between this observation and a critical bug that a user discovered in the RTM version of Win7
p45367
aVThe update sometimes doesn't happen at all
p45368
aVThe bug strikes randomly but infrequently, I've seen this myself just once on my machine
p45369
aVKnowingly anyway
p45370
aVThe details are in this thread (beware of very slow server)
p45371
aVThis still fails today with all Win7 updates applied
p45372
aVWell, interesting tidbit but not really germane to your question
p45373
aVYou do need to alter your code to accommodate the OS works
p45374
as(dp45375
g9
V17034
p45376
stp45377
a((dp45378
g2
(lp45379
VIt is explicitly mentioned in the documentation for _matherr:
p45380
aVFor special error handling, you can
p45381
aVprovide a different definition of
p45382
aV_matherr
p45383
aVIf you use the dynamically linked version of the C run-time
p45384
aVlibrary (Msvcr90
p45385
aVdll), you can replace
p45386
aVthe default _matherr routine in a
p45387
aVclient executable with a user-defined
p45388
aVversion
p45389
aVHowever, you cannot
p45390
aVreplace the default _matherr routine
p45391
aVin a DLL client of Msvcr90
p45392
aVdll
p45393
aVYou'll need to put the override in the EXE module
p45394
aVAlter your unit test to accommodate this
p45395
as(dp45396
g9
V17034
p45397
stp45398
a((dp45399
g2
(lp45400
VI'll just address the UI angle
p45401
aVYou can hide it by setting the column width to 0
p45402
aVFor example, if the ID is bound to the 2nd column:
p45403
aVIt's not quite ideal, the user can get confuzzled by the 'splitter' cursor that shows up when she's a bit too far to the right of the column divider
p45404
aVThat's very hard to fix
p45405
as(dp45406
g9
V17034
p45407
stp45408
a((dp45409
g2
(lp45410
VYou cannot realistically implement a replacement for BinaryFormatter
p45411
aVThe exact format of the binary data it generates isn't documented
p45412
aVAnd the structure is complicated, it adds metadata to the actual object data that allows the reader to reconstruct the type of the object
p45413
aVIt also isn't an exact one-to-one match with the collection layout, it flattens the object graph to some extent to avoid generating too much metadata
p45414
aVThe amount of code in BinaryFormatter is quite stupendous
p45415
aVTackle this at the source and think of another representation of the data that doesn't consume so much memory
p45416
as(dp45417
g9
V17034
p45418
stp45419
a((dp45420
g2
(lp45421
VI may be a somewhat useful abstraction to have a mental image of what's going on behind the scenes
p45422
aVBut neither is true in any currently shipping version of the JIT compilers
p45423
aVWhich perhaps is the crux of the issue, actual allocation location is a JIT compiler implementation detail
p45424
aVThere are at least four places where a value type value can live with mainstream (x86 and x64) jitters:
p45425
aVin a stack frame, put there by a local variable declaration or a method call
p45426
aVin a CPU register, a very common optimization performed by the JIT in the Release build
p45427
aVAnd used to pass arguments in the __clrcall method calling convention
p45428
aVon the GC heap, when the value is part of a reference type
p45429
aVon the loader heap of the AppDomain, when the variable is declared static
p45430
aVReference type objects are commonly allocated on the GC heap
p45431
aVBut I know of one specific exception, interned strings produced from literals in the source code are allocated in the AppDomain's loader heap
p45432
aVThis completely behaves like an object at runtime, except that it isn't linked in to the GC heap, the collector simply cannot see it
p45433
aVAddressing your code snippet:
p45434
aVyes, "a" is likely to be stored on the GG heap
p45435
aVx" is always passed in a CPU register on x86 and x64
p45436
aV"y" will be in a CPU register on x64, the stack on x86
p45437
aVc" is likely to not exist at all, removed by the JIT compiler because the code has no effect
p45438
as(dp45439
g9
V17034
p45440
stp45441
a((dp45442
g2
(lp45443
VReshaper which will incrementally perform background compilation as you write
p45444
aVIt doesn't, it just parses the source code
p45445
aVThe exact same thing Visual Studio already does if you don't have Resharper, that's how it implements IntelliSense, its own refactoring features and commands like GoTo Definition and Find All References
p45446
aVVisual Studio also parses in the background, updating its data while you type
p45447
aVResharper just implements more bells and whistles with that parsing data
p45448
aVGoing from parsing the code to actually generating the assembly is a pretty major step
p45449
aVThe internal format of an assembly is too convoluted to allow this to happen in the background without affecting the responsiveness of the machine
p45450
aVAnd the C# compiler is still a large chunk of unmanaged C++ code that is independent from the IDE
p45451
aVAn inevitable consequence of having to have the compiler first
p45452
aVIt is however a stated goal for the next version of C# to provide compile-on-demand services
p45453
aVGetting true background compilation is a possibility
p45454
as(dp45455
g9
V17034
p45456
stp45457
a((dp45458
g2
(lp45459
VThere's a ever so slight hint that this might be possible if you run on Vista or higher
p45460
aVFrom the documentation of NOTIFYICONDATA:
p45461
aVWhen uVersion is set to
p45462
aVNOTIFYICON_VERSION_4, the standard
p45463
aVToolTip is replaced by the
p45464
aVapplication-drawn pop-up user
p45465
aVinterface (UI)
p45466
aVBut with any hints whatsoever how to actually make this work
p45467
aVGoogling for +NOTIFYICON_VERSION_4 +ToolTip doesn't produce anything relevant
p45468
aVIt also isn't wrapped by the Windows API Code Pack
p45469
aVI'm guessing that it takes listening for callback notifications
p45470
aVAt any rate, you will have to completely replace the NotifyIcon class to make this work
p45471
aVMaybe your google fu can get you a better hit
p45472
as(dp45473
g9
V17034
p45474
stp45475
a((dp45476
g2
(lp45477
VA sector is meaningless without a file system
p45478
aVSurely both your pen drive and the hard disk have one that your operating system supports
p45479
aVThen there's little point to not use fopen() and friends
p45480
as(dp45481
g9
V17034
p45482
stp45483
a((dp45484
g2
(lp45485
VGDI+ supports indexed formats very poorly
p45486
aVThings got better with Vista which included an update to gdiplus
p45487
aVdll to version 1
p45488
aV10
p45489
aVNothing you should could on I imagine
p45490
aVYou could hack Bitmap
p45491
aVLock(), dealing with the single byte-per-pixel format is doable
p45492
aVBut get these images into a 24 or 32bpp format I'd say
p45493
as(dp45494
g9
V17034
p45495
stp45496
a((dp45497
g2
(lp45498
VOdd things like this can happen when your app is leaking operating system resources
p45499
aVLike handles or kernel memory pool
p45500
aVStuff stops working when it exceeds the process quota, error messages aren't always great
p45501
aVRun Taskmgr
p45502
aVexe, Process tab, View + Select Columns
p45503
aVTick at least Handles and Threads
p45504
as(dp45505
g9
V17034
p45506
stp45507
a((dp45508
g2
(lp45509
VThis is done with satellite assemblies
p45510
aVYou can see what can be localized with Reflector
p45511
aVClick the Resources node for an assembly and select the
p45512
aVresources entry
p45513
aVThere's rather a lot of it, but I only see strings for exception messages and property descriptions visible from the Properties window
p45514
aVCountry names are already localized
p45515
as(dp45516
g9
V17034
p45517
stp45518
a((dp45519
g2
(lp45520
VYou are running on a 64-bit version of Windows
p45521
aVDebugging with sos
p45522
aVdll is not possible when your program is 64-bit as well, Visual Studio is a 32-bit process
p45523
aVFix: Project + Properties, Compile tab, scroll down, Advanced, Target CPU = x86
p45524
as(dp45525
g9
V17034
p45526
stp45527
a((dp45528
g2
(lp45529
VUsing Assembly
p45530
aVLoadFrom() is not a very good idea in this specific case
p45531
aVUse fuslogvw
p45532
aVexe to find out why your program loaded the wrong assembly
p45533
aVGAC, probably
p45534
aVAnyhoo, LoadFile() is called for here
p45535
as(dp45536
g9
V17034
p45537
stp45538
a((dp45539
g2
(lp45540
VAny thread that creates a window must be STA
p45541
aVBoth user32 and gdi are fundamentally thread-unsafe
p45542
as(dp45543
g9
V17034
p45544
stp45545
a((dp45546
g2
(lp45547
VThat's E_FAIL, "Unspecified error"
p45548
aVIt's an utterly useless error code but not uncommon for COM servers
p45549
aVThe programmer took a shortcut, couldn't find a better error code and didn't want to create his own
p45550
aVIt is very doubtful that it has anything to do with the interop library, you never got to the point of actually using it
p45551
aVMaybe some kind of config that the COM server needs, maybe an installation problem
p45552
aVBut these are just wild guesses
p45553
aVUltimately you probably need help from the component vendor or author to get past this hump
p45554
as(dp45555
g9
V17034
p45556
stp45557
a((dp45558
g2
(lp45559
VYes, you can't make this work
p45560
aVIt's a Windows restriction, transparency effects are relative to the top-level window, stacking effects do not work
p45561
aVYou'll see the form as the background, not the menu strip
p45562
aVHacking a label that asks the menustrip to render itself to create the background is technically possible
p45563
aVBut Windows won't generate a paint message when the strip repaints itself
p45564
aVWhich will be starkly visible when the user resizes the form for example
p45565
as(dp45566
g9
V17034
p45567
stp45568
a((dp45569
g2
(lp45570
VThat's what string
p45571
aVNormalize() takes care of
p45572
aVYou can use the Normalize(NormalizationForm) override to control this explicitly
p45573
as(dp45574
g9
V17034
p45575
stp45576
a((dp45577
g2
(lp45578
VThere's an intrinsic available for it, __sidt()
p45579
as(dp45580
g9
V17034
p45581
stp45582
a((dp45583
g2
(lp45584
VIt can't, it is just an object reference
p45585
aVThere could be many references to the same object, they would all point to a dead object if the compiler did this automatically
p45586
aVThat's a guaranteed kaboom
p45587
aVA core property of a garbage collector is that neither the compiler nor you can find out how many references exist to an object
p45588
aVOnly the garbage collector can do that
p45589
aVAnd it already does, it automatically finalizes an object if all references are gone
p45590
aVThe point of IDisposable() is to not wait until that happens
p45591
aVSince the compiler cannot do this, nor can it be automated, it is up to you to make the promise that no other live references to the object exists
p45592
aVIf you can't make that promise then you should not call Dispose() and leave it up to the collector
p45593
aVStandard in COM interop code for example
p45594
aVOther automatic memory management schemes can do this
p45595
aVThey use reference counting, common before garbage collectors became main-stream
p45596
aVExpensive and unreliable because it cannot deal with cycles
p45597
aVMicrosoft funded a research project to add reference counting to the CLR
p45598
aVIt was a big bust
p45599
aVGC got a lot more respect after that
p45600
as(dp45601
g9
V17034
p45602
stp45603
a((dp45604
g2
(lp45605
VA critical bit of information is missing from your question, which of the two keyboard hooks do you use
p45606
aVThe easy one, WH_KEYBOARD_LL cannot work
p45607
aVYou'll end up using the keyboard state of your program, not the program that actually gets the keystroke
p45608
aVDead keys indeed make the difference
p45609
aVThe hard one, WH_KEYBOARD requires a hook that you cannot write in managed code
p45610
aVYou'll need an unmanaged DLL that can be injected in every process
p45611
aVOnce you got that, I'd just not bother with a keyboard hook, might as well log the WM_CHAR messages with WH_CALLWNDPROC
p45612
aVA sample DLL is available here
p45613
as(dp45614
g9
V17034
p45615
stp45616
a((dp45617
g2
(lp45618
VFind the location of your  directive and make it look like this:
p45619
as(dp45620
g9
V17034
p45621
stp45622
a((dp45623
g2
(lp45624
VYou cannot mix 64-bit and 32-bit compiled code
p45625
aVConfig instructions for Linux are here
p45626
as(dp45627
g9
V17034
p45628
stp45629
a((dp45630
g2
(lp45631
VNot quite
p45632
aVThere's no point in adding the Same1 and Same2 methods, you inherit them from ProtocolBase
p45633
aVAnd DiffStuff() should be a virtual method so that you can override it and give it different behavior
p45634
as(dp45635
g9
V17034
p45636
stp45637
a((dp45638
g2
(lp45639
VYou can edit the files that are used by the template
p45640
aVBetter yet, create your own
p45641
aVFile + Export Template
p45642
as(dp45643
g9
V17034
p45644
stp45645
a((dp45646
g2
(lp45647
VI cannot think of any reason why you wouldn't do it like this:
p45648
as(dp45649
g9
V17034
p45650
stp45651
a((dp45652
g2
(lp45653
VImplement the MouseDown event and find out what tab got clicked:
p45654
as(dp45655
g9
V17034
p45656
stp45657
a((dp45658
g2
(lp45659
VYou can sort it any way you like with the TreeView
p45660
aVTreeViewNodeSorter property
p45661
aVThere's a good example in the MSDN Library article for it
p45662
as(dp45663
g9
V17034
p45664
stp45665
a((dp45666
g2
(lp45667
VIt was an adaptation to the pascal calling convention for 32-bit code
p45668
aVPascal was the calling convention for 16-bit operating systems like OS/2 and Windows 3
p45669
aVWhy pascal was chosen is a bit of a guess, even I was a small pup back then, but it is slightly more efficient
p45670
aVWhich mattered back when 640 KB was all you had to work with
p45671
aVMost Win32 functions aren't true stdcall as it also prescribes how the exported function is decorated before presented to the linker
p45672
aVLike void Mumble(int arg) becomes _Mumble@4
p45673
aVThe number after the @ describes the activation frame size
p45674
aVBut most Win32 functions are exported without any decoration
p45675
aVProbably to give the programmer a fighting chance to make GetProcAddress() work
p45676
aVI think the decoration was intended to help the linker detect mismatches between the declared API function signature and the actual one
p45677
aVHaving a mismatch in the number of passed arguments is an automatic kaboom since the callee will pop more or less arguments off the stack then were passed
p45678
aVHard to diagnose too
p45679
aVA weakness of stdcall, the cdecl convention doesn't have this problem
p45680
aVInternal calling is a mixed bag between stdcall, cdecl and thiscall
p45681
aVCan't say I've ever detected a pattern, although single-stepping Windows code isn't something I enjoy doing
p45682
as(dp45683
g9
V17034
p45684
stp45685
a((dp45686
g2
(lp45687
VYou can usually get some decent info out of a WMI query, although it requires the device driver to cooperate
p45688
aVMost do afaik
p45689
aVRun a query on the Win32_SerialPort class
p45690
aVYou can use the WMI Code Creator tool to experiment with the query and auto-generate the C# code you need
p45691
aVDon't count on being able to auto-select the device
p45692
aVYou'll need a config option to allow the user to select the port
p45693
aVYou can display the info you got from the query to help her pick the right one
p45694
aVOr ask her to unplug the device and plug it back in, the added COM port should be the right one
p45695
as(dp45696
g9
V17034
p45697
stp45698
a((dp45699
g2
(lp45700
VOdds are very good that the first task is completed by the time the 2nd task even starts running
p45701
aVYou can only observe this behavior if both threads run that code simultaneously and there's no intervening cache-synchronizing operations
p45702
aVThere is one in your code, the StartNew() method will take a lock inside the thread pool manager somewhere
p45703
aVGetting two threads to run this code simultaneously is very hard
p45704
aVThis code completes in a couple of nanoseconds
p45705
aVYou would have to try billions of times and introduce variable delays to have any odds
p45706
aVNot much point to this of course, the real problem is when this happens randomly when you don't expect it
p45707
aVStay away from this, use the lock statement to write sane multi-threaded code
p45708
as(dp45709
g9
V17034
p45710
stp45711
a((dp45712
g2
(lp45713
VIt is located in c:\u005cprogram files\u005cmicrosoft sql server\u005cxxx\u005csdk\u005cassemblies on my machine
p45714
aVWhere xxx is the SQL Server version number (90 or 100)
p45715
aVNot sure how it got there
p45716
as(dp45717
g9
V17034
p45718
stp45719
a((dp45720
g2
(lp45721
VThe Dispose() method may be called more than once, there is no rule that says it isn't legal
p45722
aVIf you do override it (implement the destructor in C++/CLI) then you have to make sure that your code is resilient to this
p45723
aVVery commonly done with an isDisposed field in the class
p45724
as(dp45725
g9
V17034
p45726
stp45727
a((dp45728
g2
(lp45729
VCould be a threading problem
p45730
aVCOM will automatically marshal method calls on a COM interface to the proper thread
p45731
aVWhich is usually the UI thread of the program
p45732
aVThis is very slow since it requires a thread context switch and the UI thread must be in a state to dispatch the call
p45733
aVFew CPU cycles are burned, everything is blocking until the call can complete
p45734
aVUse the COM object on the same thread as it was created
p45735
aVWhich ought to be the UI thread if this the object has STA requirements
p45736
aVThey usually do
p45737
as(dp45738
g9
V17034
p45739
stp45740
a((dp45741
g2
(lp45742
VYou need a transparent window that's on top of all the other controls
p45743
aVThe only way to get one is by overlapping the form with another form, made transparent with its TranparencyKey property
p45744
aVYou'll find sample code for this in my answer in this thread
p45745
as(dp45746
g9
V17034
p45747
stp45748
a((dp45749
g2
(lp45750
VThe video adapter in your workstation has a different dots-per-inch setting
p45751
aVThe form automatically rescales itself to accommodate that
p45752
aVThis is going to happen as well when you ship your product and it will run on the client's machine
p45753
aVChanging the form's AutoScaleMode property is not a fix, that will just produce clipped text in the controls
p45754
aVMake sure you form design is resilient to layout changes
p45755
aVDock, Anchor, TableLayoutPanel, FlowLayoutPanel, the Resize event for tough cases
p45756
aVAnd make sure the controls inherit their container's Font property (not bold in the Properties window)
p45757
as(dp45758
g9
V17034
p45759
stp45760
a((dp45761
g2
(lp45762
VLook at the
p45763
aVresx file to see what all is getting reassigned
p45764
aVProperties like Size and Form
p45765
aVAutoScaleDimensions are localizable properties
p45766
aVReassigning them has the kind of effect you are seeing
p45767
aVEspecially undoing the auto-scaling would be quite unpleasant
p45768
aVNo specific advise to fix this problem, this just isn't made to be run in any other place than the form constructor
p45769
aVReconstruct the form
p45770
aVPointing out that the actual user of your form never feels a need to change her native language on-the-fly never seems to make an impression
p45771
as(dp45772
g9
V17034
p45773
stp45774
a((dp45775
g2
(lp45776
VThere is no guaranteed worst-case
p45777
aVLosing the CPU for hundreds of milliseconds is quite possible
p45778
aVYou are subject to whatever kernel threads are doing, they'll always run with a higher priority than you can ever get
p45779
aVRunning into a misbehaving NIC, USB or audio driver is a problem you'll constantly be fighting
p45780
aVUnless you can control the hardware
p45781
aVIf you can survive occasional under-runs then make sure that the I/O request you use to get the device data is a waitable event
p45782
aVWindows likes scheduling threads that are blocking on an I/O request that completed ahead of all other ones
p45783
aVPolling with a Sleep() is not a good strategy
p45784
aVIt burns CPU cycles needlessly and the scheduler won't favor the thread at all
p45785
aVIf you can't survive the under-runs then you need to consider a device driver
p45786
as(dp45787
g9
V17034
p45788
stp45789
a((dp45790
g2
(lp45791
VWell, sure, you can pass the delegate instance in the form constructor, just like the name
p45792
aVThere is no advantage of doing this, the code will be very similar to having the event declared in the dialog form
p45793
aVJust non-standard
p45794
as(dp45795
g9
V17034
p45796
stp45797
a((dp45798
g2
(lp45799
VYou could P/Invoke AnimateWindow() to get effects like this
p45800
aVVisit pinvoke
p45801
aVnet for the declarations you'll need
p45802
aVBeware that the novelty of this wears off very quickly, definitely make it a user-selectable option
p45803
as(dp45804
g9
V17034
p45805
stp45806
a((dp45807
g2
(lp45808
VYes, it simply requires calling the exported function
p45809
aVThe devil is in the details though
p45810
aVThe DLL will load all its implicitly linked dependent DLLs as well
p45811
aVAnd their DllMain() entrypoints will run
p45812
aVThat's kinda okay in a simple process like regsvr32, not so okay in yours that needs to survive beyond the registration step
p45813
aVThen there's getting the permissions to write to the registry
p45814
aVUAC will definitely put a stop to that, both for running Regsvr32 as well as calling the entrypoint directly
p45815
aVTo get permission from the user you will need a separate EXE with a manifest that asks for admin rights
p45816
aVYou're not ahead
p45817
aVLook into reg-free COM, supplying the registration info in a manifest
p45818
aVYou then won't have to register the DLL anymore
p45819
aVYou'll get lots of hits if you search for the term
p45820
as(dp45821
g9
V17034
p45822
stp45823
a((dp45824
g2
(lp45825
VIt is rather important to never ask a question like this because you won't get a straight answer
p45826
aVBut since you did anyway: the minimum size is 0 bytes
p45827
aVWhich you'll get when the JIT optimizer manages to keep the value in a CPU register
p45828
aVThe next size is 2 bytes, for bool
p45829
aVand byte
p45830
aV, 1 byte for HasValue, another byte for the value
p45831
aVWhich you'll rarely get because local variables must be aligned to an address that's a multiple of 4
p45832
aVThe extra 2 bytes of padding simply will never be used
p45833
aVThe next size is 3 for short
p45834
aVand char
p45835
aV, you'll now get 1 byte of padding
p45836
aVBig leap to the next one, int
p45837
aVrequires 5 bytes but the padding increases that to 8
p45838
aVEtcetera
p45839
aVYou find this out by writing a bit of code like this:
p45840
aVAnd looking at the machine code instructions with the debugger
p45841
aVNote the ebp register offsets
p45842
aVAnd beware that the stack grows down
p45843
as(dp45844
g9
V17034
p45845
stp45846
a((dp45847
g2
(lp45848
VJust drop the /primary argument for tlbimp
p45849
aVexe
p45850
aVThere's little point in generate PIAs for your own components
p45851
aVMaking members of your classes public that use an ADOR type is best avoided, you'll saddle the user of your component with having to have a reference to it as well and use the same ADOR PIA
p45852
aVIf you really want to do this then you'll have to generate a PIA for msador15
p45853
aVdll first and register it
p45854
aVI'm pretty sure that Microsoft doesn't ship one
p45855
aVYou'll also have to deploy them
p45856
as(dp45857
g9
V17034
p45858
stp45859
a((dp45860
g2
(lp45861
VDon't start a new thread, there's no point since you're already running on another thread and InvokeRequired will always be True
p45862
aVThe mistake is that you call Me
p45863
aVInvoke() but forget to pass the "MsgString" argument
p45864
aVYou'll also want to use Me
p45865
aVBeginInvoke(), no need to wait
p45866
aVThus:
p45867
as(dp45868
g9
V17034
p45869
stp45870
a((dp45871
g2
(lp45872
VIt is in the Unicode chart, codepoint \u005cu0142
p45873
aVScroll down to the description, "Latin small letter with stroke", it has no decomposition listed
p45874
aVDon't know anything about Polish, but it is common for a letter to have a distinguishing mark that makes it its own letter instead of a base one with a diacritic
p45875
as(dp45876
g9
V17034
p45877
stp45878
a((dp45879
g2
(lp45880
VIt's the same thing
p45881
aVUsage is simple, if you create the object and use it in only one method then use using
p45882
aVIf you need to keep it alive beyond the method call then you have to use Dispose()
p45883
aVThe runtime callable wrappers for COM objects don't have a Dispose() method
p45884
as(dp45885
g9
V17034
p45886
stp45887
a((dp45888
g2
(lp45889
VYou are removing the control that has the focus
p45890
aVIt will try to find another one to give the focus to, scrolling it into view if necessary
p45891
aVShort from giving another control the focus, one thing that might work is adding the TextBox and giving it the focus before you remove the label
p45892
as(dp45893
g9
V17034
p45894
stp45895
a((dp45896
g2
(lp45897
VObviously the crash is not occurring in a managed thread, you covered that
p45898
aVYou'd better ditch those audio codecs that you are using
p45899
aVOr get help from the vendor forum
p45900
as(dp45901
g9
V17034
p45902
stp45903
a((dp45904
g2
(lp45905
VAs soon as that executes, there is no window left in your application that can still receive the focus
p45906
aVWindows needs to find another one to give the focus to, it will be a window of another app
p45907
aVA bit later your dialog shows up, but that's too late, focus is already lost
p45908
aVUsing a trick like Control
p45909
aVBeginInvoke() to minimize the form after the dialog is displayed doesn't work either, the dialog automatically closes when it parent minimizes
p45910
aVThe best you can do is hide it
p45911
aVYou'll have to use the same trick to restore it before the dialog closes or you'll still lose focus
p45912
aVLike this:
p45913
as(dp45914
g9
V17034
p45915
stp45916
a((dp45917
g2
(lp45918
VThere is very little point in targeting the client profile for
p45919
aVNET 4
p45920
ag2512
aVThe download is 41MB, the full version is 48MB, only 15% bigger
p45921
aVThe client profile does make a lot of sense if you target 3
p45922
aV5, the full install is ~350 MB
p45923
aVThe huge difference is explained by the prerequisites,
p45924
aVNET 4
p45925
aV0 requires at least XP SP3 or Vista SP1, 3
p45926
aV5 installs on any version of Windows > 2000
p45927
aVThe 3
p45928
aV5 installer thus contains lots of the required updates for unmanaged Windows components used by
p45929
aVNET
p45930
aVThe web installer lessens that blow considerably btw
p45931
aVThe client profile is painful in
p45932
aVNET 4
p45933
aV0 because VS2010 made it the default
p45934
aVNET framework target
p45935
aVAnd deals quite poorly with a solution that has projects that have a mix of full and client profile targets, produces very mystifying build errors on code that IntelliSense doesn't complain about
p45936
aVThey didn't make the same mistake again in VS2012, nor does
p45937
aVNET 4
p45938
aV5 have a Client profile
p45939
aVGood riddance
p45940
as(dp45941
g9
V17034
p45942
stp45943
a((dp45944
g2
(lp45945
VThe Panel class was designed as container, it avoids taking the focus so a child control will always get it
p45946
aVYou'll need some surgery to fix that
p45947
aVI threw in the code to get cursor key strokes in the KeyDown event as well:
p45948
as(dp45949
g9
V17034
p45950
stp45951
a((dp45952
g2
(lp45953
VYou need to pinvoke GetWindowThreadProcessId()
p45954
aVThat gets you the ID of the process that owns the window
p45955
aVBack to managed code, Process
p45956
aVGetProcessById() gives you details of the process
p45957
as(dp45958
g9
V17034
p45959
stp45960
a((dp45961
g2
(lp45962
VIn your C# Project: Project + Properties, Debug tab, tick "Enabled unmanaged code debugging"
p45963
aVSingle stepping from managed code into unmanaged code isn't going to work
p45964
aVYou need to set a breakpoint on the DLL function you want to debug
p45965
as(dp45966
g9
V17034
p45967
stp45968
a((dp45969
g2
(lp45970
VUse the [ComSourceInterface] attribute on your class
p45971
aVThe relevant MSDN Library topic is here
p45972
as(dp45973
g9
V17034
p45974
stp45975
a((dp45976
g2
(lp45977
VYes, there's a race here
p45978
aVA takes a good millisecond before the target starts running
p45979
aVIt will work 'better' if you use Control
p45980
aVBeginInvoke() instead, the form's Dispose() implementation will empty the dispatch queue
p45981
aVBut that's still a race, albeit that it will strike very rarely
p45982
aVYour code as written in the snippet doesn't require Invoke()
p45983
aVThe only clean fix is to interlock the FormClosing event and to delay the close until you got confirmation that the background thread is completed and can't be started again
p45984
aVNot easy to do with your code as is since that requires a 'completed' callback so you can really get the form closed
p45985
aVBackgroundWorker would be a better mousetrap
p45986
aVThe Q&D; fix is to catch the ObjectDisposedException that BeginInvoke will raise
p45987
aVGiven how rare this will be when you use BeginInvoke(), that ugly hack could be acceptable
p45988
aVYou just can't test it :)
p45989
as(dp45990
g9
V17034
p45991
stp45992
a((dp45993
g2
(lp45994
VYou will have to force your EXE project to run in 32-bit mode so it can use that C++ DLL
p45995
aVProject + Properties, Build tab, Platform Target = x86
p45996
as(dp45997
g9
V17034
p45998
stp45999
a((dp46000
g2
(lp46001
VHmya, it is only going to slow down a decent programmer for no more than 5 minutes:
p46002
aVwhich will blow just as hard
p46003
aVThere isn't much point in trying to prevent usage of your class that can be used anyway
p46004
aVThe Lines property ought to be useful to anybody that uses your editor, it covers the very basic need to be able to retrieve the text that was edited
p46005
aVDon't throw out the baby with the bath water
p46006
aVThe real problem here is that RTB uses so much unmanaged memory to store the text, leaving little left for the garbage collected heap
p46007
aVIt gets really slow too once you pump thousands of lines into it
p46008
aVNo component should ever be allowed to swallow up half of all available memory
p46009
aVEither limit the number of lines you allow to edit or use a better editor, like ScintillaNET
p46010
aVIt is also rather important to be a pragmatic programmer
p46011
aVBeyond hiding a property needlessly
p46012
aV600,000 lines in a text box is an enormous number
p46013
aVThere a 3/4 million words in the Bible, you are displaying 6 copies of the Bible in your text box
p46014
aVNo sane human is ever going to read that, they'll just dislike your program intensely
p46015
aVNot just because it is impossible to use effectively but also because it is a crash bucket
p46016
as(dp46017
g9
V17034
p46018
stp46019
a((dp46020
g2
(lp46021
VYou are looking at the working set size of your program
p46022
aVThe sum of the virtual memory pages of your program that are actually in RAM
p46023
aVWhen you minimize your main window, Windows assumes the user won't be interested in the program for a while and aggressively trims the working set
p46024
aVCopying the pages in RAM to the paging file and chucking them out, making room for the other process that the user is likely to start or to switch to
p46025
aVThis number will also go down automatically when the user starts another program that needs a lot of RAM
p46026
aVWindows chucks out your pages to make room for this program
p46027
aVIt picks pages that your program hasn't used for a while, making it likely that this doesn't affect the perf of your program much
p46028
aVWhen you switch back to your program, Windows needs to swap pages back into RAM
p46029
aVBut this is on-demand, it only pages-in pages that your program actually uses
p46030
aVWhich will normally be less than what it used before, no need to swap the initialization code of your program back in for example
p46031
aVNeedless to say perhaps, the number has absolutely nothing to do with the memory usage of your program, it is merely a statistical number
p46032
aVPrivate bytes would be a better indicator for a memory leak
p46033
aVTaskmgr doesn't show that, SysInternals' ProcMon tool does
p46034
aVIt still isn't a great indicator because that number also includes any blocks in the heap that were freed by your program and were added to the list of free blocks, ready to be re-used
p46035
aVThere is no good way to measure actual memory in use, read the small print for the HeapWalk() API function for the kind of trouble that causes
p46036
aVThe memory and heap manager in Windows are far too sophisticated to draw conclusions from the available numbers
p46037
aVUse a leak detection tool, like the VC debug allocator (crtdbg
p46038
aVh)
p46039
as(dp46040
g9
V17034
p46041
stp46042
a((dp46043
g2
(lp46044
VThe last stand-alone version of the
p46045
aVNET SDK was 2
p46046
ag2512
aVIt got integrated with the Windows SDK after that
p46047
aVYou already have the important bits on your machine, it is stored in c:\u005cprogram files\u005cmicrosoft sdks\u005cwindodws\u005cv7
p46048
aV0a
p46049
aVIt is a truncated version (thus the "a"), the full version is a separate download
p46050
aVBeware that this download is 7
p46051
ag2582
aVThere have been a fair number of critical problems with the version 7
p46052
aV0 SDK installer btw
p46053
aVThe install failed on my machine, leaving a partial install that didn't rewind
p46054
aVI had to patch registry entries by hand to recover
p46055
aVI recommend you install this on a non-critical machine and just copy the folder
p46056
aVI had no trouble with the SDK 7
p46057
aV1 installer
p46058
as(dp46059
g9
V17034
p46060
stp46061
a((dp46062
g2
(lp46063
VThe VB
p46064
aVNET and C# IDEs merely look the same
p46065
aVThey are actually very different chunks of code that don't have much in common beyond the text editor engine
p46066
aVThey did a pretty good job making them look similar, it certainly wasn't that way in earlier releases of VS
p46067
aVBut there are subtle differences here and there, like the ones you are fretting over
p46068
aVYou'll need to get over this
p46069
aVPick, say, global warming or the economy to direct your rage
p46070
aVOr a hapless contributor to SO :)
p46071
as(dp46072
g9
V17034
p46073
stp46074
a((dp46075
g2
(lp46076
VAssuming there are no other delays in your code that would prevent the UI thread from re-entering the message loop so that the OnPaint() method can be called: your Paint event handler gets called after PictureBox has drawn the Image
p46077
aVIt isn't yet visible, PB uses double-buffering
p46078
aVThat image gets expensive to draw when it has to be resized to fit the PB's client area
p46079
aVWhich is very likely in your case because your images are pretty large
p46080
aVIt uses a high-quality bi-cubic filter to make the resized image look good
p46081
aVThat's pretty expensive, albeit that the result is good
p46082
aVTo avoid that expense, resize the image yourself before assigning it to the Image property
p46083
aVMake it just as large as the PB's ClientSize
p46084
aVThat's going to make a big difference in itself
p46085
aVThe next thing you can do is to create the scaled bitmap with the 32bppPArgb pixel format
p46086
aVIt's the format that's about 10 times faster then any other because it matches the video adapter on most machines so no pixel format conversions are necessary
p46087
aVSome code:
p46088
aVYou'll probably want to tinker with this so the image preserves its aspect ratio
p46089
aVTry it first as-is to make sure you do get the perf improvement
p46090
as(dp46091
g9
V17034
p46092
stp46093
a((dp46094
g2
(lp46095
VWow, that KB article is pretty bad
p46096
aVThat should be done by overriding IsInputKey()
p46097
aVI don't care much for DGV, it is a bugger to customize
p46098
aVBut you can probably whack this into some kind of shape:
p46099
as(dp46100
g9
V17034
p46101
stp46102
a((dp46103
g2
(lp46104
VOld stuff, it probably was never tried on a user account with limited privileges before
p46105
aVIt probably does something verboten, like writing to registry keys in HKLM\u005cSoftware or creating a file in c:\u005cwindows
p46106
aVThat's over and done with these days
p46107
aVIf you have no idea what it might be done then use SysInternals' ProcMon tool to observe it using the disk and the registry
p46108
aVThe access denied error should pop out, although it takes a bit of digging
p46109
aVIf you can't change the code then you really ought to consider to end-of-life this component
p46110
aVYou can hack the rights for the specific file or registry key that it is trying to munch as an intermediary solution
p46111
aVBe sure not to do anything to the c:\u005cwindows directories, that causes more trouble than it solves
p46112
aVWhich is another thing, your component really doesn't belong in a private Windows directory
p46113
as(dp46114
g9
V17034
p46115
stp46116
a((dp46117
g2
(lp46118
VIt is telling you that it cannot find the ProgId in the registry
p46119
aVThat's not very healthy, it is a pretty standard component on any Windows install
p46120
aVVerify this, fire up regedit
p46121
aVexe and navigate to HKLM\u005cSoftware\u005cClasses\u005cADODB
p46122
aVConnection
p46123
aVIf that is missing then you need to install the dbase providers on that machine
p46124
aVDownload the MDAC 2
p46125
aV8 installer from Microsoft and run it
p46126
aVIf it is not missing then you have a more mysterious problem, perhaps something to do with this being a 64-bit operating system
p46127
aVLook in HKLM\u005cSoftware\u005cWow6432Node then
p46128
aVGet additional diagnostics by using the SysInternals' ProcMon tool to see what it is poking at in the registry
p46129
as(dp46130
g9
V17034
p46131
stp46132
a((dp46133
g2
(lp46134
VYou are doing it wrong
p46135
aVThe
p46136
aVrgs files are there so that the component can install itself
p46137
aVAny installer supports letting a component install itself
p46138
aVA Visual Studio Setup project for example, set the Register property
p46139
as(dp46140
g9
V17034
p46141
stp46142
a((dp46143
g2
(lp46144
VJust ignore the time part of the date you get from DTP with DateTime
p46145
aVDate
p46146
aVLike this:
p46147
as(dp46148
g9
V17034
p46149
stp46150
a((dp46151
g2
(lp46152
VThat's what Office InfoPath was designed to do
p46153
aVIt's got an automation interface, like any Office product, easily usable from a
p46154
aVNET program
p46155
aVMicrosoft
p46156
aVOffice
p46157
aVInterop
p46158
aVInfoPath namespace
p46159
aVMicrosoft takes care of the redist :)
p46160
as(dp46161
g9
V17034
p46162
stp46163
a((dp46164
g2
(lp46165
VI think it is largely historic, but there is one clear distinction
p46166
aVA code page is a look-up table, one particular byte maps to a specific character
p46167
aVDifferent code pages use different mappings
p46168
aVIn the olden days, those mappings weren't actually performed
p46169
aVWhich required you to also have fonts that had glyphs to match the code page
p46170
aVStill a problem today btw, console windows have a code page
p46171
aVThere is no mapping in a Unicode encoding
p46172
aVThey merely needs to squeeze 32-bits into an efficient format
p46173
aVDifferent Unicode encodings use different ways to squeeze the bits
p46174
aVThe character always has a fixed value (codepoint in Unicode speak)
p46175
aVUTF encoded text files should have a BOM, allowing the reader to autodetect the encoding
p46176
aVNo such convention exists for text files that were encoded with a code page
p46177
aVGetting good text out of them is a bit of a crap shoot
p46178
aVIt's an evil that should die already :)
p46179
as(dp46180
g9
V17034
p46181
stp46182
a((dp46183
g2
(lp46184
VThis is all the same crash reason
p46185
aVYour component threw a C++ exception and it wasn't caught with a catch statement
p46186
aVUse a debugger to find out why it is throwing exceptions
p46187
as(dp46188
g9
V17034
p46189
stp46190
a((dp46191
g2
(lp46192
VYou cannot do this with CreateProcess(), the child program has to take care of it itself
p46193
aVTwo basic ways:
p46194
aVuse the  keywords to catch and handle the SEH exception
p46195
aVregister a callback with SetUnhandledExceptionFilter()
p46196
aVTry to do as little as possible in either case, you have no idea what state the program is in when it suffered the heart attack
p46197
aVBest thing to do is to SetEvent() a named event and have your main process terminate the process
p46198
as(dp46199
g9
V17034
p46200
stp46201
a((dp46202
g2
(lp46203
VIt is rather important that you quote the source of that quote so we can get the context
p46204
aVAs near as I can see, you got that from a book about DirectShow programming
p46205
aVWhat it actually refers to is the need to call CoUninitialize()
p46206
aVYes, that's kinda important
p46207
aVA thread should call CoInitializeEx() to initialize the COM infrastructure before it starts using any of the COM API functions
p46208
aVYou really should call CoUninitialize() when that threads ends so stuff is properly cleaned up
p46209
aVTypically at the end of your program's main() function
p46210
aVFailure to do so may make another app fail when it finds a register class factory that in fact is dead
p46211
aVThis otherwise has nothing to do with a COM out-of-process server having to restrict itself in any way
p46212
aVYou specify sharing mode with the REGCLS argument to CoRegisterClassObject()
p46213
aVOf course, a server should not exit and call CoUninitialize until all its objects are released
p46214
as(dp46215
g9
V17034
p46216
stp46217
a((dp46218
g2
(lp46219
VYou can debug multiple
p46220
aVexes with one instance of the debugger by using Debug + Attach
p46221
aVI however always use two instances of Visual Studio, use Debug + Attach in the second one
p46222
aVOr you could put a __debugbreak() in the child's code, the JIT debugger window will prompt you
p46223
aVCan be a bit flaky
p46224
aVOr you can use the "Image File Execution Options" registry key to automatically launch a debugger as soon as the child
p46225
aVexe is started:
p46226
aVEdit the
p46227
aVexe name
p46228
aVAll of this assumes you have at least VS2005
p46229
as(dp46230
g9
V17034
p46231
stp46232
a((dp46233
g2
(lp46234
VThere's a high probability of failure here
p46235
aVIt starts with inserting the RTF in the right place
p46236
aVThe true problem is likely to be the exact format you generate
p46237
aVImages are embedded OLE objects for RTB, they need a metadata header that describes the object
p46238
aVThere is no support whatsoever for this in
p46239
aVNET, OLE embedding went the way of the dodo a long time ago
p46240
aVOne thing I know that works is to get an image into an RTB through the clipboard
p46241
aVLike this:
p46242
aVAdjust the SelectionStart property as necessary to determine where the image gets inserted
p46243
as(dp46244
g9
V17034
p46245
stp46246
a((dp46247
g2
(lp46248
VYour second snippet does it the right way
p46249
aVIt uses FileStream, not StreamReader
p46250
aVStreamReader is only suitable for text files
p46251
as(dp46252
g9
V17034
p46253
stp46254
a((dp46255
g2
(lp46256
VYou are not using the Unicode version, that requires CharSet = CharSet
p46257
aVUnicode in the [DllImport] declaration
p46258
aVFurthermore, creating directories with long names has nothing to do with the security attribute
p46259
aVYou have to prefix the name with
p46260
aVThus:
p46261
as(dp46262
g9
V17034
p46263
stp46264
a((dp46265
g2
(lp46266
VDebug + Windows + Modules
p46267
aVLocate the DLL in the list and right-click it
p46268
aVSymbol Load Information tells you where the debugger looked for the
p46269
aVpdb file
p46270
aVMake sure you get it there
p46271
aVAfter update: it is very likely that with /clr enabled that you are actually running code that was compiled to IL and just-in-time compiled
p46272
aVJust like managed code
p46273
aVYou'll need to switch the debugger to Mixed mode debugging
p46274
aVProject + Properties, Debugging, Debugger Type = Mixed
p46275
as(dp46276
g9
V17034
p46277
stp46278
a((dp46279
g2
(lp46280
VYou cannot call such a method in another process
p46281
aVYou could try to inject the WM_COMMAND message that a context menu usually generates with SendMessage
p46282
aVUse Spy++ to find out what that message might be, if it exists
p46283
as(dp46284
g9
V17034
p46285
stp46286
a((dp46287
g2
(lp46288
VThis is entirely normal when you use FileSystemWatcher
p46289
aVIt is very likely that the file you get the notification for is in use by the process that created or modified the file
p46290
aVYou will have to wait until the process stops using it
p46291
aVYou of course cannot predict when that happens
p46292
aVA generic approach is to put the path to the file in a list that you periodically scan, triggered by a timer
p46293
aVEventually you'll get access to the file
p46294
as(dp46295
g9
V17034
p46296
stp46297
a((dp46298
g2
(lp46299
VHaving your form TopMost is not sufficient to ensure this method runs
p46300
aVYour form also needs to have the focus
p46301
aVThat requires calling its Activate() method (SetForegroundWindow in the Win32 API)
p46302
aVWhich is not guaranteed to run, you cannot steal the focus away from a window that the user is actively using
p46303
aVOnly when enough time has passed since the last input event can you grab the focus
p46304
aVNot sure what you are really trying to do, maybe you need a keyboard hook or use RegisterHotKey
p46305
as(dp46306
g9
V17034
p46307
stp46308
a((dp46309
g2
(lp46310
VThere's no problem doing this
p46311
aVThe more current approach is to use Code Contracts
p46312
as(dp46313
g9
V17034
p46314
stp46315
a((dp46316
g2
(lp46317
VNothing special is needed
p46318
aVJust write your code in a
p46319
aVc source code file instead of a
p46320
aVcpp file
p46321
aVThe project templates create
p46322
aVcpp files, just rename them with right-click + Rename
p46323
as(dp46324
g9
V17034
p46325
stp46326
a((dp46327
g2
(lp46328
VThis is how Windows Forms and WPF work
p46329
aVI'd strongly recommend you use one of them to implement this task
p46330
aVUse a Timer, implement its Tick event
p46331
aVAnd implement the form's KeyDown event
p46332
aVSomething like that, your question is too generic to be more specific
p46333
as(dp46334
g9
V17034
p46335
stp46336
a((dp46337
g2
(lp46338
VIt is because you didn't turn on the WS_CLIPCHILDREN style for the main window
p46339
aVFix:
p46340
aVThe 'color' variable is a hack, avoid this in real code
p46341
aVYou're leaking the brush btw
p46342
as(dp46343
g9
V17034
p46344
stp46345
a((dp46346
g2
(lp46347
VYes, this is not possible
p46348
aVApplication settings are serialized using XML serialization
p46349
aVOne hard requirement for a class to be serializable is that it needs to have a parameter-less constructor
p46350
aVNeither class has one
p46351
aVThis isn't a real problem because either class has a constructor that takes a string
p46352
aVSo, make the setting a string and you can get always get a FileInfo or a DirectoryInfo out of it
p46353
aVAlbeit that it must refer to a file system object that exists
p46354
aVIf that's an issue then just make your own class
p46355
as(dp46356
g9
V17034
p46357
stp46358
a((dp46359
g2
(lp46360
VIt you look in an ASCII code chart, you'll see the 0x3f is the character code for
p46361
aVThat's the substitution character you'll get when Encoding
p46362
aVGetString() cannot convert a byte value to a character
p46363
aVMakes sense, the default SerialPort
p46364
aVEncoding is ASCII, 0xff is not a valid character code in that encoding
p46365
aVThe root problem is that you are reading strings
p46366
aVBut the device is not sending strings, it is sending bytes
p46367
aVYou must use SerialPort
p46368
aVRead() instead of ReadExisting()
p46369
as(dp46370
g9
V17034
p46371
stp46372
a((dp46373
g2
(lp46374
VThat should be 900 to get the text vertical, units are 0
p46375
aV1 degrees
p46376
aVYour plan to let DrawText take care of the line breaks is going to fall flat I'm afraid
p46377
aVI could not convince it to align the text properly
p46378
aVIt aligns on the last line, not the first
p46379
aVSome code to play with:
p46380
aVI think I tried all alignment options
p46381
as(dp46382
g9
V17034
p46383
stp46384
a((dp46385
g2
(lp46386
VYou've got an impossible stack trace
p46387
aVIt is clear that threading is not the cause of the problem, everything is running on the main thread and the [STAThread] attribute on your Main method is setting the apartment state
p46388
aVThe stack trace shows that it indeed the entrypoint
p46389
aVWell, bad news, some kind of add-on is farking with your main thread
p46390
aVDoing something nasty like calling CoUninitialize too many times
p46391
aVI've had this happen to me once, took me a month to find it
p46392
aVStart diagnosing this with Project + Properties, Debug tab, tick "Enable unmanaged code debugging"
p46393
aVThat lets you see what DLLs are getting loaded into your program, it is shown in the Output window
p46394
aVThe first lead is when the dialog displays okay the first time but fails the second time
p46395
aVThen you've got some kind of shell extension handler that wormed its way into your program
p46396
aVUse SysInternals' AutoRuns utility and disable any shell extension handler that wasn't made by Microsoft
p46397
aVIt gets harder when the dialog fails right away
p46398
aVThen use Debug + Windows + Modules and go through the list of DLLs
p46399
aVPay attention to where they came from, shown in the Path column
p46400
aVDistrust anything the doesn't quack like a
p46401
aVNET or Microsoft DLL
p46402
aVEspecially not having a Symbol File when you enabled the Microsoft Symbol Server is a lead
p46403
aVA good way to make some headway with this is to compare that list to one you see on another machine that doesn't have this problem
p46404
aVI do have a war-story about this
p46405
aVMy COM code was crashing on hundreds of machines, all I had to go by was a minidump
p46406
aVTook me a month to discover the source, an open source project named ffdshow
p46407
aVVery widely distributed, using different names as well
p46408
aVIt had a bug, calling CoUnitialize two times too many
p46409
aVThe bug was present in releases for two years but got fixed about a year and a half ago
p46410
aVVery hard to diagnose, I didn't get close to it until I started looking at old releases
p46411
aVIf you do see ffdshow in your Modules window then you're close :)
p46412
aVGood luck, let us know the evil-doer
p46413
as(dp46414
g9
V17034
p46415
stp46416
a((dp46417
g2
(lp46418
VAny code that's generated with System
p46419
aVReflection
p46420
aVEmit namespace classes won't have a CodeBase
p46421
aVSince the code wasn't loaded from an assembly, it was generated at runtime
p46422
aVThat certainly includes System
p46423
aVXml
p46424
aVXsl classes, they do use the internal System
p46425
aVXml
p46426
aVXsl
p46427
aVXmlILGenerator class which heavily leans on System
p46428
aVXml
p46429
aVXsl
p46430
aVIlGen
p46431
aVLots of Reflection
p46432
aVEmit code there
p46433
aVI cannot guess why this worked before
p46434
aVMaybe
p46435
aVNET 4
p46436
aV0, not sure
p46437
as(dp46438
g9
V17034
p46439
stp46440
a((dp46441
g2
(lp46442
VThere's a lot more to implementing an interface than meets the eye
p46443
aVFor one, implementation methods are virtual, even though you don't use that keyword
p46444
aVIn fact, you're not allowed to use that keyword
p46445
aVFor another, the compiler rearranges the methods to match the method table layout of the interface
p46446
aVRemoving the inherited interface from the declaration is guaranteed to make the result incompatible
p46447
aVThe methods won't be virtual anymore
p46448
aVWhat you are pursuing is called 'dynamic dispatch'
p46449
aVImplemented in the DLR and integrated into
p46450
aVNET 4
p46451
aV0 and the C# 4
p46452
aV0 language
p46453
aVRe-inventing the System
p46454
aVReflection code and making it efficient is a major undertaking
p46455
as(dp46456
g9
V17034
p46457
stp46458
a((dp46459
g2
(lp46460
VYou get this exception because the code is running in the finalizer thread
p46461
aVYou are referencing an object that is already finalized
p46462
aVThe order in which objects are finalized is not deterministic
p46463
aVThat's what causes it, what you'd do about it is unclear to me from the snippet
p46464
as(dp46465
g9
V17034
p46466
stp46467
a((dp46468
g2
(lp46469
VI assume you mean an out-of-process server
p46470
aVNo, COM is heavily invested in preventing you from retrieving this information
p46471
aVImportant so it can host the COM object as it sees fit
p46472
aVWhich enables things like surrogates, DCOM and the COM+ stuff
p46473
aVYou'll need the interface method
p46474
as(dp46475
g9
V17034
p46476
stp46477
a((dp46478
g2
(lp46479
Vreading location 0xccccccc0
p46480
aVThe debug build always initializes local variables with the value 0xcccccccc, designed to let your program crash when it tries to use an uninitialized variable
p46481
aVThat's working well, always nice to get a diagnostic for a bug in your code that will cause random failure in the shipped product
p46482
aVThis of course has nothing to do with your setup project
p46483
aVUse the debugger to find out where the bug is located
p46484
aVThe call stack should be a major hint as to what pointer is invalid
p46485
as(dp46486
g9
V17034
p46487
stp46488
a((dp46489
g2
(lp46490
VThose style flag combinations are invalid
p46491
aVA child window cannot be a popup nor can it be top-most
p46492
aVNo idea what kind of side effects that might have, never tried to get this wrong intentionally
p46493
aVGetting stuck on this might be educational but not very practical
p46494
aVHave you considered using a class library to take care of the gooey stuff
p46495
as(dp46496
g9
V17034
p46497
stp46498
a((dp46499
g2
(lp46500
VIt is entirely legal for a device driver to return less bytes than requested
p46501
aVThat's why ReadFile() has the lpNumberOfBytesRead argument
p46502
aVYou should avoid the low-level CRT implementation details, like _read()
p46503
aVUse fread() instead
p46504
aVUpdate: this isn't the correct answer
p46505
aVIt looks like your virtual machine simply refuses to consider ReadFile() calls that ask for more than 16MB
p46506
aVProbably has something to do with an internal buffer it uses to talk to the host operating system
p46507
aVNothing you can do but call fread() in a loop so you can stay below this upper limit
p46508
as(dp46509
g9
V17034
p46510
stp46511
a((dp46512
g2
(lp46513
VUndocumented
p46514
aVBut it isn't unusual for a process to return the Windows error, COM failure HRESULT or exception code
p46515
aVWhich explains why it isn't documented
p46516
aVWindows error code 4 is "Too many open files"
p46517
aVGot deeply nested
p46518
aVh files or recursive #includes without a guard
p46519
as(dp46520
g9
V17034
p46521
stp46522
a((dp46523
g2
(lp46524
VCheckListBox
p46525
aVItems only implements IEnumerable, not
p46526
aVYou get the overload of AsQueryable() that returns IQueryable (not the generic one)
p46527
aVWhich only has the Cast and OfType extension methods
p46528
aVCast the items back from object to Department
p46529
aVLike this:
p46530
aVYou don't need AsQueryable() anymore btw
p46531
as(dp46532
g9
V17034
p46533
stp46534
a((dp46535
g2
(lp46536
VIt is not the DLL that crashes, it is your thread that suffers the heart attack
p46537
aVIt cannot continue, which usually means your process is done for as well
p46538
aVTrying to handle the exception is rarely possible, you don't know what kind of damage was done
p46539
aVRunning it in a separate process is the only reasonable workaround
p46540
aVAlthough trying to recover from this process suddenly dying is unreasonably hard
p46541
as(dp46542
g9
V17034
p46543
stp46544
a((dp46545
g2
(lp46546
VYou can find bit twiddling algorithms in the fxtbook
p46547
aVChapter 1
p46548
aV14 gives these bit swapping algorithms:
p46549
aVWhich makes your byte value bit reversal:
p46550
aVThe x86 JIT compiler doesn't do a great job optimizing this code
p46551
aVIf speed matters then you could use it to initialize a byte[] to make it a fast lookup instead
p46552
as(dp46553
g9
V17034
p46554
stp46555
a((dp46556
g2
(lp46557
VThis looks like a really elaborate ploy to avoid the && operator
p46558
aVBoolean expressions are coolio:
p46559
as(dp46560
g9
V17034
p46561
stp46562
a((dp46563
g2
(lp46564
VThis is not a common complaint, which makes it likely it is environmental
p46565
aVSome random shots in the dark:
p46566
aVNot having at least 2 GB of RAM
p46567
aVInstalling VS2010 on an old machine with a badly fragmented disk drive
p46568
aVEditing extremely large source code files (> 10,000 lines)
p46569
aVKeeping a very large number of editor tabs opened (> 50)
p46570
aVA bad interaction with a Visual Studio add-on
p46571
aVA bad interaction with a system add-on
p46572
aVThe IntelliSense engine for C++ has lots of tweakable items in Tools + Options, Text Editor, C/C++, Advanced
p46573
aVThis blog post describes these options in detail
p46574
aVIf your machine is old and not well maintained (i
p46575
ag9581
aVnever ran a disk defrag, lots of shell extension handlers) then consider a new one or a system wipe
p46576
as(dp46577
g9
V17034
p46578
stp46579
a((dp46580
g2
(lp46581
VThere is no dedicated shortcut key-stroke or Windows message
p46582
aVOdds are pretty good that the mouse helper has specific awareness of the process that has the focus
p46583
aVAnd generates the specific command that this program needs to reset the zoom, possibly a WM_COMMAND message
p46584
aVUse a tool like Microsoft's Spy++ to see what messages are generated, if any
p46585
as(dp46586
g9
V17034
p46587
stp46588
a((dp46589
g2
(lp46590
VThere is no black magic at work here
p46591
aVThe string class is immutable simply because it doesn't have any public fields, properties or methods that allows you to modify the internal string
p46592
aVAny method that mutates a string returns a new string instance
p46593
aVYou of course can do this as well with your own classes
p46594
as(dp46595
g9
V17034
p46596
stp46597
a((dp46598
g2
(lp46599
VWriting C code that uses a COM server is outlawed by the 'cruel and unusual punishment' clause in Article 5 of the Universal Declaration of Human Rights
p46600
aVShould you elect to ignore this then try to get started by running OleView
p46601
aVexe, File + View TypeLib, select the DLL
p46602
aVThat opens a window with the contents of the type library embedded in the DLL
p46603
aVCopy and paste the interface declarations into a
p46604
aVidl file
p46605
aVRun this through midl
p46606
aVexe, that produces a
p46607
aVh file that has C compatible declarations for the interfaces
p46608
as(dp46609
g9
V17034
p46610
stp46611
a((dp46612
g2
(lp46613
VI reckon you want this:
p46614
aVNote that this consumes the next element, just what you want if I read your question right
p46615
as(dp46616
g9
V17034
p46617
stp46618
a((dp46619
g2
(lp46620
VThis is a very wrong-headed approach
p46621
aVYou never want to intentionally throw accuracy away in your program
p46622
aVYour computer is patient, it has no trouble keeping track of up to 15 significant digits in a number
p46623
aVWhich is as much as you'll ever get out a double value
p46624
aVYou'll get in deep trouble if you intentionally make it less accurate and keep using the resulting values in further computations
p46625
aVOnly people care what the number looks like
p46626
aVAccommodate that by displaying the value to human eyes and then get rid of noise digits
p46627
aVLike:
p46628
aVor
p46629
as(dp46630
g9
V17034
p46631
stp46632
a((dp46633
g2
(lp46634
VYes, sure, that's slow
p46635
aVYou are making a round-trip through the kernel and video device driver for each individual pixel
p46636
aVYou make it fast by drawing to memory first, then update the screen in one fell swoop
p46637
aVThat takes, say, CreateDIBitmap, CreateCompatibleDc() and BitBlt()
p46638
aVThis isn't a good time and place for an extensive tutorial on graphics programming
p46639
aVIt is well covered by any introductory text on GDI and/or Windows API programming
p46640
aVEverything you'll need to know you can find in Petzold's seminal Programming Windows
p46641
as(dp46642
g9
V17034
p46643
stp46644
a((dp46645
g2
(lp46646
VThe CLR makes a hard promise that all local variables will be initialized to their default value upon entry into the method before the first statement is executed
p46647
aVThis promise is implemented by the JIT compiler
p46648
aVSeeing this is a bit difficult since the C# requires variables to be initialized explicitly before they are used
p46649
aVBut here's an example:
p46650
aVUse Debug + Windows + Disassembly to see the generated code:
p46651
aVRewriting this to initialize ix to zero produces this code:
p46652
aVWell, that's a bit sad
p46653
aVThe JIT compiler is usually quite good at optimizing useless code away but fumbles in this particular case
p46654
aVSo, you're friend is right
p46655
aVAt least for the x86 JIT compiler, not close to an x64 machine right now
p46656
aVThe overhead is probably around half a nanosecond or so
p46657
aVNot something that is easy to measure
p46658
as(dp46659
g9
V17034
p46660
stp46661
a((dp46662
g2
(lp46663
VYou have to use the parent's mdi client window's PointToScreen() method:
p46664
aVYou cannot avoid the slight offset you get on Aero, nor the flicker
p46665
as(dp46666
g9
V17034
p46667
stp46668
a((dp46669
g2
(lp46670
VCheck for 0x207 and 0x208, middle button down and up:
p46671
as(dp46672
g9
V17034
p46673
stp46674
a((dp46675
g2
(lp46676
VNah, the short name gets created on-the-fly when the file is restored
p46677
aVWhich is very important, the original short name might already be in use
p46678
aVWhat happens to the access rights is documented in the SDK docs for BackupWrite
p46679
aVNote the bProcessSecurity argument
p46680
aVNot sure what happens when the SID doesn't exist, easy to find out by trying that
p46681
as(dp46682
g9
V17034
p46683
stp46684
a((dp46685
g2
(lp46686
VYou created two single-threaded apartments by calling CoInitialize(NULL)
p46687
aVAn interface pointer must be marshaled from one apartment to the other before it is usable
p46688
aVInitializing the worker thread as MTA doesn't solve the problem
p46689
aVThe original interface pointer was still created in a single-threaded apartment and is thus not thread-safe
p46690
aVIn other words, you cannot call the interface methods directly from a thread
p46691
aVThose calls have to be marshaled to the thread that created the interface
p46692
aVMarshaling the interface pointer sets up the plumbing that makes that possible
p46693
aVThe only time you don't have to marshal is when both threads are MTA
p46694
aVThat's almost never possible, your main thread must be STA if it creates any windows
p46695
aVAnd the COM server would actually have to be thread-safe, they very rarely are
p46696
aVThey advertise what they need with the ThreadingModel key in the registry
p46697
aVCOM will actually create an STA thread if necessary to find a good home for the server
p46698
aVYou must marshal the pointer with CoMarshalInterThreadInterfaceInStream() to avoid the error
p46699
aVThat's a fairly unfriendly function, IGlobalInterfaceTable is easier to use
p46700
aVThe COM server also has to support it, you typically need a proxy/stub DLL that takes care of the marshaling
p46701
aVYou'll get E_NOINTERFACE if it doesn't
p46702
aVAlso beware the overhead, marshaling a call from the worker thread to the main thread is pretty expensive and subject to how responsive your main thread is
p46703
aVIn other words, if you wrote the thread to speed up your program or to avoid blocking the user interface then this won't actually work
p46704
aVIt is the 'there is no free lunch' principle
p46705
as(dp46706
g9
V17034
p46707
stp46708
a((dp46709
g2
(lp46710
VNo, the automation interface of the free version is quite limited
p46711
aVYou'll get more with the retail edition
p46712
aVThe API manual is here
p46713
aVBeware that the document is quite confuzzling, it mixes the docs for the freeware and retail edition
p46714
aVChapter 3 starts talking about COM specific stuff, the kind you could use from a
p46715
aVNET app
p46716
as(dp46717
g9
V17034
p46718
stp46719
a((dp46720
g2
(lp46721
VSpeechLib
p46722
aVdll is the COM interop library for the native COM interface (SAPI)
p46723
aVSpeechRecognitionEngine is the friendly
p46724
aVNET class wrapper for it
p46725
aVThey both access the exact same recognition engine
p46726
aVThere's probably some kind of problem with your recording
p46727
aVUsually a volume issue, like clipping (too loud) or too much noise (too soft)
p46728
aVGet some basic diagnostics by implementing the AudioSignalProblemOccurred event
p46729
as(dp46730
g9
V17034
p46731
stp46732
a((dp46733
g2
(lp46734
VSame answer as you previous question
p46735
aVThe retail automation interface has the FindText() method
p46736
aVI already gave you the link to the API documentation
p46737
as(dp46738
g9
V17034
p46739
stp46740
a((dp46741
g2
(lp46742
VWinforms doesn't give you direct access to the MDI client window
p46743
aVYou have to find it, like this:
p46744
as(dp46745
g9
V17034
p46746
stp46747
a((dp46748
g2
(lp46749
VProcessStartInfo
p46750
aVVerb will only have an effect if the process is started by ShellExecuteEx()
p46751
aVWhich requires UseShellExecute = true
p46752
aVRedirecting I/O and hiding the window can only work if the process is started by CreateProcess()
p46753
aVWhich requires UseShellExecute = false
p46754
aVWell, that's why it doesn't work
p46755
aVNot sure if forbidding to start a hidden process that bypasses UAC was intentional
p46756
aVProbably
p46757
aVVery probably
p46758
aVCheck this thread for the manifest you need to display the UAC elevation prompt
p46759
as(dp46760
g9
V17034
p46761
stp46762
a((dp46763
g2
(lp46764
VI looked at the patch diff
p46765
aVThis doesn't look like a subtle one, that's a heckofalot [XmlIgnores]
p46766
aVWith potentially wide-ranging effects on devs that expect those classes to xml-serialize like they always did before
p46767
aVPatches need to follow the Hippocratic oath: first do no harm
p46768
aVThis has an 'operation succeeded, patient dead' smell
p46769
aVI don't want to get bogged down in the technicalities, it sounds like your patch just didn't pass the smell test
p46770
aVIt's the team's prerogative to make the call, you have to fork if you don't like their call
p46771
aVForking requires getting support from other devs that have the same problem
p46772
aVCould happen, but "just make it work" is rarely good enough
p46773
aVGood luck
p46774
aVHow is the Mono patch coming along
p46775
as(dp46776
g9
V17034
p46777
stp46778
a((dp46779
g2
(lp46780
VYou are already willing to give up on foreach
p46781
aVSo this ought to be suitable:
p46782
as(dp46783
g9
V17034
p46784
stp46785
a((dp46786
g2
(lp46787
VI couldn't get the GetPreviewHandlerGUID() to recognize a
p46788
aVtxt file and had to inject the GUID directly
p46789
aVYou can see what goes wrong when you use Project + Properties, Debug, tick Enable unmanaged code debugging
p46790
aVThe debugger will now stop on the problem and display
p46791
aV`STATUS_STACK_BUFFER_OVERRUN encountered
p46792
aVThe top of the call stack looks like this:
p46793
aVThe problem is located in the StreamInCallback() function
p46794
aVIt is called by the RichTextBox that's used to display the preview (msftedit
p46795
aVdll) to load the file
p46796
aVThe code in this callback function has a bug, it destroys the 'canary' that's used to detect that the stack frame got corrupted because of a buffer overrun
p46797
aVThis is part of the counter-measures that Microsoft took to prevent viruses from injecting themselves by buffer overruns
p46798
aVThe /GS compile option in Visual Studio for the C/C++ languages
p46799
aVOnce detected, the CRT very swiftly terminates the program
p46800
aVThis happens without an exception getting raised, the stack cannot safely be unwound because it was compromised
p46801
aVAccordingly, the CLR cannot catch the exception
p46802
aVThis bug is specific to the TXT file viewer
p46803
aVThere's nothing you can do about it other than not using it
p46804
aVReporting this bug to connect
p46805
aVmicrosoft
p46806
aVcom probably isn't useful, they'll close it as 'external'
p46807
aVThis is otherwise a subtle hint what can happen when you let unmanaged code run inside your program ;)
p46808
as(dp46809
g9
V17034
p46810
stp46811
a((dp46812
g2
(lp46813
VJust don't use a macro, use a variable
p46814
as(dp46815
g9
V17034
p46816
stp46817
a((dp46818
g2
(lp46819
VThe directory name is invalid
p46820
aVThat's your real problem
p46821
as(dp46822
g9
V17034
p46823
stp46824
a((dp46825
g2
(lp46826
VTableLayoutPanel would be my call
p46827
as(dp46828
g9
V17034
p46829
stp46830
a((dp46831
g2
(lp46832
VYes, awkward
p46833
aVYou've got bigger problems, (0, 0) won't be valid even on the primary monitor if the user put the taskbar on the left or the top
p46834
aVLike I did
p46835
aVYou can get help from the Windows Forms Screen class
p46836
aVUse its FromPoint() method, then the WorkingArea property
p46837
aVOr the Bounds property if you allow the window to go full-screen
p46838
aVPersonally, I'd just P/Invoke GetWindowRect()
p46839
as(dp46840
g9
V17034
p46841
stp46842
a((dp46843
g2
(lp46844
VYou can do it by invoking the constructor for the nullable type you need
p46845
aVLike this:
p46846
as(dp46847
g9
V17034
p46848
stp46849
a((dp46850
g2
(lp46851
VIts okayish, but the Or operator doesn't generate well distributed hash values since it can only turn bits on, not off
p46852
aVUse the Xor operator instead
p46853
as(dp46854
g9
V17034
p46855
stp46856
a((dp46857
g2
(lp46858
VThis is a side-effect of the C++/CLI language supported by the IDE
p46859
aVWhere event is a keyword
p46860
aVThere are others, like gcnew, generic, array, etc
p46861
aVSyntax highlighting is based on the file name extension and C++/CLI also uses
p46862
aVcpp
p46863
aVI can't think of an easy fix
p46864
aVI'd recommend you post feedback to connect
p46865
aVmicrosoft
p46866
aVcom
p46867
as(dp46868
g9
V17034
p46869
stp46870
a((dp46871
g2
(lp46872
Vwhile (netStream
p46873
aVDataAvailable);
p46874
aVThat's not correct
p46875
aVYou should stop reading when the Read() call returns 0
p46876
aVThe DataAvailable property just tells you whether or not the Read() call will block, waiting to allow the server to catch up
p46877
as(dp46878
g9
V17034
p46879
stp46880
a((dp46881
g2
(lp46882
VYou can start another instance like this:
p46883
aVYou can test the command line argument with code like this in the form constructor:
p46884
aVTo debug this, you must use Project + Properties, Debug tab, untick "Enable the Visual Studio hosting process"
p46885
as(dp46886
g9
V17034
p46887
stp46888
a((dp46889
g2
(lp46890
VYes, DrawToBitmap()
p46891
aVBut not on the transparent panel, on the one that's underneath it
p46892
aVIf that 'panel' isn't actually yours then you have to use Graphics
p46893
aVCopyFromScreen()
p46894
aVNot sure what you intend to do with it, but drawing the blurred image in the transparent panel will make it non-transparent and you cannot interact with the underlying window anymore
p46895
aVAlso, don't use Red, you'll get unintended transparency if the underlying window contains any red
p46896
aVColor
p46897
aVFuchsia is a good choice, it is a fuchsed-up color
p46898
as(dp46899
g9
V17034
p46900
stp46901
a((dp46902
g2
(lp46903
VNever noticed this before, this might be an artifact of your video display driver
p46904
aVYes, you can do something about it
p46905
aVA layered window allows you to control the opacity
p46906
aVYou could start out with SetLayeredWindowAttributes()'s bAlpha at 0 and change it after the first WM_PAINT message you process
p46907
aVA fade-in driven by a timer is a pretty common trick as well
p46908
as(dp46909
g9
V17034
p46910
stp46911
a((dp46912
g2
(lp46913
VYes, if you want to alter the array beyond just altering its elements (i
p46914
ag9581
aVadding or removing elements) then you have to pass it by reference
p46915
aVThe C# declaration would be:
p46916
aVWhich isn't great syntax
p46917
aVThe garbage collector makes it easy to return an array as the function return value:
p46918
aVBut consider a  instead
p46919
as(dp46920
g9
V17034
p46921
stp46922
a((dp46923
g2
(lp46924
VThis works because Windows doesn't allow mapping pages for the first 64 KB of the address space
p46925
aVTo catch null pointer references
p46926
aVBut I think also to catch pointer bugs in programs that were converted from the 16-bit version of Windows
p46927
aVA side-effect is that this allows to reliably distinguish resource IDs packed into a pointer value since they'll always point to non-mappable memory
p46928
as(dp46929
g9
V17034
p46930
stp46931
a((dp46932
g2
(lp46933
VTooltips display automatically
p46934
aVThat's a bit of a problem, the native Windows control has counter-measures in place to avoid displaying tips too often, potentially wearing out the user with info that has been shown frequently enough
p46935
aVNot exactly sure how that rate limiting is implemented, accumulated time is a factor (like 60 seconds), possibly also the number of times it was displayed
p46936
aVThe SDK docs do not document the implementation details
p46937
aVThere is also no message available to forcibly reset the rate limiter
p46938
aVI do think that passing another control in the Show() method resets it
p46939
aVAll and all, it does mean that the ToolTip control is really only suitable to act as a traditional tool tip
p46940
aVIt doesn't work well as a 'dynamic label'
p46941
aVwhich is your alternative, a Label control with BackColor = Info
p46942
aVAlbeit it not quite the same because you cannot easily make it a top-level window
p46943
as(dp46944
g9
V17034
p46945
stp46946
a((dp46947
g2
(lp46948
VFind one, right-click, Find All References
p46949
aVReflector can help too
p46950
aVRight-click the property getter, Analyze, Used by
p46951
as(dp46952
g9
V17034
p46953
stp46954
a((dp46955
g2
(lp46956
VYes, very awkward language
p46957
aVIt is a prototype definition of a function
p46958
aVWhich you can use with the __except keyword or as an argument to SetUnhandledExceptionFilter()
p46959
aVEither would make yours an 'application defined function'
p46960
aVThere's default handling if you do neither, the debugger automatically stops at an unhandled exception
p46961
aVWhich I suppose is what they meant with "that passes exceptions to the debugger"
p46962
aVThe SDK docs for SEH deserve an all-around failing grade
p46963
as(dp46964
g9
V17034
p46965
stp46966
a((dp46967
g2
(lp46968
VYou will have to marshal the Mumble
p46969
aVMinute value yourself with Marshal
p46970
aVReadXxxx()
p46971
aVThese declarations are not great for interop, writing a wrapper in the C++/CLI language is advisable
p46972
as(dp46973
g9
V17034
p46974
stp46975
a((dp46976
g2
(lp46977
VYou cannot get this out of the Anchor property, a TLP is an obvious solution
p46978
aVIf you don't want to use that either then implement the form's Resize event and modify the controls Location and Size properties yourself
p46979
as(dp46980
g9
V17034
p46981
stp46982
a((dp46983
g2
(lp46984
VYou cannot cast WebProxyWrapperOpaque to WebProxy
p46985
aVOnly IWebProxy:
p46986
as(dp46987
g9
V17034
p46988
stp46989
a((dp46990
g2
(lp46991
VIt can not
p46992
aVYou can't use classes that have a [HostProtection] attribute that marks the class as unsafe
p46993
aVDetails are in this MSDN Library article, it includes lists of classes that are off limits
p46994
aVThe classic example of such a class is TimeZoneInfo, it loads an unmanaged DLL that won't be unloaded if there's a query abort
p46995
as(dp46996
g9
V17034
p46997
stp46998
a((dp46999
g2
(lp47000
VYou are mixing it up
p47001
aVImplementing your own IEqualityComparer<> is useful to compare the elements you put in the HashSet
p47002
aVThe Count property would only ever be useful if you want to compare the sets
p47003
aVTwo very different things
p47004
aVThere is no default implementation of Equals()
p47005
aVThe HashSet
p47006
aVSetEquals() method indeed first checks the Count properties, if possible
p47007
as(dp47008
g9
V17034
p47009
stp47010
a((dp47011
g2
(lp47012
VYou can run custom tools for a file with a specific filename extension
p47013
aVThe MSDN Library article on how to setup the custom build rule is here
p47014
aVBeware that this is pretty broken in VS2010 right now
p47015
as(dp47016
g9
V17034
p47017
stp47018
a((dp47019
g2
(lp47020
VIt is almost always a mistake to implement your own
p47021
aVSmall unique numbers require a really reliable recording of the last used number
p47022
aVThat is hard to come by, hard disks have head crashes, registries get corrupted occasionally
p47023
aVYou'll need to organize it so there is a single point of failure
p47024
aVSimilar to a dbase's auto-incrementing column
p47025
aVMake sure if there's a loss of the last number, there is also complete loss of data
p47026
aVThat means, for one, that there shouldn't be a way for the user to copy the data without also copying the record of the last number
p47027
aVOr that you always have a reliable copy of all the data and can recover the last number from it
p47028
aVQuickly
p47029
aVYou'll also have a hard time ensuring that the number is incremented atomically
p47030
aVJust starting two instances of your program is typically enough to cause mayhem
p47031
aVFixing that is tricky, you'll need an independent arbiter process that stores the number
p47032
aVThen there's the burden of having to guess what's going to happen 10 or 20 years from now
p47033
aVWill your app scale to meet the demands by then
p47034
aVThat's very rare, counting on machines getting faster is over and done with
p47035
aVWhat's a local unique number now needs to becomes a globally unique number
p47036
aVVery different kind of demands on that
p47037
aVDon't screw around with this, 16 bytes is nothing
p47038
aVUse a Guid
p47039
as(dp47040
g9
V17034
p47041
stp47042
a((dp47043
g2
(lp47044
VThere is something special about the BackColor property, it is an ambient property
p47045
aVWhat that means is that if the property was never assigned then the BackColor of the control will be the same as the parent's BackColor value
p47046
aVThat's highly desirable, it provides automatic consistent background color values
p47047
aVIf the parent changes its BackColor then all child controls change it too, to the same value
p47048
aVAs long as they never assigned it themselves
p47049
aVThat might have paralyzed the original author a bit
p47050
aVBut since he used system colors, the test shouldn't be necessary
p47051
aVI think
p47052
as(dp47053
g9
V17034
p47054
stp47055
a((dp47056
g2
(lp47057
VI can't help you diagnose what's going on, I'll just mumble a bit about what this all means
p47058
aVThis is a counter-measure against DLL Hell
p47059
aVIt is supposed to protect your application against some kind of other install program that could overwrite your COM server registry keys
p47060
aVSpecifically the (Default) key which gives the location to your server DLL
p47061
aVFrom the fake InprocServer32 value, the app can auto-detect that the Default key was overwritten and automatically launch MSI again to repair the damage
p47062
aVWhich is what you see happening
p47063
aVI thoroughly dislike the feature, it is just one more fail point in something that is already hard to troubleshoot when it blows up
p47064
aVAnd it is a useless feature, it assumes that the other installer doesn't use the exact same counter-measure
p47065
aVWhich would have worked 10 years ago
p47066
aVNo idea what you'd do to troubleshoot this particular failure
p47067
aVOther then just punt this cr*p and let the servers just SelfReg themselves
p47068
aVAt least you'll have something to work with when that doesn't work
p47069
as(dp47070
g9
V17034
p47071
stp47072
a((dp47073
g2
(lp47074
VThat's correct, there is no common ancestor
p47075
aVThe ToolStripMenuItem class is derived from ToolStripItem, the base class for many derived classes that are parts of a MenuStrip or a ToolStrip
p47076
aVThey are special because they are not derived from Control
p47077
aVThey are window-less controls, they don't have a Handle property
p47078
aVWhich is the key property of the Control base class
p47079
aVThis is an optimization, the Control derived classes are expensive
p47080
aVThey need a native Windows window, a heavy operating system object with lots of overhead
p47081
aVReally evident when you put, say, 50 buttons on a form
p47082
aVYou can see it paint
p47083
aVDuplicating this logic is thus normal
p47084
aVUsing the Tag property to control state isn't
p47085
as(dp47086
g9
V17034
p47087
stp47088
a((dp47089
g2
(lp47090
VI'm not 100% sure about what's happening, but I have a good theory
p47091
aVFont technology has progressed considerably since GDI+, probably as a result of incorporating OpenType support
p47092
aVWPF has the notion of FontStretch, the FontStretches class defines values like "Consensed", "Medium", "Expanded" etc
p47093
aVThis property isn't available in legacy code, I think the Windows font manager synthesizes font family names to keep things compatible
p47094
aVBy injecting "Condensed" (etc) in the regular family name
p47095
aVSo, mentally remove this adjective to get the WPF name
p47096
aVIt does kill your plan of course, unless you'd consider filtering it yourself in code
p47097
as(dp47098
g9
V17034
p47099
stp47100
a((dp47101
g2
(lp47102
VSystemTimeToTzSpecificLocalTime( NULL, &stUTC1;, &ftpFileWriteTime; )
p47103
aVThat doesn't work
p47104
aVYou'd have to pass the time zone in which the server lives, not your own time zone
p47105
aVAssuming that the server even sends UTC time stamps, that wasn't common the last time I gave up on it
p47106
aVFinding out what timezone it lives in ought to be challenging
p47107
aVFTP hasn't matured well
p47108
as(dp47109
g9
V17034
p47110
stp47111
a((dp47112
g2
(lp47113
VThe porting kit for the
p47114
aVNET Micro Framework directly supports AT91, BF537, Cortex-M3, LPC22XX, LPC24XX, MC9328, PXA271 and SH2
p47115
aVGet the data-sheets from their manufacturers to see what you like
p47116
as(dp47117
g9
V17034
p47118
stp47119
a((dp47120
g2
(lp47121
VNot possible
p47122
aVThe DLL stores the handle returned by HeapCreate() internally
p47123
aVYou'd have to know that handle to release the memory, you cannot get it out of the DLL
p47124
aVAnd you would have to know how many extra bytes were allocated by the DLL's malloc function to adjust the pointer
p47125
aVYou cannot even do this reliably if you write a wrapper for the DLL so that you can call free()
p47126
aVThe DLL will have to use the DLL version of the CRT and you have to compile the wrapper with the exact same version of the compiler and the CRT so they'll share the same CRT DLL
p47127
aVIf you are really desperate, you could try to hack through GetProcessHeaps()
p47128
aVAlthough that's hard to get right, error prone and you really have to know what you're doing
p47129
aVDLLs returning pointers that need to be freed is a really bad practice even in C or C++
p47130
aVJust not in
p47131
aVNET, hail the garbage collector :)
p47132
as(dp47133
g9
V17034
p47134
stp47135
a((dp47136
g2
(lp47137
VNo difference, StartEngine() isn't virtual
p47138
aVYou should not use base, in case you ever  refactor it to make it virtual
p47139
aVThe perf diff is not measurable
p47140
as(dp47141
g9
V17034
p47142
stp47143
a((dp47144
g2
(lp47145
VWell, yes, COM supports remote procedure calls to an out-of-process COM server
p47146
aVYou make the call from the client, it runs in another process as though it was called inside that process
p47147
aVA code snippet doesn't make much sense because it looks exactly like a regular function call
p47148
aVThere's a fair amount of plumbing and configuration you have to take care of to make that work
p47149
aVYou typically need a proxy/stub DLL that helps to marshal the arguments of the function call
p47150
aVThey are normally auto-generated from the IDL you write that describes the interfaces
p47151
aVIf the arguments you pass are 'unusual' then you may need to write a custom marshaller
p47152
aVThat's usually easily avoided by not passing opaque pointers or variable sized chunks of data
p47153
aVVisual Studio can get a lot of that stuff done automatically, ATL is very helpful
p47154
aVDoing something wrong unintentionally is definitely a lot harder to trouble-shoot
p47155
aVExpect several months to get up to speed on this if you've never done it before
p47156
aVGetting good learning material can be difficult, this is getting obsolete
p47157
aVThis kind of stuff is done in managed environments these days
p47158
aVMuch easier to auto-generate the required proxies
p47159
as(dp47160
g9
V17034
p47161
stp47162
a((dp47163
g2
(lp47164
VThe IntelliSense parser was completely rewritten for VS2010
p47165
aVThe
p47166
aVncb file is history
p47167
aVIt's now a
p47168
aVsdf file, a SQL Server Compact dbase
p47169
aVIt works very well on my machine, I have seen very few complaints about it
p47170
aVNotable is that the C++/CLI language has lost IntelliSense support due to the rewrite
p47171
as(dp47172
g9
V17034
p47173
stp47174
a((dp47175
g2
(lp47176
VThe problem starts at your ANSWERCB function pointer declaration
p47177
aVIt isn't actually suitable for calling the MethodD() function, that's an instance method of the class
p47178
aVMake this work in native C++ first, you need a member function pointer
p47179
aVFrom there, you'll have a lot less problems making it work from managed code, Marshal::GetDelegateForFunctionPointer() gets you what you need
p47180
as(dp47181
g9
V17034
p47182
stp47183
a((dp47184
g2
(lp47185
VYou're on the wrong track with this
p47186
aVThe cursor shape is not controlled by WM_SETCURSOR anymore when a D+D is in progress
p47187
aVCOM takes over and alters the shape when a window give the 'okay to drop' feedback
p47188
aVWhich is probably what's missing from your code
p47189
aVYou cannot bypass 'OLE' or the MFC wrappers that make it easy, the source of the drag will use it
p47190
aVLookup IDropTarget::DragEnter to get that right
p47191
aVUsing a class wrapper is certainly the best approach, it isn't that easy to get it right on your own
p47192
as(dp47193
g9
V17034
p47194
stp47195
a((dp47196
g2
(lp47197
VWhether a property is visible in IntelliSense is controlled by the [EditorBrowsable] attribute
p47198
aVVB
p47199
aVNET is a bit special because it hides EditorBrowsableState
p47200
aVAdvanced by default
p47201
aVNone of this would apply to an override to Button
p47202
aVAutoSize, it is always visible
p47203
aVMaybe you can give a better example, a code snippet is always good
p47204
as(dp47205
g9
V17034
p47206
stp47207
a((dp47208
g2
(lp47209
VNo, a flash file system driver is explicitly designed to minimize the wear and spread it across the memory cells
p47210
aVTaking advantage of the near-zero seek time
p47211
aVYour data rates are low, it's going to last a long time
p47212
aVSpecifying a yearly replacement of the media is a simple way to minimize the risk
p47213
as(dp47214
g9
V17034
p47215
stp47216
a((dp47217
g2
(lp47218
VExact same kind of difference as between a control's Click and MouseClick events
p47219
aVThe Click event can also be generated by the keyboard
p47220
aVFor example when the user presses the space bar when a button has the focus
p47221
aVVery similar for DataGridView, OnCellClick can be raised when the column contains a Button, CheckBox or link
p47222
aVNecessarily there is no mouse info, the cursor could be anywhere
p47223
as(dp47224
g9
V17034
p47225
stp47226
a((dp47227
g2
(lp47228
VNot sure what you're trying to do, it certainly sounds wrong
p47229
aVA VARIANT you get from a client needs to be converted to the type that you know how to deal with
p47230
aVThat's easy to do, just call the VariantToXxxx() function
p47231
aVFor example, use VariantToString() if you want to get a string
p47232
aVThere are several C++ wrapper classes already available that make this easier
p47233
aV_variant_t, CComVariant, COleVariant
p47234
aVThey all do the same thing, just different #include files
p47235
aV_variant_t is a good one because it doesn't tie you into either MFC or ATL
p47236
aVUnless you are already using them
p47237
aVTheir ChangeType() method makes the conversion
p47238
aVMemory management is automatic
p47239
as(dp47240
g9
V17034
p47241
stp47242
a((dp47243
g2
(lp47244
VThe generic problem with a question like this is that they often include a very unrealistic code snippet
p47245
aVA "what will the compiler do" question needs real code
p47246
aVSince compilers were designed and optimized to compile real code
p47247
aVMost compilers will completely eliminate the function, and the function call, since the code has no side-effects
p47248
aVLeaving us with a question that doesn't have a useful answer
p47249
aVBut, sure, you are leaning towards finding a use for the volatile keyword
p47250
aVYou can find many threads on SO talking about why volatile isn't appropriate in a multi-threaded app
p47251
as(dp47252
g9
V17034
p47253
stp47254
a((dp47255
g2
(lp47256
VNope, the designer doesn't support this
p47257
aVImportant that it works the way it does, localization through satellite assemblies wouldn't work otherwise
p47258
aVYou can do this but you have to write the code yourself
p47259
aVPretty much what you find in the Resources
p47260
aVDesigner
p47261
aVcs file
p47262
aVDo consider if this is worth the effort, it isn't very maintainable and sharing resource assemblies isn't much of an optimization
p47263
aVA terabyte disk is less than a hundred bucks
p47264
aVBtw: never edit the Resources
p47265
aVDesigner
p47266
aVcs file yourself
p47267
as(dp47268
g9
V17034
p47269
stp47270
a((dp47271
g2
(lp47272
VMake your C++ code work first
p47273
aVIt is junk as posted, you don't initialize the pointer
p47274
aVIt will crash with an AccessViolation
p47275
aVReturning pointers to structures is very hard to get right in C/C++ as well, the client of your code won't know how the memory needs to be released
p47276
aVWhich plays havoc on the P/Invoke marshaller as well, it is going to try to release the pointer with CoTaskMemFree()
p47277
aVThat's a kaboom on Vista and up, a memory leak on XP
p47278
aVAll of these problems disappear if you let the client pass a pointer to the structure as an argument:
p47279
aVWhich then in C# becomes:
p47280
as(dp47281
g9
V17034
p47282
stp47283
a((dp47284
g2
(lp47285
VCreate a
p47286
aVlnk file in the c:\u005cusers\u005cmumble\u005cappdata\u005croaming\u005cmicrosoft\u005cinternet explorer\u005cquick launch folder
p47287
aVBeware that the Quick Launch toolbar is disabled by default in Win7, I don't remember what I did to re-enable it
p47288
aVCreating the
p47289
aVlnk file takes secret sauce as well
p47290
aVYou can find sample code in my answer in this thread
p47291
as(dp47292
g9
V17034
p47293
stp47294
a((dp47295
g2
(lp47296
VJust don't work from the assumption that the optimizer ever destroys your code
p47297
aVIt's just not what it was made to do
p47298
aVIf you do observe problems then automatically consider unintentional UB
p47299
aVYes, threading can play havoc with the kind of assumptions you are used to
p47300
aVYou get no help from either the language or the compiler, although that's changing
p47301
aVWhat you do about that is not piss around with volatile, you use a good threading library
p47302
aVAnd you use one of its synchronization primitives wherever two or more threads can both touch variables
p47303
aVTrying to take short-cuts or optimizing this yourself is a one-way ticket into threading hell
p47304
as(dp47305
g9
V17034
p47306
stp47307
a((dp47308
g2
(lp47309
VJust use the same API that OpenCV uses
p47310
aVYou need the waveInXxxx() functions for recording audio
p47311
aVA good example is available here
p47312
as(dp47313
g9
V17034
p47314
stp47315
a((dp47316
g2
(lp47317
VThe vast majority of design time problems with custom controls are caused by code in the event handlers or method overrides in your control running at design time as well as run time
p47318
aVThat's normally desirable, you get instant feedback when you change a property in the Properties window for example
p47319
aVBut not desirable when the code depends on something that's available at runtime but not design time
p47320
aVLike a dbase connection or a file that's stored in the build folder
p47321
aVThat can generate exceptions and Visual Studio isn't very robust against handling exceptions at design time
p47322
aVWorst case, you can crash VS to the desktop without any diagnostic
p47323
aVBut anything is possible
p47324
aVReview the code in your control and make sure that the bits of code that should only run at runtime are wrapped like this:
p47325
aVHard cases can be diagnosed with the debugging tips in this MSDN Library article
p47326
as(dp47327
g9
V17034
p47328
stp47329
a((dp47330
g2
(lp47331
VYes, interface implementation methods are virtual as far as the runtime is concerned
p47332
aVIt is an implementation detail, it makes interfaces work
p47333
aVVirtual methods get slots in the class' v-table, each slot has a pointer to one of the virtual methods
p47334
aVCasting an object to an interface type generates a pointer to the section of the table that implements the interface methods
p47335
aVThe client code that uses the interface reference now sees the first interface method pointer at offset 0 from the interface pointer, etcetera
p47336
aVWhat I under-appreciated in my original answer is the significance of the final attribute
p47337
aVIt prevents a derived class from overriding the virtual method
p47338
aVA derived class must re-implement the interface, the implementation methods shadow the base class methods
p47339
aVWhich is enough to implement the C# language contract that says that the implementation method is not virtual
p47340
aVIf you declare the Dispose() method in the Example class as virtual, you'll see the final attribute getting removed
p47341
aVNow allowing a derived class to override it
p47342
as(dp47343
g9
V17034
p47344
stp47345
a((dp47346
g2
(lp47347
VThis is easy to do with a macro
p47348
aVStart with Tools + Macros + Record
p47349
aVDo a search, setting all the options you want, click Stop Recording
p47350
aVView + Other Windows + Macro Explorer
p47351
aVRename the "TemporaryMacro" to something more suitable
p47352
aVTools + Customize + Keyboard and assign a keystroke to the macro
p47353
aVYou now have a single keystroke to execute the search
p47354
as(dp47355
g9
V17034
p47356
stp47357
a((dp47358
g2
(lp47359
VdynamicMethod
p47360
aVCreateDelegate(eventInfo
p47361
aVEventHandlerType, this);
p47362
aVThe this argument cannot be correct
p47363
aVThat references your class, the one that generates the dynamic type
p47364
aVSurely you need targetObject instead
p47365
as(dp47366
g9
V17034
p47367
stp47368
a((dp47369
g2
(lp47370
VI think you can get somewhere with the forbidden NtQuerySystemInformation() API
p47371
aVA sample project that ab/uses this API is available here
p47372
aVLots of warning flags need to be raised with this, you're monkeying with intentionally undocumented internal kernel data structures
p47373
aVYou most definitely do not want to do what that article proposes, closing file handles involuntarily is a great way to cause random file system corruption
p47374
aVAnd you'll have a hard time keeping this kind of code compatible with future versions of Windows
p47375
aVA possibly better, but not more elegant solution is to rely on the SysInternals' Handle utility
p47376
aVIt is likely to be maintained for a while to come
p47377
aVRun this program from yours, redirecting the output
p47378
aVParsing the text is doable
p47379
as(dp47380
g9
V17034
p47381
stp47382
a((dp47383
g2
(lp47384
VI don't think that System
p47385
aVNumerics
p47386
aVdll is part of the Silverlight 4
p47387
aV0 distribution
p47388
aVBut that's not the real point
p47389
aVWhat you are looking at is a special version of the reference assembly
p47390
aVYou'll find one in  for example
p47391
aVThe assemblies there have all their IL stripped from them
p47392
aVTheir metadata is otherwise identical to the "real" reference assemblies in
p47393
aVI have no clue what the function of these stripped assemblies is supposed to be
p47394
aVI can only imagine they are meant to speed-up compilation, since the compiler only needs the metadata
p47395
aVBut that's a bit of a long shot
p47396
aVI can also imagine it has something to do with the mysterious new [TargetedPatchingOptOut] attribute, a very long shot as well since the mechanism behind it isn't explained anywhere that I could find
p47397
aVI had a conversation with JaredPar about this, he was going to ask inside MSFT about it
p47398
aVHaven't heard back
p47399
aVWell, no real answer, but it does explain what you saw
p47400
aVFollowing up on this, I do have one more theory, inspired when I noted that the folder is named "v4
p47401
aV0"
p47402
aVNote that the build number is not part of it, as it is in c:\u005cwindows\u005cmicrosoft
p47403
aVnet
p47404
aVThat ought to have interesting effects when they release new builds, similar to the updates to the base assemblies of
p47405
aVNET 2
p47406
aV0 when the service packs were released
p47407
aVInfamously, one thing that went badly wrong is that these updates had changes in the core classes, without a change to the [AssemblyVersion]
p47408
aVThe most visible one was the WaitHandle class, it acquired the WaitOne(int) overload
p47409
aVVery useful, because nobody could ever figure out what to pass for the exitContext argument
p47410
aVUsing this new overload was easy to do, targeting
p47411
aVNET 2
p47412
aV0 doesn't prevent it, but hell breaks loose if the target machine has the original
p47413
aVNET 2
p47414
aV0 RTM release installed without getting the service packs
p47415
aVMy guess: these reference assemblies are the core assemblies for any current and future version of
p47416
aVNET 4
p47417
ag2512
aVTheir public interface is frozen
p47418
aVAnd prevents you from accidentally using a public method that gets added in a later build
p47419
aVIt follows that IL isn't useful because that's going to change
p47420
as(dp47421
g9
V17034
p47422
stp47423
a((dp47424
g2
(lp47425
Vor the precompiled header is C++ and you are using it from C
p47426
aVWhich is your problem
p47427
aVNot sure how you got in this pickle, the mumble_i
p47428
aVc file is generated by MIDL and should not contain an #include "stdafx
p47429
aVh" directive
p47430
aVDon't edit the file
p47431
aVRight-click it in Solution Explorer window, Properties, C/C++, Precompiled Headers, Create/Use = "Not using Precompiled Headers"
p47432
as(dp47433
g9
V17034
p47434
stp47435
a((dp47436
g2
(lp47437
VA project property sheet is an implementation detail of the C++ IDE
p47438
aVThere is no equivalent for the C# IDE
p47439
aVMostly because there are so few knobs to tweak
p47440
aVAs compared with the C and C++ compiler and linker who have, what, over 100 options
p47441
aVThe managed code way is to use [attributes] instead
p47442
aVProject + Properties to change the C# settings
p47443
aVRejoice in the sparsity
p47444
aVActually changing any of them is quite rare, the project template takes care of them, if necessary
p47445
as(dp47446
g9
V17034
p47447
stp47448
a((dp47449
g2
(lp47450
VNo, the P/Invoke marshaller copied the unmanaged structure member values into the managed version of the structure
p47451
aVIn general, the managed version of a structure is not in any way compatible with the unmanaged version of it
p47452
aVThe memory layout is not discoverable, something the CLR uses to reorder fields to make the structure smaller
p47453
aVMarshaling is essential, you have to create a copy
p47454
aVModifying the structure is not possible with the given function signature since you let fill in the memory that's passed to it
p47455
aVThe function itself already copies the structure
p47456
aVYou can however party on the Field2 value since it is a raw pointer
p47457
aVIf that points to a structure then marshal it yourself with
p47458
aVModify the managed copy of it and copy it back to unmanaged memory with
p47459
aVOr access it directly with Marshal
p47460
aVReadXxx() and WriteXxx()
p47461
as(dp47462
g9
V17034
p47463
stp47464
a((dp47465
g2
(lp47466
VIt is allowed because not allowing it would be a lot worse
p47467
aVCode like this would deadlock badly:
p47468
aVYou are of course pointing a loaded gun at your foot
p47469
aVThis behavior is documented in the CLI Spec (Ecma 335) Partition II, Chapter 10
p47470
ag2447
ag2586
aV2 "Relaxed guarantees":
p47471
aVA type can be marked with the attribute beforefieldinit (10
p47472
ag2582
aV6) to indicate that the guarantees specified in 10
p47473
ag2447
ag2586
aV1 are not necessarily required
p47474
aVIn particular, the final requirement above need not be provided: the type initializer need not be executed before a static method is called or referenced
p47475
aV[Rationale: When code can be executed in multiple application domains it becomes particularly expensive to ensure this final guarantee
p47476
aVAt the same time, examination of large bodies of managed code have shown that this final guarantee is rarely required, since type initializers are almost always simple methods for initializing
p47477
aVstatic fields
p47478
aVLeaving it up to the CIL generator (and hence, possibly, to the programmer) to decide whether this guarantee is required therefore provides efficiency when it is desired at the cost of consistency guarantees
p47479
aVend rationale]
p47480
aVThe C# compiler indeed emits the beforefieldinit attribute on a class:
p47481
as(dp47482
g9
V17034
p47483
stp47484
a((dp47485
g2
(lp47486
VYou're right, P/Invoke cannot handle data exports from a DLL
p47487
aVIt is however technically possible by obtaining the export directly
p47488
aVThis is very ugly and you'll probably regret it some day, but this worked:
p47489
aVSample C/C++ DLL:
p47490
aVTest C# code:
p47491
as(dp47492
g9
V17034
p47493
stp47494
a((dp47495
g2
(lp47496
VI'll assume the 8 is a typo and should be 6
p47497
aVYou can never get to get this code working consistently as-is, the double type can only store 15 significant digits
p47498
aVAnything beyond is just noise
p47499
aVYou'll need to get rid of the noise digits
p47500
aVFurthermore, it is very unlikely that you get the exact same noise digits when calculating in C# vs Objective-C
p47501
aVThey use the FPU differently, leaving intermediary results in the FPU at different times
p47502
aVThose intermediaries have more significant digits
p47503
aVAn arbitrary way to filter the noise digits:
p47504
aVThe N12 format specifier makes sure that only 12 digits can appear in the fraction, chopping off the noise
p47505
aVThe 'appropriate' value of it is strongly dependent on the magnitude of the number
p47506
aVAt its core, this code snippet is flawed because it assumes that the double type doesn't have rounding issues
p47507
aVIt does
p47508
aVThe number one reason that the decimal type exists
p47509
aVAs long as you're stuck with double, it is important that you do this a different way
p47510
aVI cannot guess why you are doing this
p47511
as(dp47512
g9
V17034
p47513
stp47514
a((dp47515
g2
(lp47516
VAll these SO responses assume the worker thread will loop
p47517
aVThat doesn't sit comfortably with me
p47518
aVThere are not a lot of ways to make code take a long time
p47519
aVLooping is a pretty essential programming construct
p47520
aVMaking code take a long time without looping takes a huge amount of statements
p47521
aVHundreds of thousands
p47522
aVOr calling some other code that is doing the looping for you
p47523
aVYes, hard to make that code stop on demand
p47524
aVThat just doesn't work
p47525
as(dp47526
g9
V17034
p47527
stp47528
a((dp47529
g2
(lp47530
VThis window belongs to another process, right
p47531
aVI can see you hard-coded the window handle
p47532
aVNot so sure that message is automatically marshaled across process boundaries, only the system message are (WM_Xxx < 0x400)
p47533
aVMarshaling it yourself requires OpenProcess, VirtualAllocEx to allocate the buffer, WriteProcessMemory to intialize it, SendMessage, ReadProcessMemory to read the buffer
p47534
aVPlus cleanup
p47535
as(dp47536
g9
V17034
p47537
stp47538
a((dp47539
g2
(lp47540
VYes, there is only ever one v-table in a managed language, the CLR does not support multiple inheritance
p47541
aVThere is a pointer fixup when you cast to an implemented interface
p47542
aVThis is a notable problem when trying to declare a COM interface that is itself declared from another interface beyond IUnknown
p47543
aVAn issue not quite understood by this article's author
p47544
aVCOM requires a separate v-table for each interface, just what a compiler that supports MI does
p47545
as(dp47546
g9
V17034
p47547
stp47548
a((dp47549
g2
(lp47550
VTo get the exception, add this statement to the deserialization code:
p47551
as(dp47552
g9
V17034
p47553
stp47554
a((dp47555
g2
(lp47556
VNot possible
p47557
aVThe CLR keeps an internal status bit that tracks whether the type initializer was started
p47558
aVIt cannot run again
p47559
aVThat status bit is indeed stored in the loader heap as part of the AppDomain state
p47560
aVThe workaround is simple, just add a static method to the class
p47561
as(dp47562
g9
V17034
p47563
stp47564
a((dp47565
g2
(lp47566
VIt depends on what kind of DLL it is
p47567
aVIf it is a COM server then Copy Local is off when you have a PIA registered for that COM server
p47568
aVIf it is a regular
p47569
aVNET assembly then it will be off when it is registered in the GAC
p47570
aVFix the issue by, respectively, using regasm /u to unregister the PIA or gacutil /u to remove it from the GAC
p47571
aVDo note that you might not want to do this if this DLL requires that its installer is executed on the target machine
p47572
aVWhich is likely
p47573
aVTalk to the component vendor or author to find out what you should do
p47574
as(dp47575
g9
V17034
p47576
stp47577
a((dp47578
g2
(lp47579
VThis is, in general, not possible
p47580
aVCOM takes care of the threading requirements for a COM server
p47581
aVWhich it advertises in the registry
p47582
aVHave a look-see with Regedit
p47583
aVexe and locate the HKCR\u005cCLSID{guid} key for the coclass that you use
p47584
aVThe ThreadingModel key says what is required
p47585
aVIf it is missing or set to Apartment then the server says that it needs to be created on an STA thread and its interface methods must be called from that same thread
p47586
aVIf you call a method from another thread then the call gets marshaled to the STA thread
p47587
aVThat's safe but it is slow and you don't have any concurrency
p47588
aVIf it is set to Both then the call is still marshaled when the COM object was created on an STA thread
p47589
aVBut not when it was created on an MTA thread
p47590
aVOnly Free allows free threading
p47591
aVWhich is very rare, the vast majority of COM components are apartment threaded and don't have the internal protection that's required to make calls from a worker thread
p47592
aVThere's typically only one STA thread in a program, the startup thread
p47593
aVIt must pump a message loop, a hard requirement for STA
p47594
aVIf you don't have one, COM will create an STA thread for you to find a good home for the server
p47595
aVAll calls will be marshaled then
p47596
aVNot good news, I'm sure, there's no free lunch in threading
p47597
as(dp47598
g9
V17034
p47599
stp47600
a((dp47601
g2
(lp47602
VSorted by efficiency:
p47603
aVCounting your AppendLine() calls
p47604
aVCalling IndexOf() in a loop
p47605
aVUsing Regex
p47606
aVUsing String
p47607
aVSplit()
p47608
aVThe last one is extraordinary expensive and generates lots of garbage, don't use
p47609
as(dp47610
g9
V17034
p47611
stp47612
a((dp47613
g2
(lp47614
VIt is quite explicit in the SDK docs for the message:
p47615
aVButtons with the BS_PUSHBUTTON,
p47616
aVBS_DEFPUSHBUTTON, or BS_PUSHLIKE
p47617
aVstyles do not use the returned brush
p47618
aVButtons with these styles are always
p47619
aVdrawn with the default system colors
p47620
aVDrawing push buttons requires several
p47621
aVdifferent brushes-face, highlight, and
p47622
aVshadow-but the WM_CTLCOLORBTN message
p47623
aVallows only one brush to be returned
p47624
aVTo provide a custom appearance for
p47625
aVpush buttons, use an owner-drawn
p47626
aVbutton
p47627
aVMost Windows programs nowadays use the visual style selected by the user
p47628
aVRecommended, add the required manifest
p47629
as(dp47630
g9
V17034
p47631
stp47632
a((dp47633
g2
(lp47634
VIt is because you use the TEXT macro
p47635
aVThat automatically puts an L before a string literal if you compile with _UNICODE defined
p47636
aVThat blows up because you use sprintf(), a non-Unicode function
p47637
aVIt wants a char*, not a wchar_t*
p47638
aVThere are three basic solutions here:
p47639
aVRemove the TEXT macro
p47640
aVUse TCHAR and the corresponding string functions consistently
p47641
aVUse Unicode declarations in your code, wchar_t[] and swprintf()
p47642
aVNo real point in 2, there is no mainstream operating system left that isn't native Unicode
p47643
as(dp47644
g9
V17034
p47645
stp47646
a((dp47647
g2
(lp47648
VWell, it's a rock and a hard place
p47649
aVAn atomic increment is a heavy duty platform implementation detail
p47650
aVThat's why the LONG typedef exists in the first place
p47651
aVSome future operating system 20 or 50 years from now might redefine that type
p47652
aVWhen, say, 256 bit cores are common and atomic increments work differently
p47653
aVWho knows
p47654
aVIf you want to write truly portable code then you should use truly portable types
p47655
aVLike LONG
p47656
aVAnd it will be Microsoft's burden to make it work, instead of yours
p47657
aVIt's going to be a 32-bit integer for quite a while to come, I'd recommend you don't worry about it
p47658
as(dp47659
g9
V17034
p47660
stp47661
a((dp47662
g2
(lp47663
VYou are disabling the file system cache with that flag
p47664
aVYes, that makes an enormous difference, it forces the OS to work with the disk driver and read sectors directly
p47665
aVCylinders cannot be read and cached, disabling the optimization that makes reading tracks without having to move the read head so cheap
p47666
aVAnd lazy write-back is disabled, an optimization that makes disk writes appear instantaneous
p47667
as(dp47668
g9
V17034
p47669
stp47670
a((dp47671
g2
(lp47672
VYour machine never executes IL, it is always translated to machine code
p47673
aVThe job of the JIT compiler
p47674
aVThe Disassembly window shows you the result of that translation
p47675
aVAs long as you do this with the Debug build then you can see a reasonable match between the IL and the machine code
p47676
aVThat disappears however when the JIT optimizer is enabled, it makes a lot of optimizations that make the machine code as fast as reasonably possible
p47677
aVTypical is that entire methods disappear (called inlining), local variables disappear (replaced by CPU registers) and code gets re-organized
p47678
aVAny introductory book about the x86 assembly language will help you interpret the machine code
p47679
as(dp47680
g9
V17034
p47681
stp47682
a((dp47683
g2
(lp47684
VThere are just very few real-life cases where that matters at all
p47685
aVYou only ever serialize to make your objects compatible with some kind of external resource
p47686
aVDisk, network, etcetera
p47687
aVThe code that transmits the serialized data on the resource is always orders of magnitude slower then the code needed to serialize the object
p47688
aVIf you make the serialization code twice as fast, you've made the overall operation no more than 0
p47689
aV5% faster, give or take
p47690
aVThat is worth neither the risk nor the effort
p47691
aVMeasure three times, cut once
p47692
as(dp47693
g9
V17034
p47694
stp47695
a((dp47696
g2
(lp47697
VNo
p47698
aVThe Load event runs right after the Handle is created
p47699
aVIt is possible for the constructor to use a property of a control that requires the physical window to be created
p47700
aVThat automatically triggers the CreateHandle() method, Load is next
p47701
aVThis is rare and usually a mistake
p47702
aVIt tends to come to a good end, depending on what is being done in the event handler
p47703
aVWhich ought to only ever do the kind of things that require the window
p47704
aVThat's not common, anything else belongs in the constructor
p47705
aVThe constructor however hasn't finished yet so you are working with a partially initialized object
p47706
aVAccidents are possible
p47707
as(dp47708
g9
V17034
p47709
stp47710
a((dp47711
g2
(lp47712
VWhich requires moving the bytes starting at the end
p47713
aVMemcpy() makes a mess of it
p47714
as(dp47715
g9
V17034
p47716
stp47717
a((dp47718
g2
(lp47719
VYes, the pen width gets scaled as well
p47720
aVCreate a pen with a Width = 0
p47721
aVThat will always be one pixel wide, regardless of the ScaleTransform
p47722
as(dp47723
g9
V17034
p47724
stp47725
a((dp47726
g2
(lp47727
VWell, that just doesn't work
p47728
aVIt creates a new form, one that isn't visible because Show() wasn't called
p47729
aVYou'll need a reference to the existing form, this in the MainForm's code
p47730
aVYou can pass it to the worker class by calling its constructor, passing the reference
p47731
aVThat is however a Bad Idea
p47732
aVIt makes your worker class dependent on the user interface
p47733
aVChanging the GUI, happens often because it is, well, so visible, will break your worker class
p47734
aVYou solve that problem by using events
p47735
aVLet the worker class raise the event when something worthwhile happens
p47736
aVSo that the form can then obtain the information from the class object and update the UI accordingly
p47737
aVAlso look into the MVC pattern to get some ideas
p47738
as(dp47739
g9
V17034
p47740
stp47741
a((dp47742
g2
(lp47743
VYou need a lexer
p47744
as(dp47745
g9
V17034
p47746
stp47747
a((dp47748
g2
(lp47749
VThere's no magic available here
p47750
aVJust as you wrap the interface types from the COM component with equivalent
p47751
aVNET types, so you have to wrap other declarations from the type library
p47752
aVIf you don't want to expose the COM enum types then you have to wrap them
p47753
aVWith a
p47754
aVNET enum type declaration
p47755
aVThe code is simple by casting through int, but it is a maintenance item
p47756
aVJust like the
p47757
aVNET class wrappers are
p47758
aVMake sure there's an actual value-add from wrapping the COM types, a one-to-one mapping is rarely useful
p47759
aVUnless this is training wheels for an eventual replacement of the COM server
p47760
aVWhich is a-okay, it gives you a good feel for what's needed
p47761
aVIn which case you really do want to declare the enum
p47762
as(dp47763
g9
V17034
p47764
stp47765
a((dp47766
g2
(lp47767
VCongratulations, you've found a bug in the
p47768
aVNET framework
p47769
aVIt is induced by the byte value, 0xef in hex
p47770
aVWhich is the first byte of the UTF-8 BOM
p47771
aVIt is not a complete BOM of course, the next two bytes are missing
p47772
aVIt is however enough to fatally confuse StreamReader, it keeps trying to read data from the stream without ever getting anywhere, consuming memory while trying
p47773
aVOOM is, eventually, next
p47774
aVThis bug is present in
p47775
aVNET 4
p47776
aV0 as well
p47777
aVThe exact source of the bug is hard to trace, the code that's involved is not included in the Reference Source
p47778
aVIt could possibly be classified as a critical one since it could be used in a DOS attack
p47779
aVYou can report the bug at connect
p47780
aVmicrosoft
p47781
aVcom
p47782
aVLet me know if you don't want to, I'll report it (MVP duty)
p47783
as(dp47784
g9
V17034
p47785
stp47786
a((dp47787
g2
(lp47788
VImage
p47789
aVRawFormat has cooties, stay away from it
p47790
aVI've seen several reports of it having no legal value for no apparent reason
p47791
aVUndiagnosed as yet
p47792
aVYou are quite right, it doesn't matter what format you save it to
p47793
aVAfter you loaded the file, the internal format is the same for any bitmap (not vector) with the same pixel format
p47794
aVGenerally avoid recompressing jpeg files, they tend to get bigger and acquire more artifacts
p47795
aVSteve mentions multi-frame files, they need to be saved a different way
p47796
as(dp47797
g9
V17034
p47798
stp47799
a((dp47800
g2
(lp47801
VYou can draw this style of progress bar with DrawThemeBackground()
p47802
aVYou'll find the theme name, part and state numbers in my answer in this thread
p47803
as(dp47804
g9
V17034
p47805
stp47806
a((dp47807
g2
(lp47808
VIt will return c:\u005cwindows\u005csystem32, even in a 32-bit program that runs on the 64-bit version of Windows
p47809
aVDo not fix this, it doesn't need fixing
p47810
aVBecause when you use that path, Windows will automatically remap it to c:\u005cwindows\u005csyswow64
p47811
aVThe file system redirector takes care of it
p47812
as(dp47813
g9
V17034
p47814
stp47815
a((dp47816
g2
(lp47817
VSystem
p47818
aVTimers
p47819
aVTimer is a horrible class
p47820
aVThere is no good way to stop it reliably, there is always a race and you can't avoid it
p47821
aVThe problem is that its Elapsed event gets raised from a threadpool thread
p47822
aVYou cannot predict when that thread actually starts running
p47823
aVWhen you call the Stop() method, that thread may well have already been added to the thread pool but didn't get around to running yet
p47824
aVIt is subject to both the Windows thread scheduler and the threadpool scheduler
p47825
aVYou can't even reliably solve it by arbitrarily delaying the closing of the window
p47826
aVThe threadpool scheduler can delay the running of a thread by up to 125 seconds in the most extreme cases
p47827
aVYou'll reduce the likelihood of an exception by delaying the close by a couple of seconds, it won't be zero
p47828
aVDelaying the close for 2 minutes isn't realistic
p47829
aVJust don't use it
p47830
aVEither use System
p47831
aVThreading
p47832
aVTimer and make it a one-shot timer that you restart in the event handler
p47833
aVOr use a System
p47834
aVWindows
p47835
aVForms
p47836
aVTimer, it is synchronous
p47837
aVA WF Timer should be your choice here because you use Control
p47838
aVInvoke()
p47839
aVThe delegate target won't start running until your UI thread goes idle
p47840
aVThe exact same behavior you'll get from a WF timer
p47841
as(dp47842
g9
V17034
p47843
stp47844
a((dp47845
g2
(lp47846
VHere's a copy of a table in the CLI specification (Ecma 335) that specifies which operands are valid on the binary numeric operators of the type A op B, where A and B are the operands and "op" is the operator, like Opcodes
p47847
aVSub that you are using in your snippet:
p47848
aVSome annotations are required with this:
p47849
aVnative int" is IntPtr in a C# program
p47850
aVF represents a floating point type, double or float in C#
p47851
aV& represents a pointer value, the boxes are shaded because they are unsafe operations
p47852
aVO represents an object reference
p47853
aVx is an operation that's not permitted
p47854
aVNote the row and column for F, both operands must be floating point, you cannot directly add, say, an int to a double
p47855
aVThe C# compiler deals with that limitation by automatically converting the int operand to double so that the operator is valid
p47856
aVRelevant to your question: also note that the byte, sbyte, char, short and ushort types are not present
p47857
aVSame approach, the compiler converts the operands to the smallest type that can represent the value so that the operator can be used
p47858
aVWhich will be int32
p47859
aVAccording to the table, the result of the operation will be int32
p47860
aVNow here's the rub: the result is int32 but assigning that back to a byte value requires a narrowing conversion
p47861
aVFrom 32 bits to 8 bits
p47862
aVThat's trouble because it loses significant bits
p47863
aVThe C# compiler requires you to make that explicit
p47864
aVYou essentially acknowledge that you know what you're doing and that you are aware of the potentially surprising result
p47865
aVLike this one:
p47866
aVThe -= operator is a problem because there is no effective way to apply that required cast
p47867
aVIt isn't expressible in the language syntax
p47868
aVUsing (byte)3 doesn't make sense, the literal gets converted to int32 anyway to make the operator work
p47869
aVThey punted the problem, the compiler automatically emits the cast without your help
p47870
as(dp47871
g9
V17034
p47872
stp47873
a((dp47874
g2
(lp47875
VWebBrowser is a COM component under the hood, Internet Explorer
p47876
aVLike many COM components, it requires a 'single threaded apartment'
p47877
aVYou have to create one to make it a hospitable home for the component
p47878
aVBasically two essential requirements: the thread needs to be initialized as an STA and it needs to pump a message loop
p47879
aVHere's one that uses the plumbing provided by Windows Forms:
p47880
aVBeware that the DocumentCompleted event gets raised on that worker thread
p47881
aVI arbitrarily used that event to also make the thread terminate
p47882
as(dp47883
g9
V17034
p47884
stp47885
a((dp47886
g2
(lp47887
VThis is one of the horrors induced by VB
p47888
aVNET's support for using the type name of a form to refer to the instance of the form
p47889
aVIt is an anachronism carried over from VB6 where using the type name of a form was normal
p47890
aVThis falls apart when you use threads because "FormMain" has thread affinity
p47891
aVIn other words, it has the  attribute
p47892
aVWhen you use it in a worker thread then you get a new instance of the form, not the one that the user is looking at
p47893
aVThis new instance isn't visible because its Show() method was never called
p47894
aVWhich is why you don't see your code having any effect
p47895
aVIf you call Show() in your code then you'll see it pop up
p47896
aVIt is however quite dead, the thread isn't pumping a message loop
p47897
aVAnother effect you should have noticed was that InvokeRequired is False, you know that can't be right
p47898
aVYou will have to stop using FormMain
p47899
aVIf this code lives inside that class then you can simply use Me
p47900
aVIf it doesn't then you'll have to pass the form reference with a property or a constructor argument
p47901
aVThe Q&D; fix is to use Application
p47902
aVOpenForms(0)
p47903
as(dp47904
g9
V17034
p47905
stp47906
a((dp47907
g2
(lp47908
VYou are going to have to be more flexible if you want a solution
p47909
aVThe only odds you'll have for a 'perfect' solution is SHAppBarMessage with ABM_REMOVE
p47910
aVThe odds aren't good, especially on Win7
p47911
aVI don't want to try this myself, I like my taskbar :)
p47912
as(dp47913
g9
V17034
p47914
stp47915
a((dp47916
g2
(lp47917
VUse the System
p47918
aVSpeech
p47919
aVRecognition namespace
p47920
aVThere's little point in battling the SAPI COM interfaces yourself, the SpeechRecognizer class lets you do anything you can do in SAPI
p47921
aVPoint your browser to the MSDN Library topics for that namespace, you'll find plenty of examples
p47922
as(dp47923
g9
V17034
p47924
stp47925
a((dp47926
g2
(lp47927
VYou need to work on your google skills
p47928
aVSecond hit on this google query, the first one is a commercial solution
p47929
as(dp47930
g9
V17034
p47931
stp47932
a((dp47933
g2
(lp47934
VYes, there's more than 1 resource in MyNameSpace
p47935
aVResources
p47936
aVresource
p47937
aVWhich is the name you have to pass to ResourceManager, an empty string isn't going to work
p47938
aVTo see the kind of code you have to write, start a Windows Forms application and add a couple of resources to the Project + Properties, Resources tab
p47939
aVIn the Solution Explorer, click the "Show All Files" icon
p47940
aVOpen the My Project node, open the Resources
p47941
aVresx node and double-click the Resources
p47942
aVDesigner
p47943
aVvb file
p47944
aVNote the code for the ResourceManager property
p47945
as(dp47946
g9
V17034
p47947
stp47948
a((dp47949
g2
(lp47950
VIt is equivalent to "static class" in the C# language
p47951
aVThe language that was used to write almost all of the BCL classes
p47952
aVAll the methods must be static
p47953
aVDeclaring it abstract and sealed prevents anybody from deriving from the class and creating an instance of it
p47954
aVThe class methods are the exact equivalent of free functions in the C and C++ language
p47955
aVSomething the CLR does not support
p47956
as(dp47957
g9
V17034
p47958
stp47959
a((dp47960
g2
(lp47961
VThat's a fake annotation, representing the this pointer that gets passed to a class method
p47962
aVYou don't actually declare it in neither C++ nor C#, it gets passed without writing it out explicitly
p47963
aVBut do note the difference between the server and the client
p47964
aVIn the server, you use the this keyword to recover that pointer
p47965
aVIn the client, you have the object reference
p47966
aVFor example:
p47967
aVThe app and doc variables are the object references you are looking for
p47968
aVThe value of this inside Word's implementation of the Application and Document interfaces
p47969
aVIgnoring the intricacies of RCWs for a moment
p47970
as(dp47971
g9
V17034
p47972
stp47973
a((dp47974
g2
(lp47975
VYou forgot this one:
p47976
aVWhat you'll have to work on next is putting the taskbar at, say, the left side of the screen and running the code on a machine that has the video DPI setting at a different value (like 125)
p47977
aVYou can only position the form accurately in its Load event
p47978
aVDon't set the client size
p47979
as(dp47980
g9
V17034
p47981
stp47982
a((dp47983
g2
(lp47984
VYou do the exact same thing you do when:
p47985
aVyou created 10,000 windows
p47986
aVyou allocated 10,000 handles
p47987
aVyou created 2,000 threads
p47988
aVyou exceeded your quota of kernel pool memory
p47989
aVyou filled up the hard disk to capacity
p47990
aVYou send your customer a very humble message where you apologize for writing such crappy code and promise a delivery date for the bug fix
p47991
aVAny else is not nearly good enough
p47992
aVHow you want to be notified about it is up to you
p47993
as(dp47994
g9
V17034
p47995
stp47996
a((dp47997
g2
(lp47998
VYou get it from GetMonitorInfo(), MONITORINFOEX
p47999
aVrcWork
p48000
aVGet the HMONITOR from, say, MonitorFromRect(), passing your window rectangle
p48001
aVOr MonitorFromPoint() or EnumDisplayMonitors(), depends where you want to display your window
p48002
aV(0,0) is always the upper left corner of the primary monitor
p48003
as(dp48004
g9
V17034
p48005
stp48006
a((dp48007
g2
(lp48008
VSet a breakpoint on CreateFile()
p48009
aVWrite one in main() so you can easily trace into it an find the API entrypoint
p48010
aVSwitch to disassembly view before single-stepping
p48011
as(dp48012
g9
V17034
p48013
stp48014
a((dp48015
g2
(lp48016
VUsing Option Strict On would have helped you quickly find the problem
p48017
aVYour syntax for the Case statements is wrong, those expressions evaluate to Boolean
p48018
aVscore will rarely be equal to True or False, you only get a value if score equals 0 or 1
p48019
aVYou need to write it like this:
p48020
aVUse Option Strict On while you learn to program in VB
p48021
aVNET
p48022
aVYou can turn it off again when you've become a master
p48023
as(dp48024
g9
V17034
p48025
stp48026
a((dp48027
g2
(lp48028
VIt is a simple measure: the fewer declarations you have in the
p48029
aVh file, the more modular it is
p48030
aVGrouping by functionality is important
p48031
aVHaving extern declarations is very bad, give those an extra 'penalty'
p48032
as(dp48033
g9
V17034
p48034
stp48035
a((dp48036
g2
(lp48037
VIt uses the IEqualityComparer<> that you passed to the HashSet constructor
p48038
aVIf you didn't pass one then it uses EqualityComparer<>
p48039
aVDefault
p48040
aVWhich, if the element type doesn't implement IEquatable<> uses the Equals and GetHashCode methods of the type
p48041
aVI would guess that your list contains objects that don't override these methods
p48042
aVUse the IEqualityComparer constructor argument to fix
p48043
as(dp48044
g9
V17034
p48045
stp48046
a((dp48047
g2
(lp48048
VThere are lots of versions of VBA, integrated in various application
p48049
aVGoing by the version number, I'm guessing you need to use Project + Add Reference, Browse tab, select c:\u005cwindows\u005csystem32\u005cmsvbvm60
p48050
aVdll
p48051
aVThat's the runtime support module for VB6
p48052
aVIt indeed has a Collection class in the VBA namespace
p48053
aVDo try to double-check if the component was written in VB6
p48054
aVDeployment could be interesting
p48055
as(dp48056
g9
V17034
p48057
stp48058
a((dp48059
g2
(lp48060
VThis ought to do it with just plain
p48061
aVNET classes:
p48062
as(dp48063
g9
V17034
p48064
stp48065
a((dp48066
g2
(lp48067
Vcompletely local, it doesn't access servers
p48068
aVIt does, it accesses a SQL Server Express server
p48069
aVYou'll have to deploy that as well
p48070
aVYou could include the bootstrapper for it in your Setup project
p48071
aVOr just download it from Microsoft
p48072
as(dp48073
g9
V17034
p48074
stp48075
a((dp48076
g2
(lp48077
VThe CLR is not involved at all here, this should all be translated to straight machine code without calls into the CLR
p48078
aVThe JIT compiler is responsible for generating that machine code, it has an optimizer that tries to come up with the most efficient code
p48079
aVIt has limitations, it cannot spend a large amount of time on it
p48080
aVOne of the important things it does is figuring out what local variables should be stored in the CPU registers
p48081
aVThat's something that changed when you put the Height property in a local variable
p48082
aVIt possibly decided to store that variable in a register
p48083
aVBut now there's one less available to store another variable
p48084
aVLike the x or y variable, one that's critical for speed
p48085
aVYes, that will slow it down
p48086
aVYou got a bad diagnostic about the outer loop
p48087
aVThat could possibly be caused by the JIT optimizer re-arranging the loop code, giving the profiler a harder time mapping the machine code back to the corresponding C# statement
p48088
aVSimilarly, the optimizer might have decided that you were using the array inefficiently and switched the indexing order back
p48089
aVNot so sure it actually does that, but not impossible
p48090
aVAnyhoo, the only way you can get some insight here is by looking at the generated machine code
p48091
aVThere are many decent books about x86 assembly code, although they might be a bit hard to find these days
p48092
aVYour starting point is Debug + Windows + Disassembly
p48093
aVKeep in mind however that even the machine code is not a very good predictor of how efficient code is going to run
p48094
aVModern CPU cores are enormously complicated and the machine code is no longer representative for what actually happens inside the core
p48095
aVThe only tried and true way is what you've already been doing: trial and error
p48096
as(dp48097
g9
V17034
p48098
stp48099
a((dp48100
g2
(lp48101
VIt is a convention of the C language, you pass an array by passing a pointer to the first element of the array
p48102
aVSo a double[] is already marshaled as a
p48103
aVWhen you use the out or ref keyword, you tell the marshaller that the function returns a pointer to a new array, a
p48104
aVThe function does not create a new array, it requires the client to pass an array that's large enough to receive the result
p48105
aVTherefore, neither the out nor the ref annotation is correct
p48106
aVThe serr argument should be declared as StringBuilder btw
p48107
aVThe function is very dangerous since there is no way for the client to say how large an array it created
p48108
aVParticularly a problem with the serr argument
p48109
aVA detailed error message is prone to overrun the end of the array and that will destroy the garbage collected heap
p48110
aVNothing you can do but pass a very large array (i
p48111
ag9581
aVStringBuilder with a large Capacity) and keep your fingers crossed
p48112
aVBuffer overruns are the preferred attack vector for malware authors
p48113
aVNot likely to be abused in a managed program, it will just crash the app with FEEE
p48114
as(dp48115
g9
V17034
p48116
stp48117
a((dp48118
g2
(lp48119
VYou cannot realistically implement your own TextBox, writing your own text editor is punishing
p48120
aVUse something off the shelf, like ScintillaNET
p48121
aVWriting your own scrollable Label is somewhat do-able
p48122
aVStart with a double-buffered Panel, use OnPaint to draw the text
p48123
aVIt is only ever going to be an improvement if you don't implement word wrap, that makes it very expensive to figure out where to start drawing since you have to wrap all the text before the scrolled first visible line
p48124
aVCalculating the AutoScrollMinSize is expensive since you have to scan the entire text to count the line breaks, make sure you don't have to update the Text too often
p48125
aVIn general, the odds are good that you'll merely find out why TextBox is as slow as it is
p48126
aVYou keep it performant by limiting the amount of text to what a human can reasonably be expected to ever want to read through
p48127
aVWhich isn't much
p48128
aVI do it by keeping track of the length of the Text for each append and throwing half of it away when it goes past 65536 characters
p48129
aVA nice round number
p48130
as(dp48131
g9
V17034
p48132
stp48133
a((dp48134
g2
(lp48135
VYou are linking in some code that is still compiled with /MD, possibly some kind of static library
p48136
aVMixing and matching doesn't work
p48137
aVUsing /MT when you use DLLs is very dangerous
p48138
aVYou'll get in trouble when the exported functions return a pointer or a C++ object that needs to be released by the client code
p48139
aVReturning an std::string for example
p48140
aVWith /MT, the client will use its own heap allocator to release the memory
p48141
aVCannot work, the DLL used another heap
p48142
aVYou'll leak, very hard to diagnose
p48143
aVUsing 3rd party DLLs that were built with a different version of the CRT is a problem for the same reason
p48144
aVThere's more details in this MSDN Library article
p48145
aVDeploying the required CRT DLLs is pretty simple with this download
p48146
as(dp48147
g9
V17034
p48148
stp48149
a((dp48150
g2
(lp48151
VIt is very unlikely to be the shovel-ware on your machine
p48152
aVThese DLLs need to inject themselves also into non-managed programs, they have to be written in a language that doesn't depend on the CLR, like C or C++
p48153
aVAnd accordingly cannot generate managed exceptions
p48154
aVThese exceptions look like machine configuration problems to me
p48155
aVJunk in your registry
p48156
aVThe bad culture name (sounds like "us" got corrupted to "ug") generates three of them, the font is probably listed in the registry but missing from the disk
p48157
aVShort from a OS reinstall, you could possibly diagnose this by using both ProcMon and the debugger
p48158
aVUse Debug + Exceptions, Thrown checkbox to force the debugger to stop on the first-chance exception
p48159
aVWhen it hits, switch to ProcMon, the registry key or file should be visible very near the end of the trace
p48160
as(dp48161
g9
V17034
p48162
stp48163
a((dp48164
g2
(lp48165
VWell, it is possible but quite awkward
p48166
aVThe problem is that the MethodBody class only lets you retrieve the IL as an array of bytes
p48167
aVThe ILGenerator
p48168
aVEmit() method however does not have an overload to just copy those bytes into the dynamic method
p48169
aVIt requires you to use the proper overload to generate the proper IL instruction
p48170
aVThat's important not just to ensure that you always generate correct IL, it is also used to collect info about the dynamic method
p48171
aVSpecifically the stack size that's required for the method
p48172
aVThe only way to be able to use ILGenerator
p48173
aVEmit() is to write code that decompiles the bytes first into their corresponding IL instructions
p48174
aVThat's not impossible, just a lot of work
p48175
aVI can't think of a short-cut
p48176
as(dp48177
g9
V17034
p48178
stp48179
a((dp48180
g2
(lp48181
VThread pool threads are background threads
p48182
aVFinish that sentence with "they have their IsBackground property initialized to True, unlike threads created with the Thread class
p48183
aVSetting it to false could be a bit risky
p48184
aVThreadpool threads are recycled, I'm not so sure that the property will be re-initialized
p48185
aVIt is not a property associated with the physical operating system thread, they don't have IsBackground behavior, it is added by the wrapper that the CLR puts around it
p48186
aVSo probably yes
p48187
aVLittle reason to mess with it though
p48188
as(dp48189
g9
V17034
p48190
stp48191
a((dp48192
g2
(lp48193
VThis isn't covered by the Winapi, you need WMI (Windows Management Instrumentation)
p48194
aVTo get started on the kind of queries you can run, experiment with the WMI Code Creator tool
p48195
aVIt can auto-generate the code you need
p48196
aVNot in C, you'll find that quite an awkward language for WMI
p48197
as(dp48198
g9
V17034
p48199
stp48200
a((dp48201
g2
(lp48202
VThe debugging info in the
p48203
aVpdb, probably
p48204
aVIt just needs to iterate the CLSIDs defined in the mumble_i
p48205
aVc file generated by MIDL
p48206
aVNo problem matching them, they are after all globally unique :)
p48207
as(dp48208
g9
V17034
p48209
stp48210
a((dp48211
g2
(lp48212
VDon't look at a thread you didn't start, that one can't freeze the window updates
p48213
aVLook at your main thread, find out what it is blocking on
p48214
aVIf that doesn't help, post the actual stack trace of that thread in your question instead of describing it
p48215
as(dp48216
g9
V17034
p48217
stp48218
a((dp48219
g2
(lp48220
VYou'll have to trust the compiler on this, it is convinced that DerivedClass1 does not inherit BaseClass
p48221
aVIt doesn't get that wrong
p48222
aVThat's either because it didn't see the Inherits clause in the DerivedClass1 declaration or because it picked a BaseClass definition from another assembly
p48223
aVTo fix the former problem, you have no alternative but to declare the ActiveItem as Object or to find another type that these classes have in common
p48224
aVUse the Object Browser
p48225
aVTo fix the latter problem you'll have to change the Imports directive or spell out the full name of the BaseClass type (including namespace)
p48226
as(dp48227
g9
V17034
p48228
stp48229
a((dp48230
g2
(lp48231
VYes, it is smart enough
p48232
aVBut what has made no progress at all in the past 40 years is the way C programs are built
p48233
aVIt is still one source code file at a time
p48234
aVSo to get a function inlined in more then one
p48235
aVc file you put the function definition in the
p48236
aVh file
p48237
aVAnd if you don't mark them inline, the linker will complain about the multiple definitions
p48238
as(dp48239
g9
V17034
p48240
stp48241
a((dp48242
g2
(lp48243
VYou can see what's happening if you replace the MessageBox
p48244
aVShow call by Debugger
p48245
aVBreak and attach a debugger with native debugging enabled when the break hits
p48246
aVThe call stack looks like this:
p48247
aVThe relevant function is CoWaitForMultipleHandles
p48248
aVIt ensures that the STA thread cannot block on a sync object without still pumping messages
p48249
aVWhich is very unhealthy since it is so likely to cause deadlock
p48250
aVEspecially in the case of NotifyIcon since blocking the notification message would hang the tray window, making all icons inoperative
p48251
aVWhat you see next is the COM modal loop, infamous for causing re-entrancy problems
p48252
aVNote how it calls PeekMessage(), that's how the MouseClick event handler gets activated again
p48253
aVWhat's pretty stunning about this call stack is that there's no evidence of the lock statement transitioning into code that calls CoWaitForMultipleHandles
p48254
aVIt is somehow done by Windows itself, I'm fairly sure that the CLR doesn't have any provisions for it
p48255
aVAt least not in the SSCLI20 version
p48256
aVIt suggests that Windows actually has some built-in knowledge of how the CLR implements the Monitor class
p48257
aVPretty awesome stuff, no clue how they could make that work
p48258
aVI suspect it patches DLL entrypoint addresses to revector the code
p48259
aVAnyhoo, these special counter-measures are only in effect while the NotifyIcon notification runs
p48260
aVA workaround is to delay the action of the event handler until the callback is completed
p48261
aVLike this:
p48262
aVProblem solved
p48263
as(dp48264
g9
V17034
p48265
stp48266
a((dp48267
g2
(lp48268
VThere are several
p48269
aVStarting with the Dock and Anchor properties of a control, good for simple layouts with no more than, say, 3 controls across
p48270
aVThen the TableLayoutPanel and FlowLayoutPanel controls, they automatically arrange the controls inside of them
p48271
aVRespectively in a grid and a flow layout
p48272
aVFor the really tough layout cases you could implement the form's Resize event and calculate Location and Size properties yourself
p48273
aVThat's rarely necessary
p48274
as(dp48275
g9
V17034
p48276
stp48277
a((dp48278
g2
(lp48279
VYou can attach the console
p48280
aVMake the code in Program
p48281
aVcs look like this:
p48282
as(dp48283
g9
V17034
p48284
stp48285
a((dp48286
g2
(lp48287
VYou can't, it is an abstract class
p48288
aVThe only visible concrete implementation of it is SafeMemoryMappedViewHandle, a helper class for the classes in the System
p48289
aVIO
p48290
aVMemoryMappedFiles namespace
p48291
aVIt has a non-accessible constructor since it can only be properly initialized by the plumbing that makes memory mapped files work
p48292
aVThe use case is an IntPtr that maps to unmanaged memory, managed by a handle
p48293
aVFairly rare in the Windows API, MapViewOfFile or GlobalAllocPtr for example
p48294
aVIf you want to create your own then you have to derive from SafeBuffer so you can call its constructor and call, say, AcquirePointer
p48295
aVMost of this is unsafe
p48296
aVWhat are you really trying to do
p48297
as(dp48298
g9
V17034
p48299
stp48300
a((dp48301
g2
(lp48302
VNope
p48303
aVThe debugger doesn't have enough information about the exact way the JIT compiler generated the code to return the value
p48304
aVIt is a heavy duty implementation detail of the jitter and the specific architecture it generates code for
p48305
aVSimple types like objects and integral types are not much of a problem, usually the EAX/RAX register, FPU stack or XMM0 register
p48306
aVIt gets convoluted when the method returns a struct
p48307
aVThat gets mapped to registers it the struct fits, but needs to spill over in a temporary stack buffer when the struct is too large
p48308
aVI suspect they'll need to do a lot of work on the metadata that the jitter generates to get that working
p48309
aVYou'll know when that work is complete, it will become visible in the Autos window
p48310
aVLike it used to be, back in the simple days
p48311
as(dp48312
g9
V17034
p48313
stp48314
a((dp48315
g2
(lp48316
VThat's not possible on current mainstream hardware
p48317
aVMemory buffers are restricted to 2 gigabytes, even on 64-bit machines
p48318
aVIndexed addressing of the buffer is still done with a 32-bit signed offset
p48319
aVIt is technically possible to generate machine code that can index more, using a register to store the offset, but that's expensive and slows down all array indexing, even for the ones that aren't larger than 2 GB
p48320
aVFurthermore, you can't get a buffer larger than about 650MB out of the address space available to a 32-bit process
p48321
aVThere aren't enough contiguous memory pages available because virtual memory contains both code and data at various addresses
p48322
aVCompanies like IBM and Sun sell hardware that can do this
p48323
as(dp48324
g9
V17034
p48325
stp48326
a((dp48327
g2
(lp48328
VCompiling your project with /MT solves the distribution problem
p48329
aVBe careful though, it can get you in trouble when you use DLLs
p48330
aVThey will have their own memory allocator
p48331
aVIf they export a function that exposes a pointer or a C++ object that needs to be released by the client code then you'll have a very hard to diagnose memory leak on your hands
p48332
aVVery easy to do, just return an std::string for example
p48333
aVAnyhoo, the setting is found by right-clicking the project in the Solution Explorer window, Properties, C/C++, Code generation, Runtime Library setting
p48334
aVAlso note that VS2010 supports local deployment
p48335
aVJust put the msvcr100
p48336
aVdll file in the same directory as your EXE
p48337
aVYou also need msvcp100
p48338
aVdll if you use STL or iostreams
p48339
as(dp48340
g9
V17034
p48341
stp48342
a((dp48343
g2
(lp48344
VYes, the TreeView control is pretty flaky when the focus is changed while one of its events runs
p48345
aVWhich is one reason it distinguishes the BeforeXxxx and AfterXxxx events
p48346
aVUnfortunately, the context menu strip is shown too soon
p48347
aVThe solution is to display the context menu yourself by implementing the NodeMouseClick event
p48348
aVLike this:
p48349
aVI'll leave restoring the focus afterwards up to you
p48350
aVIt doesn't make much sense to implement it
p48351
as(dp48352
g9
V17034
p48353
stp48354
a((dp48355
g2
(lp48356
VSeveral problems in your C++ code
p48357
aVYou are returning an array, that requires the argument to be SAFEARRAY**
p48358
aVYou also are stuffing the array with the wrong data, you created an array of strings but you are writing VARIANTs
p48359
aVNot sure what the intention was, I'll keep variants in the code fix:
p48360
aVC# code:
p48361
as(dp48362
g9
V17034
p48363
stp48364
a((dp48365
g2
(lp48366
VBug, fixed in VS2010
p48367
aVFeedback item is here
p48368
as(dp48369
g9
V17034
p48370
stp48371
a((dp48372
g2
(lp48373
VWell, difficult, this emulation is done at the device driver level
p48374
aVYou can get some info out of the driver with WMI, Win32_SerialPort class
p48375
aVMaybe you can key off some of this
p48376
aVTry it out with the WMI Code Creator utility, it also generates the code you need
p48377
as(dp48378
g9
V17034
p48379
stp48380
a((dp48381
g2
(lp48382
VYou'll need to walk the nodes with TVM_GETNEXTITEM, starting at TVGN_ROOT
p48383
aVThen select it with TVM_SELECTITEM
p48384
aVPass the TVGN_FIRSTVISIBLE to ensure it is visible, shouldn't be necessary if you just automate it
p48385
aVTake a look at AutoIt to avoid writing grungy code like this
p48386
as(dp48387
g9
V17034
p48388
stp48389
a((dp48390
g2
(lp48391
VOdd code, the DS register is the default
p48392
aVJust ignore it, on Windows the DS, CS and ES registers are set to the same value
p48393
aVA protected mode selector
p48394
aVAnd the same value used by the Memory window
p48395
aVJust omit the ds: prefix
p48396
as(dp48397
g9
V17034
p48398
stp48399
a((dp48400
g2
(lp48401
VYes, this is the reason you'll always get advice to not use DoEvents()
p48402
aVIt is far to indiscriminate about what kind of events it allows to run
p48403
aVNot just closing forms, pressing the button that starts that loop is a nasty problem as well
p48404
aVNevertheless, there is already code in
p48405
aVNET that uses DoEvents() in a loop
p48406
aVForm
p48407
aVShowDialog()
p48408
aVIt makes it safe by doing the equivalent of this:
p48409
aVSetting the Enabled property to false is what makes it safe
p48410
aVThe user can't close forms or start the command again
p48411
as(dp48412
g9
V17034
p48413
stp48414
a((dp48415
g2
(lp48416
VAs long as you always lock a before b then you'll be okay
p48417
as(dp48418
g9
V17034
p48419
stp48420
a((dp48421
g2
(lp48422
VYou make it efficient by assigning the SelectedText property
p48423
aVUse the Select(int, int) method first to select the last character
p48424
as(dp48425
g9
V17034
p48426
stp48427
a((dp48428
g2
(lp48429
VYou right-clicked the solution name in the Solution Explorer window and got the solution properties
p48430
aVNote that the window says "Solution Test Property Pages"
p48431
aVRight-click the project name (Test in bold) instead to set the project options
p48432
as(dp48433
g9
V17034
p48434
stp48435
a((dp48436
g2
(lp48437
VI think this is a system setting
p48438
aVControl Panel + Sounds + Sounds tab
p48439
aVNot sure which one does it, I have a lot of them turned off
p48440
aVMaybe "Program Error"
p48441
as(dp48442
g9
V17034
p48443
stp48444
a((dp48445
g2
(lp48446
VDrawing the 'hash mark' is going to be the real problem
p48447
aVTreeView has a DrawMode property but its DrawItem event doesn't let you draw between the nodes
p48448
aVYou need to handle this by changing the cursor to indicate what is going to happen
p48449
aVUse the GiveFeedback event, set e
p48450
aVUseCustomCursors to false and assign Cursor
p48451
aVCurrent to a custom cursor that indicates the operation
p48452
as(dp48453
g9
V17034
p48454
stp48455
a((dp48456
g2
(lp48457
VIt is a built-in feature of the TabControl
p48458
aVDrop an ImageList on the form and fill it with your icons
p48459
aVSet the TabControl
p48460
aVImageList property
p48461
aVFor each tab page, set the ImageIndex property
p48462
as(dp48463
g9
V17034
p48464
stp48465
a((dp48466
g2
(lp48467
VIt is quite explicit in the MSDN Library docs for UnmapViewOfFile:
p48468
aVlpBaseAddress A pointer to the
p48469
aVbase address of the mapped view of a
p48470
aVfile that is to be unmapped
p48471
aVThis
p48472
aVvalue must be identical to the value
p48473
aVreturned by a previous call to the
p48474
aVMapViewOfFile or MapViewOfFileEx
p48475
aVfunction
p48476
aVYou changing the mapping by unmapping the old one and creating a new one
p48477
aVUnmapping bits and pieces isn't well supported, nor would it have any useful side-effects from a memory management point of view
p48478
aVYou don't want to risk getting the address space fragmented
p48479
aVYou'll have to do this differently
p48480
as(dp48481
g9
V17034
p48482
stp48483
a((dp48484
g2
(lp48485
VYou cannot draw outside your own windows
p48486
aVThe way to do this is by changing the mouse cursor
p48487
aVThat's what the GiveFeedback event is available, set e
p48488
aVUseDefaultCursors to false and set the Cursor
p48489
aVCurrent
p48490
aVJust to give you an idea what this looks like, here's a sample form that drags visible text
p48491
aVAlter it to draw the bitmap the way you want it, from your ImageList for example
p48492
aVBeware that Bitmap
p48493
aVGetHicon() does not create great icons, the color mapping is poor
p48494
as(dp48495
g9
V17034
p48496
stp48497
a((dp48498
g2
(lp48499
VIf the COM server DLL couldn't get loaded then you'd get a loud kaboom from this code
p48500
aVThe CSCCOMWRAP constructor would throw an exception
p48501
aVMaybe you haven't guessed the server DLL name correctly, it is not that easy to find
p48502
aVYou'd have to look in the registry for the InProcServer32 registry key value to know the DLL name
p48503
aVNote that your IDisposable implementation accomplishes nothing
p48504
as(dp48505
g9
V17034
p48506
stp48507
a((dp48508
g2
(lp48509
VIncrease the size of the TabControl's Font
p48510
aVThat takes care of the height
p48511
aVIf they are not wide enough then put more text in them
p48512
aVOr set the SizeMode property to Fixed
p48513
as(dp48514
g9
V17034
p48515
stp48516
a((dp48517
g2
(lp48518
VThe BackColor property is special, it is an 'ambient' property
p48519
aVIf it was never assigned then it will automatically get the value of the parent's BackColor
p48520
aVThat's very nice, it automatically makes all the child control background colors right when you change, say, the background color of the form
p48521
aVOther properties that behave this way are ForeColor, Cursor and Font
p48522
aVSounds like this is your problem
p48523
aVStart by looking at the BackColor property of the controls that don't color correctly in the Properties window
p48524
aVIf it is shown in bold then right-click it and choose Reset
p48525
aVLooking at the InitializeComponent() method and searching for BackColor assignments is a quick way to find them all
p48526
aVNext, check if your custom controls assign the BackColor property explicitly
p48527
as(dp48528
g9
V17034
p48529
stp48530
a((dp48531
g2
(lp48532
VTrying to guess at the problem isn't useful
p48533
aVAsk Windows what was wrong, use GetLastError()
p48534
aVLookup the error code in WinUser
p48535
aVh or use FormatMessage()
p48536
as(dp48537
g9
V17034
p48538
stp48539
a((dp48540
g2
(lp48541
VYou can't do this easily without getting notifications from the app
p48542
aVWhich, if it doesn't provide them, would require setting a global hook with SetWindowsHookEx() so you can see the WM_ERASEBKGND and WM_PAINT messages
p48543
aVThat's hard to get right, you cannot write such a hook in managed code
p48544
aVSince it requires injecting a DLL into the target process
p48545
aVThe only other option is that you put a transparent overlay on top of your form
p48546
aVAnother form that has its TransparencyKey property set
p48547
aVThe basic code you need to get that right is available in my answer in this thread
p48548
aVYou just need to tweak it so it is permanent
p48549
as(dp48550
g9
V17034
p48551
stp48552
a((dp48553
g2
(lp48554
VThere is no SelectedItemsChanged event, I'm guessing you mean SelectedIndexChanged
p48555
aVWhat you can do is leverage the Control
p48556
aVBeginInvoke() method
p48557
aVThe delegate target starts running when the UI thread goes idle again, after all the events have been fired
p48558
aVMake it look like this:
p48559
as(dp48560
g9
V17034
p48561
stp48562
a((dp48563
g2
(lp48564
VBe sure not to call this code too frequently, it is very detrimental to the health of the UI thread
p48565
aVIf you call it more than about 1000 times per second then the UI thread will stop responding completely
p48566
aVIt won't redraw anymore nor respond to mouse clicks
p48567
aVIf you have a large number of items to add then make sure you first store them in a List(Of ListViewItem), then Invoke() and add them to the list view, bracketed by BeginUpdate() and EndUpdate()
p48568
aVThere's no point in LockWindowUpdate()
p48569
aVThat will take care of most flicker, but won't eliminate it completely
p48570
aVThe ListView class supports double buffering but it isn't turned on by default
p48571
aVTo fix that, add a new class to your project and paste the code shown below
p48572
aVCompile
p48573
aVDrop the new control from the top of the toolbox, replacing the existing ListView
p48574
as(dp48575
g9
V17034
p48576
stp48577
a((dp48578
g2
(lp48579
VYes, that shouldn't be a problem
p48580
aVThere are very few native C++ constructs that cannot be translated to IL
p48581
aVVarargs used to be a problem but that was solved, I'm only aware of __fastcall as untranslatable
p48582
aVWon't be a problem, Boost won't use it
p48583
aVThe only other problem I'm aware of is having a lot of global variables
p48584
aVThey need to be embedded in a CLR class and a class cannot have more than 65535 fields
p48585
aVYou'll get an exception when the CLR loader tries to load the assembly
p48586
aVYou'd need some pretty, erm, special code to get close to that limitation
p48587
aVA secondary consideration is whether it actually makes sense to do so
p48588
aVThe point of using native code in the first place is to take advantage of the time that the code optimizer can spend on optimizing it
p48589
aVYou are throwing that away by getting the code translated to IL, the JIT optimizer doesn't have the same luxury
p48590
aVLeverage C++ Interop, it can translate from managed value types to native types without you having to write any glue code
p48591
aVJust turn off IL generation on the fly
p48592
aVLike this:
p48593
as(dp48594
g9
V17034
p48595
stp48596
a((dp48597
g2
(lp48598
VYou didn't post the code for your HashHelper method, but since it should be small and fast, yes, it is quite likely that it will get inlined
p48599
aVAnd, yes, the JIT optimizer is quite capable of evaluating expressions at compile time and replace the code with a simple constant value
p48600
aVBut that is not going to happen when you use a readonly member
p48601
aVBecause the value it has is determined by the constructor
p48602
aVThe optimizer does not consider the code in other methods to guess if the field has a known value
p48603
aVIt must be able to detect the value when it compiles GetHashCode
p48604
aVYou can get this if you use a const to initialize the readonly field
p48605
aVAnd use that same const in the GetHashCode implementation
p48606
aVThat's pretty ugly
p48607
aVGiven the very limited benefit you'll get from this micro-optimization, this is probably not something you should consider
p48608
aVThe possible win is no more than a nano-second or so
p48609
aVBut most likely zero because the optimizer would replace a xor with a mov
p48610
as(dp48611
g9
V17034
p48612
stp48613
a((dp48614
g2
(lp48615
VYou cannot create controls in another thread and add them to a form that was created in the main UI thread
p48616
aVWindows requires that the child windows owned by a top-level window belong to the same thread
p48617
aVYou have to create them in the UI thread
p48618
aVLeverage the Control
p48619
aVBegin/Invoke() method
p48620
as(dp48621
g9
V17034
p48622
stp48623
a((dp48624
g2
(lp48625
VThere are two kinds of COM interfaces
p48626
aVThe one you are familiar with are the ones that restrict themselves to a subset of the COM spec known as "OLE Automation"
p48627
aVAlso known as ActiveX before that term became associated with security disasters
p48628
aVAutomation compatible interfaces are easy to use from just about any language
p48629
aVThey typically inherit from IDispatch, allowing them to be used from scripting languages
p48630
aVAnd limit themselves to using only automation compatible types for their method arguments
p48631
aVThe simple stuff, comparable to the
p48632
aVNET value types, BSTR for strings, SAFEARRAY for arrays, VARIANT for untyped arguments, quite similar to
p48633
aVNET's System
p48634
aVObject
p48635
aVAnother feature they support well is type libraries, the equivalent of
p48636
aVNET metadata
p48637
aVUsed by a compiler to know how to call the interface methods
p48638
aVThe IDE uses a type library to automatically generate the interop library so you can directly create the wrapper class and call the methods from
p48639
aVNET code
p48640
aVWell, that's the good news
p48641
aVThe bad news is that there are lots of COM interfaces around that do not use the Automation restrictions
p48642
aVThey typically inherit from IUnknown and use function arguments that don't marshal well
p48643
aVLike structures
p48644
aVOne very large and visible component in Windows that is like this is the shell
p48645
aVWindows Explorer
p48646
aVThat's where IActiveDesktop fits in as well, it is a shell interface and inherits from IUnknown
p48647
aVIt is declared in the ShlObj
p48648
aVh SDK header file, there is not even a IDL file for it
p48649
aVAnd consequently no way to get a type library with its definition
p48650
aVIt uses incompatible argument types, like LPCWSTR (a raw pointer to a string) instead of BSTR
p48651
aVAnd structure pointers like LPCCOMPONENT and LPWALLPAPEROPT
p48652
aVThe CLR interop support is powerless to marshal that properly
p48653
aVUsing the interface in C# is technically not impossible, but you have to redeclare the interface
p48654
aVVery carefully, getting it wrong is very easy to do
p48655
aVThe fact that source code that already does this is very hard to find is a hint how difficult it is
p48656
aVThis squarely falls in the 'not impossible, but what sane programmer wants to maintain code like this' category
p48657
aVThe shell is the domain of unmanaged C++ code
p48658
aVAnd a crew of hardy programmers, because debugging shell extensions is quite painful
p48659
as(dp48660
g9
V17034
p48661
stp48662
a((dp48663
g2
(lp48664
VNo, they emulate a serial port at the driver level
p48665
aVYour code, nor the SerialPort class, won't know the difference
p48666
aVThe only temptation you'll have to resist is unplugging the USB cable while the port is opened
p48667
aVThat works about as well as unplugging a flash memory stick while Windows is writing to it
p48668
aVYour customer will do it anyway, but they usually get bored with it after a couple of times
p48669
as(dp48670
g9
V17034
p48671
stp48672
a((dp48673
g2
(lp48674
VOdd question: 'I have a problem if I have a bug in my code'
p48675
aVWell, yes
p48676
aVFix the bug, don't try to paper it over
p48677
aVThat kind of paper only ever produces two bugs because you can't test it until you know what the first bug is
p48678
as(dp48679
g9
V17034
p48680
stp48681
a((dp48682
g2
(lp48683
VHmya, console output isn't particularly fast
p48684
aVBut this is a 'problem' that never needs fixing
p48685
aVKeep your eyes on the prize: you are writing to the console for the benefit of a human
p48686
aVAnd that person isn't close to be able to read that fast
p48687
aVIf the output is redirected, it stops being slow
p48688
aVIf that still has an impact on your program then you are perhaps just writing way too much info
p48689
aVWrite to a file instead
p48690
as(dp48691
g9
V17034
p48692
stp48693
a((dp48694
g2
(lp48695
VYou got
p48696
aVpdb files that were stripped
p48697
aVTheir source code file and line number info was removed
p48698
aVTypical for example for
p48699
aVpdb files you can get from the Microsoft symbol server
p48700
aVWhich is okay, you can't get the source code anyway
p48701
aVWithout the line number info, the debugger falls back to using the 'closest' symbol whose address it does have available, typically the function entry point, and adds the offset of the call instruction
p48702
aVSometimes you get bogus information if debug info is missing for long stretches of code
p48703
aVThat 'closest' symbol is in no way related to the original code
p48704
aVAny time the offset gets to be larger than, oh, 0x200 then you ought to downplay the relevance of the displayed symbol name
p48705
aVThere are a couple of places in the Windows code where you actually see the name of a string variable
p48706
aVThe stack trace you posted has high confidence, those offsets are small
p48707
as(dp48708
g9
V17034
p48709
stp48710
a((dp48711
g2
(lp48712
VIt is sorta like witnessing one of those massive pile-ups at a formula 1 race
p48713
aVThe last bit of shrapnel that came to a rest reported:
p48714
aVYes, that's a very serious tire blow-out
p48715
aVLots of things go wrong when a heap gets corrupted
p48716
aVYou've probably got some unmanaged code that's misbehaving in a way that's so typical of unmanaged code, destroying the integrity of the heap with a bad pointer write
p48717
aVVery hard to diagnose, isolate that code
p48718
as(dp48719
g9
V17034
p48720
stp48721
a((dp48722
g2
(lp48723
VI've been keeping track of your questions
p48724
aVThere's context that you should have put in your question, I think you're trying to debug a DirectShow plug-in that you don't have the source code for
p48725
aVSome kind of camera gizmo
p48726
aVNo, opening a
p48727
aVpdb file in a text editor isn't going to show you anything useful
p48728
aVIt is binary data
p48729
aVI know you have a relevant
p48730
aVpdb for the plug-in you're working with, you get decent stack traces with named functions
p48731
aVYou probably got the
p48732
aVpdb from the Microsoft Symbol server
p48733
aVReading a
p48734
aVpdb file is the job of the debugger
p48735
aVThere are several APIs available to read it yourself, the dbghelp API is the core one
p48736
aVBut it will not show you anything you don't already know from the debugger
p48737
aVThe
p48738
aVpdb file is just a database of functions
p48739
aVYou got the stripped one, it will never show more than what you see in the call stack window
p48740
aVUltimately, this is a chain of XY questions
p48741
aVYou keep asking about Y without ever revealing what the real X problem is all about
p48742
aVYou'll just get useless answers, like this one, until you tell us about X
p48743
as(dp48744
g9
V17034
p48745
stp48746
a((dp48747
g2
(lp48748
VYou should always override OnLoad()
p48749
aVUsing the event is only appropriate when another class would be interested in the event
p48750
aVWhich is what events are for
p48751
aVAnother class being interested in the Load event is very rare, only really useful to do window arrangement stuff
p48752
aVStill, the Load event works well with the designer and VB6 programmers are very comfortable with it
p48753
aVIt isn't horribly wrong, you'd only get in trouble when you start inheriting the form and code doesn't run in the right order
p48754
aVMost code that now gets put in the Load event really belongs in the constructor
p48755
aVYou only need OnLoad if:
p48756
aVYou need to know the exact size and position of the window
p48757
aVOnLoad is best, the window Handle is created and the user preferences are applied (title and border size) and the form was rescaled as directed by the Form
p48758
aVAutoScaleMode property
p48759
aVThe window is not yet visible, a very good time to move the window somewhere else or to arrange the child controls
p48760
aVYou have code that needs the Handle property
p48761
aVThis is subtle, you cannot always tell
p48762
aVHaving code like that in the constructor is unhealthy, the window gets created before the constructor completed
p48763
aVIt usually comes to a good end but it can make creating the form very slow
p48764
aVEasy to diagnose from the Call Stack window
p48765
aVTo avoid a bug in the MDI implementation
p48766
aVIf you create an MDI child in the parent constructor then you'll get duplicated glyphs, visible when you maximize the child
p48767
aVCreate the child in OnLoad instead
p48768
as(dp48769
g9
V17034
p48770
stp48771
a((dp48772
g2
(lp48773
VThis has nothing to do with the CRT deployment, although it is mysterious that you got the debug build deployed
p48774
aVThe code is simply crashing on a runtime error, raised by the _invalid_parameter() function
p48775
aVWhich is called when a CRT function detects a critical problem with one of its arguments
p48776
aVThe fact that it doesn't happen in the Release build is no consolation, the Debug build is especially booby-trapped to cause errors like these so you don't have problems with a Release build that occasionally crashes
p48777
aVYou'll need a debugger, it automatically breaks just before it goes kaboom
p48778
as(dp48779
g9
V17034
p48780
stp48781
a((dp48782
g2
(lp48783
VMake your Navigator form look like this:
p48784
aVAnd your loop like this:
p48785
as(dp48786
g9
V17034
p48787
stp48788
a((dp48789
g2
(lp48790
VYup, I think you understand what's going on
p48791
aVSetWindowsHookEx() requires a valid module handle, and verifies it, but it doesn't actually use it when you set a low-level hook
p48792
aVYou just need a valid handle, it doesn't matter which specific one
p48793
aVCalling LoadLibrary("user32
p48794
aVdll") is a good way to get a handle, that DLL will always be loaded anyway since you P/Invoke its methods
p48795
aVAnd it is always loaded by the CLR bootstrapper (mscoree
p48796
aVdll)
p48797
aVDon't bother calling FreeLibrary(), it makes no difference
p48798
aVLater versions of Windows no longer perform this check
p48799
aVNot exactly sure when that started, somewhere around Windows 7 SP1 I think
p48800
aVProbably meant to be helpful but invokes the "works on my machine, not the customer's" failure scenario
p48801
as(dp48802
g9
V17034
p48803
stp48804
a((dp48805
g2
(lp48806
VNo, MSBuild isn't picky about XML comments
p48807
aVWhatever code analysis tool you use is
p48808
aVGuessing at something like StyleCop
p48809
aVIt does complain about this exact problem, it's not very smart, about on par with the Windows Forms project templates
p48810
aVYou are only ever going to solve this problem if you enforce the same kind of build rules on the devs as you apply to the build server
p48811
aVBecause it will take one of them to edit the do-not-edit code that it is in a Mumble
p48812
aVDesigner
p48813
aVcs file and apply the [GeneratedCode] attribute
p48814
aVIt is not there now
p48815
aVThat's a political problem, one I cannot really help you with
p48816
aVNor the Microsoft groups that worked on this at different times and different buildings
p48817
aVBut you can count on the devs barking loudly if you ask them to solve the problem
p48818
aVMake it consistent
p48819
as(dp48820
g9
V17034
p48821
stp48822
a((dp48823
g2
(lp48824
VDon't handle the exception, fix the bug in your code
p48825
aVThe form instance is dead after the form is closed, you cannot show it again
p48826
aVEither write it like this:
p48827
aVOr if you want only one instance of the form to be ever visible:
p48828
as(dp48829
g9
V17034
p48830
stp48831
a((dp48832
g2
(lp48833
VThe CLR only promises a variable alignment of 4
p48834
aVWhich means that it is quite possible for a long or double to straddle the boundaries of a CPU cache-line
p48835
aVThat makes the read guaranteed to be non-atomic
p48836
aVIt is also a fairly serious perf problem, reading such a poorly aligned variable is over 3 times as slow
p48837
aVNothing you can really do about it beyond hacking pointers
p48838
as(dp48839
g9
V17034
p48840
stp48841
a((dp48842
g2
(lp48843
VCode: 0xe053534f
p48844
aVThe last 3 hex codes translate to 'SSO'
p48845
aVWhich is an acronym for Soft Stack Overflow
p48846
aVAlways fun when the error code matches the web site name
p48847
aVA soft stack overflow exception is raised when the runtime detects that a hard stack overflow is imminent when it is setting up a call stack
p48848
aVIt is a serious error, just a wee bit less disastrous as getting a hard stack overflow
p48849
aVIt is almost certainly caused by an unholy interaction between the add-ons you are using
p48850
aVDisable them one-by-one to find the trouble-maker
p48851
as(dp48852
g9
V17034
p48853
stp48854
a((dp48855
g2
(lp48856
s(dp48857
g9
V17034
p48858
stp48859
a((dp48860
g2
(lp48861
VA bit tenuous, but there is a subtle difference
p48862
aVThere are 17 concrete classes in the
p48863
aVNET framework that format XML
p48864
aVThese formatters are all hidden, you get an instance to them with a method like XmlWriter
p48865
aVCreate()
p48866
aVSame for DataContractSerializer, the actual formatting is done by, say, an XmlDictionaryWriter instance
p48867
aVNo such indirection for BinaryFormatter or SoapFormatter, they take care of the formatting themselves
p48868
aVIn other words, a Formatter formats, a Serializer uses a formatter
p48869
as(dp48870
g9
V17034
p48871
stp48872
a((dp48873
g2
(lp48874
VWhy don't you just create another short-cut on the desktop that starts devenv
p48875
aVexe without elevation
p48876
as(dp48877
g9
V17034
p48878
stp48879
a((dp48880
g2
(lp48881
VNo answer, just a note about your approach
p48882
aVILMerge can only make the cold-start of your program quicker
p48883
aVLess DLLs that the file system needs to find
p48884
aVNgen
p48885
aVexe actually makes the cold-start worse, it doubles the number of files that need to be found
p48886
aVIt can only improve the warm-start, skipping the JIT step
p48887
aVThe GAC isn't good either, the files are stored in a large directory that won't be physically near the install location
p48888
as(dp48889
g9
V17034
p48890
stp48891
a((dp48892
g2
(lp48893
VFor C# projects you can use
p48894
aVLook at the manifest for the
p48895
aVassembly directives
p48896
aVThe C# compiler automatically removes ones that are not used
p48897
aVIf you see a reference in the References node of the project that doesn't have a matching
p48898
aVassembly directive then you can remove it
p48899
aVNot sure if the C++/CLI compiler does this as well
p48900
aVTry it out
p48901
aVC++ is much more difficult because the build tools can generate files beyond a
p48902
aVlib
p48903
aVLike a type library, created from IDL and used by managed code
p48904
aVOr a
p48905
aVh file from IDL
p48906
aVOr a
p48907
aVres file from a
p48908
aVrc file
p48909
aVIt is also likely that there's a dependency that nobody has found yet
p48910
aVThe kind that breaks the build when you use a machine with a lot of cores
p48911
aVYou can find out if a static or import
p48912
aVlib is used by analyzing the output of the linker with the /VERBOSE option
p48913
aVThere will be a line in the (large) output when it used a symbol from the
p48914
aVlib
p48915
aVFlush out missing project dependencies by reversing the order of the projects in the
p48916
aVsln file and doing a clean build, forcing only one CPU to be used
p48917
as(dp48918
g9
V17034
p48919
stp48920
a((dp48921
g2
(lp48922
V(
p48923
aVSetCursorPos@@$$J18YGHHH@Z)
p48924
aVNote how the function name got the C++ name decoration
p48925
aVYour declaration of the function is wrong, using extern "C" is required
p48926
aVAvoid these kind of mistakes by simply including
p48927
aVBut, don't do it this way
p48928
aVWindows Forms lets you move the cursor too:
p48929
aVI was seriously misled by the name decoration, that's an unpleasant linker error message
p48930
aVThe real problem is that your project isn't linking the required Windows import library
p48931
aVRight-click the project, Properties, Linker, Input
p48932
aVRemove the $(NoInherit) from the Additional Dependencies setting
p48933
aVIf you use VS2010 then put "user32
p48934
aVlib" in that setting
p48935
aVYou should still use the
p48936
aVNET Cursor class in this specific case
p48937
as(dp48938
g9
V17034
p48939
stp48940
a((dp48941
g2
(lp48942
VThere's a silly bug in the AutoWordSelection property implementation
p48943
aVThe workaround is equally silly
p48944
aVAdd a new class to your project and paste the code shown below
p48945
aVCompile
p48946
aVDrop the new control from the top of the toolbox onto your form, replacing the existing RTB
p48947
aVI left an annotation at the bottom of this MSDN Library page with the details of the bug
p48948
as(dp48949
g9
V17034
p48950
stp48951
a((dp48952
g2
(lp48953
VYou need a feature called 'Type equivalence', added to
p48954
aVNET 4
p48955
ag2512
aVIt is used to allow two distinct
p48956
aVNET types to be considered equivalent when they have the exact same GUID
p48957
aVThis feature was used to implement the new 'Embed Interop Types' feature, making it unnecessary to deploy PIAs
p48958
aVI don't know enough about it to judge whether you can actually use it to make this code work
p48959
aVGut instinct says yes
p48960
aVCheck out the docs for the [TypeIdentifier] attribute
p48961
as(dp48962
g9
V17034
p48963
stp48964
a((dp48965
g2
(lp48966
VThere's already a profiler built into MSBuild
p48967
aVTools + Options, Projects and Solutions, Build and Run, "MSBuild project build output verbosity"
p48968
aVChange it to Diagnostic
p48969
aVSample output from a do-nothing project:
p48970
as(dp48971
g9
V17034
p48972
stp48973
a((dp48974
g2
(lp48975
Vsizeof(arr) here is the size of the pointer to the array
p48976
aVC++ will not pass the actual array, that would be grossly inefficient
p48977
aVYou'd typically only get one pass through the loop
p48978
aVDeclare your function like this:
p48979
aVBut, really, use a vector
p48980
aVOh, hang on, the question
p48981
aVLoop through the array and print each individual element
p48982
as(dp48983
g9
V17034
p48984
stp48985
a((dp48986
g2
(lp48987
VThe problem is that your program is not pumping a message loop or is not letting the UI thread go idle
p48988
aVAn API function like SetTimer() requires a message loop to work
p48989
aVApplication
p48990
aVRun() in a Windows Forms project for example
p48991
aVThe callback can only run when the your main thread is inside the loop, dispatching Windows messages
p48992
aVIt works when you use MessageBox
p48993
aVShow(), that's a function that pumps its own message loop
p48994
aVSo that the message box can respond to the user clicking the OK button
p48995
aVBut of course, that will only work for as long as the box is up
p48996
aVYou'll probably need to restructure your program so it is based on a Windows Forms project template
p48997
aVCalling Application
p48998
aVDoEvents() in a loop is a very imperfect workaround
p48999
as(dp49000
g9
V17034
p49001
stp49002
a((dp49003
g2
(lp49004
VAre you running on a 64-bit version of Windows
p49005
aVLook in c:\u005cwindows\u005csyswow64, home of the 32-bit programs
p49006
as(dp49007
g9
V17034
p49008
stp49009
a((dp49010
g2
(lp49011
VThis cannot work
p49012
aVYou are getting this exception because you use the bitmap in more than one thread
p49013
aVI'd guess at another thread that's drawing the bitmap
p49014
aVTo make that work, you have to make sure that the two threads cannot use the bitmap at the same time
p49015
aVAnd that indeed requires the lock keyword
p49016
aVBut on the same lock object
p49017
aVThe Graphics instance you use won't be the same
p49018
aVThe lock doesn't work
p49019
aVCreate a dedicated locking object that both threads use
p49020
as(dp49021
g9
V17034
p49022
stp49023
a((dp49024
g2
(lp49025
VThis is a classic Heisenberg problem, you affect the outcome of the test by your measurement
p49026
aVThe startup time of a managed app is normally dominated by the cold-start time
p49027
aVThe time needed by the file system to find all the assemblies
p49028
aVAs opposed to warm-start time, a much smaller number you see when the assemblies are present in the file system cache
p49029
aVYou then only see the amount of time the JIT compiler needs to compile the startup code of your program
p49030
aVYour test will always be a warm-start because running the test code puts the
p49031
aVNET assemblies in the file system cache
p49032
aVHappy numbers, to be sure, but not accurate
p49033
aVYou will have to write your test in unmanaged code
p49034
aVSome scripting language that you're familiar with
p49035
aVHelp it along by calling Application
p49036
aVExit() in the Shown event of the main form so that your program immediately quits when the first form is visible
p49037
aVYou now only have to measure how long the process was executing
p49038
aVCould be as simple as
p49039
aVbat file that looks like this:
p49040
aVReboot the machine before you run the test so you can be sure that Prof
p49041
aVHeisenberg isn't around
p49042
aVAnd keep in mind that the exact number you measure won't likely repro on your customer's machine
p49043
aVBecause it is so dependent on the state of the hard disk
p49044
aVOnly use it for measuring the success of incremental improvements to your code
p49045
as(dp49046
g9
V17034
p49047
stp49048
a((dp49049
g2
(lp49050
VA VB6 DLL is normally a COM server
p49051
aVYou do in fact have the equivalent of a
p49052
aVh file, it has a type library embedded in it
p49053
aVStart this off with Project + Properties, Common Properties, Framework and References
p49054
aVAdd New Reference button, Browse tab, select the DLL
p49055
aVNext, View + Object Browser
p49056
aVYou should see the generated Interop library in the list
p49057
aVOpen the node to see what is there
p49058
aVYou write normal managed code, like gcnew, to create the COM object and call the interface methods
p49059
aVYou do need some minimum documentation on the available methods to have a guess at how they should be called
p49060
as(dp49061
g9
V17034
p49062
stp49063
a((dp49064
g2
(lp49065
VYes, unlike floating point types, System
p49066
aVDecimal keeps track of the number of digits in the literal
p49067
aVThis is a feature of decimal
p49068
aVParse(), whether executed by your code yourself or by the compiler when it parses a literal in your program
p49069
aVYou can recover this information, check out the code in my answer in this thread
p49070
aVRecovering the number of significant digits after you do math on the value strikes me as a long shot
p49071
aVNo idea if the operators preserve them, please let us know what you find out
p49072
as(dp49073
g9
V17034
p49074
stp49075
a((dp49076
g2
(lp49077
VVersioning in COM is a serious matter
p49078
aVThe dreaded DLL Hell is always around the corner
p49079
aVOne of the stone cold hard rules is that if you change a public interface of your COM component then you have to give the interface a new GUID
p49080
aVThis ensures that an client that was compiled with the previous version of the type library cannot accidentally use the new interface
p49081
aVNot following that rule produces very difficult to diagnose problems
p49082
aVThe client of the server will call the wrong method
p49083
aVOr the right method but with the wrong arguments
p49084
aVThe outcome is never pretty, anything can happen
p49085
aVIf you are lucky then the program crashes with an AccessViolation
p49086
aVThat kind of luck is hard to come by though, it usually just malfunctions in very inscrutable ways
p49087
aVJudging from your question, you don't use the [Guid] attribute on your interfaces but leave it up to the compiler to automatically generate one
p49088
aVIt does so by considering, for one, the [AssemblyVersion] attribute
p49089
aVA different version automatically generates a different GUID
p49090
aVWhat's next is, indeed, the DLL Hell avoidance at work, your VB6 program can no longer find the interface
p49091
aVYou'll get a predictable error message instead of a random call going into the weeds
p49092
aVThe VB6 program has to be recompiled to use the new type library
p49093
aVDo note that this is very much a feature, not a bug
p49094
aVYou can take control over it yourself by giving the interfaces a [Guid] attribute so they no longer depend on the assembly name or version
p49095
aVYou now have to manually change it when you change the interface
p49096
aVAnd will pay the price sooner or later when you forget to do so
p49097
aVThe type library version number is similarly important
p49098
aVChanging the public interface is not a simple build or revision change, it is a sweeping change
p49099
aVClients of your COM server have to be recompiled
p49100
aVExpress this in your version number, increment either the minor or major version number
p49101
as(dp49102
g9
V17034
p49103
stp49104
a((dp49105
g2
(lp49106
VOnce the debugger breaks on the exception, use Debug + Windows + Call stack
p49107
aVLocate your code in the displayed stack frames and double-click it
p49108
aVKeep that window around, it is one of the most useful debugging tools
p49109
as(dp49110
g9
V17034
p49111
stp49112
a((dp49113
g2
(lp49114
VAdd a new class to your project and paste the code shown below
p49115
aVCompile
p49116
aVDrop the new control from the top of the toolbox onto your form
p49117
aVBeware of the less than stellar rendering quality and the normal hassle of measuring the length of a string
p49118
as(dp49119
g9
V17034
p49120
stp49121
a((dp49122
g2
(lp49123
VFinalizers do not dispose objects
p49124
aVThe Excel
p49125
aVApplication interface doesn't have a Dispose method anyway
p49126
aVThe problem is that the finalizer for the RCW has already run by the time your finalizer runs
p49127
aVThat's by design, the order of finalizers isn't deterministic
p49128
aVExcel already quits automatically when all of the outstanding interfaces are released
p49129
aVWhich is done by the finalizers for the RCWs
p49130
aVDon't help
p49131
aVIf you want to help anyway then write it like this:
p49132
aVThe client of your class has to call that Dispose() method
p49133
as(dp49134
g9
V17034
p49135
stp49136
a((dp49137
g2
(lp49138
VYes, this was changed in VS2010:
p49139
aVNot sure about the abs() error, the line number looks wrong
p49140
aVThe math_functions
p49141
aVh header is no longer compatible with VS2010, something is going to have to give
p49142
aVReview the need to still have to #include math
p49143
aVh, it ought to be functionally replaced by Cuda
p49144
aVHacking the header would be another way to get past the problem until they fix it:
p49145
as(dp49146
g9
V17034
p49147
stp49148
a((dp49149
g2
(lp49150
VException 0xc000007b (STATUS_INVALID_IMAGE_FORMAT) is almost always generated on the 64-bit version of Windows
p49151
aVBecause your program is running in 64-bit mode and trying to load a DLL that contains unmanaged 32-bit code
p49152
aVOr the other way around
p49153
aVMake sure the managed assembly was built with the Platform Target set to Any CPU
p49154
aVThat isn't the default anymore in VS2010
p49155
aVProject + Properties, Build tab, Platform target setting
p49156
aVBe sure to change it for both the Debug and the Release configuration
p49157
aVIf you have no clue what DLL it might be then observe the program loading the DLL with the SysInternals' ProcMon utility
p49158
as(dp49159
g9
V17034
p49160
stp49161
a((dp49162
g2
(lp49163
VTry/catch is all you've got
p49164
aVThe try is for free, only the catch is expensive
p49165
aVShould not matter
p49166
aVIn general, be very careful mixing COM objects and threads
p49167
aVThe vast majority of them do not support free threading
p49168
aVDoing it anyway buys you exactly the kind of problem you are having
p49169
as(dp49170
g9
V17034
p49171
stp49172
a((dp49173
g2
(lp49174
VIt is a simple fix in VB
p49175
aVNET: Project + Properties, Application tab
p49176
aVChange Shutdown mode to "When last form closes"
p49177
as(dp49178
g9
V17034
p49179
stp49180
a((dp49181
g2
(lp49182
VIt is physically stored in the registry, spread out across the keys under HKEY_CURRENT_USER\u005cSoftware\u005cMicrosoft\u005cVisualStudio\u005c9
p49183
ag2512
aVThe
p49184
aVvssettings file you get out of Tools + Import/Export + Export is an XML file
p49185
as(dp49186
g9
V17034
p49187
stp49188
a((dp49189
g2
(lp49190
VWhy not just use ReadFile or DeviceIoControl on the service side
p49191
aVSimple IRP on the driver side, complete it when you have something to report
p49192
aVThe service will need to spin up a thread or use an I/O completion callback
p49193
aVAnd CancelIo to cancel the blocking call when the service exits
p49194
as(dp49195
g9
V17034
p49196
stp49197
a((dp49198
g2
(lp49199
VI repro, but it is specific to VS2010
p49200
aVThere is no such behavior in VS2008, both execute in less than 1 tick
p49201
aVIt also doesn't depend on the
p49202
aVNET version
p49203
aVThis looks like a defect in IntelliTrace, available in the Ultimate edition
p49204
aVTrying to dig deeper and turning unmanaged code debugging on removed the effect
p49205
aVProject + Properties, Debug tab, tick "Enable unmanaged code debugging"
p49206
aVAlso, running the program without the debugger (Ctrl+F5) removed the effect
p49207
aVThe slam-dunk is Tools + Options, IntelliTrace, General, untick Enable to remove the effect
p49208
aVI recommend you post your findings to connect
p49209
aVmicrosoft
p49210
aVcom
p49211
aVYou can reference this thread in your feedback report
p49212
aVEverything they need to know to diagnose the problem is available
p49213
aVAs noted, the workaround is to disable IntelliTrace
p49214
aVThis is guaranteed to not be a problem on your customer's machine
p49215
as(dp49216
g9
V17034
p49217
stp49218
a((dp49219
g2
(lp49220
VYou could use http://www
p49221
aVwhatismyip
p49222
aVorg/ it echos back your IP
p49223
as(dp49224
g9
V17034
p49225
stp49226
a((dp49227
g2
(lp49228
VDon't make the string content look like what you write in a C# program
p49229
aVThis ought to look more like:
p49230
aVBe sure to use the Path
p49231
aVCombine() method, it takes care of putting the backslashes in the right place
p49232
as(dp49233
g9
V17034
p49234
stp49235
a((dp49236
g2
(lp49237
VYes, use the MCI_CAPTURE command
p49238
as(dp49239
g9
V17034
p49240
stp49241
a((dp49242
g2
(lp49243
VYou didn't read it correctly
p49244
aVYou must do this:
p49245
aVchange your code to keep a reference
p49246
aVto that delegate on the managed side
p49247
aVfor the lifetime of the marshaled
p49248
aVunmanaged function pointer
p49249
aVIn other words, just store a reference to the delegate instance in your class and make sure the class object survives long enough
p49250
aVUse a static if you really have to
p49251
as(dp49252
g9
V17034
p49253
stp49254
a((dp49255
g2
(lp49256
VYou need to catch these keystrokes with a KeyDown event handler, not KeyPressed
p49257
aVKeyPressed is only raised for typing keys
p49258
aVA MaskedTextBox is not ideal here, you can also do it with a regular TextBox
p49259
aVUse the Validating event to format the number and check for range
p49260
aVFor example:
p49261
as(dp49262
g9
V17034
p49263
stp49264
a((dp49265
g2
(lp49266
VThis looks like an unholy XP feature
p49267
aVIt had the option to change the size of the system font independently from the video adapter DPI setting
p49268
aVVery convenient to XP users living in Easy Asia where glyphs that make up the letters are very intricate and need all the pixels they can get to make their script legible
p49269
aVIt is covered by Windows Forms with the Form
p49270
aVAutoScaleMode property, which defaults to Font instead of Dpi
p49271
aVWPF is however strongly biased to Dpi, the normal way of scaling
p49272
aVI don't think the twain shalt ever meet
p49273
aVTell your user to reset the XP setting
p49274
aVIt is buried somewhere in the Control Panel + Display setting, I don't have it anymore to tell you exactly where to look
p49275
aVOr the logical alternative, changing the video DPI setting to match the font size
p49276
aVThat's was in the Adapter tab, IIRC
p49277
aVChanging it from 96 to 120 DPI would be a good guess
p49278
as(dp49279
g9
V17034
p49280
stp49281
a((dp49282
g2
(lp49283
VUse Project + Add Reference, Browse tab
p49284
aVNavigate to c:\u005cprogram files\u005ccommon files\u005cmicrosoft shared\u005cink and select InkObj
p49285
aVdll
p49286
aVYou can now create an instance of MSINKAUTLib
p49287
aVInkDispClass
p49288
aVIt implements IInkDisp and has Save and Load methods
p49289
aVYou will have to cast the object to micautLib
p49290
aVIInkDisp, the interfaces come from different type libraries
p49291
aVAnd the clincher, you have to call the MathInputControl's Show() method first before using LoadInk()
p49292
aVError reporting is miserable, everything is E_UNEXPECTED
p49293
aVThe code I got to work:
p49294
aVPlus event handlers for the Insert and Close event
p49295
aVAnd the glue to get the window in the right place
p49296
aVAlso beware that the micautLib type library has a dependency on the bit-ness of the machine
p49297
aVThe troublemaker is the SetOwnerWindow() method, you really want to use it to prevent the dialog from disappearing behind another window
p49298
aVIts argument is declared as LONG_PTR, a type that is 32-bits on a 32-bit operating system, 64-bits on x64
p49299
aVThe window handle
p49300
aVWhen you use Visual Studio, you will always get the 32-bit version of that method since VS is a 32-bit program
p49301
aVIf you plan on supporting 64-bit operating systems then you will have to build a separate version of your program
p49302
aVStarting with running the 64-bit version of Tlbimp
p49303
aVexe (not Visual Studio) to create the interop wrapper
p49304
aVSo that the argument will be a 64-bit value and compatible with the window Handle you pass to the method
p49305
aVAh, the joys of COM
p49306
aVNo real accident that this wasn't wrapped by Microsoft
p49307
aVInk
p49308
aVdll :)
p49309
as(dp49310
g9
V17034
p49311
stp49312
a((dp49313
g2
(lp49314
VAssume delete[] didn't exist, write the code for deleting the array vs deleting only the first element in the array
p49315
aVA pointer to an array being an alias for a pointer to the first element of the array is of course an old C "feature"
p49316
as(dp49317
g9
V17034
p49318
stp49319
a((dp49320
g2
(lp49321
VThere is no point in using a FLP if it contains only one control
p49322
aVIts job is to flow the controls inside of it, nothing to flow if there's only one
p49323
aVUse the TabControl as-is, set its Dock property to Fill
p49324
aVIf that make it overlap one of the TLPs then right-click the TLP and click 'Send To Back'
p49325
as(dp49326
g9
V17034
p49327
stp49328
a((dp49329
g2
(lp49330
VThe element type of a managed array must be a managed type
p49331
aVOne workaround is store pointers:
p49332
as(dp49333
g9
V17034
p49334
stp49335
a((dp49336
g2
(lp49337
VRight, PropertyGrid has no hope of guessing how to assign the value
p49338
aVSo, hide it:
p49339
aVIf property assignment is a requirement then you'll need to implement a UITypeEditor for the property
p49340
as(dp49341
g9
V17034
p49342
stp49343
a((dp49344
g2
(lp49345
VErm, no
p49346
aVExecutable files contain machine code
p49347
aVAnd initialization values for global variables
p49348
aVOn Windows, the debugging information is normally stored in a separate file, a
p49349
aVpdb
p49350
aVA piece of debug data from that file about a function or a variable in your program is called a symbol
p49351
aVThe dbghelp API is described here
p49352
as(dp49353
g9
V17034
p49354
stp49355
a((dp49356
g2
(lp49357
VNot easily, the key-down of the 2nd keystroke stops the 1st one from repeating
p49358
aVWhat you have to do is record that the key is down in the KeyDown event
p49359
aVCancel that state in the KeyUp event
p49360
aVNext, use a Timer (~250 msec) and in its Tick event check the state of the keys
p49361
as(dp49362
g9
V17034
p49363
stp49364
a((dp49365
g2
(lp49366
VRight-click the
p49367
aVcpp file in the Solution Explorer window, Properties, C/C++, Output Files, Object File Name setting
p49368
aVThe default is ,  that's what is doing the flattening
p49369
aVAll the
p49370
aVobj file will go into $(IntDir), the "Debug" directory in the debug configuration
p49371
aVYou can change the setting, say
p49372
aVOr select all the files from one group (use Shift+Click) and change the setting to, say,
p49373
aVOr you can change the
p49374
aVcpp filename so that
p49375
aVobj files don't overwrite each other
p49376
aVHaving files with the exact same name in two directories is a bit odd
p49377
aVOr you can create multiple projects, creating, say,
p49378
aVlib projects for the files in identity and range
p49379
aVCommonly done in makefile projects for example
p49380
aVThat does however make managing the compile and link settings more of a hassle unless you use project property sheets
p49381
as(dp49382
g9
V17034
p49383
stp49384
a((dp49385
g2
(lp49386
VYou'll need to ignore the threads that are started by Microsoft code
p49387
aVI'm guessing at mmsys or DirectX from your screen shot
p49388
aVMicrosoft code is very thread-happy
p49389
aVYou can get better diagnostics about what they do when you enable the Microsoft Symbol Server
p49390
aVYou'll get decent names in the Call Stack window, often letting you guess what their purpose is
p49391
aVOf course, you'll never get to look at their code
p49392
as(dp49393
g9
V17034
p49394
stp49395
a((dp49396
g2
(lp49397
VNot really
p49398
aVThe CRT startup code calls main(), then calls exit()
p49399
aVThat terminates the program, regardless of any other threads
p49400
aVYou would have to prevent main() from returning
p49401
aVNormally done with WaitForSingleObject() on the thread handle
p49402
aVIn this specific case, if you see the threads still running when you trace through main's return then you forgot to release/close the Win32 resource you are using
p49403
as(dp49404
g9
V17034
p49405
stp49406
a((dp49407
g2
(lp49408
Vor one of its dependencies
p49409
aVWhich is the relevant part of the error message
p49410
aVIt has a dependency on vspmsg
p49411
aVdll from that same directory, you'll have to copy it by hand into your bin\u005cDebug folder
p49412
aVUsing private assemblies, exclusive to Visual Studio, is fairly courageous
p49413
as(dp49414
g9
V17034
p49415
stp49416
a((dp49417
g2
(lp49418
VA well described Browser Helper Object implemented in C#, designed to steal passwords, showing you how to use the DOM in the process is available in this project
p49419
aVOf course, battling built-in IE security is yours to deal with
p49420
aVA Winforms project that uses WebBrowser
p49421
aVDocument in the DocumentCompleted event is certainly an option as well
p49422
aVThere are far too few details in your question to help you choose
p49423
as(dp49424
g9
V17034
p49425
stp49426
a((dp49427
g2
(lp49428
VYour Execute method already runs on a thread
p49429
aVA threadpool thread that was started by the System
p49430
aVTimers
p49431
aVTimer you are using in order to raise the Elapsed event
p49432
aVDon't start another thread, just use the one that was handed to you
p49433
aVThreadpool threads are very cheap and recycle automatically
p49434
as(dp49435
g9
V17034
p49436
stp49437
a((dp49438
g2
(lp49439
VYou've got too many threads going to bring this to a good end
p49440
aVBoth the Timer and the delegate's BeginInvoke() method will use a threadpool thread
p49441
aVThe problem is that the PictureBox
p49442
aVImage property is only partially thread-safe
p49443
aVIt can be accessed by only one thread at a time
p49444
aVYour code will die with an exception when the image is painted by the UI thread at the exact same time your code is calling the Clone() method
p49445
aVYour lock statement doesn't solve the problem, the PictureBox is accessing the Image property without using that same lock
p49446
aVI would strongly recommend getting rid of the threading first, use a System
p49447
aVWindows
p49448
aVForms
p49449
aVTimer instead of a System
p49450
aVThreading
p49451
aVTimer
p49452
aVIt's Tick event is raised on the UI thread
p49453
aVThat will however make the UI thread unresponsive while the event is running, it depends how long it takes whether that's noticeable to the user
p49454
aVMore than, say, 100 milliseconds gets to be a problem
p49455
aVThe only other approach is to try to make the PictureBox control thread-safe
p49456
aVThat's possible to some degree
p49457
aVAdd a new class to your project and paste the code shown below
p49458
aVCompile
p49459
aVDrop the new control from the top of the toolbox onto your form, replacing the existing PB
p49460
aVBeware that this is only a partial solution, displaying an animated GIF or using the ImageLocation property will still bomb
p49461
aVUse the provided Clone method instead of calling Clone on the Image property
p49462
as(dp49463
g9
V17034
p49464
stp49465
a((dp49466
g2
(lp49467
VIf you have to source code for the server, change the linker's /MACHINE option
p49468
aVProject + Properties, Linker, System, SubSystem setting
p49469
aVAnd replace the main() function with WinMain()
p49470
aVIf you don't have to source code then you could use
p49471
aVfrom the Visual Studio Command prompt
p49472
as(dp49473
g9
V17034
p49474
stp49475
a((dp49476
g2
(lp49477
VWell, that's not much to go on without knowing exactly what you click on
p49478
aVThe gray background of the parent is a separate control, an MdiClient, not the form
p49479
aVYou'd register a click event for it with code like this:
p49480
as(dp49481
g9
V17034
p49482
stp49483
a((dp49484
g2
(lp49485
VAn InvalidCastException is raised when the IUnknown::QueryInterface() method of the COM interface returns the E_NOINTERFACE error return code
p49486
aVTwo basic reasons for that
p49487
aVThe usual one is that the COM object simply doesn't implement the interface you are casting to
p49488
aVThat's however very repeatable, it cannot be affected by a debugging session
p49489
aVThe second reason is trickier and is related to threading
p49490
aVWhen you use the RCW in another thread then the CLR will automatically marshal the interface pointer
p49491
aVThis requires the COM server to either explicitly implement the IMarshal interface, have a proxy/stub DLL registered (built from the IDL) or to support the standard marshaller (uses the type library)
p49492
aVThis is not universally done, there are a lot of COM servers that simply assume they will only be used from a single thread
p49493
aVThe debugger comes in to play because of the way it evaluates expressions in the Watch window
p49494
aVIt actually runs code to obtain the value of the expression
p49495
aVThe exact rules are not well documented that I know of, but sometimes that code will run on a helper thread
p49496
aVTypical for example if you used Debug + Break All to break into the program
p49497
aVThat helper thread is going to bomb if the COM server doesn't support marshaling
p49498
aVOne thing to check is that the thread that owns the COM object is the current thread
p49499
aVDebug + Windows + Threads and double-click the owning thread (usually the main thread of your app)
p49500
aVNot a great explanation, it is not a slam-dunk for your observation, but I suspect this is close to the problem
p49501
aVNot much you can do about it, avoid using the Watch window to display COM server properties
p49502
aVOr write a bit of debug code to copy the server property into a local variable, put a Watch on that variable instead
p49503
as(dp49504
g9
V17034
p49505
stp49506
a((dp49507
g2
(lp49508
VCOM takes care of threading on behalf of the COM server
p49509
aVThe server publishes the kind of threading it supports with the ThreadingModel registry key
p49510
aVVery common settings are Apartment or Both
p49511
aVFree is very rare
p49512
aVA missing key is equivalent to Apartment
p49513
aVCOM requires a single-threaded apartment (STA) for apartment threaded servers
p49514
aVIf you don't provide one (CoInitialize/Ex call) then it will create a dedicated thread for the server
p49515
aVA hard requirement for an STA thread is that it also pumps a Windows message loop
p49516
aVThe message loop is the mechanism by which COM automatically marshals a method call from one thread to another
p49517
aVSo, the general answer to your question is, yes, it normally is thread-safe
p49518
aVThere are still things that can go wrong
p49519
aVDeadlock is possible when a call is made from a worker thread but the STA thread isn't pumping
p49520
aVOr the server could be fibbing about the ThreadingModel it registered
p49521
aVNot uncommon with servers implemented in
p49522
aVNET
p49523
aVThey get registered as Both, but there are few
p49524
aVNET classes that are actually thread-safe
p49525
as(dp49526
g9
V17034
p49527
stp49528
a((dp49529
g2
(lp49530
V"Make assembly COM visible" is a big hammer to make all public types in the assembly [ComVisible]
p49531
aVRarely desirable, you will want to select the specific types that you want to be visible, like you did in your snippet
p49532
aVAfter the assembly is built, it needs to be registered so that it becomes usable by COM clients
p49533
aVThis involves writing registry keys in the  portion of the registry
p49534
aVYou can do it yourself by running  or you can leave it up to the build system to do it automatically after building the assembly
p49535
aVWhich is what "Register for COM interop" does
p49536
aVVS needs to run elevated to have write access to those registry keys, one reason for making it optional
p49537
aVOr you just don't want to register it, common on build servers
p49538
aVI can't comment on why you'd sometimes not get the
p49539
aVtlb without more diagnostics
p49540
as(dp49541
g9
V17034
p49542
stp49543
a((dp49544
g2
(lp49545
VDon't guess at this problem
p49546
aVWrite an event handler for the AppDomain
p49547
aVCurrent
p49548
aVUnhandledException event
p49549
aVDisplay or log the value of e
p49550
aVExceptionObject
p49551
aVToString()
p49552
as(dp49553
g9
V17034
p49554
stp49555
a((dp49556
g2
(lp49557
VPerformance counters only tell you that your program is slow
p49558
aVThey don't tell you why your program is slow
p49559
aVUse a profiler
p49560
as(dp49561
g9
V17034
p49562
stp49563
a((dp49564
g2
(lp49565
VUse the Controls
p49566
aVModifierKeys property to see what's pressed
p49567
aVFor example:
p49568
aVOther modifiers are Keys
p49569
aVAlt and Keys
p49570
aVShift
p49571
aVFind combinations with, say, (Keys
p49572
aVControl | Keys
p49573
aVShift)
p49574
as(dp49575
g9
V17034
p49576
stp49577
a((dp49578
g2
(lp49579
VIt is a status flag, separate from the principal drop effects (Copy/Move/Link)
p49580
aVShort from leaving room for future drop effects, picking the high bit allows a trick like checking if the value is negative
p49581
aVSame kind of idea as an HRESULT or the GetAsyncKeyState return value
p49582
as(dp49583
g9
V17034
p49584
stp49585
a((dp49586
g2
(lp49587
VAvoid thinking in terms of "driver", true operating system drivers cannot be written in a
p49588
aVNET language
p49589
aVThe original code no doubt used a simple Socket
p49590
aVSo can you
p49591
aVThe only hard part is figuring out the exact protocol, the meaning of each individual byte
p49592
aVUse Reflector on the original
p49593
aVNET assembly, you can probably reverse-engineer it
p49594
aVDo first check if your license agreement allows this, it isn't exactly common
p49595
as(dp49596
g9
V17034
p49597
stp49598
a((dp49599
g2
(lp49600
VYou are leaving it up to the Open() method to pick the FileShare value passed to the FileStream constructor
p49601
aVWhich is FileShare
p49602
aVNone
p49603
aVSpecify your own
p49604
as(dp49605
g9
V17034
p49606
stp49607
a((dp49608
g2
(lp49609
VYour array requires too much contiguous memory
p49610
aVYour program has a bit less of 2 gigabytes of virtual memory available but that address space is broken up by chunks of code, data and various heaps
p49611
aVMemory is allocated from the free space between those chunks
p49612
aVOn a 32-bit operating system you can get ~650 MB when you allocate immediately
p49613
aVThat goes South when your program starts using memory
p49614
aVThe sum of all memory allocations is still ~2GB
p49615
aVUse a 64-bit operating system or partition your data structures
p49616
aVSysInternals' VMMap utility can give you insight in the virtual memory mapping of your program
p49617
as(dp49618
g9
V17034
p49619
stp49620
a((dp49621
g2
(lp49622
VDon't hesitate to just try this yourself, Visual Studio makes it easy
p49623
as(dp49624
g9
V17034
p49625
stp49626
a((dp49627
g2
(lp49628
VDim properties = GetType(TestClass)
p49629
aVGetFields(
p49630
aVYou're trying to retrieve properties but you used GetFields
p49631
aVUse GetProperties instead
p49632
aVNext problem is the BindingFlags you pass
p49633
aVYou are asking for private properties but the class has only public properties
p49634
aVAlso include BindingFlags
p49635
aVPublic
p49636
aVNext problem is the type you pass GetCustomAttributes(), you want to search for CustomAttrib, not the class type
p49637
aVFixed:
p49638
as(dp49639
g9
V17034
p49640
stp49641
a((dp49642
g2
(lp49643
VIt is the blackest of black arts to get that going, I futzed for a long time to get the 3
p49644
aV5 reference source going
p49645
aVNever got 4
p49646
aV0 figured out yet
p49647
aVOne problem I discovered is the symbol cache
p49648
aVIf you've been debugging with the symbol server enabled before trying to get the reference source going then it it is filled with the wrong
p49649
aVpdb files, the ones that don't have source info
p49650
aVI fixed that by copying the
p49651
aVpdbs from the reference source (downloaded with the Massdownloader) by hand into the symbol cache directory, overwriting the bad ones
p49652
aVPay dirt
p49653
as(dp49654
g9
V17034
p49655
stp49656
a((dp49657
g2
(lp49658
VA char** argument is troublesome, there is a memory management problem
p49659
aVIf you declare the argument as "out string", the P/Invoke marshaller is going to try to free the pointer
p49660
aVThat's very unlikely to work, it requires the string to be allocated with CoTaskMemAlloc()
p49661
aVThe only other option you have to declare it as "out IntPtr" and marshal the string yourself with Marshal
p49662
aVPtrToStringAnsi()
p49663
aVThat will work, beyond an unpluggable memory leak if LLVMC actually expects you to free the pointer
p49664
aVCall it a million times to verify that
p49665
aVThere are a few odds that it won't blow since it is an error message, it might return a pointer to a string literal
p49666
aVThe only option left then is to write a wrapper in the C++/CLI language so you can free the pointer
p49667
as(dp49668
g9
V17034
p49669
stp49670
a((dp49671
g2
(lp49672
VYes, SortedList is O(n) for inserts
p49673
aVUse carefully
p49674
aVThe biggest reason is modern computer design
p49675
aVThe CPU cache is very important because RAM is so slow
p49676
aVThe memory bus design just couldn't keep up with the rapid advances in CPU clock speeds
p49677
aVMaking a high frequency digital signal travel more than an inch is very difficult
p49678
aVAn array has unbeatable cache performance, it very likely that the next element is already in the cache when you iterate it
p49679
aVA linked list gives very small odds that this is the case, the next item is essentially at a random address
p49680
aVThat's expensive, it stalls the processor, waiting for the RAM to catch up
p49681
aVCan be hundreds of cycles
p49682
as(dp49683
g9
V17034
p49684
stp49685
a((dp49686
g2
(lp49687
VThe first snippet cannot work because aTreeView is a reference to the TreeView that is stored in the form's Controls collection
p49688
aVThe assignment just changes the reference, it doesn't change the actual TreeView that the user is looking at
p49689
aVThe second snippet is flawed because a TreeNode has an owner
p49690
aVThe TreeView
p49691
aVThe code will empty the TreeView in your class
p49692
aVThe moved nodes might not be visible because you used the wrong reference, possible the wrong form instance
p49693
aVBe sure to use the one that the user is looking at
p49694
aVYou need to use the TreeNode
p49695
aVClone() method to create a copy of the node
p49696
as(dp49697
g9
V17034
p49698
stp49699
a((dp49700
g2
(lp49701
VThere are not a lot of a failure modes here
p49702
aVBut do keep in mind that the Target Platform setting is separate for the Debug and the Release version
p49703
aVAnd that the configuration name in VS2010 doesn't actually have anything to do with the Target Platform setting
p49704
aVIn other words, you can change the Target Platform but it will still be named "x86" in Build + Configuration Manager
p49705
aVTricky
p49706
aVSo double-check your assumptions
p49707
aVActually verify the Target Platform combo for both configurations
p49708
aVAnd Bob's recommendation to triple-check with Corflags
p49709
aVexe is a good idea
p49710
aVRun it from the Visual Studio Command prompt
p49711
aVOnly the EXE setting matters, the DLLs have to follow suit with what the startup assembly demanded
p49712
aVThere are additional failure modes if your code gets started by other means than a EXE
p49713
aVLike a unit-test runner
p49714
as(dp49715
g9
V17034
p49716
stp49717
a((dp49718
g2
(lp49719
VFun quirk of the MSVC compiler, it generates the exact same error when you compile it like that
p49720
aVYes, not a lot of 'fun'
p49721
aVIt skips everything to find the stdafx
p49722
aVh precompiled header include directive
p49723
aVThe string
p49724
aVh doesn't actually get included
p49725
aVFix:
p49726
aVAlways put the stdafx
p49727
aVh include first
p49728
as(dp49729
g9
V17034
p49730
stp49731
a((dp49732
g2
(lp49733
VJust draw it yourself in the OnPaintBackground() method
p49734
aVAdd the image to the resources (I called it BkgImage) and make the form code look like this:
p49735
as(dp49736
g9
V17034
p49737
stp49738
a((dp49739
g2
(lp49740
VThis is the declaration of the property:
p49741
aVStarting with [Browsable], that attribute ensures that the property doesn't show up in the Properties window
p49742
aVWhich makes sense because it is a runtime property and there is no setter
p49743
aVThat's also the relevance to [DesignerSerializationVisibility], it ensures that the property value doesn't get written to the InitializeComponent() method
p49744
aV[SRDescription] is for localization
p49745
aV[EditorBrowsable] is relevant to your question
p49746
aVUsing EditorBrowsableState
p49747
aVAdvanced ensures that IntelliSense will only display the property if the editor is operating in 'Show advanced IntelliSense info' mode
p49748
aVThe only IDE that I know that uses this feature is VB
p49749
aVNET, its IntelliSense popup window has an "All" tab but defaults to "Common"
p49750
aVBut not the C# IDE, the language you tagged your question with
p49751
aVI have to guess that you are actually programming in VB
p49752
aVNET, not C#
p49753
aVClick the All tab on the popup
p49754
as(dp49755
g9
V17034
p49756
stp49757
a((dp49758
g2
(lp49759
VChanging the Target framework setting is not exactly perfect
p49760
aVIn a C# project for example you have to remove the reference to Microsoft
p49761
aVCSharp by hand
p49762
aVAnd yes, it doesn't automatically update the System
p49763
aVDrawing assembly references in the
p49764
aVresx files
p49765
aVThis is quite a flaw, works okay when you increase the
p49766
aVNET version number (what just about everybody normally does), kaboom if you try to decrease it
p49767
aVNET is only forward compatible
p49768
aVYou'll have to remove the resources and add them back after changing the target framework
p49769
aVPretty painful, editing the
p49770
aVresx file by hand to minimize the job is however possible
p49771
aVRight-click the
p49772
aVresx file, Open With and select the text editor
p49773
aVChange the Version for the assembly name from 4
p49774
ag2512
ag2512
aV0 to 2
p49775
ag2512
ag2512
ag2512
aVBeware however that there can be trickier resources, like ImageList, the kind whose data got embedded in the
p49776
aVresx in binary
p49777
aVYou'll see a blob of base64 encoded bytes in the
p49778
aVresx file
p49779
aVThat also has the version number embedded, done so by BinaryFormatter
p49780
aVThe possible reason that VS doesn't do this for you
p49781
aVWriting a little program that decodes that base64 string back to byte[], locates the proper 0x34 and changes it to 0x32 and converts it back to base64 is only a hacker's delight, man over machine style :)  Best to just re-add those to avoid the almost inevitable oopses
p49782
as(dp49783
g9
V17034
p49784
stp49785
a((dp49786
g2
(lp49787
VIt is called Bidi Communication
p49788
aVThe SDK topic starts here
p49789
aVBeware for the rough ride, this is not friendly
p49790
aVEspecially not in C#, these are COM interfaces without a type library
p49791
as(dp49792
g9
V17034
p49793
stp49794
a((dp49795
g2
(lp49796
VYes, but you'll have to write a bunch of code
p49797
aVStart with DeviceManager
p49798
aVDeviceInfos to enumerate the devices that are available
p49799
aVYou'll need some guidance from the user to select the specific device she intends to use
p49800
aVThat produces a DeviceInfo from DeviceInfos
p49801
aVItem, call its Connect method
p49802
aVThat produces a Device, call its ExecuteCommand method
p49803
aVThat produces an Item, call its Transfer method
p49804
aVThat produces the ImageFile you need
p49805
as(dp49806
g9
V17034
p49807
stp49808
a((dp49809
g2
(lp49810
VThere's a property sheet included with the project named no_ms_shit
p49811
aVprops (after conversion)
p49812
aVThere's a fair amount of hate expressed in that sheet for what MS has been trying to do for the past 5 years
p49813
aVThey went a little too over-board with turning everything off, they even disabled linking to sprintf_s()
p49814
aVWhich is the source of your error, the stdio
p49815
aVh header omits the declaration but the string header uses it
p49816
aVNot sure if the Express edition supports editing project property sheets, but the step in the retail edition are:
p49817
aVView + Property Manager
p49818
aVOpen one of the nodes and locate "no ms shit"
p49819
aVRight-click it, Properties
p49820
aVC/C++, Preprocessor, Preprocessor Definitions
p49821
aVChange  to 1
p49822
aVAdd _CRT_SECURE_NO_WARNINGS to those definitions
p49823
aVThe project compiles clean now
p49824
aVI do get a build error for copying files, it is a post-build event
p49825
aVStart another question if you can't figure out how to fix it
p49826
as(dp49827
g9
V17034
p49828
stp49829
a((dp49830
g2
(lp49831
VWindows isn't picky about the filename extension for a DLL
p49832
aVChanging them isn't unusual,
p49833
aVocx for ActiveX controls,
p49834
aVscr for screen savers for example
p49835
aVBut still a regular DLL
p49836
aVThe Windows loader verifies the identity of the file from the content, the PE32 header is what makes it a true DLL
p49837
aVSo just rename your Window version of the
p49838
aVdll to
p49839
aVso
p49840
aVChange the linker's Output name setting or just rename the file
p49841
as(dp49842
g9
V17034
p49843
stp49844
a((dp49845
g2
(lp49846
VWhy do you need any synchronization when the threads each have their own instance
p49847
aVProtect the resource that is shared, don't bother with unshared state
p49848
aVThat automatically helps you find the best place for the locking object
p49849
aVIf it is a static member that the objects have in common then you indeed need a static locking object as well
p49850
as(dp49851
g9
V17034
p49852
stp49853
a((dp49854
g2
(lp49855
VThis should work:
p49856
as(dp49857
g9
V17034
p49858
stp49859
a((dp49860
g2
(lp49861
VIt will help if you use code that compiles
p49862
aVYour 'concrete implementations' are bogus, it looks like you mixed the concepts of class and method
p49863
aVThere is otherwise no design problem here
p49864
aVFor example:
p49865
as(dp49866
g9
V17034
p49867
stp49868
a((dp49869
g2
(lp49870
VImplement the KeyPress event
p49871
aVSet e
p49872
aVHandled = true if you don't like the key:
p49873
as(dp49874
g9
V17034
p49875
stp49876
a((dp49877
g2
(lp49878
VThis is already available in Windows, the shell uses natural sort order when arranging the files in an Explorer window
p49879
aVThe comparison function it uses is exported and available to any program, at least since Windows 2000
p49880
aVWhile P/Invoke isn't the greatest solution, it does have the considerable advantage of having been tested billions of times in the past 10 odd years
p49881
aVAnd sorting strings in a way that the user is already well familiar with
p49882
aVHandling diacritics is already part of
p49883
aVNET, the string
p49884
aVNormalize() method takes care of it
p49885
aVHere's a sample program that uses it, it properly sorts the strings as requested in the original thread:
p49886
as(dp49887
g9
V17034
p49888
stp49889
a((dp49890
g2
(lp49891
VIt sounds like your app is still begin built targeting x86
p49892
aVYou can double-check with the Corflags
p49893
aVexe utility
p49894
aVBeware that the Target platform setting is separate for each configuration type
p49895
aVYou might have changed it for the Debug configuration, so it runs on your dev machine, but not for the Release configuration, the one you're trying to deploy
p49896
aVSelect the configuration first before changing the option
p49897
aVBuild + Configuration manager
p49898
as(dp49899
g9
V17034
p49900
stp49901
a((dp49902
g2
(lp49903
VThis only has an effect on the form itself, not the child controls
p49904
aVIf you have a lot of them then the time they need to take turns painting themselves becomes noticeable, it leaves a rectangular hole where the control goes that doesn't get filled up until the child control gets it turn
p49905
aVWhat you'd need to combat this is double-buffering the entire form and the controls
p49906
aVThat's an option available since Windows XP which made the WS_EX_COMPOSITED style flag available
p49907
aVPaste this into your form to turn it on:
p49908
aVIt doesn't speed up the painting at all, but the form snaps onto the screen after a delay
p49909
aVEliminating the visible paint artifacts
p49910
aVReally fixing the delay requires not using controls
p49911
aVWhich you'd do by using the OnPaint method to draw the 'controls' and making the OnMouseClick event smart about what 'control' got clicked by the user
p49912
as(dp49913
g9
V17034
p49914
stp49915
a((dp49916
g2
(lp49917
VAsk him to enable daylight savings time observance and to verify the timezone
p49918
aVAnd in general use DateTime
p49919
aVUtcNow
p49920
aVAsk more questions about it at superuser
p49921
aVcom
p49922
as(dp49923
g9
V17034
p49924
stp49925
a((dp49926
g2
(lp49927
VNo user ever likes to get slapped with a message box that tells her she did something dumb
p49928
aVImprove your user interface, simply disable the menu item if it shouldn't be used
p49929
aVUse the context menu's Opening event, like this:
p49930
as(dp49931
g9
V17034
p49932
stp49933
a((dp49934
g2
(lp49935
VThat's utterly impossible to diagnose from the command line switches, you have to use a profiler
p49936
aVOne thing that's relevant however is you using the /clr option
p49937
aVUnless you explicitly use #pragma managed in your code, everything will be translated to IL, even the STL template code
p49938
aVWhich means that your optimization settings have no effect whatsoever since they only apply to generated machine code
p49939
aVYou are then subject to what the JIT compiler does for optimization
p49940
aVIt will not optimize by default when you have a debugger attached for example
p49941
as(dp49942
g9
V17034
p49943
stp49944
a((dp49945
g2
(lp49946
VEvery decent Unicode support library (not the standard library of course) has a way to decompose a string in KC or KD form
p49947
aVWhich separates the diacritics from the letters
p49948
aVGiving you a shot at filtering them out
p49949
aVNot so sure this is worth pursuing, the result is just gibberish to the native language reader and not every letter is decomposable
p49950
aVIn other words, junk with question marks
p49951
as(dp49952
g9
V17034
p49953
stp49954
a((dp49955
g2
(lp49956
VThis doesn't resemble an ISO 2022 encoding
p49957
aVThe high bits are supposed to be zero
p49958
aVThe escape sequence looks somewhat recognizable, but it starts with ESC
p49959
aV0x1b, not 0xb0
p49960
aVNo idea what those byte values really mean
p49961
as(dp49962
g9
V17034
p49963
stp49964
a((dp49965
g2
(lp49966
VYour  element has no effect
p49967
aVIt is explicitly noted in the MSDN docs for it:
p49968
aVThe enabled attribute for this element
p49969
aVis effective only when code access
p49970
aVsecurity (CAS) is disabled
p49971
aVYou enabled CAS
p49972
aVRun Caspol
p49973
aVexe to assign trust to the network location
p49974
aVInstructions are here
p49975
as(dp49976
g9
V17034
p49977
stp49978
a((dp49979
g2
(lp49980
VThe Microsoft employee that worked on that got hit by a bus
p49981
aVThat happens, the traffic congestion in Redmond is epic
p49982
aVIt didn't progress to an official downloadable release version, you have to hump the check-ins
p49983
aVFollowing the links takes me to this page, the download link at the upper right corner is active for that one
p49984
aVLooks complete, didn't try it
p49985
as(dp49986
g9
V17034
p49987
stp49988
a((dp49989
g2
(lp49990
VThis is fundamental about MDI, a child form can not be made modal
p49991
aVYou have to use ShowDialog() and make sure you don't set the MdiParent property
p49992
aVSuch a dialog is not constrained by the boundaries of the MDI parent, you can use the StartPosition property to get it centered
p49993
aVLike this:
p49994
aVOf course, you don't have to check anymore whether the form already exists, it is modal
p49995
as(dp49996
g9
V17034
p49997
stp49998
a((dp49999
g2
(lp50000
VIt is not the
p50001
aVNET version that's the problem
p50002
aVThe C++ build system currently does not directly support building for pre-
p50003
aVNET 4
p50004
aV0 targets
p50005
aVIt requires VS2008 to be installed so it can use its tool chain
p50006
aVSounds like you don't have it
p50007
aVThis blog post explains the workaround
p50008
aVYou can upvote this feedback article if you're unhappy with that
p50009
aVNo idea if this is slated to be fixed in SP1, this is not drawing a lot of votes
p50010
as(dp50011
g9
V17034
p50012
stp50013
a((dp50014
g2
(lp50015
VThat's normal
p50016
aVA printer has a resolution that's easily 6 times better than a monitor
p50017
aVWith the default mapping (1 pixel = 0
p50018
aV01 inch), you'll get a bitmap on the printer that's about the same size as it is on the screen
p50019
aVWith 1 pixel on the screen becoming a blob of 6 x 6 pixels on the printer
p50020
aVYes, doesn't look great
p50021
aVYou'll get a sharp image if you draw it 6 times smaller
p50022
aVA bit bigger than a postage stamp
p50023
aVDon't print forms
p50024
aVTake advantage of the printer resolution by drawing on e
p50025
aVGraphics
p50026
aVLots of work of course, report generators like Crystal Reports are popular
p50027
as(dp50028
g9
V17034
p50029
stp50030
a((dp50031
g2
(lp50032
VThe Windows Forms designer has limited support for generic types
p50033
aVIt will work okay when you avoid the generic type argument for :
p50034
as(dp50035
g9
V17034
p50036
stp50037
a((dp50038
g2
(lp50039
VRead up on using indexers in the C# language
p50040
aVHere's a relevant page
p50041
as(dp50042
g9
V17034
p50043
stp50044
a((dp50045
g2
(lp50046
VIt's a one-liner:
p50047
as(dp50048
g9
V17034
p50049
stp50050
a((dp50051
g2
(lp50052
g3471
aVocx is an unmanaged DLL that contains COM servers, ActiveX controls typically
p50053
aVIt cannot be merged into a
p50054
aVNET assembly
p50055
aVYou will have to replace those controls with, say, custom Windows Forms controls to get ahead on your plan
p50056
as(dp50057
g9
V17034
p50058
stp50059
a((dp50060
g2
(lp50061
VThere's a name mismatch, not sure how that happened
p50062
aVRemove the assembly reference
p50063
aVRename the DLL you downloaded from CodeScales
p50064
aVHttp
p50065
aVV0
p50066
aV14
p50067
aVdll to CodeScales
p50068
aVHttp
p50069
aVdll
p50070
aVThen add the reference back
p50071
as(dp50072
g9
V17034
p50073
stp50074
a((dp50075
g2
(lp50076
VThis is easy to fix in the IDE
p50077
aVClick the first file in the folder, Shift+Click the last file so all of them are selected
p50078
aVRight-click, Properties, C++, Output Files
p50079
aVChange the Object File Name from  to, say,
p50080
aVYou can repeat for the Multivariate file group although that's not strictly necessary
p50081
as(dp50082
g9
V17034
p50083
stp50084
a((dp50085
g2
(lp50086
VPaste this code in your form:
p50087
as(dp50088
g9
V17034
p50089
stp50090
a((dp50091
g2
(lp50092
VThe search path for assemblies is different when they get loaded at design time, it will be probing path for Visual Studio
p50093
aVWhich is configured by the devenv
p50094
aVexe
p50095
aVconfig file in Common7\u005cIDE
p50096
aVOnly the Public Assemblies and Private Assemblies folders are included
p50097
aVThe build directory of your project is not considered
p50098
aVModifying this
p50099
aVconfig file or copying your assembly into one of these folders is not exactly practical
p50100
aVBy far the best thing to do is to just not call the code that requires this assembly at design time
p50101
aVUse the DesignMode property:
p50102
as(dp50103
g9
V17034
p50104
stp50105
a((dp50106
g2
(lp50107
VWell, different rules in C++
p50108
aVClosest you could get is this slight abomination:
p50109
as(dp50110
g9
V17034
p50111
stp50112
a((dp50113
g2
(lp50114
VThey are two very different things
p50115
aVtry/catch are the familiar C++ keywords you know
p50116
aVis used to catch SEH exceptions
p50117
aVExceptions raised by Windows itself, like DivisionByZero or AccessViolation
p50118
aVIt is well described in the MSDN Library article for it
p50119
aVYou can also use it to catch C++ exception because it leverages the Windows SEH feature
p50120
aVYou however can't get the thrown exception object out of it so there will be zero context if you actually want the handle the exception
p50121
aVWhich is madness
p50122
aVThe number one approach is to not ever catch SEH exceptions, they are always gross
p50123
aVIf you do need to marry the two then use _set_se_translator() to convert the SEH exception to a C++ exception
p50124
as(dp50125
g9
V17034
p50126
stp50127
a((dp50128
g2
(lp50129
VIt is related to the way the threadpool scheduler works
p50130
aVIt tries hard to ensure that it won't release more waiting threads than you have CPU cores
p50131
aVWhich is a good idea, running more threads than cores is wasteful as Windows spends time switching context between threads
p50132
aVMaking the overall time needed to complete the jobs longer
p50133
aVAs soon as a TP thread completes, another one is allowed to run
p50134
aVTwo times per second, the TP scheduler steps in when the running threads do not complete
p50135
aVIt cannot tell why these threads are taking so much time to get their job done
p50136
aVHalf a second is a lot of CPU cycles, a cool billion or so
p50137
aVIt therefore assumes that the threads are blocking, waiting for some kind of I/O to complete
p50138
aVLike a dbase query, a disk read, a socket connection attempt, stuff like that
p50139
aVAnd it allows another thread to run
p50140
aVYou've now got more threads then you have cores
p50141
aVWhich isn't really a problem if those original threads are indeed blocking, they're not consuming any CPU cycles
p50142
aVYou can see where this leads: if your thread runs for 3 seconds then its creating a bit of a logjam
p50143
aVIt delays, but won't block, other TP threads that are waiting to run
p50144
aVIf your thread needs to spend so much time because it is constantly blocking then you are better off creating a regular Thread
p50145
aVAnd if you really care that the thread does not get delayed by the TP scheduler then you should use a Thread as well
p50146
aVThe TP scheduler was tinkered with in
p50147
aVNET 4
p50148
aV0 btw, what I wrote is really only true for earlier releases
p50149
aVThe basics are still there, it just uses a smarter scheduling algorithm
p50150
aVBased on a feedback, dynamically scheduling by measuring throughput
p50151
aVThis really only matters if you have a lot of TP threads going
p50152
as(dp50153
g9
V17034
p50154
stp50155
a((dp50156
g2
(lp50157
VThe version you get will depend on which version was last installed on your machine
p50158
aVYou should be using the Office PIAs so you don't need the interop libraries
p50159
aVYou can download them from here
p50160
aVThat PIA also needs to be deployed on the target machine
p50161
aVThis is largely history on VS2010, it supports embedding the interop types
p50162
aVVery desirable and a very good reason to consider upgrading
p50163
as(dp50164
g9
V17034
p50165
stp50166
a((dp50167
g2
(lp50168
VYour question is too general
p50169
aVThe Windows API has specific support for asynchronous I/O without using a thread, check the docs for ReadFile() for example
p50170
aVThe lpOverlapped argument controls this
p50171
aVThe ReadFileEx() function allows specifying an I/O completion callback
p50172
aVThis is well covered by the
p50173
aVNET framework classes
p50174
aVCalling a slow external API function is not covered by this mechanism, you need to spin up your own thread
p50175
as(dp50176
g9
V17034
p50177
stp50178
a((dp50179
g2
(lp50180
VThis is the same kind of issue as with the Thread class
p50181
aVIt consumes 5 operating system handles but does not implement IDisposable
p50182
aVGood decision of the original designers, there are of course few reasonable ways to call the Dispose() method
p50183
aVYou'd have to call Join() first
p50184
aVThe Task class adds one handle to this, an internal manual reset event
p50185
aVWhich is the cheapest operating system resource there is
p50186
aVOf course, its Dispose() method can only release that one event handle, not the 5 handles that Thread consumes
p50187
aVYeah, don't bother
p50188
aVDo beware that you ought to be interested in the task's IsFaulted property
p50189
aVIt's a fairly ugly topic, you can read more about it in this MSDN Library article
p50190
aVOnce you deal with this properly, you should also have a good spot in your code to dispose the tasks
p50191
as(dp50192
g9
V17034
p50193
stp50194
a((dp50195
g2
(lp50196
VSelecting a DLL as the startup project does not in any way guarantee that it actually gets loaded
p50197
aVThat EXE you are using has to use Assembly
p50198
aVLoad/From() to get the DLL loaded
p50199
aVAt that point does the debugger step in and activate the break-points you set
p50200
aVEasy to tell from the Debug + Windows + Modules window
p50201
aVIf you don't see your DLL loaded in that window then nothing is going to happen
p50202
aVYou'll need to find out what the exact configuration rules are for that EXE so that it will load the DLL you want to debug
p50203
as(dp50204
g9
V17034
p50205
stp50206
a((dp50207
g2
(lp50208
VYou cannot update a specific line in a text file
p50209
aVYou can only rewrite a text file from scratch or append to it
p50210
aVWhich is not what you want here
p50211
aVYou have to use File
p50212
aVReadAllLines() to get a string[] with the lines in the text file
p50213
aVSearch the specific element in the array that you want to update
p50214
aVThen write it all back with File
p50215
aVWriteAllLines()
p50216
aVThis is expensive of course, but your text file is small
p50217
aVThis is the primary reason why database engines are popular
p50218
as(dp50219
g9
V17034
p50220
stp50221
a((dp50222
g2
(lp50223
VThis is a fairly persistent complaint about VS2010 although it is not wide-spread
p50224
aVI haven't seen a good diagnosis for it yet
p50225
aVThe feedback item to watch is this one, it seems to be the collector for most duplicates
p50226
aVGetting it resolved quicker probably is going to require opening a case at Microsoft Support
p50227
as(dp50228
g9
V17034
p50229
stp50230
a((dp50231
g2
(lp50232
VThe CLR will not allow you to use a struct that has a field that overlaps a reference type
p50233
aVThe two arrays in your case
p50234
aVIt is quite incompatible with the garbage collector, it cannot keep track of the object reference
p50235
aVAnd would be quite unsafe as it allows a backdoor into the heap, manipulating the value of the object reference directly
p50236
aVThere's no point in doing so in your specific case as both arrays overlap and are exactly the same size
p50237
aVOne will get the job done just fine
p50238
as(dp50239
g9
V17034
p50240
stp50241
a((dp50242
g2
(lp50243
VMake it look similar to this:
p50244
as(dp50245
g9
V17034
p50246
stp50247
a((dp50248
g2
(lp50249
VYou are registering a function but you forgot to write it
p50250
aVPaste this into your form code:
p50251
as(dp50252
g9
V17034
p50253
stp50254
a((dp50255
g2
(lp50256
VBe sure to pay attention to the CloseReason so you won't block Windows trying to close your form
p50257
aVLike this:
p50258
as(dp50259
g9
V17034
p50260
stp50261
a((dp50262
g2
(lp50263
VThose assemblies implemented the DLR
p50264
aVThat's been moved in
p50265
aVNET 4
p50266
aV0, System
p50267
aVCore
p50268
aVdll assembly
p50269
as(dp50270
g9
V17034
p50271
stp50272
a((dp50273
g2
(lp50274
VDon't guess at this
p50275
aVWrite an event handler for AppDomain
p50276
aVCurrent
p50277
aVUnhandledException and display the value of e
p50278
aVExceptionObject
p50279
aVToString()
p50280
aVIn a VB
p50281
aVNET windows forms application:
p50282
as(dp50283
g9
V17034
p50284
stp50285
a((dp50286
g2
(lp50287
VA DGV will not go into edit mode until it is visible
p50288
aVOnLoad is too soon, the form isn't visible yet
p50289
aVYou could use the OnShown() method instead, it runs right after the form and all controls are painted for the 1st time
p50290
aVOr you could just directly assign the cell, no need to jump through the DataGridViewTextBoxCell hoop
p50291
as(dp50292
g9
V17034
p50293
stp50294
a((dp50295
g2
(lp50296
VThis is a threading problem
p50297
aVYou should ask the component vendor for help with this, sounds like they didn't set the ThreadingModel registry key properly
p50298
aVBut the likely response you'll get is "do not use them from a worker thread, only from an STA thread"
p50299
aVWhich is very common for ActiveX controls
p50300
as(dp50301
g9
V17034
p50302
stp50303
a((dp50304
g2
(lp50305
VEnumerable
p50306
aVOrderBy() slurps the IEnumerable<> into an array and uses quick sort
p50307
aVO(n) storage requirements
p50308
aVIt's done by an internal class in System
p50309
aVCore
p50310
aVdll,
p50311
aVThe storage cost makes it uncompetitive with simply sorting the list, if you have one, since List<> sorts in-place
p50312
aVLinq often optimizes by checking the true capabilities of the IEnumerable with the is operator
p50313
aVWon't work here since List<>
p50314
aVSort is destructive
p50315
aVList<>
p50316
aVSort and Array
p50317
aVSort use in-place quick sort
p50318
aVSortedList<> has O(n) complexity for an insertion, dominating the O(log(n)) complexity of finding the insertion point
p50319
aVSo putting N unsorted items into it will cost O(n^2)
p50320
aVSortedDictionary<> uses a red-black tree, giving insert O(log(n)) complexity
p50321
aVThus O(nlog(n)) to fill it, same as amortized quick sort
p50322
as(dp50323
g9
V17034
p50324
stp50325
a((dp50326
g2
(lp50327
VThis directive should be used by code generators
p50328
aVTools that translate from one language to another
p50329
aVSo that when you debug that code, the debugger will show the source file of the original language, stepping through the statements of that language
p50330
aVInstead of the (often cryptic) statements in the translated code
p50331
aVWhich is not what you did here, you are giving nonsense information in the directive
p50332
aVAnd obviously got nonsense results when you debug
p50333
aVGigo, garbage in, garbage out
p50334
aVRemove the directive
p50335
as(dp50336
g9
V17034
p50337
stp50338
a((dp50339
g2
(lp50340
VThe Windows Forms toolbox is remarkably cranky
p50341
aVThis ought to work, but indeed doesn't
p50342
aVNo idea why, this code is locked up inside Visual Studio
p50343
aVAs a workaround, you can hide it by using the DesignTimeVisibleAttribute
p50344
aVLike this:
p50345
as(dp50346
g9
V17034
p50347
stp50348
a((dp50349
g2
(lp50350
VJust some pointers to what's needed, I doubt you'll pursue this when you find out what it takes
p50351
aVStarting point is writing code that enumerates all of the EXE and DLL files on your disk drives
p50352
aVFor each file you find, you first have to check if it is indeed a managed program
p50353
aVNext, you need to lift the metadata version number from the COR header
p50354
aVIt indicates what CLR version the executable was built against
p50355
aVCommon values are 2
p50356
ag2512
aV50727 for
p50357
aVNET 2
p50358
aV0, 3
p50359
aV0 and 3
p50360
aV5, 4
p50361
ag2512
aV30319 for
p50362
aVNET 4
p50363
aV0, I don't know the numbers for
p50364
aVNET 1
p50365
ag22731
aVNext you need to use Assembly
p50366
aVGetReferencedAssemblies() to find out what
p50367
aVNET assemblies it has a dependency on
p50368
aVYou'll need to build your own index of assemblies that are present in 2
p50369
aV0, 3
p50370
aV0, 3
p50371
aV5 and its service packs
p50372
aVThis lets you find out what specific version is needed
p50373
aVNext you need to parse any
p50374
aVconfig file that might be present for an EXE and check for  and  elements
p50375
aVThe latter attribute is the tricky one since it can appear more than once
p50376
aVThere are probably some things I overlooked, like publisher assemblies and bindingRedirects
p50377
aVUse the source code for ildasm
p50378
aVexe in SSCLI20 to get a crack at reading the metadata version number
p50379
aVThe win for such a tool is small
p50380
aVWith one terabyte drives selling for a hundred bucks today, the potential savings of such a tool are worth about 4 cents
p50381
as(dp50382
g9
V17034
p50383
stp50384
a((dp50385
g2
(lp50386
VCopy and pasted from Math
p50387
aVcs in the
p50388
aVNET 4
p50389
aV0 Reference Source:
p50390
aVNo idea what you are looking at
p50391
aVIt was reverse-engineered from a follow-up question that you looked at the auto-generated text that was created from the assembly metadata when you use the Go To Definition context menu item
p50392
aVYes, the code that generates this text appears to use the default %f formatting on public double constant values
p50393
aVQuite rare btw, there are not a lot of public constants that are double in the
p50394
aVNET framework
p50395
aVYou can file a feedback report at connect
p50396
aVmicrosoft
p50397
aVcom
p50398
as(dp50399
g9
V17034
p50400
stp50401
a((dp50402
g2
(lp50403
VYes, the Visible property is a big deal in Windows Forms, that's what actually gets the handle created and causes OnLoad() to run
p50404
aVIn other words, the window doesn't exist until it gets visible
p50405
aVAnd it will ignore attempts to undo this
p50406
aVIt is pretty common to want to still create the handle but not make the window visible if you use a NotifyIcon
p50407
aVYou can achieve this by overriding SetVisibleCore:
p50408
aVBeware that OnLoad still won't run until the window actually gets visible so move code if necessary
p50409
aVJust call Show() in the NotifyIcon's context menu event handler to make the window visible
p50410
as(dp50411
g9
V17034
p50412
stp50413
a((dp50414
g2
(lp50415
VYes, this cannot work properly by design
p50416
aVA dialog disables all of the windows that your program displays
p50417
aVSo that it is modal
p50418
aVWhen you hide the dialog, there are no windows left that can get the focus
p50419
aVWindows is forced to find another window to give the focus to
p50420
aVThat will be a window owned by another application
p50421
aVYour own windows will now hide behind it
p50422
aVThere are more side effects, the dialog will also close
p50423
aVNecessary because otherwise the user can never get back to your program anymore since all windows are disabled
p50424
aVThis is all unsurprising behavior
p50425
aVBug would be a strong word, but it would of course work better if it first re-enabled all windows before closing the dialog
p50426
aVBut closing the dialog is already undesirable behavior
p50427
aVDon't call Hide() for a dialog
p50428
aVJust set the DialogResult property to DialogResult
p50429
aVCancel to achieve the exact same effect, minus the focus problem
p50430
aVYou do have to reset it back to None if you want to display the dialog again
p50431
aVThat's a real bug
p50432
as(dp50433
g9
V17034
p50434
stp50435
a((dp50436
g2
(lp50437
VIt is a heavy implementation detail of the JIT compiler
p50438
aVIn general, if the struct is small enough and has simple members then its gets returned in CPU registers
p50439
aVIf it gets too big then the calling code reserves enough space on the stack and passes a pointer to that space as an extra hidden argument
p50440
aVIt will never be boxed, unless the return type of the method is object of course
p50441
aVFwiw: this is also the reason that the debugger cannot display the return value of the function in the Autos window
p50442
aVPainful sometimes
p50443
aVBut the debugger doesn't get enough metadata from the JIT compiler to know exactly where to find the value
p50444
as(dp50445
g9
V17034
p50446
stp50447
a((dp50448
g2
(lp50449
VYes, it works the exact same way in
p50450
aVNET
p50451
aVStart reading here
p50452
as(dp50453
g9
V17034
p50454
stp50455
a((dp50456
g2
(lp50457
VYou do this with a resource in a Windows program
p50458
aVRight-click the project, Add, Resource, Import
p50459
aVGive the custom resource type a name
p50460
aVEdit the resource ID, if necessary
p50461
aVGet a pointer to the resource data at runtime with FindResource and LoadResource
p50462
as(dp50463
g9
V17034
p50464
stp50465
a((dp50466
g2
(lp50467
VYes, use integer division
p50468
aVBut the devil is in the details, be sure to use an integral property of a TimeSpan to avoid overflow and round-off problems:
p50469
as(dp50470
g9
V17034
p50471
stp50472
a((dp50473
g2
(lp50474
VYou can use Console
p50475
aVSetOut() to redirect the output
p50476
aVHere's a sample form that demonstrates the approach
p50477
aVDrop a RichTextBox and a button on the form
p50478
aVI assume it won't be very fast but looked okay when I tried it
p50479
aVYou could optimize by overriding more methods
p50480
as(dp50481
g9
V17034
p50482
stp50483
a((dp50484
g2
(lp50485
VYou can do it if you draw the hands with the GraphicsPath class
p50486
aVIts IsVisible() method lets you implement hit-testing in the MouseDown event and detect that the mouse is over a hand
p50487
as(dp50488
g9
V17034
p50489
stp50490
a((dp50491
g2
(lp50492
VThere are zero reasons left to avoid setting the Character Set to Unicode
p50493
aVWindows has been a native Unicode operating system for the past 17 years
p50494
aVCOM automation can only work with Unicode strings
p50495
aVIt doesn't actually matter that much since you should be using BSTRs in your COM code, it is not affected by that setting
p50496
aVAlways use BSTR in your interface declarations
p50497
aVThe _bstr_t class is indeed a handy wrapper class around BSTR to make manipulating these strings easy
p50498
aVTCHAR is archaic and not compatible with COM automation
p50499
aVSame reasoning goes for the client app
p50500
aVThe setting doesn't matter because you forced the client to use BSTR with your interface declaration
p50501
aVBut not using Unicode in the rest of that app's code is archaic
p50502
aVAnd the code you'd have to write to convert the BSTR to a const char* and back is just a waste of your time and a potent source of lossage when the Unicode string contains characters that cannot be translated to the system code page
p50503
aVAll mainstream COM clients (Java,
p50504
aVNET, Javascript and other scripting languages) use Unicode
p50505
as(dp50506
g9
V17034
p50507
stp50508
a((dp50509
g2
(lp50510
VWell, that doesn't look healthy
p50511
aVNote how it is not valid XML, the project
p50512
aVelement is mismatched with RuthSiteManager
p50513
aVNot sure how it got that way, you'll have to edit it into shape
p50514
aVI guess you want to rename "project1"
p50515
aVAvoid editing the
p50516
aVconfig file by hand otherwise
p50517
aVAnd make sure you have the required  element as well
p50518
as(dp50519
g9
V17034
p50520
stp50521
a((dp50522
g2
(lp50523
VPort 0x379 is an input port
p50524
aVYou cannot change the value it reports in software, you actually have to put a voltage on pin 10, 11, 12, 13 or 15
p50525
aVRespectively the Ack, *Busy, PaperOut, Select and Error signals
p50526
as(dp50527
g9
V17034
p50528
stp50529
a((dp50530
g2
(lp50531
VOne approach I've seen is shown in this blog post
p50532
aVIt was referenced by this code (beware of slow server)
p50533
aVCrazy stuff of course, no idea how well this will port between different Windows versions
p50534
as(dp50535
g9
V17034
p50536
stp50537
a((dp50538
g2
(lp50539
VThere might be a publisher policy file that overrides your binding redirect
p50540
aVFind out by using Fuslogvw
p50541
aVexe to see what policies are applied
p50542
as(dp50543
g9
V17034
p50544
stp50545
a((dp50546
g2
(lp50547
VYes, you're not the first to be annoyed by this
p50548
aVThis looks to be likely to get fixed in SP1 according to this feedback item
p50549
as(dp50550
g9
V17034
p50551
stp50552
a((dp50553
g2
(lp50554
VDon't convert it
p50555
aVOne of the very nice features of
p50556
aVNET is that the types from one managed language can be used in another
p50557
aVRight-click your C++/CLI project, Properties, Common Properties, Framework and References
p50558
aVClick Add New Reference
p50559
aVUse the Projects tab if your C# project is in the same solution (recommended)
p50560
aVOtherwise click the Browse tab and navigate to your C# assembly
p50561
as(dp50562
g9
V17034
p50563
stp50564
a((dp50565
g2
(lp50566
VWrite it like this:
p50567
aVTo get error CS0165: Use of unassigned local variable 'handler'
p50568
aVQuestionable diagnostic, it isn't actually unassigned
p50569
aVThe hidden class that implements the anonymous method does in fact get created before the captured value of 'handler' is assigned
p50570
aVThat cannot be easy to implement in the C# compiler though
p50571
aVEdge case
p50572
as(dp50573
g9
V17034
p50574
stp50575
a((dp50576
g2
(lp50577
VThere are a lot of things you are not taking care of
p50578
aVTXBuffer needs to be a circular buffer
p50579
aVOnce you increment TXEndPos past 127 then you need to wrap it back to 0
p50580
aVSame for TXCurrrentPos
p50581
aVThat also affects the test to see if there's something in the buffer, the > 0 test isn't good enough
p50582
aVGeneric advice is available here
p50583
as(dp50584
g9
V17034
p50585
stp50586
a((dp50587
g2
(lp50588
VYes, it make a difference
p50589
aVIt makes the cold-start of your app slower
p50590
aVWhen you haven't run your app before, like a couple of minutes ago so the DLL is in the file system cache, the hard disk has to find the DLL back so that the CLR can load it
p50591
aVThe time needed for that is remarkably constant since I started measuring it, about 50 milliseconds to find a file
p50592
aVHard disks get bigger and faster, but the time needed to find a file is one divided by the other and consistent
p50593
aVIgnoring SSDs
p50594
aVIt's a human time measure, not a machine measure
p50595
aVHow long is your user willing to tap her foot to get your program going
p50596
aVVery subjective, a program that doesn't do much at all taking one second is too much
p50597
aVA program that does a lot displays a pretty splash screen, like Visual Studio, something to keep you occupied for the next 5-some seconds
p50598
aVAt first
p50599
aVYou can use ILMerge to fight back the tapping
p50600
as(dp50601
g9
V17034
p50602
stp50603
a((dp50604
g2
(lp50605
VYou're okay on several levels
p50606
aVThe #if ensures that your code doesn't use any types from Y, the compiler will actually remove the assembly reference from the final assembly
p50607
aVEven if you did have references to Y types in your code, they can actually be JIT compiled because you do have valid metadata for it
p50608
aVYou've got the interop assembly
p50609
aVThe only thing you can't do is create the COM object and call its methods
p50610
aVYou can use a regular if rather than #if
p50611
aVAllowing you to avoid building separate assemblies
p50612
aVTesting IntPtr
p50613
aVSize is a good way to find out if you are running in 64-bit mode
p50614
as(dp50615
g9
V17034
p50616
stp50617
a((dp50618
g2
(lp50619
VFrom the ScrollWindowEx docs:
p50620
aVdy Specifies the amount, in
p50621
aVdevice units, of vertical scrolling
p50622
aVThis parameter must be a negative
p50623
aVvalue to scroll up
p50624
aVI bolded the relevant phrase
p50625
as(dp50626
g9
V17034
p50627
stp50628
a((dp50629
g2
(lp50630
VWild guess: try calling SetThreadExecutionState(ES_CONTINUOUS) on the same thread that called WaveInOpen
p50631
as(dp50632
g9
V17034
p50633
stp50634
a((dp50635
g2
(lp50636
VThere's a bug in Windows Forms that makes a form disappear from the Application
p50637
aVOpenForms collection
p50638
aVThis will happen when you assign the ShowInTaskbar, FormBorderStyle, Min/MaximizedBox, RightToLeftLayout, HelpButton, Opacity, TransparencyKey, ShowIcon or MdiParent property after the window was created
p50639
aVThese properties are special in that they are specified as style flags in the native CreateWindowEx() call
p50640
aVThis sample form demonstrates the bug:
p50641
aVWindows Forms must call CreateWindowEx() again to make the changed property effective, passing different style flags
p50642
aVDestroying the original window first has side effects beyond the very noticeable flicker, one of them is that the Application class loses track of the form since it sees the window disappear
p50643
aVWith the bug that it doesn't add it back when the new window is created
p50644
aVAvoid the bug by setting the property only in the constructor, code that runs before CreateWindowEx() is called, not in any event handlers
p50645
aVIn general, avoid relying on OpenForms due to this bug
p50646
aVGive the class that needs to display the message box a reference to the form instance through its constructor
p50647
aVMessageBox usually figures out a parent window by itself correctly btw, it will pick the active window and that's correct 99
p50648
aV9% of the time
p50649
as(dp50650
g9
V17034
p50651
stp50652
a((dp50653
g2
(lp50654
VYou managed to create a circular project reference somehow
p50655
aVThe resource value looks roughly like this, when converted from base64 to bytes:
p50656
aVThis is data generated by BinaryFormatter, note that it is referencing the DataTesting assembly, the assembly that you are trying to compile
p50657
aVThis indeed can go undetected for a while since DataTesting
p50658
aVdll will exist as you are editing your project
p50659
aVUntil you do a clean build and the DLL is no longer available
p50660
aVKaboom
p50661
aVNo idea what the resource actually means or how you got it into the resource in the first place
p50662
aVBut you'll need to spin whatever type is stored here into another assembly so that it can be built separately
p50663
aVRecovering from this error, short from restoring an earlier version from SCCS, might be possible by editing the
p50664
aVresx file by hand and deleting the resource
p50665
as(dp50666
g9
V17034
p50667
stp50668
a((dp50669
g2
(lp50670
VI do not see a way for ShapeCollection
p50671
aVDispose() to throw that exception
p50672
aVAlthough it is manipulating a List<> that can indeed throw that exception, the code should not trigger it:
p50673
aVWell, this is from the PowerPacks version that I have
p50674
aVThere have been a couple of versions of it floating around, it used to be distributed separately
p50675
aVMake sure you didn't accidentally deploy an old version
p50676
as(dp50677
g9
V17034
p50678
stp50679
a((dp50680
g2
(lp50681
VYou are fighting the "There's no free lunch" principle
p50682
aVYou cannot assume that stuffing millions of items in a list isn't going to affect perf
p50683
aVOnly the SortedList<> should be a problem, it is going to start allocating memory in the Large Object Heap
p50684
aVThat allocation isn't going to be freed soon, it takes a gen #2 collection to chuck stuff out of the LOH again
p50685
aVThis delay should not otherwise affect the perf of your program
p50686
aVOne thing you can do is avoiding the multiple of copies of the internal array that SortedList<> will jam into the LOH when it keeps growing
p50687
aVTry to guess a good value for Capacity so it pre-allocates the large array up front
p50688
aVNext, use Perfmon
p50689
aVexe or TaskMgr
p50690
aVexe and looks at the page fault delta of your program
p50691
aVIt should be quite busy while you're allocating
p50692
aVIf you see low values (100 or less) then you might have a problem with the paging file being fragmented
p50693
aVA common scourge on older machines that run XP
p50694
aVDefragging the disk and using SysInternals' PageDefrag utility can do extraordinary wonders
p50695
as(dp50696
g9
V17034
p50697
stp50698
a((dp50699
g2
(lp50700
VA struct type is not immutable
p50701
aVYes, strings are
p50702
aVMaking your own type immutable is easy, simply don't provide a default constructor, make all fields private and define no methods or properties that change a field value
p50703
aVHave a method that should mutate the object return a new object instead
p50704
aVThere is a memory management angle, you tend to create a lot of copies and garbage
p50705
as(dp50706
g9
V17034
p50707
stp50708
a((dp50709
g2
(lp50710
VRTL only affects the display of text, not the transmission
p50711
aVNot sure what "mixed up" might mean but I'd recommend you take a good look at the MailMessage
p50712
aVBodyEncoding property
p50713
aVThe default is ASCII, not suitable for sending the kind of characters used in a RTL language
p50714
aVIf that doesn't help then consider that the problem might actually be caused by the mail reader you are using
p50715
aVIt might not support RTL or cannot handle a mix
p50716
as(dp50717
g9
V17034
p50718
stp50719
a((dp50720
g2
(lp50721
VTrackBar is a wrapper around a native Windows control
p50722
aVLike most native controls, it draws itself using the system colors as selected by the user
p50723
aVYou can't change it yourself
p50724
aVBeyond making your own control, there's nothing you can do but pick a contrasting background color
p50725
aVWhich typically ought to be the same color as the container
p50726
aVWhich typically is a system color as well ("Control")
p50727
aVA consistent look-and-feel between different applications was considered an asset
p50728
aVIt arguably is, users like to pick a custom theme and expect programs to change accordingly
p50729
as(dp50730
g9
V17034
p50731
stp50732
a((dp50733
g2
(lp50734
VUse Convert::ToDouble(str, System::Globalization::CultureInfo::InvariantCulture);
p50735
as(dp50736
g9
V17034
p50737
stp50738
a((dp50739
g2
(lp50740
VThis is something you are going to have to deal with if you expect to generate line numbers from code generated in the Release configuration
p50741
aVThe JIT compiler's optimizer is enabled and it is going to move code around to create more efficient machine code
p50742
aVThat's going to affect the accuracy of the reported line number
p50743
aVThe specific workaround here is to apply this attribute to "badMethod":
p50744
aVThis is not a joyful workaround, inlining is an important optimization, especially on property getter/setters
p50745
aVThe reason it is different between
p50746
aVNET 2
p50747
aV0 and 4
p50748
aV0 is because they have different jitters with different rules for deciding when a method should be inlined
p50749
as(dp50750
g9
V17034
p50751
stp50752
a((dp50753
g2
(lp50754
VIt depends
p50755
aVThere are various stream types that do not implement the Length or Position property, you'd get a NotSupportedException
p50756
aVNetworkStream for example
p50757
aVOf course, if you'd use such a stream then you really do have to know up front how often to call the BinaryReader
p50758
aVRead() method
p50759
aVSo, yes, it's fine
p50760
as(dp50761
g9
V17034
p50762
stp50763
a((dp50764
g2
(lp50765
VYou will have to remove the ExactSpelling property
p50766
aVThe real name of the function is SetDllDirectoryW
p50767
aVI also recommend you use CharSet
p50768
aVAuto, using Ansi is a lossy conversion that can cause subtle problems
p50769
aVThe export is not available in any Windows version prior to XP SP1
p50770
as(dp50771
g9
V17034
p50772
stp50773
a((dp50774
g2
(lp50775
VYou didn't say anything about the kind of assembly
p50776
aVOnly the startup assembly determines the bit-ness of the process
p50777
aVThe EXE
p50778
aVAny DLL must follow suit
p50779
as(dp50780
g9
V17034
p50781
stp50782
a((dp50783
g2
(lp50784
VHere is C# code to do this directly:
p50785
aVSample usage:
p50786
as(dp50787
g9
V17034
p50788
stp50789
a((dp50790
g2
(lp50791
VYou really need to add some error checking
p50792
aVAt least verify if _dllHandle
p50793
aV= IntPtr
p50794
aVZero
p50795
aVAlso, depending on the current working directory is dangerous, use Assembly
p50796
aVGetEntryAssembly()
p50797
aVLocation to get a full path name
p50798
aVThe function name is probably wrong
p50799
aVExports tends to be decorated, like _MyDllFunc or _MyDllFunc@4
p50800
aVMore wildly if it was compiled by a C++ compiler
p50801
aVUse Dumpbin
p50802
aVexe /exports on your DLL to see the real names
p50803
aVBack to error handling, use SetLastWin32Error in the [DllImport] attribute
p50804
aVThrow Win32Exception if the function returns false or IntPtr
p50805
aVZero
p50806
aVEdit: I see the real problem
p50807
aVUsing CharSet
p50808
aVAuto for GetProcAddress() is wrong
p50809
aVVery unlucky, it is just about the only Windows API function that only has an ANSI version
p50810
aVYou have to use CharSet
p50811
aVAnsi
p50812
aVA good place to get proper [DllImport] declarations is pinvoke
p50813
aVnet
p50814
as(dp50815
g9
V17034
p50816
stp50817
a((dp50818
g2
(lp50819
VYour glOrtho() call is almost certainly wrong
p50820
aVYou pass the window size, not the window client area size
p50821
aVThe difference is the size of the borders and the height of the caption
p50822
as(dp50823
g9
V17034
p50824
stp50825
a((dp50826
g2
(lp50827
VThe buffer will last for only 40 milliseconds
p50828
aVYou can't guarantee zero under-runs on Windows with such strict timing requirements
p50829
aVIn user mode land, you are looking at, potentially, hundreds of milliseconds when kernel threads do what they need to do
p50830
aVThey run with higher priorities that you can ever gain
p50831
aVThe thread quantum on the workstation version is 3 times the clock tick, already beyond 40 milliseconds (3 x 15
p50832
aV625 msec)
p50833
aVYou can't even reliably compete with user mode threads that boosted their priority and take their sweet old time
p50834
aVIf a bigger buffer is not an option then you are looking at a device driver to get this kind of service guarantee
p50835
aVOr something in between that can provide a larger buffer
p50836
as(dp50837
g9
V17034
p50838
stp50839
a((dp50840
g2
(lp50841
VYour code is corrupting the heap
p50842
aVThe first snippet is from the C runtime library, the assert is telling you that your program is passing a bad pointer value to the delete operator
p50843
aVCommenting out the delete statements merely hides the problem
p50844
aVIt will come back to haunt you a different way when you keep developing the program
p50845
aVThere are some debugging tips in this thread
p50846
aVLearning how to catch these kind of bugs is a rite of passage for any C or C++ programmer
p50847
aVWelcome to the group
p50848
as(dp50849
g9
V17034
p50850
stp50851
a((dp50852
g2
(lp50853
VA service cannot ask for a UAC elevation
p50854
aVIt sounds to me that the UAC prompt you describe is actually requested by the installer, not the service
p50855
aVServices normally run with a very privileged account already, LocalSystem by default
p50856
aVDo make sure that you configure the service to use such a privileged account, not a restricted user account
p50857
as(dp50858
g9
V17034
p50859
stp50860
a((dp50861
g2
(lp50862
Vif (
p50863
aVFile
p50864
aVExists("chart
p50865
aVsdf"))
p50866
aVYou seem to want to create the database in the same directory as your program
p50867
aVYes, that will work on your dev machine but that's not going to work on a regular machine
p50868
aVThe typical install directory (c:\u005cprogram files\u005cetc) does not permit write access to files
p50869
aVYou will need to use Environment
p50870
aVGetFolderPath() to get an ApplicationData directory that you can write to
p50871
aVIt is often a lot easier and less error prone to let an installer create the appdata directory and copy the initial
p50872
aVsdf file in there
p50873
aVAlbeit that Setup projects are not supported by the Express edition
p50874
aVThere does come a point where hacking code to work around the Express edition's restrictions is defeating the price of the product license
p50875
aVYou're pretty close here
p50876
as(dp50877
g9
V17034
p50878
stp50879
a((dp50880
g2
(lp50881
VIt is fairly unwise, the CLR cannot find the DLL without help
p50882
aVYour customer won't care much about the location of the DLL
p50883
aVIn fact, I think most IT staff prefer binaries in the same directory
p50884
aVIf you put the DLL in a c:\u005capp\u005cbin\u005cdll subdirectory then you can use an app
p50885
aVexe
p50886
aVconfig file with the  element to tell the CLR to look in that directory
p50887
aVDeploying to c:\u005capp\u005cdll is much harder, it requires a very unpractical  in a
p50888
aVWhich makes the app unmovable, prefer Pierre's solution instead
p50889
aVExcept that it needs work, you want to use Assembly
p50890
aVGetEntryAssembly()
p50891
aVLocation to get the install path of the EXE so that you can generate a relative path off that
p50892
as(dp50893
g9
V17034
p50894
stp50895
a((dp50896
g2
(lp50897
VI rubbed my crystal ball and it revealed that you are using a USB driver that emulates a serial port, that the user decided it was a good idea to kill the process because she jerked the USB connector out of the socket and that she is running a pre-Vista version of Windows
p50898
aVRoughly any two combinations out of that list
p50899
aVYes, doesn't work, you cannot kill a process when it has a kernel thread going that is completing an I/O request that cannot finish
p50900
aVYou can tell from TaskMgr
p50901
aVexe when you use View + Select Columns and tick Handles
p50902
aVThe process will zombie with one handle opened
p50903
aVWon't close until the driver actually lets go
p50904
aVWon't happen, USB drivers suck like that
p50905
aVStarting the program again will bomb, the first instance of the process still has the port opened
p50906
aVAccess denied
p50907
aVTell the user to keep her hands off the connector
p50908
aVOr buy another one from a different manufacturer
p50909
aVYou can help by adding a "Safely Remove Hardware" menu option to your program
p50910
aVThat calls the SerialPort
p50911
aVClose() method
p50912
aVCall Sleep(2500) and display a message box that it is okay to unplug it
p50913
as(dp50914
g9
V17034
p50915
stp50916
a((dp50917
g2
(lp50918
VUse Marshal
p50919
aVSizeOf:
p50920
as(dp50921
g9
V17034
p50922
stp50923
a((dp50924
g2
(lp50925
VYes, your string contains lots of ligatures that cannot be represented in the 1256 code page
p50926
aVYou'll have to decompose the string before writing it
p50927
aVLike this:
p50928
as(dp50929
g9
V17034
p50930
stp50931
a((dp50932
g2
(lp50933
VThe P/Invoke marshaller isn't going to complain when the uint gets too big, you'll just end up with a negative int
p50934
aVThe extra layer does allow you to use the checked keyword to generate an OverflowException
p50935
aVWhich is fairly desirable
p50936
aVWhether it is worth the hassle is a secondary question
p50937
aVLots of APIs, like Win32, use unsigned as a logical constraint
p50938
aVLike the length of the string or the size of a block of memory, it can never be negative
p50939
aVIn practice, such a number can never overflow
p50940
aVBecause it isn't possible to allocate that much memory
p50941
aVI can't remember running once in an API where it was a slam-dunk that uint should be used
p50942
aVAs such, I think you're fine just using a straight pinvoke declaration with ints
p50943
as(dp50944
g9
V17034
p50945
stp50946
a((dp50947
g2
(lp50948
VYes, kill the other process
p50949
aVAn OS otherwise of course does not provide a way to allow you to open a locked file, that would utterly defeat the point of supporting locking
p50950
aVFwiw, a pretty common mistake is to try to open a file that another process has opened for writing and specifying only read sharing
p50951
aVCan't work, the other process already gained write access
p50952
aVYou must specify read+write sharing
p50953
as(dp50954
g9
V17034
p50955
stp50956
a((dp50957
g2
(lp50958
VLaunch will start a debugger when one is available
p50959
aVBut is just ignored if there is none available
p50960
aVBreak will crash the program if no debugger is available
p50961
as(dp50962
g9
V17034
p50963
stp50964
a((dp50965
g2
(lp50966
VThis is the declaration for the TextBoxBase
p50967
aVText property:
p50968
aVThe [Editor] attribute is what you need
p50969
aVThere is hassle if you also use
p50970
aVNET 4
p50971
aV0 (note the version string)
p50972
aVIt is better to use the alternative version of the constructor
p50973
aVProject + Add Reference, select System
p50974
aVDesign
p50975
aVMake it look like this:
p50976
as(dp50977
g9
V17034
p50978
stp50979
a((dp50980
g2
(lp50981
VI do measure a slowdown on this code, XP draws the listview in about 47 msec, Win7 needs about 96 msec, roughly twice as slow
p50982
aVNot sure if that deserves the 'hell' moniker
p50983
aVI don't know what causes it but don't doubt that Aero has something to do with it
p50984
aVTurning it off isn't exactly a desirable option
p50985
aVLuckily you made a mistake in your code, one that costs 48 msec in my measurements
p50986
aVGiving you back the exact perf you had on XP
p50987
aVYou re-use the same ListViewItem, you're supposed to create a new one
p50988
aVAdd this line of code to the RetrieveVirtualItem event handler:
p50989
aVAnd get rid of the field
p50990
as(dp50991
g9
V17034
p50992
stp50993
a((dp50994
g2
(lp50995
VJust an explanation for why this exception is thrown
p50996
aVYou can repro the exception with this sample Windows Forms app
p50997
aVStart by adding a setting named "Setting" of type StringCollection
p50998
aVClick the dots in the Value column and enter a couple of strings
p50999
aVMake the form class code look like this:
p51000
aVDebug + Exceptions, tick the Thrown checkbox for CLR exceptions
p51001
aVRun the form and close it, the debugger will stop when the exception is thrown
p51002
aVThe top of the call stack looks like this:
p51003
aVYou can see the XmlSerializer class hunting for an assembly that contains the XML serializer for the StringCollection class
p51004
aVThe LoadGeneratedAssembly method looks like this with the boring bits removed:
p51005
aVAnd Compiler
p51006
aVGetTempAssemblyName():
p51007
aVThis GetTempAssemblyName is the evil-doer in this case
p51008
aVThe StringCollection class lives in the System
p51009
aVdll assembly, the method generates the name "System
p51010
aVXmlSerializers"
p51011
aVThis method is designed to find the assembly for your own classes, the one generated by Sgen
p51012
aVexe
p51013
aVLike WindowsApplication1
p51014
aVXmlSerializers
p51015
aVdll for your sample program
p51016
aVBut StringCollection is a class in the
p51017
aVNET Framework, the assembly name it generates just isn't valid
p51018
aVThere isn't actually a "System
p51019
aVXmlSerializers
p51020
aVdll" assembly in the framework
p51021
aVFeedback reports about this behavior at connect
p51022
aVmicrosoft
p51023
aVcom have all been closed with "By Design"
p51024
aVIt was, the original designers considered the cost of preventing the exception too high and decided to just catch the exception
p51025
aVWhich all works fine, the exception is indeed caught
p51026
aVYou just happen to see it because you got the Thrown checkbox turned on in the Debug + Exceptions dialog
p51027
aVMaking the Xml serialization code behave differently here is not an option
p51028
aVIt would have been easy enough for them to simply filter out types in the System
p51029
aVdll assembly, but that's a potentially never-ending battle, there are a lot more assemblies in the framework
p51030
aVA workaround is to use your own class to store the setting instead of using a StringCollection
p51031
as(dp51032
g9
V17034
p51033
stp51034
a((dp51035
g2
(lp51036
VThe error code ix 0x80131040
p51037
aVThat's a code that matches a
p51038
aVNET exception, a very common one
p51039
aVThe located assembly's manifest definition does not match the assembly reference
p51040
aVI'm surprised you don't get a message for it, you might want to review your error handling code
p51041
aVAnyhoo, you've got a bit of DLL Hell going on, the CLR is finding an assembly whose [AssemblyVersion] or PublicKeyToken doesn't match the reference assembly that was used to build the code
p51042
aVGiven that this is associated with a strong named assembly, you might have signed the assembly after building the code
p51043
aVIn which case simply removing the assembly reference from your project and adding it back, now selecting the strong named assembly, will fix the problem
p51044
aVBut no need to guess at this, the Fuslogvw
p51045
aVexe utility will tell you exactly what is going wrong
p51046
aVRun it first to get a trace of the binding attempt and the reason it failed
p51047
as(dp51048
g9
V17034
p51049
stp51050
a((dp51051
g2
(lp51052
VI just looked at the bootstrapper that was installed when I put Visual Studio 2010 on my machine
p51053
aVIt is in the SDK directory (c:\u005cprogram files\u005cmicrosoft sdks\u005cwindows\u005c7
p51054
aV0a)
p51055
aVThe Bootstrapper directory there contains a bunch of them, the ones you get to choose from when you create a VS Setup project and select the prerequisites
p51056
aVOn my machine, the package file is in vstor40\u005cen\u005cpackage
p51057
aVxml
p51058
aVThe fwlink declared there for the x64 version is
p51059
aVhttp://go
p51060
aVmicrosoft
p51061
aVcom/fwlink/
p51062
aVLinkId=158918
p51063
aVGiven the ready availability of these bootstrappers in VS, I seriously doubt Microsoft has any problem with you actually using them
p51064
as(dp51065
g9
V17034
p51066
stp51067
a((dp51068
g2
(lp51069
VDo not add the control to the toolbox yourself
p51070
aVThis puts a copy of the assembly in a private directory
p51071
aVYes, this copy does not get updated automatically, you get the old control
p51072
aVRely on the "Auto toolbox populate" setting
p51073
aVIt automatically adds any controls you have in your loaded project(s) to the toolbox
p51074
aVThe added controls are at the top of the toolbox
p51075
as(dp51076
g9
V17034
p51077
stp51078
a((dp51079
g2
(lp51080
VYes, base64 is not very efficient
p51081
aVThe assumption here is that you could encode the byte[] yourself in a different way and save space
p51082
aVMaybe a run-length encoding
p51083
aVMaybe you can gzip the array and base64 encode the compressed data
p51084
aVSomething like that
p51085
as(dp51086
g9
V17034
p51087
stp51088
a((dp51089
g2
(lp51090
VNo, that's accurate
p51091
aVNote the Scope column in the Setting Designer
p51092
aV"Application" is used for setting values that go into app
p51093
aVexe
p51094
aVconfig
p51095
aV"User" should be used for settings that can be modified and saved back
p51096
aVThey go in a separate file named user
p51097
aVconfig which is stored in a subdirectory of AppData
p51098
aVIt needs to work this way because you normally need admin privileges to modify the app
p51099
aVexe
p51100
aVconfig file
p51101
aVIt must be stored in the same directory as the EXE
p51102
aVThe normal install location (c:\u005cprogram files\u005csomething) is read-only for restricted user accounts or admin accounts with UAC turned on
p51103
as(dp51104
g9
V17034
p51105
stp51106
a((dp51107
g2
(lp51108
VThe resource compiler uses the C pre-processor
p51109
aVYou can simply use a #define in a header file you #include in your
p51110
aVrc file
p51111
aVOr use the /D command line option for rc
p51112
aVexe
p51113
aVYou can use the macro symbol in your resource definition
p51114
as(dp51115
g9
V17034
p51116
stp51117
a((dp51118
g2
(lp51119
VSorry, but it is completely impossible to make using DoEvents safe here
p51120
aVNothing good is going to happen when the user closes the form while your animation is going
p51121
aVIt will crash the program with an ObjectDisposed exception
p51122
aVMaking DoEvents safe requires setting the form's Enabled property to false so that the user cannot accidentally cause mishaps like this
p51123
aVA control can not reasonable set the form's Enabled property to false, especially not for an animation
p51124
aVThe workaround is simple enough, just use a Timer with an Interval of 15 msec
p51125
aVPlenty fast enough to make the animation look smooth
p51126
aVYou'll find sample code that does this in my answer in this thread
p51127
as(dp51128
g9
V17034
p51129
stp51130
a((dp51131
g2
(lp51132
VYou might want to take a look at the ComVisibleAttribute class to learn more about the ways you can make managed classes available to unmanaged code
p51133
aVThe [Guid] is the exact equivalent to the
p51134
aVNET Type
p51135
aVAssemblyQualifiedName
p51136
aVLike
p51137
aVWith the obvious distinction that the
p51138
aVNET type name is easier to read by a human
p51139
aVIt is necessary to allow a program to discover what DLL needs to be loaded to use a type
p51140
aVIn the
p51141
aVNET case, the assemblies are (usually) found by enumerating the GAC
p51142
aVIt is file based
p51143
aVCOM however uses the registry
p51144
aVAfter that assembly whose source code you looked at gets built and registered then you can find back the [Guid] in the registry
p51145
aVFire up regedit
p51146
aVexe and navigate to
p51147
aVYou'll see the registration key values that the runtime uses to load the CLR and the assembly
p51148
as(dp51149
g9
V17034
p51150
stp51151
a((dp51152
g2
(lp51153
VA ThreadAbortException is highly non-specific
p51154
aVHttpWebRequest already supports a way to cancel the request in a predictable way with the Abort() method
p51155
aVI recommend you use it instead
p51156
aVNote that you'll still get a WebException on the thread, designed to tell you that the request got aborted externally
p51157
aVBe prepared to catch it
p51158
as(dp51159
g9
V17034
p51160
stp51161
a((dp51162
g2
(lp51163
VThere's an extensive automation interface for Virtual Server, but not for Virtual PC
p51164
aVI don't have it installed on my machine to help you find it
p51165
aVBut you can probably find it yourself
p51166
aVFire up regedit
p51167
aVexe and navigate through HKCR
p51168
aVThere should be a ProgId named some similar to "VirtualMachine
p51169
aVApplication"
p51170
aVNote the CLSID guid
p51171
aVNavigate to  and note the InProcServer32 key value
p51172
aVThat should be the DLL that you can browse to in the Browse tab of the Add Reference dialog
p51173
as(dp51174
g9
V17034
p51175
stp51176
a((dp51177
g2
(lp51178
VTerribly vague question, but it sounds like you are using Visual Studio
p51179
aVRight-click your project, Properties, C/C++, Preprocessor, change "Generate Preprocessed File" to Yes
p51180
aVAfter you rebuild, you'll get the
p51181
aVi files with the preprocessor output in your project directory
p51182
as(dp51183
g9
V17034
p51184
stp51185
a((dp51186
g2
(lp51187
VYou cannot use a BackgroundWorker to animate this control
p51188
aVIt is an ActiveX control, it requires that you create it in your app's main thread
p51189
aVThe same thread that creates the form
p51190
aVThis is a very common restriction for controls in general, they do not support threading
p51191
aVThe linked thread does not solve your problem
p51192
aVYes, you can create your own STA thread by calling SetApartmentState() and specifying STA but now you cannot do anything with the Form that you created on the main thread
p51193
aVYou'll get an exception when you add the control to the form
p51194
aVThe child controls of a form must be created in the same thread as the form
p51195
aVThis should in general not be an issue
p51196
aVThe animation ought to be reasonably smooth as long as you keep the form's event handlers short and snappy
p51197
aVIf such an event handler needs to do something that takes a while (and freezes the animation as a result) then let a BGW perform that job
p51198
as(dp51199
g9
V17034
p51200
stp51201
a((dp51202
g2
(lp51203
VThe WM_SETCURSOR message automatically gets passed to the parent so you can handle it there
p51204
aVIf the child control actually handles it then you'll have to sub-class it
p51205
aVOr hack the message loop (yuck)
p51206
as(dp51207
g9
V17034
p51208
stp51209
a((dp51210
g2
(lp51211
VThe probing path for assemblies get to be a bit unpredictable when a unmanaged EXE starts the process
p51212
aVJust because it loaded a C++/CLI DLL, perhaps through LoadLibrary or SetDllDirectory, does not in any way affect the probing path for the CLR
p51213
aVBut that's just guessing
p51214
aVThere is no need to guess when you look at the output produced by Fuslogvw
p51215
aVexe
p51216
aVIt shows you exactly what is being probed and what policies are applied
p51217
aVYou fix the problem with an app
p51218
aVexe
p51219
aVconfig file (probing element) or indeed by AssemblyResolve
p51220
as(dp51221
g9
V17034
p51222
stp51223
a((dp51224
g2
(lp51225
VThe time_t typedef comes in two flavors, legacy 32-bits that will create the Y2K38 problem and 64-bits, the solution to that problem
p51226
aVYou've got a mismatch here
p51227
aVCheck the time
p51228
aVh header file of the CRT you use, there should be a #ifdef in it that selects between the legacy and the 64-bit version
p51229
aVAvoid using legacy if you still expect to be a programmer by 2038
p51230
as(dp51231
g9
V17034
p51232
stp51233
a((dp51234
g2
(lp51235
VThis is almost certainly an optimization
p51236
aVThe
p51237
aVNET framework code is pretty religious about checking arguments to let the programmer fall in the pit of success
p51238
aVBut that doesn't come for free
p51239
aVThe cost is fairly minuscule, many class methods take lots more machine cycles than is spent on the checking
p51240
aVBut arrays are special
p51241
aVThey are the very core data structure in the framework
p51242
aVAlmost every collection class is built on top of them
p51243
aVAny overhead put in the Array class directly impacts the efficiency of a lot of code that sits on top of it
p51244
aVAvoiding the check is okay, it gets implicitly checked anyway when the internal code needs to cast the value to unsigned
p51245
aVAnd it is very rare that it trips
p51246
aVSo checking it twice is not quite worth the better exception message
p51247
as(dp51248
g9
V17034
p51249
stp51250
a((dp51251
g2
(lp51252
VYou can hack OnPaintBackground() or you can hack WndProc()
p51253
aVEither requires deriving your own class
p51254
aVIt's trivial, I just don't see why you'd avoid it
p51255
aVThe long distance shot is SetWindowsHookEx() with a WH_CALLWNDPROC hook, too silly really
p51256
as(dp51257
g9
V17034
p51258
stp51259
a((dp51260
g2
(lp51261
VThe Main thread doesn't look idle
p51262
aVYour screen shot shows it current location at ECM
p51263
aVProgram
p51264
aVMain
p51265
aVThat can't be correct, if it is idle then it is inside Application
p51266
aVRun(), pumping the message loop
p51267
aVWhich is required for Invoke() to complete
p51268
aVDouble-click the main thread and switch to the Call Stack window to find out what it is really doing
p51269
as(dp51270
g9
V17034
p51271
stp51272
a((dp51273
g2
(lp51274
VIt is a low-level COM error, associated with RPC
p51275
aVThat gets normally used in out-of-process servers, but that doesn't sound like your setup
p51276
aVIt would also be used if you make calls on a COM interface from another thread
p51277
aVOne possible cause is that the thread that created the COM object was allowed to exit, calling CoUninitialize and tearing down the COM object
p51278
aVA subsequent call made from another thread would generate this error
p51279
aVGetting reference counting wrong (calling Release too often) could cause this too
p51280
aVTackle this by carefully tracing which threads create a COM object and how long they survive
p51281
as(dp51282
g9
V17034
p51283
stp51284
a((dp51285
g2
(lp51286
VThe corners are good, the gamma correction looks different
p51287
aVThe WPF LinearGradientBrush indeed has a GammaCorrection property
p51288
aVPlay with it
p51289
as(dp51290
g9
V17034
p51291
stp51292
a((dp51293
g2
(lp51294
VPAGE_NOCACHE is murder on perf, it disables the CPU cache
p51295
aVWas that intentional
p51296
as(dp51297
g9
V17034
p51298
stp51299
a((dp51300
g2
(lp51301
VThere are other processes in Windows that want a piece of that file
p51302
aVThe search indexer is an obvious candidate
p51303
aVOr a virus scanner
p51304
aVThey'll open the file for full sharing, including FILE_SHARE_DELETE, so that other processes aren't heavily affected by them opening the file
p51305
aVThat usually works out well, unless you create/write/delete at a high rate
p51306
aVThe delete will succeed but the file cannot disappear from the file system until the last handle to it got closed
p51307
aVThe handle held by, say, the search indexer
p51308
aVAny program that tries to open that pending-delete file will be slapped by error 5
p51309
aVThis is otherwise a generic problem on a multitasking operating system, you cannot know what other process might want to mess with your files
p51310
aVYour usage pattern seems unusual, review that first
p51311
aVA workaround would be to catch the error, sleep and try again
p51312
as(dp51313
g9
V17034
p51314
stp51315
a((dp51316
g2
(lp51317
VThe [AssemblyVersion] is a very big deal in
p51318
aVNET
p51319
aVOne philosophy, encouraged by Microsoft is that you let it auto-increment, forcing all projects that depend on the assembly to be recompiled
p51320
aVWorks okayish if you use a build server
p51321
aVIt is never the wrong thing to do but beware of people carrying swords
p51322
aVThe other one, more closely associated with its actual meaning is that the number is representative for the versioning of the public interface of the assembly
p51323
aVIn other words, you only change it when you alter a public interface or class
p51324
aVSince only such a change requires clients of the assembly to be recompiled
p51325
aVThis needs to be done manually though, the build system isn't smart enough to auto-detect such a change
p51326
aVYou can further extend this approach by only incrementing the version when the assembly was deployed on machines outside of your reach
p51327
aVThis is the approach that Microsoft uses, their
p51328
aVNET assemblies version numbers very rarely change
p51329
aVMostly because of the very considerable pain it causes on their customers
p51330
aVSo what Microsoft preaches is not what it practices
p51331
aVIts build process and versioning control is however unparalleled, they even have a dedicated software engineer that monitors the process
p51332
aVDidn't quite work out so well, the WaitHandle
p51333
aVWaitOne(int) overload in particular caused a fair amount of pain
p51334
aVFixed in
p51335
aVNET 4
p51336
aV0 with a very different approach, but that's getting a bit beyond the scope
p51337
aVIt is rather up to you and your confidence in how well you can control the build process and the release cycles to make your own choice
p51338
aVOther than that, auto-incrementing the [AssemblyFileVersion] automatically is very appropriate
p51339
aVWith however the inconvenience that this is not supported
p51340
as(dp51341
g9
V17034
p51342
stp51343
a((dp51344
g2
(lp51345
VYeah, you're doing it backwards
p51346
aVThe IDE generates the
p51347
aVconfig file contents from the settings you define in the Settings designer
p51348
aVThat doesn't work the other way around
p51349
aVIf getting the connection string valid straight from the build is important then set the default in the Settings designer
p51350
aVOr don't store it in a setting
p51351
as(dp51352
g9
V17034
p51353
stp51354
a((dp51355
g2
(lp51356
VThe Console Application project template that you started with does not have the necessary assembly references
p51357
aVProject + Add Reference and select System
p51358
aVDrawing and System
p51359
aVWindows
p51360
aVForms
p51361
aVAlso be sure to make the necessary changes in the Program class
p51362
aVMain() must have the [STAThread] attribute and you need to add the boilerplate code to enable visual styles and start the message loop
p51363
aVTake a look at a sample Windows Forms project to get that right
p51364
as(dp51365
g9
V17034
p51366
stp51367
a((dp51368
g2
(lp51369
VString
p51370
aVContains() follows a torturous route through System
p51371
aVGlobalization
p51372
aVCompareInfo into the CLR and the NLS support sub-system where I thoroughly got lost
p51373
aVThis contains highly optimized code with impressive perf
p51374
aVThe only way to do it faster is through pinvoking the standard CRT function wcsstr, available in msvcrt
p51375
aVdll
p51376
aVIt returns IntPtr
p51377
aVZero if the string wasn't found
p51378
aVI made some measurements, using String
p51379
aVIndexOf() instead of Contains() to test the various string comparison options
p51380
aVAll times are in nanoseconds, searching for a string of 7 characters in a string of 60 characters
p51381
aVWith the string not present so worst case is measured
p51382
aVThe lowest time out of a sample of 20 was used:
p51383
aVVery impressive numbers and on par with what you'd expect these functions to require
p51384
aVThe wcsstr() function does the same kind of ordinal comparison as String
p51385
aVCompare()
p51386
aVIt is only 13% faster, a statistically insignificant improvement given that real perf is not likely to approach these measurements due to the effects of CPU cache locality
p51387
aVI can only conclude that you're going about as fast as you can expect
p51388
aVWhether the slight improvement from wcsstr is worth it is up to you
p51389
as(dp51390
g9
V17034
p51391
stp51392
a((dp51393
g2
(lp51394
VIt already works this way by default
p51395
aVThe UI thread exception handling method is controlled by Application
p51396
aVSetUnhandledExceptionMode()
p51397
aVThe default is UnhandledExceptionMode
p51398
aVCatchException so that the ThreadException event is raised and, by default, creates a ThreadExceptionDialog
p51399
aVHowever, if a debugger is attached then it overrides this mode
p51400
aVSo that an exception will always be unhandled if there is no active catch clause
p51401
aVSo that the debugger will stop, allowing you to diagnose the problem
p51402
aVBy writing your own try/catch, you prevent this from working
p51403
aVDo beware that OnPaint() can be special, particularly for PictureBox
p51404
aVIt has a try/catch clause, catching an unhandled exception and painting a red cross
p51405
aVThis is a bit unusual but necessary because it supports the ImageLocation property
p51406
aVWhich lets it display images from a potentially unreliable network source
p51407
aVThe best way to trouble-shoot exceptions in that case is with Debug + Exceptions, tick the Thrown checkbox
p51408
aVThis forces the debugger to always stop on an exception, even if it isn't unhandled
p51409
as(dp51410
g9
V17034
p51411
stp51412
a((dp51413
g2
(lp51414
VThis string is baked into Common7\u005cIDE\u005c1033\u005cmsvb7ui
p51415
aVdll
p51416
aVIn other words, it is hard-coded in the binary code that implements the VB
p51417
aVNET IDE
p51418
aVThis is also the case for the auto-generated code when you implement IDisposable
p51419
aVMuch worse actually since that code is inappropriate 99
p51420
aV9% of the time
p51421
aVIf it really annoys you, you could use File + Open + File and navigate to the DLL
p51422
aVOpen the string table and double-click "String Table"
p51423
aVIt is string #1059
p51424
aVNote that you cannot change the line spacing or the comment
p51425
aVDo make sure you make a backup of the file, I didn't try it myself
p51426
as(dp51427
g9
V17034
p51428
stp51429
a((dp51430
g2
(lp51431
VThe impedance mismatch is severe
p51432
aVYou have to write a wrapper in the C++/CLI language so that you can construct a vector
p51433
aVAn additional problem is Point, your C++ declaration for it is not compatible with the managed version of it
p51434
aVYour code ought to resemble this, add it to a class library project from the CLR node
p51435
aVDo note the cost of copying the collection, this can quickly erase the perf advantage you might get out of writing the algorithm in native C++
p51436
as(dp51437
g9
V17034
p51438
stp51439
a((dp51440
g2
(lp51441
VNo, it is raised on the thread that created the WebBrowser, the one that's also pumping the message loop that keeps events on WebBrowser alive
p51442
aVCalling Navigate() from a worker thread is technically possible but unwise if you want to keep your ducks in a row
p51443
as(dp51444
g9
V17034
p51445
stp51446
a((dp51447
g2
(lp51448
VYour AttachThreadInput() hack is (I think) a known way to defeat the focus stealing counter-measures in Windows
p51449
aVYou are using the wrong handle though, you want to attach to the thread that currently has the focus
p51450
aVWhich won't be hApp, you wouldn't need this code otherwise
p51451
aVUse GetForegroundWindow() to get the handle to the window with the focus
p51452
aVAlthough I think the 2nd argument needs to be thread ID of hApp
p51453
aVBecause you don't want to shove your own window if I understood correctly
p51454
aVNot sure if that can work
p51455
as(dp51456
g9
V17034
p51457
stp51458
a((dp51459
g2
(lp51460
VThis requires patching the Win32 CreateFile API function
p51461
aVWhich is merely technically possible with Detours from Microsoft Research
p51462
aVWhich requires unmanaged C or C++
p51463
aVTackle this problem at the source, having hard-coded path names in source code is unreasonable
p51464
as(dp51465
g9
V17034
p51466
stp51467
a((dp51468
g2
(lp51469
VA ListBox can store more than just strings, it can also store objects
p51470
aVYou want to take advantage of that here, the list item in your case has more state than just the text
p51471
aVAdd a little nested helper class:
p51472
aVNote how the ToString() override generates the text that the user sees
p51473
aVNow just add items to the listbox like this:
p51474
aVAnd cast the object back to your class in the DrawItem event handler:
p51475
aVAnd use obj
p51476
aVType to determine colors
p51477
as(dp51478
g9
V17034
p51479
stp51480
a((dp51481
g2
(lp51482
VYes, a Panel control
p51483
aVSet AutoScrollMinSize to the minimum size you want before scrollbars appear
p51484
aVSet AutoScroll to True
p51485
aVSet MinimumSize if necessary, it shouldn't be
p51486
aVThe controls inside the panel need to auto layout by themselves so they'll move as necessary when the panel gets smaller
p51487
aVUse their Dock or Anchor properties
p51488
aVIf the layout gets complicated then switch to a TableLayoutPanel or FlowLayoutPanel control
p51489
as(dp51490
g9
V17034
p51491
stp51492
a((dp51493
g2
(lp51494
VTo debug your program with command line arguments, use Project + Properties, Debugging, Command Arguments setting
p51495
aVClick around some more to get familiar with what's there, you'll need it sooner or later
p51496
aVPress F1 if things sound mysterious
p51497
as(dp51498
g9
V17034
p51499
stp51500
a((dp51501
g2
(lp51502
VThe BackgroundWorker
p51503
aVReportProgress() method was intended to do that
p51504
aVYou implement the ProgressChanged event to update the UI, it will run on the main thread
p51505
aVYou're not restricted to report just a progress percentage, you can pass any object as well to pass info to the event handler by using the overload that accepts the userState argument
p51506
aVBeware that you have to use proper locking if you do that
p51507
as(dp51508
g9
V17034
p51509
stp51510
a((dp51511
g2
(lp51512
VDon't guess at the cause of the error, let
p51513
aVNET tell you
p51514
aVWrite an event handler for AppDomain
p51515
aVCurrentDomain
p51516
aVUnhandledException and display or log the value of e
p51517
aVExceptionObject
p51518
aVToString()
p51519
aVYou may need to know the InnerException as well in this case since the constructor failed
p51520
aVCast e
p51521
aVExceptionObject to Exception
p51522
aVIf you can't make sense of the stack trace and the exception message then copy/paste it into your question
p51523
as(dp51524
g9
V17034
p51525
stp51526
a((dp51527
g2
(lp51528
VYes, it is tricky
p51529
aVThe offset you see for the CALL instruction is bogus
p51530
aVPlus it won't let you navigate to an unmanaged code address when the current focus is on a managed function
p51531
aVStart by enabling unmanaged code debugging and setting a breakpoint on the call
p51532
aVRun the code and when the break point hits use Debug + Windows + Disassembly:
p51533
aVThe debugger tries to display the absolute address but gets it wrong because it uses the bogus incremental address instead of the real instruction address
p51534
aVSo first recover the true relative value: 0x6E53D5D0 - 0x2A = 0x6E53D5A6
p51535
aVNext you need to find the real code address
p51536
aVDebug + Windows + Registers and look at the value of the EIP register
p51537
aV0x009A0095 in my case
p51538
aVAdd 5 to get to the nop, then add the relative offset: 0x9A0095 + 5 + 0x6E53D5A6 = 0x6EEDD640
p51539
aVThe real address of the function
p51540
aVDebug + Windows + Call Stack and double-click an unmanaged stack frame
p51541
aVNow you can enter the calculated address in the Disassembly window's Address box, prefix with 0x
p51542
aVBingo, you're know you're good if you see the stack frame setup code
p51543
aVSet a breakpoint on it and press F5
p51544
aVOf course, you'll be stepping machine code since there's no source code available
p51545
aVYou'll get much better insight in what this code is doing by looking at the SSCLI20 source code
p51546
aVNo guarantee that it will be a match for the actual code in your current version of the CLR but my experience is that these low-level code chunks that have been around since 1
p51547
aV0 are highly conserved
p51548
aVThe implementation is in clr\u005csrc\u005cclasslibnative\u005cnls, not sure which source code file
p51549
aVIt won't be named "nativeCompareOrdinal", that's just an internal name used by ecall
p51550
aVcpp
p51551
as(dp51552
g9
V17034
p51553
stp51554
a((dp51555
g2
(lp51556
VIt is the "Control" system color
p51557
aVBattleship gray by default
p51558
aVIn code:
p51559
as(dp51560
g9
V17034
p51561
stp51562
a((dp51563
g2
(lp51564
VThe CreateDispatch call uses late binding to talk to the COM server
p51565
aVClassInterfaceType
p51566
aVAutoDispatch
p51567
aVUsing AutoDual is fine, that also includes late binding support
p51568
aVWith the significant advantage that you can make it a lot faster some day
p51569
aVLate binding isn't cheap
p51570
as(dp51571
g9
V17034
p51572
stp51573
a((dp51574
g2
(lp51575
VSelect all the projects in your solution
p51576
aVProject + Properties, C/C++, Preprocessor, Preprocessor Definitions
p51577
aVAdd
p51578
aVYou can now test the SOLUTION macro value in your source code
p51579
as(dp51580
g9
V17034
p51581
stp51582
a((dp51583
g2
(lp51584
VReading the Visible property gives you the actual visibility state of the control, not the 'intended' state
p51585
aVWhich will always be false in the InitializeComponent() method, the form or control isn't visible yet until after the Load event runs
p51586
aVIt will also be false if the container control isn't visible
p51587
as(dp51588
g9
V17034
p51589
stp51590
a((dp51591
g2
(lp51592
VStarting and stopping services requires admin privileges
p51593
aVYou cannot bypass UAC with impersonation, you have to display the elevation prompt
p51594
aVThis answer shows you how
p51595
as(dp51596
g9
V17034
p51597
stp51598
a((dp51599
g2
(lp51600
VYes, getting a deadlock when unlocking the work station is a pretty infamous Windows Forms threading problem
p51601
aVI never got a good diagnosis for this but I'm fairly sure it is caused by the SystemEvents class
p51602
aVIt is a program initialization problem, the class gets initialized on demand when controls start subscribing to its events
p51603
aVI think the failure mode is creating the first form on a thread other than the program's main thread
p51604
aVYou'd get this when, say, you create your own splash screen instead of using the
p51605
aVNET one
p51606
aVOr spinning up a thread that creates its own form instance and starting it too soon
p51607
aVAs a result, SystemEvents will fire its events from the wrong thread
p51608
aVThe SystemSwitch event is somehow lethal
p51609
aVSo, look at your startup code with a fine-toothed comb
p51610
aVSubscribing to one of the system events in your Main() method before doing anything important ought to be a Q&D; fix
p51611
as(dp51612
g9
V17034
p51613
stp51614
a((dp51615
g2
(lp51616
VThe best interop library available is the
p51617
aVNET Framework
p51618
aVUser32
p51619
aVdll is wrapped very well by Windows Forms
p51620
aVThe Windows API code pack concentrates on wrapping API additions made in Vista and Win7
p51621
aVThose were not additions to user32, mostly shell stuff
p51622
aVYou'll probably get a better answer if you can be specific about exactly what user32 APIs you want to use
p51623
aVAfter seeing edit: what you are trying to do is explicitly forbidden by the Win32 SDK documentation
p51624
aVThe parent of a window must belong to the same process
p51625
aVThere are however some appcompat hacks in Windows, designed to support Windows 3
p51626
aVx programs where this restriction did not exist
p51627
aVBecause it didn't support threading
p51628
aVYou can try, but beware you'll void the warranty
p51629
aVP/Invoke SetParent()
p51630
aVVisit pinvoke
p51631
aVnet for the declaration you'll need
p51632
as(dp51633
g9
V17034
p51634
stp51635
a((dp51636
g2
(lp51637
VSystem
p51638
aVDllNotFoundException: Unable to load DLL 'xpcom'
p51639
aVYour program has a dependency on unmanaged DLL(s), the ones that implement the browser
p51640
aVVisual Studio cannot find these dependencies automatically
p51641
aVXpcom
p51642
aVdll is indeed one of the components that get used in Firefox
p51643
aVThere are probably some additional ones
p51644
aVYou need to find the deployment instructions for the gecko library you are using
p51645
aVTo get these DLLs published, use Project + Add Existing Item and navigate to the DLL
p51646
aVThe Build Action property for the item should be set to "Content", it is by default
p51647
as(dp51648
g9
V17034
p51649
stp51650
a((dp51651
g2
(lp51652
VThe events are listed in the IntelliSense popup window you'll get when you type the class reference variable name followed by a dot
p51653
aVThey have a lightning bolt icon
p51654
aVMany more organized ways to know what a class can do
p51655
aVYou could read its documentation
p51656
aVOr browse its source code
p51657
aVOr use Reflector if there isn't any
p51658
as(dp51659
g9
V17034
p51660
stp51661
a((dp51662
g2
(lp51663
VPretty vague
p51664
aVFocus stealing is something users dislike a lot and Windows actively prevents
p51665
aVJust implement the Activated event of the form and have the event handler set the focus
p51666
as(dp51667
g9
V17034
p51668
stp51669
a((dp51670
g2
(lp51671
VThis is a property of the COM server itself
p51672
aVThe value it passes for the flags argument in the CoRegisterClassObject() call
p51673
aVSounds like it is passing REGCLS_MULTIPLEUSE, which is not uncommon since it can be expensive to start a new process for each individual client
p51674
aVThe client cannot change that behavior
p51675
aVYou'll need help from the vendor, maybe there's a configuration file
p51676
as(dp51677
g9
V17034
p51678
stp51679
a((dp51680
g2
(lp51681
VYou didn't include Assembly
p51682
aVCreateInstance() in your list
p51683
aVDifference there is that it will be happy with just the Type
p51684
aVFullName to create the object
p51685
aVYou have to give Activator
p51686
aVCreateInstance the 'fully qualified typename' so it can find the proper assembly to load
p51687
aVDepends if you already have the assembly reference
p51688
aVBut these are equivalent:
p51689
aVAppDomain
p51690
aVCreateInstance() is a whole different ballgame
p51691
aVAppDomains are mainly important in custom CLR hosts like ASP
p51692
aVNET and SQL Server
p51693
aVA subset are apps that support plug-ins
p51694
aVAn AD is similar to a process in Windows, they isolate chunks of code so that they cannot destabilize each other
p51695
aVA Windows process accomplishes that by giving each process a completely separate view of memory, strongly enabled by the processor's support for virtual memory
p51696
aVAn AD is the exact same analogue, each AD has its own garbage collected heap and its own loader heap
p51697
aVWhich allows isolating chunks of managed code, each running in their own AD, so they cannot destabilize the host
p51698
aVThe win here is that creating an AD is a lot cheaper than creating a process
p51699
aVPretty important in the quest to kick LAMP ass
p51700
aVJust as there's a need to scale the wall that Windows puts up between processes so they can interact, there's a way and need in
p51701
aVNET as well
p51702
aVAppDomain
p51703
aVCreateInstance
p51704
aVThe actual plumbing isn't very relevant here, the difference between MarshalByRefObject and objects that are marshaled by value is very opaque and worthy of a question by itself perhaps
p51705
aVThe difference between the two you listed is small
p51706
aVCreateInstanceAndUnWrap is a convenience method because that's what you'd normally want to do
p51707
aVGet a proxy reference or copy of the object in the other AD and it better not fail
p51708
aVAppDomain
p51709
aVCreateInstance() lets you first test if the marshaling was successful, avoiding the exception that unwrapping would cause when CreateInstance returns a null ObjectHandle
p51710
as(dp51711
g9
V17034
p51712
stp51713
a((dp51714
g2
(lp51715
VThe
p51716
aVobj file format is highly conserved between VS2005 and VS2010
p51717
aVThis should not be a problem, especially since it is a simple non-mangled symbol reference
p51718
aVAnd especially not when it works in the Release configuration but not in Debug
p51719
aVA simple explanation is always better than a convoluted one: your customer simply forgot to add your
p51720
aVlib file to the linker's Additional Dependencies setting
p51721
aVBeware that the setting change needs to be made for both configurations, use the "Configuration" combo in the upper left corner of the dialog
p51722
aVYou can help your customer fall into the pit of success by using #pragma comment(lib, "mumble
p51723
aVlib") in your
p51724
aVh file
p51725
as(dp51726
g9
V17034
p51727
stp51728
a((dp51729
g2
(lp51730
VThe auto-generated files:
p51731
aVAssemblyInfo
p51732
aVcs : the attributes inside it are set by Project + Properties, Application Tab, Assembly Information button
p51733
aVEditing the file directly is okay, the IDE doesn't easily get confused by it
p51734
aVSettings
p51735
aVDesigner
p51736
aVcs : auto-generated from the Settings
p51737
aVsettings file which in turn is generated from the Settings designer
p51738
aVAny edits to this file will be lost quickly
p51739
aVResources
p51740
aVDesigner
p51741
aVcs : auto-generated from the Resources
p51742
aVresx file which in turn is generated from the Resources designer
p51743
aVAny edits to this file will be lost quickly
p51744
aVForm
p51745
aVDesigner
p51746
aVcs : auto-generated by the form designer
p51747
aVEditing this file is possible, there is no independent file that stores the form layout
p51748
aVThe design view is generated by running this code at design time and using Reflection to recover the form and control properties
p51749
aVAnd saved again when you close the designer, it re-generates the
p51750
aVInitializeComponent method and the control variables
p51751
aVGetting your code changes to survive this process requires writing the code exactly the way the designer itself would
p51752
aVWhich is fairly untrivial when you make changes beyond simple property value changes
p51753
aVThere's also considerable risk, an unwise change can easily cause an exception
p51754
aVWhen that happens at design time, you get the infamous WSOD (White Screen Of Darn) which displays an often very cryptic exception and tells you that you cannot design your form anymore
p51755
aVYou can learn more about the way the designer generates code by observing the changes it makes to InitializeComponent when you modify the form in the designer
p51756
aVGetting this right is certainly not beginner material, you are probably have more pressing things to learn while you get up to speed on
p51757
aVNET programming
p51758
aVThe designers are there to make your life easier and to minimize the risk of getting it wrong
p51759
as(dp51760
g9
V17034
p51761
stp51762
a((dp51763
g2
(lp51764
VIt is a heavy implementation detail, but on Windows a C++ exception is also a SEH exception
p51765
aVThe exception code is 0xE04D5343 (last three bytes = 'MSC')
p51766
aVAnd all of the regular SEH support is used to unwind the stack, get automatic cleanup code to run and to filter the exception so the proper catch clause is selected
p51767
aVGetting the thrown exception object in the filter expression is plumbing that's added by the CRT beyond what SEH provides
p51768
aVSEH also supports a __finally clause but that doesn't get used in standard C++
p51769
aVA further implementation detail is the /EH compiler setting
p51770
aVThe default (/EHsc) allows the compiler to optimize the code that's generated and suppress the exception filters that are needed to run automatic cleanup
p51771
aVIf it can see that none of the emitted C++ code can throw an exception
p51772
aVThis is above all a space optimization, a small time optimization for x86 code but not for x64 code
p51773
aVTo get automatic cleanup for SEH exceptions you have to compile with /EHa so that this optimization is suppressed
p51774
aVA good strategy to marry C++ exceptions with SEH is to use _set_se_translator() so you can translate an SEH exception to a C++ exception
p51775
aVAlbeit that it isn't often wise to catch SEH exceptions, they are almost always nasty
p51776
as(dp51777
g9
V17034
p51778
stp51779
a((dp51780
g2
(lp51781
VBlocking and receiving Windows messages are mutually incompatible
p51782
aVYou get messages by pumping a message loop
p51783
aVSince you cannot rely on the app pumping one, you'll need to do this yourself
p51784
aVYou will need to create a thread
p51785
aVCreate a hidden window in that thread then run the standard message loop
p51786
aVThe window procedure for that window can see the WM_DEVICECHANGE message
p51787
aVIt can do what ever it needs to do, within the constraints of running inside a separate thread
p51788
aVLike setting an event to signal that a function should stop blocking
p51789
as(dp51790
g9
V17034
p51791
stp51792
a((dp51793
g2
(lp51794
VI'm surprised that this works at all
p51795
aVIt should find the x86 version first and fail
p51796
aVA failed assembly bind doesn't produce another attempt through AssemblyResolve
p51797
aVClearly, the CLR cannot actually find the x86 version or this would fail in x64 mode as well
p51798
aVIn other words, when you fix the problem, you'll break the 64-bit code
p51799
aVChase the x86 problem first, use Fuslogvw
p51800
aVexe to see which folders are being probed for the assembly
p51801
aVA real fix should include moving the x86 assembly into a separate folder as well and adjusting your event handler accordingly
p51802
aVYou can test IntPtr
p51803
aVSize to find out if you're running in 64-bit mode (Size == 8)
p51804
aVAlso be sure to generate a full path name, using the relative path like you do now can cause failure when the app's working directory isn't set where you hope it is
p51805
aVAssembly
p51806
aVGetEntryAssembly()
p51807
aVLocation gets you the path of the EXE
p51808
as(dp51809
g9
V17034
p51810
stp51811
a((dp51812
g2
(lp51813
VPostSharp is an IL-rewriter
p51814
aVIt loads the assembly that's generated by the
p51815
aVNET compiler and modifies the generated IL
p51816
aVCalling this 'generating code' is only technically accurate, it certainly isn't the kind of code that, say, a C# compiler can compile
p51817
aVDoing this yourself isn't exactly trivial, you have to have black-belt skills in understanding IL
p51818
aVGetting it wrong can produce very hard to diagnose problems
p51819
aVI think there are some open source projects that use the IL rewriting technique, like Spring
p51820
aVNET, they ought to be a good starting point for getting this right
p51821
aVI do see excellent hits when googling "IL rewriter"
p51822
aVDo expect to burn a considerable amount of time on it
p51823
aVIt is also a high-maintenance item, a new release of
p51824
aVNET often breaks the rewriter
p51825
as(dp51826
g9
V17034
p51827
stp51828
a((dp51829
g2
(lp51830
VPaste this code into your form class:
p51831
aVThis ensures the icon will disappear without lingering in the tray
p51832
aVNow set a breakpoint on that code and find out why your form is closing
p51833
aVCopy and paste the stack trace into your question if you cannot figure out why
p51834
as(dp51835
g9
V17034
p51836
stp51837
a((dp51838
g2
(lp51839
VFirst, right-click the toolbox and select Choose Items
p51840
aVUntick the ones you don't want
p51841
aVIf that doesn't help then try recovering the toolbox by using Reset
p51842
aVIf that doesn't help then you may have to clean the toolbox directory by hand and delete stray assembly copies that got left there
p51843
aVThis btw can get really out of hand and severely slowdown the toolbox initialization
p51844
aVNavigate to c:\u005cusers\u005cyourname\u005cappdata\u005clocal\u005cmicrosoft\u005cvisualstudio\u005c9
p51845
aV0 and look for DLLs in subdirectories there
p51846
as(dp51847
g9
V17034
p51848
stp51849
a((dp51850
g2
(lp51851
VIt is more of an implementation detail of VB
p51852
aVNET, it has an alternate way of dealing with events using the WithEvents and Handles keywords
p51853
aVAn event handler that uses Handles gets subscribed by auto-generated code in the form constructor
p51854
aVThis code will run before any of your code, including InitializeComponent or your custom AddHandler statement
p51855
aVAnd will thus always run first
p51856
aVGetting your code to guarantee to run first is possible
p51857
aVDerive your own class from Button and override the OnClick method:
p51858
as(dp51859
g9
V17034
p51860
stp51861
a((dp51862
g2
(lp51863
VWell, it is tricky
p51864
aVCalculating a point size directly isn't going to work, the width of the text is dependent on the font metrics
p51865
aVBinary search is an obvious strategy but it cannot work in practice
p51866
aVTrue-type hinting and word wrapping conspire to destabilize it
p51867
aVI'd recommend you start with binary search, setting hi and lo to reasonable defaults like 72 and 6
p51868
aVThen when the range narrows down to, say, 5 points, start testing each individual point size until you find the largest one that fits
p51869
aVWhen you write the algorithm, do make sure you count on a size N that fits but a size N-1 that doesn't fit
p51870
as(dp51871
g9
V17034
p51872
stp51873
a((dp51874
g2
(lp51875
VThe relevant implementation detail is that the underlying storage for a  is a T[]
p51876
aVSo for a  the values will be stored in an int[]
p51877
aVThe integers are stored in a contiguous chunk of memory, allocated from the garbage collected heap
p51878
aVWhat makes it so fast is not just that the integers are not boxed, it is that an int[] works so very well with the CPU cache
p51879
aVWhen you read the first element, you essentially get the next 15 for free without having to read the slow RAM or secondary cache
p51880
aVThis works not nearly so well for a boxed int because it is so large and the extra reference can have poor cache locality
p51881
aVHowever, the garbage collector really helps to take the sting out of that cost by compacting the heap
p51882
as(dp51883
g9
V17034
p51884
stp51885
a((dp51886
g2
(lp51887
VStandard VB
p51888
aVNET trap
p51889
aVForm1 is a class name, not a reference to the form
p51890
aVUnfortunately, VB
p51891
aVNET implemented an anachronism from VB6 where that was legal
p51892
aVIt however falls apart when you use threads
p51893
aVYou'll get another form object automatically created, one that isn't visible because its Show() method was never called
p51894
aVOtherwise dead as a doornail since the thread is not pumping a message loop
p51895
aVYou'll need to pass a reference to the actual form object that the user is looking at to the worker class
p51896
aVThe value of Me in the Form1 code
p51897
aVYou will also have to use Control
p51898
aVInvoke since it isn't legal to update controls from another thread
p51899
aVI recommend you fire an event instead, one that Form1 can subscribe to, so that your worker class isn't infected with implementation details of the UI
p51900
as(dp51901
g9
V17034
p51902
stp51903
a((dp51904
g2
(lp51905
VThe DLL was loaded and mapped into virtual memory
p51906
aVThat puts a lock on the file
p51907
aVStarting or stopping the service doesn't change that
p51908
aVThe exact same is true for the service EXE
p51909
aVYou would have to dynamically load and unload the DLL to fix this
p51910
aVLoadLibrary and FreeLibrary
p51911
aVBut that only works if it is an unmanaged DLL
p51912
aVAnd is very risky if you use pinvoke because the CLR won't automatically load the DLL again after you unloaded it
p51913
aVIf it is a managed DLL that you can only unload it if it was loaded in another AppDomain
p51914
aVNo bed of roses either
p51915
as(dp51916
g9
V17034
p51917
stp51918
a((dp51919
g2
(lp51920
VYou can use a
p51921
aVIt supports both a  and a  which is just what you need
p51922
as(dp51923
g9
V17034
p51924
stp51925
a((dp51926
g2
(lp51927
VNo, this is the universally adopted way of doing this
p51928
aVUnsubscribing the event handler and re-subscribing it afterward is way more fugly
p51929
as(dp51930
g9
V17034
p51931
stp51932
a((dp51933
g2
(lp51934
VYou should always use Assembly
p51935
aVLoad()
p51936
aVOnly that method can guarantee a predictable outcome
p51937
aVIt avoids DLL Hell and ensures an assembly only gets loaded once, even if the code loads it more than once
p51938
aVYou need the other two if you want to intentionally break the rules
p51939
aVLoadFrom() is used if you want to load an assembly that's not in the normal probing path
p51940
aVPretty common for plug-ins for example when they are stored in a different directory
p51941
aVYou'll have no problems getting the intended assembly loaded but you do commonly have a problem with the assemblies that it depends on
p51942
aVLoadFile() does this as well but also breaks the "don't load it more than once" rule
p51943
aVIt is very, very rare that this is what you'd want
p51944
aVOnly useful in a case where you'd want to load a copy of an assembly with the same identity but stored in a different path
p51945
aVSome kind of tool that dumps assembly metadata for example
p51946
aVAvoid it in all other cases, it causes nothing but misery
p51947
aVThe types loaded from such an assembly are never compatible with the exact same types loaded from another copy of the assembly
p51948
aVEven the same copy
p51949
as(dp51950
g9
V17034
p51951
stp51952
a((dp51953
g2
(lp51954
VYou must be using VS2010
p51955
aVPretty important that you mention this in your questions
p51956
aVYes, I repro this in that edition
p51957
aVThe IntelliSense parser was completely rewritten, squiggles support was one of its added features
p51958
aVThere is a pretty basic issue with the File Type property as shown in the Properties window for a
p51959
aVc file
p51960
aVOnly the "C/C++ Code" type is available
p51961
aVI however think it not unlikely that the parser can only parse C++ code
p51962
aVThere's also a problem with C++/CLI source code files, there's no IntelliSense support at all for them
p51963
aVHopefully it is on the to-do list
p51964
aVRemind them about it by filing a feedback report at connect
p51965
aVmicrosoft
p51966
aVcom, they pay attention to it to set priorities
p51967
as(dp51968
g9
V17034
p51969
stp51970
a((dp51971
g2
(lp51972
VI am forced to use a proprietary function to acquire my data
p51973
aVYou didn't say much about that function
p51974
aVYour problem suggests that it was implemented as a COM server, pretty common
p51975
aVCOM takes care of the threading requirements for the COM server
p51976
aVSuch a server indicates in the registry with the ThreadingModel registry key what kind of threading it supports
p51977
aVA very common setting is "Apartment", also the default when the key is missing
p51978
aVThat setting indicates that the server doesn't support threading
p51979
aVIt needs a Single Threaded Apartment (STA)
p51980
aVCOM takes care of that and it automatically marshals any call made on the server to an STA thread
p51981
aVYour UI thread
p51982
aVWhich thus goes dead as a doornail until the call completes
p51983
aVThere ought to be something about this in the documentation for the library
p51984
aVContacting the vendor for support would be a good idea as well
p51985
aVIf you can't get help then the first thing you could try is initializing the server on the worker thread instead of your UI thread
p51986
aVThat would solve the problem if the ThreadModel is "Both"
p51987
aVIf that doesn't help then you'll need to create your own STA thread
p51988
aVCall Thread
p51989
aVSetApartmentState() before starting the thread, start your own message loop with Application
p51990
aVRun() in the thread
p51991
aVYou might be able to skip the loop but it is normally required
p51992
as(dp51993
g9
V17034
p51994
stp51995
a((dp51996
g2
(lp51997
VThe requirement that this works without having a focused window is the more difficult one
p51998
aVYou need to use a low-level mouse hook with the SetWindowsHookEx() API function
p51999
aVThis requires P/Invoke, a good example is available in this blog post
p52000
as(dp52001
g9
V17034
p52002
stp52003
a((dp52004
g2
(lp52005
VYes, you're battling UIPI, an aspect of UAC that prevents unelevated programs from hijacking the resources of an elevated one
p52006
aVAnd yes, ChangeWindowMessageFilter() allows you to bypass this restriction for Windows messages
p52007
aVHowever, OLE drag and drop doesn't use Windows messages
p52008
aVIt uses callbacks, review the docs for RegisterDragDrop() for details
p52009
aVThis microsoftie blog post tells you that you're screwed although it opens the door for CWMF
p52010
aVHow to get a WM_DROPFILES message is however completely unclear to me
p52011
aVUsing DragAcceptFiles() in a sample Windows Forms app had no discernible effect
p52012
as(dp52013
g9
V17034
p52014
stp52015
a((dp52016
g2
(lp52017
VUse SerialPort
p52018
aVReadLine()
p52019
aVTweak the NewLine and the Encoding property if neccessary
p52020
as(dp52021
g9
V17034
p52022
stp52023
a((dp52024
g2
(lp52025
VYes it is special, discovering the name of this folder didn't become possible until Vista
p52026
aVNET still needs to support prior operating systems
p52027
aVThe solution isn't pretty but this should work reliably enough:
p52028
aVFeel free to tweak the fallback version, I'm not so sure how accurate it is
p52029
aVHopefully you'll never need it
p52030
as(dp52031
g9
V17034
p52032
stp52033
a((dp52034
g2
(lp52035
VCode like this is completely bound by how fast you can get the data off the disk
p52036
aVThe file simply can never fit in the file system cache so you're always waiting on the disk to supply the data
p52037
aVYou're doing fairly well at 10 MB/sec, optimizing the code is never going to have a discernible effect
p52038
aVGet a faster disk
p52039
aVDefrag the one you've got as an intermediate step
p52040
as(dp52041
g9
V17034
p52042
stp52043
a((dp52044
g2
(lp52045
VYes, cannot work
p52046
aVVSLangProj80 dates from VS2005, the property was added in VS2010
p52047
aVThere is a VSLangProj100 but it contains nothing but three enumeration types
p52048
aVThe VsProjReferencePropId100 enum indeed defines DISPID_Reference_EmbedInteropTypes
p52049
aVIt is the kind of identifier you'd use in late-bound COM
p52050
aVI'm not up to speed on this, but I'm guessing that you might get something out of ProjectItem
p52051
aVProperties
p52052
as(dp52053
g9
V17034
p52054
stp52055
a((dp52056
g2
(lp52057
VProject + Properties, Debug tab, tick "Enable unmanaged code debugging"
p52058
aVRun your program and select the Output window in VS
p52059
aVOpen your dialog
p52060
aVWhat you see in the Output window are a crapload of unmanaged DLLs getting loaded into your process
p52061
aVThese are the shell extension handlers that are installed on your machine
p52062
aVThe bad ones can affect your program in unpleasant ways, much like you describe in your question
p52063
aVUse SysInternals' AutoRuns utility to get control over this
p52064
aVStart by disabling the ones that were not made by Microsoft
p52065
as(dp52066
g9
V17034
p52067
stp52068
a((dp52069
g2
(lp52070
VI think this is actually a bug in Windows Forms
p52071
aVSomewhat inevitable due to the way it checks for access to the Handle property by the wrong thread
p52072
aVThe SDK docs for SetParent are not explicit about it, it states the requirement is that both windows belong to the same application
p52073
aVNo mention of having to belong to the same thread
p52074
aVI know for a fact that the 'same application' requirement is not hard, there's appcompat code in Windows that makes this work for windows from different processes
p52075
aVAdobe Acrobat ab/used this for a long time
p52076
aVWhich definitely absolves the 'same thread' requirement
p52077
aVWell, punt the problem and try it out
p52078
aVSet Control
p52079
aVCheckForIllegalCrossThreadCalls to false before you set the owner, back to true afterward
p52080
aVAnd test the heck out of it
p52081
aVIf you have trouble then try pinvoking SetParent() directly instead of setting the Owner
p52082
aVWindows Forms actually uses SetWindowLongPtr which is not recommended by the SDK
p52083
as(dp52084
g9
V17034
p52085
stp52086
a((dp52087
g2
(lp52088
VHard to talk about this at all in familiar terms, this capability is not at all exposed in the C# or VB
p52089
aVNET languages
p52090
aVThe C++/CLI compiler uses it however
p52091
aVThe way it is shown in disassemblers like Ildasm
p52092
aVexe or Reflector is also not standardized
p52093
aVPerhaps the best angle is Reflector, take a look-see at the System
p52094
aVData
p52095
aVdll assembly
p52096
aVIt is in an unnamed namespace ("-" in Reflector),  node
p52097
aVThe
p52098
aVcctor you see there is a module initiailizer
p52099
aVSame kind of animal as a static class constructor but at the module level
p52100
aVIt runs when the assembly gets loaded
p52101
aVC++/CLI uses it to initialize the C runtime library
p52102
aVThe ___CxxCallUnwindDtor() method you find there is an example of a "global method"
p52103
aVThe C++/CLI language doesn't give any way to make these kind of functions public, they are always embedded in the metadata with internal accessibility
p52104
aVAnd can thus not be called directly from a C# or VB
p52105
aVNET program
p52106
aVI haven't played enough with ModuleBuilder to know if that can be messed with at all beyond what C++/CLI does
p52107
aVThis is all very obscure and not actually that useful
p52108
as(dp52109
g9
V17034
p52110
stp52111
a((dp52112
g2
(lp52113
VFrom the MSDN description of Monitor
p52114
aVWait():
p52115
aVReleases the lock on an object and blocks the current thread until it reacquires the lock
p52116
aVThe 'releases the lock' part is the problem, the object isn't locked
p52117
aVYou are treating the _locker object as though it is a WaitHandle
p52118
aVDoing your own locking design that's provably correct is a form of black magic that's best left to our medicine man, Jeffrey Richter and Joe Duffy
p52119
aVBut I'll give this one a shot:
p52120
aVIn most any practical producer/consumer scenario you will want to throttle the producer so it cannot fill the queue unbounded
p52121
aVCheck Duffy's BoundedBuffer design for an example
p52122
aVIf you can afford to move to
p52123
aVNET 4
p52124
aV0 then you definitely want to take advantage of its ConcurrentQueue class, it has lots more black magic with low-overhead locking and spin-waiting
p52125
as(dp52126
g9
V17034
p52127
stp52128
a((dp52129
g2
(lp52130
VUser defined operators would be another example
p52131
aVLike System
p52132
aVString
p52133
aVop_Equality (operator==):
p52134
aVThere's no exhaustive list, language implementations are free to use the attribute to hide their glue
p52135
aVYou probably saw the raise_ prefix on code generated by the VB
p52136
aVNET compiler using the RaiseEvent accessor for example
p52137
as(dp52138
g9
V17034
p52139
stp52140
a((dp52141
g2
(lp52142
VWhat does this actually do
p52143
aVThe flac code seems to require a FILE*
p52144
aVThat's a pointer, not a handle
p52145
aVThe CRT is completely agnostic of Windows handles
p52146
aVIf FileHandle is actually a Windows handle then you're guaranteed to get the big Kaboom, handles are obfuscated pointer values
p52147
aVYou cannot get a FILE* from the CRT without pinvoking a function that you write that returns the required pointer
p52148
aVThat function should call fopen (or _wfopen_s) and ought to use the exact same version of the CRT as the flac code
p52149
aVIn the end you're not ahead of course, might as well call the function that works
p52150
as(dp52151
g9
V17034
p52152
stp52153
a((dp52154
g2
(lp52155
VWhy do you assume there's anything wrong with your code
p52156
aVA debugger gets a first-chance notifications for any SEH exception
p52157
aVYou are debugging an enormous amount of code
p52158
aVNot just Explorer
p52159
aVexe, you also get all of the shell extension handlers
p52160
aVThere's plenty of crud around, Explorer does its best to stay alive even when those extensions have bugs
p52161
aVIf you actually want to solve this, not a bad idea, then use SysInternals' Autoruns utility and disable any shell extension handler that wasn't made by Microsoft and you don't really need
p52162
aVIf you want to test your debugger then try something more innocent like Notepad
p52163
aVexe
p52164
aVAlthough File + Open brings those shell extensions back
p52165
as(dp52166
g9
V17034
p52167
stp52168
a((dp52169
g2
(lp52170
VWindows security attributes are too fine grained to test this with _stat()
p52171
aVIts implementation uses the FindFirstFile() API function, that will only fail if the right to enumerate files is not granted
p52172
aVThat's rarely the case, the more restrictive one that typically is turned off is Write or Modify
p52173
aVHacking the security API to test the ACLs is often avoided and highly unportable
p52174
aVYou just find out that you don't have the necessary privilege when you try to open the file
p52175
aVQuite acceptable because there's nothing you can do in your code to gain the right to access the file
p52176
as(dp52177
g9
V17034
p52178
stp52179
a((dp52180
g2
(lp52181
VYou added a COM component to your project
p52182
aVThe IDE automatically generated the interop assembly for it
p52183
aVYes, you'll need to deploy that DLL along with the EXE
p52184
aVThe greater effort however is in making sure that this COM component gets deployed on the target machine as well
p52185
aVYou'll need the vendor's installer if this is not a one of the COM servers that are available on any Windows machine
p52186
aV"t1" certainly doesn't sound like a standard one
p52187
as(dp52188
g9
V17034
p52189
stp52190
a((dp52191
g2
(lp52192
VYes, this is done differently now
p52193
aVThey call it a "project-to-project dependency"
p52194
aVNot actually sure what that means
p52195
aVRight-click the EXE project, Properties, Common Properties, Framework and References
p52196
aVClick the Add New Reference button and select your
p52197
aVlib project
p52198
aVThe "Link Library Dependencies" should be set to True, it is by default
p52199
aVYou no longer have to use the old "Project Dependencies" dialog anymore, it sorts out the build order from the new step
p52200
as(dp52201
g9
V17034
p52202
stp52203
a((dp52204
g2
(lp52205
VA ListView is the right choice here
p52206
aVDrop an ImageList on the form as well, that stores the images
p52207
aVSet the ListView's View property to Tile and its TileSize to the size of the tiles you want
p52208
aVFor each item you add to the list view, set its Text property to the label you want to show to the right of the image
p52209
aVAnd the ImageIndex property to the index of the image in the ImageList
p52210
aVYou can try this all out in the designer without writing code
p52211
as(dp52212
g9
V17034
p52213
stp52214
a((dp52215
g2
(lp52216
VSetting the Text property resets the TextBox
p52217
aVSelectionStart and SelectionLength properties
p52218
aVChanging the insert point in the process
p52219
aVThere's a better mousetrap available here, implement the KeyPress event so you can modify the pressed key
p52220
aVLike this:
p52221
as(dp52222
g9
V17034
p52223
stp52224
a((dp52225
g2
(lp52226
VYuck, ugly problem
p52227
aVNo, EM_SETPARAFORMAT can only work on the current selection
p52228
aVAnd EM_EXSETSEL always puts the caret at the end of the selection
p52229
aVYou could detect the selection direction by observing the change in SelectionStart but you can't get the caret in the right spot
p52230
aVAn edit control has the same problem
p52231
aVIt isn't normally a problem because re-coloring happens only when the user modifies text, not when she's selecting text
p52232
aVThe only workaround I can think of is restoring the selection by injecting keystrokes
p52233
aVThat's fugly
p52234
as(dp52235
g9
V17034
p52236
stp52237
a((dp52238
g2
(lp52239
VYes
p52240
aVUse View + Other Windows + Document Outline
p52241
as(dp52242
g9
V17034
p52243
stp52244
a((dp52245
g2
(lp52246
VServices run in an isolated session
p52247
aVThat session has its own desktop, much like the login screen
p52248
aVA user however can never look at it
p52249
aVThis is a very basic security measure, services typically run with a very privileged account
p52250
aVYou can use Process
p52251
aVStart(), the user just will never be able to see the UI of the program
p52252
aVThis is not a real problem, it makes zero sense to start a browser in a service
p52253
as(dp52254
g9
V17034
p52255
stp52256
a((dp52257
g2
(lp52258
VYes, this cannot work
p52259
aVcvWaitKey() is implemented by calling the PeekMessage() API function
p52260
aVThat can only see messages on the message queue which is associated with the thread
p52261
aVThe thread you created doesn't have any windows
p52262
aVThere is no obvious workaround for this, you have to call it on the thread that created the window
p52263
aVCalling GetAsyncKeyState() could work, a very different approach though
p52264
as(dp52265
g9
V17034
p52266
stp52267
a((dp52268
g2
(lp52269
VAvoid spending a lot of time and energy on this
p52270
aVThe user of your app will always get the message box she's familiar with
p52271
aVIt will show the text that matches her language, much like the rest of Windows
p52272
aVSomebody that speaks Russian as her native language is not going to need to switch to French on the fly
p52273
aVIf she actually does then she would have purchased a license for the Ultimate edition of Windows which permits changing the Windows language quickly
p52274
aVYour app will follow suit, as long as you don't override the default culture and have localized your app
p52275
aVBeware that overriding the default culture of the UI thread is a very dangerous thing to do, the threadpool threads that
p52276
aVNET uses (or you for that matter) still run in the default language
p52277
aVThis can cause very subtle problems because of the different string comparison rules
p52278
aVFor example, a SortedList filled in one thread will suddenly not be sorted anymore in another thread, causing a binary search to malfunction
p52279
as(dp52280
g9
V17034
p52281
stp52282
a((dp52283
g2
(lp52284
VYeah, that's not healthy
p52285
aVDo it the same way as Windows Forms does it, just re-create the window, now minus the WS_EX_MDICHILD style flag
p52286
aVDestroy the old one
p52287
aVYes, you'll get a bit of flicker
p52288
aVLeverage your existing code simply by giving this new window the same window procedure
p52289
as(dp52290
g9
V17034
p52291
stp52292
a((dp52293
g2
(lp52294
VNot sure why the EXE project didn't create the interop library
p52295
aVBut punt this problem
p52296
aVInstead of having the EXE project reference ADO again, let it reference the interop library that was created by the DLL project
p52297
aVNot exposing the ADO types in a public class would be the better solution
p52298
aVADO Ext is a utility bag, you should be able to encapsulate it well enough
p52299
as(dp52300
g9
V17034
p52301
stp52302
a((dp52303
g2
(lp52304
VSome LCD monitors do indeed have a problem showing the gray color distinctive enough
p52305
aVIt is a system setting and affects all programs, you cannot change it for just your own
p52306
aVGiven that this really a problem with your monitor, there's little reason to not just fix it by changing the system color
p52307
aVUse Control Panel + Display
p52308
aVOn Win7 click Personalization, Window Color, Advanced Appearance Settings
p52309
aVSelect "Disabled Item" in the dialog
p52310
as(dp52311
g9
V17034
p52312
stp52313
a((dp52314
g2
(lp52315
VUse the Debugger
p52316
aVGetExpression() method
p52317
as(dp52318
g9
V17034
p52319
stp52320
a((dp52321
g2
(lp52322
VYou indeed have an old version of the CRT
p52323
aVThe version number is set in the vc\u005cinclude\u005ccrtassem
p52324
aVh include file
p52325
aVWindows Update should have given you the security update that was released in July of last year
p52326
aVIt also updates the CRT
p52327
aVh and
p52328
aVlib files
p52329
aVMaybe you got that release from an installer of another program
p52330
aVIf you don't want to turn on Windows Update then you can get the security update from here
p52331
aVBeware that the download it starts is rather large
p52332
as(dp52333
g9
V17034
p52334
stp52335
a((dp52336
g2
(lp52337
VWindows has several desktops
p52338
aVYou're familiar with the one you are looking at right now
p52339
aVThere's another one for the login screen
p52340
aVAnd there's one for the screen saver
p52341
aVLocking the workstation switches the desktop to the login screen
p52342
aVYou cannot switch back to another desktop (like the screen saver one) until you login
p52343
aVYou can however get the screen saver started, that selects the screen saver desktop
p52344
aVWhich automatically switches to the login desktop if you configure the screen saver that way
p52345
as(dp52346
g9
V17034
p52347
stp52348
a((dp52349
g2
(lp52350
VSet its AutoSize property to True
p52351
as(dp52352
g9
V17034
p52353
stp52354
a((dp52355
g2
(lp52356
VYou will actually have to have a thread that is burning CPU cycles to get SwitchToThread() to actually make a context switch
p52357
aVMore than one if your CPU has multiple cores
p52358
aVEven then, the result you'll get is largely meaningless
p52359
aVThe amount of overhead is highly variable depending on the process that owns the thread that gets the quantum and the state of the TLB cache
p52360
aVReloading the TLB registers and getting cache misses adds lots of time
p52361
aVThe usual number thrown about is between 2,000 and 10,000 cycles
p52362
as(dp52363
g9
V17034
p52364
stp52365
a((dp52366
g2
(lp52367
VNobody got to the last two questions (btw: ask only one per thread)
p52368
aVUsing a lock in Dispose() is pretty lethal to the finalizer thread
p52369
aVThere's no upper-bound on how long the lock might be held, your program will crash after two seconds when the CLR notices that the finalizer thread got stuck
p52370
aVMoreover, it is just a bug
p52371
aVYou should never call Dispose() when another thread might still have a reference to the object
p52372
aVYes, implementing a finalizer without implementing IDisposable is not unheard of
p52373
aVAny COM object wrapper (RCW) does that
p52374
aVSo does the Thread class
p52375
aVThis was done because it just isn't practical to call Dispose()
p52376
aVIn the case of a COM wrapper because it is just not possible to keep track of all reference counts
p52377
aVIn case of Thread because having to Join() the thread so that you could call Dispose() defeats the purpose of having a thread
p52378
aVPay attention to Jon Hanna's post
p52379
aVImplementing your own finalizer is indeed wrong 99
p52380
aV99% of the time
p52381
aVYou've got the SafeHandle classes to wrap unmanaged resources
p52382
aVYou'd need something pretty obscure to not be wrappable by them
p52383
as(dp52384
g9
V17034
p52385
stp52386
a((dp52387
g2
(lp52388
VYou will have to implement the D+D events on all the controls
p52389
aVNot exactly practical, but you could do so by iterating the Form
p52390
aVControls collection recursively
p52391
aVGive the user a good drop target, makes it easier for her to guess where to drop, easier for you to implement the code
p52392
as(dp52393
g9
V17034
p52394
stp52395
a((dp52396
g2
(lp52397
VYes, I think you already diagnosed the problem correctly
p52398
aVIt is a nasty side effect of, say, the vertical scrollbar appearing and needing space, making the available client area smaller
p52399
aVToo small to fit the controls, now also making the horizontal scrollbar appear
p52400
aVIt is actually bi-stable, the horizontal bar can flicker on and off in certain cases
p52401
aVTo avoid this effect, the layout engine would have to make multiple passes through the layout, dealing with the changing client area
p52402
aVIt however only makes one pass
p52403
aVWhich sounds wise, this could be a potentially never ending loop
p52404
aVI don't know of a decent fix for this
p52405
aVYour user will probably just resize the window large enough to get rid of at least one of the scrollbars
p52406
as(dp52407
g9
V17034
p52408
stp52409
a((dp52410
g2
(lp52411
VIt's the code in the 2nd snippet that messes this up
p52412
aVEast Asian machines often take advantage of a XP feature that allows increasing the system font size without also increasing the DPI
p52413
aVNice for readability of their intricate characters
p52414
aVJust remove the code to solve the problem
p52415
aVIf you want to make the form unsizable then set its FormBorderStyle to, say, Fixed3D
p52416
aVIf you do insist on faking the border then you'll have to move the Min/MaximumSize assignments to the Load event
p52417
aVOnly then is the form's Size property calculated and corrected for the system font size as well as any user preferences like the size of the border or the size of the caption text
p52418
aVWhich btw is another failure mode for your code
p52419
as(dp52420
g9
V17034
p52421
stp52422
a((dp52423
g2
(lp52424
VPreventing a focusable control from taking the focus takes a number of counter-measures
p52425
aVYou will have to include a control that does take the focus for this class to be resist all attempts:
p52426
as(dp52427
g9
V17034
p52428
stp52429
a((dp52430
g2
(lp52431
VWell, posting code that uses a thread and then saying in your question that you don't actually need it was not a great idea :)
p52432
aVLet's focus on the real problem
p52433
aVProcess
p52434
aVWaitForExit() has no failure mode
p52435
aVIt's solid, this is rock in the Windows API
p52436
aVSo program
p52437
aVexe really did exit
p52438
aVIf you still see side-effects of the program after WaitForExit() returned then program
p52439
aVexe is probably a single-instance app
p52440
aVThe canonical example of a single-instance app is Microsoft Word
p52441
aVIt's a big program that requires lots of machine resources, running multiple instances of it can quickly consume them
p52442
aVIt was optimized so that only one instance of msword
p52443
aVexe ever runs, even if you open multiple documents
p52444
aVThis works by msword
p52445
aVexe starting up small and checking if another instance is already running
p52446
aVIf there is, it talks to it using an interprocess communication facility like named pipes to tell the first instance to open the file
p52447
aVAfter which it quickly exits
p52448
aVNot much you can do about this
p52449
aVKilling any running instance of program
p52450
aVexe before you start it would be a very Q&D; solution
p52451
as(dp52452
g9
V17034
p52453
stp52454
a((dp52455
g2
(lp52456
VThis is exactly the reason the GAC exists
p52457
aVThe only other workaround I can think of is to stuff these DLLs in subdirectories so the CLR cannot find them and implement AppDomain
p52458
aVAssemblyResolve
p52459
aVYou now get to maintain that code for every new version update
p52460
as(dp52461
g9
V17034
p52462
stp52463
a((dp52464
g2
(lp52465
s(dp52466
g9
V17034
p52467
stp52468
a((dp52469
g2
(lp52470
VThe structure has a fixed size
p52471
aVThere's no point in passing an array, just pass the structure:
p52472
aVYou do have a memory management problem
p52473
aVWho owns the pointer
p52474
aVOkay, the structure is actually variable sized and the pointer points into the array
p52475
aVYou need nother approach
p52476
aVSimply allocate a chunk of unmanaged memory up front instead of letting the P/Invoke marshaller copy the data into a managed array
p52477
aVWhich is in fact a hard requirement since the garbage collector can move the array, invalidating the pointer
p52478
aVCall Marshal
p52479
aVCoTaskMemAlloc() to reserve the memory, you'll have to free it later
p52480
aVAnd change the first argument of the function to IntPtr (not out)
p52481
aVYou'll find that marshaling the structure a lot easier too, no need to pin the memory
p52482
aVDon't forget to Marshal
p52483
aVFreeCoTaskMem() when you're done
p52484
as(dp52485
g9
V17034
p52486
stp52487
a((dp52488
g2
(lp52489
VYes, can't work
p52490
aVYou need the actual instance of a class that implements IHandleTraits
p52491
aVInterfaces need a class that implements a v-table
p52492
aVAs long as you want to seal this class, you need a factory or create an instance of T
p52493
aVRealistically, the object hierarchy is wrong
p52494
aVSafeHandle should be an abstract base class with concrete derived classes that each know how to deal with a specific handle type
p52495
aVThat's how the desktop version of SafeHandle is implemented as well
p52496
aVYou can rescue your approach by giving T the new() constraint so that you can create an instance of it
p52497
aVDragging around the extra reference isn't that great though:
p52498
as(dp52499
g9
V17034
p52500
stp52501
a((dp52502
g2
(lp52503
VHmya, the add-in market for Visual Studio is a whole new ball game in the DLL Hell stadium
p52504
aVVS2010 consuming 1 1/2 gigabytes of memory is completely absurd of course
p52505
aVPlain vanilla it is an incredibly low ~300 MB or so
p52506
aVDownload SysInternals' ProcMon utility and find out what file that blasted add-in is reading to get it out of control this badly
p52507
aVThe tool will generates a lot of trace data, you should however have no trouble finding out what file is responsible given how long it takes
p52508
aVDelete it
p52509
aVYou probably ought to consider uninstalling it next, this is just sloppy
p52510
as(dp52511
g9
V17034
p52512
stp52513
a((dp52514
g2
(lp52515
VLong cold start times are pure hard disk problems
p52516
aVFinding the DLLs that your program needs
p52517
aVYou cannot optimize the hard disk beyond running a defragging tool
p52518
aVSegmenting your program so that DLL loading overlaps UI time is quite difficult
p52519
aVUsing COM servers or the linker's /DELAYLOAD option are obvious approaches but it is just not that easy to get a functional UI up on the screen without touching just about anything
p52520
aVSeparating classes  into DLLs that are triggered by toolbar or menu options is of course possible but MFC doesn't make it that easy with Idle time UI updating (sorry, forgot the exact phrase)
p52521
aVYou're not alone, good examples of programs that have this problem too are Microsoft Office and Acrobat Reader
p52522
aVThey solve the problem with a very icky hack, they install an 'optimizer' in Run registry key or Startup folder shortcut
p52523
aVWhich doesn't do anything but touch all the DLLs so that they are loaded in the file system cache
p52524
aVGiving the EXE a warm start after the user checked her email
p52525
aVI hate them and keep deleting them after they put it back again
p52526
aVBut it does improve the user opinion, they'll think it is the email reader that is slow
p52527
aVOr the blasted Windows-shoulda-gotten-a-Mac of course
p52528
aVThat said, 30 seconds is a helluva long time
p52529
aVDo make sure this isn't a problem on just your dev machine, induced by building the binaries over and over again and getting them scattered all over the disk
p52530
aVRun Defraggler
p52531
aVNext, check what all it is doing with the SysInternals' ProcMon utility
p52532
as(dp52533
g9
V17034
p52534
stp52535
a((dp52536
g2
(lp52537
VDon't show dialogs or message boxes on a web server
p52538
aVIf that error wasn't checked, somebody would have to break into the server room to click the OK button
p52539
as(dp52540
g9
V17034
p52541
stp52542
a((dp52543
g2
(lp52544
VNET already supports these, nothing special is needed
p52545
aVAll it needs is the type library for the component, it should be embedded in the DLL when you created it with VS6
p52546
aVIn a
p52547
aVNET project, use Project + Add Reference, Browse tab and select the DLL
p52548
aVThat automatically generates the interop library
p52549
aVUse Object Browser to verify that everything is there
p52550
as(dp52551
g9
V17034
p52552
stp52553
a((dp52554
g2
(lp52555
VThe first argument should not be NULL, it must be the handle of a dialog
p52556
aVPainful here of course
p52557
as(dp52558
g9
V17034
p52559
stp52560
a((dp52561
g2
(lp52562
VThis is completely inappropriate
p52563
aVA user of your class that doesn't know the details well will assume that calling Dispose() will do something innocent
p52564
aVA bit of cleanup, nothing fancy
p52565
aVShe will not expect the program to be left in a completely unpredictable state with threads mutating that state aborted at random locations with no way to recover state
p52566
aVIt is also complete redrum on the finalizer thread, aborting a thread can take many seconds if the thread is not in an alertable state
p52567
aVThe CLR will abort the finalizer thread after 2 seconds and terminate the program, giving no diagnostic at all about the true reason the program crashed
p52568
as(dp52569
g9
V17034
p52570
stp52571
a((dp52572
g2
(lp52573
VWell, whomever is going to implement the Paint event for the control is going to have a bit of a surprise
p52574
aVIt could be valid if it makes sense that everything is always rotated, but that is for you to decide
p52575
aVGraphics
p52576
aVSave + Restore takes about 4 microseconds on my laptop
p52577
aVNothing to worry about given the typical expense of drawing
p52578
as(dp52579
g9
V17034
p52580
stp52581
a((dp52582
g2
(lp52583
VI assume you're looking for this:
p52584
aVThe syntax for a jagged array is:
p52585
as(dp52586
g9
V17034
p52587
stp52588
a((dp52589
g2
(lp52590
VYes, strange things start to happen when your program is close to consuming 10,000 GDI handles
p52591
aVIt almost certainly affects the Windows font mapper without necessarily throwing an exception
p52592
aVYour program is playing Russian roulette with this potential problem because you are not calling Dispose() on the fonts you use
p52593
aVIf the garbage collector doesn't run frequently enough then you may well get that gun to go off
p52594
aVYou need to write it like this:
p52595
aVAlso note another bug in your code, you are using TextRenderer
p52596
aVMeasureText but drawing with Graphics
p52597
aVDrawString
p52598
aVThe measurement is not identical
p52599
aVYou must use Graphics
p52600
aVMeasureString
p52601
as(dp52602
g9
V17034
p52603
stp52604
a((dp52605
g2
(lp52606
VYes, you should dispose the form
p52607
aVIt isn't automatic when you use ShowDialog()
p52608
aVWhy is this a dialog in the first place when you are not interested in the results
p52609
aVAfter edit: this is not a problem
p52610
aVThe exact same thing happens in Program
p52611
aVcs
p52612
as(dp52613
g9
V17034
p52614
stp52615
a((dp52616
g2
(lp52617
VImagine I have an object of IInterface myInterface, is there a way to create a MyClass object myClass and to set all fields of myClass with the one of myInterface
p52618
aVThis is fundamentally flawed
p52619
aVYou cannot have an object of an interface, only an object of a class that implements the interface
p52620
aVFurthermore, an interface cannot have fields, only properties, events and methods
p52621
aVThe interface declaration in your snippet can never compile
p52622
aVFurthermore, the odds that the passed object has any fields in common with your class are slim to none, unless they have a base class in common that declares the fields
p52623
aVYou'll need a base class instead of an interface
p52624
aVCopying the field values is now trivial and quick
p52625
as(dp52626
g9
V17034
p52627
stp52628
a((dp52629
g2
(lp52630
VYou'll probably find it back in the hidden icons
p52631
aVOn Win7 click the "Show hidden icons" arrow, click on Customize and override the behavior
p52632
as(dp52633
g9
V17034
p52634
stp52635
a((dp52636
g2
(lp52637
VTurbo Pascal could only generate 16-bit code, there was never a version that could create 32-bit executables
p52638
aVRunning 16-bit code requires a virtual machine that uses the real-mode emulation support in the CPU (virtual 8086 mode)
p52639
aVThis emulation is not available if the processor is running in 64-bit mode
p52640
aVYou cannot run 16-bit processes on a 64-bit operating system
p52641
aVYou may have a shot at getting it going with the DOSBox emulator
p52642
as(dp52643
g9
V17034
p52644
stp52645
a((dp52646
g2
(lp52647
VOuch, you're hacking COM the low-level way
p52648
aVIt is roughly okay, but there are problems
p52649
aVIt will never work in 64-bit mode, uEnum can't be a uint, it has to be a pointer
p52650
aVIt is also being leaked, you don't call Release() for it
p52651
aVYou can't ignore that
p52652
aVClearly you've got a type library and created a interop library from it or else the reflection code wouldn't work
p52653
aVI can only guess that there's something wrong with the IDL
p52654
aVThe signature of EnumTypes suggests that you forgot the [out,retval] attributes on the last argument
p52655
aVAt least post the IDL for EnumTypes
p52656
as(dp52657
g9
V17034
p52658
stp52659
a((dp52660
g2
(lp52661
VI've seen this called "Stringy typing" in another SO thread
p52662
aVNo, not possible, you cannot find out what the string contains until runtime
p52663
aVEven the value of testing it at runtime is iffy, there could be many more things wrong with the query statement
p52664
aVYou do seem to be re-inventing stored procedures, consider using the dbase engine support for them
p52665
as(dp52666
g9
V17034
p52667
stp52668
a((dp52669
g2
(lp52670
VThe sync block sits at a negative offset from the object pointer
p52671
aVThe first field at offset 0 is the method table pointer, 8 bytes on x64
p52672
aVSo on x86 it is SB + MT + X + Y = 4 + 4 + 4 + 4 = 16 bytes
p52673
aVThe sync block index is still 4 bytes in x64
p52674
aVBut the object header also participates in the garbage collected heap, acting as a node in a linked list after it is released
p52675
aVThat requires a back and a forward pointer, each 8 bytes in x64, thus requiring 8 bytes before the object pointer
p52676
aV8 + 8 + 4 + 4 = 24 bytes
p52677
as(dp52678
g9
V17034
p52679
stp52680
a((dp52681
g2
(lp52682
VJust give the Presenter a Run() method
p52683
as(dp52684
g9
V17034
p52685
stp52686
a((dp52687
g2
(lp52688
VDim strReturn As String = System
p52689
aVText
p52690
aVASCIIEncoding
p52691
aVASCII
p52692
aVGetString(b)
p52693
aVYou encoded the XML in UTF-8, don't read it back as ASCII
p52694
aVYou'll lose all the special characters that cannot be encoded
p52695
aVFix:
p52696
as(dp52697
g9
V17034
p52698
stp52699
a((dp52700
g2
(lp52701
VYou need to find the label control back on the active tab page
p52702
aVThe cleanest way to do this is to create an array that has a reference to each label
p52703
aVLike this:
p52704
as(dp52705
g9
V17034
p52706
stp52707
a((dp52708
g2
(lp52709
VPaste this into your form code to help the Dock layout calculations:
p52710
as(dp52711
g9
V17034
p52712
stp52713
a((dp52714
g2
(lp52715
VThe blog post is accurate
p52716
aVMake it look like this:
p52717
as(dp52718
g9
V17034
p52719
stp52720
a((dp52721
g2
(lp52722
VYes it is
p52723
aVThe IFilters run inside a hosting process named SearchFilterHost
p52724
aVexe
p52725
aVSince the filters can potentially open files with malicious content, the host runs with very restricted privileges
p52726
aVThe ability to start a process would certainly not be included
p52727
aVNo idea how to override this, or for that matter if you should even consider doing so
p52728
aVGoogling "searchfilterhost
p52729
aVexe" brings up plenty of alarm bells
p52730
aVThat's gotta be painful news, sorry to be the bearer
p52731
as(dp52732
g9
V17034
p52733
stp52734
a((dp52735
g2
(lp52736
VWell, yes, the IntelliSense parser is not an exact replica of the C# compiler
p52737
aVIt has a very different job to do, it needs to do something meaningful while the code is utterly broken since you are editing it
p52738
aVTough assignment, they did a tremendous job with it
p52739
aVBut as a side-effect, it can fail to parse things that are actually legal
p52740
aVIt's quite rare but not unheard of, seen it myself a few times
p52741
aVThis won't go anywhere concrete until you at least give us some idea of what kind of errors you are seeing, along with a snippet of the code that generates them
p52742
aVYou didn't do so, I can only recommend that you select another window so you don't have to look at them
p52743
as(dp52744
g9
V17034
p52745
stp52746
a((dp52747
g2
(lp52748
V@mikerobi is correct, when you write to the stream the file pointer is changed and moved to the end of the stream
p52749
aVWhat you are not counting on is that StreamReader has its own buffer
p52750
aVIt reads 1024 bytes from the file and you'll get results from that buffer
p52751
aVUntil the buffer runs out so it has to read from the FileStream again
p52752
aVFinding nothing because the file pointer is at the end of the file
p52753
aVYou really do need to separate FileStreams, each with their own file pointer to have any hope of making this work
p52754
as(dp52755
g9
V17034
p52756
stp52757
a((dp52758
g2
(lp52759
VRight-click your project, Properties, Linker, Input
p52760
aVIn the "Ignore Specific Library" setting put mfc80u
p52761
aVlib
p52762
aVIn the "Additional Dependencies" setting add mfc90u
p52763
aVlib
p52764
aVNo guarantee that this will work but you got a decent shot at it
p52765
aVYour best bet is to contact the SDK vendor and ask for an update
p52766
as(dp52767
g9
V17034
p52768
stp52769
a((dp52770
g2
(lp52771
VYour machine sounds messed up, this should work
p52772
aVNavigate to C:\u005cProgram Files\u005cReference Assemblies\u005cMicrosoft\u005cFramework\u005cv3
p52773
aV5 and look at the properties of the DLL
p52774
aVThe file version on mine is 3
p52775
ag2447
aV30729
p52776
aV4926, modify date 6/10/2009
p52777
aVCopying the file from another machine is the Q&D; fix, reinstalling
p52778
aVNET would be wise
p52779
as(dp52780
g9
V17034
p52781
stp52782
a((dp52783
g2
(lp52784
VYes, the debugger gets a notification for it
p52785
aVNo, the UI doesn't allow you to tell it to break on that notification
p52786
aVIf this is for managed code then you could use the MDbg sample and modify it
p52787
as(dp52788
g9
V17034
p52789
stp52790
a((dp52791
g2
(lp52792
VFormat 0x0003 is in fact ieeeFloat, you shouldn't get this exception
p52793
aVBetter check the value it read
p52794
aVYou cannot convert the values with bit shifting, you have to convert from float to short
p52795
aVA simple cast gets the job done
p52796
as(dp52797
g9
V17034
p52798
stp52799
a((dp52800
g2
(lp52801
VYes, that's accurate
p52802
aVIt is up to your code to do the same thing that Perfmon does: query the performance counter once a second to get a meaningful value
p52803
aVYou'll need a timer or (ugh) call Sleep()
p52804
aVUsing the PerformanceCounter class is the better way to do this btw, WMI is not cheap
p52805
aVThat also gives you access to the PerformanceCounter property which tells you what kind of counter it is
p52806
aVDoesn't really matter, you know you need the timer anyway
p52807
as(dp52808
g9
V17034
p52809
stp52810
a((dp52811
g2
(lp52812
VYou can create your own formatting specifiers by implementing IFormatter
p52813
aVBut you cannot do so for the types that are already baked into
p52814
aVNET
p52815
aVLike System
p52816
aVDouble or System
p52817
aVDecimal, or whatever the type of the variable whose value is 1
p52818
aV2452
p52819
aVThe format specifiers that are baked in for these standard
p52820
aVNET types don't allow picking off the 3 last digits
p52821
aVA custom culture with an altered NumberFormatInfo doesn't give you enough control over the formatting
p52822
aVYou'll need to get control over the actual value
p52823
aVThen it is simple
p52824
as(dp52825
g9
V17034
p52826
stp52827
a((dp52828
g2
(lp52829
VDumpbin
p52830
aVexe has some options to peek an the
p52831
aVobj file content
p52832
aVBuilding the final DLL and looking at either the generated machine code with the debugger or the IL with Ildasm
p52833
aVexe or Reflector ought to be a lot more productive
p52834
as(dp52835
g9
V17034
p52836
stp52837
a((dp52838
g2
(lp52839
VIt is very much an implementation detail of the JIT compiler
p52840
aVIt will try very hard to  store local variables in a CPU register, very efficient
p52841
aVThe stack is the usual backing store, in case there aren't enough registers available to store all the local variables
p52842
aVBig difference between the x86 and x64 jitters for example
p52843
aVx64 has a lot more registers available
p52844
aVThis also applies to the arguments passed to a method
p52845
aVx86 allows 2 passed in a CPU register, x64 allows 4
p52846
aVPlus whatever can be stored in the FPU stack or XMM registers
p52847
aVSo, there are really four distinct places a local variable can be stored
p52848
as(dp52849
g9
V17034
p52850
stp52851
a((dp52852
g2
(lp52853
VIt isn't read-only, use lnk->Path instead, followed by lnk->Save()
p52854
aVAssuming you have write privileges to the file
p52855
aVC# code that does the same thing is in my answer in this thread
p52856
as(dp52857
g9
V17034
p52858
stp52859
a((dp52860
g2
(lp52861
VHmm, not really sure what "highestAvailable" does
p52862
aVRemove all doubt and use "requireAdministrator" instead, that always works to get full admin privileges
p52863
aVAlso make sure you use the right resource name and ID, RT_MANIFEST and 1
p52864
as(dp52865
g9
V17034
p52866
stp52867
a((dp52868
g2
(lp52869
VYes, you'll have to create a custom text box so you can detect it scrolling
p52870
aVThe trick is to pass the scroll message to the other text box so it will scroll in sync
p52871
aVThis really only works well when that other text box is about the same size and has the same number of lines
p52872
aVAdd a new class to your project and paste the code shown below
p52873
aVCompile
p52874
aVDrop two of the new controls from the top of the toolbox onto your form
p52875
aVSet the Buddy property to the other control on both
p52876
aVRun, type some text in both of them and watch them scroll in sync as you drag the scrollbar
p52877
as(dp52878
g9
V17034
p52879
stp52880
a((dp52881
g2
(lp52882
VThe keyboard works too, just type the first letter of the filename
p52883
as(dp52884
g9
V17034
p52885
stp52886
a((dp52887
g2
(lp52888
VNot so sure that it has anything to do with the command prompt
p52889
aVHowever, you get the exact same behavior as what you get from the command prompt by using the same command line interpreter
p52890
aVUse cmd
p52891
aVexe as the process file name, /c powercfg
p52892
aVexe as the argument
p52893
as(dp52894
g9
V17034
p52895
stp52896
a((dp52897
g2
(lp52898
VYes, create your own
p52899
aVA rough draft to get you 80% there, embellish as needed:
p52900
as(dp52901
g9
V17034
p52902
stp52903
a((dp52904
g2
(lp52905
VDispatcher can only perform its Begin/Invoke() duty when the main thread goes idle and re-enters the dispatch loop
p52906
aVAt that point the main thread is quiescent and it can safely execute the dispatched requests
p52907
aVAs well as any notifications sent to it by Windows
p52908
aVIt isn't idle in your case, it is stuck inside of Sleep(2500)
p52909
as(dp52910
g9
V17034
p52911
stp52912
a((dp52913
g2
(lp52914
VThe future happened yesterday, C# is in fact ported to a large number of embedded cores
p52915
aVThe
p52916
aVNET Micro Framework is the typical deployment scenario
p52917
aVModel numbers I see listed as native targets are AT91, BF537, CortexM3, LPC22XX, LPC24XX, MC9328, PXA271 and SH2
p52918
aVI don't know the exact implementation details of their core instruction set but I'm fairly sure that these are all 32-bit cores and several of them are ARM cores
p52919
aVWriting threaded code for them requires a minimum guarantee and atomic updates for properly aligned words is one of them
p52920
aVGiven the supported list and that 4 byte atomic updates for aligned words is trivial to implement in 32-bit hardware, I trust they all do in fact support it
p52921
as(dp52922
g9
V17034
p52923
stp52924
a((dp52925
g2
(lp52926
VHmm, your code suggest that you do in fact use C# 4
p52927
aV0 since you're using named parameters
p52928
aVThat version does support indexed properties in COM interop scenarios
p52929
aVIndexer syntax however requires [square brackets]
p52930
aVNo idea if it still works with more than one argument, the examples all have just one
p52931
aVTry this first:
p52932
aVOr punt the problem with:
p52933
aVPlease let us know what you find out, I'm interested to learn if indexed properties with multiple arguments is supported
p52934
as(dp52935
g9
V17034
p52936
stp52937
a((dp52938
g2
(lp52939
VNope, Reflection is all about types, not code
p52940
aVYou can find out anything you want with System
p52941
aVReflection about what a type looks like: fields, properties, events, methods
p52942
aVBut method calls are encoded in IL
p52943
aVReflection stops there, all you got is MethodInfo
p52944
aVGetMethodBody()
p52945
aVThat didn't stop some people, you can actually interpret the IL handed to you by the method
p52946
aVShining light there is Lutz Roeder and his awesome Reflector tool
p52947
aVNinety percent of what I know about how the
p52948
aVNET framework actually works, and how I can advantage of it myself, was handed on a silver platter
p52949
aVVery awesome, give the guy a medal
p52950
aVAnd MSFT following up on that with the Reference Source
p52951
as(dp52952
g9
V17034
p52953
stp52954
a((dp52955
g2
(lp52956
Valso Windows 7 64bit
p52957
aVEdit+Continue only works for 32-bit code
p52958
aVEasy fix, and the default now for VS2010 projects: Project + Properties, Build tab, Platform target = x86
p52959
aVYou can of course leave that setting for your Release configuration at Any CPU
p52960
as(dp52961
g9
V17034
p52962
stp52963
a((dp52964
g2
(lp52965
VYes, this cannot work on a 32-bit machine, it manages to scrape by on a 64-bit machine but that's sheer luck
p52966
aVYour pinvoke declaration dates from the VB6 era, it is quite wrong for VB
p52967
aVNET
p52968
aVWatch out for this, there are a lot of junk declarations out there
p52969
aVThe pinvoke
p52970
aVnet site is a good bet to get it right
p52971
aVFix:
p52972
aVAnother thing you want to do on your dev machine so you can debug this for a 32-bit machine is Project + Properties, Compile tab, scroll down, Advanced Compile Options, Target CPU = x86
p52973
aVAlso enables Edit+Continue, you'll love it
p52974
aVNote that your GetAsyncKeyState() declaration is almost certainly wrong as well
p52975
aVIt returns Short, not Integer
p52976
as(dp52977
g9
V17034
p52978
stp52979
a((dp52980
g2
(lp52981
VIt's rather too simple, guaranteed to not work
p52982
aVYou'll need to set the communication properties on the SerialPort to match them with HyperTerminal
p52983
aVBaudrate, DataBits, Parity and StopBits at least
p52984
aVAnd HyperTerminal won't send anything if it doesn't detect the device on-line
p52985
aVYou have to set the RtsEnable and DtrEnable properties to true
p52986
as(dp52987
g9
V17034
p52988
stp52989
a((dp52990
g2
(lp52991
VNET was very much intended to be the replacement for COM
p52992
aVThe project had many names while it was being worked on, but it started life as "COM+"
p52993
aVThis influence is still evident in many places
p52994
aVMany of the core source code files for the CLR start with the name "com", even though the CLR uses (almost) no COM at all
p52995
aVThe Windows exception code for a managed exception is 0xE0434F4D
p52996
aVThe last 3 byte values of the code is ASCII for "COM"
p52997
aVThe assertion that WCF was a replacement is not accurate
p52998
aVIt replaced
p52999
aVNET Remoting
p53000
aVCOM has a very wide range, it is a generic interop tool, much like the CLR allows many languages to interoperate
p53001
aVOne of its features was supporting interop between different processes and machines, perhaps the source of the statement
p53002
aVBut that's just a part of it
p53003
aVThere are still lots of COM applications that have not been replaced by
p53004
aVNET
p53005
aVThe best example is the Windows shell, Explorer
p53006
aVexe
p53007
aVPretty hard to do something as simple as creating a context menu shell extension in C#
p53008
aVAnd until
p53009
aVNET 4
p53010
aV0 strongly discouraged
p53011
as(dp53012
g9
V17034
p53013
stp53014
a((dp53015
g2
(lp53016
VClose the solution
p53017
aVOpen the project's Properties\u005cSettings
p53018
aVsettings file and re-arrange the  items
p53019
aVYou'll get them back listed in the Settings Designer in the order in which they are listed in that file
p53020
as(dp53021
g9
V17034
p53022
stp53023
a((dp53024
g2
(lp53025
VIn your Setup project, click View + Editor + File System
p53026
aVRight-click the left panel, Add special folder, select "User's Startup Folder"
p53027
aVSelect it
p53028
aVRight-click the right panel, Create New Shortcut and select the application
p53029
as(dp53030
g9
V17034
p53031
stp53032
a((dp53033
g2
(lp53034
VYou can link with the static version of the CRT (yes, /MT) but it is quite dangerous
p53035
aVYou'll have to carefully review your exports
p53036
aVMake very sure that none of them return C++ objects, not even an std::string (or CString)
p53037
aVOr any pointers that the client code has to release
p53038
aVThis will go wrong badly because the client will have its own CRT copy and use a different heap
p53039
aVThat will leak the returned object/pointer, crash the program on Vista and Win7 when their secure heap manager detects that the pointer doesn't belong to the heap
p53040
aVIt might be a matter of debate what exactly an 'external dependency' means
p53041
aVHaving a dependency on the CRT is not exactly external
p53042
aVYou will however have to supply them with a version of the DLL that was built on the same version of Visual Studio that they use
p53043
aVThe CRT can only be shared if the version matches
p53044
as(dp53045
g9
V17034
p53046
stp53047
a((dp53048
g2
(lp53049
VWell, it is accurate, the Dispose() method on these streams will be called more than once
p53050
aVThe StreamReader class will take 'ownership' of the cryptoStream so disposing streamWriter will also dispose cryptoStream
p53051
aVSimilarly, the CryptoStream class takes over responsibility for the memoryStream
p53052
aVThese are not exactly real bugs, these
p53053
aVNET classes are resilient to multiple Dispose() calls
p53054
aVBut if you want to get rid of the warning then you should drop the using statement for these objects
p53055
aVAnd pain yourself a bit when reasoning what will happen if the code throws an exception
p53056
aVOr shut-up the warning with an attribute
p53057
aVOr just ignore the warning since it is silly
p53058
as(dp53059
g9
V17034
p53060
stp53061
a((dp53062
g2
(lp53063
VNo answers, I'll give it a shot
p53064
aVIt isn't obvious to me how the posted snippet could fail, I suspect the real problem is in the comment
p53065
aVI don't have hands-on experience with CHESS but studied it well enough to know that you cannot rely on it to ever give you reproducible test results
p53066
aVIt's approach to uncovering threading problems is very much statistical, injecting random delays in the threads
p53067
aVDesigned to recreate the kind of threading problems that are so heavily influenced by timing, especially race conditions
p53068
aVA race condition can go undetected for a very long time if code execution timing is predictable
p53069
aVAnd when it strikes, incredibly hard to diagnose
p53070
aVA good example of this is a large government project I heard of that shipped with the logging kept turned on
p53071
aVBecause with it turned off it would no longer work and there was no good way to diagnose the problem without the logging info
p53072
aVThreat CHESS as a diagnostic tool
p53073
aVIf it raises a flag, you can be fairly sure that you have a real, but still hard to solve, threading problem
p53074
as(dp53075
g9
V17034
p53076
stp53077
a((dp53078
g2
(lp53079
VYes, this is a fairly infamous threading problem caused by the SystemEvents class
p53080
aVI never got a solid diagnostic for it but the 90% odds are that this is triggered by an initialization problem in your app
p53081
aVThe root problem is that SystemEvents gets initialized on-demand by the first form in your app that has controls that are interested in the events it generates
p53082
aVIf that first form is not created in the main thread then SystemEvents is helpless to guess at which thread is the UI thread in your program
p53083
aVEventually, when a notification is received (like UserPreferenceChanging), it tries to fire the event on that thread, but it isn't around anymore
p53084
aVThe fallback code in the SynchronizationContext class raises the event on a threadpool thread instead
p53085
aVThat inevitably invokes Threading Hell by running UI code on a thread that didn't create the window
p53086
aVLots of things can go wrong when that happens
p53087
aVDeadlock is a particularly common outcome when restoring the desktop after the workstation was locked
p53088
aVReview the startup sequence of your app
p53089
aVCreating your own splash screen is a good lead, do favor using the built-in support that the WindowsFormsApplicationBase class provides
p53090
aVAny place where you might create your own form on a worker thread is a red flag too
p53091
aVThis can be unintentional if you use VB
p53092
aVNET
p53093
as(dp53094
g9
V17034
p53095
stp53096
a((dp53097
g2
(lp53098
VYou can add a Form object to the ListBox
p53099
aVItems collection but the only thing you'll ever see is the type name of the form
p53100
aVListBox is not capable of rendering controls as its items
p53101
aVThe efficient solution is to implement the ListBox
p53102
aVDrawItem event and custom draw the tweet
p53103
aVThere's a good example of such an event handler in the MSDN Library documentation for the event
p53104
aVThe slow solution is to add controls to a Panel's Collection property with its AutoScroll property set to true
p53105
aVThat cannot be a form, it must be a UserControl
p53106
as(dp53107
g9
V17034
p53108
stp53109
a((dp53110
g2
(lp53111
VIt already works that way
p53112
aVYou do however have to use the Show(owner) overload so that the 'child' windows are always on top of your main window and cannot get lost behind the window of another application
p53113
aVAlmost any commercial program works like that
p53114
aVDistinguishing between Activated reasons is possible, Windows provides the window handle of the previously active window
p53115
aVWhich you could then check to see if it was one of your own windows
p53116
aVThis isn't however available in the event, you have to trap the message yourself
p53117
aVLike this:
p53118
as(dp53119
g9
V17034
p53120
stp53121
a((dp53122
g2
(lp53123
VDon't use depends
p53124
aVexe anymore, it hasn't kept up with developments in the Windows core and deployment strategies like the side-by-side cache
p53125
aVTrying to fix the warnings it gives will actually mess up your machine pretty badly
p53126
aVOnly use it for hints if a program actually fails to start
p53127
as(dp53128
g9
V17034
p53129
stp53130
a((dp53131
g2
(lp53132
VIt is the job of the operating system to provide that kind of info
p53133
aVFire up Perfmon
p53134
aVexe, select Performance Monitor
p53135
aVRight-click the graph area and click Add Counters
p53136
aVLook in the "Network Interface" section
p53137
aVBytes sent/sec gives you a good rate indicator
p53138
aVOr Current Bandwidth
p53139
aVThis is also available from C#, use the PerformanceCounter class
p53140
aVSelecting the right network interface can be a hassle, just keep in mind that the info is available at your fingertips with the performance monitor
p53141
aVThe user typically is only interested in how far the download progressed, there very little she can do to make it faster
p53142
aVSimple ProgressBar will do that job just fine
p53143
as(dp53144
g9
V17034
p53145
stp53146
a((dp53147
g2
(lp53148
VIt is quantifiable
p53149
aVOn my dual core laptop, the threadpool scheduler releases an extra tp thread twice a second if the running ones are not making progress
p53150
aVSo "long" is more than half a second
p53151
aVI do not know how this scales with beefier hardware
p53152
aVIt is easy to test, just start 16 tp threads and have them write DateTime
p53153
aVNow and Sleep(8001)
p53154
aVAlso, any thread that is very likely to block for extended periods, either on a lock or slow I/O should be a regular thread
p53155
aVBecause no useful work will be done by the processor, the blocking thread is preventing other tp threads that might have useful work to do from running for at least that half second
p53156
aVOf course, that makes such a thread almost automatically qualify as a "long" thread
p53157
as(dp53158
g9
V17034
p53159
stp53160
a((dp53161
g2
(lp53162
VShowDialog() returns a value that indicates what the user did with the dialog
p53163
aVUse it like this:
p53164
aVBe sure to set the dialog's DialogResult property in your OK button Click event handler:
p53165
aVAlthough it is automatic when you set the form's AcceptButton property
p53166
aVSetting the DialogResult also automatically closes the dialog
p53167
as(dp53168
g9
V17034
p53169
stp53170
a((dp53171
g2
(lp53172
VThey just use the standard Windows controls
p53173
aVSource code for notepad++ is available, look in src\u005cpowereditor\u005cwincontrols\u005ctoolbar\u005ctoolbar
p53174
aVcpp for the CreateWindowEx calls
p53175
as(dp53176
g9
V17034
p53177
stp53178
a((dp53179
g2
(lp53180
VThis is fine, the usual caveats for DoEvents do not apply here because you don't have a UI
p53181
aVThere are no ramifications, the rate is realistic
p53182
aVApplication
p53183
aVRun() also pumps the message loop but you'll have a harder time controlling the thread since the call doesn't return
p53184
aVYes, WPF pumps the message loop too but there's little point in using it since you don't have a UI
p53185
aVYou should initialize the service thread by calling SetApartmentState() to select STA
p53186
aVThis ensures that any COM server works properly
p53187
aVOh, one caveat that jumps to mind: you do need to do something to prevent the thread from burning 100% core
p53188
aVIt is automatic with Application
p53189
aVRun() but not with DoEvents in a 'game loop'
p53190
aVI think you already do since you can specify a 20 msec rate
p53191
aVOtherwise, calling WaitHandle
p53192
aVWaitOne(20) on the service stop request event is the typical approach
p53193
as(dp53194
g9
V17034
p53195
stp53196
a((dp53197
g2
(lp53198
VThat's evil code and bound to throw sooner or later
p53199
aVWindows cannot provide a service guarantee like that
p53200
aVOr for that matter the device itself, especially when you power it on and off
p53201
aVUse SerialPort
p53202
aVReadTimeout, set it to at least 2 seconds
p53203
aVAnd make a blocking call, like ReadLine()
p53204
aVThat's tops the previous snippet
p53205
aVYou have no idea what's going wrong when that runs
p53206
aVAnd your code will try to use a closed port
p53207
aVJust delete the statements, it does nothing but harm
p53208
aVDo not close the ports until your program ends
p53209
aVSerialPort uses a background thread to watch for events on the port, that thread needs to shutdown after the Close() call before you can open the port again
p53210
aVHow long it takes to shutdown is unpredictable, it could be seconds worst case
p53211
aVThere's no point in closing the port, it isn't going to be useful to anything else
p53212
as(dp53213
g9
V17034
p53214
stp53215
a((dp53216
g2
(lp53217
VVS2005 had a knack for crashing to the desktop when an exception was raised during design time
p53218
aVThat cannot be caused by the code you posted
p53219
aVI doubt we're looking at the real code, this control doesn't do anything
p53220
aVBe careful with the constructor and event handlers, they'll run a design time as well
p53221
aVIf you do anything that critically depends on the state of the program, like trying to open files or talk to a dbase server etcetera then avoid running such code by checking the this
p53222
aVDesignMode property
p53223
as(dp53224
g9
V17034
p53225
stp53226
a((dp53227
g2
(lp53228
VMoving a page that needs to be hidden into a List is the simple approach
p53229
aVHowever, such a hidden page also needs to be disposed when the form closes
p53230
aVIt won't be automatic anymore since the TabControl cannot see the page
p53231
aVAnd you can't ignore it, forgetting to dispose a control is a permanent leak
p53232
aVMake it look like this:
p53233
as(dp53234
g9
V17034
p53235
stp53236
a((dp53237
g2
(lp53238
VThis doesn't have to be difficult
p53239
aVDock a TreeView on the left, add a panel and set its Dock to Fill
p53240
aVThen use code like this to select a user control into it:
p53241
aVYou can get fancy on the TreeView by using reflection
p53242
aVIn the designer, set the node's Name property to the name of the user control (like "UserControl1")
p53243
aVAnd implement the BeforeSelect event similar to this:
p53244
aVThat's all
p53245
aVTweak the above code if the user controls are in a different namespace or in a different assembly
p53246
as(dp53247
g9
V17034
p53248
stp53249
a((dp53250
g2
(lp53251
VThis is a standard threading problem
p53252
aVEven if you could block the events, very hard to do, it still won't solve the problem
p53253
aVBecause the event handler might already have started, but not yet finished, by the time you want to start blocking
p53254
aVAnd it has a standard solution, use the lock keyword
p53255
aVIf that is not practical because the user needs to change several controls before you can run a query again then you need to terminate the running thread first
p53256
aVBackgroundWorker
p53257
aVCancelAsync for example
p53258
aVIf that's not practical because it takes too long to cancel the query then you need to set the controls Enabled property to false while the query is running
p53259
as(dp53260
g9
V17034
p53261
stp53262
a((dp53263
g2
(lp53264
VI'm sure you won't appreciate this answer but there's a very good reason that List<>
p53265
aVAdd() works this way
p53266
aVIt is very fast, it needs to be to be competitive with an array and because it is such a low-level method
p53267
aVIt is however just a hair too big to get inlined by the JIT optimizer
p53268
aVIt cannot optimize the return statement you'd need to return the list reference
p53269
aVWriting lst
p53270
aVAdd(obj) in your code is for free, the lst reference is available in a CPU register
p53271
aVA version of Add() that returns the reference makes the code almost 5% slower
p53272
aVIt's a lot worse for the proposed extension method, there an entire extra stack frame involved
p53273
as(dp53274
g9
V17034
p53275
stp53276
a((dp53277
g2
(lp53278
VThe actual implementation of ValueType
p53279
aVGetHashCode() doesn't quite match the comment
p53280
aVIt has two versions of the algorithm, fast and slow
p53281
aVIt first checks if the struct contains any members of a reference type and if there is any padding between the fields
p53282
aVPadding is empty space in a structure value, created when the JIT compiler aligns the fields
p53283
aVThere's padding in a struct that contains bool and int (3 bytes) but no padding when it contains int and int, they fit snugly together
p53284
aVWithout a reference and without padding, it can do the fast version since every bit in the structure value is a bit that belongs to a field value
p53285
aVIt simply xors 4 bytes at a time
p53286
aVYou'll get a 'good' hash code that considers all the members
p53287
aVMany simple structure types in the
p53288
aVNET framework behave this way, like Point and Size
p53289
aVFailing that test, it does the slow version, the moral equivalent of reflection
p53290
aVThat's what you get, your KeyValuePair<> contains references
p53291
aVAnd this one only checks the first candidate field, like the comment says
p53292
aVThis is surely a perf optimization, avoiding burning too much time
p53293
aVYes, nasty detail and not that widely known
p53294
aVIt is usually discovered when somebody notices that their collection code sucks mud
p53295
aVOne more excruciating detail: the fast version has a bug that bytes when the structure contains a field of a type decimal
p53296
aVThe values 12m and 12
p53297
aV0m are logically equal but they don't have the same bit pattern
p53298
aVGetHashCode() will say that they are not equal
p53299
aVOuch
p53300
as(dp53301
g9
V17034
p53302
stp53303
a((dp53304
g2
(lp53305
VI really do not want to install Visual Studio 2005 just to do this
p53306
aVWell, that's going to be difficult, you won't have the CRT include files if you don't do this
p53307
aVYou need them, especially to get the correct manifest
p53308
aVAnother obstacle is that the directories to search is a global setting, Tools + Options
p53309
aVYou'd have to carefully set the directories in the project settings so the 2005 directories always get searched first
p53310
aVInstalling 2005 takes half an hour, tops
p53311
aVTough to beat as soon as you hit the first snag, which ought to be getting the manifest right
p53312
as(dp53313
g9
V17034
p53314
stp53315
a((dp53316
g2
(lp53317
VYou're supposed to #define the _WIN32_WINNT macro to tell what version of Windows you want to support
p53318
aVThe default in the SDK that ships with VS2010 is 0x600 which avoids you ever linking to an API function that is not available in Vista
p53319
aVSo, yes, you're probably good to go
p53320
as(dp53321
g9
V17034
p53322
stp53323
a((dp53324
g2
(lp53325
VWhy are you doing this by hand
p53326
aVBinaryFormatter already knows how to do this automatically
p53327
aVIf filtering the fields is important then make another class that just stores the ones that you want to serialize
p53328
as(dp53329
g9
V17034
p53330
stp53331
a((dp53332
g2
(lp53333
VThis is fundamental about
p53334
aVNET, you never execute IL
p53335
aVThe JIT compiler translates it to machine code, the two have very little in common
p53336
aVYou cannot see IL executing, only machine code
p53337
aVYes, all you got to have some idea what the local variable value are is the Disassembly window and the Registers window
p53338
aVThe latter shows you what their value is when they get loaded in a CPU register
p53339
aVSome knowledge of x86 (or x64) assembly is required to see the correspondence between the C# and the assembly code to know what register contains what local variable
p53340
aVYou'd have to use a Memory window to look at the stack but that's quite impractical, you need to know the value of the ebp register and the offset
p53341
as(dp53342
g9
V17034
p53343
stp53344
a((dp53345
g2
(lp53346
VCheck your favorite C# programming book about the new keyword
p53347
aVThe brief version: it hides the base method, it doesn't override it
p53348
aVAnd it will thus never be called
p53349
aVDrop new virtual, use override, just like you did for the other methods
p53350
aVYou will also have to set the CanHandlePowerEvent property to true in the constructor
p53351
as(dp53352
g9
V17034
p53353
stp53354
a((dp53355
g2
(lp53356
VNo
p53357
aVThe library only covers the SMTP protocol, the communication with the server
p53358
aVIt does nothing to help you construct a valid MIME document
p53359
as(dp53360
g9
V17034
p53361
stp53362
a((dp53363
g2
(lp53364
VIf a debugger could see the internal state of a synchronization object then a program could as well
p53365
aVAllowing it to circumvent the API and use the object in a thread-unsafe manner
p53366
aVThis is for your own good, but of course an enormous pita when trying to debug threading problems
p53367
aVGood luck
p53368
as(dp53369
g9
V17034
p53370
stp53371
a((dp53372
g2
(lp53373
VIt is possible but you have to carefully control the file sharing you specify
p53374
aVMost
p53375
aVNET classes default to FileShare
p53376
aVRead, denying another process from writing to the file
p53377
aVBut that cannot work if the file is opened by Excel, it already gained write access to it
p53378
aVYou cannot deny a right that was already acquired
p53379
aVTo fix the problem, make your code look similar to this:
p53380
aVNote the use of FileShare
p53381
aVReadWrite
p53382
aVI verified this code works while Excel had test
p53383
aVcsv opened
p53384
aVBeware of the potential trouble you'll invite with this, odd things can happen when Excel writes to the file just as you are reading it
p53385
aVYou'll likely read garbage, part of old data, part of new, without a good way to diagnose this
p53386
as(dp53387
g9
V17034
p53388
stp53389
a((dp53390
g2
(lp53391
VThe IntelliSense parser was completely rewritten for VS2010
p53392
aVIt no longer uses the
p53393
aVncb file, it is now an
p53394
aVsdf file, a SQL Compact database
p53395
aVIf you program in the C++/CLI language then you'll get no IntelliSense at all, the current implementation doesn't support that language
p53396
aVI've also seen feedback that C isn't well supported either yet
p53397
as(dp53398
g9
V17034
p53399
stp53400
a((dp53401
g2
(lp53402
VYou've got a deadlock problem, so common in threaded code
p53403
aVVS2010 isn't magically going to make it disappear
p53404
aVThere's a new class in
p53405
aVNET 4
p53406
aV0 called Task, it simplifies the job of managing threads
p53407
aVBut is just as likely to suffer from deadlock if your original code is already triggering it
p53408
aVYou could rewrite the code with tasks and get lucky
p53409
aVThat kind of luck is usually short-lived, it will deadlock once a month instead of once an hour
p53410
aVFar worse since it is so much harder to troubleshoot
p53411
aVSolve the problem first, consider improving it only after that
p53412
aVAnd the time you'll spent on chasing this problem is well worth it, you'll know a lot more about threading when you're done
p53413
as(dp53414
g9
V17034
p53415
stp53416
a((dp53417
g2
(lp53418
VIExtenderProvider is not a suitable solution to this, it was meant to add new properties to existing controls
p53419
aVThe generic approach is quite simple: use a Panel
p53420
aVPut all the controls you want to disable or hide in that panel
p53421
aVAnd set the panel's Visible or Enabled property to false
p53422
aVThis will automatically disable all the child controls of the panel
p53423
aVAnd when you hide the panel, its children will be hidden too
p53424
as(dp53425
g9
V17034
p53426
stp53427
a((dp53428
g2
(lp53429
VEverybody misunderstands your question because Windows doesn't actually have a "system configuration" feature
p53430
aVThe Msconfig
p53431
aVexe tool doesn't show anything like the info that GetSystemMetrics returns
p53432
aVGetSystemMerics is well covered by the SystemParameters class
p53433
aVThere's a wealth of info available from WMI queries, supported by the System
p53434
aVManagement class
p53435
aVThe best way to play with that is the WMI Code Creator tool, it lets you run queries and can automatically generate the C# code for them
p53436
as(dp53437
g9
V17034
p53438
stp53439
a((dp53440
g2
(lp53441
VYes, there is a definitely coupling between the language and the support assemblies in the
p53442
aVNET framework
p53443
aVBy far the most important one is mscorlib
p53444
aVdll, the home for the System
p53445
aVIDisposable interface declaration
p53446
aVIt is so important that it isn't even listed in your C# project's References node
p53447
aVThe C# compiler assumes it is always needed and will find it by itself, unless you use the special /nostdlib compile option
p53448
aVOther examples of syntactic elements that require it:
p53449
aVarray[], requires System
p53450
aVArray
p53451
aV[attributes], requires System
p53452
aVAttribute
p53453
aVcatch, requires System
p53454
aVException
p53455
aVdelegate, requires System
p53456
aVMulticastDelegate
p53457
aVtype
p53458
aV, requires System
p53459
aVNullable<>
p53460
aVparams, requires System
p53461
aVParamArrayAttribute
p53462
aVtypeof, requires System
p53463
aVType
p53464
aVThere's coupling between all the basic types and their corresponding declaration in mscorlib (like Int32, String, Object, ValueType etc)
p53465
aVLater examples are the Linq query comprehension syntax, requiring System
p53466
aVCore
p53467
aVdll, and the dynamic keyword, requiring Microsoft
p53468
aVCSharp
p53469
aVdll
p53470
aVThese examples are by no means exhaustive
p53471
aVThis is otherwise quite normal, even C compilers assume that a runtime library is available with primitives like memset() and ldiv()
p53472
as(dp53473
g9
V17034
p53474
stp53475
a((dp53476
g2
(lp53477
VThis is a historical limitation, at least on Windows
p53478
aVThe GDI primitives, like DrawTextEx don't support transparency
p53479
aVThey will simply ignore the alpha channel
p53480
aVThis restriction is solved by graphics libraries like GDI+ and Milcore
p53481
aVBut there's only one TrueType renderer and it does a job too untrivial to be easily replaced
p53482
aVYour screenshot shows it running inside a regular Windows window so the restriction is very likely to apply
p53483
aVNot sure if this is different on a console
p53484
aVA possible workaround is to use a function similar to GraphicsPath
p53485
aVAddString()
p53486
aVYou will however lose the ClearType anti-aliasing effect
p53487
aVNot so sure that matters in XNA
p53488
aVNor do I know it well enough to suggest the equivalent of GraphicsPath
p53489
as(dp53490
g9
V17034
p53491
stp53492
a((dp53493
g2
(lp53494
VNothing special is needed, your custom code will be used as soon as the button gets its first paint notification
p53495
aVA possible mistake is the location of the base
p53496
aVOnPaint() call
p53497
aVThis will not work for example:
p53498
aVThe base
p53499
aVOnPaint() method draws the default appearance of the button, wiping out your customization
p53500
aVYou have to call base
p53501
aVOnPaint() before drawing your stuff:
p53502
as(dp53503
g9
V17034
p53504
stp53505
a((dp53506
g2
(lp53507
VYour current code is overwriting the passed pointer
p53508
aVYou need to retrieve the pointer and write through it
p53509
aVSomething like this:
p53510
aVWrite this code in C first and look at the assembly code that it generates to get this right
p53511
as(dp53512
g9
V17034
p53513
stp53514
a((dp53515
g2
(lp53516
VWell, yes, it is a problem when you register it but it will be a much larger problem when a client actually uses your COM server
p53517
aVA typical COM client will be unmanaged code, it isn't very practical to give it, say, a
p53518
aVconfig file to tell the CLR where to look for assembly B
p53519
aVIf you want this to work for any client without config then you ought to put B in the GAC
p53520
aVWhich in general is the proper place for COM servers, DLL Hell is nothing to mess with when you use COM
p53521
aVUsing the Assembly
p53522
aVAssemblyResolve event is probably not going to be practical but you could try by using a static class constructor to register the event handler
p53523
aVHard coding the path to dependencies is questionable unless those folders are always related
p53524
as(dp53525
g9
V17034
p53526
stp53527
a((dp53528
g2
(lp53529
VThat's very bad
p53530
aVYou are throwing away the bytes you have just written
p53531
aVThe WriteLine() method writes the command to the output buffer from which they are slowly written to the serial port
p53532
aVOnly if you debug the code, single stepping through the code, would the serial port driver have enough of a chance to actually send something
p53533
aVIt would be hit or miss if the chip itself has a FIFO buffer
p53534
aVJust delete the DiscardOutBuffer() call, it does nothing but harm
p53535
aVBeyond that, you are really complaining about a problem with receiving a response
p53536
aVBut didn't show any code that makes any Read call
p53537
as(dp53538
g9
V17034
p53539
stp53540
a((dp53541
g2
(lp53542
VThe type of the 1 literal is int
p53543
aVEither constructor is going to need a conversion, int to int64_t vs int to long double
p53544
aVThe compiler doesn't think either of them is preferable so it complains
p53545
aVSolve it by adding a Foo(int) constructor
p53546
aVOr casting the literal, like (int64_t)1
p53547
as(dp53548
g9
V17034
p53549
stp53550
a((dp53551
g2
(lp53552
VI can't tell whether this code is present in a KeyDown or KeyPress event handler
p53553
aVIf you want to filter typing keys then you should use KeyPress
p53554
aVAnd the code is then simply:
p53555
as(dp53556
g9
V17034
p53557
stp53558
a((dp53559
g2
(lp53560
VTrue transparency doesn't exist in Windows Forms
p53561
aVIt is a Windows restriction, it doesn't support it on child windows
p53562
aVThere are a few workaround tricks for it, like the WS_EX_TRANSPARENT window style and some support built into winforms for a BackColor that's transparent
p53563
aVThey both work by asking the parent of the control to draw itself in the control window, providing the background pixels
p53564
aVThis breaks down when you start to overlap controls, you see the background of the parent (the form usually), not the overlapped control
p53565
aVAnd if your form's BackColor is white then you'll indeed see white, not the gradient of the intermediate control
p53566
aVThere's no practical workaround for this
p53567
aVIf you want true transparency then you should consider WPF
p53568
aVIt doesn't use windows, just layers of paint
p53569
aVTransparency is now trivial, just don't draw
p53570
as(dp53571
g9
V17034
p53572
stp53573
a((dp53574
g2
(lp53575
VThe best way to tackle this is to provide overloads of the function so everything is squeaky clean on the C# side
p53576
aVLike this:
p53577
as(dp53578
g9
V17034
p53579
stp53580
a((dp53581
g2
(lp53582
VAccording to Effective C#, should all classes which uses unmanaged code implement both IDisposable and a finalizer
p53583
aVNo, this is about using unmanaged resources, not code
p53584
aVIn Windows, resources are almost invariably represented by 'handles'
p53585
aVUnmanaged code in itself is not a resource, there is no kernel object associated with it beyond the handle for the DLL, a handle you don't have access to
p53586
aVThe argument you pass to SetForegroundWindow is indeed one of those resources
p53587
aVIt is a handle to a window
p53588
aVBut you didn't create that window yourself, you're trying to set the focus to some window that was already created and is managed by other code
p53589
aVYou should not dispose objects that you didn't create
p53590
aVNotable too is that the advice is outdated
p53591
aVWindows handles should be wrapped by one of the SafeHandle derived classes
p53592
aVThey already provide a finalizer, you shouldn't implement your own
p53593
aVJust implement Dispose() and call the SafeHandle
p53594
aVDispose() method
p53595
as(dp53596
g9
V17034
p53597
stp53598
a((dp53599
g2
(lp53600
VThat's not possible
p53601
aVThe workaround is trivial, just don't put any text in the sub-item
p53602
as(dp53603
g9
V17034
p53604
stp53605
a((dp53606
g2
(lp53607
VThis is the likely implementation for Interlocked
p53608
aVExchange() in the CLR, copied from the SSCLI20 source:
p53609
aVIt is superior to using XCHG because this code works without taking a bus lock
p53610
aVThe odd looking jumping code is an optimization in case branch prediction data is not available
p53611
aVNeedless to say perhaps, trying to do a better job than what has been mulled over for many years by very good software engineers with generous helpings from the chip manufacturers is a tall task
p53612
as(dp53613
g9
V17034
p53614
stp53615
a((dp53616
g2
(lp53617
VThis is risky, there's a lot more to it than just searching the directories in the PATH
p53618
aVTry this:
p53619
aVThe executable is stored in c:\u005cProgram Files\u005cWindows NT\u005cAccessories on my machine, that directory is not on the path
p53620
aVThe HKEY_LOCAL_MACHINE\u005cSOFTWARE\u005cMicrosoft\u005cWindows\u005cCurrentVersion\u005cApp Paths key plays a role in finding executables
p53621
aVI'm fairly sure there are additional land-mines like this around, directory virtualization in 64-bit versions of Windows could trip you up for example
p53622
aVTo make this more reliable, I think you need to pinvoke AssocQueryString()
p53623
aVNot sure, never had the need
p53624
aVThe better approach is certainly to not have to ask the question
p53625
as(dp53626
g9
V17034
p53627
stp53628
a((dp53629
g2
(lp53630
VWindows Forms has strong counter-measures against doing this
p53631
aVMost controls store the event handler reference in a list that requires a secret 'cookie'
p53632
aVThe cookie value is dynamically created, you cannot guess it up front
p53633
aVReflection is a backdoor, you have to know the cookie variable name
p53634
aVThe one for the Control
p53635
aVClick event is named "EventClick" for example, you can see this in the Reference Source or with Reflector
p53636
aVThis is all incredibly unpractical, if you're getting the feeling you are doing something unwise then you're on the right track
p53637
aVYou can find sample code that does this in my answer in this thread
p53638
as(dp53639
g9
V17034
p53640
stp53641
a((dp53642
g2
(lp53643
VYes you do
p53644
aVBut not on the iBrowser, you didn't acquire that pointer inside this code
p53645
aVBeware that your error checking isn't sufficient, your code will bomb when get_Document() fails
p53646
aVSame for get_parentElement()
p53647
aVAnd after the message box is dismissed
p53648
as(dp53649
g9
V17034
p53650
stp53651
a((dp53652
g2
(lp53653
VBig difference
p53654
aVA custom build step allows you to specify dependencies and outputs
p53655
aVWhich allows the build system to determine when to execute the step and to skip it when the output is already up to date
p53656
aVA post-build event is always executed when the project requires building and its timing is fixed
p53657
as(dp53658
g9
V17034
p53659
stp53660
a((dp53661
g2
(lp53662
VOne clear reason to not use an enumerator is when you need IEnumerator<>
p53663
aVReset() to work
p53664
aVIterators are very nice, but they can't escape the "there's no free lunch" principle
p53665
aVYou won't find them used in the
p53666
aVNET framework collection code
p53667
aVThere's a good reason for that, they can't be as efficient as a dedicated implementation
p53668
aVNow that mattered to the
p53669
aVNET designers, they couldn't predict when efficiency matters
p53670
aVYou can, you know whether your code is in the critical path of your program
p53671
aVIterators are a bit over twice as slow as a dedicated implementation
p53672
aVAt least that's what I measured by testing the List<> iterator
p53673
aVWatch out for micro optimizations, they are still really fast and their big Oh is the same
p53674
aVI'll include the testing code so you can verify this for yourself:
p53675
as(dp53676
g9
V17034
p53677
stp53678
a((dp53679
g2
(lp53680
VYeah, no problem
p53681
aVSet the form's ControlBox property to False and the Text property to an empty string
p53682
aVThe menu is tougher, you'll have to approximate it with a ContextMenuStrip
p53683
aVGoogle WM_NCHITTEST to restore the window behavior that is lost because of the missing title bar
p53684
as(dp53685
g9
V17034
p53686
stp53687
a((dp53688
g2
(lp53689
VIt's a fairly classic sign of DLL Hell
p53690
aVVB6 generates new interface IIDs when the code is modified
p53691
aVMaking it likely that the COM server on the target PC is not the same version as the one you built your program against
p53692
as(dp53693
g9
V17034
p53694
stp53695
a((dp53696
g2
(lp53697
VYou'll want to take a look at the Microsoft Research Common Compiler Infrastructure (CCI) project
p53698
aVIt provides everything you need to generate the metadata and the MSIL for an assembly
p53699
aVAnd the debugging
p53700
aVpdb file, rather important to get your language going
p53701
aVThere's a sister project that might be useful as well, depends how far along you got
p53702
as(dp53703
g9
V17034
p53704
stp53705
a((dp53706
g2
(lp53707
VJust call WPF's Application
p53708
aVRun()
p53709
aVOr Window
p53710
aVShowDialog(), same thing
p53711
aVYou will also have to apply the [STAThread] attribute on your Main() method
p53712
as(dp53713
g9
V17034
p53714
stp53715
a((dp53716
g2
(lp53717
VThat's not possible
p53718
aVThe native Windows control has hard-coded behavior to make the tip disappear when it has been shown long enough
p53719
aVThere's no way to override that behavior
p53720
aVA tooltip that is permanent is a Label
p53721
as(dp53722
g9
V17034
p53723
stp53724
a((dp53725
g2
(lp53726
VIt's a pretty classic problem with VB
p53727
aVNET, the pinvoke declaration is wrong
p53728
aVThe one you use only works for VB6, a language that for historical reasons uses Integer for a 16-bit number, Long for a 32-bit number
p53729
aVThis goes back to early versions of VB that ran on 16-bit operating systems
p53730
aVVB
p53731
aVNET was redesigned to work well on 32-bit operating systems, its Integer is 32 bits, its Long is 64 bits
p53732
aVYou have to declare the arguments as Integer
p53733
aVIt works in 64-bit mode by accident
p53734
aVUse pinvoke
p53735
aVnet to get the proper declaration
p53736
aVAnd take a good look at Graphics
p53737
aVCopyFromScreen and Control
p53738
aVDrawToBitmap for very similar functionality without needing pinvoke
p53739
as(dp53740
g9
V17034
p53741
stp53742
a((dp53743
g2
(lp53744
VUse two GroupBoxes (frame) or Panels (no frame)
p53745
aVGroupBox is best, it shows the user what radio buttons belong together
p53746
as(dp53747
g9
V17034
p53748
stp53749
a((dp53750
g2
(lp53751
VJust use the old way, there's nothing in 4
p53752
aV0 that makes this method any easier to use
p53753
aVAdd a reference to the COM type library, usually the DLL itself, and you should get a class with the method bool MethodName(ref object)
p53754
aVWhat you are supposed to do with the object is completely unclear from your question
p53755
aVCheck the API manual, get help from the component vendor
p53756
as(dp53757
g9
V17034
p53758
stp53759
a((dp53760
g2
(lp53761
VThis is easy to test in a Windows Forms app
p53762
aVThis is what I saw:
p53763
aVWM_SHOWWINDOW would be a good time to check if the parent changed
p53764
aVNot 100% sure if this is a side effect of the WF code taking care of the changed parent, the odds are fairly high
p53765
aVThere is otherwise no dedicated message for it, the assumption is that the program already knows since it called SetParent or SetWindowLongPtr explicitly
p53766
as(dp53767
g9
V17034
p53768
stp53769
a((dp53770
g2
(lp53771
VThis restriction exists because the referenced assembly must be registered on the server first
p53772
aVExecute the CREATE ASSEMBLY sql statement, I used this one to test it:
p53773
aVNext, use Add Reference on your database project, the registered assembly shows up in SQL Server tab
p53774
as(dp53775
g9
V17034
p53776
stp53777
a((dp53778
g2
(lp53779
VBecause you might want to catch one of them
p53780
aVYou can't selectively catch an exception if they are all raised as Exception
p53781
as(dp53782
g9
V17034
p53783
stp53784
a((dp53785
g2
(lp53786
VOh Lord, no
p53787
aVWMI is farking painful in C++, System
p53788
aVManagement is a very nice wrapper around the COM code you'd have to write in C++
p53789
aVYou don't even have to write the C# code yourself
p53790
aVDownload the WMI Code Creator Tool, it lets you play with the queries and it automatically generates the C# code to cut-and-paste into your project
p53791
as(dp53792
g9
V17034
p53793
stp53794
a((dp53795
g2
(lp53796
VRemove the Pack property from the [DllImport] declaration, it is wrong
p53797
aVYou are not using a #pragma pack directive in your C code, the default value for Pack is appropriate
p53798
aVIf it would have been in effect then your C code would have reported 16
p53799
aVYou are seeing 24 because there's 4 bytes of padding to align the double and 4 bytes of padding at the end of the structure to make the double align when the structure is used in an array
p53800
aV4 + 4 + 8 + 4 + 4 = 24
p53801
aVThe packing in effect is 8, the default
p53802
aVYou can make it more efficient by swapping Value2 and Value3 to get a struct of 16 bytes, no padding necessary
p53803
aVIn case it matters
p53804
aVThat's what the JIT compiler does
p53805
aVThe next problem is tougher, the P/Invoke marshaller will marshal the embedded array as a SAFEARRAY
p53806
aVYou can solve that on the unmanaged side by using this code:
p53807
aVI wrote the code using the C++ compiler, you may have to tweak
p53808
as(dp53809
g9
V17034
p53810
stp53811
a((dp53812
g2
(lp53813
VYou are digging yourself a deeper hole
p53814
aVThis goes wrong early, the size of the rotated bitmap is not Width x Height
p53815
aVIt is also very inefficient
p53816
aVYou need to get RotateTransform going, it is important to also use TranslateTransform and pick the correct image drawing location
p53817
aVHere's a sample Windows Forms app that rotates a bitmap around its center point, offset just enough to touch the inner edge of the form when it rotates
p53818
aVDrop a Timer on the form and add an image resource with Project + Properties, Resource tab
p53819
aVName it SampleImage, it doesn't have to be square
p53820
aVMake the code look like this:
p53821
aVYou can make draw a lot faster by creating a bitmap in the 32bppPArgb format, I skipped that step
p53822
as(dp53823
g9
V17034
p53824
stp53825
a((dp53826
g2
(lp53827
VDo not use Assembly
p53828
aVLoadFile(), it loads assemblies without a loading context
p53829
aVUse LoadFrom() instead
p53830
aVThe exception message is pretty meaningless, not the kind you'd get out the
p53831
aVNET framework code
p53832
aVYou need to look at the stack trace of the InnerException to know where it got raised
p53833
as(dp53834
g9
V17034
p53835
stp53836
a((dp53837
g2
(lp53838
VThe Wow6432 key contains the registry keys that a 32-bit program sees
p53839
aVProject + Properties, Build tab, check your Platform target setting
p53840
aVIt defaults to x86 in VS2010
p53841
aVRegistry redirection can be changed but not with the
p53842
aVNET RegistryKey class
p53843
aVYou'd have to pinvoke the registry API functions
p53844
aVMore background info is available in the SDK
p53845
as(dp53846
g9
V17034
p53847
stp53848
a((dp53849
g2
(lp53850
VWhat you quoted is quite inappropriate for
p53851
aVNET assemblies
p53852
aVThe Windows side-by-side cache is for unmanaged DLLs, the exact equivalent in
p53853
aVNET is the GAC
p53854
aVFurthermore, the compiler already embeds references to the dependent assemblies in the assembly manifest
p53855
aVYou can see it if you run Ildasm
p53856
aVexe on your assembly
p53857
aVDouble-click the manifest, you'll see the
p53858
aVassembly directives listed
p53859
aVFwiw, embedding your own Windows manifest in a class library is not a problem
p53860
aVJust use Project + Add New Item and select the Application Manifest File template item
p53861
aVThe auto-generated content is completely wrong for a DLL of course but it does get embedded in the DLL
p53862
aVYou can see that by using File + Open + File and selecting your assembly
p53863
aVYou'll see the RT_MANIFEST with resource ID 2
p53864
aVJust to reiterate: don't do this for a managed DLL unless you want to enter reg-free COM directives
p53865
as(dp53866
g9
V17034
p53867
stp53868
a((dp53869
g2
(lp53870
VThe this argument is wrong, it refers to your Page class
p53871
aVPass instance_class instead
p53872
as(dp53873
g9
V17034
p53874
stp53875
a((dp53876
g2
(lp53877
VThat's not how you'd declare it in C
p53878
aVIf the record in the file contains a string then you'd declare the structure similar to:
p53879
aVThe equivalent C# declaration would look like:
p53880
aVYou'd normally use BinaryReader to read the data
p53881
aVBut it cannot handle strings like this directly, you have to read them as a byte[] and do the string conversion yourself
p53882
aVYou also cannot take advantage of the declarative syntax, you have to write a call for each individual member of the struct
p53883
aVThere's a workaround for that, the Marshal class already knows how to convert unmanaged structures to managed ones with the PtrToStructure() method
p53884
aVHere's a generic implementation, it works for any blittable type
p53885
aVTwo versions, a static one that reads from a byte[] and an instance method that was optimized to repeatedly read from a stream
p53886
aVYou'd use a FileStream or MemoryStream with that one
p53887
aVUntested, hope it works
p53888
as(dp53889
g9
V17034
p53890
stp53891
a((dp53892
g2
(lp53893
VUse Project + Add Existing Item and select the DLL
p53894
aVSelect the added file in the Solution Explorer window
p53895
aVIn the Properties window, change the Copy to Output Directory setting to "Copy if newer"
p53896
as(dp53897
g9
V17034
p53898
stp53899
a((dp53900
g2
(lp53901
VThis would be a very good example of code where you don't want to use the as operator
p53902
aVClearly you cannot afford the cast to fail or you would have included a null test and did something meaningful if the cast failed
p53903
aVUse a real cast
p53904
aVYou'll get an informative exception that gives you a much better hint why the cast failed:
p53905
aVExceptions are your friend, don't avoid them
p53906
aVTaking a wild guess: this could happen when you use a COM object in a thread and the COM server doesn't support marshaling
p53907
aVIf that's the case then the exception message will tell you so
p53908
as(dp53909
g9
V17034
p53910
stp53911
a((dp53912
g2
(lp53913
VArbitrarily pick one of the DLL projects as the startup project, it doesn't matter which
p53914
aVRight-click + Properties, Debugging
p53915
aVSet the 'Command' setting to the path of a test EXE that will load the DLLs
p53916
aVIf you don't have a good one then just write one, might as well add it to the project and make it the startup project
p53917
aVPay attention to the Output window while the EXE starts
p53918
aVYou'll see notifications for each DLL that gets loaded
p53919
aVAs soon as one of the DLLs that's in your solution gets loaded then the debugger jumps in, looks for the
p53920
aVpdb file for the DLL and activates any breakpoints you'd have set in the DLL source code
p53921
aVYou cannot debug the DLL unless the EXE loads it
p53922
aVIf that still doesn't enable breakpoints then use Debug + Windows + Modules and locate the DLL in the list
p53923
aVRight-click it and choose Symbol Load Information to find out where the debugger looked for the
p53924
aVpdb file
p53925
aVThis doesn't go wrong very often since the DLL contains the path to the
p53926
aVpdb file
p53927
aVThe far more typical failure mode is that the EXE simply didn't load the DLL
p53928
as(dp53929
g9
V17034
p53930
stp53931
a((dp53932
g2
(lp53933
VThat's in general not possible
p53934
aVThe callback is made on a threadpool thread, you cannot wave a magic flag and ask "don't fire please"
p53935
aVEven if it were possible, that's an inevitable race condition, the thread might have already been started but didn't get a chance to execute yet
p53936
aVAll you can do is block the thread, use a critical section or a mutex in your callback
p53937
aVAcquiring the mutex when your UI thread is 'not idle' is pretty unpractical, you'd have to do so in your message loop
p53938
aVIn general, you only want to protect shared state, variables that are both accessed in your UI thread and your callback
p53939
aVIf you are contemplating this because you don't want the callback to consume CPU cycles while your UI thread is busy then keep in mind that almost any machine nowadays has at least two CPU cores
p53940
aVThat problem doesn't need to be fixed
p53941
as(dp53942
g9
V17034
p53943
stp53944
a((dp53945
g2
(lp53946
VYeah, 1, a Setup and Deployment project, easy peasy
p53947
aVHow to configure the setup project to install the service with a custom action is described in detail in the "Creating a service application" walkthrough
p53948
as(dp53949
g9
V17034
p53950
stp53951
a((dp53952
g2
(lp53953
VThis is an unusual problem but it can happen
p53954
aVWMI is COM based, the IWbemClassObject is a COM interface that gets an RCW wrapper
p53955
aVThese wrappers don't get cleaned-up until the finalizer thread runs
p53956
aVIt is technically possible to run a lot of WMI queries but not do enough work with the results to get the garbage collector to run
p53957
aVDiagnose this with Perfmon
p53958
aVexe, Performance Monitor
p53959
aVRight click the graph, Add Counters,
p53960
aVNET CLR memory and add the # Gen 0 Collections counter
p53961
aVSelect your program from the bottom list
p53962
aVObserve the counter while your program is running
p53963
aVYou'll have this problem if it is not ticking up
p53964
aVIf this is the case, review your code and verify if it still makes sense to run so many queries but never or rarely use the results
p53965
aVA workaround is to count them and every, say, 100,000 times call GC
p53966
aVCollect() and GC
p53967
aVWaitForPendingFinalizers()
p53968
as(dp53969
g9
V17034
p53970
stp53971
a((dp53972
g2
(lp53973
VYou need to read as many bytes as will fit in the buffer
p53974
aVRight now, you don't have a buffer yet, all you got is a pointer to a buffer
p53975
aVThat isn't initialized to anything
p53976
aVChicken-and-egg, you therefore don't know how many bytes to read either
p53977
aVCreate a buffer
p53978
as(dp53979
g9
V17034
p53980
stp53981
a((dp53982
g2
(lp53983
VThe dialog just works in a fairly bizarre way
p53984
aVIt always shows up the way you see it in your screen shot, whatever the state of the ReadOnly attribute
p53985
aVThe checkbox is in the 'indetermined' state
p53986
aVYou have to click it and either clear or check it to make it perform its action
p53987
aVAnd in spite of the prompt text (but not the hint next to the checkbox), it only changes the ReadOnly attribute on the files in the directory, not the directory itself
p53988
aVUse the attrib command line command to see what is really going on
p53989
aVIn all likelihood, your code fails because the directory contains files that have their ReadOnly attribute set
p53990
aVYou'll have to iterate them
p53991
as(dp53992
g9
V17034
p53993
stp53994
a((dp53995
g2
(lp53996
VYou are doing something seriously wrong if you get times like that
p53997
aVFloat comparisons are dramatically fast, I clock them at 2 nanoseconds with the loop overhead
p53998
aVCrafting a test like this is tricky because the JIT compiler will optimize stuff away if you don't use the result of the comparison
p53999
aVThe structure is slightly faster, 1
p54000
aV96 nanoseconds vs 2
p54001
aV20 nanoseconds for the float[] on my laptop
p54002
aVThat's the way it should be, accessing the Y member of the struct doesn't cost an extra array index
p54003
aVTest code:
p54004
as(dp54005
g9
V17034
p54006
stp54007
a((dp54008
g2
(lp54009
VNot sure what "clean version" means but clearly the GUIDs in the interop library no longer match the GUIDs used by the ActiveX controls
p54010
aVGetting 0x80040154 is the result, it can no longer find the ActiveX registry keys
p54011
aVControlling the build process and keeping the ActiveX controls in sync with the interop wrappers is pretty important or you'll be battling this problem long-term
p54012
aVGenerating them ought to be associated with building the controls
p54013
aVThis can be especially a problem if the controls were created in VB6
p54014
aVIt is quick to assign new GUIDs unless you setup its binary compatibility feature
p54015
as(dp54016
g9
V17034
p54017
stp54018
a((dp54019
g2
(lp54020
VYou could iterate the windows with EnumWindows to find the hidden window that is associated with the tray icon
p54021
aVThat's all rather fugly and error prone
p54022
aVDo this cleanly, have these 'server apps' create a named pipe
p54023
aVYou can connect to them in your manager app by using the well-known name and then send them a command
p54024
aVSystem
p54025
aVIO
p54026
aVPipes namespace
p54027
as(dp54028
g9
V17034
p54029
stp54030
a((dp54031
g2
(lp54032
VSurely your unit test runner produces a good log that shows the exact exception message or error
p54033
aVIt's kinda pointless to guess at it but an "access denied" kind of error would be an obvious candidate
p54034
aVSetup whatever dbase engine you use (you forgot to mention that too) to give the user account that runs the tests on the build grunt access to the tables
p54035
as(dp54036
g9
V17034
p54037
stp54038
a((dp54039
g2
(lp54040
VIt is pointless to prevent this
p54041
aVThe client code can always cast it to object
p54042
as(dp54043
g9
V17034
p54044
stp54045
a((dp54046
g2
(lp54047
VStart killing processes with Taskmgr
p54048
aVexe, Processes tab
p54049
aVYou'll eventually find the one that's sucking Ctrl + M with a windows hook
p54050
aVJust to confirm, from more than one question and comment about this, it is the Microsoft Bing toolbar that causes the problem
p54051
aVUninstalling it is the only known workaround right now
p54052
as(dp54053
g9
V17034
p54054
stp54055
a((dp54056
g2
(lp54057
VYes, the scenario can occur
p54058
aVYes it can deadlock if you don't declare the bool variable as volatile
p54059
aVJust don't use a bool, use an event like you did
p54060
aVThe logic looks weird, it smells like you are trying to let the main thread wait for the processing to be completed
p54061
aVThe workDoneEvent doesn't actually signal that the work was done
p54062
aVRight now the main thread will check the assert before the worker is done, that can't be good
p54063
aVIf the intention was that it signals that the worker is done then ProcessAndSignal should be the one calling Set(), at the end of the method
p54064
aVAnd the main thread should call WaitOne()
p54065
aVIf this is at all accurate then you just should not use QUWI, just call ProcessAndSignal directly without using a thread
p54066
aVFar more efficient, zero odds for threading problems
p54067
as(dp54068
g9
V17034
p54069
stp54070
a((dp54071
g2
(lp54072
VThe full name for the method is Microsoft
p54073
aVVisualBasic
p54074
aVDateAndTime
p54075
aVYear(DateTime)
p54076
aVThis is a compat function
p54077
aVSince you need to pass a DateTime argument anyway, you might as well use its Year property
p54078
aVAlbeit that the VB version can be different because it uses the current culture calendar's GetYear() method
p54079
aVIn other words, in Israel your program might get the year since the destruction of the temple in Jerusalem (I think)
p54080
aVNot sure if that should be intentional in your case
p54081
as(dp54082
g9
V17034
p54083
stp54084
a((dp54085
g2
(lp54086
VIt is stored in the unmanaged resource section of an executable
p54087
aVYou can see that section with File + Open + File and selecting the DLL or EXE
p54088
aVOpen the Icon node
p54089
aVThe lowest numbered resource is the one that Windows picks as the application icon
p54090
aVThere's spotty support in the
p54091
aVNET framework for accessing the unmanaged resources of a binary
p54092
aVYour best bet here is to use Icon
p54093
aVExtractAssociatedIcon() but you cannot control  which of the images in the icon you'll get
p54094
aVThe pinvoke fallback is LoadImage() but it is difficult to use
p54095
aVBy far the best approach is to also make the icon available in your managed resources
p54096
as(dp54097
g9
V17034
p54098
stp54099
a((dp54100
g2
(lp54101
VYou cannot dispose dictionaries, only the garbage collector gets rid of them
p54102
aVSetting the dictionary reference to null in a timer's Tick event would get the job done, eventually
p54103
aVLook at the WeakReference class
p54104
as(dp54105
g9
V17034
p54106
stp54107
a((dp54108
g2
(lp54109
V"Ownership" has no meaning here, these are completely unrelated classes
p54110
aVAt best you could jump through the InternalsVisibleTo attribute hoop
p54111
as(dp54112
g9
V17034
p54113
stp54114
a((dp54115
g2
(lp54116
VYes, this is the typical nemesis for keyboard filtering
p54117
aVThe TextBox control doesn't have any built-in events to intercept a paste from the clipboard
p54118
aVYou'll have to detect the Ctrl+V keypress yourself and screen Clipboard
p54119
aVGetText()
p54120
aVThe logic is tricky to get right
p54121
aVHere's a class that can make all this a little easier
p54122
aVAdd a new class to your project and paste the code shown below
p54123
aVCompile
p54124
aVDrop the new control from the top of the toolbox onto a form
p54125
aVDouble click it and write the ValidateChar event handler
p54126
aVLike this one, only allowing entering digits:
p54127
aVThe code:
p54128
as(dp54129
g9
V17034
p54130
stp54131
a((dp54132
g2
(lp54133
VYour project crashed Visual Studio
p54134
aVIt's a bug in VS, the exception code indicates that it is making a call to the C runtime library with an invalid argument
p54135
aVThat immediately terminates the program
p54136
aVThis is going to be difficult to deal with, the bug lives deep inside the VS codebase no doubt
p54137
aVIt is likely that it has something to do with your project but it is next to impossible to diagnose exactly what might be wrong with it
p54138
aVYou'll need some trained eyes to spot the potential mistake, if any
p54139
aVIf you don't have anybody inside your own company to do this for you, you can call Microsoft Support to get help
p54140
aVThey will need your project so they can repro the crash
p54141
aVBest thing to do is the provide a minimum repro project, one that easily demonstrates the bug
p54142
aVHave it ready to upload before you call, along with your credit card
p54143
aVIn the process of creating this repro project, you often discover the reason
p54144
as(dp54145
g9
V17034
p54146
stp54147
a((dp54148
g2
(lp54149
VYou will have to use an interprocess communication mechanism that's supported by
p54150
aVNET
p54151
aVThe standard ones are named pipes, sockets and WCF
p54152
aVThis is always painful and it tends to destabilize your product since failure is so difficult to deal with
p54153
aVYou'll need ten really good reasons to want to do this
p54154
as(dp54155
g9
V17034
p54156
stp54157
a((dp54158
g2
(lp54159
VYour code snippet is borked, you're using synth after it is disposed
p54160
aVBut that's not the real problem I'm sure
p54161
aVSetOutputToAudioStream produces the raw PCM audio, the 'numbers'
p54162
aVWithout a container file format (headers) like what's used in a
p54163
aVwav file
p54164
aVYes, that cannot be played back with a regular media program
p54165
aVThe missing overload for SetOutputToWaveStream that takes a SpeechAudioFormatInfo is strange
p54166
aVIt really does look like an oversight to me, even though that's extremely rare in the
p54167
aVNET framework
p54168
aVThere's no compelling reason why it shouldn't work, the underlying SAPI interface does support it
p54169
aVIt can be hacked around with reflection to call the private SetOutputStream method
p54170
aVThis worked fine when I tested it but I can't vouch for it:
p54171
aVIf you're uncomfortable with the hack then using Path
p54172
aVGetTempFileName() to temporarily stream it to a file will certainly work
p54173
as(dp54174
g9
V17034
p54175
stp54176
a((dp54177
g2
(lp54178
VLook at the far right of the box, there's a spy glass icon there
p54179
aVClick it
p54180
aVThat's the Text Visualizer
p54181
aVIt displays the string the way it would appear if you wrote it to, say, the console
p54182
aVWith the escapes applied and \u005cr\u005cn actually breaking the string into the next line
p54183
aVCopy and paste from that
p54184
as(dp54185
g9
V17034
p54186
stp54187
a((dp54188
g2
(lp54189
VThis goes wrong on the very first line of the code
p54190
aVThe System
p54191
aVTimers
p54192
aVTimer class is pretty icky, there's absolutely no guarantee that call Stop() will prevent another call
p54193
aVThe timer uses ThreadPool
p54194
aVQueueUserWorkItem to make the Elapsed event handler call
p54195
aVIf the threadpool is busy this may end up queuing several calls, waiting to get the go-ahead from the TP scheduler to start running
p54196
aVStopping the timer doesn't prevent those waiting threads from running
p54197
aVWithout using a lock, those threads will step on each other badly and mess up your communication state
p54198
aVA safe one is System
p54199
aVThreading
p54200
aVTimer with a period of zero so you'll get only one callback
p54201
aVRecharge the timer with its Change() method
p54202
aVCalling a delegate's BeginInvoke() method and then blocking on it completing doesn't make sense
p54203
aVJust call Invoke()
p54204
aVSaves you from burning up another thread
p54205
aVYes, if the 'Work' method never returns then you have a problem
p54206
aVAn unsolvable one
p54207
aVA lot of this misery could disappear if you avoid using polling to see if there's anything available on the serial port
p54208
aVLet it tell you that there's something worthwhile going on
p54209
aVIt raises the DataReceived event, on a threadpool thread, whenever there's at least one byte in the receive buffer
p54210
aVUsing its WriteTimeout property is also an excellent way to avoid getting stuck when something is amiss with the communication protocol or the device
p54211
aVDedicating one Thread and making blocking Read calls works well too
p54212
as(dp54213
g9
V17034
p54214
stp54215
a((dp54216
g2
(lp54217
VAlways hard to prove the definite absence of an API, but this one is a 95% no-go
p54218
aVLots of system settings are configured through the registry without an API to tweak it afterward
p54219
aVRaymond Chen's typical response to questions like these is "if you want to know then you are doing something wrong"
p54220
aVIt applies here, the default quota of 10,000 handles is enormous
p54221
as(dp54222
g9
V17034
p54223
stp54224
a((dp54225
g2
(lp54226
VWow, that fits the "a little knowledge could be dangerous" mold
p54227
aVNot even the native C++ programmers call the gdiplus entry point directly, they use the C++ wrapper in
p54228
aVThe failure mode here is that your program is loading the wrong version of gdiplus
p54229
aVdll, the one in c:\u005cwindows\u005csystem32
p54230
aVThe legacy version
p54231
aVThe right one is in the Windows side-by-side cache,
p54232
aVNET's System
p54233
aVDrawing assembly contains code to make sure it gets the right version of the DLL from the cache
p54234
aVNot the one you get
p54235
aVYours isn't even initialized, GdiplusStartup was never called
p54236
aVKaboom
p54237
aVNo clue what you're trying to accomplish
p54238
aVThe Graphics class has a TextRenderingHint property, no need for the killer poke
p54239
as(dp54240
g9
V17034
p54241
stp54242
a((dp54243
g2
(lp54244
VIt isn't really clear what "send to native function" might mean
p54245
aVYou shouldn't need much more than Bitmap::GetHbitmap() to get a HBITMAP handle
p54246
aVIf you need a pointer to the raw pixel data then use Bitmap::LockBits()
p54247
as(dp54248
g9
V17034
p54249
stp54250
a((dp54251
g2
(lp54252
VIt does but it has a private copy, c:\u005cwindows\u005csystem32\u005cmsvcr100_clr0400
p54253
aVdll
p54254
aVIt is not suitable for use by a C or C++ program, it needs msvcr100
p54255
aVdll and msvcp100
p54256
aVdll
p54257
aVLocal deployment is now an option, you might want to take advantage of it
p54258
aVThe merge modules you'd need if you want to use an installer are already on your machine
p54259
aVc:\u005cprogram files\u005ccommon files\u005cmerge modules
p54260
aVUsing a Setup project is probably the easiest way
p54261
aVAdd it with Project + Properties, Prerequisites, tick "Visual C++ 2010 Runtime libraries"
p54262
aVThe download links Jon gave you are suitable if you want your customer to prep the machine
p54263
as(dp54264
g9
V17034
p54265
stp54266
a((dp54267
g2
(lp54268
VAnchor the TLP to the bottom
p54269
aVClick the tasks glyph (upper right corner), Edit rows and columns, Show = Rows, select the 2nd row and change the Size Type to Absolute
p54270
aVAlso note that you don't really need a TLP for this
p54271
aVJust use a regular Panel and dock or anchor the controls to the bottom
p54272
as(dp54273
g9
V17034
p54274
stp54275
a((dp54276
g2
(lp54277
VIt is a floating point number, you have to tell it that:
p54278
as(dp54279
g9
V17034
p54280
stp54281
a((dp54282
g2
(lp54283
VWell, do take a hint from the lack of decent samples or tutorials
p54284
aVIf you really want to do this in C++ then check out a copy of Chris Sells' ATL Internals
p54285
aVIt is still in print afaik
p54286
aVIt contains a complete walkthrough for creating an ActiveX control using ATL
p54287
as(dp54288
g9
V17034
p54289
stp54290
a((dp54291
g2
(lp54292
VWell, doing all that casting is unusual, the client code quite often already knows who the sender is because it explicitly subscribed the event for only one object
p54293
aVSharing event handlers is fairly rare
p54294
aVIf common behavior is desirable then the better approach is to derive from the class and override the OnXxxx method
p54295
aVYou then no longer care about sender, you got this
p54296
aVBut, solve your problem trivially by including a type-safe reference to the sender in your custom EventArgs derived class
p54297
as(dp54298
g9
V17034
p54299
stp54300
a((dp54301
g2
(lp54302
VNote how the declaration of the pointer is different from the way you did it in Evaluate
p54303
aVIt is an IDebugger* there
p54304
aVThe DebuggerPtr class is a wrapper class generated by the #import directive
p54305
aVIt is a smart pointer class, it knows how to call Release() automatically
p54306
aVEven if the code throws exceptions, it won't leak the pointer
p54307
aVHighly recommended
p54308
aVYou'll find it documented in the MSDN library as the _com_ptr_t class
p54309
as(dp54310
g9
V17034
p54311
stp54312
a((dp54313
g2
(lp54314
VUse the is operator:
p54315
aVOr just cut it short since you don't know how to handle these exceptions anyway
p54316
aVIf you did then you would have caught them in the DoWork() event handler, there's no point in trying to handle them after the state has evaporated:
p54317
as(dp54318
g9
V17034
p54319
stp54320
a((dp54321
g2
(lp54322
VUse the CWnd::MessageBox() method instead
p54323
as(dp54324
g9
V17034
p54325
stp54326
a((dp54327
g2
(lp54328
VRight-click the project, Properties, Linker, System, change the SubSystem setting
p54329
aVYou'll also have to change your main() method to WinMain()
p54330
aVAnd you'd better create some windows or there won't be much to look at
p54331
as(dp54332
g9
V17034
p54333
stp54334
a((dp54335
g2
(lp54336
VRemoting cannot do this, a hard requirement for an STA thread is that it also pumps a message loop
p54337
aVYou'll indeed have to create your own thread, use Thread
p54338
aVSetApartmentState() to switch it to STA before you start it
p54339
aVAnd use Application
p54340
aVRun() with a dummy form to start the message loop
p54341
aVYou can then use Control
p54342
aVBeginInvoke() to marshal the call from the remoting thread to this new thread
p54343
aVNote that since you already started an STA thread for the server, that thread would do the job just fine
p54344
aVPaste this into your form class to prevent it from getting visible:
p54345
as(dp54346
g9
V17034
p54347
stp54348
a((dp54349
g2
(lp54350
VYou should never use LoadFile(), use LoadFrom() so the CLR has a shot at finding any dependent assemblies
p54351
aVIf you still have trouble then use Fuslogvw
p54352
aVexe to get a trace of the assembly resolution attempt
p54353
aVThe backup plan is to implement AppDomain
p54354
aVAssemblyResolve
p54355
as(dp54356
g9
V17034
p54357
stp54358
a((dp54359
g2
(lp54360
VYes, null is not likely to be correct
p54361
aVThere are a couple of Variants that indicate "no data", like VT_EMPTY, VT_ERROR, VT_NULL
p54362
aVStart by passing Type
p54363
aVMissing
p54364
as(dp54365
g9
V17034
p54366
stp54367
a((dp54368
g2
(lp54369
VYes, you'd have to upgrade to
p54370
aVNET 4
p54371
aV0 to get the new dialog
p54372
aVIf you're stuck on 3
p54373
aV5 then you can use System
p54374
aVWindows
p54375
aVForms
p54376
aVOpenFileDialog, it did get the update to use the new IFileDialog COM interface
p54377
aVThe fallback is automatic but you can use its AutoUpgradeEnabled property to force legacy, if necessary
p54378
aVWhich it is not, unlikely that a
p54379
aVNET program would modify the dialog
p54380
as(dp54381
g9
V17034
p54382
stp54383
a((dp54384
g2
(lp54385
VYeah, doesn't work, VB6 wants its own Collection class
p54386
aVI'm fairly shocked how that turned out
p54387
aVI thought, easy peasy, just add a reference to c:\u005cwindows\u005csystem32\u005cmsvbvm60
p54388
aVdll and use the interop library that generates
p54389
aVThen:
p54390
aVKaboom:
p54391
aVClass not registered
p54392
aVLooked in the registry, it's there under HKLM\u005cCLSID but the InprocServer32 key is blank
p54393
aVBlank
p54394
aVThat's not good
p54395
aVChanged it to point to point to msvbvm60
p54396
aVdll
p54397
aVKaboom, 0x80040111, "ClassFactory cannot supply requested class"
p54398
aVThis isn't going to fly
p54399
aVAbandon all hope the way I see it, unless you can refactor the VB6 code
p54400
as(dp54401
g9
V17034
p54402
stp54403
a((dp54404
g2
(lp54405
VNot sure what your real problem might be but it looks all wrong
p54406
aVThe managed wrapper should be a pretty close facsimile to the unmanaged one
p54407
aVLet's work from an unmanaged declaration like this:
p54408
aVThen your wrapper ought to resemble this:
p54409
aVThe recipe here is that the instance of the unmanaged class is a pointer in the wrapper
p54410
aVAnd just delegate the managed method calls to the unmanaged one
p54411
aVYes, some hokeypokey with strings, as shown
p54412
aVAnd making sure that this native instance gets deleted when either the user or the garbage collector gets around to it
p54413
as(dp54414
g9
V17034
p54415
stp54416
a((dp54417
g2
(lp54418
VRun the Windows Charmap
p54419
aVexe applet
p54420
aVTick the Advanced view checkbox and in the Search for box type "two"
p54421
aVYou should see the "Subscript two" glyph, Unicode codepoint '\u005cu2082'
p54422
aVClick Select and Copy
p54423
aVSwitch to your code or the Properties window and type "H" + Ctrl+V + "O" to get "H\u2082O"
p54424
as(dp54425
g9
V17034
p54426
stp54427
a((dp54428
g2
(lp54429
VThe WindowsBase assembly didn't become available until
p54430
aVNET 3
p54431
ag2512
aVIf you want to run this code without an exception then you'll need to install 3
p54432
aV0 on the machine, 2
p54433
aV0 isn't good enough
p54434
aVCheck the build settings for the add-in project and make sure that it doesn't reference any WPF assemblies
p54435
as(dp54436
g9
V17034
p54437
stp54438
a((dp54439
g2
(lp54440
VA lot of this is automatic if you create a Windows Forms app
p54441
aVThey will (mostly) use the standard native Windows controls which draw themselves with the theme colors
p54442
aVBut there are exceptions:
p54443
aVthe Form item template uses a default Font named Microsoft Sans Serif
p54444
aVYou'll have to change it to Segoe UI to match the Vista/Win7 default
p54445
aVThis is only necessary for the Form class, all controls you put on it will automatically inherit that font
p54446
aVOn an XP machine, the Windows font mapper will notice that the font is missing and automatically fall back to MSS
p54447
aVthe MenuStrip class uses custom rendering to draw the menu items
p54448
aVIt tries to match the Windows style when you change the RenderMode property to System but the way it draws doesn't match the Win7 style
p54449
aVRight-click the toolbox, Choose Items and select MainMenu
p54450
aVThat's a legacy version that does use Windows to draw menus so it produces the proper theme appearance
p54451
aVA very similar problem for ToolStrip
p54452
aVIt's legacy version is ToolBar
p54453
aVThis is a hard one to swallow, it doesn't use a rebar which make the tool bar look flat and ugly
p54454
aVThere are similar problems in WPF but with the added problem that WPF doesn't use any of the standard Windows controls
p54455
aVAnd gets it wrong in subtle places
p54456
as(dp54457
g9
V17034
p54458
stp54459
a((dp54460
g2
(lp54461
VProject + Add Reference,
p54462
aVNET tab, select "System
p54463
aVSpeech"
p54464
aVA project template pre-selects several
p54465
aVNET assemblies
p54466
aVBut only common ones, like System
p54467
aVdll, System
p54468
aVCore
p54469
aVdll, etcetera
p54470
aVYou have to add the 'unusual' ones yourself
p54471
as(dp54472
g9
V17034
p54473
stp54474
a((dp54475
g2
(lp54476
VThe problem is that your equality test is a float point test
p54477
aVThe i variable will be converted to float first and that of course produces the same float
p54478
aVConvert the float back to int to get an integer equality test:
p54479
aVIf it starts with the digits 16 then you found the right one
p54480
aVConvert it to hex and explain why that was the one that failed for a grade bonus
p54481
as(dp54482
g9
V17034
p54483
stp54484
a((dp54485
g2
(lp54486
VYou are calling ReportProgress too often
p54487
aVDo it more than about 1000 times per second and the UI thread gets flooded with requests that it cannot keep up with
p54488
aVIt won't get around to doing its normal duties, which include painting the controls and responding to the mouse and keyboard
p54489
aVIt looks frozen
p54490
aVThis gets worse when the UI update code gets more expensive, updating text in a TextBox when there's already a lot of text in it can get quite slow
p54491
aVThe diagnostic is still seeing the UI frozen for a while after the BGW stops running, working on emptying the backlog in the invoke request queue, then suddenly jumping back alive when the queue is finally emptied
p54492
aVYou need to throttle the rate at which you call BeginInvoke()
p54493
aVIt never makes more sense to call it any more frequently than once every 50 milliseconds, a human cannot perceive the difference beyond that
p54494
aVCollect the info in a List<> so you can BeginInvoke() a lot less frequently
p54495
aVThat's still no complete guarantee if your worker can produce results faster than the UI thread could ever keep up with
p54496
aVIn which case slowing down the worker would be a fix
p54497
aVEasy by using Invoke instead of BeginInvoke
p54498
as(dp54499
g9
V17034
p54500
stp54501
a((dp54502
g2
(lp54503
VYou have to watch out for this
p54504
aVNot a problem with the Now property, it returns DateTime
p54505
aVNow
p54506
aVBut there are subtle differences in other ones, like the Year() method
p54507
aVIt uses the current calendar's GetYear() method which doesn't have to be the same as the DateTime
p54508
aVNow
p54509
aVYear property
p54510
aVDepending where your program is running, that might for example give the number of years since the temple in Jerusalem got destroyed
p54511
aVUse these VB6 compat functions only if you really want to emulate behavior of a legacy VB6 program
p54512
as(dp54513
g9
V17034
p54514
stp54515
a((dp54516
g2
(lp54517
VNot using inheritance as Adrian recommended is a mistake
p54518
aVIt is the right way to do it because you can in one fell swoop change every form in your app by editing the base form properties
p54519
aVBut you want to change the template
p54520
aVThat's easy to do as well
p54521
aVStart a new scratch project with one Form and change the properties you want to have customized
p54522
aVClick File + Export Template
p54523
aVSelect Item template, Next
p54524
aVTick the form, Next
p54525
aVNext
p54526
aVGive it a good name and description and click Finish
p54527
aVYou can now select that template whenever you create a new form
p54528
as(dp54529
g9
V17034
p54530
stp54531
a((dp54532
g2
(lp54533
VYes, the switching between user controls is the problem here
p54534
aVWhen you switch away and switch back, you create a new instance of the control
p54535
aVWhich creates a new instance of the BackgroundWorker
p54536
aVWhich has a RunWorkerCompleted event handler that is not associated with the BGW that is actually running
p54537
aVThere's another bug in your code, this should crash your program with an ObjectDisposedException when the original BGW instance finishes the job and sets the (now invisible) control properties
p54538
aVYou are forgetting to call Dispose() on the user controls when you switch between them
p54539
aVNot quite sure how that's done in WPF but in winforms that is an unpluggable leak
p54540
aVYou are going to have to this differently as long as you want to support switching
p54541
aVThe BGW instance needs to be separate from the user control instance so it can survive the switch
p54542
aVFairly painful, you'll have to wire and unwire the events as the control gets created and disposed, you definitely need to override the Dispose() method and not forget to call it
p54543
aVMaking the BGW static is defensible if you only allow the job it does to run one-at-a-time
p54544
aVWhich should be normal
p54545
aVStacking the user controls so you only ever create them once is a Q&D; fix
p54546
as(dp54547
g9
V17034
p54548
stp54549
a((dp54550
g2
(lp54551
VWell, it's been tinkered with plenty when UAC was implemented in Vista
p54552
aVNevertheless, this is not a common complaint
p54553
aVYes, it is quite possible for Windows to stop calling back the hook callback
p54554
aVA built-in feature to prevent the operating system from getting unresponsive when there is one hooker that doesn't handle the callback in a timely manner
p54555
aVIt gets automatically removed from the callback list without any diagnostic
p54556
aVThis is based on a timeout and can indeed trip when the OS is starting to run low on resources
p54557
aVLike not having enough RAM and running lots of processes, getting massive paging
p54558
aVMore likely with later versions of Windows since they need more RAM and tend to suffer when the machine was upgraded instead of wiped before the install due to disk fragmentation problems (especially the paging file)
p54559
aVThe timeout setting can be tweaked by adding the HKCU\u005cControl Panel\u005cDesktop\u005cLowLevelHooksTimeout value (DWORD, say 10000)
p54560
aVAsk more questions about it at superuser
p54561
aVcom
p54562
as(dp54563
g9
V17034
p54564
stp54565
a((dp54566
g2
(lp54567
VWell, that's pretty odd
p54568
aVThis list is almost certainly filled from the project file, the  element should be significant
p54569
aVBut you eliminated that possibility by recreating the project file from scratch
p54570
aVI can't see how a property on a form would make it disappear from the list
p54571
aVOne thing you could try is editing the My Project\u005cApplication
p54572
aVmyapp file with Notepad
p54573
aVCopy the solution first and make sure it isn't loaded in VS
p54574
aVChange the  element to one of the forms that isn't listed
p54575
aVLoad the project and see what is shown in the project property page and if anything breaks when you compile it
p54576
as(dp54577
g9
V17034
p54578
stp54579
a((dp54580
g2
(lp54581
VWell, that's quite yucky
p54582
aVModifying the PATH is about as evil a thing an installer could ever do
p54583
aVIt has gotten a particularly bad rap because so many uninstallers destroy it, causing very hard to diagnose problems
p54584
aVI think you'll need to write a custom action that modifies the registry
p54585
aVThe system environment is stored in HKEY_LOCAL_MACHINE\u005cSYSTEM\u005cCurrentControlSet\u005cControl\u005cSession Manager\u005cEnvironment, Path value
p54586
aVYou should force a reboot to make sure the new setting is effective
p54587
aVAnd test the uninstall
p54588
aVSeeing your comment to SLaks, use HKEY_LOCAL_MACHINE\u005cSOFTWARE\u005cMicrosoft\u005cWindows\u005cCurrentVersion\u005cApp Paths instead
p54589
as(dp54590
g9
V17034
p54591
stp54592
a((dp54593
g2
(lp54594
VThey do this by setting the window style bits so it is created without a title bar
p54595
aVAnd then draw their own, making it look like a custom one
p54596
aVWhich is the main reason that all these programs have caption glyphs that are not identical
p54597
aVYou'd accomplish the same in WPF by setting the WindowStyle to None
p54598
aVAnd a whole bunch of code to get back the behavior that Windows implements automatically with the title bar
p54599
aVGoogle "WM_NCHITTEST" to find out more
p54600
as(dp54601
g9
V17034
p54602
stp54603
a((dp54604
g2
(lp54605
VYou're close but you have to use PtrToStringAnsi()
p54606
aVAuto uses the system default which will be Unicode
p54607
as(dp54608
g9
V17034
p54609
stp54610
a((dp54611
g2
(lp54612
VYou cannot easily get the exact Win98 look without a pretty drastic rewrite of the control
p54613
aVBut a simple flat light-blue progress bar can be had by turning off visual styles
p54614
aVLike this:
p54615
as(dp54616
g9
V17034
p54617
stp54618
a((dp54619
g2
(lp54620
VIt is an utter mystery how you got 21 out of the ASCII data
p54621
aVThe shaded byte is in hex, its real value is 33
p54622
aVThere's no way you can get 21 out of BitConverter
p54623
aVToInt32, that requires bytes values (in hex) 15 00 00 00
p54624
aVThis must have worked by accident but no idea what that accident might look like
p54625
aVPost more code, including the code that writes this
p54626
as(dp54627
g9
V17034
p54628
stp54629
a((dp54630
g2
(lp54631
VI see a range of timestamps on the
p54632
aVNET 4
p54633
aV0 files that span about 20 hours
p54634
aVThe build ended early in the morning on March 19th, 2010 (UTC)
p54635
aVSo the 0319 part of the version is a very good match
p54636
aVThe simple explanation is that year 0 for
p54637
aVNET 4
p54638
aV0 was 2007
p54639
aVSounds about right for them starting to work on it
p54640
as(dp54641
g9
V17034
p54642
stp54643
a((dp54644
g2
(lp54645
VElegant isn't typically the word that jumps to mind when you have to hack the way the native Windows control works, but that's what required here
p54646
aVDo consider if you really want your control to behave differently from the listviews in any other program
p54647
aVAdd a new class to your project and paste the code shown below
p54648
aVCompile
p54649
aVDrop the new control from the top of the toolbox onto your form
p54650
as(dp54651
g9
V17034
p54652
stp54653
a((dp54654
g2
(lp54655
VStart looking with a tool that can show you the Windows messages that the control generates and receives
p54656
aVLike Microsoft's Spy++
p54657
aVCompare it with a working list view to have an idea what might be amiss
p54658
aVAlso check the parent window
p54659
aVI haven't otherwise heard of listviews that dingaling, the LVN_ACTIVATEITEM should fire the first WM_LBUTTONDOWN, no double-click necessary
p54660
as(dp54661
g9
V17034
p54662
stp54663
a((dp54664
g2
(lp54665
VBy far the simplest way is to just set the ListView
p54666
aVContextMenuStrip property to your CMS, everything is automatic then
p54667
aVYou can do so in the designer
p54668
aVIf you need a custom handler for some reason, to check if the right item was clicked for example, then you can call the Show() method property with code like this:
p54669
as(dp54670
g9
V17034
p54671
stp54672
a((dp54673
g2
(lp54674
VNo idea, it is unnecessary
p54675
aVA constructor always calls the base class constructor automatically without you having to write it explicitly
p54676
aVBut that's what it means
p54677
aVYou'd have to write it if you don't want to call the parameterless constructor but one that takes an argument
p54678
as(dp54679
g9
V17034
p54680
stp54681
a((dp54682
g2
(lp54683
VYou can see for yourself when you change the MSBuild output to Diagnostic
p54684
aVTools + Options, Projects and Solutions, Build and Run
p54685
aVThe string you'd pass to the FrameworkName constructor appears as the  build property
p54686
aVThe ones I can easily see myself are the regular desktop version:
p54687
aVNETFramework,Version=v4
p54688
aV0,Profile=Client
p54689
aVAnd the Silverlight version:
p54690
aVSilverlight,Version=v4
p54691
ag2512
aVContributed by the OP, the Windows Phone 7 version:
p54692
aVSilverlight,Version=v4
p54693
aV0,Profile=WindowsPhone
p54694
aVI can't get any Micro Framework projects built, instant crash to the desktop
p54695
aVCompact Framework support was removed from VS2010
p54696
aVThat's about it for versions that I know of
p54697
as(dp54698
g9
V17034
p54699
stp54700
a((dp54701
g2
(lp54702
VIt is unclear to me why you are doing this the hard way
p54703
aVJust add the icon to your resources
p54704
aVProject + Properties, Resource tab, arrow on Add Resource button, Add Existing File
p54705
aVThen you'd use it like this at runtime:
p54706
aVWhere Mumble is the name of the icon
p54707
aVIf you are 100% sure that GetObject() doesn't return null then try setting the Icon property in the designer
p54708
aVIf it still doesn't show up then there's something wrong with the icon format
p54709
aVMake sure that it doesn't have too many colors, 256 works on XP
p54710
as(dp54711
g9
V17034
p54712
stp54713
a((dp54714
g2
(lp54715
VAssuming MSVC since this is a Windows question
p54716
aVYou can get a breakpoint exception by using the __debugbreak() intrinsic
p54717
aVTest without attaching a debugger
p54718
aVA floating point stack check fault requires unmasking the under/overflow exceptions in the FPU control word
p54719
aVAnd, say, popping the stack too often
p54720
aVI rolled them both in one sample program:
p54721
aV`
p54722
as(dp54723
g9
V17034
p54724
stp54725
a((dp54726
g2
(lp54727
VWhile I never intentionally link libraries that were built with different compiler settings, there isn't much point in doing so, I only know of the STL classes in the Dinkumware implementation (the one MSFT uses) to cause this problem
p54728
aVThey support a feature called 'iterator debugging' which is turned on by default in the Debug configuration
p54729
aVThis adds members to the classes to aid the diagnostic code
p54730
aVMaking them larger
p54731
aVThis goes bad when you create the object in a chunk of code that was compiled with one setting and pass it to code that was compiled with the opposite setting
p54732
aVYou can turn this off by setting the _HAS_ITERATOR_DEBUGGING macro to 0
p54733
aVWhich is rather a major loss, the feature is excellent to diagnose mistakes in the way you use STL classes
p54734
aVPassing objects or pointers between different libraries is always a problem if you don't carefully control the compile settings
p54735
aVMixing and matching the CRT version and flavor gets you in trouble when you do so
p54736
aVThis normally generates a warning from the linker, not sure what you did to not see it
p54737
aVThere won't be one if the code lives in a DLL
p54738
as(dp54739
g9
V17034
p54740
stp54741
a((dp54742
g2
(lp54743
VThis is best done by declaring an interface:
p54744
aVAnd let your MDI child form implement it:
p54745
aVIn your parent, implement the Click event for the toolbar button like this:
p54746
aVIt is also a good idea to disable the button if a child is active that doesn't implement the command
p54747
aVWhich you can do by writing an event handler for the Application
p54748
aVIdle event:
p54749
as(dp54750
g9
V17034
p54751
stp54752
a((dp54753
g2
(lp54754
VAfter you obtain the window handle you can use Control
p54755
aVFromHandle() to get a reference to the control
p54756
aVThen check the relative mouse position to see if its it is the client area of the form or control
p54757
aVLike this:
p54758
as(dp54759
g9
V17034
p54760
stp54761
a((dp54762
g2
(lp54763
VThese are opposing goals
p54764
aVThe point of using the declarative approach is to not use Regasm
p54765
aVexe or Regsvr32
p54766
aVexe to call the registration function
p54767
aVIn other words, your [ComRegisterFunction] attributed method won't be called
p54768
aVYou can't have both
p54769
aVThe exception that heat
p54770
aVexe dies on isn't healthy, it indicates that there's something wrong with your registration function or class contructor
p54771
aVDebug this by making your DLL the startup project
p54772
aVProject + Properties, Debug tab and make heat
p54773
aVexe the startup program
p54774
aVSet the command line to your DLL
p54775
aVDebug + Exceptions and tick the Thrown box for CLR exceptions, the debugger will stop when the exception is thrown
p54776
aVOh, and don't forget to call RegistrationServices
p54777
aVRegisterAssembly in your register function
p54778
aVRegasm
p54779
aVexe won't do it automatically anymore since you used the attribute
p54780
as(dp54781
g9
V17034
p54782
stp54783
a((dp54784
g2
(lp54785
VThis happens because the StreamReader takes over 'ownership' of the stream
p54786
aVIn other words, it makes itself responsible for closing the source stream
p54787
aVAs soon as your program calls Dispose or Close (leaving the using statement scope in your case) then it will dispose the source stream as well
p54788
aVCalling fs
p54789
aVDispose() in your case
p54790
aVSo the file stream is dead after leaving the first using block
p54791
aVThere is one constructor for StreamReader that allows saying that it doesn't own the source stream
p54792
aVIt is however not accessible from a
p54793
aVNET program, the constructor is internal
p54794
aVIn this particular case, you'd solve the problem by not using the using statements for the StreamReader
p54795
aVThat's however a fairly hairy implementation detail
p54796
aVThere's surely a better solution available to you but the code is too synthetic to propose a real one
p54797
as(dp54798
g9
V17034
p54799
stp54800
a((dp54801
g2
(lp54802
VThis strongly resembles a very similar problem in VisualStudio2008 SP1
p54803
aVIt was fixed with a post-SP hotfix
p54804
aVBut there's other evidence that the hotfix didn't get incorporated into the code base, this feedback item was also a problem
p54805
aVIt isn't that unusual for hotfixes to not get integrated back
p54806
aVThere isn't a feedback item that exactly describes your problem, at least that I can find
p54807
aVI'd recommend you file one
p54808
aVGiven the usual trouble with reproduce bugs like this, I'd strongly recommend you include a reproduction project that exhibits this problem with instructions on how to reproduce the issue
p54809
aVThere is a workaround of sorts for your issue, you could go into Debug + Windows + Threads, right-click the threads you don't want to debug and select Freeze
p54810
aVDon't forget to Thaw them later
p54811
aVThese bugs were fixed again in Visual Studio 2010 Service Pack 1
p54812
as(dp54813
g9
V17034
p54814
stp54815
a((dp54816
g2
(lp54817
VUse FirstOrDefault()
p54818
as(dp54819
g9
V17034
p54820
stp54821
a((dp54822
g2
(lp54823
VThis can be reverse-engineered somewhat from the SSCLI20 source, albeit that it is dated
p54824
aVThe core CLR function that implements MsgWaitForMultipleHandles is DoAppropriateWait
p54825
aVFrom what I see, it is used by AutoResetEvent, ManualResetEvent and Semaphore but not by Mutex
p54826
aVOne quirk is that WaitHandle
p54827
aVWaitAny is okay from an STA thread but WaitAll() generates an exception
p54828
aVYeah, this isn't documented anywhere other then a few hints in Chris Brumme's blog
p54829
aVYou can't assume too much from what I found, test this to be sure
p54830
as(dp54831
g9
V17034
p54832
stp54833
a((dp54834
g2
(lp54835
VThe C# IDE has the "Specific Version" property for a reference but the C++/CLI build system doesn't support that
p54836
aVThere is a workaround, you can use the #using directive in source code to load an assembly reference
p54837
aVThis by design cannot check the assembly version of the reference assembly
p54838
aVNormally that's a problem but not in your case
p54839
aVThe MSDN page is here
p54840
as(dp54841
g9
V17034
p54842
stp54843
a((dp54844
g2
(lp54845
VYou can do this by taking care of the marshaling yourself instead of leaving it to the P/Invoke marshaller
p54846
aVRedeclare foo like this:
p54847
aVWhich now allows you to define a generic method:
p54848
aVIf perf is critical then you can speed it up by keeping the memory allocated by AllocCoTaskMem around, growing it only if needed
p54849
aVIt isn't clear from your question whether the C functions updates the passed structure, you can omit the PtrToStructure call if it doesn't
p54850
as(dp54851
g9
V17034
p54852
stp54853
a((dp54854
g2
(lp54855
VYou can do this by deriving your own control from Label and overriding the GetPreferredSize() method
p54856
aVAdd a new class to your project and paste the code shown below
p54857
aVCompile
p54858
aVDrop the new control from the top of the toolbox onto your form
p54859
as(dp54860
g9
V17034
p54861
stp54862
a((dp54863
g2
(lp54864
VAn AppDomain is nice since you can ditch the program state but you still have the problem that the thread is dead
p54865
aVThat this happens on the finalizer thread is fatal, the CLR will abort the process without recourse
p54866
aVThe only 'fix' is to run this component in its own process
p54867
aVYou can shoot it in the head with Process
p54868
aVKill() to prevent the finalizer thread from running at process exit
p54869
aVUse one of the interprocess communication mechanisms that
p54870
aVNET supports to talk to it
p54871
aVA socket, named pipe, Remoting or WCF
p54872
aVGood luck with it
p54873
as(dp54874
g9
V17034
p54875
stp54876
a((dp54877
g2
(lp54878
VNo, that's a problem with modern compilers, like VB
p54879
aVNET's
p54880
aVThere is no one-to-one mapping between bytes and strings anymore when Unicode became the preferred way of handling text
p54881
aVCodepoints like 0x80 don't have a corresponding character, it is going to get munched when you convert the string to bytes
p54882
aVYou'll need to work with a Byte() array in your code
p54883
aVThe exact equivalent for your example is:
p54884
as(dp54885
g9
V17034
p54886
stp54887
a((dp54888
g2
(lp54889
VIf you are sure that the registry key actually exists (use Regedit
p54890
aVexe) then you've got a problem if you are running on the 64-bit version of Windows
p54891
aVA VS2010 project is forced to run in 32-bit mode by default, it sees another set of registry keys
p54892
aVProject + Properties, Build tab, Platform Target = Any CPU
p54893
aVRepeat for the Release configuration
p54894
as(dp54895
g9
V17034
p54896
stp54897
a((dp54898
g2
(lp54899
VThat's because of the BOM in the file
p54900
aVThe TYPE command is too primitive to detect it and will just copy the 3 bytes to the output
p54901
aVYou can change the encoding used for the
p54902
aVsql file
p54903
aVTedious too btw
p54904
aVFile + Save As, click the arrow on the Save button, Save With Encoding and select your current code page
p54905
aVLike 1252 for Western Europe and Americas, it is probably the first one in the list
p54906
aVThis is the same thing you did with Notepad
p54907
aVBeware of the trouble you can get into if the server runs with a different code page and your scripts contain accented characters
p54908
aVI would myself just write a little utility that uses Directory
p54909
aVGetFiles and StreamReader/Writer to fix the problem
p54910
as(dp54911
g9
V17034
p54912
stp54913
a((dp54914
g2
(lp54915
VUse Console
p54916
aVKeyAvailable inside the loop
p54917
aVAs soon as it returns true, the user started typing so call ReadLine()
p54918
aVIt doesn't make for a very attractive user interface though
p54919
aVConsider Windows Forms
p54920
as(dp54921
g9
V17034
p54922
stp54923
a((dp54924
g2
(lp54925
VSet base
p54926
aVBorderStyle to None to the default border isn't drawn
p54927
aVYou'll need to override the BorderStyle property to make this work
p54928
as(dp54929
g9
V17034
p54930
stp54931
a((dp54932
g2
(lp54933
VOnly one window can ever be activated
p54934
aVYou are otherwise asking about 'owned' windows
p54935
aVUse the Show(owner) overload
p54936
aVIt ensures that when the user activates the main (owner) window, all other forms move to the foreground as well
p54937
aVAnd get minimized when the main window is minimized
p54938
as(dp54939
g9
V17034
p54940
stp54941
a((dp54942
g2
(lp54943
VWhen things that obviously should work don't work then assume there's something you cannot see
p54944
aVLike this:
p54945
as(dp54946
g9
V17034
p54947
stp54948
a((dp54949
g2
(lp54950
VWell, yes, it is a slight optimization
p54951
aVThis code snippet:
p54952
aVgenerates this machine code in the release build:
p54953
aVDo note that the JIT compiler is smart enough to use the AND processor instruction
p54954
aVIt is not doing a division as the % operator would normally perform
p54955
aVKudos there
p54956
aVBut your custom test generates this code:
p54957
aVI had to alter the assignment statement because the JIT compiler got suddenly smart and evaluated the expression at compile time
p54958
aVThe code is very similar but the AND instruction got replaced by a TEST instruction
p54959
aVSaving one instruction in the process
p54960
aVFairly ironic how it this time chose to not use an AND :)
p54961
aVThese are the traps of making assumptions
p54962
aVYour original instinct was right however, it ought to save about half a nanosecond
p54963
aVVery hard to see that back unless this code lives in a very tight loop
p54964
aVIt gets drastically different when you change the variable from uint to int, the JIT compiler then generates code that tries to be smart about the sign bit
p54965
aVUnnecessarily
p54966
as(dp54967
g9
V17034
p54968
stp54969
a((dp54970
g2
(lp54971
VHmya, don't look for a complicated solution when the obvious one is simple
p54972
aVJust copy your solution and project files and give them a distinctive name
p54973
aVPostfix "10", anything goes
p54974
aVAnd open them in VS2010 to get them converted
p54975
aVRun a diff on the source code files, just in case, there shouldn't be any
p54976
aVCheck them in
p54977
aVYou can now open the original in VS2008 and the converted in VS2010
p54978
as(dp54979
g9
V17034
p54980
stp54981
a((dp54982
g2
(lp54983
VIt's smelly
p54984
aVCatching an exception requires that you restore the program state, as though doSomethingElse() was never called
p54985
aVIt very much depends on what the method does but it is generally pretty unusual to write a method without any side effects whatsoever
p54986
aVIf it has any then those side effects need to be canceled
p54987
aVOnly doSomethingElse() can do so, the doSomething() method is powerless to guess how many of those side effects were actually executed
p54988
aVAnd can thus not reliably restore state
p54989
aVThis is especially the case when you catch all exceptions
p54990
aVYou'll grab the nasty ones as well
p54991
aVLike AccessViolation or FatalExecutionEngineError, exceptions that leave the CLR itself in a unknown state, you can never restore that
p54992
aVWhat happens next is quite unpredictable
p54993
aVYou'll get a flurry of additional exceptions only if you're lucky
p54994
aVDiagnosing them is impossible, you threw away valuable info
p54995
as(dp54996
g9
V17034
p54997
stp54998
a((dp54999
g2
(lp55000
VYou are expecting a bit too much out of the smarts of this tool
p55001
aVThat the property is an alias for the field is only obvious to human eyes
p55002
aVIt requires pretty sophisticated analysis to let a tool see that
p55003
aVFxCop just doesn't have that kind of horse power
p55004
aVYour code is in fact questionable
p55005
aVIf the property was never used by the client code then you'll create the WebClient object and immediately dispose it
p55006
aVUse the field instead, test for null and Dispose()
p55007
aVThe problem with the second field is probably induced by the need for the tool to avoid unnecessary warnings
p55008
aVIt will only complain if it can determine with absolute certainty that the field is ever initialized
p55009
aVSame kind of lack of smarts here, it can't tell that the factory always returns a non-null reference
p55010
aVOnly when it sees the constructor being used in the class itself can it be sure that the field needs to be disposed
p55011
aVIt's a good tool, not perfect
p55012
as(dp55013
g9
V17034
p55014
stp55015
a((dp55016
g2
(lp55017
VThe test is wrong, check for -1
p55018
aVAnd it is missing the parentheses, throw new Exception()
p55019
aVThis is however very inappropriate code in many different ways
p55020
aVThat starts by throwing Exception instead of a specific exception derived class object
p55021
aVYour catch clause will catch every exception, including ones thrown by other mishaps like a bug in your code
p55022
aVYou tell the user to enter something when she actually did
p55023
aVFurthermore, exceptions should only be used for exceptional circumstances
p55024
aVThere is nothing exceptional about the user forgetting to do something
p55025
aVJust display the message in the if() statement, do the rest in the else clause
p55026
aVFurthermore, you should not even allow the user to fall into this trap
p55027
aVOnly set the Delete button's Enabled property to true when you see that she's selected something
p55028
as(dp55029
g9
V17034
p55030
stp55031
a((dp55032
g2
(lp55033
VYour C# declaration is not equivalent, it generates the SomeData field inline
p55034
aVIn other words, the equivalent native declaration would be:
p55035
aVThe P/Invoke marshaller cannot deal with a member that's a pointer
p55036
aVIt is a memory management problem, it is very murky who owns the pointer and is responsible for deleting it
p55037
aVTo make this work at all, you have to declare the structure like this:
p55038
aVAnd marshal it yourself
p55039
aVLike this:
p55040
aVImplicit in this code is that the pointer is owned by the managed code and that it releases the memory (FreeCoTaskMem call)
p55041
aVIf the native code copies the passed structure then this will be a problem, it is going to read bad data or bomb when it tries to dereference the pointer
p55042
aVNot freeing the memory isn't an option either, that produces an unpluggable memory leak
p55043
aVBecause the native code cannot use the free() function to release it
p55044
aVIf you end up in that mine field then you will have to write a wrapper in the C++/CLI language so that you can use the CRT's malloc() function
p55045
as(dp55046
g9
V17034
p55047
stp55048
a((dp55049
g2
(lp55050
VYour dispose code is not appropriate
p55051
aVIterating the Images collection actually creates a new bitmap for each image
p55052
aVWhich you then immediately dispose again
p55053
aVJust call Clear()
p55054
aVGC
p55055
aVCollect() cannot have any effect either, the ImageList class is a wrapper around the native Windows component
p55056
aVWhich stores the images in native memory, not garbage collected memory
p55057
aVLast but not least your real issue: the Windows memory manager just doesn't work the way you think
p55058
aVIt does not shrink the virtual memory size of the program when it frees memory
p55059
aVIt simply marks the block of memory as unused and adds it to the list of free blocks
p55060
aVReady to be re-used at a later time
p55061
aVOnly in the very rare case where the freed memory happens to span the entire set of reserved memory pages can it shrink the virtual memory size
p55062
aVThis is not a real problem
p55063
aVIt's virtual
p55064
as(dp55065
g9
V17034
p55066
stp55067
a((dp55068
g2
(lp55069
VYou need to declare setTime() virtual so you can override it
p55070
aVDon't forget to call the base method
p55071
as(dp55072
g9
V17034
p55073
stp55074
a((dp55075
g2
(lp55076
VWell, a multiline TextBox or RichTextBox will do the job just fine
p55077
aVUse its AppendText() method
p55078
aVI cannot judge the value of this info from your question
p55079
aVIn general, avoid assuming the user is interested in implementation details, especially when there's a lot of it
p55080
aVA ProgressBar is almost always the most appropriate progress indicator
p55081
aVMaybe a Label or a StatusStrip to give some context
p55082
aVBeware of the cost of Control
p55083
aVBeginInvoke() to update the controls
p55084
as(dp55085
g9
V17034
p55086
stp55087
a((dp55088
g2
(lp55089
VBecause the literal 0
p55090
aV7 is of type double, not float
p55091
aVThe actual value of a is 0
p55092
aV699999
p55093
aVFix:
p55094
as(dp55095
g9
V17034
p55096
stp55097
a((dp55098
g2
(lp55099
VThere's a heck of a lot of plumbing that needs to be initialized for an appdomain
p55100
aVEspecially since they do not share the same heaps or the same set of assemblies
p55101
aVA detail that's wrong in your question
p55102
aVTheir value is in that still costing a lot less than creating a new process
p55103
aVAfter seeing edit: 10 seconds is rather a lot and not easily explained away beyond the appdomain doing a cold start on the assemblies that need to be loaded
p55104
aVDisk or network overhead
p55105
as(dp55106
g9
V17034
p55107
stp55108
a((dp55109
g2
(lp55110
Vnew byte[]{5,6,6}
p55111
aVThe problem here is that the initializer {5, 6, 6} creates a static field
p55112
aVYou can see it with Ildasm
p55113
aVexe
p55114
aVThe CLR imposes a maximum of, I believe, 65535 fields in a class
p55115
aVYour auto-generated code is exceeding it
p55116
aVYou are going to have to do this differently
p55117
aVA file jumps to mind
p55118
as(dp55119
g9
V17034
p55120
stp55121
a((dp55122
g2
(lp55123
VI really don't understand why you'd make implementation details like background workers visible on the user interface
p55124
aVWell, some code
p55125
aVIt doesn't make sense to use a Queue, threads do not end in any predictable order
p55126
aVLet's do a list:
p55127
aVYou want to take advantage of the RunWorkerCompleted event raised by BGW to know when the job is done
p55128
aVSo use AddHandler:
p55129
aVAnd the event handler can look like this:
p55130
as(dp55131
g9
V17034
p55132
stp55133
a((dp55134
g2
(lp55135
VAs long as you registered the marshaller for the interface, yeah, no problem
p55136
aVThe std marshaller can do it
p55137
as(dp55138
g9
V17034
p55139
stp55140
a((dp55141
g2
(lp55142
VNot sure why you thought that was a good idea, used to program in VB
p55143
aVDrop the -1, you want to read all the bytes, not all the bytes minus the last one
p55144
aVFile
p55145
aVReadAllBytes() would be a good choice
p55146
as(dp55147
g9
V17034
p55148
stp55149
a((dp55150
g2
(lp55151
VThe parsers were never implemented
p55152
aVIn any of the language providers
p55153
aVAnd never will, the method has been removed in
p55154
aVNET 4
p55155
ag2512
aVThere are alternatives, good looking ones in the top hits when you type "vb parser" in the google search box
p55156
as(dp55157
g9
V17034
p55158
stp55159
a((dp55160
g2
(lp55161
VIt's a bit hum to have a user control open a form, consider raising an event so that the control's parent form stays in control and displays the dialog
p55162
aVBut okay if the dialog is a complete implementation detail of the control
p55163
aVDon't set the Parent, you need to use the ShowDialog(owner) overload if you want to pick a specific owner
p55164
aVIt isn't typically necessary, the ShowDialog() method goes hunting for a suitable owner if you don't specify one
p55165
aVYou can find the parent form of the control back with code like this:
p55166
aVBut you've got another problem, also the reason why you asked this question in the first place
p55167
aVYour dialog right now doesn't have an owner and it is likely to disappear behind another window
p55168
aVThat's because your code runs on another thread
p55169
aVA thread that created no windows, and thus can't supply an owner window, and the reason for the cross-thread exception message
p55170
aVYou need to use Control
p55171
aVInvoke to run the dialog code on the UI thread
p55172
aVThere's a good example of it in the MSDN Library topic for it
p55173
as(dp55174
g9
V17034
p55175
stp55176
a((dp55177
g2
(lp55178
VYes:
p55179
aVcpp: source code
p55180
aVfilters: project file
p55181
aVh: source code
p55182
aVico: resource
p55183
aVrc: resource script
p55184
aVrc2: resource script
p55185
aVsln: project file
p55186
aVtxt: project element
p55187
aVvcxproj: project file
p55188
aVNo:
p55189
aVaps: last resource editor state
p55190
aVexe: build result
p55191
aVidb: build state
p55192
aVipch: build helper
p55193
aVlastbuildstate: build helper
p55194
aVlib: build result
p55195
aVCan be 3rd party
p55196
aVlog: build log
p55197
aVmanifest: build helper
p55198
aVCan be written yourself
p55199
aVobj: build helper
p55200
aVpch: build helper
p55201
aVpdb: build result
p55202
aVres: build helper
p55203
aVsdf: intellisense dbase
p55204
aVsuo: solution user options
p55205
aVtlog: build log
p55206
aVuser: debug settings
p55207
aVDo preserve if just one dev or custom debug settings
p55208
aVSeveral of these are iffy because they can both be auto-generated and maintained yourself
p55209
aVAnd there are several more that don't appear in your list
p55210
aVPrimarily pay attention to the location of the file
p55211
aVIf it is in your solution or project directory then it's highly likely you want to check it in
p55212
aVIn the Debug or Release subdirectories then highly unlikely
p55213
aVBuild + Clean removes a lot of the noise files
p55214
aVAnd of course: check-in, rename the project directory, check-out and verify that it builds
p55215
as(dp55216
g9
V17034
p55217
stp55218
a((dp55219
g2
(lp55220
VI completely agree with your diagnosis, nice sleuthing
p55221
aVThe explicit interface implementation is updating a field named m_positionChanged
p55222
aVThe PositionChanged event is updating a delegate field named PositionChanged
p55223
aVInspiring to see the big boys fumble this
p55224
aVNo simple workaround for this beyond hacking reflection to access the private fields directly
p55225
aVYou can report the bug at connect
p55226
aVmicrosoft
p55227
aVcom
p55228
aVJust a link to this thread should give them everything they need
p55229
as(dp55230
g9
V17034
p55231
stp55232
a((dp55233
g2
(lp55234
VYou are focusing on the wrong problem
p55235
aVThe ThreadAbortException is just as likely to abort the OpenText() method
p55236
aVYou might hope that it is resilient to that but it isn't
p55237
aVThe framework methods do not have try/catch clauses that try to deal with a thread abort
p55238
aVDo note that the file doesn't remain opened forever
p55239
aVThe FileStream finalizer will, eventually, close the file handle
p55240
aVThis of course can still cause exceptions in your program when you keep running and try to open the file again before the finalizer runs
p55241
aVAlbeit that this is something you always have to be defensive about when you run on a multi-tasking operating system
p55242
as(dp55243
g9
V17034
p55244
stp55245
a((dp55246
g2
(lp55247
VThere's one reason I can think of: the worker thread got aborted
p55248
aVThis will run the finally block generated by the using statement and close the file
p55249
aVHow it could be aborted is a secondary question
p55250
aVIs the thread's IsBackground property set to true
p55251
aVIs the program bombing on an unhandled exception elsewhere and shutting down
p55252
aVJust guesses of course
p55253
as(dp55254
g9
V17034
p55255
stp55256
a((dp55257
g2
(lp55258
VThere's a bit of interesting history behind the seemingly duplicate methods in the File class
p55259
aVIt came about after a usability study on a pre-release version of
p55260
aVNET
p55261
aVThey asked a group of experienced programmers to write code to manipulate files
p55262
aVThey were never exposed to
p55263
aVNET before and just had the docs to work from
p55264
aVThe success rate was 0%
p55265
aVYes, there's a difference
p55266
aVYou'll find out when you try to read a file that's a gigabyte or more
p55267
aVThat's a guaranteed crash on the 32-bit version
p55268
aVNo such problem with a StreamReader that reads line-by-line, it will use very little memory
p55269
aVIt depends on what the rest of your program does but try to limit the convenience method to files no larger than, say, a couple of megabytes
p55270
as(dp55271
g9
V17034
p55272
stp55273
a((dp55274
g2
(lp55275
VThe CLR is completely out of the loop on this, it is the job of the JIT compiler to generate the appropriate machine code to get an argument passed by reference
p55276
aVWhich is an implementation detail in itself, there are different jitters for different machine architectures
p55277
aVBut the common ones do it exactly the way a C programmer does it, they pass a pointer to the variable
p55278
aVThat pointer is passed in a CPU register or on the stack frame, depending on how many arguments the method takes
p55279
aVWhere the variable lives doesn't matter, a pointer to a variable in the stack frame of the caller is just as valid as a pointer to member of a reference type object that's stored on the heap
p55280
aVThe garbage collector knows the difference between them, by virtue of the pointer value, adjusting the pointer if necessary when it moves an object
p55281
aVYour code snippet invokes magic inside the
p55282
aVNET framework that's required to make marshaling calls from one thread to another work
p55283
aVThis is the same kind of plumbing that makes Remoting works
p55284
aVTo make such a call, a new stack frame has to be created on the thread where the call is performed
p55285
aVThe remoting code uses the type definition of the delegate to know what that stack frame should look like
p55286
aVAnd it can deal with arguments passed by reference, it knows that it needs to allocate a slot in the stack frame to store the pointed-to variable, i in your case
p55287
aVThe BeginInvoke call initializes the copy of the i variable in the remoted stack frame
p55288
aVThe same thing happens on the EndInvoke() call, the results are copied back from the stack frame in the threadpool thread
p55289
aVKey point is that there isn't actually a pointer to the i variable, there's a pointer to the copy of it
p55290
aVNot so sure this answer is very clear, having some understanding of how CPUs work and a bit of C knowledge so the concept of a pointer is crystal can help a lot
p55291
as(dp55292
g9
V17034
p55293
stp55294
a((dp55295
g2
(lp55296
VThat's not how syntax highlighting works in VS2008
p55297
aVIt is done by 'lexical analysis', not a language parser
p55298
aVIn other words, it tokenizes the text in the source code file and classifies them by lexical type
p55299
aVKeyword, identifier, number, string literal, comment, whitespace
p55300
aVAnd gives them their associated color
p55301
aVIt is important that it works that way because lexical analysis is fast, parsing is slow
p55302
aVGetting text to repaint in a text editor needs to be fast
p55303
aVAccordingly, it has no option to classify individual keywords, the only option you got is the "Keyword" color in the dialog
p55304
aVWhich changes the color of all keywords, not just
p55305
as(dp55306
g9
V17034
p55307
stp55308
a((dp55309
g2
(lp55310
VNo, it can't cause stack corruption
p55311
aVIDispatch::Invoke() is used to call the method, the arguments are packaged in an array
p55312
aVThe stock implementation of IDispatch certainly would detect the argument mismatch, it uses the type library info to check
p55313
aVBut it is conceivable that the COM server author implemented it himself
p55314
aVImperfectly
p55315
aVIt is something a C++ hacker might do, the stock implementation is dreadfully slow
p55316
aVThe GC heap getting corrupted is the kind of thing that happens when imperfect code executes
p55317
as(dp55318
g9
V17034
p55319
stp55320
a((dp55321
g2
(lp55322
VThe declaration is wrong, it takes a (ByRef oldValue As IntPtr) argument
p55323
aVWhich you need to pass to the revert function
p55324
aVHowever, you cannot safely use this in a
p55325
aVNET program
p55326
aVIt also affects the CLR, it won't be able to find
p55327
aVNET framework assemblies anymore
p55328
aVYou cannot predict when they get loaded
p55329
aVThere are surely better ways to accomplish what you need, start a new question about that
p55330
as(dp55331
g9
V17034
p55332
stp55333
a((dp55334
g2
(lp55335
VLook at the declaration of strpcy()
p55336
aVYou need to pass a pointer
p55337
aVSo you don't dereference pointer and line
p55338
aVBecause that would pass a char
p55339
as(dp55340
g9
V17034
p55341
stp55342
a((dp55343
g2
(lp55344
VAh, Einar, good man
p55345
aVDoing flash and Sharepoint stuff these days, ouch
p55346
aVNorwegian, might explain the trigraphs
p55347
aVAnyhoo, nothing complicated, you just forgot to tell the linker to look at some libraries
p55348
aVRight-click your project, Project Dependencies, tick the Thunk project
p55349
aVThat makes sure that Thunk32
p55350
aVlib gets looked at and resolves the ctor and dtor
p55351
aVRight-click again, Properties, Linker, Additional dependencies, add "winmm
p55352
aVlib"
p55353
aVThat resolves the capCreateCaptureWindow symbol
p55354
as(dp55355
g9
V17034
p55356
stp55357
a((dp55358
g2
(lp55359
VIt starts out pretty easy
p55360
aVThe pinvoke marshaller first calls LoadLibrary and passes the DLL name you specified, the DllImportAttribute
p55361
aVValue property
p55362
aVIn your case, user32
p55363
aVdll is already loaded because it gets loaded by the
p55364
aVNET bootstrapper, its reference count just gets incremented
p55365
aVBut normally the Windows loader gets the DLL mapped into the address space of the process so the exported functions can be called
p55366
aVNext is GetProcAddress to get the address of the function to call, the DllImportAttribute
p55367
aVEntryPoint property
p55368
aVThe marshaller makes a couple of tries unless you used ExactSpelling
p55369
aVA function name like "foo" is tested several possible ways, foo and fooW or fooA
p55370
aVNasty implementation detail of Win32 related to the difference between Unicode and Ansi characters
p55371
aVThe CharSet property matters here
p55372
aVNow I need to wave hands a bit because it gets tricky
p55373
aVThe marshaller constructs a stack frame, setting up the arguments that need to be passed to the exported function
p55374
aVThis requires low level code, carefully excluded from prying eyes
p55375
aVTake it at face value that it performs the kind of translations that the Marshal class supports to convert between managed and unmanaged types
p55376
aVThe DllImportAttribute
p55377
aVCallingConvention property matters here because that determines what argument value needs to be place where so that the called function can read it properly
p55378
aVNext it sets up an SEH exception handler so that hardware exceptions raised by the called code can be caught and translated into a managed exception
p55379
aVThe one that generates the more common one, AccessViolationException
p55380
aVAnd others
p55381
aVNext, it pushes a special cookie on the stack to indicate that unmanaged code is about to start using stack
p55382
aVThis prevents the garbage collector from blundering into unmanaged stack frames and interpret the pointers it finds there as managed object references
p55383
aVYou can see this cookie back in the debugger's call stack, [Managed to Native Transition]
p55384
aVNext, just an indirect call to the function address as found with GetProcAddress()
p55385
aVThat gets the unmanaged code running
p55386
aVAfter the call, cleanup might need to be done to release memory that was allocated to pass the unmanaged arguments
p55387
aVThe return value might need to be translated back to a managed value
p55388
aVAnd that's it, assuming nothing nasty happened, execution continues on the next managed code statement
p55389
as(dp55390
g9
V17034
p55391
stp55392
a((dp55393
g2
(lp55394
VTechnically it is possible, although it is very ugly
p55395
aVYou need to catch the message before it is sent to the control that was clicked
p55396
aVWhich you can do with IMessageFilter, you can sniff an input message that was removed from the message queue before it is dispatched
p55397
aVLike this:
p55398
as(dp55399
g9
V17034
p55400
stp55401
a((dp55402
g2
(lp55403
VWinRes
p55404
aVexe, it is included with the SDK
p55405
aVRun it from the Visual Studio command prompt
p55406
as(dp55407
g9
V17034
p55408
stp55409
a((dp55410
g2
(lp55411
VYes, you really need to do those things because the window is owned by another process
p55412
aVGlobal hooks require a DLL that can be injected
p55413
aVFull D+D support requires RegisterDragDrop and COM code
p55414
aVIcky COM code
p55415
aVAnd no, you really should not do this because somebody else might have already had the same idea as you
p55416
aVAnd got his program shipped first
p55417
aVThe appcompat team at MSFT must have a nightmare with it
p55418
aVCareful with Raymond Chen, he's got a Bad Temper
p55419
as(dp55420
g9
V17034
p55421
stp55422
a((dp55423
g2
(lp55424
VNot sure I follow
p55425
aVBut to get the ampersand to show up, you have to double it
p55426
aVFix:
p55427
as(dp55428
g9
V17034
p55429
stp55430
a((dp55431
g2
(lp55432
VInstance methods of a class have a hidden argument
p55433
aVAn example:
p55434
aVactually looks like this when the JIT compiler is done with it, converted back to C# syntax:
p55435
aVThat hidden argument is the reason that you can use this in an instance method
p55436
aVThe JIT compiler figures out the argument to pass from the object reference you provide to call the Foo method
p55437
aVAs you can tell, it is now a very short hop to an extension method
p55438
as(dp55439
g9
V17034
p55440
stp55441
a((dp55442
g2
(lp55443
VIt is complaining about the file format, it doesn't recognize it as an icon
p55444
aVI can't tell from your snippet, not enough of the base64 encoded value is visible
p55445
aVI have to say, if this IDE is making you write code like this then it is not helping you
p55446
aVStoring icons in the resources is utterly trivial in Visual Studio, there is no need to write any code at all
p55447
aVThe Express edition has the same price
p55448
as(dp55449
g9
V17034
p55450
stp55451
a((dp55452
g2
(lp55453
VAs long as you didn't intentionally design the class to be inherited from then there's no reliable way to guess what methods should be virtual and what members should be protected
p55454
aVThe only thing you can be sure about is that you'll very likely guess wrong
p55455
aVDon't mess around with this, use the sealed keyword and make the members private
p55456
aVYou can always refactor later, you will have to anyway
p55457
as(dp55458
g9
V17034
p55459
stp55460
a((dp55461
g2
(lp55462
VJust use a System
p55463
aVThreading
p55464
aVTimer with a period of 0 so that the callback runs only once
p55465
aVWhen everything is done, recharge the timer so it will fire again later
p55466
aVYou'll have guaranteed only ever one thread running this way
p55467
as(dp55468
g9
V17034
p55469
stp55470
a((dp55471
g2
(lp55472
VThe IDE really likes relative paths because absolute ones are so brittle
p55473
aVYour build will also break when the R: drive isn't mapped properly
p55474
aVBut it is fixable: Project + Properties, Common Properties, Framework and References
p55475
aVAdd the R:\u005c path to the "Additional reference search paths" list
p55476
as(dp55477
g9
V17034
p55478
stp55479
a((dp55480
g2
(lp55481
VIt's automatic when you set the GroupBox' AutoSize property to True, it will grow as needed to fit the ListView
p55482
aVThis isn't very common in most typical layouts since that will makes it liable to overlap some other control or grow beyond the form edges
p55483
as(dp55484
g9
V17034
p55485
stp55486
a((dp55487
g2
(lp55488
VThere's not enough code to diagnose the problem, especially without any evidence of error checking
p55489
aVHowever, there is something really smelly in what you posted
p55490
aVYour call to strncpy_s() says that pszFileName is a pointer to an array with 280 elements
p55491
aVWhere did that number come from
p55492
aVIs it just a guess
p55493
aVIt can never be more than 260 on Windows, why is it more
p55494
aVI suspect that when you make this a real number, like an argument passed to your function, instead of a guess that you'll fix the problem as well
p55495
as(dp55496
g9
V17034
p55497
stp55498
a((dp55499
g2
(lp55500
VNothing in the Win32 API for this
p55501
aVHowever, it is supported through WMI with the Win32_ProcessStartTrace query
p55502
aVYou'll find some C# code that demonstrates the query in my answer in this thread
p55503
aVWriting WMI code in C++ is fairly painful, you'll find a link to boilerplate code you have to write in the MSDN Library article
p55504
aVDo beware that this isn't particularly fast
p55505
aVIt isn't clear to me how much help the WMI provider gets from the kernel to generate the notification but given the speed it quacks like polling
p55506
aVIn other words, the process is likely to be well on its way by the time you get the notification
p55507
aVThis is otherwise par for the course on a multitasking operating system
p55508
as(dp55509
g9
V17034
p55510
stp55511
a((dp55512
g2
(lp55513
VYou forgot to add settings to the class library project
p55514
aVYou cannot access the settings of the EXE project directly
p55515
aVGiving a class library project its own settings is possible but it is a hassle
p55516
aVA DLL cannot have its own
p55517
aVconfig file, there's only one: the app
p55518
aVexe
p55519
aVconfig file
p55520
aVYou have to merge the entries in the DLL's app
p55521
aVconfig file into the app
p55522
aVexe
p55523
aVconfig file by hand
p55524
aVCopy and paste with a text editor
p55525
aVThis is not very maintainable
p55526
aVAnother approach is to make these settings properties of the class
p55527
aVAnd let the code in the main project initialize them from its own settings
p55528
aVOr just ditch settings because their a pita and use an
p55529
aVxml file
p55530
as(dp55531
g9
V17034
p55532
stp55533
a((dp55534
g2
(lp55535
VYou only need to check if your code is running in 64-bit mode
p55536
aVThat's easy:
p55537
as(dp55538
g9
V17034
p55539
stp55540
a((dp55541
g2
(lp55542
VThere is no obvious failure mode here
p55543
aVOther than that the pixel isn't actually a match with the color
p55544
aVBeing off by, say, only one in the Color
p55545
aVB value for example
p55546
aVYou cannot see this with the unaided eye
p55547
aVThese kind of very subtle color changes are quite common when the image was resized
p55548
aVAn interpolation filter alters the color subtly, even if not strictly needed
p55549
aVAnother failure mode is using a compressed image format like JPEG, the compression algorithm changes colors
p55550
as(dp55551
g9
V17034
p55552
stp55553
a((dp55554
g2
(lp55555
VYou need to set the ProcessStartInfo
p55556
aVUserName and Password properties
p55557
aVWith UseShellExecute set to false
p55558
aVIf you only have a token then pinvoke CreateProcessAsUser()
p55559
as(dp55560
g9
V17034
p55561
stp55562
a((dp55563
g2
(lp55564
VThere is no static
p55565
aVlib for these
p55566
aVThe SDK libraries are always import libraries, not static
p55567
aVlibs because the corresponding Windows API lives in a DLL
p55568
aVNo need to worry about this
p55569
as(dp55570
g9
V17034
p55571
stp55572
a((dp55573
g2
(lp55574
Vgcroot<> is a smart pointer
p55575
aVYou can cast to get the tracking handle out of it:
p55576
aVSteve's answer is fine too btw
p55577
as(dp55578
g9
V17034
p55579
stp55580
a((dp55581
g2
(lp55582
VIt is already automatic afaik
p55583
aVEvery time I tinkered with a Setup project, it already figured out the prerequisites from the projects I added
p55584
aVFrom your Setup project, use Project + Properties and click Prerequisites
p55585
aVVerify that the right Visual C++ Runtime Libraries and
p55586
aVNET Framework are ticked
p55587
as(dp55588
g9
V17034
p55589
stp55590
a((dp55591
g2
(lp55592
VThere's some virtue in , it will crash your program quicker
p55593
aV"COM object that has been separated from its underlying RCW cannot be used" is the CLR telling you that you taking care of COM reference counts yourself instead of leaving it up the CLR was a mistake
p55594
aVYour mileage may vary, you cannot really trust to get it right when it works on your dev machine
p55595
aVMake sure you implement good error reporting when you deploy the code to your customer's machine
p55596
aVThe virtue is that there's only one place in your code where you got it wrong, the  call
p55597
aVIt gets much fuzzier when you use
p55598
aVBecause that will go undetected for a while, crashing your program when the CLR calls the final , the one that destroys the object
p55599
aVVery far removed from an incorrect  call
p55600
aVBut that's the doomsday scenario, the more likely outcome is that the call just doesn't make any difference because you missed the hard ones
p55601
aVLike , an indexer reference that is so very hard to see being used
p55602
aVWell, my advice is obvious: don't do this
p55603
aVYou are competing with a machine that never gets it wrong
p55604
aVIt is merely a bit slow at doing so
p55605
aVA very good "report from real life" is available here
p55606
aVThe "silent assassin" section is most relevant
p55607
aVIf it is absolutely essential to get a COM server to exit instantly then let the machine take care of getting all the reference counts to 0
p55608
aVYou do so with GC
p55609
aVCollect()
p55610
aVBut do keep in mind that you have to place that call correctly if you want this to also work when you debug
p55611
aVIt won't work in the same method that uses the COM objects, explained in this answer
p55612
aVPut it in the calling method instead
p55613
as(dp55614
g9
V17034
p55615
stp55616
a((dp55617
g2
(lp55618
VAdding or removing items does not change the number you passed to SetItemData()
p55619
aVGetItemData() returns the same number
p55620
aVYou however need to pass the index of the item to DeleteString()
p55621
aVWhen lower numbered items were deleted before then the index will no longer match GetItemData()
p55622
aVIf you lost track of the index of a specific item you want to delete then you need to iterate the items to find it back
p55623
as(dp55624
g9
V17034
p55625
stp55626
a((dp55627
g2
(lp55628
VRunning out of non-paged pool memory is a very serious mishap in Windows
p55629
aVNothing good happens after that, drivers will fail to do their job, a reboot is required to recover from this
p55630
aVOf course, it isn't normal for a user mode program (a managed one at that) to cause this to happen
p55631
aVWindows protects itself against this by giving a process a limited quota of the available system resources
p55632
aVThere are many of them, a limit of 10,000 handles is an obvious one that strikes pretty often if a program leaks handles
p55633
aVMemory from the non-paged pool is exclusively allocated by drivers
p55634
aVThey need that kind of precious memory because they use memory at device interrupt time
p55635
aVA critical time where it isn't possible to map memory from the paging file
p55636
aVThe pool is small, it needs to be because it permanently occupies RAM
p55637
aVIt depends on the amount of RAM your machine has, typically 256 MB max for a machine with 1 GB of RAM
p55638
aVYou can see its current size in TaskMgr
p55639
aVexe, Performance tab
p55640
aVI'm giving it a decent workaround right now, it is currently showing 61 MB
p55641
aVClearly your program is making a driver on your machine consume too much non-page pool memory
p55642
aVOr it is leaking, possibly induced by the heavy workout you give it
p55643
aVWindows is powerless to prevent this, quotas are associated with processes, not drivers
p55644
aVYou'll have to find the driver that misbehaves
p55645
aVIt would be one that's associated with the file system or the disk
p55646
aVA very common one that causes trouble like this is, you probably guessed it by now, your virus scanner
p55647
as(dp55648
g9
V17034
p55649
stp55650
a((dp55651
g2
(lp55652
VThe DsoFramer download was removed at the exact same time that the first beta of Office 2010 shipped
p55653
aVThis is not a coincidence
p55654
aVOLE embedding is dead as a doornail, it has been for the past 8 years
p55655
aVYou could try calling Microsoft Support but I'm pretty sure they'll flip you the bird
p55656
aVYou cannot keep your app in its present form and hope to continue future Office versions
p55657
aVThis answer was not meant to be helpful, merely reinforcing that you are spending your time and energy trying to solve the wrong problem
p55658
as(dp55659
g9
V17034
p55660
stp55661
a((dp55662
g2
(lp55663
VUse Marshal
p55664
aVGetIUnknownForObject()
p55665
as(dp55666
g9
V17034
p55667
stp55668
a((dp55669
g2
(lp55670
VUse the Button
p55671
aVTag property to store a reference to its associated PictureBox
p55672
aVCast sender to Button:
p55673
as(dp55674
g9
V17034
p55675
stp55676
a((dp55677
g2
(lp55678
VThis is a bug that was present in VS2008 SP1
p55679
aVThere was a post-SP hotfix that solved it
p55680
aVUnfortunately, it doesn't look like they checked the fixed back into the trunk, the bugs came back in VS2010
p55681
aVThis is not uncommon for hotfixes
p55682
aVWell, no quick fix or well documented workaround I'm afraid
p55683
aVYou could post to connect
p55684
aVmicrosoft
p55685
aVcom to remind them about it
p55686
aVHopefully it will be covered by SP1, you might want to consider moving back to VS2008 while you wait for that
p55687
as(dp55688
g9
V17034
p55689
stp55690
a((dp55691
g2
(lp55692
VThis is a solved problem, avoid re-inventing that wheel
p55693
aVXML is the lingua franca of machines talking to each other over the internet
p55694
aVIt's chatty, if bandwidth is a concern then look for Google's protobuf
p55695
aVIt has many language bindings, C++ is well supported
p55696
as(dp55697
g9
V17034
p55698
stp55699
a((dp55700
g2
(lp55701
VYou can open a VB6
p55702
aVvbp project file in Visual Studio
p55703
aVThis automatically invokes the project converter, it will try to translate your VB6 code into VB
p55704
aVNET
p55705
aVThe translator does a fairly decent job of it but the VB
p55706
aVNET language has changed pretty drastically
p55707
aVIt depends on how 'clean' your VB6 code was
p55708
aVAfter the conversion is completed, you'll have to walk through the list of warnings and errors you'll get
p55709
aVGetting none at all is rare
p55710
aVThere might be hundreds or thousands
p55711
aVIf you're in that boat, it starts making sense to rewrite the code
p55712
aVAnyhoo, just try and see what hits the fan
p55713
aVYou'll have a good idea what you're in for in about ten minutes
p55714
aVDon't forget to copy the project before you start the conversion
p55715
as(dp55716
g9
V17034
p55717
stp55718
a((dp55719
g2
(lp55720
VThe WPF toolbox is not without problems
p55721
aVI've always managed to whack it back into shape by right-clicking it and choosing Reset
p55722
as(dp55723
g9
V17034
p55724
stp55725
a((dp55726
g2
(lp55727
VWell, it is simple, because not using separate folders is so much worse
p55728
aVYou'll build Release, find out something is amiss, switch back to Debug and not get the actual Debug versions of the assemblies
p55729
aVUnless you explicitly use Build + Clean first
p55730
aVNow you'll go sword-fighting or visiting SO, forgetting why you switched back
p55731
aVDealing with project output from another solution is straight forward too: always add a reference to the Release version
p55732
aVBecause if you needed to debug and alter that assembly then you would have added the project to your current solution
p55733
as(dp55734
g9
V17034
p55735
stp55736
a((dp55737
g2
(lp55738
VNot sure I see it from the screenshots
p55739
aVBut the complaint is a familiar one
p55740
aVMDI really dislikes a maximized child window
p55741
aVWhen you display a new child window and make it maximized as well then it needs to go through a song-and-dance
p55742
aVFirst it restores the current child so it is no longer maximized
p55743
aVThen creates the new child and sets the focus to it
p55744
aVThen maximizes it
p55745
aVThose intermediate steps are visible and can produce a good amount of flicker when drawing the child is expensive
p55746
aVYours look expensive
p55747
aVYou cannot suppress the painting
p55748
aVIf you always display your MDI child windows maximized then MDI is the wrong form model to use
p55749
aVJust use a simple form, make the child 'windows' user controls
p55750
aVYou can even rescue your current child forms by setting their TopLevel property to false, that turns them into controls
p55751
aVSet FormBorderStyle to None and Visible to true
p55752
as(dp55753
g9
V17034
p55754
stp55755
a((dp55756
g2
(lp55757
VIt doesn't make sense to create an installer for the Debug build, you always want the Release build
p55758
aVIf that's really necessary then open the
p55759
aVvdproj in Visual Studio, Build + Configuration Manager and tick the Build checkbox for the Debug configuration
p55760
aVBeware that this property is stored in the
p55761
aVsln file, not the
p55762
aVvdproj file so click File + Save All to let VS write the solution file
p55763
as(dp55764
g9
V17034
p55765
stp55766
a((dp55767
g2
(lp55768
VThis is typical behavior for a serial port
p55769
aVThey are very slow
p55770
aVWhen the DataReceived event fires, you'd typically only get one or two characters
p55771
aVNotably is that it works well when you debug because single-stepping through the code gives the serial port lots of time to receive additional characters
p55772
aVBut it will go Kaboom as soon as you run without a debugger because the string isn't long enough
p55773
aVYou'll need to modify the code by appending the string you receive to a string variable at class scope
p55774
aVOnly parse the string after you've received all the characters you expected
p55775
aVYou'll need some way to know that you've received the full response
p55776
aVMost typically serial devices will terminate the string with a special character
p55777
aVOften a line-feed
p55778
aVIf that's the case then you can make it easy by setting the SerialPort
p55779
aVNewLine property to that terminator and calling ReadLine() instead of ReadExisting()
p55780
as(dp55781
g9
V17034
p55782
stp55783
a((dp55784
g2
(lp55785
VUnfortunately you wrote something that already exists
p55786
aVThe SynchronizationContext class does exactly what you do
p55787
aVAdd a property to your main class, similar to this:
p55788
aVOr use AsyncOperationManager
p55789
aVSynchronizationContext, it does the exact same thing
p55790
aVPreferable of course
p55791
as(dp55792
g9
V17034
p55793
stp55794
a((dp55795
g2
(lp55796
VThere is no such thing as an 'empty bitmap'
p55797
aVYou might have a bitmap that contains nothing but black or white pixels
p55798
aVIt needs just as much memory as one that has, say, a photo of the same size
p55799
aVAnd is just as capable of generating an OOM exception when it is large
p55800
aVOr because you clicked several times since you forgot to dispose the old one:
p55801
aVThere could also be something wrong with the image file format, perhaps one that GDI+ doesn't support
p55802
aVThat too generates OOM, unfortunately
p55803
aVIn case it is relevant: don't try to load a
p55804
aVtxt file
p55805
as(dp55806
g9
V17034
p55807
stp55808
a((dp55809
g2
(lp55810
VA tab control draws itself according to the currently selected windows theme
p55811
aVWhich ignores a custom color
p55812
aVThis isn't something you ought to change, you typically want to honor the user's attempt to style the windows according to her selected preference
p55813
aVIf you really do want to override it then you can use custom drawing, the TCS_OWNERDRAWFIXED style flag and the WM_DRAWITEM message
p55814
aVBeware that drawing with a transparent color isn't going to work
p55815
as(dp55816
g9
V17034
p55817
stp55818
a((dp55819
g2
(lp55820
VThere are a couple of possibilities for this exception
p55821
aVBut if it is intermittent then there's really only one
p55822
aVYour code is leaking window handles
p55823
aVA program can allocate up to 10,000 of them before Windows pulls the plug and refuses to allow it to create any more
p55824
aVHard to repro because leaks like this take a while to build up to the quota
p55825
aVBut easily observed from Taskmgr
p55826
aVexe
p55827
aVClick the Processes tab, View + Select columns and tick "USER objects"
p55828
aVObserve this number while you run your program
p55829
aVIt will go up by one every time your app creates a new form or control
p55830
aVAnd should go down when you close a form
p55831
aVUnfortunately it is fairly easy to make a mistake that causes such a leak
p55832
aVIt happens when you remove a control from a form without calling its Dispose() method
p55833
aVOr calling Controls
p55834
aVClear() without disposing the controls first
p55835
aVControls that are removed like that are temporarily hosted on the "parking window"
p55836
aVWith the intent that it will survive long enough to allow you to move them to another container
p55837
aVIf that doesn't happen then the window handle for the control is permanently leaked
p55838
as(dp55839
g9
V17034
p55840
stp55841
a((dp55842
g2
(lp55843
VThere's a buffer, there's a buf_end, there's some 'buffer work'
p55844
aVAll invisible in the snippet
p55845
aVClearly there's some invisible code that writes past the end of the buffer, stomping the local variables debug and i
p55846
aVSet a data breakpoint on the buffer end and you'll find it in a minute or two, usually
p55847
as(dp55848
g9
V17034
p55849
stp55850
a((dp55851
g2
(lp55852
VConsole mode apps are restricted to an 8-bit code page encoding
p55853
aVThe default on many machines is IBM437, the code page that matches the old IBM PC character set
p55854
aVYou can change the code page by assigning the OutputEncoding property:
p55855
aVBut now you typically have a problem with the font
p55856
aVConsoles default to the Terminal font, an old device font that had glyphs in the right place to produce the IBM PC character set
p55857
aVThere are not a lot of fonts available that can produce the proper glyphs that match the Unicode codepoints
p55858
aVConsolas is about it, available on Vista and Win7
p55859
aVBut that's not what you are asking, I think, I'm guessing that you are actually asking about the old box drawing characters
p55860
aVThat works without any tinkering with the console settings, you just have to use the right Unicode characters
p55861
aVHere's an example that ought to survive a copy-and-paste:
p55862
aVTo find these characters, use the Windows charmap
p55863
aVexe applet
p55864
aVClick the "Advanced view" checkbox and type "box" in the "Search for" text box, the grid will fill with the box drawing characters
p55865
aVThe first usable one that will properly convert to the console is '\u005cu250c'
p55866
as(dp55867
g9
V17034
p55868
stp55869
a((dp55870
g2
(lp55871
VConverting a bitmap to a Region is a fundamentally slow process
p55872
aVHowever, I saw the author mentioning GetPixel() which is about as slow you could ever make it
p55873
aVReading pixels in a bitmap can be a lot faster if you use an unsafe pointer
p55874
aVThe code in this web page does so and generates the Region you need
p55875
as(dp55876
g9
V17034
p55877
stp55878
a((dp55879
g2
(lp55880
VThis is not a bug
p55881
aVIt is always possible to convert an integral value type to an enum like StringComparison
p55882
aVThe compiler normally requires a cast but you are bypassing the compiler here
p55883
aVAnd just as in C#, there is no check to verify that the integral value actually represents one of the enumeration values
p55884
as(dp55885
g9
V17034
p55886
stp55887
a((dp55888
g2
(lp55889
VNot sure if I understand the problem correctly
p55890
aVBut this is normal behavior
p55891
aVBeginSend means "do this asynchronously if you have to"
p55892
aVIt doesn't have to very often
p55893
aVIn many cases, the send can be completed synchronously because there was enough space in the kernel memory pool to store the bytes
p55894
aVThat only needs a very fast memory-to-memory copy and the overlapped I/O transfer completes immediately
p55895
aVAnother good example of this is FileStream
p55896
aVBeginWrite(), that writes to the file system cache
p55897
aVYou typically have to write more than a gigabyte before that fills up the cache and starts taking time
p55898
aVAnyhoo, under these circumstances the WaitOne() call will return immediately and not use the timeout
p55899
aVRaymond Chen just blogged about this recently
p55900
aVFrom a native API point of view but that's what is being used here
p55901
aVI don't think you've got a real problem here, just Windows working efficiently
p55902
as(dp55903
g9
V17034
p55904
stp55905
a((dp55906
g2
(lp55907
VThere are plenty of pain points here
p55908
aVYou assume that no other code will subclass the window
p55909
aVAnd that such code will un-subclass it in the right order
p55910
aVThere is no right order, your hooking is quite asynchronous from the program's execution
p55911
aVBut, the workaround is simple enough
p55912
aVYou are already hooking with SetWindowsHookEx, might as well do one more
p55913
aVWH_CALLWNDPROC or WH_CALLWNDPROCRET, depending on what you want to do
p55914
as(dp55915
g9
V17034
p55916
stp55917
a((dp55918
g2
(lp55919
VIt is explicitly forbidden by the SDK docs, but some appcompat hacks for Windows 3
p55920
aVx apps can make it possible
p55921
aVAb/used by several 32-bit programs as well, Acrobat Reader for one
p55922
aVP/Invoke SetParent(), you'll need the window handle of the app's main window
p55923
aVProcess
p55924
aVMainWindowHandle() with some luck
p55925
aVMoveWindow to put it in the right place
p55926
aVUse pinvoke
p55927
aVnet for the declarations you'll need
p55928
aVThe fact that this app displays video doesn't improve the odds that this will work out
p55929
as(dp55930
g9
V17034
p55931
stp55932
a((dp55933
g2
(lp55934
VYes, that's the strategy that the
p55935
aVNET framework uses
p55936
aVString
p55937
aVConcat() would be a good example
p55938
aVIt has overloads for up to 4 strings, a fallback one that takes a params string[]
p55939
aVPretty important here, Concat needs to be fast and is there to help the user fall in the pit of success when he uses the + operator instead of a StringBuilder
p55940
aVThe code duplication you'll get is the price
p55941
aVYou'd profile them to see if the speedup is worth the maintenance headache
p55942
aVFwiw: there are plenty of micro-optimizations like this in the
p55943
aVNET framework
p55944
aVSomewhat necessary because the designers could not really predict how their classes were going to be used
p55945
aVString
p55946
aVConcat() is just as likely to be used in a tight inner loop that is critical to program perf as, say, a config reader that only runs once at startup
p55947
aVAs the end-user of your own code, you typically have to luxury of not having to worry about that
p55948
aVThe reverse is also true, the
p55949
aVNET framework code is remarkably free of micro-optimizations when it is unlikely that their benefit would be measurable
p55950
aVLike providing overloads when the core code is slow anyway
p55951
as(dp55952
g9
V17034
p55953
stp55954
a((dp55955
g2
(lp55956
VIt's not a problem
p55957
aVUse the Show(owner) overload to display the form
p55958
aVAn owned form is always on top of its owner
p55959
aVIt minimizes automatically when you minimize the main window
p55960
aVNo need for ShowInTaskbar
p55961
aVAnother window model supported by winforms is MDI, check out the MdiParent property
p55962
aVThe child windows are confined inside the bounds of the main window
p55963
aVAlso consider using UserControls instead of a form, you can swap them in and out as needed
p55964
aVOr a tabbed interface, using TabControl
p55965
aVWeifenluo's DockPanel suite is a very popular implementation of the Visual Studio style windowing model, supporting windows that can be docked and floating within the main window
p55966
aVPlenty of choices here :)
p55967
as(dp55968
g9
V17034
p55969
stp55970
a((dp55971
g2
(lp55972
VThis will happen when you import a project that was created in an earlier version of VS
p55973
aVIt will import it for configurations Debug|AnyCPU and Release|AnyCPU
p55974
aVAdding a new project to the solution creates additional configurations: Debug|x86 and Release|x86, the defaults for VS2010
p55975
aVNow you got four
p55976
aVThey tried to find a workaround for that by adding yet another set, Debug|Mixed Platforms and Release|Mixed Platforms
p55977
aVNow you got six
p55978
aVOuch
p55979
aVThis is a bit of a mess
p55980
aVWhat is probably worst about it is that the configuration name is in no way associated with the Target Platform setting
p55981
aVYou can change it but the configuration name doesn't change
p55982
aVThis wasn't thought through real well
p55983
aVFix your problem with Build + Configuration Manager
p55984
aVStart with configuration = Debug, platform = x86
p55985
aVNote the Platform column, pick the project that has Any CPU
p55986
aVClick the combobox arrow, New and pick x86
p55987
aVImportant: uncheck the "Create new solution platforms" checkbox
p55988
aVTick the "Build" checkbox
p55989
aVSelect configuration = Release and repeat the procedure
p55990
aVThat puts everything in the right spot
p55991
aVYou can get rid of the bozo platforms by selecting Edit in the upper right platform combobox and using Remove
p55992
aVOh, make a backup before you begin
p55993
aVI don't think this will actually solve your problem, you should just remove the SQLite assembly reference and add it back
p55994
as(dp55995
g9
V17034
p55996
stp55997
a((dp55998
g2
(lp55999
VAxShockwaveFlash is an auto-generated Windows Forms control, created by aximp
p56000
aVexe
p56001
aVSo you can put it on a form
p56002
aVThat object you got is not that control
p56003
aVYou can only cast to the interface exposed by the interop wrapper, which should be ShockwaveFlashObjects
p56004
aVShockwaveFlash
p56005
as(dp56006
g9
V17034
p56007
stp56008
a((dp56009
g2
(lp56010
VThere is no documented way to find out if the workstation is currently locked
p56011
aVYou can however get a notification when it un/locks
p56012
aVSubscribe the SystemEvents
p56013
aVSessionSwitch event, you'll get SessionSwitchReason
p56014
aVSessionLock and Unlock
p56015
aVThe sceen saver is troublesome too
p56016
aVYour main window gets the WM_SYSCOMMAND message, SC_SCREENSAVE when the screen saver turns on
p56017
aVYou can pinvoke SystemParametersInfo to check if it running
p56018
aVYou'll find sample code for this in my answer in this thread
p56019
aVThere is no good way to find out if the user fell asleep
p56020
as(dp56021
g9
V17034
p56022
stp56023
a((dp56024
g2
(lp56025
s(dp56026
g9
V17034
p56027
stp56028
a((dp56029
g2
(lp56030
VA boxed value can only be unboxed to a variable of the exact same type
p56031
aVThis seemingly odd restriction is a very important speed optimization that made
p56032
aVNET 1
p56033
aVx feasible before generics were available
p56034
aVYou can read more about it in this answer
p56035
aVYou don't have to jump through the multiple cast hoop, simple value types implement the IConvertible interface
p56036
aVWhich you invoke by using the Convert class:
p56037
as(dp56038
g9
V17034
p56039
stp56040
a((dp56041
g2
(lp56042
VYou asked for it, you got it
p56043
aVTo get a match you'd need CAIRO_ANTIALIAS_SUBPIXEL
p56044
aVThis is however not appropriate when you draw text to an image that might be displayed on another machine
p56045
aVThere's no guarantee that the monitor on that machine is an LCD panel with the RGB stripes in a predictable order
p56046
aVOr that it in landscape orientation
p56047
aVOr that it is displayed with the exact original size
p56048
aVWhen there's a mismatch, the text will look quite poor
p56049
as(dp56050
g9
V17034
p56051
stp56052
a((dp56053
g2
(lp56054
VThat C code does not prevent a program from executing
p56055
aVIt simply waits for it to finish executing, the function won't return until that happens
p56056
aVYou'd get the exact same thing in
p56057
aVNET with Process
p56058
aVWaitForExit()
p56059
as(dp56060
g9
V17034
p56061
stp56062
a((dp56063
g2
(lp56064
VYou will need to set some additional properties to enable the border and the link behavior
p56065
aVThis worked well:
p56066
as(dp56067
g9
V17034
p56068
stp56069
a((dp56070
g2
(lp56071
VJust compile the C++ code with the /clr compiler option
p56072
aVThat will translate the code to IL, it can execute on most any
p56073
aVNET enabled platform
p56074
aVThere are very few C++ constructs that cannot be translated, it would have to use non-standard compiler extensions like __fastcall
p56075
aVHowever, I suspect that you will find out that the platform requires verifiable code
p56076
aVWhich is the common reason why a platform would restrict code to a
p56077
aVNET compliant language
p56078
aVI cannot guess at this since you didn't mention the execution environment
p56079
aVNative C++ translated to IL is not verifiable due to pointer manipulations
p56080
aVIf that's the case then you are looking at a pretty drastic rewrite
p56081
as(dp56082
g9
V17034
p56083
stp56084
a((dp56085
g2
(lp56086
VWell, WMI is COM enabled, the exception is not entirely mysterious
p56087
aVI suspect a race in the finalizer, try fixing it by calling the watcher's Stop() method before you let your program terminate
p56088
as(dp56089
g9
V17034
p56090
stp56091
a((dp56092
g2
(lp56093
VUse the PerformClick method:
p56094
aVMaybe you have to cast to Button, I can't tell from your snippet
p56095
aVI'll assume you won't need to pursue the reflection code anymore :)
p56096
as(dp56097
g9
V17034
p56098
stp56099
a((dp56100
g2
(lp56101
VThe general solution for this is to use the Makefile Project template
p56102
aVYou can specify the commands that build, clean and rebuild commands
p56103
aVYou typically only need the build command
p56104
aVIt is up to you to write it, anything goes
p56105
aVYou can add source code files to the project but there is no way to reference them in the build command
p56106
aVIn other words, if you add a new source code file then you'll have to modify the build command by hand
p56107
as(dp56108
g9
V17034
p56109
stp56110
a((dp56111
g2
(lp56112
VDebug + Exceptions, tick the Thrown box for CLR exceptions
p56113
aVYou'll now see what is going wrong
p56114
aVThere are several exceptions but the deal breaker is the second one, "The type
p56115
aVwas not expected"
p56116
aVAttributes are required to tell the xml serializer what types are stored in an ArrayList
p56117
aVThis is described in this MSDN Library page, "Serializing an ArrayList" section
p56118
aVProblem is, you cannot apply the required [XmlElement] attribute since the ArrayList instance is declared in auto-generated code
p56119
aVA generic List(Of T) doesn't have the same problem, but now you'll smack into a restriction in the setting designer, it doesn't support generic types
p56120
aVWell, a rock and a hard place here, you can't make this work
p56121
aVStringCollection is the distasteful alternative
p56122
aVOr ditch the idea of using Settings for this and just do it yourself with xml serialization
p56123
aVOr whatever else you prefer
p56124
as(dp56125
g9
V17034
p56126
stp56127
a((dp56128
g2
(lp56129
VThe WDK docs are reference material, they won't teach you how to get started
p56130
aVEssential are the sample code included with the WDK, there's lots of it and you can often find something that resembles the kind of driver you want to create
p56131
aVA generic filter driver is available in the src\u005ckmdf\u005ctoaster\u005cfilter directory, I think that's what you'd need if I understand your goal properly
p56132
aVWalter Oney's books are essential to learn important concepts, strongly recommended
p56133
aVI keep running into osronline
p56134
aVcom as a web site that strongly focuses on driver development, with forums
p56135
aVYou typically won't find much help here, it is a rather specialized kind of coding
p56136
as(dp56137
g9
V17034
p56138
stp56139
a((dp56140
g2
(lp56141
VHere's a snippet from the canonical Windows code, auto-generated when you create a new Win32 project in Visual Studio:
p56142
aVNote what's missing in yours: you forgot to call ShowWindow()
p56143
as(dp56144
g9
V17034
p56145
stp56146
a((dp56147
g2
(lp56148
VIt is quite unclear to me how you created subfolders for Resources
p56149
aVWhich is probably the source of your problem
p56150
aVMy
p56151
aVResources refers to resources that you add in the Project + Properties, Resources tab
p56152
aVThose resources get embedded into your program, they become part of the assembly itself
p56153
aVYou can't get a path for it such a resource, it isn't a file
p56154
aVYou have to use My
p56155
aVResources
p56156
aVResourceManager to retrieve them, it uses Assembly
p56157
aVGetmanifestResourceStream() internally to get to the embedded data inside the assembly
p56158
aVNot sure where you want to go with this, but if you actually want to use files in a folder instead of an embedded resource then you should not use My
p56159
aVResources
p56160
aVDoing this is a bit of a hassle because you have to copy the files from your project directory to the bin\u005cDebug and bin\u005cRelease directory
p56161
aVUsing My
p56162
aVResources is usually the preferred solution, especially since the user doesn't get ready access to your art, but it doesn't let you organize the resources into folders
p56163
aVLet us know what you really want to do
p56164
as(dp56165
g9
V17034
p56166
stp56167
a((dp56168
g2
(lp56169
VThis is a generic problem with any kind of program, not specific to a Winforms app
p56170
aVIt is related to the way a process is created
p56171
aVWindows creates a so-called memory mapped file, it maps the bytes in the file into the address space of the process
p56172
aVIt is a very efficient way to read data from a file, a disk read only occurs if the data is actually needed
p56173
aVWhen program execution jumps to a specific chunk of code, or the JIT compiler needs the IL for a method, a page fault is generated when the data hasn't been read yet
p56174
aVThe operating system solves it by reading a chunk from the file
p56175
aVYou only pay for code that actually runs
p56176
aVAnother major benefit is when the system is under pressure and too much RAM is needed to keep processes running
p56177
aVThe memory manager chucks pages out of RAM to make room for the process that needs the CPU
p56178
aVThese pages are normally written to the paging file
p56179
aVBut that's unnecessary when they came from the EXE file
p56180
aVIt can simply discard them and always get them back by re-reading the file
p56181
aVYou can probably see where this leads: loading pages from the EXE file can't work anymore when you popped out the disk
p56182
aVWindows notices this and puts up the dialog
p56183
aVThis is a very low level error handling mechanism, you cannot trap it in the process itself
p56184
aVThat couldn't work since that would require executing code in your program
p56185
aVCode that cannot be loaded from disk anymore
p56186
aVYou might be able to suppress the error by pinvoking SetErrorMode()
p56187
aVNot sure, never tried it
p56188
aVBut that doesn't really solve anything, the next best thing that could happen is that Windows terminates the program with an obscure error
p56189
aVThe only reasonable solution is either to let the user put the disk back, as requested by Windows, or to run an installer from your media so that a copy of the program is created on the hard drive
p56190
as(dp56191
g9
V17034
p56192
stp56193
a((dp56194
g2
(lp56195
VIt was tweaked to work better on modern Big Iron
p56196
aVMachines with more than 64 CPU cores, that kind of hardware
p56197
aVObviously they have less trouble with context switches
p56198
aVThe feedback loop they added to the scheduler is interesting, gathering statistics to make better scheduling decisions
p56199
aVBut this stuff doesn't kick in until you've got the major hardware first
p56200
as(dp56201
g9
V17034
p56202
stp56203
a((dp56204
g2
(lp56205
VUse WMI to get this kind of info, well supported by the System
p56206
aVManagement namespace
p56207
aVGet started by downloading the WMI Code Creator utility, it lets you experiment with queries and can auto-generate the C# you'll need
p56208
aVYou want to query Win32_Process, it provides lots of info about a process
p56209
aVPrivatePageCount would be a good measure for the amount of memory it uses that isn't shared by any other process
p56210
aVKernelModeTime and UserModeTime gives you time spent executing code
p56211
as(dp56212
g9
V17034
p56213
stp56214
a((dp56215
g2
(lp56216
VThe docs are a bit confuzzling, but I'm fairly sure you need to use NOTIFYICONDATA
p56217
aVhBalloonIcon
p56218
aVVista or better required
p56219
as(dp56220
g9
V17034
p56221
stp56222
a((dp56223
g2
(lp56224
VAssuming it registered properly, a standard failure mode is running on a 64-bit version of Windows
p56225
aVCOM servers like this are almost always only usable from 32-bit code
p56226
aVProject + Properties, Build tab, Platform target = x86
p56227
aVThe next approach is to use Regedit
p56228
aVexe and verify that it was actually registered
p56229
aVNavigate to HKLM\u005cSoftware\u005cClasses\u005cCLSID{guid} where {guid} is the GUID that you got from the error message
p56230
aVOn a 64-bit operating system, you'd find it in HKLM\u005cSoftware\u005cWow6432Node\u005cetc
p56231
aVThe next approach is to use SysInterals' ProcMon utility to observe your program searching the registry
p56232
aVThe next approach is to call the supplier for support
p56233
aVAnd then you give up trying to make it work
p56234
as(dp56235
g9
V17034
p56236
stp56237
a((dp56238
g2
(lp56239
VWell, yes, the example is a bit of a joke, you'd never write something like this yourself
p56240
aVWhat's missing is the really important part, the code that // opens the file
p56241
aVA realistic version of it would, say, pinvoke CreateFile()
p56242
aVThe point being that Windows doesn't know anything about CAS
p56243
aVSo if you provide a utility function like this and you want to enforce the CAS rules then you have to verify that your calling code has the required permission
p56244
aVOf course, this kind of code is really only belongs in the
p56245
aVNET framework
p56246
aVUse Reflector and take a look at FileStream
p56247
aVInit(), you'll see the FileIOPermission being demanded there, right before the CreateFile call
p56248
as(dp56249
g9
V17034
p56250
stp56251
a((dp56252
g2
(lp56253
VThe code snippet is using late binding, it is definitely a COM server
p56254
aVIf it was written in VB6 then it should also have a type library
p56255
aVThe odds are low if you can't add a reference to it from Visual Studio but I've seen a few cases where it failed but Tlbimp
p56256
aVexe had no problem
p56257
aVRun it from the Visual Studio Command Prompt
p56258
aVYou can also run OleView
p56259
aVexe and use File + View Typelib to look at the type library
p56260
aVIf these attempts fail then you're done, you can't reverse engineer this COM component without documentation
p56261
aVWhich, frankly, is fairly risky anyway
p56262
aVIf the original supplier of this COM component is out of business then there ought to be at least a programmer that still remembers working on this
p56263
aVHe might be reading SO but he can't find you until you drop some names
p56264
as(dp56265
g9
V17034
p56266
stp56267
a((dp56268
g2
(lp56269
VDependent Assembly Microsoft
p56270
aVVC90
p56271
aVDebugCRT,
p56272
aVcould not be found
p56273
aVYes, that can only be found on a machine that has Visual Studio installed
p56274
aVThe DebugCRT is not distributable
p56275
aVAnd it doesn't make sense to write C or C++ code and deploy the debug build for it, it is a lot slower
p56276
aVDeploy the Release build version of your DLL
p56277
aVAnd the VC++ Libraries, one of the check boxes in the Prerequisites of a Setup project
p56278
as(dp56279
g9
V17034
p56280
stp56281
a((dp56282
g2
(lp56283
VI don't see the code for TouchFiles() but it sounds like the source of the problem
p56284
aVLike when it iterates all of the directories on a disk drive
p56285
aVThat takes a lot of time, longer then the Service Control Manager is willing to put up with for a service to get started (30 seconds, I think)
p56286
aVStart a thread and have it touch the files
p56287
aVAlso beware of your BackgroundWorker, the events are not called on the same thread that started it
p56288
aVThat takes a synchronization provider that is not available in a service
p56289
as(dp56290
g9
V17034
p56291
stp56292
a((dp56293
g2
(lp56294
VThey are jerking you around, knowing full well that this is not that easy to implement
p56295
aVIt is utterly trivial for them to add the logging, they should already have done so if their app is that sensitive to network conditions
p56296
aVThe most positive view on this request is that they'll hope you'll figure this out by yourself from trying to make this work
p56297
aVCould happen
p56298
aVTalk to your supervisor and point this out
p56299
as(dp56300
g9
V17034
p56301
stp56302
a((dp56303
g2
(lp56304
VIt is constant time up to 32 elements with the BitArray class
p56305
aVYou could write a custom one to get up to 64 elements, using an underlying ulong[]
p56306
aVUnmanaged code makes 128 elements possible with the _mm_or_si128 and _mm_and_si128 intrinsics
p56307
aVHard to use due to their memory alignment requirements, can't get that from the garbage collected heap
p56308
aVThese are not practical amounts in most any case where you'd want to optimize this kind of code
p56309
aVIt is fundamentally an O(n) algorithm with a very small Oh
p56310
aVMight as well use BitArray
p56311
as(dp56312
g9
V17034
p56313
stp56314
a((dp56315
g2
(lp56316
VDataGridView is the only suitable control here
p56317
aVAnything else either doesn't have enough grid editing capabilities (like ListView) or is fugly-slow like individual controls in a TLP
p56318
as(dp56319
g9
V17034
p56320
stp56321
a((dp56322
g2
(lp56323
VThe trivial solution is to provide the bitmap along with the EXE as a separate file
p56324
aVActually replacing an embedded resource in the EXE requires decompiling it with  and putting it back together with
p56325
aVis only available in the Windows SDK, it can be downloaded separately
p56326
aVError prone and small odds that your customer can get that right, you'll need to provide them with, say, a
p56327
aVbat file that does this
p56328
aVOf course, whomever is interested in replacing the logo, for whatever reason, would not be slowed down by replacing either the separate image file or using the  trick
p56329
aVThere is therefore very little point in making it any more complicated then it needs to be
p56330
as(dp56331
g9
V17034
p56332
stp56333
a((dp56334
g2
(lp56335
VThe
p56336
aVNET 4
p56337
aV0 install did not go well
p56338
aVThe missing DLL is supposed to be present in C:\u005cWindows\u005cMicrosoft
p56339
aVNET\u005cassembly\u005cGAC_MSIL\u005cUIAutomationProvider\u005cv4
p56340
aV0_4
p56341
ag2512
ag2512
aV0__31bf3856ad364e35
p56342
aVReinstalling
p56343
aVNET 4
p56344
aV0 would be your next move
p56345
aVBut do worry a bit about your machine stability, DLLs don't just disappear or not get installed
p56346
as(dp56347
g9
V17034
p56348
stp56349
a((dp56350
g2
(lp56351
VMSBuild doesn't create an EXE file, a compiler does
p56352
aVNone of the Microsoft compilers currently support compiling from a memory stream
p56353
aVSystem
p56354
aVCodeDom provides an illusion of it but it actually uses the disk
p56355
aVThere's stuff coming in a future version of C#, plans are to provide 'compiler as a service' feature
p56356
aVCurrent internal project name is Roslyn
p56357
aVWhether that will affect the build process is murky, I doubt it but have no real clue how it will be integrated with the existing compiler, if at all
p56358
aVOne of the key properties of Windows is that there is only a slight difference between memory and files
p56359
aVAnything in memory is also in a file, the paging file for example
p56360
aVMemory is only a fast way to read and write file data
p56361
aVWhen you read or write a file, you are actually reading/writing memory
p56362
aVThe file system cache
p56363
aVIf it is big enough, it is for most any C# project, the compiler will read that same memory without ever hitting the disk
p56364
aVIt will only slow down when the file hasn't been read or written recently
p56365
as(dp56366
g9
V17034
p56367
stp56368
a((dp56369
g2
(lp56370
VYup, they wanted to improve (Extend) the API and keep a similar name so it was likely that the programmer would move to the new version
p56371
aVNotable is GetVersionEx() to get the Windows version, pretty painful for a while with a nasty chicken-and-egg problem
p56372
aVThe record keeper is the National Language Support team who have several ExEx versions, like EnumCalendarInfoExEx
p56373
aVUnsurprising, culture moves even faster than software
p56374
aVNo ExExEx as of yet
p56375
as(dp56376
g9
V17034
p56377
stp56378
a((dp56379
g2
(lp56380
VThis is the declaration for FindByType() as retrieved from the type library:
p56381
aVNote the 2nd argument, unsigned long
p56382
aVVB6 doesn't support unsigned types
p56383
aVIt is not a problem in VB
p56384
aVNET or C#, they do support them
p56385
aVThis problem is fixable if you have the Windows SDK installed
p56386
aVYou should have it if you have a recent version of Visual Studio
p56387
aVUse the Visual Studio Command Prompt, then:
p56388
aVrun oleview
p56389
aVexe c:\u005cwindows\u005csystem32\u005cupnp
p56390
aVdll
p56391
aVtype Ctrl+A, Ctrl+C to copy the type library content
p56392
aVrun notepad
p56393
aVexe, Ctrl+V
p56394
aVSearch for "unsigned" and delete it
p56395
aVThere are two
p56396
aVsave the file to a temporary directory with the name upnp
p56397
aVidl
p56398
aVrun midl upnp
p56399
aVidl /tlb upnp
p56400
aVtlb
p56401
aVcopy the generated upnp
p56402
aVtlb to your project directory
p56403
aVYou can now add upnp
p56404
aVtlb instead of upnp
p56405
aVdll, you should no longer get the error
p56406
aV-
p56407
as(dp56408
g9
V17034
p56409
stp56410
a((dp56411
g2
(lp56412
VYou are solving the wrong problem
p56413
aVIt will take a typical user well over a week to find back what she is looking for when she's got 5 million fields to search through
p56414
aVThe speed of your UI becomes irrelevant
p56415
aVOnly a machine can do a better job finding the data back
p56416
aVYou've got one
p56417
aVHelp the user narrow down what she is searching for by letting her enter search terms so that the total query result doesn't contain more than, say, a hundred rows
p56418
aVThe dbase engine helps you make that fast
p56419
aVAnd it automatically solves your grid perf problem
p56420
as(dp56421
g9
V17034
p56422
stp56423
a((dp56424
g2
(lp56425
VConverting the RGB color to the HSL color space often produces good results
p56426
aVCheck wikipedia for the conversion formula
p56427
aVIt is up to you to assign weights to the differences in H, the color, S, how 'deep' the color is and L, how bright it is
p56428
as(dp56429
g9
V17034
p56430
stp56431
a((dp56432
g2
(lp56433
VGo ahead and worry
p56434
aVThe CRT should emulate signal() but the MSVC one explicitly mentions that longjmp() is not legal in a handler unless it handles SIGFPE
p56435
aVCheck yours
p56436
aVThe equivalent of SIGSEGV is an SEH exception with exception code 0xc0000005 (STATUS_ACCESS_VIOLATION)
p56437
aVThe MSVC compiler allow catching them with the __try and __except keywords
p56438
aVThe idea of "protecting" a module like this is deeply flawed
p56439
aVYour program's state is corrupted beyond repair, you have no idea how it was mutated so you have no chance to restore it
p56440
aVContinuing to run can cause a number of mishaps
p56441
aVYou'll be lucky when it dies on another exception, giving you no clue what the real problem was, but it is more likely to just generate bad data that won't be diagnosed for a long time
p56442
aVYou are much better off just not writing code like this
p56443
aVAnd solve your porting problem in the process
p56444
as(dp56445
g9
V17034
p56446
stp56447
a((dp56448
g2
(lp56449
VProject + Properties, Application tab, change Shutdown Mode to "When last form closes"
p56450
aVThis ensures that your app won't quit until all the windows are closed
p56451
aVNow you can write code like this:
p56452
as(dp56453
g9
V17034
p56454
stp56455
a((dp56456
g2
(lp56457
VYou only have to use new GUIDs when the interface definition changes
p56458
aVWhen you keep them the same, your new COM server will replace the existing one
p56459
aVAnd client code that uses it doesn't have to be recompiled
p56460
aVWhen you do change them then they can live side-by-side but client code has to explicitly be recompiled to use the new one
p56461
aVNote that the in-process side-by-side CLR version support in
p56462
aVNET 4
p56463
aV0 is relevant here
p56464
aVYour COM server can be used in a program that binds the
p56465
aVNET 4
p56466
aV0 CLR, even if the COM server still binds the 2
p56467
aV0 CLR
p56468
aVTechnically you don't have to update it
p56469
as(dp56470
g9
V17034
p56471
stp56472
a((dp56473
g2
(lp56474
VPatching the relocatable addresses isn't the big deal, that runs at memory speeds, microseconds
p56475
aVThe bigger issue is that the pages that contains this code now need to be backed up by the paging file instead of the DLL file
p56476
aVIn other words, when pages containing code are unmapped, they need to be written to the paging file instead of just getting discarded
p56477
aVThe cost of this isn't that easy to measure, especially on modern machines with lots of RAM
p56478
aVIt only counts when the machine starts to get under load with lots of processes competing for memory
p56479
aVAnd the fragmentation of the paging file
p56480
aVBut clearly, rebasing is a very cheap optimization
p56481
aVAnd it is very easy to see in the Debug + Windows + Modules window, there's a bright icon on the rebased DLLs
p56482
aVThe Address column gives you a good hint what base address would be a good choice
p56483
aVLeave ample space between them so you don't constantly have to tweak this as your program grows
p56484
as(dp56485
g9
V17034
p56486
stp56487
a((dp56488
g2
(lp56489
VYou would have to work with the respective manufacturers to arrive at a solution
p56490
aVYou didn't post any snippet to verify that you did something wrong, I doubt it if you have double-checked the behavior in a native program
p56491
aVAnd there a few ways to fumble the arguments
p56492
aVUsing the Unicode version, like everybody else does, would be a remote chance
p56493
aVThis is a difficult kind of support request, you are working with two parties, Microsoft and the card vendor, they are liable to point fingers at each other
p56494
aVYour only real hope for a quick workaround is to force your app to run in 32-bit mode by setting the Target platform setting to x86
p56495
as(dp56496
g9
V17034
p56497
stp56498
a((dp56499
g2
(lp56500
VVS2005 doesn't support targeting, it is up to you to pick the assemblies you add as references wisely, your program will ask for the V2
p56501
aV0 CLR
p56502
aVVS2008 supports choosing between 2
p56503
aV0, 3
p56504
aV0 and 3
p56505
ag2447
aVThis is a simple trick, it just hides assemblies that are not available in an earlier version so you can't add them
p56506
aVYour program will still ask for the V2
p56507
aV0 CLR, the CLR version for all three versions of the framework
p56508
aVVS2010 targets the V4
p56509
aV0 CLR by default
p56510
aVYou can target earlier versions but there's a problem with that
p56511
aVThe build system was radically changed, switching to MSBuild instead of the legacy C/C++ builder
p56512
aVYou can only target an earlier version if you also have VS2008 installed on your machine
p56513
aVProjects that you import from an earlier VS version require editing the
p56514
aVvcxproj file by hand to get them to target an earlier
p56515
aVNET version
p56516
aVA fair amount of pain here, not sure what's in store for SP1
p56517
as(dp56518
g9
V17034
p56519
stp56520
a((dp56521
g2
(lp56522
VGetting events like this requires a window and a message loop
p56523
aVThe window is taken care of by SystemEvents, the message loop is automatically there in a WPF or winforms app
p56524
aVIt is smart enough to create a dedicated thread if you use it in another type of app, like a service or a console mode app
p56525
aVYou'll see that thread back in the debugger (Debug + Windows + Threads) with the name "
p56526
aVNET SystemEvents"
p56527
aVThis will happen when your app runs in a non-interactive Windows workstation (like services) or when your Main method doesn't have the [STAThread] attribute (like console apps)
p56528
aVNothing special is needed in your code to subscribe the event
p56529
aVBut do beware that your event handler will run on this helper thread, synchronization with the lock keyword might be necessary
p56530
as(dp56531
g9
V17034
p56532
stp56533
a((dp56534
g2
(lp56535
VNo, this is not possible
p56536
aVFSW sits at a very low level in the file system driver stack
p56537
aVIt can only tell that the file system is getting modified, it doesn't know by whom
p56538
aVThis is very much by design, it might be a process that sits half-way across the world, using a VPN connection over the internet to use a file share
p56539
aVThere is no reasonable alternative for your request
p56540
as(dp56541
g9
V17034
p56542
stp56543
a((dp56544
g2
(lp56545
VThis is the statement that probably causes it
p56546
aVIt fires the AfterCheck event
p56547
aVYour event handler will get called again, while it is already running
p56548
aVYou need to protect yourself against that and break the recursion with a private field
p56549
aVSomething like this:
p56550
as(dp56551
g9
V17034
p56552
stp56553
a((dp56554
g2
(lp56555
VNET has no support for this whatsoever
p56556
aVThe icon is stored in the unmanaged resources embedded in a
p56557
aVexe
p56558
aVYou can see them with File + Open + File, select the
p56559
aVexe and open the Icons node
p56560
aVThe lowest numbered icon is the one Windows uses
p56561
aVUpdating those resources normally requires rebuilding the
p56562
aVexe
p56563
aVLuckily the Windows API has support for updating resources on-the-fly
p56564
aVIt has restrictions but that shouldn't affect you for icons
p56565
aVYou'll need BeginUpdateResource, UpdateResource and EndUpdateResource
p56566
aVBeware that they are not easy to use, you need to know the icon resource number
p56567
aVVisit pinvoke
p56568
aVnet for the declarations you will need
p56569
as(dp56570
g9
V17034
p56571
stp56572
a((dp56573
g2
(lp56574
VCalling ToString() on a null value goes Kaboom
p56575
aVTry IsNot Nothing instead
p56576
aVBut I think the real answer is here
p56577
as(dp56578
g9
V17034
p56579
stp56580
a((dp56581
g2
(lp56582
VThis isn't new, the same attribute was added in previous versions of Visual Studio
p56583
aVThey just didn't change the item template
p56584
aVIt is a CAS attribute that basically says "I need at least the minimum permissions to run unmanaged code"
p56585
aVWhich is appropriate, that permission is always needed for a C++/CLI app
p56586
aVEven if you write pure code, unmanaged code permission is still required to initialize the CRT
p56587
aVThe permission is only relevant in sandboxing scenarios where code doesn't run with full trust, like inside a web browser or a secure plug-in setup
p56588
aVCAS has indeed been deprecated but it wasn't removed
p56589
aVNot quite sure what happens in
p56590
aVNET 4
p56591
aV0 these days
p56592
aVWhich was kind of the point with CAS getting obsoleted, it was ineffective because it was so hard to understand by an average Joe like me
p56593
aVShawn Farkas' blog is the best source for info about this
p56594
aVHe's the
p56595
aVNET security guru at Microsoft
p56596
aVThe C# version of it is much the same:
p56597
aVNot sure why you would need it, the C++/CLI assembly requesting it is enough
p56598
as(dp56599
g9
V17034
p56600
stp56601
a((dp56602
g2
(lp56603
VYes, this is only checked when a debugger is attached
p56604
aVThis was necessary because there was lots of
p56605
aVNET 1
p56606
aVx code that violated this rule
p56607
aVIt is not an obvious one
p56608
aVThe bigger problem is that such code got away with it
p56609
aVEither by luck, not thinking too much about the occasional painting problems or by thinking that aborting the app when it deadlocked and restarting it once a day was acceptable
p56610
aVBecause the programmer had no real hope of discovering the problem without a diagnostic
p56611
aVMicrosoft cares a lot about backward compat, even if it is buggy compat
p56612
aVThe fix is excellent, even though it is sometimes wrong (Show(owner) is checked when it shouldn't)
p56613
aVFor reference, the relevant code is present in the static constructor of the Control class:
p56614
as(dp56615
g9
V17034
p56616
stp56617
a((dp56618
g2
(lp56619
VFor the SerialPort class, that's Baudrate = 2400, Parity = None, DataBits = 8, StopBits = One
p56620
aVOnly the Baudrate has a non-default setting
p56621
as(dp56622
g9
V17034
p56623
stp56624
a((dp56625
g2
(lp56626
VWow, worrying about that definitely distracts from the joy of spending the money
p56627
aVIt makes no sense, it only thrashes when it is written frequently
p56628
aVThe install folder for an extension only gets written to once
p56629
as(dp56630
g9
V17034
p56631
stp56632
a((dp56633
g2
(lp56634
VYes, when you specify that the text file should be encoded in UTF-8, the CRT implicitly assumes that you'll be writing Unicode text to the file
p56635
aVNot doing so doesn't make sense, you wouldn't need UTF-8
p56636
aVThis will work proper:
p56637
aVOr:
p56638
as(dp56639
g9
V17034
p56640
stp56641
a((dp56642
g2
(lp56643
VThe underlying API is ReadDirectoryChangesW
p56644
aVThe only thing mentioned in the MSDN Library article for it is that the FILE_LIST_DIRECTORY access right is required on the directory handle and the directory needs to be opened with the FILE_FLAG_BACKUP_SEMANTICS option
p56645
aVThe
p56646
aVNET framework code is often helpful
p56647
aVThe private FileSystemWatcher
p56648
aVStartRaisingEvents() method uses this code to open the directory handle:
p56649
aVUse FILE_FLAG_OVERLAPPED only for asynchronous notifications
p56650
as(dp56651
g9
V17034
p56652
stp56653
a((dp56654
g2
(lp56655
VUse Assembly
p56656
aVCreateInstance() to create the object, pass it a 'well known name'
p56657
aVCast the return value to IFace, the rest is easy
p56658
aVOh, don't use LoadFile, use LoadFrom
p56659
as(dp56660
g9
V17034
p56661
stp56662
a((dp56663
g2
(lp56664
VIt's documented:
p56665
aVIf the path must be changed, the
p56666
aVapplication should clear the existing
p56667
aVGUID registry information before
p56668
aVmoving the binary file to a new
p56669
aVlocation and reregistering it with a
p56670
aVnew GUID
p56671
aVAny settings associated with
p56672
aVthe original GUID registration will be
p56673
aVlost
p56674
aVThis also occurs in the case of a
p56675
aVside-by-side installation
p56676
aVWhen
p56677
aVdealing with a side-by-side
p56678
aVinstallation, new versions of the
p56679
aVapplication should update the GUID of
p56680
aVthe binary file
p56681
aVNote  The only exception to a moved
p56682
aVfile occurs when both the original and
p56683
aVmoved binary files are
p56684
aVAuthenticode-signed by the same
p56685
aVcompany
p56686
aVIn that case, settings are
p56687
aVpreserved through the move
p56688
aVThe mechanics of the app "clearing the existing GUID registry information" are bit, erm, unclear
p56689
aVI'd work from the assumption that this doesn't actually happen often
p56690
aVSo, new guid or a certificate
p56691
as(dp56692
g9
V17034
p56693
stp56694
a((dp56695
g2
(lp56696
VThe usual approach to debug problems like this is to use the debugger
p56697
aVCopy/paste this into the Main() method of the source file for 'app
p56698
aVexe':
p56699
aVAs soon as app
p56700
aVexe starts running, you'll get a dialog that lets you pick a debugger
p56701
aVFrom there you shouldn't have much trouble figuring out why it doesn't work
p56702
aVIf you don't have the source code for app
p56703
aVexe then you'll need to think this through
p56704
aVUsing a relative path like "app
p56705
aVexe" or "temp
p56706
aVtxt" is always trouble
p56707
aVA classic failure mode is using an OpenFileDialog to let the user pick the _patchpath value
p56708
aVIf that dialog's RestoreDirectory property isn't set to True then your program's default directory changes to the path of the patch file
p56709
aVAnd neither app
p56710
aVexe nor temp
p56711
aVtxt can be fournd anymore
p56712
aVProtect yourself against this by programming defensively:
p56713
as(dp56714
g9
V17034
p56715
stp56716
a((dp56717
g2
(lp56718
VMatt Neerincx of the Sql Server team addressed this in an MSDN forum question
p56719
aVOdd but true, the connect timeout from the connection string is used to set the timeout
p56720
aVVerified by him looking at the source code
p56721
as(dp56722
g9
V17034
p56723
stp56724
a((dp56725
g2
(lp56726
VNope, you didn't improve what is already there
p56727
aVA byte[] is a reference type
p56728
aVYou can simply pass it to the MemoryStream(byte[]) constructor and no data is getting copied
p56729
aVMS simply stores a reference to the same array
p56730
aVIn fact, you made it worse because you pinned the array
p56731
aVGetting a garbage collection to run inside the body of your snippet isn't unlikely, you are reading stuff from the array and are probably creating objects from the data, strings and what-not
p56732
aVThe garbage collector needs to work around the pinned array, making its life considerably more difficult
p56733
aVThis can actually affect the perf of your program for a while, compacting the heap is important to make the CPU cache efficient
p56734
as(dp56735
g9
V17034
p56736
stp56737
a((dp56738
g2
(lp56739
VI have a form named testDebug
p56740
aVThis is a classic trap in VB
p56741
aVNET programming
p56742
aVSet a breakpoint on the If statement
p56743
aVNotice how it returns False, even though you know that the code is running on another thread
p56744
aVInvokeRequired is an instance property of a Form
p56745
aVBut testDebug is a class name, not a reference to an instance of a form of type testDebug
p56746
aVThat this is possible in VB
p56747
aVNET has gotten a lot of VB
p56748
aVNET programmers in deep trouble
p56749
aVIt is an anachronism carried over from VB6
p56750
aVIt completely falls apart and blows up in your face when you do this in a thread
p56751
aVYou'll get a new instance of the form, instead of the one that the user is looking at
p56752
aVOne that isn't visible because its  was never called
p56753
aVAnd otherwise dead as a doornail since the thread isn't running a message loop
p56754
aVI answered this question several times already, with the recommended fix
p56755
aVI'll just refer you to them rather than rehashing it here:
p56756
aVForm is not updating, after custom class event is fired
p56757
aVAccessing controls between forms
p56758
as(dp56759
g9
V17034
p56760
stp56761
a((dp56762
g2
(lp56763
VPay attention to the grid spacing, Report + Report Properties, General tab, Grid spacing
p56764
aVThe default setting is 0
p56765
aV125 inch, 4 points
p56766
aVWith the "Snap to Grid" check box turned on, only font sizes that are a multiple of 4 are easy
p56767
aVIf you try, say, a font of 10 points (not a multiple of 4) then you'll have a hard time sizing the text box
p56768
as(dp56769
g9
V17034
p56770
stp56771
a((dp56772
g2
(lp56773
VIt is not impossible, you don't actually need a StreamWriter initialized with Apppend = true
p56774
aVAll you need to do is use FileStream
p56775
aVSeek() to ensure that the 'file pointer' is positioned at the end of the file
p56776
aVThis sample C# code worked well:
p56777
aVDo note the fair amount of discomfort in this code
p56778
aVI would start with FileShare
p56779
aVRead, your preferred value
p56780
aVIt implies that you'll let another process read the file while you are tinkering with it
p56781
aVThere are good odds that this process is going to get a bit confused about bytes showing up in this file without notice
p56782
aVCould work out well, FileShare
p56783
aVNone ensures that your code can never cause any kind of mishap
p56784
aVStrongly recommended
p56785
aVNext flag is // Note not using using
p56786
aVThat's important because StreamReader will take 'responsibility' of the stream you pass it
p56787
aVIf you do the standard Right Thing in
p56788
aVNET code, the class is going to close the stream when the Using statement ends its scope
p56789
aVThat's not what you want, you want to keep a hold of the file so you can write to it
p56790
aVThe Seek() call does what the StreamWriter constructor's Append argument does, make really sure that you are appending to the file instead of randomly overwrite parts of the file from the beginning
p56791
aVSince you want to append, no problem about making sure that old data in the file is truncated
p56792
aVThe Flush call is the smelly bit here
p56793
aVYou have to call it to force the writer to flush its output buffer
p56794
aVIf you don't, random bits of what you write will be missing from the file
p56795
aVIt is normally not a problem because you'd call Close() or use the Using statement to ensure the writer is closed
p56796
aVNot in this case, the FileStream is calling the shots, it will properly close the file here but it doesn't know that another writer jumped on the bandwagon and wants to write
p56797
aVThis will work but it breaks a fair number of dogmas
p56798
aVThe more typical pattern is open-read + read + close, open-createnew + write + close
p56799
aVAnd dealing with the possibility that the open-createnew might in fail because another process grabbed the file
p56800
aVThe hazards of a multi-tasking operating system, always be prepared to deal with that
p56801
as(dp56802
g9
V17034
p56803
stp56804
a((dp56805
g2
(lp56806
VI rubbed my crystal ball and it said: "you downloaded this from the Codeplex site and you are using a Visual Studio edition earlier than 2010
p56807
aVIt's usually pretty reliable when it gets that explicit, I'll work from the assumption that it is accurate
p56808
aVIf you are not ready to upgrade to VS2010 then you'll need the 0
p56809
ag15605
aV0 version, as documented on the landing page
p56810
aVThe 0
p56811
ag15605
aV0 download is listed in the upper right box, this is the link
p56812
as(dp56813
g9
V17034
p56814
stp56815
a((dp56816
g2
(lp56817
VNo
p56818
aVIt is technically possible but it would be extremely rare to get the exact same amount of overhead
p56819
aVA hash table is organized into buckets
p56820
aVDictionary<> (and Hashtable) calculate a bucket number for the object with an expression like this:
p56821
aVSo two objects with a different hash code can end of in the same bucket
p56822
aVA bucket is a List<>, the indexer next searches that list for the key which is O(n) where n is the number of items in the bucket
p56823
aVDictionary<> dynamically increases the value of totalNumberOfBuckets to keep the bucket search efficient
p56824
aVWhen you pump a hundred million items in the dictionary, there will be thousands of buckets
p56825
aVThe odds that the bucket is empty when you add an item will be quite small
p56826
aVBut if it is by chance then, yes, it will take just as long to retrieve the item
p56827
aVThe amount of overhead increases very slowly as the number of items grows
p56828
aVThis is called amortized O(1)
p56829
as(dp56830
g9
V17034
p56831
stp56832
a((dp56833
g2
(lp56834
VList<>
p56835
aVCount is not a field, it is a property
p56836
aVYou can't create a unmanaged reference to a managed property, obtaining the property value requires calling the property accessor
p56837
aVShort from your first approach, the better mousetrap here is to use Math::Max()
p56838
as(dp56839
g9
V17034
p56840
stp56841
a((dp56842
g2
(lp56843
VThere is no such thing as an 'alias' for registry keys
p56844
aVYou can however create an entry in HKCU\u005cSoftware\u005cClasses\u005cCLSID, COM looks there first
p56845
aVThis would also limit the amount of damage you do to the machine and you'll have halfway decent odds of actually being able to write the key
p56846
as(dp56847
g9
V17034
p56848
stp56849
a((dp56850
g2
(lp56851
VNot sure where the focus is supposed to go
p56852
aVBut if to the hovered window then fake a mouse click with SendInput()
p56853
as(dp56854
g9
V17034
p56855
stp56856
a((dp56857
g2
(lp56858
VNo, you're fine with this code
p56859
aVThe garbage collector only moves managed (ref class) objects allocated on the GC heap
p56860
aVIt doesn't mess with the stack or the JIT compiled code
p56861
aVYou don't have to worry about inducing bugs like this, the compiler always warns you about it
p56862
aVTry making the vector a member of the class for example
p56863
aVNow it would be a problem, the GC does move an object of type "test"
p56864
as(dp56865
g9
V17034
p56866
stp56867
a((dp56868
g2
(lp56869
VThe Application
p56870
aVIdle event is good to do this, it runs after the last input event is retrieved
p56871
aVYou just need to check if the currently active control is capable of copy/paste
p56872
aVMake your form's code look similar to this, using a ToolStrip with the 3 buttons:
p56873
as(dp56874
g9
V17034
p56875
stp56876
a((dp56877
g2
(lp56878
VIf I go into TaskManager and kill the second application, the first one gets that notification
p56879
aVKeep your eyes on the ball, the real problem is that this second application is not exiting by itself
p56880
aVAnd thus myProcess
p56881
aVWaitForExit() isn't going to return
p56882
aVSo this is not a problem in your code snippet
p56883
aVWhy the 2nd app doesn't want to quit is completely unclear from your question
p56884
aVGiven that it is a Windows Forms app, do keep in mind that there is nobody to click the Close button of the form
p56885
aVApplication
p56886
aVExit() should make it stop, Environment
p56887
aVExit() is a rude abort that cannot be veto-ed by a FormClosing event handler
p56888
as(dp56889
g9
V17034
p56890
stp56891
a((dp56892
g2
(lp56893
VWhen you use the Win32 API like this, it is very important that you check for errors yourself
p56894
aVYou no longer have the friendly
p56895
aVNET wrappers that will do it for you and throw an exception
p56896
aVThis needs to be done in several places, but here's one:
p56897
aVThe real problem is your use of mainModule
p56898
aVModuleName
p56899
aVIf only gives the name of the file, not the full path
p56900
aVGetModuleHandle() will fail and return IntPtr
p56901
aVZero
p56902
aVAs above, if you would have tested this then you'd have quickly found the problem
p56903
aVThere's an additional failure mode when you run this code in
p56904
aVNET 4
p56905
ag2512
aVThe CLR no longer fakes native modules for managed code
p56906
aVSetWindowsHookEx() needs a valid DLL handle but it doesn't actually use it since this is a low-level hook
p56907
aVThe best way to get one is to ask for user32
p56908
aVdll, it is always loaded in a managed program:
p56909
aVNo need to release it
p56910
as(dp56911
g9
V17034
p56912
stp56913
a((dp56914
g2
(lp56915
VYou already know that JIT compiling is not the problem, that would also slow down the second start
p56916
aVAll you have to do is get the DLLs in the file system cache
p56917
aVSo that when you start the program later, it will use the copy of that DLL from the cache instead of digging through the network attached drive to find it
p56918
aVWhich is what is taking time
p56919
aVOffice Quick Start is using the same trick
p56920
aVNot sure who will win if all this preloaded stuff doesn't fit anymore
p56921
aVJust create a Winforms app, so you don't get a window, and call Assembly
p56922
aVLoad() to get the assemblies loaded, File
p56923
aVReadAllBytes() to ensure the entire content is in the cache
p56924
aVPut a shortcut to this program in the Startup folder
p56925
aVThat one assembly you mentioned is plenty big enough to get a boost in the warm start from Ngen
p56926
aVexe
p56927
aVThat has to be run on each individual work station though
p56928
as(dp56929
g9
V17034
p56930
stp56931
a((dp56932
g2
(lp56933
Vtable
p56934
aVColumns
p56935
aVAdd(new DataColumn("Date1", typeof(DateTime)));
p56936
aVUse the DataColumn
p56937
aVDateTimeMode property:
p56938
aVThis shouldn't matter if you store dates in your dbase in UTC, like you should
p56939
as(dp56940
g9
V17034
p56941
stp56942
a((dp56943
g2
(lp56944
VAt the command prompt, type NET START to get a list of running services
p56945
aVThe name you see listed is what you should pass as the first argument
p56946
aVA example name would be "SQL Server (SQLEXPRESS)"
p56947
as(dp56948
g9
V17034
p56949
stp56950
a((dp56951
g2
(lp56952
VYes, sure, a namespace is not tied to any particular assembly
p56953
aVIt is otherwise an excellent way to confuse the user of your classes beyond recoverable hope
p56954
aVAnd strongly discouraged by Microsoft, they claim both "Microsoft" and "System" as theirs
p56955
aVWith zero sympathy if some kind of future update of
p56956
aVNET will have a namespace name that collides with yours
p56957
as(dp56958
g9
V17034
p56959
stp56960
a((dp56961
g2
(lp56962
VAdmin privileges are required to allow Regasm
p56963
aVexe to update the registry
p56964
aVIf this is a UAC restriction then create a shortcut on the desktop for cmd
p56965
aVexe and check the "Run this program as an administrator" checkbox
p56966
aVOr change this setting on the Visual Studio Command Prompt shortcut, that's easier
p56967
as(dp56968
g9
V17034
p56969
stp56970
a((dp56971
g2
(lp56972
VHard to see how your icon could mess this up
p56973
aVIt sounds like a corrupted icon cache
p56974
aVThe linked article is quite outdated, ask more about this at superuser
p56975
aVcom
p56976
as(dp56977
g9
V17034
p56978
stp56979
a((dp56980
g2
(lp56981
VStandard problem with C arrays, not even the debugger can know how long they are
p56982
aVYou have to tell it that with a watch expression like nonces[0],12
p56983
aVYou tagged this with C++/CLI, it is not a problem with managed arrays:
p56984
as(dp56985
g9
V17034
p56986
stp56987
a((dp56988
g2
(lp56989
VNative code can call managed code but that needs to be done in a source code file that's compiled with /clr
p56990
aVYou need a little adapter class that's native (no "ref") in ProjectB
p56991
aVIf these are instance methods then you'll need gcroot<> in the adapter to store a reference to the managed class
p56992
as(dp56993
g9
V17034
p56994
stp56995
a((dp56996
g2
(lp56997
VUse the TreeNode
p56998
aVBounds
p56999
aVRight property and compare against TreeView
p57000
aVClientRectangle
p57001
aVRight
p57002
as(dp57003
g9
V17034
p57004
stp57005
a((dp57006
g2
(lp57007
VThis is not something you can fix in
p57008
aVNET code
p57009
aVThe
p57010
aVNET Process class as well as Windows uses Unicode
p57011
aVThe conversion from Unicode to an 8-bit char string happens inside the C Runtime Library embedded in the program you started
p57012
aVThat conversion is based on the current system code page, it uses the WideCharToMultiByte() API function with CodePage = CP_ACP
p57013
aVThere is no way to change that conversion, short from changing the system code page
p57014
aVWhich has drastic effects on the entire operating system
p57015
aVOf course this is a lossy conversion, it can only handle characters that are defined in the code page
p57016
aVIf you pass it an argument that contains a Unicode character that cannot be represented in the code page then the program will see a question mark in that string
p57017
aVNo amount of string manipulation that you could do in your
p57018
aVNET code can prevent this, short from omitting or substituting that character
p57019
aVBut then you are not passing it the same string anymore
p57020
as(dp57021
g9
V17034
p57022
stp57023
a((dp57024
g2
(lp57025
VThe designer honors the access modifiers on the base class members
p57026
aVYou must change the Modifiers property of the base form's control from Private to Protected
p57027
aVRecompile
p57028
aVNow the inherited form has access to the control, you'll have no trouble overriding properties and assigning an event handler from the designer
p57029
as(dp57030
g9
V17034
p57031
stp57032
a((dp57033
g2
(lp57034
VYou could decompile the interop library with , edit the declaration and put it back again with ilasm
p57035
aVexe
p57036
aVUse a sample C# declaration to know how to edit it
p57037
aVOr you could just declare that one interface in C#
p57038
aVThe name doesn't matter, only the GUID has to match
p57039
aVOpen the interop library in Reflector and copy/paste the interface declaration into your C# code
p57040
aVChange the interface name and modify the method that causes the problem
p57041
as(dp57042
g9
V17034
p57043
stp57044
a((dp57045
g2
(lp57046
VIt requires using COM, ShellLinkObject from shell32
p57047
aVdll
p57048
aVNo idea what that takes in Java, but you'll find C# code in my answer in this thread
p57049
as(dp57050
g9
V17034
p57051
stp57052
a((dp57053
g2
(lp57054
VSwitch to the Release build, Project + Properties, Build tab, scroll down, Advanced
p57055
aVChange the "Debug Info" setting to Full
p57056
aVBe sure to change the /y argument, these
p57057
aVpdbs need to be stored separate from the debug versions
p57058
as(dp57059
g9
V17034
p57060
stp57061
a((dp57062
g2
(lp57063
VNo, this has nothing to do with stack vs heap
p57064
aVThe stack in a managed program is no different from one in a native program
p57065
aVUsing native code in a managed program doesn't make it any less likely to cause it to destroy the heap, stomp the stack frame, overwrite the end of a buffer, invoke undefined behavior, the usual stuff that make native code crash with an access violation
p57066
aVThe difference between storing it on the stack vs the heap is the kind of damage that's done
p57067
aVYes, heap corruption can take a while to have side-effects
p57068
aVUsually much longer than stack frame corruption, including never
p57069
as(dp57070
g9
V17034
p57071
stp57072
a((dp57073
g2
(lp57074
VIt's possible, Windows has a dedicated API for it, BlockInput()
p57075
aVBe sure to save all your work when you experiment with it, it is rather effective
p57076
aVYou may need to reboot your machine, the thing your user will do when you use it in a program
p57077
aVHere's a sample Windows Forms form that uses it, it needs a button and a timer:
p57078
as(dp57079
g9
V17034
p57080
stp57081
a((dp57082
g2
(lp57083
VDispatcher
p57084
aVBeginInvoke() is a fire-and-forget method, the delegate target runs at some later time on the UI thread
p57085
aVThat's not good enough in your case, you need to wait until the target runs so you can get the return value
p57086
aVUse the Invoke() method instead:
p57087
aVAnd use Func instead of Action
p57088
aVOr AddressOf, the more 'natural' VB
p57089
aVNET way
p57090
as(dp57091
g9
V17034
p57092
stp57093
a((dp57094
g2
(lp57095
VCreate a temporary Console application and run this code:
p57096
aVWhat does it say
p57097
as(dp57098
g9
V17034
p57099
stp57100
a((dp57101
g2
(lp57102
VThere is a try/catch block around the message loop code inside Application
p57103
aVRun() that catches unhandled exceptions raised by an event handler
p57104
aVThe catch clause raises the Application
p57105
aVThreadException event
p57106
aVThere is a default handler for that event, it displays a ThreadExceptionDialog
p57107
aVGiving the user the option to ignore the error or abort the program
p57108
aVThis catch clause is disabled when you run your program with a debugger
p57109
aVThis allows you to easily debug exceptions
p57110
aVWith it disabled, the CLR will find the catch clause in your Main() method
p57111
aVTo disable this behavior, add this line of code to the top of your Main() method:
p57112
aVIt will now behave the same way as in the debugger
p57113
aVThe better mousetrap here is to implement an event handler for AppDomain
p57114
aVCurrentDomain
p57115
aVUnhandledException
p57116
aVThis catches all unhandled exceptions, including those raised in worker threads
p57117
aVAnd lets you debug unhandled exceptions, the debugger stops at the throw statement
p57118
as(dp57119
g9
V17034
p57120
stp57121
a((dp57122
g2
(lp57123
VYeah, confuzzling setting
p57124
aVIt is actually a linker setting: Linker, Debugging, Generate Program Database File
p57125
aVMake sense if you think about it, only after linking are all object files combined and can debug info be created
p57126
aVNot sure why you'd have to jump through this hoop, the default settings in the Debug configuration ensure that a
p57127
aVpdb file is created
p57128
aVOught to be good enough for NCover, I'd imagine
p57129
as(dp57130
g9
V17034
p57131
stp57132
a((dp57133
g2
(lp57134
VNo, you can't do these things without getting elevated
p57135
aVThe point of UAC is not to stop you from doing this, it is to let the user know that you're about to do this
p57136
aVAn obvious and valuable property of UAC is that it doesn't provide a backdoor to do these things anyway without the user knowing about it
p57137
aVThis is not a problem, it is a feature
p57138
aVWhat you describe doesn't strike me as something that needs to happen frequently
p57139
aVThis should not wear out the user
p57140
aVIf that's an issue, you can run it from a scheduled task using an admin account
p57141
as(dp57142
g9
V17034
p57143
stp57144
a((dp57145
g2
(lp57146
VRight, not an option
p57147
aVThere's no knob that you can tweak to make it a supported format, neither GDI+ nor WPF have an encoder for that format
p57148
aVYou'll need to find a graphics library
p57149
aVStart with the Big Dog, Lead Tools
p57150
aVYou'd better contact them first to ask if they support that format, it is very unusual
p57151
aVI've never heard of it
p57152
as(dp57153
g9
V17034
p57154
stp57155
a((dp57156
g2
(lp57157
VClassic sign of a threading problem
p57158
aVTest textBox1
p57159
aVInvokeRequired in this code
p57160
aVAnd delete any assignment to Control
p57161
aVCheckForIllegalCrossThreadCalls you might have
p57162
as(dp57163
g9
V17034
p57164
stp57165
a((dp57166
g2
(lp57167
VThere's no hope to diagnose the source of the problem from the question
p57168
aVJust some pointers
p57169
aVStart by setting the OpenFileDialog's RestoreDirectory to True
p57170
aVThis ensures that clicking Open doesn't change the program's working directory
p57171
aVIf that works then there's a rather mysterious dependency on the current directory in the query
p57172
aVNext thing to worry about are the DLLs that are getting loaded when you use the dialog
p57173
aVProject + Properties, Debug tab, tick "Enable unmanaged code debugging"
p57174
aVCheck out the Output window when you open the dialog, it shows a list of the DLLs getting injected
p57175
aVThese are shell extensions, one of them might conflict with SQLite
p57176
aVNo real clue what such an extension might do beyond maybe corrupting memory or using SQLite itself
p57177
aVYou can temporarily disable shell extension with the SysInternals' AutoRuns utility
p57178
aVStart with the ones not written by Microsoft
p57179
as(dp57180
g9
V17034
p57181
stp57182
a((dp57183
g2
(lp57184
VIt is rather by accident that TextBox doesn't cause this exception
p57185
aVIts Text property is cached in a string
p57186
aVThat's not the case for ComboBox
p57187
aVText, and the vast majority of other control properties, it asks the native Windows control and at that point Windows Forms discovers that you are trying to use a control from a thread other than the UI thread
p57188
aVNo can do
p57189
aVYou definitely need to think of a way to restructure this code
p57190
aVIt is not only illegal, it is incredibly expensive and fundamentally thread unsafe since the UI could be updated while your worker is running
p57191
aVCollect the info from the controls you need into a little helper class, pass that as an argument to the RunWorkerAsync(object) overload
p57192
aVAnd get it back in DoWork from e
p57193
aVArgument
p57194
as(dp57195
g9
V17034
p57196
stp57197
a((dp57198
g2
(lp57199
VYou do, indirectly, marshal
p57200
aVh includes it
p57201
aVIt dumps an enormous amount of identifiers in the global namespace
p57202
aVThe macros are especially awkward, lots of them match names used in the framework
p57203
aVLots of things that marshal
p57204
aVh does can be done by the Marshal class as well
p57205
aVBut I can't help you with that, you didn't mention why you want to use it
p57206
aVYou can solve this particular mishap by putting the #include directive before the using statements:
p57207
as(dp57208
g9
V17034
p57209
stp57210
a((dp57211
g2
(lp57212
VI repro, this should technically be possible
p57213
aVClearly the compiler doesn't agree
p57214
aVThe workaround is simple though:
p57215
aVOr as a one-liner:
p57216
aVThe JIT compiler should optimize the temporary away so it doesn't cost anything
p57217
as(dp57218
g9
V17034
p57219
stp57220
a((dp57221
g2
(lp57222
VHmya, this is not the way it is normally done
p57223
aVAfter initializing the CLR, you'd next load an assembly that is not in the GAC, produced by a managed compiler
p57224
aVTypically an EXE with a Main() method but you've got alternate options here of course
p57225
aVIf you want to pursue this then you really do have to produce a fully qualified name, Fusion requires it to know which assembly to pick from the GAC
p57226
aVThe equivalent of gacutil /l is the Fusion API, you'd use CreateAssemblyEnum() to iterate it
p57227
aVGets you an IAssemblyEnum, its GetNextAssembly() method gets you an IAssemblyName
p57228
aVThere has to be some hard-coded selection algorithm to decide exactly which version you'd prefer
p57229
aVThis is not a problem when you use an assembly created by a managed compiler
p57230
aVThe assembly references in the project select the desired version
p57231
aVI'd have to recommend you head that way
p57232
as(dp57233
g9
V17034
p57234
stp57235
a((dp57236
g2
(lp57237
VYes, a screen saver runs in its own desktop
p57238
aVThere are three common ones, the login desktop, the one you are looking at now and the screen saver desktop
p57239
aVA process is associated to a desktop through the STARTUPINFO
p57240
aVlpDesktop member passed to CreateProcess
p57241
aVWhen NULL, it runs in the current desktop
p57242
aVa desktop cannot be closed until all processes that run on it are closed
p57243
aVWhich is what you see happening done automatically
p57244
aVNot sure why you are trying to do this but you're looking at pinvoking CreateProcess to avoid getting this process killed
p57245
aVI do rather doubt that Windows allows this, screen savers were a notorious vector for malware
p57246
as(dp57247
g9
V17034
p57248
stp57249
a((dp57250
g2
(lp57251
VThe Bitmap class is a managed class wrapper around a big chunk of unmanaged code called GDI+
p57252
aVThe wrapper itself uses very little memory, the actual bitmap pixels are stored (by the unmanaged code) in unmanaged memory
p57253
aVThe garbage collector cannot touch that memory, it can only see the wrapper
p57254
aVThis is also why Bitmap has a Dispose() method, it frees that unmanaged memory
p57255
aVThe OOM you get is GDI+ telling the wrapper that it can't allocate the unmanaged memory anymore
p57256
aVYes, or ArgumentException when GDI+ randomly decides that the Width or Height you pass is too large instead of throwing OOM
p57257
aVGDI+ is pretty notorious for throwing uninformative exceptions
p57258
aVThe finalizer isn't called because your program bombs on the GDI+ exception first
p57259
aVThe memory allocation that failed was not one from the garbage collected heap, it was the unmanaged code that couldn't allocate anymore
p57260
aVThe finalizer code is wrong, by the time your finalizer runs, the bitmap is probably already finalized itself
p57261
aVYou must instead have ImageHolder implement IDisposable, like this:
p57262
aVNow you've got a shot at preventing OOM:
p57263
aVIf you really do need to store a thousand of those large images then you'll need a machine that can provide 1000 x 1000 x 1000 x 4 = 4 gigabytes of virtual memory
p57264
aVThat's possible, a 64-bit operating system can give you that
p57265
aVThe generic rule of thumb to keep you out of trouble like this is that it is extremely rare to implement your own destructor
p57266
aVIt is the job of the
p57267
aVNET classes to provide wrappers around unmanaged resources
p57268
aVLike Bitmap
p57269
aVThose wrapper classes have a finalizer, you don't need (and should not) provide your own
p57270
aVThe 99
p57271
aV99% case is that you need to implement IDisposable so you can call Dispose() on the
p57272
aVNET class instances
p57273
aVEven if you would be tempted to manage your own operating system resources then you still don't
p57274
aVYou should use one of the SafeHandle wrappers
p57275
as(dp57276
g9
V17034
p57277
stp57278
a((dp57279
g2
(lp57280
VThe Environment
p57281
aVUserName property getter asks for a demand on the EnvironmentPermission
p57282
aVRead permission
p57283
aVYeah, that's going to blow in a sand-boxed environment such as created to run code securely inside a browser
p57284
aVA web app has no business obtaining privileged information such as the user name
p57285
aVIt is half-way to being able to crack the user's login credentials, albeit that the password would be a bit harder to guess
p57286
aVNo can do, if you want the user to reveal her user name then you are going to have to ask her politely
p57287
aVAnd do make sure that's a name that you provide, don't expect her to reveal the name she uses to logon to her machine
p57288
as(dp57289
g9
V17034
p57290
stp57291
a((dp57292
g2
(lp57293
VIt is built-in, the BackgroundWorker class implements it automatically
p57294
aVIts event handlers run on the UI thread, assuming it is properly created
p57295
aVTaking a more cynical approach to this: it is an anti-pattern
p57296
aVAt least in my code, it is extremely rare that the same method run on both the UI thread and some worker thread
p57297
aVIt just doesn't make sense to test InvokeRequired, I know it is always is true since I wrote the code that would call it intentionally as code that runs in a separate thread
p57298
aVWith all the necessary plumbing that's required to make such code safe and interop correctly
p57299
aVUsing the lock statement and Manual/AutoResetEvents to signal between the threads
p57300
aVAnd if InvokeRequired would be false then I know I have a bug in that code
p57301
aVBecause invoking to the UI thread when the UI components are either not yet created or disposed is Very Bad
p57302
aVIt belongs in a Debug
p57303
aVAssert() call, at best
p57304
as(dp57305
g9
V17034
p57306
stp57307
a((dp57308
g2
(lp57309
VA FileLoadException is a pretty serious mishap
p57310
aVIt is raised when the JIT compiler tries to compile the code that you run in your thread
p57311
aVA try/catch pair cannot catch this exception because it is raised before the code starts executing
p57312
aVIn other words, it bombs before you enter the try block
p57313
aVGiven that this is a thread, you can't stop your program from crashing to the desktop
p57314
aVThe last gasp you have is AppDomain
p57315
aVUnhandledException, the e
p57316
aVExceptionObject's InnerException property tells you what is really going wrong
p57317
aVThis exception should otherwise always be easily fixable
p57318
aVIt is a configuration issue, the JIT compiler finds an assembly that has the wrong version number or is an old version of the assembly, something like that
p57319
aVIf you can't diagnose it from AppDomain
p57320
aVUnhandledException then the Fuslogvw
p57321
aVexe tool can show you how it is finding the wrong assembly
p57322
aVA full rebuild of your solution ought to be halfway to a fix
p57323
as(dp57324
g9
V17034
p57325
stp57326
a((dp57327
g2
(lp57328
VI don't see you doing anything wrong
p57329
aVI can't test this, don't have the setup right now
p57330
aVBounds is a bit tricky, there's a bunch of code behind it that ensures that the form can't be displayed off-screen
p57331
aVAs an alternative, you could set the Location property instead and override OnLoad() in SnippingTool to set the WindowState property
p57332
as(dp57333
g9
V17034
p57334
stp57335
a((dp57336
g2
(lp57337
VIt is quite unclear from your snippet, but I'll guess you want alternating colors
p57338
aVEven numbered items colored one way, odd numbered colored another way
p57339
aVYes, very effective as a reading guide when you have a large number of columns in the view
p57340
aVAnd yes, that's going to get mucked up when you sort the items
p57341
aVRight after sorting, you'll need a simple for loop that changes the BackColor property
p57342
aVCall this after sorting
p57343
aVOr after filling the ListView
p57344
aVI suck at colors, please pick your own
p57345
as(dp57346
g9
V17034
p57347
stp57348
a((dp57349
g2
(lp57350
VThis is incredibly fuzzy
p57351
aVThere is however a red flag though, you seem to be talking about UI as a starting point instead of the end result
p57352
aVThat's a classic trap in winforms, the designer is rather good and makes it way too easy to endlessly tinker with form layouts
p57353
aVYou forever keep adding and removing controls and event handlers as your ideas about how the program is supposed to work evolve
p57354
aVThis is backward and indeed a huge time sink
p57355
aVEffective design demands that you grab a piece of paper and focus on the structure of the program instead
p57356
aVThe starting point is the model, the M in the MVC pattern
p57357
aVAs you flesh out how the model should behave, it becomes obvious what kind of UI elements are necessary
p57358
aVAnd what commands should be available to the user
p57359
aVThe V emerges
p57360
aVInstead of jumping into the designer, sketch out what the view should look like
p57361
aVOn paper
p57362
aVMake a rough draft of an organized way to present the data
p57363
aVAnd what operations are available to the user to alter them
p57364
aVWhich selects the type of controls and the menus and buttons you'll need
p57365
aVOnce that congeals, you can very quickly design the form and add the C
p57366
aVThe event handlers that tie the UI to the model
p57367
aVThere's a very interesting tool available from Microsoft that helps you to avoid falling into this trap
p57368
aVI love the idea of it, it intentionally makes the UI design step imperfect
p57369
aVSo you don't spend all that time pushing pixels around instead of focusing on the design of your program
p57370
aVIt draws UI designs in a paper-and-pencil fashion, there are no straight lines
p57371
aVIncredibly effective not just for the programmer, also a "keep the customer focused and involved" fashion
p57372
aVSo that the customer doesn't fall in the same trap either, nagging about a control being off by one pixel
p57373
aVIt is called SketchFlow, link is here
p57374
aVIt is otherwise the exact same analogue of paper and pencil, but with a 'runs on my machine' flourish
p57375
as(dp57376
g9
V17034
p57377
stp57378
a((dp57379
g2
(lp57380
VThe only reason to use C++/CLI is for its support of mixing managed and native code
p57381
aVIf everything is managed then use C# or VB, if everything is native then use C or C++
p57382
aVOr whatever language you prefer
p57383
aVClearly avoiding mixing is nonsensical
p57384
aVThere is a small amount of overhead going from managed to unmanaged
p57385
aVThe C++/CLI compiler auto-generates a bit of machine code that pushes a 'cookie' on the stack, designed to prevent the garbage collector from blundering into unmanaged stack frames and mis-interpreting pointers on that frame as managed object references
p57386
aVCosts about 7 nanoseconds, give or take
p57387
as(dp57388
g9
V17034
p57389
stp57390
a((dp57391
g2
(lp57392
VMicrosoft
p57393
aVWin32
p57394
aVOpenFileDialog is the standard dialog that any application on Windows uses
p57395
aVYour user won't be surprised by its appearance when you use WPF in
p57396
aVNET 4
p57397
ag2512
aVThe dialog was altered in Vista
p57398
aVWPF in
p57399
aVNET 3
p57400
aV0 and 3
p57401
aV5 still used the legacy dialog but that was fixed in
p57402
aVNET 4
p57403
ag2512
aVI can only guess that you started this thread because you are seeing that old dialog
p57404
aVWhich probably means you're actually running a program that is targeting 3
p57405
ag2447
aVYes, the Winforms wrapper did get the upgrade and shows the Vista version
p57406
aVSystem
p57407
aVWindows
p57408
aVForms
p57409
aVOpenFileDialog class, you'll need to add a reference to System
p57410
aVWindows
p57411
aVForms
p57412
as(dp57413
g9
V17034
p57414
stp57415
a((dp57416
g2
(lp57417
VThese are not appropriate paths
p57418
aVYour app needs to go into c:\u005cprogram files\u005cmanufacturer\u005cproductname
p57419
aVYour temporary files need to go into Path
p57420
aVGetTempPath so that they'll get cleaned-up when your app crashes and forgets to clean up the temporary files
p57421
aVFind the directory at runtime
p57422
aVYour log files need to go into c:\u005cdocuments and settings\u005cusername\u005capplication data\u005c folder
p57423
aVFind the directory at runtime with Environment
p57424
aVGetFolderPath()
p57425
aVDon't store paths in app
p57426
aVexe
p57427
aVconfig
p57428
aVThis ensures your app will install and run on any Windows version
p57429
as(dp57430
g9
V17034
p57431
stp57432
a((dp57433
g2
(lp57434
VJeff Winn's response to your support request:
p57435
aVThe RasConnectionWatcher class is
p57436
aVmulti-threaded, as such you just need
p57437
aVto set the SynchronizingObject
p57438
aVproperty on the component
p57439
aVIf you have
p57440
aVthe component on a form, you can set
p57441
aVit to the form instance
p57442
aVIt will
p57443
aVhandle the thread synchronization for
p57444
aVyou automatically once it's been set
p57445
aVOr do it similar to this:
p57446
aVI'm guessing at the delegate type name
p57447
as(dp57448
g9
V17034
p57449
stp57450
a((dp57451
g2
(lp57452
VNo, MSI itself has no support for this
p57453
aVThe text for the controls is hard-baked into the "Control" table of the MSI file
p57454
aVYou can create a localized installer with a Setup project
p57455
aVIn the Properties window, change the Localization property
p57456
aVThis property is used to choose the corresponding
p57457
aVwid file from the common7\u005ctools\u005cdeployment\u005cvsddialogs\u005cxxxx subdirectory of the VS install directory
p57458
aVThese are pre-cooked msi files with localized dialogs
p57459
aVGetting the right language version of the resulting setup msi or exe to your user is your burden
p57460
aVMicrosoft does so by letting the user override the language on the download page
p57461
aVEnglish users are directed to a  page for example
p57462
as(dp57463
g9
V17034
p57464
stp57465
a((dp57466
g2
(lp57467
VIt's the exact opposite, this code was optimized by not using List<> or similar collection object
p57468
aVEverything that List does is inlined here
p57469
aVThe added advantage is that the locking is cheap (TrySetSlot uses Interlocked
p57470
aVCompareExchange) and saving the cost of dragging around a locking object
p57471
aVExplicitly inlining code like this rather than leaving it up to the JIT compiler isn't that common in the
p57472
aVNET framework
p57473
aVBut exceptions are made for low-level primitives like this
p57474
as(dp57475
g9
V17034
p57476
stp57477
a((dp57478
g2
(lp57479
VThis is impossible to diagnose without you posting code
p57480
aVBy default, Graphics
p57481
aVDrawString does not paint the background
p57482
aVThis sample form demonstrates this:
p57483
aVNote how the 'Overlap' string does not erase the 'Underneath' string
p57484
as(dp57485
g9
V17034
p57486
stp57487
a((dp57488
g2
(lp57489
VYou'll have bigger problems when you change the AutoScaleMode property
p57490
aVIncreasing the DPI also changes the system font size
p57491
aVNecessarily so, font sizes are expressed in points, 1/72 inch
p57492
aVThe fonts need to be bigger to get the same point size when the DPI increases
p57493
aVSince the controls don't get resized anymore, the text on, say, a button no longer fits
p57494
aVOne way to battle this is to change the font size on the controls proportionally
p57495
aVEasy if you let all the controls inherit the form font, just changing the form's Font property automatically updates the controls as well
p57496
aVThe clear disadvantage is that the user will have a harder time reading the text
p57497
aVThis especially gets bad when the DPI goes to 150 DPI and beyond, your UI just becomes unusable
p57498
aVYes, background images need to get scaled to fit the larger control or form
p57499
aVA pixel in the image now no longer maps one-to-one to a pixel on the screen
p57500
aVThe default Graphics
p57501
aVInterpolationMode value does a very decent job of filtering the image
p57502
aVBut it depends on the kind of image how well that turns out
p57503
aVA photo almost always scales very well
p57504
aVFinely detailed line art does not
p57505
aVPicking the right kind of image goes a long way to avoiding having to create separate ones
p57506
aVThis problem isn't going to go away until monitors start to have the kind of resolution a printer has
p57507
aVWe're still a long way from 600 DPI
p57508
as(dp57509
g9
V17034
p57510
stp57511
a((dp57512
g2
(lp57513
VSet the IntegralHeight property of the list boxes to False so that they are allowed to size themselves to fit the panel
p57514
as(dp57515
g9
V17034
p57516
stp57517
a((dp57518
g2
(lp57519
VA very obvious use case for Invoke() is when you need to invoke a method whose return value you need
p57520
aVOnly Invoke() can provide this for you, it returns Object, the method return value
p57521
aVA weaker one is where your worker thread is producing results at a rate far faster than the UI thread can keep up with
p57522
aVUsing Invoke() will throttle the worker and the invoke list cannot grow without bound
p57523
aVThis however is merely a band-aid for a bigger problem, it doesn't make sense to update the UI any faster than a human can perceive
p57524
aVOnce every 40 milliseconds looks smooth to the human eye
p57525
aVYou still want to use Invoke() if it takes the UI thread still too much time to process the result collection
p57526
aVClassic signs of having a problem like this is the UI thread freezing, not getting around to painting and responding to mouse and keyboard events because it is completely overwhelmed by invoke requests
p57527
aVAnd the UI thread staying unresponsive for a while after the worker completed running, busy working off the backlog
p57528
aVAnother case is locking requirements for the object(s) you pass to BeginInvoke()
p57529
aVNo locking is required when you use Invoke(), the UI thread and the worker thread cannot access the object at the same time
p57530
aVNot the case for BeginInvoke, it keeps motoring and if the thread keeps using the same object then you have to protect the object with a lock in both the UI thread and the worker
p57531
aVIf that locking prevents the worker from making any progress then you might as well use Invoke()
p57532
aVThis is all pretty uncommon, it takes a great deal of time for the main thread to start executing the delegate
p57533
aVAnd it is always a good idea to create a new instance of the object after you invoked so that there's no need for locking
p57534
as(dp57535
g9
V17034
p57536
stp57537
a((dp57538
g2
(lp57539
VUse CBitmap::GetBits() to get a raw pointer to the pixel data
p57540
aVYou can now directly party on the pixels without going through the expensive GetPixel() method
p57541
aVThere are a number of things you need to be careful with when you do this:
p57542
aVYou have to use CBitmap::GetPitch() to calculate the offset to the start of a line
p57543
aVThe pitch is not the same as the width
p57544
aVLines in the bitmap are stored upside-down
p57545
aVYou have to deal with the pixel format yourself
p57546
aVA 24bpp image stores 3 bytes per pixel
p57547
aVAn indexed format like 8bpp requires looking up the color in the color table
p57548
aV32bpp is the easy one, 4 bytes per pixel and the pitch is always the same as the width
p57549
as(dp57550
g9
V17034
p57551
stp57552
a((dp57553
g2
(lp57554
VThat line was designed to create confusion, as near as I can tell
p57555
aVUnlikely, COM servers announce the threading model they support in the registry with the ThreadingModel value
p57556
aVWhich is quite often "Apartment" (or missing, same thing)
p57557
aVCOM will create an STA thread to give it a safe home
p57558
aVOnly if it says "Both" or "Free" will the object be created on your thread and no marshaling will be needed
p57559
aVYes, that creates an STA apartment and the object will live on that thread, regardless of its ThreadingModel
p57560
aVNot calling CoInitialize will make any COM API fail, including attempts to create a COM object
p57561
as(dp57562
g9
V17034
p57563
stp57564
a((dp57565
g2
(lp57566
VYes, use BindingFlags
p57567
aVIgnoreCase:
p57568
aVBeware the possible, but unlikely, ambiguity
p57569
aVYou'd get an AmbiguousMatchException
p57570
as(dp57571
g9
V17034
p57572
stp57573
a((dp57574
g2
(lp57575
VThis took a bit over a second on a 442MB file on my otherwise poky Dell laptop:
p57576
aVVery hard to beat the raw perf of an array
p57577
as(dp57578
g9
V17034
p57579
stp57580
a((dp57581
g2
(lp57582
VYou'll have to pinvoke SHGetFolderPath yourself
p57583
aVGet the declaration and sample usage from pinvoke
p57584
aVnet
p57585
aVPass 14 for the 2nd argument
p57586
aVRequires at least Windows XP
p57587
as(dp57588
g9
V17034
p57589
stp57590
a((dp57591
g2
(lp57592
VUse SendInput()
p57593
as(dp57594
g9
V17034
p57595
stp57596
a((dp57597
g2
(lp57598
VThe form's Padding property has a somewhat mysterious effect on the snap location
p57599
aVSetting Padding
p57600
aVLeft to 1 makes it snap to X=4, 2 to 5 etc
p57601
aVNo idea how well that reproduces but might be good enough for what you're trying to do
p57602
aVDirectly editing the Location
p57603
aVX property would certainly work too
p57604
as(dp57605
g9
V17034
p57606
stp57607
a((dp57608
g2
(lp57609
VJust delete the unsafe keyword from the declaration
p57610
aVWindows API functions like this are not unsafe
p57611
aVYou can get rid if the awkward void* (IntPtr in managed code) like this:
p57612
aVAlso note that the first argument is a handle, an IntPtr, not an Int32
p57613
aVRequired to make this code work on 64-bit operating systems
p57614
as(dp57615
g9
V17034
p57616
stp57617
a((dp57618
g2
(lp57619
VToBinary() and ToFileTimeUtc() do not return the same value
p57620
aVToBinary provide a round-trip value, an Int64 that can preserve the properties of a DateTime
p57621
aVIt uses the same time base, January 1st of the year 0
p57622
aVThe value is always UTC
p57623
aVBit 62 is set for the extreme corner case where a local time near the 1/1/00 would be negative when converted to UTC (paying attention to detail here :))
p57624
aVBit 63 is set when the Kind is UTC
p57625
aVConvert the magic number to hex to see this
p57626
aVToFileTimeUtc() uses the same time base as Windows' FILETIME, January 1st of the year 1601
p57627
aVThe magic number is the number of ticks for 12am, 1/1/1601
p57628
as(dp57629
g9
V17034
p57630
stp57631
a((dp57632
g2
(lp57633
VAs long as this code runs on the main thread then there is no race
p57634
aVA BGW can only complete when the RunWorkerCompleted event handler finished running
p57635
aVThe handler cannot start running until the main thread re-enters the message loop
p57636
aVThere's another kind of race though, induced by the else clause
p57637
aVYou let the BGW start without a RunWorkerCompleted event handler
p57638
aVNow it can complete asynchronously since it won't be blocked
p57639
aVAlways subscribe the event, test e
p57640
aVCancelled to know what happened
p57641
as(dp57642
g9
V17034
p57643
stp57644
a((dp57645
g2
(lp57646
VYes, you need to fix this
p57647
aVRight now you are leaking the user controls instances, they won't get disposed automatically
p57648
aVNor does their finalizer take care of the job
p57649
aVAfter a while, your program will crash when it has consumed 10,000 window handles
p57650
aVMake it look similar to this:
p57651
as(dp57652
g9
V17034
p57653
stp57654
a((dp57655
g2
(lp57656
VTools + Options, Windows Forms Designer, General
p57657
aVEnsure that the AutoToolboxPopulate setting is True
p57658
as(dp57659
g9
V17034
p57660
stp57661
a((dp57662
g2
(lp57663
VThat would be one obvious place to lose a reference
p57664
aVThis method cannot actually return the buffer that was retrieved
p57665
aVYou would have to use the ref keyword to let it return the array
p57666
aVHard to believe that the real code looks anything like this, it just wouldn't work at all
p57667
aVThere are lots of other red flags, ConcurrentBag has thread associativity, stuff gets lost if you create consumer threads on the fly
p57668
aVYou can't sync a consumer with a producer with a ManualResetEvent, it can only count to 1
p57669
aVIn general, this optimization is inappropriate unless the buffers are bigger than 85KB
p57670
aVTrust the garbage collector, it does an excellent job that is very hard to improve upon
p57671
as(dp57672
g9
V17034
p57673
stp57674
a((dp57675
g2
(lp57676
VTree is the buzz-word here
p57677
aVImplement a tree where the nodes can have an arbitrary number of child nodes
p57678
aVThere's list
p57679
aVImplement an algorithm that iterates every node in the tree without using recursion
p57680
aVThere's stack
p57681
as(dp57682
g9
V17034
p57683
stp57684
a((dp57685
g2
(lp57686
VYou could just add a property to your component, allows the client to set a form reference that you can use to call its BeginInvoke() method
p57687
aVThat can be done automatically as well, preferable so nobody can forget
p57688
aVIt requires a bit of design time magic that's fairly impenetrable
p57689
aVI didn't come up with this by myself, I got it from the ErrorProvider component
p57690
aVTrusted source and all that
p57691
aVPaste this into your component source code:
p57692
aVThe designer automatically sets the ParentForm property when the user drops your component on a form
p57693
aVUse ParentForm
p57694
aVBeginInvoke()
p57695
as(dp57696
g9
V17034
p57697
stp57698
a((dp57699
g2
(lp57700
VTelnet is a very simple protocol
p57701
aVSome wonky stuff to negotiate the terminal type but I'm sure your robot doesn't care where the cursor ends up
p57702
aVJust use a socket to open a TCP/IP connection on port 23 and send the command strings, terminated with a '\u005cn'
p57703
as(dp57704
g9
V17034
p57705
stp57706
a((dp57707
g2
(lp57708
VThe problem here is that you not just changed the operating system, you also changed your development tools
p57709
aVIt should still work if you run VB6 on Win7
p57710
aVBut Visual Studio 2008 supports VB
p57711
aVNET, a very different language from VB6
p57712
aVIt only supports 'true' type libraries, the ones that COM uses
p57713
aVCalling an exported function from a DLL requires using the P/Invoke marshaller built into
p57714
aVNET
p57715
aVCheck out DllImportAttribute and the VB
p57716
aVNET Declare statement in the MSDN Library
p57717
aVThe declaration for that function ought to resemble this:
p57718
aVNo need to register a type library with this
p57719
aVWriting a managed class wrapper in the C++/CLI language would be another approach
p57720
as(dp57721
g9
V17034
p57722
stp57723
a((dp57724
g2
(lp57725
VIt is described very well in the C# Language Specification, chapter 7
p57726
ag28089
aV6 "Reference type equality operators":
p57727
aVThe predefined reference type equality
p57728
aVoperators are:
p57729
aVbool operator ==(object x, object y);
p57730
aVbool operator
p57731
aV=(object x,
p57732
aVobject y);
p57733
aVThe operators return the
p57734
aVresult of comparing the two references
p57735
aVfor equality or non-equality
p57736
aVSince
p57737
aVthe predefined reference type equality
p57738
aVoperators accept operands of type
p57739
aVobject, they apply to all types that
p57740
aVdo not declare applicable operator ==
p57741
aVand operator
p57742
aV= members
p57743
aVConversely,
p57744
aVany applicable user-defined equality
p57745
aVoperators effectively hide the
p57746
aVpredefined reference type equality
p57747
aVoperators
p57748
aVThe predefined reference
p57749
aVtype equality operators require one of
p57750
aVthe following:
p57751
aV\u2022 Both operands are
p57752
aVreference-type values or the literal
p57753
aVnull
p57754
aVFurthermore, a standard implicit
p57755
aVconversion (6
p57756
ag2586
aV1) exists from the
p57757
aVtype of either operand to the type of
p57758
aVthe other operand
p57759
aV\u2022    One operand is a
p57760
aVvalue of type T where T is a
p57761
aVtype-parameter and the other operand
p57762
aVis the literal null
p57763
aVFurthermore T
p57764
aVdoes not have the value type
p57765
aVconstraint
p57766
aVUnless one of these
p57767
aVconditions are true, a compile-time
p57768
aVerror occurs
p57769
aVNotable implications of
p57770
aVthese rules are:
p57771
aV\u2022 It is a
p57772
aVcompile-time error to use the
p57773
aVpredefined reference type equality
p57774
aVoperators to compare two references
p57775
aVthat are known to be different at
p57776
aVcompile-time
p57777
aVFor example, if the
p57778
aVcompile-time types of the operands are
p57779
aVtwo class types A and B, and if
p57780
aVneither A nor B derives from the
p57781
aVother, then it would be impossible for
p57782
aVthe two operands to reference the same
p57783
aVobject
p57784
aVThus, the operation is
p57785
aVconsidered a compile-time error
p57786
aVThe last paragraph is why you get the error
p57787
as(dp57788
g9
V17034
p57789
stp57790
a((dp57791
g2
(lp57792
VThe  header contains a handy wrapper for VARIANT
p57793
aVTakes care of proper initialization and cleanup
p57794
aVThere isn't anything in your code snippet that would help me help you figuring out how to obtain the COM interface pointer
p57795
aVStart a new question about that if you have trouble
p57796
as(dp57797
g9
V17034
p57798
stp57799
a((dp57800
g2
(lp57801
VUse a GraphicsPath instead
p57802
aVYou can draw it with Graphics
p57803
aVFillPath, like this:
p57804
as(dp57805
g9
V17034
p57806
stp57807
a((dp57808
g2
(lp57809
VYes, they implement OpenMP version 2
p57810
aVStart reading here
p57811
as(dp57812
g9
V17034
p57813
stp57814
a((dp57815
g2
(lp57816
VThere are not many good reasons this would fail, especially the regsvr32 step
p57817
aVRun dumpbin /exports on that dll
p57818
aVIf you don't see DllRegisterServer then you've got a corrupt install
p57819
aVIt should have more side-effects, you wouldn't be able to build C/C++ projects anymore
p57820
aVOne standard failure mode is running this on a 64-bit operating system
p57821
aVThis is 32-bit unmanaged code, you would indeed get the 'class not registered' exception
p57822
aVProject + Properties, Build tab, change Platform Target to x86
p57823
as(dp57824
g9
V17034
p57825
stp57826
a((dp57827
g2
(lp57828
VIt is easy to implement yourself, Unicode never messed with the ASCII codes:
p57829
as(dp57830
g9
V17034
p57831
stp57832
a((dp57833
g2
(lp57834
VThey are equivalent
p57835
aVThis is determined by the operator precedence rules in the C# language, chapter 7
p57836
ag2584
aV1 in the C# Language Specification:
p57837
aVThe  operator is at the top in this list, the cast operator is the 2nd in the list
p57838
aVThe  operator "wins"
p57839
aVYou will have use parentheses if you need the cast because Property1 is a property of the MyType class:
p57840
as(dp57841
g9
V17034
p57842
stp57843
a((dp57844
g2
(lp57845
VBizarre
p57846
aVLooking with the debugger, the first non-null value on the thread's stack is the value of the argument, the 4th argument to CreateThread
p57847
aVWhich gets handed to you on a silver platter when you write the thread procedure like this:
p57848
aVNot sure how that's related to "kernel32
p57849
aVCtrlRoutine" unless this is a thread used in a service
p57850
as(dp57851
g9
V17034
p57852
stp57853
a((dp57854
g2
(lp57855
VThat blog post is of very questionable value
p57856
aVIt is impossible to make this work in the general case
p57857
aVIt only works because:
p57858
aVthe CLR is known to be available
p57859
aVthe address of the method to execute is known
p57860
aVit doesn't require injecting a DLL in the target process
p57861
aVWindows security is unlikely to stop this particular approach
p57862
aVWhich it achieves by handing the client process everything it needs get that thread started
p57863
aVThe far more typical usage of CreateRemoteThread is to do so when the target process does not cooperate
p57864
aVIn other words, you don't have the CLR, you have to inject a DLL with the code, that code can't be managed, you have to deal with the DLL getting relocated and Windows will balk at all this
p57865
aVAnyhoo, addressing your question: you don't check for any errors so you don't know what is going wrong
p57866
aVMake sure your [DllImport] declarations have SetLastError=true, check the return value for failure (IntPtr
p57867
aVZero here) and use Marshal
p57868
aVGetLastWin32Error() to retrieve the error code
p57869
as(dp57870
g9
V17034
p57871
stp57872
a((dp57873
g2
(lp57874
VYou cannot get this out of Visual Studio
p57875
aVIts syntax highlighting is based on lexical analysis
p57876
aVWhich detects simple programming elements, keyword, identifier, comment, number, string literal, preprocessor directive, etc
p57877
aVSelectively highlighting identifiers is a much harder problem, it requires parsing the text
p57878
aVNot only is that slow, affecting the text rendering speed, it is also very difficult to do since the text is almost always in an un-parsable state as you're editing the code
p57879
aVThe universal plug-in for the C++ IDE is Visual Assist from Whole Tomato
p57880
aVBut it certainly isn't free, these kind of add-ons never are
p57881
aVNo idea to what degree they support C++/CLI, you'd have to try with the trial download
p57882
as(dp57883
g9
V17034
p57884
stp57885
a((dp57886
g2
(lp57887
VYou always have to check for errors when you use Win32 API functions
p57888
aVGetAltTabInfo returns BOOL, call GetLastError() when it returns FALSE:
p57889
aVI'll think you'll see error 1400, "Invalid window handle"
p57890
aVOn my machine, none of the window handles enumerated by EnumWindows() are accepted
p57891
aVI'd draw the conclusion that this API is no longer usable when you've got Aero enabled
p57892
aVI can't find independent confirmation for this
p57893
as(dp57894
g9
V17034
p57895
stp57896
a((dp57897
g2
(lp57898
VYou have to use a WPF TextBox to make spell checking work
p57899
aVYou can embed one in a Windows Forms form with the ElementHost control
p57900
aVIt works pretty similar to a UserControl
p57901
aVHere's a control that you can drop straight from the toolbox
p57902
aVTo get started, you need Project + Add Reference and select WindowsFormsIntegration, System
p57903
aVDesign and the WPF assemblies PresentationCore, PresentationFramework and WindowsBase
p57904
aVAdd a new class to your project and paste the code shown below
p57905
aVCompile
p57906
aVDrop the SpellBox control from the top of the toolbox onto a form
p57907
aVIt supports the TextChanged event and the Multiline and WordWrap properties
p57908
aVThere's a nagging problem with the Font, there is no easy way to map a WF Font to the WPF font properties
p57909
aVThe easiest workaround for that is to set the form's Font to "Segoe UI", the default for WPF
p57910
aVBy popular demand, a VB
p57911
aVNET version of this code that avoids the lambda:
p57912
as(dp57913
g9
V17034
p57914
stp57915
a((dp57916
g2
(lp57917
VYou already got a proxy on thread A since you asked for an out-of-process server
p57918
aVWhat happens next depends on the kind of apartment that thread A lives in, the argument to CoInitializeEx()
p57919
aVIf it is MTA you will definitely get the same proxy in thread B, assuming it is MTA as well
p57920
aVThe added reference count should keep it alive if Thread A exits
p57921
aVIf it is STA then I'm not 100% sure but think you ought to get a new one
p57922
aVEasy to test btw, just use the one from thread A and you'll get RPC_E_WRONGTHREAD if a new one would have to be created
p57923
aVI don't have a great explanation for why the thread A exit kills the proxy for thread B
p57924
aVUnless you call IGlobalInterfaceTable::RevokeInterfaceFromGlobal()
p57925
aVWhich you'd normally do
p57926
as(dp57927
g9
V17034
p57928
stp57929
a((dp57930
g2
(lp57931
VThis is more than just a color change
p57932
aVThe line is entirely overwritten with garbage
p57933
aVMust be some other misbehaving add-in
p57934
aVVerify this by running devenv
p57935
aVexe with the /SafeMode command line option
p57936
as(dp57937
g9
V17034
p57938
stp57939
a((dp57940
g2
(lp57941
VEvery form has an ActiveControl, the control that will get the focus when the form is activated
p57942
aVTo get the active form you should use the static Form
p57943
aVActiveForm property
p57944
as(dp57945
g9
V17034
p57946
stp57947
a((dp57948
g2
(lp57949
VUse the debugger
p57950
aVIf you test this from C# then Project + Properties, Debug, tick "Enabled unmanaged code debugging"
p57951
aVSetting up the symbol server in Tools + Options, Debugging, Symbols is strongly recommended
p57952
aVRun
p57953
aVWhen it hangs use Debug + Break All
p57954
aVDebug + Windows + Threads and double-click the thread that is supposed to be doing the job
p57955
aVDebug + Windows + Call stack to see what is going on
p57956
aVPost the stack trace in your question if you can't figure it out
p57957
aVAnything you see in the Output window and the Visual Studio status bar is relevant too
p57958
as(dp57959
g9
V17034
p57960
stp57961
a((dp57962
g2
(lp57963
VLocalLock() returns the pointer
p57964
aVBut this is 18 year old silliness, just use
p57965
aVIgnoring the ~7 year old silliness of still using TCHAR for a moment
p57966
aVYour printf() statement needs work, depending on whether or not you are compiling with Unicode
p57967
aV%ls if you do
p57968
aVI'm guessing that's your real problem, use wprintf()
p57969
as(dp57970
g9
V17034
p57971
stp57972
a((dp57973
g2
(lp57974
VThe current directory of the process as maintained by Windows (Environment
p57975
aVCurrentDirectory) is not affected by the AppDomainSetup
p57976
aVIt only affects where the CLR will look for assemblies
p57977
aVChanging CurrentDirectory will change it process-wide, surely that's not what you want
p57978
aVWork with full path names, like you do in your snippet
p57979
as(dp57980
g9
V17034
p57981
stp57982
a((dp57983
g2
(lp57984
VFrom the MSDN Library article:
p57985
aVImportant
p57986
aVThis attribute should not be used on
p57987
aVASP
p57988
aVNET unit tests, that is, any test
p57989
aVwith [HostType("ASP
p57990
aVNET")] attribute
p57991
aVBecause of the stateless nature of IIS
p57992
aVand ASP
p57993
aVNET, a method decorated with
p57994
aVthis attribute might be called more
p57995
aVthan once per test run
p57996
aVThere are few knobs you can tweak in test runner
p57997
aVI would just punt the problem with a counter:
p57998
as(dp57999
g9
V17034
p58000
stp58001
a((dp58002
g2
(lp58003
VThe
p58004
aVNET bootstrapper automatically installs both the 32-bit and the 64-bit versions of the
p58005
aVNET framework on a machine with a 64-bit operating system
p58006
aVNothing you have to do to tell it to do so
p58007
aVAvoid distributing the
p58008
aVNET framework yourself, you'll have a hard time keeping up with the security updates
p58009
aVJust tick the option in the Setup project's Prerequisites to get the bootstrapper, that will download the latest and greatest during install on the target machine, if necessary
p58010
aVThe option is automatically ticked when you create an installer for a managed program
p58011
aVThere is no 64-bit version of VS2010, no need to worry about that
p58012
aVThe Platform Target setting in the Project + Properties, Build tab for your EXE project is relevant
p58013
aVIt defaults to x86 in a project that was created from scratch in VS2010
p58014
aVThere is no great reason to change it to AnyCPU for the Release build unless you need the extra virtual memory space that a 64-bit process can provide
p58015
aVIf you do change it then do make sure to test it thoroughly
p58016
aVI know you've been tinkering with unmanaged COM servers, x86 is probably a hard requirement
p58017
as(dp58018
g9
V17034
p58019
stp58020
a((dp58021
g2
(lp58022
VIt isn't impossible, you could use Control Panel + System and add the environment variables set by the
p58023
aVcmd file
p58024
aVDoing so has several troublesome consequences though:
p58025
aVthe build tools will only work on your machine, you'll have a hard time getting a build going on your colleagues' machine or a build server
p58026
aVEspecially since you no longer try to keep it compatible
p58027
aVyou'll have a very hard time switching between a debug and release build or a x86 and a x64 build
p58028
aVyou'll have a very hard time when you start using a new release of the SDK, especially when you temporarily need to switch back and forth between the old and the new release
p58029
aVI'm pretty sure you'll deeply regret doing this, eventually
p58030
as(dp58031
g9
V17034
p58032
stp58033
a((dp58034
g2
(lp58035
VYes, this certainly wasn't made to be extensible
p58036
aVHard to see how you could get anywhere at all unless you create your own shell namespace extension
p58037
aVSo that it is viewable in a shell window
p58038
aVDoing so is quite brutal in managed code, the shell's COM interfaces derived from IUnknown are very hard to use
p58039
aVWhich is what the wrapper classes in the API code pack is doing to get a browser window in a managed program
p58040
aVCreating the shell namespace extension is the greater solution, your custom files would be visible in a regular Explorer window as well
p58041
aVBut write that kind of code in C++, both because it is so much easier to get the COM code going and to avoid injecting the CLR in any program that uses a File + Open dialog box
p58042
aVAlthough that is now technically supported by
p58043
aVNET 4
p58044
ag2512
as(dp58045
g9
V17034
p58046
stp58047
a((dp58048
g2
(lp58049
VIt is one of the leaks in Windows Forms' debugging logic that tries to detect you using controls in a thread-unsafe manner
p58050
aVIt cannot see you assigning the DataSource property in a thread other than the UI thread
p58051
aVUse BackgroundWorker to implement your threaded logic
p58052
aVAnd use its RunworkerCompleted event handler to set the grid's DataSource property
p58053
aVOr use Control
p58054
aVInvoke if you prefer to keep your existing threading code
p58055
as(dp58056
g9
V17034
p58057
stp58058
a((dp58059
g2
(lp58060
VHmm, this is all pretty odd
p58061
aVRenaming the file to
p58062
aVexe if it actually is an executable file seems the lower paint point
p58063
aVTry cmd
p58064
aVexe /c start /wait d:/my/path/file
p58065
aVbin args
p58066
as(dp58067
g9
V17034
p58068
stp58069
a((dp58070
g2
(lp58071
VThe Web Service wizard is still available
p58072
aVRight-click the project, Add Service Reference, Advanced, Add Web Reference
p58073
aVWsdl
p58074
aVexe is available in c:\u005cprogram files\u005cmicrosoft sdks\u005cwindows\u005cv7
p58075
aV0a\u005cbin
p58076
as(dp58077
g9
V17034
p58078
stp58079
a((dp58080
g2
(lp58081
VI think I'd just use a StreamReader, constructed with the right encoding and pass that to the XmlReader
p58082
aVCreate(TextStream) method:
p58083
as(dp58084
g9
V17034
p58085
stp58086
a((dp58087
g2
(lp58088
VNo, this isn't a good idea
p58089
aVThe code is much too brittle
p58090
aVCatch this earlier
p58091
aVAt the user interface level for example, whatever code you have that sets the setting value
p58092
aVIt can fire the event and you'll know exactly what is getting modified
p58093
aVOr make an intermediate helper class
p58094
as(dp58095
g9
V17034
p58096
stp58097
a((dp58098
g2
(lp58099
VThis is not fixable as-is, you cannot control the keyboard state
p58100
aVThe receiving app will use GetKeyState() to check if the Shift, Ctrl or Alt key is down
p58101
aVSetKeyState() doesn't work, it only changes the keyboard state of your process, not the process that gets the messages
p58102
aVUse SendInput() instead
p58103
aVA window in the target process must have the focus
p58104
as(dp58105
g9
V17034
p58106
stp58107
a((dp58108
g2
(lp58109
VLook at individual nodes in the collection with categoryNode[0], changing the index
p58110
aVOr drill down into the private owner property
p58111
aVIts children field gives you a list of all the nodes
p58112
aVOr if Linq is in scope, you can type
p58113
as(dp58114
g9
V17034
p58115
stp58116
a((dp58117
g2
(lp58118
VYour build task is trying to start Internet Explorer
p58119
aVYes, it needs an STA thread, and no, you can't get one out of MSBuild
p58120
aVexe
p58121
aVHow you got from SmtpClient to Internet Explorer is completely unclear to me
p58122
aVUsing an HTML body or some kind an attachment sounds all pretty remote to me
p58123
aVHaving your build task start a program that does the job instead at least ought to give you a better diagnostic
p58124
as(dp58125
g9
V17034
p58126
stp58127
a((dp58128
g2
(lp58129
VThis dates back to very early versions of Microsoft Basic
p58130
aVThese type characters let you both set the type of an identifier and a literal:
p58131
as(dp58132
g9
V17034
p58133
stp58134
a((dp58135
g2
(lp58136
VThe C# compiler itself doesn't alter the emitted IL a great deal in the Release build
p58137
aVNotable is that it no longer emits the NOP opcodes that allow you to set a breakpoint on a curly brace
p58138
aVThe big one is the optimizer that's built into the JIT compiler
p58139
aVI know it makes the following optimizations:
p58140
aVMethod inlining
p58141
aVA method call is replaced by the injecting the code of the method
p58142
aVThis is a big one, it makes property accessors essentially free
p58143
aVCPU register allocation
p58144
aVLocal variables and method arguments can stay stored in a CPU register without ever (or less frequently) being stored back to the stack frame
p58145
aVThis is a big one, notable for making debugging optimized code so difficult
p58146
aVAnd giving the volatile keyword a meaning
p58147
aVArray index checking elimination
p58148
aVAn important optimization when working with arrays (all
p58149
aVNET collection classes use an array internally)
p58150
aVWhen the JIT compiler can verify that a loop never indexes an array out of bounds then it will eliminate the index check
p58151
aVBig one
p58152
aVLoop unrolling
p58153
aVShort loops (up to 4) with small bodies are eliminated by repeating the code in the loop body
p58154
aVAvoids the branch misprediction penalty
p58155
aVDead code elimination
p58156
aVA statement like if (false) { /
p58157
aV/ } gets completely eliminated
p58158
aVThis can occur due to constant folding and inlining
p58159
aVOther cases is where the JIT compiler can determine that the code has no possible side-effect
p58160
aVThis optimization is what makes profiling code so tricky
p58161
aVCode hoisting
p58162
aVCode inside a loop that is not affected by the loop can be moved out of the loop
p58163
aVCommon sub-expression elimination
p58164
aVx = y + 4; z = y + 4; becomes z = x;
p58165
aVConstant folding
p58166
aVx = 1 + 2; becomes x = 3;  This simple example is caught early by the compiler, but happens at JIT time when other optimizations make this possible
p58167
aVCopy propagation
p58168
aVx = a; y = x; becomes y = a;  This helps the register allocator make better decisions
p58169
aVIt is a big deal in the x86 jitter because it has so few registers to work with
p58170
aVHaving it select the right ones is critical to perf
p58171
aVThese are very important optimizations that can make a great deal of difference when, for example, you profile the Debug build of your app and compare it to the Release build
p58172
aVThat only really matters though when the code is on your critical path, the 5 to 10% of the code you write that actually affects the perf of your program
p58173
aVThe JIT optimizer isn't smart enough to know up front what is critical, it can only apply the "turn it to eleven" dial for all the code
p58174
aVThe effective result of these optimizations on your program's execution time is often affected by code that runs elsewhere
p58175
aVReading a file, executing a dbase query, etc
p58176
aVMaking the work the JIT optimizer does completely invisible
p58177
aVIt doesn't mind though :)
p58178
aVThe JIT optimizer is pretty reliable code, mostly because it has been put to the test millions of times
p58179
aVIt is extremely rare to have problems in the Release build version of your program
p58180
aVIt does happen however
p58181
aVBoth the x64 and the x86 jitters have had problems with structs
p58182
aVThe x86 jitter has trouble with floating point consistency, producing subtly different results when the intermediates of a floating point calculation are kept in a FPU register at 80-bit precision instead of getting truncated when flushed to memory
p58183
as(dp58184
g9
V17034
p58185
stp58186
a((dp58187
g2
(lp58188
VYou tagged this [vb
p58189
aVnet], you cannot ship debug builds or programs that use WithEvents
p58190
aVThere's a known and afaik unsolved memory leak for WeakReference instances if there is no debugger attached
p58191
aVThey are used to support Edit+Continue
p58192
aVFirst thing you can do is ship the
p58193
aVpdb files along with your apps
p58194
aVIn the C# IDE use Project + Properties, Build tab, Advanced, change Debug Info to "Full"
p58195
aVYou'll get line number info in the exception stack trace
p58196
aVYou cannot completely trust the line number, the JIT optimizer will move code around to make it execute faster
p58197
aVAnd inline short functions like property getters
p58198
aVYou can add an yourapp
p58199
aVini file in the same directory as the executable that disables the JIT optimizer
p58200
as(dp58201
g9
V17034
p58202
stp58203
a((dp58204
g2
(lp58205
VIt doesn't have anything to do with your code
p58206
aVThe network driver is having problems, look in the Windows Event log for the reason why
p58207
aVUltimately it needs to be the LAN admin that has to tackle the problem
p58208
aVHe can post to serverfault
p58209
aVcom for help
p58210
as(dp58211
g9
V17034
p58212
stp58213
a((dp58214
g2
(lp58215
VIt's possible with the Win32 API
p58216
aVYou need GetDlgItem() to get a handle to button you are looking for
p58217
aVUse Spy++ to find the control ID
p58218
aVAn example of the kind of code you need is available in my post in this thread
p58219
aVThat example is for an in-process dialog, it would work out-of-process as well
p58220
aVBeware that your code is liable to break on the next version of Windows
p58221
as(dp58222
g9
V17034
p58223
stp58224
a((dp58225
g2
(lp58226
VThe compiler will generate IL that's equivalent to version 2 of your code, a virtual stack location is needed to store the object reference
p58227
aVThe JIT optimizer will generate machine code that's equivalent to version 1 of your code, the reference is stored in a CPU register
p58228
aVIn other words, it doesn't matter
p58229
aVYou get the exact same machine code at runtime
p58230
as(dp58231
g9
V17034
p58232
stp58233
a((dp58234
g2
(lp58235
VDon't use a post build event
p58236
aVAfter installing the tool, an MSBuild task was added that runs the minifier automatically for a
p58237
aVjs file in your project
p58238
aVYou need a bit of minor surgery to the project file
p58239
aVThe details are explained in this blog post
p58240
as(dp58241
g9
V17034
p58242
stp58243
a((dp58244
g2
(lp58245
VThis doesn't make any sense
p58246
aVYou can only pin managed objects, the return value of PDF_LoadDoc() sure doesn't look like a managed object to me
p58247
aVSame goes for result, it is not a managed , just a plain vanilla C array that gets allocated on the stack frame
p58248
aVUnfortunately, pin_ptr<> doesn't complain about this
p58249
aVThe result array could only get 'empty' if code is stomping the stack frame
p58250
aVWhich you can diagnose by setting a data breakpoint on the first element
p58251
aVFwiw, SystemStringToCStr() looks like a candidate
p58252
aVThis cannot work without releasing the buffer for the native string somewhere
p58253
aVAnother candidate is the PDF API function declarations
p58254
aVPay attention to the value of the ESP register and make sure it doesn't change
p58255
aVIf it does, the stack is get imbalanced because you don't have the proper calling convention
p58256
aVWhich is usually __stdcall for DLL exports
p58257
as(dp58258
g9
V17034
p58259
stp58260
a((dp58261
g2
(lp58262
VNo, this is supported
p58263
aVSilly example I tried: Command Arguments = $(CharacterSet)
p58264
aVGot "Unicode" at runtime for argv[1] inside main()
p58265
aVSelect "Command Arguments", click on the dropdown arrow, Edit
p58266
aVClick Macros to see what macros are available
p58267
as(dp58268
g9
V17034
p58269
stp58270
a((dp58271
g2
(lp58272
VAs long as it is a managed program then, yes, you can run it in its own AppDomain
p58273
aVYou'll need a thread to run the code, AppDomain
p58274
aVExecuteAssembly() is the handy one that automatically starts running the Main() method of that program
p58275
aVHere's an example that uses two console mode applications:
p58276
aVAnd the one that's ran 10 times:
p58277
aVOne thing I didn't count on and stuck under a table a bit, the AppDomainSetup
p58278
aVApplicationBase property didn't work as I expected
p58279
aVI had to pass the full path of the EXE to ExecuteAssembly() instead of just passing "consoleapplication2
p58280
aVexe"
p58281
aVThat was odd
p58282
as(dp58283
g9
V17034
p58284
stp58285
a((dp58286
g2
(lp58287
VThis is your nemesis:
p58288
aVIt is internal, you cannot override it
p58289
aVYou can revive your approach of using a Form by fixing the focus stealing behavior
p58290
aVPaste this into the form class:
p58291
as(dp58292
g9
V17034
p58293
stp58294
a((dp58295
g2
(lp58296
VYou are not setting the process
p58297
aVStartInfo
p58298
aVWorkingDirectory property
p58299
aVThere's plenty of poorly written software out there that assumes the working directory will be the directory in which the EXE is stored
p58300
aVAt least add this line:
p58301
aVThe exception is however rather strange
p58302
aVI'd definitely recommend you tell the customer to update their anti-malware tools
p58303
as(dp58304
g9
V17034
p58305
stp58306
a((dp58307
g2
(lp58308
VStart a new Windows Forms project
p58309
aVProject + Add Reference, select Microsoft
p58310
aVVisualBasic
p58311
aVProject + Add New Item, select Class
p58312
aVDelete what's there then paste the code
p58313
aVCompile
p58314
aVDrop the new control from the top of the toolbox onto the form
p58315
aVThere's a bug in the code, you'll get the drives displayed twice when you press F5
p58316
aVAlter the code and make it look like this:
p58317
as(dp58318
g9
V17034
p58319
stp58320
a((dp58321
g2
(lp58322
VBitmaps have their scanlines stored up-side down
p58323
aVYou'll have to compensate for this when you directly write their pixels
p58324
as(dp58325
g9
V17034
p58326
stp58327
a((dp58328
g2
(lp58329
VIt is because you told the ToolTip control to show the tip for the entire TreeView, not just the node
p58330
aVConsider the TreeNode
p58331
aVToolTipText property instead
p58332
as(dp58333
g9
V17034
p58334
stp58335
a((dp58336
g2
(lp58337
VP7 and P8 are the important ones to find out where the P9 exception was raised
p58338
aVUse P4 to know what assembly to look for
p58339
aVRun ildasm
p58340
aVexe and open that assembly
p58341
aVFile + Dump, tick the "Token values" checkbox, OK and save the
p58342
aVil file somewhere
p58343
aVOpen the file in a text editor
p58344
aVP7 gives you the method token, it starts with 0x06, producing token value "06000129"
p58345
aVSearch for:
p58346
aVWhich gives you the method name, look up from there to find the
p58347
aVclass, that gives you the class name
p58348
aVP8 gives you the IL offset
p58349
aVFrom the found
p58350
aVmethod, look for IL_0050 for the instruction that raised the exception
p58351
aVMapping it back to your source code is a bit tricky but you'll probably figure it out
p58352
aVUse Reflector if necessary
p58353
aVIn general, write an event handler for  to avoid the pain of reverse-engineering these Watson crash buckets
p58354
aVLog the value of  to get both the exception message and a stack trace
p58355
as(dp58356
g9
V17034
p58357
stp58358
a((dp58359
g2
(lp58360
VYour 3rd snippet is the correct one, not sure why you have trouble
p58361
aVHaving the GetLastError() return value would be valuable here
p58362
aVDo note however that the 2nd argument of CreateProcess is an LPTSTR, not an LPCTSTR
p58363
aVIn other words, Windows can write back to the string
p58364
aVPretty creepy, isn't it
p58365
aVEnough reason perhaps to use ShellExecuteEx() instead
p58366
as(dp58367
g9
V17034
p58368
stp58369
a((dp58370
g2
(lp58371
VThere are not a lot of video adapters around these days that still support this
p58372
aVRun cmd
p58373
aVexe and press Alt+Enter
p58374
aVIf you get a message box that says "This system does not support fullscreen mode" then you're done
p58375
aVIf it does switch to full screen then you can use SetConsoleDisplayMode() in your main() function
p58376
aVOf course, you don't know what your customer's machine is like, best not to pursue this
p58377
as(dp58378
g9
V17034
p58379
stp58380
a((dp58381
g2
(lp58382
VNot much to go on but you never mentioned registering the assembly
p58383
aVThe C++ IDE doesn't have the "Register for COM interop" option
p58384
aVFrom the Visual Studio Command Prompt, run Regasm
p58385
aVexe on the assembly to get it registered
p58386
aVYou need the /codebase option if you don't put the assembly in the GAC
p58387
aVAnd the /tlb option generates the type library, making tlbexp
p58388
aVexe unnecessary
p58389
as(dp58390
g9
V17034
p58391
stp58392
a((dp58393
g2
(lp58394
VYou initialize the cond_rwlock and start_condition variables too late
p58395
aVMove the code up, before you start the threads
p58396
aVA thread is likely to start running right away, especially on a multi-core machine
p58397
aVAnd test the return values of api functions
p58398
aVYou don't know why it doesn't work because you never check for failure
p58399
as(dp58400
g9
V17034
p58401
stp58402
a((dp58403
g2
(lp58404
s(dp58405
g9
V17034
p58406
stp58407
a((dp58408
g2
(lp58409
VThere's really only one bug that I see, the compiler should generate an error for this
p58410
aVShouldn't be hard to implement
p58411
aVYou can report it at connect
p58412
aVmicrosoft
p58413
aVcom
p58414
as(dp58415
g9
V17034
p58416
stp58417
a((dp58418
g2
(lp58419
VWork from the assumption that this is real
p58420
aVThe installer might have noticed it was started from a removable drive and copied itself to the hard disk
p58421
aVLaunched that copy and quit
p58422
aVThis avoids trouble when the user pops out the media, that produces a very low-level paging fault that the process itself cannot catch
p58423
aVThe Windows dialog isn't great and may well run counter to the installer's request to insert the next disk
p58424
aVVerify this guess by comparing the process ID of the process you started vs the one you see running in Taskmgr
p58425
aVexe
p58426
aVReliably fixing this ought to be quite a headache
p58427
as(dp58428
g9
V17034
p58429
stp58430
a((dp58431
g2
(lp58432
VA type is strongly bound to the assembly in which it is defined
p58433
aVA namespace is not, it can appear in multiple assemblies
p58434
aVSystem
p58435
aVConfiguration for example
p58436
aVLet's assume for a moment that the metadata format for an assembly would be changed (-1 billion points) to store attributes for a namespace
p58437
aVThose attributes would still have to be stored in an assembly because that's the storage unit for metadata
p58438
aVNow you have to deal with the possibility that the CLR loads another assembly and finds the same namespace but with conflicting attributes
p58439
aVHow could it possibly resolve that
p58440
aVMore seriously, how would you prevent external code from simply using the same namespace and attributes to suddenly get access to implementation details that were meant to be private
p58441
aVThis completely destroys the value of having the internal keyword
p58442
as(dp58443
g9
V17034
p58444
stp58445
a((dp58446
g2
(lp58447
VThis is an inevitable consequence of the dramatic difference between the device resolution of a printer vs a monitor
p58448
aVA printer typically can print with a resolution of 600 dots per inch
p58449
aVA monitor is typically set to 96 DPI
p58450
aVSo when you print an image that's razor sharp on a monitor, each pixel of the image requires printing a blob of 6 x 6
p58451
aVShort from the blockiness this produces, anything that's drawn on screen with anti-aliasing will get those anti-aliasing pixels drawn 6 times larger as well
p58452
aVCompletely ruining the effect
p58453
aVThis is especially noticeable with any text that's drawn with ClearType anti-aliasing
p58454
aVThe red and blue fringes become very noticeable on paper
p58455
aVYou can partly solve this by drawing the image one-to-one on the printer, ensuring that 1 pixel in the image becomes 1 pixel on paper
p58456
aVThat ought to now look nice and sharp (minus the ClearType problem) but you'll be looking at a postage stamp
p58457
aVGrowing your arms six times longer would have the same effect
p58458
aVWell, this just doesn't work well
p58459
aVUse the PrintDocument class so you can draw stuff to the printer using its native resolution
p58460
aVUse the methods provided by e
p58461
aVGraphics in the PrintPage event handler
p58462
aVAvoid images unless they are photos, anything that doesn't have finely detailed line art will scale well
p58463
as(dp58464
g9
V17034
p58465
stp58466
a((dp58467
g2
(lp58468
VA CFAbsoluteTime is a double, the number of seconds since January 1st, 2001, 12am
p58469
aVThus:
p58470
as(dp58471
g9
V17034
p58472
stp58473
a((dp58474
g2
(lp58475
VIt is legit
p58476
aVDrawbacks are clear, this is a micro kernel
p58477
aVIt is going to be a while before your video adapter driver will be fully managed as well
p58478
aVThat takes acquiring critical mass with many devs and manufacturers jumping on the bandwagon
p58479
aVDifficult, but it has happened with Linux as the obvious example
p58480
aVThis is being pursued by Microsoft as well
p58481
aVSingularity has been well published about
p58482
aVIt has evolved into a secret research project named Midori
p58483
aVThere have been enough leaks about it to know its goal, Wikipedia has an article about it
p58484
aVI think lots of the devs that worked on the original CLR joined this project
p58485
aVWhether it will come to a good end is an open question
p58486
aVIf it does, clearly the project backer is probably enough to get that critical mass rolling
p58487
as(dp58488
g9
V17034
p58489
stp58490
a((dp58491
g2
(lp58492
VYou can get this by using a Label control instead of the baked-in TextBox control
p58493
aVAdd a new class to your project and paste the code shown below
p58494
aVCompile
p58495
aVDrop the new control from the top of the toolbox onto your form
p58496
as(dp58497
g9
V17034
p58498
stp58499
a((dp58500
g2
(lp58501
VWindows User Interface guidelines demand that a control that is disabled appears disabled
p58502
aVWith the obvious benefit that the user can tell that it won't make sense to keep banging the mouse on the control, trying to set the focus to it
p58503
aVLike all controls in the toolbox, RichTextBox implements this guideline as well
p58504
aVOverriding its painting behavior is not practical
p58505
aVConsider the ReadOnly property
p58506
as(dp58507
g9
V17034
p58508
stp58509
a((dp58510
g2
(lp58511
VBy far the simplest solution is to set the TabIndex property correctly so that your 'MyDropDownList' control has the lowest index
p58512
aVThe next approach is to do it in the constructor
p58513
aVBut you have to use Select(), the Focus() method cannot work yet because the control doesn't become visible until later
p58514
aVWorks in the Load event as well
p58515
aVFocus() starts working in the Shown event
p58516
as(dp58517
g9
V17034
p58518
stp58519
a((dp58520
g2
(lp58521
VNope, you have to ceate a new instance of the Font class to alter the style
p58522
as(dp58523
g9
V17034
p58524
stp58525
a((dp58526
g2
(lp58527
VThis is just not how the Windows memory manager works
p58528
aVAfter it went to the trouble of allocating and mapping virtual memory pages, it does not give up on them just because you stopped using them
p58529
aVThat would be very inefficient
p58530
aVIt just keeps a hold of them, adding the freed blocks of memory to a list of free blocks
p58531
aVReady to be reused again when your program continues running
p58532
aVTaskmgr
p58533
aVexe is quite insufficient to reverse-engineer how memory management works
p58534
aVEspecially the "Mem Usage" column
p58535
aVWhich only tells you how much RAM your program is currently using
p58536
aVA highly variable number
p58537
aVMinimize your app's main window for example to see a drastic change
p58538
aVWindows Internals is a decent book to learn more about how this works
p58539
as(dp58540
g9
V17034
p58541
stp58542
a((dp58543
g2
(lp58544
VThe problem is that the window's restore bounds get affected by this
p58545
aVThey become the size of the window after WM_CREATE returns
p58546
aVYou would have to modify your code to re-establish those restore bounds:
p58547
aVYou're not ahead by doing it this way
p58548
as(dp58549
g9
V17034
p58550
stp58551
a((dp58552
g2
(lp58553
VSome code to go with Ed's correct answer:
p58554
aVTo get a 'canevas' that has double-buffering turned on, so it painting doesn't flicker, use Project + Add New Item, select "Class" and paste this code:
p58555
aVCompile
p58556
aVDrag the new control from the top of the toolbox onto your form, replacing the original 'canevas'
p58557
aVUpdate the event handlers accordingly
p58558
as(dp58559
g9
V17034
p58560
stp58561
a((dp58562
g2
(lp58563
VThe problem is induced by your code that checks for the updates, it runs on the wrong thread
p58564
aVCalling Application
p58565
aVExit() from any thread other than the main UI thread is lethal
p58566
aVEven the message box is troublesome, although you'd get away with it, the box can easily disappear behind another window
p58567
aVMaybe it is easily fixable
p58568
aVIf you use FileSystemWatcher then use its SynchronizingObject property
p58569
aVIf you use a Timer then use System
p58570
aVWindows
p58571
aVForms
p58572
aVTimer
p58573
aVAnyhoo, the generic solution is to use Control
p58574
aVBeginInvoke() to make the code that displays the message box and calls Exit run on the main thread
p58575
as(dp58576
g9
V17034
p58577
stp58578
a((dp58579
g2
(lp58580
VVery unclear what "quarter of coordinates" might mean
p58581
aVTo get a Cartesian coordinate system with 0,0 in the center of the form and negative coordinates mapped to the lower left corner of the form or control, you will have to use ScaleTransform() to invert the Y-axis and TranslateTransform() to shift the origin to the center
p58582
aVLike this:
p58583
aVThis draws the line from lower-left to upper-right
p58584
as(dp58585
g9
V17034
p58586
stp58587
a((dp58588
g2
(lp58589
VWell, one obvious candidate is that this white space isn't actually a tab but spaces
p58590
aVTry FMT=Delimited( )
p58591
aVUse a hex viewer to see what's really there
p58592
aVBackgrounder is here
p58593
aVAnd this thread shows why using a buggy chunk of code like Jet that hasn't been supported for the past 9 years is such as mistake
p58594
aVWith the answer, leave the first line in schema
p58595
aVini blank
p58596
as(dp58597
g9
V17034
p58598
stp58599
a((dp58600
g2
(lp58601
VA decent tutorial, ignore the jackass title, is available here
p58602
aVThis kind of shell programming requires COM, no escaping that
p58603
aVTrying to write COM code without MSVC support classes is character-building
p58604
aVBut possible, as long as you know COM really well
p58605
as(dp58606
g9
V17034
p58607
stp58608
a((dp58609
g2
(lp58610
VI couldn't find an ideal solution for this problem, just a partial one
p58611
aVI'll assume you enabled design mode for the panels following the approach in this answer
p58612
aVAltering the design behavior of the panels requires given them their own designer
p58613
aVHere's a sample class that does this:
p58614
aVReplace the panels in your UC with MyPanel
p58615
aVThe custom SelectionRules property ensures that the user cannot easily drag the panel into another position with the mouse
p58616
aVThe Location and Size properties are however still editable in the property grid
p58617
aVTo get rid of that I think you'll need to override PreFilterProperties()
p58618
as(dp58619
g9
V17034
p58620
stp58621
a((dp58622
g2
(lp58623
VWhere did you get the "supposedly" from
p58624
aVMost of the time will be spent in the code that implements the DOM
p58625
aVWhich was written in C++ by Microsoft
p58626
aVMarshal
p58627
aVGetIUnknownForObject() gets you a raw interface pointer that you can pass to native code
p58628
aVIt needs to QI that pointer for IHtmlDocument2 and take it from there
p58629
as(dp58630
g9
V17034
p58631
stp58632
a((dp58633
g2
(lp58634
VThe C++ build model dates from an era where ferrite cores were a dollar a dozen
p58635
aVMultiple source code files compiled one at a time
p58636
aVWith a single-pass compiler
p58637
aVA linker to glue everything together
p58638
aVThat made separate declarations in header files and prototypes necessary
p58639
aVThe C# compiler takes ready advantage of modern machine resources
p58640
aVAll source code files that constitute an assembly are compiled at the same time, the compiler makes at least two passes so it can parse declarations before method bodies
p58641
aVThere's still a possible link model but it gets very rarely used
p58642
aVThe only notions of a declaration having to match a definition that I can think of is a delegate type having to match a target method and an interface member declaration having to match its concrete implementation
p58643
as(dp58644
g9
V17034
p58645
stp58646
a((dp58647
g2
(lp58648
VAppDomains are unloaded by a separate CLR thread
p58649
aVThat thread cannot run while the finalizer thread is running
p58650
aVYou're getting the exception because the CLR notices that the unload thread isn't making progress
p58651
aVIt never gets going because the finalizer thread is blocked on the Unload call
p58652
aVDeadlock
p58653
aVYour workaround indeed solves that deadlock
p58654
aVDoing the unloading explicitly instead of relying on a finalizer is the better approach here
p58655
as(dp58656
g9
V17034
p58657
stp58658
a((dp58659
g2
(lp58660
VThe SoundLocation property requires a string that contains a file path or a URL
p58661
aVThe resource you added is however returned as a Stream if it was a
p58662
aVwav file
p58663
aVYou should have gotten a compile error message, saying that it can't convert an UnmanagedMemoryStream to a string
p58664
aVThis code worked well on my machine:
p58665
aVWhat btc means in your source code is quite mysterious and possibly the real source of the compiler error message you quoted
p58666
as(dp58667
g9
V17034
p58668
stp58669
a((dp58670
g2
(lp58671
VApplication
p58672
aVExit() is required in this case
p58673
aVAnother approach is that you designate one of the forms as the "main window"
p58674
aVAnd the app will terminate when it is closed:
p58675
aVThe
p58676
aVNET framework also supports a "when last window closes" shutdown mode
p58677
aVCheck my code in this thread for the required code
p58678
as(dp58679
g9
V17034
p58680
stp58681
a((dp58682
g2
(lp58683
VThis is normal, you'll see
p58684
aVNET 2
p58685
aV0 assembly references for any framework classes that are exposed by the public types in the legacy assembly
p58686
aVFor example, a class library project compiled in VS2008 with this code:
p58687
aVAnd used in a VS2010 console mode app that targets 4
p58688
aV0:
p58689
aVProduces assembly references in its manifest like this:
p58690
aVNote the reference to the 2
p58691
aV0 version of mscorlib, named "mscorlib_2"
p58692
aVThis is resolved at runtime
p58693
aVThere is no sign from the fusion log that it was ever asked to resolve the mscorlib_2 assembly reference
p58694
aVThe StringBuilder class object that get created is the 4
p58695
aV0 version
p58696
aVWhich probably means that the CLR assembly loader is redirecting the version
p58697
aVI'm not aware of any config that does the mapping, guessing at this being hard-coded
p58698
aVThis is of course potentially breaking behavior for the code that was only ever tested with v2
p58699
aV0-v3
p58700
aV5sp1 versions of the
p58701
aVNET assemblies
p58702
aVI haven't heard of a single case yet
p58703
as(dp58704
g9
V17034
p58705
stp58706
a((dp58707
g2
(lp58708
VThis has very little to do with JavaScript, bubbling is a property of the DOM
p58709
aVWhich represents documents in a tree-like hierarchy, making it natural to pass events that are not handled up the tree
p58710
aVThis doesn't nearly correspond as well in a window hierarchy
p58711
aVChief problem being that if you nest windows deeply then you'd have been yourself a dog of a program that takes forever to draw the UI
p58712
aVNevertheless, the default window procedure does bubble window messages to the parent
p58713
aVThis is selective behavior, it depends on the particular message
p58714
aVA WM_MOUSEWHEEL message for example bubbles, looking for a parent window that knows how to scroll the view
p58715
aVBut WM_LBUTTONDOWN does not bubble, the parent window wouldn't normally have much use for a mouse click on an area that it doesn't 'own'
p58716
aVOther than perhaps to set the focus to the control, something that already happens automatically
p58717
aVYou can certainly make it bubble yourself, just send the message to the parent
p58718
aVIn effect this already happens
p58719
aVA control normally generates a MouseDown or Click event
p58720
aVWhich is subscribed by an event handler in the form
p58721
aVDifferent model, same effect
p58722
as(dp58723
g9
V17034
p58724
stp58725
a((dp58726
g2
(lp58727
VYou could add a "makefile project"
p58728
aVThe template is under Visual C++, General
p58729
aVThis project type allows you to specify custom build commands for the Build, Clean and Rebuild actions
p58730
aVThe environment will be setup automatically so you don't have to mess with paths
p58731
aVThe C++ IDE also supports creating a custom build rule so you can automatically trigger the right tool (ilasm
p58732
aVexe) from the file name extension (
p58733
aVil)
p58734
aVThat's however about as good as it gets
p58735
aVThere is no automatic mapping of multiple
p58736
aVil files in the project to a single build command
p58737
aVWriting an nmake
p58738
aVexe makefile is required to get that
p58739
aVAnd beware that custom build rules support got broken in vs2010
p58740
as(dp58741
g9
V17034
p58742
stp58743
a((dp58744
g2
(lp58745
VC arrays are fundamentally broken this way, you cannot reliably bounds-check them
p58746
aVNor can the compiler
p58747
aVIntel's C++ compiler however certainly can compile the vector class
p58748
aVTurn on iterator debugging, use the at() accessor
p58749
as(dp58750
g9
V17034
p58751
stp58752
a((dp58753
g2
(lp58754
VThis is the ThreadExceptionDialog class, it derives from the Form class
p58755
aVDeriving from it to alter the dialog is a lost cause, you can't easily get to the embedded controls
p58756
aVYou can create your own Form derived class to make your own dialog just as well, just give it a constructor that takes an Exception argument
p58757
aVImplement an event handler for Application
p58758
aVThreadException to display it
p58759
aVDo note the fundamental flaw in the dialog
p58760
aVIt expects the user to make the right choice when she needs to click a button to dismiss the dialog
p58761
aVWith, in general, fairly obscure information about what exactly went wrong
p58762
aVIt means something to you, rarely anything more than 'oh crap' to the user
p58763
aVClicking the Continue button is not typically the right thing to do
p58764
aVTo avoid the user having to make such a difficult choice, call Application
p58765
aVSetUnhandledExceptionMode() in your Main() method, passing ThrowException so that the event is never raised
p58766
aVEvery unhandled exception now goes through AppDomain
p58767
aVUnhandledException
p58768
aVIncluding the ones that were raised in a worker thread, exceptions that don't produce the dialog
p58769
aVWrite an event handler for it and display and/or log the value of e
p58770
aVExceptionObject
p58771
aVToString()
p58772
aVIt is up to you to sort out a way to get that info to your desk, or the user's IT staff, so you can improve your product and they can get their machines stable
p58773
as(dp58774
g9
V17034
p58775
stp58776
a((dp58777
g2
(lp58778
VAllocation granularity for VirtualAlloc is normally 64KB
p58779
aVHe tries to do something meaningful if the AllocationBase is not a multiple of 64KB
p58780
aVI don't think it is meaningful at all, his bitmasks still assume a granularity of 64KB and he doesn't use SYSTEM_INFO
p58781
aVdwAllocationGranularity
p58782
aVWhich has this comment:
p58783
aVThis value was hard coded as 64 KB in
p58784
aVthe past, but other hardware
p58785
aVarchitectures may require different
p58786
aVvalues
p58787
aVIn the very rare case where it is not 64KB, this code would generate junk values
p58788
aVJust zap it, go by RegionSize
p58789
as(dp58790
g9
V17034
p58791
stp58792
a((dp58793
g2
(lp58794
VKinda pointless I'd say
p58795
aVScheme interpreters often implement call/cc with a state machine that captures local state onto the heap
p58796
aVWhich is exactly what C# 5
p58797
aV0 (or more correctly C# 2
p58798
aV0's iterator) does as well
p58799
aVThey did implement call/cc, the abstraction they came up with is quite elegant
p58800
as(dp58801
g9
V17034
p58802
stp58803
a((dp58804
g2
(lp58805
VIt is possible
p58806
aVTools + Options, Debugging, Edit and Continue
p58807
aVUncheck the Enable option
p58808
aVThat also allows you to edit the source code without having a breakpoint active
p58809
aVBut of course, your changes won't have any effect until you stop and rebuild
p58810
as(dp58811
g9
V17034
p58812
stp58813
a((dp58814
g2
(lp58815
VYes, this was quite intentionally not included in the documented API
p58816
aVEnumerating open files can never work reliably on a multi-tasking operating system, you cannot 'freeze' the operating system and prevent other processes from opening and closing files while you enumerate them
p58817
aVThe race condition is unsolvable
p58818
aVThe only documented way is to try to open a file with no sharing
p58819
aVYes, NtQuerySystemInformation is the back door
p58820
aVUsed by SysInternals' Handle utility
p58821
aVAnd maintained by them since every new version of Windows requires an update to the utility
p58822
as(dp58823
g9
V17034
p58824
stp58825
a((dp58826
g2
(lp58827
VA UserControl was very much designed to be a container control for other controls
p58828
aVIt abhors getting the focus and tries to pass it off first chance it gets
p58829
aVYou should not be using a UserControl here, given that you don't put any controls inside of it
p58830
aVA Panel control will suffice
p58831
aVWhich has the exact same problem, it doesn't want to get focus either
p58832
aVSurgery is required to override its behavior
p58833
aVEverything you need is in this answer
p58834
as(dp58835
g9
V17034
p58836
stp58837
a((dp58838
g2
(lp58839
VWell, it should not recognize MSNMessenger::, you used the no_namespace attribute on the #import directive
p58840
aVTaking a wild guess, maybe you started this first without that attribute and the IntelliSense parser isn't smart enough to recognize that you changed it
p58841
aVClose your solution and delete the
p58842
aVncb file in the project directory
p58843
aVsdf for VS2010
p58844
aVOpen it back up, the IS parser will rebuild the file
p58845
as(dp58846
g9
V17034
p58847
stp58848
a((dp58849
g2
(lp58850
VYes, it would be
p58851
aVIf it wasn't for this note:
p58852
aVWarning: On Unix, this list is built
p58853
aVfrom the argc and argv parameters
p58854
aVpassed to the constructor in the
p58855
aVmain() function
p58856
aVThe string-data in
p58857
aVargv is interpreted using
p58858
aVQString::fromLocal8Bit(); hence it is
p58859
aVnot possible to pass, for example,
p58860
aVJapanese command line arguments on a
p58861
aVsystem that runs in a Latin1 locale
p58862
aVMost modern Unix systems do not have
p58863
aVthis limitation, as they are
p58864
aVUnicode-based
p58865
aVOn NT-based Windows, this limitation
p58866
aVdoes not apply either
p58867
aVOn Windows, the
p58868
aVarguments() are not built from the
p58869
aVcontents of argv/argc, as the content
p58870
aVdoes not support Unicode
p58871
aVInstead, the
p58872
aVarguments() are constructed from the
p58873
aVreturn value of GetCommandLine()
p58874
aVAs a
p58875
aVresult of this, the string given by
p58876
aVarguments()
p58877
aVat(0) might not be the
p58878
aVprogram name on Windows, depending on
p58879
aVhow the application was started
p58880
aVAdmittedly, I don't get the word either
p58881
as(dp58882
g9
V17034
p58883
stp58884
a((dp58885
g2
(lp58886
VCOM type libraries do support comments through the [helpstring] attribute
p58887
aVMany COM aware development environments display these comments in their editor
p58888
aVHowever, this is not supported in
p58889
aVNET, a type library is generated from compiled code which has all comments removed
p58890
aVAnd there is no attribute in
p58891
aVNET that lets Regasm
p58892
aVexe or Tlbexp
p58893
aVexe emit it into the
p58894
aVtlb
p58895
aVIf you want to pursue this then you'll have to write an
p58896
aVidl file
p58897
aVYou can get one out of the existing
p58898
aVtlb with OleView
p58899
aVexe, File + View Typelib command
p58900
aVYou can then edit the file to insert the [helpstring] attributes, midl
p58901
aVexe can translate it back into a type library
p58902
aVThe brutal part about it is that you have to redo this when the public interface of the C# code changes
p58903
aVNo joy without tooling
p58904
aVAnd you have to automate it to ensure this type library cannot get out of step with the C# code
p58905
aVThat produces horrible runtime exceptions that are impossible to diagnose
p58906
aVLike AccessViolationException
p58907
aVOr worse, no exception at all, just wrong values when the stack gets imbalanced
p58908
aVI'm not aware of an existing tool that does this
p58909
as(dp58910
g9
V17034
p58911
stp58912
a((dp58913
g2
(lp58914
VIt is just a diagnostic that is generated with OutputDebugString()
p58915
aVAnything written with that API ends up in your Output window
p58916
aVIt is benign, you can ignore it
p58917
aVFixing it requires rebuilding whatever ActiveX control that's being used on the web page you display
p58918
aVGetting the source for it ought to be difficult
p58919
as(dp58920
g9
V17034
p58921
stp58922
a((dp58923
g2
(lp58924
VThe formatting routine that VB6 uses is actually built into the operating system
p58925
aVOleaut32
p58926
aVdll, the VarFormat() function
p58927
aVIt's been around for 15 years and will be around for ever, considering how much code relies on it
p58928
aVTrying to translate the formatting strings to a
p58929
aVNET composite formatting string is a hopeless task
p58930
aVJust use the OS function
p58931
aVHere's a sample program that does this, using the examples from the linked thread:
p58932
as(dp58933
g9
V17034
p58934
stp58935
a((dp58936
g2
(lp58937
VWell, this is not completely impossible
p58938
aVYou need to pinvoke SHCreateItemFromParsingName() to obtain an IShellItem2 interface pointer so you can call its GetProperty() method
p58939
aVTo get this going in C# is however quite brutal
p58940
aVThe shell interfaces are in the domain of native C++, the only language in which you can get the COM declarations and guids you need to bring this to a good end
p58941
aVAfter 4 major releases of
p58942
aVNET, we're still no closer to make shell programming in a managed language any easier
p58943
aVGood keywords to google for though, somebody somewhere made this work
p58944
as(dp58945
g9
V17034
p58946
stp58947
a((dp58948
g2
(lp58949
VThis is a normal warning, you will always get it when you explicitly target x64
p58950
aVIt won't be a problem at runtime because on a 64-bit machine, the GAC stores a 64-bit specific version of mscorlib
p58951
aVdll
p58952
aVLong version: several
p58953
aVNET assemblies contain unmanaged code
p58954
aVWhich makes them sensitive to the bitness of the process that uses them
p58955
aVMscorlib
p58956
aVdll is one of them, System
p58957
aVData
p58958
aVdll and the WPF assemblies are other examples
p58959
aVMicrosoft resolved this by building two versions of those assemblies, a 32-bit one and a 64-bit one
p58960
aVThe GAC can store them both, resolved by the AssemblyName
p58961
aVProcessorArchitecture property
p58962
aVThe 'normal' setting for this property is MSIL, used when the assembly contains pure IL
p58963
aVA single copy of the assembly can then be used by both a 32-bit and a 64-bit process
p58964
aVThe reference assemblies used by the compiler are a copy of the
p58965
aVNET assemblies
p58966
aVThe compiler uses them purely for their metadata
p58967
aVThose copies are however copies of the 32-bit assemblies, they'll have the ProcessArchitecture set to X86 for assemblies that contain unmanaged code
p58968
aVYou can see where this goes, you are compiling for x64 and the compiler sees an x86 reference assembly
p58969
aVEnough to generate a warning "this program is going to work only if you also provide the x64 version of the assembly"
p58970
aVWhich is certainly the case for
p58971
aVNET assemblies, but not necessarily for your own
p58972
aVFwiw, explicitly targeting x64 is almost always the wrong thing to do
p58973
aVIt only really matters on the EXE assembly since that is the one that determines the bitness of the process
p58974
aVA DLL assembly doesn't have a choice, the appropriate build setting for them is Any CPU so they can work both ways
p58975
aVThe rare exception is that the DLL has a known dependency on a unmanaged component, typically a COM server
p58976
aVSuch components are typically only available as 32-bit images, you get a hard to diagnose error message when you try to load them in a 64-bit process ("Class not registered")
p58977
aVBy forcing them to target x86, you'd get another hard to diagnose exception that is perhaps a bit easier on the eyes, BadImageFormatException
p58978
aVHaving a dependency on unmanaged code that is only available in 64-bit code is quite rare, therefore targeting x64 doesn't make much sense
p58979
as(dp58980
g9
V17034
p58981
stp58982
a((dp58983
g2
(lp58984
VIt is not Tlbimp that does this, this was injected by midl
p58985
aVexe when you built the unmanaged COM server
p58986
aVA window handle is an interop obstacle because it is a 32-bit value in a 32-bit program and a 64-bit value in a 64-bit program
p58987
aVLike all handles
p58988
aVTake a look at the wtypes
p58989
aVidl file in the Windows SDK include directory, you'll find _RemotableHandle declared there
p58990
aVA bit further down, you'll see the #define that maps the HWND to a RemotableHandle:
p58991
aVAs near as I can tell, when you pass the /D _MIDL_DECLARE_WIREM_HANDLE to midl
p58992
aVexe then you'll get a type library without the RemoteHandle wrapper
p58993
aVAdmittedly I don't really understand how this is supposed to work
p58994
as(dp58995
g9
V17034
p58996
stp58997
a((dp58998
g2
(lp58999
VIt is caused by an initialization problem in your program
p59000
aVThe very first SystemEvents event that is subscribed causes the SystemEvents class to initialize itself and setup the plumbing that's necessary to receive these events
p59001
aVIt creates a hidden window so that it can receive the notification messages, like WM_SETTINGCHANGE
p59002
aVControls you use in your forms often subscribe to the UserPreferenceChanged event so they can redraw themselves when the user changes the Windows theme or a system color
p59003
aVThis goes wrong when that very first control is one that wasn't created on the main thread
p59004
aVSystemEvents notices this and creates a helper thread to service the hidden window
p59005
aVImportant when for example a console mode program wants to use such a system event
p59006
aVFrom there on, the subscribed event handlers are raised from that helper thread instead of the main thread
p59007
aVIf that event handler then does something with the UI, the likelihood for deadlock is high, windows are not thread-safe
p59008
aVYou can diagnose this from the Debug + Windows + Threads window, you'll see that helper thread with the name "
p59009
aVNET SystemEvents"
p59010
aVThe typical source of this problem is a custom splash screen, created on a worker thread while the main thread initializes itself
p59011
aVAvoid this and use the built-in
p59012
aVNET support for splash screens
p59013
aVAnother reason is a Main() entrypoint in your program that doesn't have the [STAThread] attribute
p59014
aVAny other kind of code that starts a worker thread at program initialization time, before calling Application
p59015
aVRun() is a potential troublemaker
p59016
aVIf you have no clue what part of the code might be doing this then you can work around it by subscribing a dummy system event in your Main() method, ensuring that the hidden notification window is always created on the main UI thread
p59017
aVPaste this code into your Main method, after the EnableVisualStyles call:
p59018
as(dp59019
g9
V17034
p59020
stp59021
a((dp59022
g2
(lp59023
VRunning unit tests doesn't produce
p59024
aVpdb files
p59025
aVCompiling the tests does
p59026
aVCheck your build settings
p59027
aVIt is the /pdb argument to the compiler, in case you are not using msbuild
p59028
aVOne exception, you could get
p59029
aVpdbs if you are unit-testing code that uses System
p59030
aVCodeDom
p59031
aVIn which case checking that you get the
p59032
aVpdbs ought to be part of the test
p59033
as(dp59034
g9
V17034
p59035
stp59036
a((dp59037
g2
(lp59038
VListening for window messages requires injecting code in the process whose window you want to dock to
p59039
aVYou cannot inject C# code, you can't reliably get the CLR initialized in that process
p59040
aVYou'll only have a fighting chance if you use native code
p59041
aVGoogle EasyHook
p59042
aVBlack belt Win32 API skills are required to bring this to a good end
p59043
as(dp59044
g9
V17034
p59045
stp59046
a((dp59047
g2
(lp59048
VYou cannot ignore the fact that Windows wants LPARAM to point to a COPYDATASTRUCT structure
p59049
aVYou however only allocate 4 bytes, not nearly enough to store that structure
p59050
aVWhat happens next is unpredictable, Windows will be reading past the memory that you allocated, looking for the value of COPYDATASTRUCT
p59051
aVcbData and lpData
p59052
aVYou might get lucky and it reads cbData = 0
p59053
aVOr not so lucky and reading a non-zero value
p59054
aVWhich will make it dereference lpData and that almost always generates an AccessViolation exception
p59055
aVYou can tell when this happens, SendMessage() returns a value
p59056
aVOne you didn't check so you don't know when this goes wrong
p59057
aVAs long as you want to keep using WM_COPYDATA, you have to provide it with proper arguments
p59058
aVThe much better approach is to use named pipes or a socket
p59059
aVWhich also avoid having to use FindWindow(), a very unreliable way to find a window handle
p59060
as(dp59061
g9
V17034
p59062
stp59063
a((dp59064
g2
(lp59065
VWe are looking at a edited version of your code
p59066
aVYou removed the bits that cause the deadlock
p59067
aVSome notes:
p59068
aVYou mention a 'status progress bar' but your code shows no evidence for it
p59069
aVGetting that bar updated provides ample ways for deadlock
p59070
aVThe commented calls to PublishStatus are a red flag
p59071
aVThere is no evidence of a RunWorkerCompleted event handler even though you'd need one to get your splash screen closed
p59072
aVThe BGW will deadlock when your main thread is blocking on the BGW and not pumping messages
p59073
aVThere's a corner case for circular dependencies between assemblies
p59074
aVYour code will hang in an endless loop
p59075
aVDiagnose with Build + Clean, Build + Build
p59076
aVRemote, but several
p59077
aVNET assemblies as well as C++/CLI assemblies have a module initializer
p59078
aVIt may not necessarily act properly when the assembly is loaded on a non-STA worker thread
p59079
aVRunWorkerCompleted is my best guess until you show an unedited version of your code
p59080
as(dp59081
g9
V17034
p59082
stp59083
a((dp59084
g2
(lp59085
VA reference DLL won't get copied if it is registered in the GAC
p59086
aVTrying to avoid the copy for non-GAC-ed assemblies is possible, set the Copy Local property to False
p59087
aVIt is however pretty unusual to do so, you can't debug the code because the CLR cannot find the required assembly at run time
p59088
aVNot being able to debug code is, well, a problem
p59089
as(dp59090
g9
V17034
p59091
stp59092
a((dp59093
g2
(lp59094
VThings you have to do:
p59095
aVProject + Properties, Application tab, change Output Type to "Windows Application"
p59096
aVProject + Add Reference, select at least System
p59097
aVWindows
p59098
aVForms and System
p59099
aVDrawing
p59100
aVLocate your Main() method in the Program
p59101
aVcs source code file
p59102
aVGive it the [STAThread] attribute
p59103
aVRewrite the Main() method to look like this:
p59104
aVChange "YourMainForm" to the name of your form class
p59105
aVSalvaging your existing code in the Main() method is what will probably be the painful bit
p59106
aVYou cannot leave it after the Run() call, that call won't return until the user closes your main form
p59107
as(dp59108
g9
V17034
p59109
stp59110
a((dp59111
g2
(lp59112
VUse the debugger
p59113
aVDebug + Break All when you notice it blocking
p59114
aVThen Debug + Windows + Threads and select the main thread
p59115
aVThe call stack window shows you what it is doing
p59116
aVA corner case is where these plugins are using a lot of calls to Control
p59117
aVBegin/Invoke or Dispatcher
p59118
aVBegin/Invoke
p59119
aVYour UI thread is not blocked in this case, it is just being overwhelmed by requests to dispatch the delegate targets
p59120
aVAnd doesn't get around to doing its normal duties anymore, like repainting the windows and responding mouse and keyboard events
p59121
aVThere's little you can do about this beyond working with the plugin authors to get them to mend their ways
p59122
aVYou've already got an UI thread, the thread that created the first window
p59123
aVCreating additional threads that have their own windows is possible but causes unsolvable problems with window Z-order (a window will disappear underneath the window of another app) and generous helpings of window interop threading misery
p59124
as(dp59125
g9
V17034
p59126
stp59127
a((dp59128
g2
(lp59129
VIt is a very unusual exception
p59130
aVThe form already has an owner when it got created by the constructor
p59131
aVYou didn't use the ShowDialog(owner) override so Windows Forms has to find an owner for itself
p59132
aVIt finds the exact same form back
p59133
aVThat's technically possible, but you'd have to write some fairly odd code
p59134
aVTo diagnose this, add this code to the form:
p59135
aVAnd set a breakpoint on it
p59136
aVIf my guess is correct, this will break before the ShowDialog call
p59137
aVLook at the call stack to see what statement is getting that window created
p59138
as(dp59139
g9
V17034
p59140
stp59141
a((dp59142
g2
(lp59143
VIt is kinda important that you use the tools that are available to you
p59144
aVCompile your proposed code
p59145
aVI'll wait a few minutes
p59146
aVOkay, you're back
p59147
aVYes, you need to add a constraint for IDisposable so that the using statement is always capable of disposing the object
p59148
aVThe code from the book is a hack around that restriction, it will work even if T does not implement IDisposable
p59149
aVusing (null) {} is valid
p59150
as(dp59151
g9
V17034
p59152
stp59153
a((dp59154
g2
(lp59155
VFrom the Remarks section of TaskbarItemInfo
p59156
aVOverlay:
p59157
aVThe overlay is not displayed if the
p59158
aVuser sets the taskbar to show small
p59159
aVicons
p59160
as(dp59161
g9
V17034
p59162
stp59163
a((dp59164
g2
(lp59165
VWell, you already got a thread running inside that process
p59166
aVYou make it do something boring, it only loads a DLL
p59167
aVThis works completely by accident, LoadLibrary just happens to have to correct function signature
p59168
aVIt can do much more
p59169
aVThat however better be unmanaged code, just like LoadLibrary(), you cannot count on any managed code running properly
p59170
aVThat takes a heckofalot more work, you have to load and initialize the CLR and tell it to load and execute the assembly you want to run
p59171
aVAnd no, you cannot load the CLR in DllMain()
p59172
aVKeywords to look for are CorBindToRuntimeEx() and ICLRRuntimeHost::ExecuteInAppDomain()
p59173
aVThis is gritty stuff to get going but I've seen it done
p59174
aVCOM and C++ skills and generous helpings of luck required
p59175
as(dp59176
g9
V17034
p59177
stp59178
a((dp59179
g2
(lp59180
VIt is because your code is wrong
p59181
aVThe a variable is an array, not a pointer
p59182
aVDeclare it char* and you don't need the override
p59183
aVThe code is nonsense of course
p59184
as(dp59185
g9
V17034
p59186
stp59187
a((dp59188
g2
(lp59189
VWM_COPYDATA is a pretty miserable way to interop, given the need to find a valid window handle
p59190
aVNevertheless, nothing useful is going to happen unless that other program is actively cooperating with yours, it is going to dump the WM_COPYDATA message in the garbage can otherwise
p59191
aVSince that program already needs to know a lot about yours, including where to find it and handling the message, it might also simply provide you with a command line argument that contains what you need
p59192
aVYes, the window handle could be passed as a command line argument, you'll get it from main() or GetCommandLine() in the child process
p59193
aVConsider a named pipe or a socket as a better mousetrap
p59194
aVOr out-of-process COM
p59195
as(dp59196
g9
V17034
p59197
stp59198
a((dp59199
g2
(lp59200
VResources are just data
p59201
aVData doesn't have any capability of springing to life to alter the appearance of a window
p59202
aVThat requires code that uses the data
p59203
aVWhether that code lives inside Windows or in your program doesn't really matter
p59204
aVIt is still code
p59205
aVSo, yes, it is all code that gets the job done
p59206
aVYou're doing it right if it is code you don't have to write
p59207
aVAnd don't have to maintain
p59208
as(dp59209
g9
V17034
p59210
stp59211
a((dp59212
g2
(lp59213
VA struct is COM's Achilles heel
p59214
aVThe actual layout of the members of the struct is highly compiler dependent
p59215
aVThey were not support in COM automation for quite a while until they came up with the IRecordInfo hack
p59216
aVNot getting used here
p59217
aVIn unmanaged code, the #pragma pack directive is very important
p59218
aVFor type libraries, the /pack argument to midl
p59219
aVexe is essential
p59220
aVIf it isn't 8 or you don't use the 64-bit version of midl then you'll definitely have this kind of problem
p59221
aVThe BSTR members are the ones that throw it off, they are either 32-bit or 64-bit pointers, depending on the bitness
p59222
aVAnd align on a multiple of 4 for the 32-bit version of midl, a multiple of 8 for the 64-bit version
p59223
aVYou can possible rescue it by passing /pack 4, as long as the struct doesn't contain any doubles
p59224
aVBut try the 64-bit version of midl
p59225
aVexe first
p59226
aVOr get rid of structs and replace them with interface pointers, that's the real fix
p59227
as(dp59228
g9
V17034
p59229
stp59230
a((dp59231
g2
(lp59232
VNo, that's not a leak
p59233
aVWhen the garbage collector goes searching for object references, it won't find a reference to the original ArrayList anymore
p59234
aVYou replaced it
p59235
aVSo it will automatically destroy that original ArrayList object, as well as all of its elements if they are not referenced anywhere either
p59236
aVThe Form class knows how to dispose itself, as well as all the controls that are child windows on that form
p59237
aVThis happens when the user closes the form, the WM_CLOSE message that Windows sends triggers this code
p59238
aVThe Form
p59239
aVControls collection helps it find the reference to all child controls so it can dispose them too
p59240
aVHowever, this will not happen if you remove controls from the form yourself
p59241
aVNow it is up to you to call Dispose() on them
p59242
aVParticularly the Controls
p59243
aVClear() method is dangerous
p59244
aVWhat is unusual about it is that this causes a permanent leak, the controls you remove are kept alive by the 'parking window'
p59245
aVWhich keeps the window handle alive so you can move them elsewhere, on another container window for example
p59246
aVIf you don't actually move them, they'll stay hosted on that parking window forever
p59247
aVNo other classes in the framework quite behave this way
p59248
aVThis leak is easy to diagnose with Taskmgr
p59249
aVexe, Processes tab
p59250
aVView + Select Columns and tick USER Objects
p59251
aVIf this steadily goes up while your program runs then you're leaking controls
p59252
as(dp59253
g9
V17034
p59254
stp59255
a((dp59256
g2
(lp59257
VMost std::string::c_str() implementations (if not all of them) simply return a pointer to an internal buffer
p59258
aVNo overhead whatsoever
p59259
aVBeware however that c_str() returns a , not a char*
p59260
aVAnd that the pointer will become invalid after the function call
p59261
aVSo you cannot use it if the function does anything like writing back into the passed string or makes a copy of the pointer
p59262
as(dp59263
g9
V17034
p59264
stp59265
a((dp59266
g2
(lp59267
VThis is the way it was done back in the Windows 3
p59268
aVx days when all you had was a 386SUX
p59269
aVNow you just update the internal shape list and call InvalidateRect to let the WM_PAINT message handler re-render all shapes
p59270
aVNo need for XOR tricks and its fugly side-effects
p59271
aVDouble-buffer when it starts to flicker
p59272
as(dp59273
g9
V17034
p59274
stp59275
a((dp59276
g2
(lp59277
VStep outside, look at the moon
p59278
aVThe horizon is on the bottom
p59279
aVTilt your head to the left, the horizon rotates to the right
p59280
aVThe up vector is the orientation of your head
p59281
as(dp59282
g9
V17034
p59283
stp59284
a((dp59285
g2
(lp59286
VA large number of the SendMessage() calls that deliver a message straight to the window procedure are in Windows or another process
p59287
aVCan't time those
p59288
aVAn indirect measurement could be SetTimer() and measuring how late the WM_TIMER message gets delivered
p59289
as(dp59290
g9
V17034
p59291
stp59292
a((dp59293
g2
(lp59294
VProject + Properties, Debug tab
p59295
aVSelect "Start external program", set it to c:\u005cprogram files\u005cinternet explorer\u005ciexplore
p59296
aVexe
p59297
aVYou probably want to set the "Command line arguments" to the path of an HTML file that exercises your BHO
p59298
aVSet a breakpoint on the code you want to debug
p59299
aVInternet Explorer will start running when you press F5
p59300
aVYou'll see the breakpoint turning hollow, indicating that the breakpoint is not armed
p59301
aVAs soon as IE loads your DLL, visible in the Output window, it will turn into a solid red
p59302
aVAnd the debugger automatically breaks when IE calls your code
p59303
aVThere is a registration step
p59304
aVDo always avoid using gacutil
p59305
aVexe, it does nothing but pollute the GAC on your machine
p59306
aVAlways favor the "Register for COM interop" option in the IDE, the equivalent of running Regasm
p59307
aVexe with the /codebase option
p59308
aVNo need for the GAC that way
p59309
aVEither way, VS must be running elevated to make these machine config changes, start it by right-clicking the shortcut and selecting "Run as Administrator"
p59310
as(dp59311
g9
V17034
p59312
stp59313
a((dp59314
g2
(lp59315
V"GMT" is ambiguous, you need to avoid the term
p59316
aVIt could represent the time kept by the Royal Observatory in Greenwich, that matches UTC
p59317
aVOr it could match the name of the timezone for London
p59318
aVWhere daylight savings time is observed, it only matches UTC in the winter
p59319
as(dp59320
g9
V17034
p59321
stp59322
a((dp59323
g2
(lp59324
VImplement the service's OnStart, OnShutdown and OnSessionChange methods
p59325
aVNot so sure that OnSessionChange still works on Vista and Win7, services run in an isolated session called Session 0
p59326
aVI seriously doubt it, no workaround for it
p59327
as(dp59328
g9
V17034
p59329
stp59330
a((dp59331
g2
(lp59332
VGDI (and thus MFC) has no decent support for drawing with an alpha
p59333
aVBut GDI+ is available in C++ code as well
p59334
aVUse  and initialize it with GdiplusStartup()
p59335
aVYou can use the Graphics class, create one with its Graphics(HDC) constructor from your CPaintDC
p59336
aVAnd use its FillRectangle() method
p59337
aVThe SDK docs are here
p59338
as(dp59339
g9
V17034
p59340
stp59341
a((dp59342
g2
(lp59343
VYes, the size for the startup thread is determined by a value in the
p59344
aVEXE file header
p59345
aVNecessarily so because Windows creates that thread, before any code in the program can run
p59346
aVThe managed compiler you use writes that value
p59347
aVCurrent
p59348
aVNET compilers select 1 MB when you target x86 or Any CPU, 4 MB when you target x64
p59349
aVThis is however not fixed, you can modify the value with the Editbin
p59350
aVexe utility, /STACK command line option
p59351
aVYou could run this in a post-build event:
p59352
aVNote that this won't work in the Express edition
p59353
aVThe stack size for threads that you create are under your control, the Thread class constructor has overloads that lets you specify the size
p59354
aVYou cannot make it too small, it clips the value to 256 KB
p59355
aV4 or 16KB is way too small, 1 MB is the default
p59356
as(dp59357
g9
V17034
p59358
stp59359
a((dp59360
g2
(lp59361
VOkay, a practical answer
p59362
aVYou are not stuck with a fixed size of the stack
p59363
aVYou can use the Thread(ThreadStart, int) constructor to create one with a larger stack
p59364
aVGive it a couple of dozen megabytes
p59365
aVThis should go a large way to avoiding the problem if not completely solve it
p59366
aVNext thing to do is to start screening the xml file you are given to process
p59367
aVNot so sure if it is the raw size of the file that would cause SO or bad data in the
p59368
aVxml
p59369
aVStart by checking the size of the file and drop it in a separate directory if it is a monster
p59370
aVTo be processed manually, preferably by whomever created this file in the first place
p59371
aVAnd make sure that you've got a couple of trouble-maker files, if you don't have them already
p59372
aVTry to process them off-line with a monster thread stack size
p59373
aVIf that still blows, start looking for an algorithm that can pre-screen the
p59374
aVxml content to detect the source of the problem
p59375
aVAsk another question if you think that the
p59376
aVxml file content might be the cause and you need to find out what kind of bad content could cause this (don't know much of anything about xlt)
p59377
as(dp59378
g9
V17034
p59379
stp59380
a((dp59381
g2
(lp59382
VYes, it has been around for a while already
p59383
aVBut it gets especially a lots of usage in Windows7
p59384
aVUnfortunately, they keep this one to themselves, it is undocumented
p59385
aVYou can try to reverse-engineer it, use a ListView as a guide to what it might do
p59386
aVBut your code will almost certainly break in the next version of Windows
p59387
aVWhich I think was the point of not documenting it, they need something they don't have to keep backwards compatible to be able to improve the look-and-feel of the operating system
p59388
as(dp59389
g9
V17034
p59390
stp59391
a((dp59392
g2
(lp59393
VThe problem is that the Font property of a Form or a control specifies the font size in Points
p59394
aVThat's a measurement that affect the height of the letters when the DPI setting changes
p59395
aVOne point is 1/72 inches
p59396
aVThe default DPI, 96 dots per inch and a font size of 9 points yields a letter that is 9 / 72 x 96 = 12 pixels high
p59397
aVWhen the user bumps up the DPI setting to, say, 120 DPI (125%) then the letter becomes 9 / 72 x 120 = 15 pixels high
p59398
aVIf you don't let the control get larger then the text won't fit in the control anymore
p59399
aVVery ugly to look at
p59400
aVThe Form
p59401
aVAutoScaleMode property solves this problem
p59402
aVIt checks at which size the form was designed and compares it against the DPI on the machine on which it runs
p59403
aVAnd resizes and relocates the controls to ensure this kind of clipping won't happen
p59404
aVVery useful, it is completely automatic without you having to do anything about it
p59405
aVThe typical problem is the "relocates" bit in the previous paragraph
p59406
aVIf you give controls their own font size instead of inheriting the size of the form or if the automatic layout of the form isn't kosher then controls may end up in the wrong spot, destroying the organized look of the form
p59407
aVYou need to fix that, it isn't clear from your question what the source of the problem might be
p59408
aVTrying to prevent this auto-scaling from doing its job is not sustainable
p59409
aVYou'll have to iterate all of the controls in the form and change their Font, picking a smaller font size
p59410
aVThis is however going to get you into trouble a couple of years from now, if not already
p59411
aVYour user is going to complain about having to work with a postage stamp
p59412
aVThe easiest way to debug the layout problem, avoiding the pain of constantly changing the DPI size, is to temporarily paste this code into your form class:
p59413
as(dp59414
g9
V17034
p59415
stp59416
a((dp59417
g2
(lp59418
VYou are using the wrong class
p59419
aVA Component cannot be a child of a panel or a form, it doesn't have a visual presentation
p59420
aVThe missing Handle property is the important one
p59421
aVYou need a Control
p59422
aVDerive your class directly from Control or from one of the built-in control classes (Button, Label, etc)
p59423
aVYou'd do the latter if you want to customize their behavior and make it re-usable
p59424
as(dp59425
g9
V17034
p59426
stp59427
a((dp59428
g2
(lp59429
VThis problem is normal, you cannot typically open the file while the other process is busy writing to it
p59430
aVYou'll need to wait, you cannot predict when it will be done
p59431
aVAdd the path to the file to a list and use a timer to empty that list, periodically retrying the operation
p59432
aVCareful with the logic, you're using threads so you'll need to protect the list with a lock
p59433
as(dp59434
g9
V17034
p59435
stp59436
a((dp59437
g2
(lp59438
VYes, the P/Invoke marshaller just uses LoadLibrary()
p59439
aVWhich observes the setting
p59440
aVIt is unprovable that it actually does in a SO post, until you try it yourself, I concluded this by being pretty sure there is no reasonable alternative
p59441
aVLoadLibrary squarely belongs in the category of the 'hard' API functions
p59442
aVFwiw, it will never find that DLL with your [DllImport] declaration
p59443
aVUnmanaged DLLs just have a path, they don't have managed assembly properties like version, culture, pkt
p59444
aVIf this is in fact a managed assembly with those properties then you load it with Assembly
p59445
aVLoad()
p59446
aVBut you'll have a hard time calling a static function, the CLR doesn't support that, every method must belong to a class
p59447
aVUse Dumpbin
p59448
aVexe /exports on that DLL to find out what is actually getting exported from that DLL
p59449
as(dp59450
g9
V17034
p59451
stp59452
a((dp59453
g2
(lp59454
VStart your program
p59455
aVRun the Spy++ utility
p59456
aVType Ctrl+F to start the finder tool and drag the bulls-eye onto your form
p59457
aVOk, Synchronize and have a look-see at the windows that are visible in the tree
p59458
aVIf you see regular Windows Forms controls, like a Button or a Label, but not any of the SyncFusion controls then you've probably found the source of the problem
p59459
aVComponent vendors that try to improve
p59460
aVNET controls typically do so by creating 'window-less' controls
p59461
aVThey are not really controls, they don't derive from the Control class and don't have a Handle property
p59462
aVThey use the surface of the parent to draw themselves, making them look just like controls
p59463
aVThe
p59464
aVNET ToolStripItem classes do this
p59465
aVAnd this is also the approach WPF uses
p59466
aVThe big advantage is that they render quickly and support all kinds of effects that regular controls can't support, like transparency, rotation and anti-aliased window edges
p59467
aVThe big disadvantage is that the kind of tool that you are using suddenly gets noddy and can't find the control back
p59468
aVBecause they work by finding the Windows window back on your form, there is no window for them
p59469
aVThis is a hard problem to solve, the 'control' exists only in memory and there's no good way for a tool to find it back
p59470
aVUsing Accessibility is about the only other way for such a tool to find a control that I can think of
p59471
aVWhich would have to be implemented by the control vendor first, a somewhat obscure feature that gets easily overlooked
p59472
aVYou really do need the help of the vendor to find a workaround for this
p59473
aVShouldn't be a problem, that's why you paid them the big money
p59474
as(dp59475
g9
V17034
p59476
stp59477
a((dp59478
g2
(lp59479
VJust download
p59480
aVNET 3
p59481
aV5 SP1, it covers all the previous service packs and security updates
p59482
aVThe download is here
p59483
aVThis gets you a small bootstrapper that then figures out what additional updates need to be installed on your machine
p59484
aVThe amount of time this will take is quite unpredictable
p59485
aVIt could take quite a while (hundreds of megabytes) if you haven't used Windows Update to keep your machine up to date
p59486
aVYou definitely ought to consider downloading the free Express edition of Visual Studio for the language that you are interested in
p59487
aVThis will get you going a lot quicker
p59488
aVThe current edition for the Express version is VS2010, it will actually install
p59489
aVNET 4
p59490
aV0 on your machine
p59491
as(dp59492
g9
V17034
p59493
stp59494
a((dp59495
g2
(lp59496
VRundll32
p59497
aVexe uses LoadLibrary() to load the executable image
p59498
aVThis is not likely to work out well for an EXE, it doesn't expect to get loaded on an address that's that not its default
p59499
aVWhich is guaranteed to happen, rundll32
p59500
aVexe already occupies that default address
p59501
aVNot sure if you could tinker with the linker so that it doesn't omit the relocation records
p59502
aVBut don't bother with this approach, just create a DLL instead of an EXE
p59503
aVAnd pass real arguments to MessageBox()
p59504
aVAnd, yes, use a
p59505
aVdef file to rename the exported function
p59506
as(dp59507
g9
V17034
p59508
stp59509
a((dp59510
g2
(lp59511
VLook in the c:\u005cwindows\u005cmicrosoft
p59512
aVnet\u005cframework\u005cv2
p59513
ag2512
aV50727 folder
p59514
aVThere should be one or more numbered subdirectories that contains cscompui
p59515
aVdll, the resource file for the C# compiler
p59516
aVThe number is what matters, 1033 is the language id (LCID) for en-US
p59517
aVInstalling the language pack for the
p59518
aVNET framework should fix your problem
p59519
aVThe download for 3
p59520
aV5 SP1 is here, change the Language to get the right one
p59521
aVThe link I gave you ought to be good for English
p59522
aVIf you get a readme
p59523
aVhtm then switch the machine back to Russian before you try again
p59524
as(dp59525
g9
V17034
p59526
stp59527
a((dp59528
g2
(lp59529
VThere is no point in using BeingReceiveFrom() and then wait for the asynchronous operation to complete
p59530
aVJust use ReceiveFrom()
p59531
aVNow you don't need that 'StateObject' anymore either to let the callback know what request the response belongs to
p59532
as(dp59533
g9
V17034
p59534
stp59535
a((dp59536
g2
(lp59537
VA delegate has two relevant properties, Method and Target
p59538
aVThe Target will be non-null if the delegate was created for an instance method
p59539
aVAnd that keeps the object alive, as long as the garbage collector can see the delegate instance
p59540
aVNative code is relevant to having problems with callbacks
p59541
aVWhen you pass a delegate instance to a pinvoked native function then the P/Invoke marshaller will use Marshal
p59542
aVGetFunctionPointerForDelegate() to create a little stub that produces the required Target reference when the native code makes the callback
p59543
aVThe garbage collector however can not see this stub and therefore won't find a reference to the delegate object
p59544
aVAnd collects it
p59545
aVThe next callback from the native code produces a crash
p59546
aVTo avoid this, you must store the delegate object yourself so that it stays referenced for as long as the native code can make the callback
p59547
aVStoring it in a static variable is an obvious solution
p59548
as(dp59549
g9
V17034
p59550
stp59551
a((dp59552
g2
(lp59553
VIt is not that clear what 'used as activex' might mean
p59554
aVIf that means your component is getting used in another, non
p59555
aVNET program then this has an explanation
p59556
aVThe code for the native ListView control, wrapped by the
p59557
aVNET ListView class, is stored in comctl32
p59558
aVdll
p59559
aVThere are two versions of that DLL, one in c:\u005cwindows\u005csystem32, another in in the Windows side-by-side cache (c:\u005cwindows\u005cwinsxs\u005cetc
p59560
aVThe one in system32 is a legacy version, used by old programs
p59561
aVUsing the side-by-side version requires the program telling Windows that it wants to use the latest version, not the legacy one
p59562
aVThese versions don't behave the same, seeing different behavior in the way they select items could certainly be explained by this
p59563
aVYou are subject to what this program is telling Windows
p59564
aVThis is typically done by including a manifest but that's not a realistic option
p59565
aVIt is very likely to break the program when it gets a version of comctl32
p59566
aVdll that it was never tested with
p59567
aVThe programmatic way is CreateActCtx(), you'd have to pinvoke it before you create the ListView control
p59568
aVThis API function is not exactly easy to use
p59569
aVDo consider if you really want to make your list view behave differently from any other list view that this program might be using
p59570
as(dp59571
g9
V17034
p59572
stp59573
a((dp59574
g2
(lp59575
VI verified
p59576
aVWorks fine in VS2010 and VS2008, targeting
p59577
aVNET 4
p59578
aV0 and 3
p59579
aV5 SP1
p59580
aVChecklist:
p59581
aVMake sure to restart VS after using Control Panel + System to edit the registry
p59582
aVDon't forget to provide an app
p59583
aVexe
p59584
aVconfig file with the  element
p59585
aVBeware that app
p59586
aVvshost
p59587
aVexe
p59588
aVconfig is used when you debug
p59589
aVUse fuslogvw
p59590
aVexe to trace the failed bind
p59591
aVMake sure it reports the correct DEVPATH
p59592
aVPost the trace in your question if this doesn't help
p59593
as(dp59594
g9
V17034
p59595
stp59596
a((dp59597
g2
(lp59598
VYou can't, Mutex is a wrapper around a native Windows handle
p59599
aVWindows obfuscate handle values to prevent anybody from peeking at the internal kernel structures
p59600
aVAdd instrumentation to your code
p59601
aVEasy enough to store the value of the thread's ManagedId or Name every time you acquire the mutex
p59602
aVLogging is often useful to troubleshoot threading problems, although it is dangerous since it affects timing of the threads so much
p59603
aVThe VS2010 Ultimate edition has a slick addon named Concurrency Visualizer
p59604
as(dp59605
g9
V17034
p59606
stp59607
a((dp59608
g2
(lp59609
VThis is the kind of code you'll find back in the
p59610
aVNET framework
p59611
aVIt is rather important there, source code is (was) not readily available
p59612
aVIf the argument check were not included, you'd get an exception that is hard to diagnose
p59613
aVIt bombs on invisible code, concluding that the argument was wrong is not exactly easy
p59614
aVThis is less of a concern with code that you write
p59615
aVBut not absent, it depends on who will be the end-user of the code
p59616
aVIf that is you, and you maintain the code, then you'll have little trouble diagnosing the cause
p59617
aVIf it is somebody else then it becomes important that they have ready access to an accurate copy of the source code as well
p59618
aVIf that is muddled at all then don't hesitate to include the check
p59619
aVAnother consideration is what happens when you deploy the Release build of your code
p59620
aVWithout the throw statement, it is quite likely that this particular code will be inlined
p59621
aVIn other words, you won't see the GetItem() method on the top of the stack
p59622
aVThis can make finding the real source of the exception more difficult, especially since release stack traces don't have line numbers
p59623
aVThen the cost is relevant
p59624
aVIt is quite low in this case, maybe a nanosecond or two if the Count property is cheap enough
p59625
aVBut the actual work done by the method is very cheap as well
p59626
aVYour test makes it easily 20% slower
p59627
aVIt is the kind of method that could very well live deeply nested on the critical path of the program
p59628
aVThe more the method does, the less relevant the extra test becomes
p59629
as(dp59630
g9
V17034
p59631
stp59632
a((dp59633
g2
(lp59634
VDrop a Timer, ProgressBar and a BackgroundWorker on the form
p59635
aVFirst thing you'll want to do is to prevent the form from getting visible when the program is started
p59636
aVPaste this code into the form class:
p59637
aVUse the timer to get the job started
p59638
aVSet its Interval and Enabled properties, add the Tick event handler:
p59639
aVThat makes the form visible when the job is started and starts the background worker
p59640
aVSet the BGW's WorkerReportsProgress property to True and add the 3 event handlers:
p59641
aVIt is up to you to fill in the code for the DoWork event handler
p59642
aVHave it do those 15 jobs, be sure to call BackgroundWorker1
p59643
aVReportProgess so that the progress bar gets updated
p59644
aVWhich is what the ProgressChanged event handler does
p59645
aVThe RunWorkerCompleted event handler hides the form again
p59646
aVYou can call the Show() method in the context menu item event for the NotifyIcon so that the user can make your form visible again
p59647
aVCall Application
p59648
aVExit() in the context menu item that allow the user to quit your app
p59649
aVMake sure you disable that when the BGW is running
p59650
aVOr implement a way to cleanly stop the job
p59651
as(dp59652
g9
V17034
p59653
stp59654
a((dp59655
g2
(lp59656
VYour exception handler in the Main() method will never run
p59657
aVThe Dispatcher
p59658
aVUnhandledException handler will prevent app
p59659
aVRun() from exiting due to an exception
p59660
aVYou set e
p59661
aVHandled = true in the event handler
p59662
aVDon't make it silent, let the user know something went kaboom
p59663
aVThe "unhandledInstalled" variable is strange btw
p59664
aVYou installed one, it is always true
p59665
aVIf the code crashes before the try block then there's no reason to try to do something meaningful, something really bad happened
p59666
as(dp59667
g9
V17034
p59668
stp59669
a((dp59670
g2
(lp59671
VStandard bat-signal sign of violating threading requirements
p59672
aVDon't mess with controls in a worker thread
p59673
as(dp59674
g9
V17034
p59675
stp59676
a((dp59677
g2
(lp59678
VWell, simple, CreateInstanceAndUnwrap() makes the thread cross the AppDomain barrier
p59679
aVAfter all, the created object exists in the AD, the thread must make the transition in order to call the constructor
p59680
aVAdditional crossing happen when you then make calls through the proxy to call the class methods
p59681
aVAnd AppDomain is not a barrier for code, it isolates data
p59682
aVEach AD has its own GC and loader heap
p59683
aVSerialization is required to cross that data barrier
p59684
aVBut it is the exact same thread to deserializes again and continues execution
p59685
aVWhich is quite distinct from marshaling between processes, that has to happen between two distinct threads
p59686
aVWith the considerable overhead of marshaling between distinct virtual memory views and the required thread context switch
p59687
aVAn AD is a much cheaper version of a process
p59688
as(dp59689
g9
V17034
p59690
stp59691
a((dp59692
g2
(lp59693
VGet used to it because that what it takes
p59694
aVOpenFileDialog is not written in WPF, the dialog exists as unmanaged code inside Windows
p59695
aVThe managed wrapper uses GetOpenFileName() on legacy versions, the IFileOpenDialog COM interface on current ones
p59696
aVFor the latter one, the IFileDialogCustomize interface was designed to customize the dialog
p59697
aVThese interfaces are only easy to use from a C++ program, a classic scourge of shell programming
p59698
aVHaving to support XP machines is a considerable headache as well, realistically you are stuck with the legacy dialog through GetOpenFileName()
p59699
aVWhich is what that code project does
p59700
as(dp59701
g9
V17034
p59702
stp59703
a((dp59704
g2
(lp59705
VThere is no such documentation, it is all pretty straightforward
p59706
aVIt is completely up to you to decide when to call DeleteObject()
p59707
aVAnd to decide how to balance resource usage of your program against dynamically creating and destroying the object when needed
p59708
aVOnly largish bitmaps are really worthy to keep around
p59709
aVPens and brushes are very cheap, you create and destroy them on-the-fly
p59710
aVFonts are a corner case, often cached simply for the live of the program since you need so few of them
p59711
aVThere are plenty of ways to manage caching, a shared_ptr<> in C++ provides the standard reference counting pattern for example
p59712
aVBut it is very typical to just keep the reference as a member of your window wrapper class
p59713
aVIt isn't very common that the same bitmap would be used in multiple windows
p59714
aVYmmv
p59715
aVCreating GDI objects doesn't require a message loop
p59716
as(dp59717
g9
V17034
p59718
stp59719
a((dp59720
g2
(lp59721
VWriting a wrapper in C++/CLI isn't that likely to be faster, the COM interop marshaller in the CLR is heavily optimized
p59722
aVIt auto-generates machine code stubs from the interop library that you create when you add a reference to the COM server
p59723
aVA does a lot more work that's pretty invisible and very hard to do yourself, related to exceptions
p59724
aVIt makes sure that failure HRESULTs are properly converted to managed exceptions and that managed exceptions cannot leak into the COM server code
p59725
aVThe "make it fast" resolve you'll have when you do this will make you cut corners like this
p59726
aVNow you've got something that's fast but unreliable
p59727
aVGetting a managed exception in unmanaged code is brutally hard to diagnose, all the context is gone
p59728
aVOptions 1 and 3 are the same thing
p59729
aVBoth generate the interop library, the IDE simply runs the equivalent of Tlbimp for you
p59730
aVThe usual guidance applies here
p59731
aVDo the simple thing first, the interop library is incredibly simple
p59732
aVOnly contemplate doing the really hard thing when you can actually measure perf problems and have a realistic idea what to do about it
p59733
aVI've never once seen anybody decide that a C++/CLI wrapper was necessary
p59734
as(dp59735
g9
V17034
p59736
stp59737
a((dp59738
g2
(lp59739
VUgh, what kind of idiot management team gives a new machine to a manager instead of a programmer
p59740
aVControl Panel + Display, Advanced tab, change the DPI setting to repro the problem on your XP machine
p59741
aVRead the docs for the Form
p59742
aVAutoScaleMode to find out what's going on
p59743
as(dp59744
g9
V17034
p59745
stp59746
a((dp59747
g2
(lp59748
V"Made before runtime" is very unclear, I'll assume you used the designer and changed properties in the Property grid window
p59749
aVIn the Solution Explorer window, click the "Show All Files" icon
p59750
aVThat shows a node next to your form, open it and double-click the Designer
p59751
aVvb file
p59752
aVScroll down to the InitializeComponent method, you'll see code that was generated by the designer to initialize the chart control
p59753
aVCopy and paste this code into your own method
p59754
aVThat gives you a major running start on the code you need to configure the chart yourself at runtime
p59755
as(dp59756
g9
V17034
p59757
stp59758
a((dp59759
g2
(lp59760
VIt hasn't gone away, you've just got another way to save the document
p59761
aVSave2() takes an extra argument, CompatibilityMode
p59762
aVIf you don't care about the compatibility mode then just keep using Save()
p59763
aVIf you do then check Application
p59764
aVVersion to verify that you can call Save2() without getting an exception
p59765
as(dp59766
g9
V17034
p59767
stp59768
a((dp59769
g2
(lp59770
VThat method uses an embedded resource named XmlCharType
p59771
aVbin, you can see it with Reflector
p59772
aVIt is used by System
p59773
aVXml
p59774
aVXmlCharType
p59775
aVget_Instance() to initialize the charProperties pointer
p59776
aVThat same resource is present in 3
p59777
aV5 as well, you could use it the same way
p59778
aVOr take the lesser 3
p59779
aV5 approach:
p59780
as(dp59781
g9
V17034
p59782
stp59783
a((dp59784
g2
(lp59785
VThe ReadingChanged event is raised on another thread
p59786
aVYou can not touch UI components directly, you must marshal a call back to the main thread
p59787
aVUse Dispatcher
p59788
aVBeginInvoke(), it is well described in this MSDN library article
p59789
as(dp59790
g9
V17034
p59791
stp59792
a((dp59793
g2
(lp59794
VIt isn't handled by Windows messages, even though a message loop is required to make it work
p59795
aVClassic COM requirement
p59796
aVStart reading at RegisterDragDrop() to see the plumbing
p59797
aVNotable is that the UIPI aspect of UAC gets in the way, you cannot D+D from a non-elevated process to an elevated one
p59798
aVChangeWindowsMessageFilter() is the usual workaround, it doesn't work for D+D
p59799
aVNo know workaround
p59800
as(dp59801
g9
V17034
p59802
stp59803
a((dp59804
g2
(lp59805
VThis is not a real problem, the WaitOne() call automatically resets the event
p59806
aVAfter all, you used an AutoResetEvent, not a ManualResetEvent
p59807
aVKey phrase here is Auto Reset
p59808
aVSeeing it steaming right through the WaitOne() call is pretty normal too
p59809
aVYou've got a nice multiple core CPU, the thread got started right away when you called Start() and didn't take but a few microseconds to get the job done
p59810
aVMilliseconds, whatever, faster than the blink of your eye
p59811
aVPerhaps more to the point, you just don't need a thread here
p59812
aVStarting one, then waiting for it to finish is pointless
p59813
aVJust call the DoSomeOtherStuff() directly
p59814
as(dp59815
g9
V17034
p59816
stp59817
a((dp59818
g2
(lp59819
VYou'll get that when sync
p59820
aVInvokeRequired is false
p59821
aVThat's not good, it should be true
p59822
aVSet a breakpoint on action(); and find out what is going on when you get the break
p59823
aVThis is the kind of code that you'd use while the form is being shown, InvokeRequired is false when the form's Handle isn't created yet
p59824
aVMake sure this code doesn't run too soon, you'll have to wait until either the form's OnHandleCreated() method runs or the Load event fires, whichever is easier to override
p59825
aVAnother simple fix is to just not test InvokeRequired, you know it should always be true since you're running this on a worker thread
p59826
aVUse BeginInvoke, not Invoke and the lambda won't run until the UI thread re-enters the message loop, after the form is created
p59827
aVAnd the ultimate fix, no point in burning up a thread just to fade a form, use a winforms Timer
p59828
aVSaves you a megabyte
p59829
as(dp59830
g9
V17034
p59831
stp59832
a((dp59833
g2
(lp59834
VThis was something that was done 20 years ago, before freely scalable outline font technologies like TrueType became available
p59835
aVSome of these fonts are still on your machine, the
p59836
aVfon files in c:\u005cwindows\u005cfonts
p59837
aVThey actually contain bitmaps of the letters in the font, usually around 256 of them for each individual font height supported by the font
p59838
aVSupport for these fonts is not present in
p59839
aVNET so don't consider creating one of them
p59840
aVIn general, the disadvantages of not using a TrueType font are:
p59841
aVonly available in certain point sizes
p59842
aVno decent Unicode support
p59843
aVdifferent code pages require different fonts
p59844
aVno support for kerning and glyph overhang
p59845
aVno anti-aliasing support
p59846
aVno ClearType support
p59847
aVTools are available to create your own TrueType font
p59848
aVIt is not exactly easy to get right, one of the things that makes TrueType shine is 'hinting', altering the letter shapes when they font is rendered at small point sizes so that they are still legible
p59849
aVVerdana is a exemplary font that is hinted extraordinarily well
p59850
aVAnyhoo, to pursue your approach you'll need to create a bitmap that contains all the letters that you are willing to support, arranged horizontally for example
p59851
aVThe best way to order them is to pick the letters in a code page that's close to you, like Windows 1252 which is common in Western Europa and the Americas
p59852
aVThings are simple if the font is fixed-pitched, every letter will start at a multiple of the letter width
p59853
aVA proportionally spaced font requires a separate lookup table that specifies at what pixel offset each letter starts
p59854
aVUsing System
p59855
aVDrawing for example, you'd use the Graphics
p59856
aVDrawImage(image, rectangle, rectangle, graphicsunit) overload where you setup the rectangles so that the letter you want to render is copied
p59857
aVUse Encoding
p59858
aVGetBytes() to convert the string to render to indices in your font bitmap
p59859
as(dp59860
g9
V17034
p59861
stp59862
a((dp59863
g2
(lp59864
VI trust that you're not actually talking about properties but a collection of name-value pairs
p59865
aVThat's covered by the Dictionary<> class
p59866
aVThe ExpandoObject class, available in
p59867
aVNET 4
p59868
aV0 is perhaps worth mentioning
p59869
as(dp59870
g9
V17034
p59871
stp59872
a((dp59873
g2
(lp59874
VI've got trouble tying a rope to this question
p59875
aVBut in any kind of lookup scenario, you always want to use a Dictionary
p59876
aVYou'll get O(1) time instead of O(n)
p59877
aVSomething like this:
p59878
aVYou can make the initialization cleaner in many ways
p59879
aVThen:
p59880
as(dp59881
g9
V17034
p59882
stp59883
a((dp59884
g2
(lp59885
VPOS printers are almost exclusively used in their native dot-matrix mode
p59886
aVYou send the strings to print directly to the printer, bypassing the printer driver
p59887
aVThe font you'll get is the one that's baked into the printer's firmware
p59888
aVTypically mono-spaced and optimized to work well with the rather restricted output capabilities of a typical POS printer
p59889
aVThe code you need is in this KB article
p59890
aVWhen you use the printer driver, the printer is switched into graphics mode by the driver
p59891
aVThat makes them very slow
p59892
as(dp59893
g9
V17034
p59894
stp59895
a((dp59896
g2
(lp59897
VThe CD signal (Carrier Detect) will turn off
p59898
aVNamed RLSD in GetCommModemStatus() and WaitCommEvent()
p59899
aVThat's the moral equivalent of std::bad_alloc when you work with a modem
p59900
as(dp59901
g9
V17034
p59902
stp59903
a((dp59904
g2
(lp59905
VIt can't, services are isolated in session 0 and cannot interact with the user
p59906
aVGoogle "session 0 isolation" to learn more
p59907
aVTrusting the Windows logon to be a reliable and time-tested source of authentication jumps to mind
p59908
as(dp59909
g9
V17034
p59910
stp59911
a((dp59912
g2
(lp59913
VThey all use the same approach, they simply create a window without a border and caption bar
p59914
aVThen draw their own, styling it the way they want to
p59915
aVIt is easy to tell, the Close button in the upper right corner is always subtly off
p59916
aVSometimes intentionally of course
p59917
aVNo native API coding is required to do this
p59918
aVBut overriding WndProc() can be handy to recover some of the functionality that's lost when you omit the caption bar and a resizable border
p59919
aVGoogle WM_NCHITTEST to find sample code, there's plenty here as well
p59920
aVIn general, watch out doing this
p59921
aVThese kind of custom styled windows are often featured in GUI Blooper lists
p59922
aVThis one is my favorite example
p59923
aVOn the same page, this one is a classic trap
p59924
as(dp59925
g9
V17034
p59926
stp59927
a((dp59928
g2
(lp59929
VThe address space does not get randomized after the process is started
p59930
as(dp59931
g9
V17034
p59932
stp59933
a((dp59934
g2
(lp59935
VYou need to include the Windows header file
p59936
aVFix:
p59937
as(dp59938
g9
V17034
p59939
stp59940
a((dp59941
g2
(lp59942
VYou can pinvoke SetParent(), the child window handle should be the Process
p59943
aVMainWindowHandle of Calc, the parent window should be the handle of the window in which you want to embed it
p59944
aVForm
p59945
aVHandle gives you that value
p59946
aVYou'll also need MoveWindow to get the window in the right place
p59947
aVUse pinvoke
p59948
aVnet to get the required pinvoke declarations
p59949
as(dp59950
g9
V17034
p59951
stp59952
a((dp59953
g2
(lp59954
VThe code assumes a different coordinate system, note that topEdge is larger than bottomEdge in the linked web page
p59955
aVYour test works with normal graphics coordinates where Bottom is larger than Top
p59956
aVYou have to swap the bottom and top arguments
p59957
as(dp59958
g9
V17034
p59959
stp59960
a((dp59961
g2
(lp59962
VSimple, have the method return a bool
p59963
aVThen you can do:
p59964
as(dp59965
g9
V17034
p59966
stp59967
a((dp59968
g2
(lp59969
VYes, you cannot leave it like this
p59970
aVThis will fail when you deploy your program on a machine that has UAC enabled or runs with a non-admin user account
p59971
aVYou won't have write privileges to the directory in which your EXE is stored
p59972
aVReview Environment
p59973
aVGetFolderPath() to find one of the appdata folders that you'll have write access to
p59974
as(dp59975
g9
V17034
p59976
stp59977
a((dp59978
g2
(lp59979
VThey keyboard message is dispatched to the window with the focus
p59980
aVThat will not be your main window, the combobox sees it
p59981
aVThis is normally handled by the dialog box logic built into Windows but you probably didn't create a dialog
p59982
aVNot sure how far you want to go with this, any class library handles this for you, primarily by sub-classing the controls and looking for navigation keys in the message loop, before dispatching the message
p59983
as(dp59984
g9
V17034
p59985
stp59986
a((dp59987
g2
(lp59988
VWrong ContextFlags value, you need CONTEXT_ALL to include CONTEXT_DEBUG_REGISTERS
p59989
as(dp59990
g9
V17034
p59991
stp59992
a((dp59993
g2
(lp59994
VAll three controls you list already have the ControlStyles
p59995
aVSupportsTransparentBackColor style turned on
p59996
aVJust set the BackColor property in the designer, Web tab
p59997
aVIt is very unclear why that's not good enough for you
p59998
aVIt is otherwise an illusion, Windows Forms implements it by asking the Parent control to draw itself in the OnPaintBackground() method so it provides the background pixels
p59999
aVOne notable thing that doesn't work is overlapping controls
p60000
aVYou only see the Parent pixels, not the pixels of the overlapped control
p60001
aVThat's fixable but the code is fugly
p60002
aVThe only other transparency option is Form
p60003
aVTransparencyKey
p60004
aVThat's true transparency, implemented by using overlays in the video adapter
p60005
aVProblem is that this only works on toplevel windows
p60006
aVForms, not controls
p60007
aVThese restrictions are inherent in the Windows Forms rendering model, using individual windows for the controls
p60008
aVA web browser doesn't have that same restriction, it emulates controls by drawing them
p60009
aVLayers of paint, that makes transparency trivial by just not painting
p60010
aVWPF uses that rendering model as well
p60011
as(dp60012
g9
V17034
p60013
stp60014
a((dp60015
g2
(lp60016
VYou never initialized the p_Students field, it is Nothing and causes the exception
p60017
aVFix:
p60018
aVNote the New keyword
p60019
aVThat's the quick fix, a more sane approach would be:
p60020
as(dp60021
g9
V17034
p60022
stp60023
a((dp60024
g2
(lp60025
VThe gzip file format is an archive format, it contains a header and a directory that lists all of the compressed files in the archive
p60026
aVGZipStream merely compresses data written to the stream
p60027
aVThe equivalent of one file in the archive, it is not capable of generating the archive format
p60028
aVA popular solution is SharpZipLib, there are many others
p60029
as(dp60030
g9
V17034
p60031
stp60032
a((dp60033
g2
(lp60034
VThe problem is in your other code, the 'client'
p60035
aVIt closes the connection after sending all the 'packets'
p60036
aVYou must wait until the server has received all of them
p60037
aVA simple approach, beyond negotiating it explicitly, is to wait for the server to close the connection
p60038
as(dp60039
g9
V17034
p60040
stp60041
a((dp60042
g2
(lp60043
VUse the string
p60044
aVIndexOf(string, int) overload
p60045
aVStart with the startIndex argument at 0, you'll get the index of the first match
p60046
aVLoop, now pass that found index+1 for the argument
p60047
aVIf you want to stick with Regex then use the Match
p60048
aVIndex property
p60049
as(dp60050
g9
V17034
p60051
stp60052
a((dp60053
g2
(lp60054
VBy using a Timer of course
p60055
aVFor example:
p60056
as(dp60057
g9
V17034
p60058
stp60059
a((dp60060
g2
(lp60061
VIt is an option
p60062
aVTools + Options, Windows Forms Designer, General, AutoToolboxPopulate must be set to True
p60063
as(dp60064
g9
V17034
p60065
stp60066
a((dp60067
g2
(lp60068
VUse BitConverter
p60069
aVGetBytes():
p60070
as(dp60071
g9
V17034
p60072
stp60073
a((dp60074
g2
(lp60075
VYou definitely want to allocate the array before you start looping, you'll want to use the results after you're done
p60076
aVAnd you ought to do something meaningful when the pixel isn't white or black
p60077
aVSomething like this:
p60078
aVNot sure about the lifetime of the bitmap, you ought to call objBitmap
p60079
aVDispose() somewhere
p60080
aVLeverage the using statement
p60081
as(dp60082
g9
V17034
p60083
stp60084
a((dp60085
g2
(lp60086
VIt is very important that values that are Equal also produce the same hash code
p60087
aVAn obvious (but not necessarily efficient) workaround is this:
p60088
aVMaking strings not behave as Unicode strings internally is a a code smell but possibly intentional here
p60089
aVIt is normally applied at the outer interface
p60090
aVYour implementation would allow for the encoding to change after the string is read
p60091
aVBut a really serious problem with that is that the dictionary is no longer valid when that happens
p60092
aVYou won't be able to find keys back
p60093
as(dp60094
g9
V17034
p60095
stp60096
a((dp60097
g2
(lp60098
VSee that scrollbar on the right
p60099
aVClick and drag it down
p60100
aVIn case you're getting way too tired: it isn't PrintDialog
p60101
aVDocument, it is PrintDialog
p60102
aVPrintDocument
p60103
aVTake a break, have a beer, kiss the girl
p60104
aVAnd, yes I completely agree, WPF sux for completely unnecessary property name changes
p60105
aVYou linked the wrong MSDN article
p60106
as(dp60107
g9
V17034
p60108
stp60109
a((dp60110
g2
(lp60111
VThe registry hackers move virtual keys around
p60112
aVWhat you need is a custom keyboard layout
p60113
aVYou can create your own with this tool
p60114
as(dp60115
g9
V17034
p60116
stp60117
a((dp60118
g2
(lp60119
VYou got the wrong impression
p60120
aVYes, while you are testing your program, you'll indeed see most time being spent inside the Parse() and builder
p60121
aVBecause that is the only code that does any real work
p60122
aVBut that's not going to be this way in production
p60123
aVThen all the time will be spent in the StreamReader
p60124
aVBecause the file won't be present in the file system cache like it is when you run your program over and over again on your dev machine
p60125
aVIn production, the file has to be read off a disk drive
p60126
aVAnd that's glacially slow, disk I/O is the true bottleneck of your program
p60127
aVMaking the parsing twice as fast will only make your program a few percent faster, if at all
p60128
aVDon't compromise the reliability or maintainability of your code for such a small gain
p60129
as(dp60130
g9
V17034
p60131
stp60132
a((dp60133
g2
(lp60134
VThis just doesn't work
p60135
aVIt is pretty inappropriate anyway, the resolution of the printer is much better than the resolution of your screen
p60136
aVThe screenshot looks very ugly on paper, especially text gets blobby with the anti-aliasing pixels becoming painfully obvious
p60137
aVBite the bullet and drop the PrintDocument component on the form
p60138
aVYou typically need to write a fair amount of code in the PrintPage event handler
p60139
aVBut it isn't hard code and it will look great and you can make it look just the way you want it
p60140
aVBe sure to make it look like a report, not a screenshot
p60141
aVUse PrintPreviewDialog to avoid wasting a lot of paper
p60142
aVReport generators like RDLC and Crystal Reports are common solutions as well
p60143
as(dp60144
g9
V17034
p60145
stp60146
a((dp60147
g2
(lp60148
VThe specific rule is that you cannot call a Windows API function that uses the Handle of a window
p60149
aVIt isn't exactly obvious whether or not using a property or calling a method of a control will end up making such an API call
p60150
aVThe MSDN docs lists only 4 of them as always safe to use: InvokeRequired, Invoke(), BeginInvoke() and CreateGraphics()
p60151
aVBut yes, sometimes a property value is available and doesn't require an API call
p60152
aVThe Text property is a good example
p60153
aVIt is cached because it is used so often
p60154
aVReading the Text property doesn't generate an exception, you just get cached value
p60155
aVBut writing the Text property goes kaboom, updating the text on the screen requires an API call
p60156
aVListView
p60157
aVVirtualSize works the exact same way
p60158
aVYou don't get the exception but it is still not kosher
p60159
aVAfter all, the UI thread might change the Text property as well, a microsecond later
p60160
aVYou'll get a stale value, a classic threading problem known as a race condition
p60161
as(dp60162
g9
V17034
p60163
stp60164
a((dp60165
g2
(lp60166
VThey are not compiler errors, they are linker errors
p60167
aVSomething is very broken in the way you build this, you are linking the wrong version of the CRT
p60168
aVEven the new and delete operators are undefined, suggesting that you don't link the CRT at all
p60169
aVVery hard to do when you use the MSVC compiler
p60170
aVDocument how you build this if that didn't help
p60171
as(dp60172
g9
V17034
p60173
stp60174
a((dp60175
g2
(lp60176
VNo programming is required
p60177
aVCreate a shortcut to your program on the desktop
p60178
aVRight-click it, Properties, Layout tab
p60179
aVAdjust the Width property of the screen buffer and window size
p60180
aVBut you can do it programmatically too, those Windows API functions you found are wrapped by the Console class as well
p60181
aVFor example:
p60182
as(dp60183
g9
V17034
p60184
stp60185
a((dp60186
g2
(lp60187
VYou can fix this with Configuration Properties + General, Output Directory setting
p60188
aVChange it to
p60189
aV$(SolutionDir)Bin\u005c$(ConfigurationName)
p60190
aVAnd leave the linker setting as-is
p60191
aVThis setting change modifies the value of $(OutDir) and keeps MSBuild happy
p60192
as(dp60193
g9
V17034
p60194
stp60195
a((dp60196
g2
(lp60197
VForms are never a problem, you can send them off to a localization service and they'll translate it for you for very little money
p60198
aVThere might be some iterations to get the details right, heavily dependent on how 'technical' the UI is
p60199
aVThe hard ones are places in your code where you've hard-coded a string literal
p60200
aVOr implicitly counted on number formatting to be predictable with a comma for a decimal point for example
p60201
aVOnly you can fix that and only you can estimate the amount of work it will take
p60202
as(dp60203
g9
V17034
p60204
stp60205
a((dp60206
g2
(lp60207
s(dp60208
g9
V17034
p60209
stp60210
a((dp60211
g2
(lp60212
VThe type of WebBrowser
p60213
aVDocument is HtmlDocument
p60214
aVIt doesn't have a Dispose() method
p60215
aVThe more likely source of the exception is the WebBrowser itself
p60216
aVIt has an IsDisposed property that you could use
p60217
aVHowever, I'd strongly recommend you go looking for the bug in the code instead of applying that bandaid
p60218
aVPerhaps a stray using statement
p60219
as(dp60220
g9
V17034
p60221
stp60222
a((dp60223
g2
(lp60224
VLooks to me like they are using exceptions to control program flow
p60225
aVSome note in the docs that it prevents the base class method from getting called
p60226
aVThat's pretty awful
p60227
aVThe
p60228
aVNET framework way to do this without exceptions is the HandledMouseEventArgs class, used by OnMouseWheel()
p60229
as(dp60230
g9
V17034
p60231
stp60232
a((dp60233
g2
(lp60234
VAvoid using exceptions to control program flow
p60235
aVUse the TreeViewCollection
p60236
aVIndexOfKey() method
p60237
aVThere's a strange bug on a 64-bit operating system when an exception is raised in the form's OnLoad() method or Load event and a debugger is attached
p60238
aVIt is swallowed without notification
p60239
aVSounds like a match
p60240
aVWorkaround is to set the Platform target to x86
p60241
as(dp60242
g9
V17034
p60243
stp60244
a((dp60245
g2
(lp60246
VYou are not doing anything obvious to set the hardware handshake signals
p60247
aVA serial port device almost always checks the RTS and DTR signals and won't send anything until they are active
p60248
aVShort from EscapeCommFunction to force them on, set the DCB
p60249
aVfDtrControl and fRtsControl members to turn on hardware handshaking
p60250
aVNot setting the basic communication properties like baudrate, parity, databits and stopbits leaves you open to failure as well if the defaults are not appropriate or were changed by another program
p60251
aVAnd do check that wiring is okay with a separate program like Putty or Hyperterminal
p60252
as(dp60253
g9
V17034
p60254
stp60255
a((dp60256
g2
(lp60257
VI think you'll want to use Project
p60258
aVProjectItems
p60259
aVAddFromTemplate() instead
p60260
aVNo trouble getting the right Project reference
p60261
as(dp60262
g9
V17034
p60263
stp60264
a((dp60265
g2
(lp60266
VI don't see anything special about that project
p60267
aVDo note that the solution and project need to be converted
p60268
aVWhen that happens, you'll end up targeting the
p60269
aVNET 2
p60270
aV0 framework
p60271
aVThat won't work out well, it has an assembly reference to WindowsBase, a 3
p60272
aV0 assembly
p60273
aVMake sure you update the target
p60274
as(dp60275
g9
V17034
p60276
stp60277
a((dp60278
g2
(lp60279
VYes, this is normal
p60280
aVAny GUI app is always executing GetMessageW(), waiting for Windows to send it a message
p60281
aVIt isn't actually burning CPU cycles doing this, just blocked on an internal synchronization object until some kind of UI event is signaled
p60282
aVThis of course makes profiling UI apps difficult, you really need unit tests that test the subcomponents of your app
p60283
as(dp60284
g9
V17034
p60285
stp60286
a((dp60287
g2
(lp60288
VJust some pointers, this is quite hard to get right
p60289
aVPass an RT_ICON by lying about the lpType argument
p60290
aVChange it from string to IntPtr and pass (IntPtr)3
p60291
aVThe lpData argument is quite tricky
p60292
aVYou need to pass the data the way it is compiled by the resource compiler (rc
p60293
aVexe)
p60294
aVI have no idea if it mangles the raw data of the
p60295
aVico file
p60296
aVThe only reasonable thing to try is to read the data from the
p60297
aVico file with FileStream into a byte[], you already seem to be doing this
p60298
aVI think the function was really designed to copy a resource from one binary image to another
p60299
aVOdds of your approach working are not zero
p60300
aVYou are also ignoring another potential problem, the resource ID of the icon of the program isn't necessarily 1
p60301
aVIt often is not, 100 tends to be a popular choice, but anything goes
p60302
aVEnumResourceNames would be required to make it reliable
p60303
aVThe rule is that the lowest numbered ID sets the icon for the file
p60304
aVI'm not actually sure if that really means that the resource compiler puts the lowest number first, something that the API probably doesn't do
p60305
aVA very small failure mode is that UpdateResource can only updated numbered resource items, not named ones
p60306
aVUsing names instead of numbers is not uncommon but the vast majority of images use numbers for icons
p60307
aVAnd of course, the odds that this will work without a UAC manifest are zero
p60308
aVYou are hacking files that you don't normally have write access to
p60309
as(dp60310
g9
V17034
p60311
stp60312
a((dp60313
g2
(lp60314
VOf course the constructor gets executed first, pretty basic rule in any OOP language
p60315
aVWhether it will finish first is an open question
p60316
aVTechnically it is possible for the constructor to tinker with a Form class property that requires the Handle to be created
p60317
aVLike using the Handle property, to keep it simple
p60318
aVThat will trigger OnLoad and the Load event which will then run to completion before the constructor is completed
p60319
aVIt's rare but possible
p60320
as(dp60321
g9
V17034
p60322
stp60323
a((dp60324
g2
(lp60325
VJust in case Marc's comment wasn't explicit enough: no way in hell
p60326
aVThe assembly metadata format was changed in
p60327
aVNET 4
p60328
aV0, the 2
p60329
aV0 CLR doesn't know how to read it
p60330
aVYou got the 2
p60331
aV0 version of the CLR running in any
p60332
aVNET version between 2
p60333
aV0 RTM and 3
p60334
aV5 SP1
p60335
aVIt is trivial to fix with a Setup project, but it certainly does get in the way of staff that takes the "I like what I know" attitude
p60336
aVBreaking through that egg shell is a political problem, not a programming problem
p60337
aVGood luck doing the damage
p60338
as(dp60339
g9
V17034
p60340
stp60341
a((dp60342
g2
(lp60343
VYes, the "out" directory for the build system is distinct from the "out" directory for your test results
p60344
aVUse Assembly
p60345
aVGetExecutingAssembly()
p60346
aVLocation to get the path to your code
p60347
aVPath
p60348
aVGetDirectoryName on that helps you find the directory that the build system copied you
p60349
aVxml file to
p60350
as(dp60351
g9
V17034
p60352
stp60353
a((dp60354
g2
(lp60355
VNot sure what a ViewportController might be
p60356
aVHowever, the Draw() method is triggered by a Windows paint request
p60357
aVThat runs the Control
p60358
aVOnPaint() method, there is an override for it in the GraphicsDeviceControl class which causes Draw() to run
p60359
aVThe sample SpinningTriangleControl shows how you'd get a control to redraw itself repeatedly, what you'd need to get it animated:
p60360
aVNote the Control
p60361
aVInvalidate() method call, that's what eventually causes the OnPaint() method to run
p60362
aVUsing the Idle event ensures this is done over and over again but only if the main thread isn't otherwise busy with anything
p60363
aVThis isn't necessary for controls that show only static content, like the sample SpriteFontControl
p60364
aVAnother way to do it is to use a Timer with a short Interval, its Tick event handler can call Invalidate()
p60365
as(dp60366
g9
V17034
p60367
stp60368
a((dp60369
g2
(lp60370
VYou could hijack the StringCollectionEditor for a cheap solution:
p60371
aVBut actually checking the files or using an OFD is going to require you writing your own UITypeEditor
p60372
aVDo keep in mind that the paths of the files at design time is in no way representative for the paths they'll have when you deploy your project
p60373
as(dp60374
g9
V17034
p60375
stp60376
a((dp60377
g2
(lp60378
VPerformanceCounter is a very low cost way of retrieving this info
p60379
aVAs opposed to WMI which will give you the exact same info but with lots of overhead because it runs on top of COM
p60380
aVAnd it has the exact same problem as PC, which is why I'd guess you think it is 'stupid'
p60381
aVCPU usage percent is measured over an interval
p60382
aVActual CPU usage is either 0 or 100%, the CPU never runs intentionally at a lower rate
p60383
aVIt runs code at full bore when there's a thread that has work to do
p60384
aVIf there is no work to do, the normal state of your desktop machine, then the CPU is powered off with the HLT instruction
p60385
aVIt is woken up again with the clock interrupt
p60386
aVThe CPU usage percentage as shown in TaskMgr or Permon is a calculated value over one second
p60387
aVThe ratio of the amount of time it was running at 100% vs the amount of time it was turned off
p60388
aVThe interval length is very important
p60389
aVThe shorter you make it, the 'jumpier' the calculated value gets
p60390
aVDown to calling NextValue() twice in a row, you'll always get 100%
p60391
aVLong story short: you need a timer
p60392
aVMake it one second to emulate what you see in PerfMon and TaskMgr
p60393
as(dp60394
g9
V17034
p60395
stp60396
a((dp60397
g2
(lp60398
VTyping six file names, or using the declarative style with #pragma comment(lib, "foo
p60399
aVlib") is small potatoes compared to the work you'll have to do to turn this into a DLL or COM server
p60400
aVThe distribution is heavily biased towards using this as a static link library
p60401
aVThere are only spotty declarations available to turn this into a DLL with __declspec(dllexport)
p60402
aVThey exist only in the 3rd party dependencies
p60403
aVAll using different #defines of course, you'll by typing a bunch of names in the preprocessor definitions for the projects
p60404
aVFurthermore, you'll have a hard time actually getting this DLL loaded at runtime since you are using it in a COM server
p60405
aVThe search path for DLLs will be the client app's when COM creates your control instance, not likely to be anywhere near close to the place you deployed the DLL
p60406
aVMaking it a COM server is a lot of work, you'll have to write all the interface glue yourself
p60407
aVAgain, nothing already in the source code that helps with this at all
p60408
as(dp60409
g9
V17034
p60410
stp60411
a((dp60412
g2
(lp60413
VAlmost all CLR limits are based on "as memory permits"
p60414
aVThe only exception I know of is the number of members of a class, restricted to 65536
p60415
aVThat's based on the definition of a token value
p60416
aVNothing like that for AppDomains
p60417
as(dp60418
g9
V17034
p60419
stp60420
a((dp60421
g2
(lp60422
VHmya, you are trying to stuff a 32-bit pig in a 31-bit poke
p60423
aVThis code ends up calling Convert::ToInt32(UInt32 value) which looks like this:
p60424
aVKaboom
p60425
aVNot sure what kind of overflow behavior you want, but this lets the compiler do the ignoring and avoids the exception:
p60426
as(dp60427
g9
V17034
p60428
stp60429
a((dp60430
g2
(lp60431
VI think you found this in RealProxy
p60432
aVcs
p60433
aVThis looks like a search-and-replace mistake
p60434
aVThere are several places where the string appears:
p60435
aVLooking at the same code with Reflector, you see the literal value 0 being used
p60436
aVWhich means that Message
p60437
aVDunno must be a const value
p60438
aVThere's one good match for that, Message
p60439
aVSync is a private const with the value 0
p60440
aVGood match too with // NOTE: Keep this in sync, and // cannot support Async and end up doing a Sync call
p60441
aVThis used to say "Message
p60442
aVSync"
p60443
as(dp60444
g9
V17034
p60445
stp60446
a((dp60447
g2
(lp60448
VThis has changed between
p60449
aVNET 3
p60450
aV5SP1 and
p60451
aVNET 4
p60452
ag2512
aVNET 3
p60453
aV5 produces MMMM d,yyyy, same as the documented Vista NLS value
p60454
aVNET 4
p60455
aV0 produces MMMM-dd-yy
p60456
aVSame as what I get when I use GetLocaleInfo() on Win7 with:
p60457
aVI think
p60458
aVNET 4
p60459
aV0 is now using the Windows locale info instead of relying on its own tables
p60460
aVNevertheless, nothing changes as fast as culture data
p60461
aVIf you think this is incorrect then you can submit feedback at connect
p60462
aVmicrosoft
p60463
aVcom
p60464
as(dp60465
g9
V17034
p60466
stp60467
a((dp60468
g2
(lp60469
VThis is almost certainly what causes the problem
p60470
aVIt affects an internal timer, used by System
p60471
aVNet classes
p60472
aVNot exactly sure what it does, something to do with timeouts I think
p60473
aVThat timer creates a threadpool thread
p60474
aVAfter you change the value, the timer will create one thousand threadpool threads per second
p60475
aVClearly setting the value back doesn't change the timer after it was created
p60476
aVThe normal value for the property is 100000, a value of 1 was probably never ever tested
p60477
as(dp60478
g9
V17034
p60479
stp60480
a((dp60481
g2
(lp60482
VIt was the forerunner of ADO
p60483
aVNET
p60484
aVYou can still use it in a C# program, it would make the conversion a lot less painful
p60485
aVProject + Add Reference, COM tab, select "Microsoft ActiveX Data Objects 2
p60486
aV8 Library"
p60487
aVEarlier versions of Window might have 2
p60488
aV7
p60489
aVThe statements should convert about one-to-one
p60490
aVThe
p60491
aVNET equivalent are the classes in the System
p60492
aVData
p60493
aVOleDb namespace if you still work with Access databases
p60494
aVUsing them will require a fairly heavy rewrite
p60495
as(dp60496
g9
V17034
p60497
stp60498
a((dp60499
g2
(lp60500
VYou are going too fast
p60501
aVGet sqlConditionType
p60502
aVGetMethod() working first to get a MethodInfo so you can be sure this is not a method overload resolution problem
p60503
aVThe arguments you pass are smelly, particularly filename and sqlConditionTypeEnumType
p60504
aVGetField("Equal")
p60505
as(dp60506
g9
V17034
p60507
stp60508
a((dp60509
g2
(lp60510
VIt is disposing like gangbusters
p60511
aVThe StreamReader
p60512
aVDispose() will already dispose the file stream, FileStream
p60513
aVDispose() will shrug and not complain
p60514
aVIf there is any notable problem then it is File
p60515
aVOpenRead()
p60516
aVYou didn't specify a FileShare value, it will use FileShare
p60517
aVRead
p60518
aVWhich is pretty normal but that will fail when somebody else has the file opened for writing
p60519
aVYou cannot omit FileShare
p60520
aVWrite when somebody else already has acquired the right to write
p60521
aVThe SysInternals' Handle utility can be helpful to diagnose problems like this
p60522
as(dp60523
g9
V17034
p60524
stp60525
a((dp60526
g2
(lp60527
VHmya, that is not crystal clear unfortunately
p60528
aVOpenFileDialog and friends inherit Dispose() from the Component class
p60529
aVEvery component must implement Dispose() because the Dispose() method of the form calls it
p60530
aVIt just so happens to be that there are several Component derived classes that have a do-nothing Dispose() method
p60531
aVThe dialog classes are like that, they are dialogs
p60532
aVThey clean up any unmanaged resources when the dialog closes
p60533
aVNo additional help is needed
p60534
aVThis isn't exactly documented well
p60535
aVIt's somewhat visible, the MSDN Library shows that the method was inherited, not overridden by the class
p60536
aVWhich still doesn't make it obvious that bypassing the inherited Component
p60537
aVDispose() method is okay (it is)
p60538
aVIf you are uncomfortable with it, many programmers are, then don't hesitate to wrap it with the using statement
p60539
aVIt does no harm to call a Dispose() method that doesn't do anything
p60540
aVWell, not the kind of harm you'd be ever be able to measure
p60541
as(dp60542
g9
V17034
p60543
stp60544
a((dp60545
g2
(lp60546
VThis is not a known issue
p60547
aVTime to defrag your hard drive
p60548
as(dp60549
g9
V17034
p60550
stp60551
a((dp60552
g2
(lp60553
VDon't use MessageBox in a web application
p60554
aVIt will show up on the server console, there's nobody around to click the OK button
p60555
aVI assume that ASP
p60556
aVNET has some counter-measures against it, given that it is such a serious denial-of-service attack
p60557
as(dp60558
g9
V17034
p60559
stp60560
a((dp60561
g2
(lp60562
VThe uppercase identifiers are macros, they ensure that the COM interface function has the proper signature
p60563
aVA COM function that's compatible with automation must use the correct calling convention, __stdcall, and must return a long (an hresult) that indicates the error or success status
p60564
aVAdditional requirements are that the COM interface must implement IUnknown and that the function argument types should restrict themselves to automation compatible types
p60565
aVThe COM interop support in the CLR ensures that these requirements are met
p60566
aVIt generates a v-table for a C# interface that automatically implements IUnknown, you don't have to implement it yourself
p60567
aVThe HRESULT return value is automatically generated, it is mapped from an Exception
p60568
aVFunction arguments are automatically marshaled from their unmanaged type to the equivalent native type
p60569
aVThe argument type translation is a rather large topic and covered in any decent book about the subject (like Adam Nathan's)
p60570
aVSuffice it to say that any automation compatible type has a corresponding managed type
p60571
aVThe harder ones are object to VARIANT, string to BSTR and array to SAFEARRAY
p60572
aVYou use the [ComVisible] attribute in C# to create a COM server
p60573
aVSeveral other ones are relevant, like [Guid] and [InterfaceType]
p60574
aVThis is well covered in any examples
p60575
aVYou create the type library with Tlbexp
p60576
aVexe or, more commonly, with Regasm
p60577
aVexe /tlb
p60578
aVThe latter tool is the one that's required to register the server, you cannot use Regsvr32
p60579
aVexe anymore
p60580
as(dp60581
g9
V17034
p60582
stp60583
a((dp60584
g2
(lp60585
VThis is caused by the ImageList that stores these images
p60586
aVYou've left the ColorDepth property to the default, Depth8Bit
p60587
aVWhich forces Windows to convert these images with high color content (note the subtle gradient in the arrows for example) to a pixel format that can store only 256 distinct colors
p60588
aVThat's a lossy conversion and causes artifacts
p60589
aVChange the property to Depth32Bit
p60590
as(dp60591
g9
V17034
p60592
stp60593
a((dp60594
g2
(lp60595
VDo not use the Focus() method in an event handler that's called because of a focusing event, like Leave
p60596
as(dp60597
g9
V17034
p60598
stp60599
a((dp60600
g2
(lp60601
VNo, once you lose a GCHandle then you've lost it forever
p60602
aVThere is no notion of a 'handle to a handle' in the garbage collector
p60603
aVYou can only create a new GCHandle for an object, it will add an extra reference
p60604
aVThe object this lost handle references will be permanently referenced, it is a leak
p60605
aVNote that GCHandle is a struct type
p60606
aVThe idea of keeping objects pinned for any length of time is detrimental to your program's perf
p60607
aVShort from giving the GC a harder time to work around the obstacles, it also prevents it from compacting the heap properly
p60608
aVThis increases the likelihood of cache misses, very expensive on modern cores
p60609
aVThese side effects can last for a while
p60610
aVIf you need pinned memory then allocate it with Marshal
p60611
aVAllocCoTaskMem()
p60612
aVThis also stops you from creating pointers to managed data that has an unpredictable memory layout
p60613
aVLayout that differs between different versions of the JIT compiler and is highly dependent on the struct or class declaration
p60614
aVOnly Marshal
p60615
aVStructureToPtr() can give you hard guarantees
p60616
as(dp60617
g9
V17034
p60618
stp60619
a((dp60620
g2
(lp60621
VThere are apps to try to hack around the restrictions of the notification area (tray) API
p60622
aVThey'll hook the Explorer window and listen for Windows messages
p60623
aVThat lets them do stuff that isn't otherwise possible but it inevitably destabilizes other apps
p60624
aVGetting two context menus is a sure sign of this kind of trouble
p60625
aVYou've got a good lead on what kind of program may do this, it's got an icon
p60626
aVKill them one by one until you find the evil-doer
p60627
aVNot much you can do about it probably, other than not running it or complaining to the vendor
p60628
as(dp60629
g9
V17034
p60630
stp60631
a((dp60632
g2
(lp60633
VTurn off Aero if you want to dumb it down back to XP
p60634
aVIts compositing feature that enables stuff like glass and live thumbnails does not come for free
p60635
as(dp60636
g9
V17034
p60637
stp60638
a((dp60639
g2
(lp60640
VYeah, doesn't work, the method is generated by Reflection
p60641
aVEmit
p60642
aVThe IL is stored in the MethodBuilder's ILGenerator
p60643
aVYou can dig it out but you have to be pretty desperate
p60644
aVReflection is needed to get to the internal and private members
p60645
aVThis worked on
p60646
aVNET 3
p60647
aV5SP1:
p60648
aVOn
p60649
aVNET 4
p60650
aV0 you'll have to use ilgen
p60651
aVGetType()
p60652
aVBaseType
p60653
aVGetField(
p60654
aVbecause the IL generator was changed, DynamicILGenerator, derived from ILGenerator
p60655
as(dp60656
g9
V17034
p60657
stp60658
a((dp60659
g2
(lp60660
VDerive your own class from TextBox
p60661
aVGive it a Flash() method that starts the flashing
p60662
aVJust change the BackColor to a pastel color
p60663
aVDon't use alpha, that doesn't work on a TextBox
p60664
aVYou ought to have all instances of this class share a common Timer so they will flash at the same time
p60665
aVMake the timer static and reference-count the number of instances you have
p60666
aVAdd up in the constructor, down in the Dispose(bool) override
p60667
as(dp60668
g9
V17034
p60669
stp60670
a((dp60671
g2
(lp60672
VI think I'm familiar with this company and its products
p60673
aVThis is unmanaged DLL, used for industrial I/O
p60674
aVThe problem is that Windows cannot find the dependency, it isn't resolved by the CLR loader
p60675
aVYou can help it by changing the current directory:
p60676
aVThis assumes seamax
p60677
aVdll is in the same directory as the assembly
p60678
aVIt normally isn't
p60679
aVPinvoking SetDllDirectory() is another trick, as is copying this DLL to a directory that's on the PATH environment variable
p60680
as(dp60681
g9
V17034
p60682
stp60683
a((dp60684
g2
(lp60685
VCreating your own 'back buffer' instead of using the built-in support for double-buffering is very hard to get performant
p60686
aVWhat matters a great deal is the pixel format of the buffer
p60687
aVOn most any modern machine, any I tried anyway, the 32bppPArgb format is ten times as fast as any other
p60688
aVFavor the built-in double-buffering support for its superior perf
p60689
aVAnother possible loss is your attempt to keep the clipping region as small as possible
p60690
aVThat can byte when the region gets complicated
p60691
aVIt sounds like you're close to that if you let fast mouse movement generate small rectangular update regions
p60692
aVWhen the painting falls behind, it almost always will since the mouse gets a higher priority, you could build up a pretty intricate chain of small rectangles
p60693
aVFirst test this by just invalidating the entire area
p60694
aVNext approach is to expand the area yourself, always keeping it a single rectangle
p60695
aVReset that when OnPaint runs
p60696
as(dp60697
g9
V17034
p60698
stp60699
a((dp60700
g2
(lp60701
VThere is no checkbox control available in the toolbox
p60702
aVYou could try an Image with a screenshot of a checkbox
p60703
aVBind its Visibility
p60704
aVToggleItem property, I think
p60705
as(dp60706
g9
V17034
p60707
stp60708
a((dp60709
g2
(lp60710
VIt is invariably too late after it is loaded
p60711
aVThe JIT compiler would quite likely already have converted the method bodies to machine code
p60712
aVEspecially on Mono
p60713
aVThe DLL is locked, you can't hack it anymore
p60714
aVUsing the profiler is pretty difficult to justify
p60715
aVLeverage Edit + Continue if this is important
p60716
as(dp60717
g9
V17034
p60718
stp60719
a((dp60720
g2
(lp60721
VCOM is the grand father of
p60722
aVNET
p60723
aVThey had pretty lofty goals with it, one of the things that COM does but
p60724
aVNET completely skips is providing threading guarantees for a class
p60725
aVA COM class can publish what kind of threading requirements it has
p60726
aVAnd the COM infrastructure makes sure those requirements are met
p60727
aVThis is completely absent in
p60728
aVNET
p60729
aVYou can use a Queue<> object for example in multiple threads but if you don't lock properly, you'll have a nasty bug in your code that is very hard to diagnose
p60730
aVThe exact details of COM threading are too large to fit in a post
p60731
aVI'll focus on the specifics of your question
p60732
aVA thread that creates COM objects has to tell COM what kind of support it wants to give to COM classes that have restricted threading options
p60733
aVThe vast majority of those classes only support so-called Apartment threading, their interface methods can only safely be called from the same thread that created the instance
p60734
aVIn other words, they announce "I don't support threading whatsoever, please take care of never calling me from the wrong thread"
p60735
aVEven if the client code actually does call it from another thread
p60736
aVThere are two kinds, STA (Single Threaded Apartment) and MTA
p60737
aVIt is specified in the CoInitializeEx() call, a function that must be called by any thread that does anything with COM
p60738
aVThe CLR makes that call automatically whenever it starts a thread
p60739
aVFor the main startup thread of your program, it gets the value to pass from the [STAThread] or [MTAThread] attribute on your Main() method
p60740
aVDefault is MTA
p60741
aVFor threads that you create yourself it is determined by your call to SetApartmentState()
p60742
aVDefault is MTA
p60743
aVThreadpool threads are always MTA, that cannot be changed
p60744
aVThere's lots of code in Windows that requires an STA
p60745
aVNotable examples are the Clipboard, Drag + Drop and the shell dialogs (like OpenFileDialog)
p60746
aVThe UI thread of a WPF or Windows Forms project should always be STA, as does any thread that creates a window
p60747
aVThe promise you make to COM that your thread is STA however does require you to follow the single-thread apartment contract
p60748
aVThey are pretty stiff and you can get pretty hard to diagnose trouble when you break the contract
p60749
aVRequirements are that you never block the thread for any amount of time and that you pump a message loop
p60750
aVThe latter requirement is met by a WPF or Winforms' UI thread but you will need to take care of it yourself if you create your own STA thread
p60751
aVThe common diagnostic for breaking the contract is deadlock
p60752
aVThere's quite a bit of support built-in the CLR to support these requirements btw, helping you to keep out of trouble
p60753
aVThe lock statement for example will pump a message loop when it blocks on an STA thread
p60754
aVMost synchronization classes do as well, Mutex being a notable exception
p60755
aVThis however only takes care of the never-block requirement, you still need to create your own message loop
p60756
aVApplication
p60757
aVRun() in both WPF and Winforms
p60758
aVI've previously contributed an answer that contains more details about the significance of having a message loop to keep COM happy
p60759
aVYou'll find the post here
p60760
as(dp60761
g9
V17034
p60762
stp60763
a((dp60764
g2
(lp60765
VYou are having a different problem here, this code uses very little memory
p60766
aVSadly GDI+ exceptions are pretty crummy
p60767
aVDiagnose this with TaskMgr
p60768
aVexe, Processes tab
p60769
aVView + Select Columns and tick GDI Objects, Handles and USER Objects
p60770
aVIf my suspicion is correct, you'll see the GDI Objects counter for your process climbing constantly as this code runs
p60771
aVWhen it reaches 10,000 Windows decides that there's something fundamentally wrong with the code and refuses to create any more handles
p60772
aVGDI+ then gets a bit gimpy about it and reports an out of memory error
p60773
aVWrong, it should have been a 'could not create handle' error
p60774
aVAn error code that it doesn't have
p60775
aVNET is powerless to improve the exception
p60776
aVAnyhoo, the reason is that you are not calling Dispose() on the font and brush
p60777
aVWrap them with the using statement
p60778
aVThis normally doesn't cause trouble but your program is apparently using too little garbage collected memory to ever kick off the finalizer thread
p60779
as(dp60780
g9
V17034
p60781
stp60782
a((dp60783
g2
(lp60784
VNo, this won't work
p60785
aVThe CLR builds a dispatch table for the COM interface based on the declaration
p60786
aVThe order of the function pointers in that table is set by the order of the method definitions in your declaration
p60787
aVThe Show() method will occupy the first slot in both cases, no trouble there
p60788
aVSetOptions() however is going to end up calling the 2nd one, which is actually SetFileTypes()
p60789
aVThey have different arguments, that's going to go kaboom in a nasty way when the implementation gets garbage arguments and the stack becomes unbalanced
p60790
aVYou can omit any declarations from the tail end
p60791
aVAlso note that the actual declaration of the method doesn't matter when you don't call it
p60792
aVWhich allows you to lie and avoid having to declare their argument types
p60793
aVDo make sure it is obvious that the method won't actually work, name it something like void DontCallMe2()
p60794
aVNote that these interfaces are already wrapped in the Windows API Code Pack as well as
p60795
aVNET 4
p60796
aV0's version of Microsoft
p60797
aVWin32
p60798
aVOpenFileDialog and
p60799
aVNET 3
p60800
aV5's version of System
p60801
aVWindows
p60802
aVForms
p60803
aVOpenFileDialog
p60804
as(dp60805
g9
V17034
p60806
stp60807
a((dp60808
g2
(lp60809
VThe Settings
p60810
aVDesigner
p60811
aVcs is generated by the IDE, not MSBuild
p60812
aVSo, no, changing that file at compile time won't have any effect
p60813
aVYou didn't document your question well enough to offer the best alternative, but it sure sounds like using a setting wasn't the correct choice
p60814
as(dp60815
g9
V17034
p60816
stp60817
a((dp60818
g2
(lp60819
VI repro on Win7
p60820
aVSomething is borked in the font mapper by the looks of it, the substitute font is clearly too large
p60821
aVNotable is the problem does not occur with Microsoft Sans Serif
p60822
aVAnd it maps just fine on my machine
p60823
aVTough to give cheap advice here, you really need the help from Microsoft Support
p60824
aVYou also ought to check it on the Japanese version of Windows, odds are decent that it will have fonts that don't require mapping
p60825
as(dp60826
g9
V17034
p60827
stp60828
a((dp60829
g2
(lp60830
VThis is not a problem you can fix with a
p60831
aVconfig file
p60832
aVIt is finding an old version of the unmanaged code that actually does the heavy lifting
p60833
aVThe name is in the error message, sybdrvado115a
p60834
aVdll
p60835
aVI'd look in c:\u005cwindows\u005csystem32 first
p60836
aVYou are going to have to update the Sybase provider on that machine to get past this exception
p60837
aVOr find an old version of the managed wrapper somewhere
p60838
aVUpgrading, and getting all machines up to date, is definitely the better solution
p60839
as(dp60840
g9
V17034
p60841
stp60842
a((dp60843
g2
(lp60844
VCall the AddHook() method in your Window constructor so you can spy on the messages
p60845
aVLook for WM_MOUSEHWHEEL, message 0x20e
p60846
aVUse wParam
p60847
aVToInt32() >> 16 to get the movement amount, a multiple of 120
p60848
as(dp60849
g9
V17034
p60850
stp60851
a((dp60852
g2
(lp60853
VPut then in a FlowLayoutPanel
p60854
aVShift+Click to select them all and assign the CheckedChanged event handler
p60855
aVMake it look like this:
p60856
aVTry it out, I think you'll find it as disorienting as your user will
p60857
as(dp60858
g9
V17034
p60859
stp60860
a((dp60861
g2
(lp60862
VWindows is quite resilient to this, haven't noticed a problem yet
p60863
aVTake a look at the snippet in this thread
p60864
aVNote the value of the _ACP_INCLUDE environment variable
p60865
aVYou have to scroll to the right to see:
p60866
aVAfaik, a lot of machines that have VS2008 have this bad path, mine certainly does
p60867
aVNevertheless, it certainly can trip up your own code when you parse path strings
p60868
as(dp60869
g9
V17034
p60870
stp60871
a((dp60872
g2
(lp60873
VSetTimer can only be as accurate as your app allows it to be
p60874
aVIt cannot deliver the WM_TIMER message until your main thread goes idle and re-enters the message loop
p60875
aVAnd if it takes more than 40 msec to paint the image then you'll inevitably fall behind
p60876
aVThis is the exact same thing you see happening when you try to play a modern game on an old machine, the frame rate gets crappy
p60877
aVAnd yes, timeSetEvent() cannot fix this problem
p60878
aVIts callback runs on a background thread
p60879
aVYou cannot update the window in such a thread, windows are not thread-safe
p60880
aVYou can only achieve 25fps by making your painting code faster
p60881
aVDirectX helps with that
p60882
as(dp60883
g9
V17034
p60884
stp60885
a((dp60886
g2
(lp60887
VThe keyword here is "embedded"
p60888
aVSuch versions of Windows are often configured to run head-less (no monitor) or optimized to work without anybody being close
p60889
aVA MessageBox is poison to such a configuration
p60890
aVThe machine stops running and nobody can find out why
p60891
aVYou need to go back to your system builder and find the option that controls this
p60892
as(dp60893
g9
V17034
p60894
stp60895
a((dp60896
g2
(lp60897
VYou cannot get a Type for the COM object
p60898
aVThat would require you creating an interop library for the COM component
p60899
aVWhich is certainly the low pain point if the COM server has a type library, just add a reference to it or run the Tlbimp
p60900
aVexe utility
p60901
aVIf it is present then the type library is usually embedded inside the DLL
p60902
aVWhen you got that, both the editor and the Object Browser get a lot smarter about the method and properties available on the COM class
p60903
aVSeeing the IDispatch cast work makes it quite likely that a type library is available as well
p60904
aVIt is pretty trivial for the COM server author to create one
p60905
aVAnother tool you can use to peek at the type library is OleView
p60906
aVexe, View + Typelib
p60907
aVIf that doesn't work then you can indeed dig stuff out of IDispatch
p60908
aVYour declaration looks fishy, the 3rd argument for IDispatch::GetTypeInfo is ITypeInfo, a COM interface
p60909
aVNo need for a custom marshaller, ITypeInfo is available in the System
p60910
aVRuntime
p60911
aVInteropServices
p60912
aVComTypes namespace
p60913
aVYou can dig the IDispatch declaration out of the framework code with Reflector
p60914
aVAnd of course, there's no substitute for decent documentation
p60915
aVYou should be able to get some when you got a license to use this component
p60916
as(dp60917
g9
V17034
p60918
stp60919
a((dp60920
g2
(lp60921
VHmya, this is very fishy
p60922
aVCatching an exception and handling it only really works well when you can restore the program's state so that it looks like the exception never happened
p60923
aVThat is completely impossible to do for a MulticastDelegate
p60924
aVIt's contract is that you have no idea what kind of code subscribed an event handler for it
p60925
aVIf that completely unknown code throws an exception and didn't handle itself, you have no guess at all how to restore state
p60926
aVThe event handler might have done a bunch of work, mutating state, then died somewhere near the end
p60927
aVYou have no hope of un-doing the 'bunch of work' parts, that code is unknown to you
p60928
aVIt might have been written months or years after you wrote your code
p60929
aVReally Bad Idea, don't do this
p60930
as(dp60931
g9
V17034
p60932
stp60933
a((dp60934
g2
(lp60935
VA sample is available here
p60936
aVThe download link is dead, it got moved here
p60937
as(dp60938
g9
V17034
p60939
stp60940
a((dp60941
g2
(lp60942
VIt is simple, implement an event handler for AppDomain
p60943
aVCurrentDomain
p60944
aVUnhandledException and log the value of e
p60945
aVExceptionObject
p60946
aVToString()
p60947
as(dp60948
g9
V17034
p60949
stp60950
a((dp60951
g2
(lp60952
VYeah, it is a bug, of sorts
p60953
aVNote how in the designer you set the size of the form with the Width and Height properties
p60954
aVThose properties include the size of the borders and the title bar
p60955
aVThat's a problem however, your form may run on a machine where the user has increased, say, the title bar font size
p60956
aVThat then would reduce the size of the window's client area
p60957
aVOr in other words, the form's ClientSize property would change on that machine
p60958
aVLeaving less room for the controls and messing up the design of your form pretty badly
p60959
aVThere's code inside the Form class that runs after the Handle is created, right before the Load event runs
p60960
aVIt recalculates the Size of the form, using the same ClientSize you had on your machine
p60961
aVNow everything is good, the Height of the form won't match the one you set in the designer but the form otherwise looks the same and the layout of the controls is identical
p60962
aVThat same code also ensures that the window doesn't get too small
p60963
aVAnd that's where it falls over, it doesn't pay enough attention to the FormBorderStyle property
p60964
aVClipping the height to the title bar size plus the client area height, as you found out
p60965
aVIt also prevents the form getting too narrow, trying to make sure that the icon and min/max/close buttons are always visible
p60966
aVEven if you don't have any
p60967
aVThe workaround is to change the ClientSize after this code runs, the OnLoad override or Load event handler is the right place for that
p60968
aVBeware that if you hard-code the form size like this then you should also set the AutoScaleMode property to None
p60969
aVMake sure that this doesn't cause trouble on a machine that has a different DPI setting
p60970
as(dp60971
g9
V17034
p60972
stp60973
a((dp60974
g2
(lp60975
VUse the Control
p60976
aVDrawToBitmap() method
p60977
aVFor example:
p60978
as(dp60979
g9
V17034
p60980
stp60981
a((dp60982
g2
(lp60983
VYup, this has been completely redesigned for
p60984
aVNET 4
p60985
ag2512
aVIt now uses a rope, a linked list of string builders to store the growing internal buffer
p60986
aVThis is a workaround for a problem when you can't guess the initial Capacity well and the amount of text is large
p60987
aVThat creates a lot of copies of the dis-used internal buffer, clogging up the Large Object Heap
p60988
aVThis comment from the source code as available from the Reference Source is relevant:
p60989
as(dp60990
g9
V17034
p60991
stp60992
a((dp60993
g2
(lp60994
VYes, this cannot work
p60995
aVThe first obstacle you'll face is that WebBrowser is an apartment threaded COM component
p60996
aVCalling its Print method on a thread doesn't actually work, COM honors the component's threading requirements and marshals the call to the thread it was created on, your UI thread
p60997
aVYour code bombs because the form's Close() call also disposes all of its child controls
p60998
aVIncluding the WebBrowser
p60999
aVYou can remove it from its Control collection to prevent this from happening, but you still have to call its Dispose() method when it is done printing
p61000
aVSolving this is not technically impossible, you'd have to create an STA thread that pumps a message loop
p61001
aVCheck my code in this thread for the approach
p61002
as(dp61003
g9
V17034
p61004
stp61005
a((dp61006
g2
(lp61007
VThe default behavior is for the build system to copy any referenced assemblies to your build output directory
p61008
aVSo that you can debug the result
p61009
aVThis copy won't happen when the reference assembly is in the GAC, like is the case with any
p61010
aVNET framework assembly
p61011
aVIn other words, you should find them back in your Release build directory after building
p61012
as(dp61013
g9
V17034
p61014
stp61015
a((dp61016
g2
(lp61017
VUse #pragma message instead
p61018
as(dp61019
g9
V17034
p61020
stp61021
a((dp61022
g2
(lp61023
VNo special tricks are necessary
p61024
aVSet the FormBorderStyle property to None, WindowState to Maximized
p61025
as(dp61026
g9
V17034
p61027
stp61028
a((dp61029
g2
(lp61030
VYou don't specify the FileMode, the default is FileMode
p61031
aVOpenOrCreate
p61032
aVNot sure how much Windows like this when you do this on a CD-Rom
p61033
aVUse the overload that let's you specify FileMode
p61034
aVOpen
p61035
aVNext step is to try to find out why Windows doesn't like you
p61036
as(dp61037
g9
V17034
p61038
stp61039
a((dp61040
g2
(lp61041
VThat's what the Capture property is designed to do
p61042
aVSet it to true and all mouse messages are routed to your control, even if it moves out of the window bounds
p61043
aVCheck the e
p61044
aVLocation property in the MouseDown event
p61045
as(dp61046
g9
V17034
p61047
stp61048
a((dp61049
g2
(lp61050
VGetAsyncKeyState() lets you inspect virtual keys
p61051
aVA virtual key doesn't become a Russian glyph until the WM_KEYDOWN message is processed by Windows through TranslateMessage(), turning that message into a WM_CHAR based on the current keyboard layout
p61052
aVMapping a glyph back to a virtual key is possible with VkKeyScanEx()
p61053
aVThis can get rapidly very complicated if the glyph is generated by dead keys
p61054
aVIn other words, requiring more than one keystroke
p61055
aVNo idea what a Russian keyboard layout looks like, ymmv
p61056
as(dp61057
g9
V17034
p61058
stp61059
a((dp61060
g2
(lp61061
VUse the PngBitmapEncoder class, it uses WIC under the covers
p61062
aVThe FormatConvertedBitmap class helps you set the palette and make the pixel format conversion
p61063
aVAt least
p61064
aVNET 3
p61065
aV0 required
p61066
as(dp61067
g9
V17034
p61068
stp61069
a((dp61070
g2
(lp61071
VYour call stack shows no evidence of this code running on the UI thread
p61072
aVNo sign of Application
p61073
aVRun()
p61074
aVThat's unhealthy, DataGridView is not a thread-safe control
p61075
aVNone of them are
p61076
aVSuch code can malfunction in very unpredictable ways, a NullReferenceException is certainly possible
p61077
aVReview your code for any place where you might have started a worker thread and are either updating DGV properties directly
p61078
aVOr more commonly, updating data that is bound to the DGV
p61079
aVYou'll have to unbind to prevent the DGV update from running on the worker thread, re-bind on the UI thread
p61080
aVUse a BackgroundWorker to make that easier
p61081
as(dp61082
g9
V17034
p61083
stp61084
a((dp61085
g2
(lp61086
VThe 2nd error causes the first one
p61087
aVOpen the project's References node, select SHDocVw
p61088
aVIn the Properties window, change "Embed Interop Types" to false
p61089
aVYou will have to deploy the Interop
p61090
aVSHDocVw
p61091
aVdll assembly you'll find the build output directory along with your program
p61092
aVEDIT: after researching this error, I found a better way to do this
p61093
aVThe issue is that only COM interface types can be embedded, not classes
p61094
aVSo avoid using the synthetic XxxxClass wrappers in your code
p61095
aVMake it look like this instead:
p61096
aVWhich looks strange, you cannot normally use the new operator on an interface type in the C# language
p61097
aVBut is actually supported for COM interfaces
p61098
as(dp61099
g9
V17034
p61100
stp61101
a((dp61102
g2
(lp61103
VThe standard diagnostic for a form not updating its visual appearance, but you seeing the property update with the debugger just fine is using the wrong form instance
p61104
aVLike this for example:
p61105
aVDiagnose this by altering your code like this:
p61106
as(dp61107
g9
V17034
p61108
stp61109
a((dp61110
g2
(lp61111
VSet the column's ReadOnly property to true to make it non-editable
p61112
aVAnd alter its DefaultCellStyle
p61113
aVBackColor (and/or ForeColor) to make it obvious to the user
p61114
as(dp61115
g9
V17034
p61116
stp61117
a((dp61118
g2
(lp61119
VYou'll have to use the File
p61120
aVReadAllText(string, Encoding) overload
p61121
aVWhat that encoding should be is unguessable from your question, but not likely utf-8 as the ReadAllText(string) overload will use
p61122
aVTry this:
p61123
aVwhich uses your machine's default code page
p61124
aVIf the source code files were not created on your machine then find out what the code page was for the machine where the files came from
p61125
as(dp61126
g9
V17034
p61127
stp61128
a((dp61129
g2
(lp61130
VThat's not what /EH does, it merely controls what unwind handlers are emitted
p61131
aV/EHsc ensures that destructors are called when C++ exceptions might be raised, /EHa ensures that they're called for any exceptions, including SEH
p61132
aV/EH- is exactly what you want to cut down on handler overhead
p61133
aVChange the destructor to this:
p61134
aVIf you want the look for unwanted try/catch code then you'll need to pay attention to
p61135
aVwarning C4530: C++ exception handler used, but unwind semantics are not enabled
p61136
aVSpecify /EHsc
p61137
as(dp61138
g9
V17034
p61139
stp61140
a((dp61141
g2
(lp61142
VYes, the display won't update until your event handler completes
p61143
aVCall cpuTurn() only once
p61144
aVMove the loop counter outside the method, make it a class member
p61145
aVCall dispatcherTimer
p61146
aVStop() when it counted up to 6
p61147
aVWhen it is the CPU's turn again, reset the counter and call Start()
p61148
aVGoogle "event driven programming" to learn more about the kind of programming that's required when you write GUI code
p61149
as(dp61150
g9
V17034
p61151
stp61152
a((dp61153
g2
(lp61154
VYou'll need to use the CImage::Draw() overload that lets you specify the source rectangle
p61155
aVSo that you can clip the image that you want to paint from the original
p61156
aVThere are two candidates, the Draw(HDC hDestDC, const RECT& rectDest, const RECT& rectSrc) for example
p61157
aVThe other one is the first one listed on this doc page
p61158
as(dp61159
g9
V17034
p61160
stp61161
a((dp61162
g2
(lp61163
VUnless the function returns a vector or vectors, it is the exact same problem in C++ as well
p61164
aVIt is a memory management problem, the caller of the function has no good way to free the memory of the array, it doesn't know the array sizes nor what allocator was used
p61165
aVFor that matter, even iterating the array is perilous
p61166
aVA problem you can't fix in C++ cannot be fixed in managed interop either
p61167
aVAnd you solve it the same way, you let the caller provide the array, to be filled by the callee
p61168
aVNote that managed arrays don't have this problem, they are classes just like vector<>
p61169
aVReturning a managed array from a function is not an issue
p61170
aVC++/CLI can do it, the standard solution for difficult interop problems
p61171
aVA SAFEARRAY is also a solution, tell the P/Invoke marshaller about them with [MarshalAs] in the managed declaration
p61172
as(dp61173
g9
V17034
p61174
stp61175
a((dp61176
g2
(lp61177
VThe font you use for the dropdown is the problem here
p61178
aVYour code assumes that every character in the strings will have the same width
p61179
aVThis is only true for fixed-pitched fonts like Courier New or Consolas
p61180
aVThe 2nd column still works because the 1st column only contains strings with digits
p61181
aVMany fonts, but not all, give digits the same width as a space
p61182
aVIt goes wrong for the 3rd column because the 2nd one contains letters
p61183
aVAn M needs a lot more space than an I
p61184
aVChange the font
p61185
aVSome controls support using a tab to align text, I can't tell from your tags if that would apply
p61186
as(dp61187
g9
V17034
p61188
stp61189
a((dp61190
g2
(lp61191
VFor starters, it wasn't really their choice
p61192
aVThat decision was made a long time before they got started, culture is a property of an operating system thread
p61193
aVReview the SDK docs for the Get/SetThreadLocale() API functions for example
p61194
aVThat doesn't completely explain it, they have virtualized other OS features, albeit that this one is very hard to virtualize because so many APIs are culture sensitive, especially COM ones
p61195
aVThe next good reason is because changing the culture process-wide is so extremely difficult to implement
p61196
aVIt is an unsolvable race condition
p61197
aVSome other thread might well be in the middle of formatting data that has culture affinity
p61198
aVWhile a lock would work to prevent it from using culture properties just as it is changing, it can not prevent it from changing in the middle of a chain of formatting calls
p61199
aVIt would require them to take some kind of global lock and hold it for the duration of the formatting job
p61200
aVDeadlock is very likely
p61201
aVThere's another aspect to this, one that I think is the real problem
p61202
aVIt is related to the Thread
p61203
aVExecutionContext property
p61204
aVThe framework uses this to "flow" thread state from one thread to another
p61205
aVVery obscure but important to imbue things like the security context onto a worker thread
p61206
aVIt would have been ideal if that context could also imbue the culture so that you can be sure that any of the workers you start have the same culture you selected and not the operating system default
p61207
aVIt doesn't, I don't really know why
p61208
aVProbably because the very first reason I gave
p61209
aVThat does however make it very perilous to change a thread's culture
p61210
aVThe kind of bugs that can cause are very subtle
p61211
aVLike creating a SortedDictionary with a string as the key in your main thread with a non-operating system default culture
p61212
aVThen finding out that a worker thread can't occasionally find stuff back anymore because the string sorting rules are different
p61213
aVEDIT: there's some relief from this problem in
p61214
aVNET 4
p61215
aV5, it supports the new static CultureInfo
p61216
aVDefaultThreadCurrentCulture and DefaultThreadCurrentUICulture properties
p61217
as(dp61218
g9
V17034
p61219
stp61220
a((dp61221
g2
(lp61222
VWell, it is easy to explain
p61223
aVIf the stack frame is corrupted then neither the minidump taker nor the debugger can walk the stack to show you more
p61224
aVEasy to do, for example just strcpy() and overflow the end of the stack buffer so that the saved EBP and return address gets stomped
p61225
aVAnd, yes, almost impossible to diagnose, no matter how good the quality of the minidump
p61226
aVGood luck with it
p61227
as(dp61228
g9
V17034
p61229
stp61230
a((dp61231
g2
(lp61232
VFrom the  header file:
p61233
aVNote how the redefinition now calls another version of malloc that has the file and line number that you are looking for
p61234
aVClearly, to make this work you will have to #define _CRTDBG_MAP_ALLOC and #include crtdb
p61235
ag6193
aVThis is best done in your precompiled header file so that you can be reasonably sure that all of your code will be compiled with these macros in effect
p61236
aVThat still doesn't guarantee that you'll get this info
p61237
aVYour project might be using a
p61238
aVlib that was compiled without it
p61239
aVAnother failure mode is DLLs that might be unloaded just before you generate the leak report
p61240
aVThe file and line info for that DLL will be unloaded as well
p61241
aVThere's a fallback to diagnose those kind of trouble makers
p61242
aVThe leak report has a line for the leak that starts with the block number, shown at the start inside curly braces
p61243
aVAs long as that block number is stable between runs, you can force the debugger to break when the allocation is made
p61244
aVPut this code in your main method or whatever point in your code that executes early:
p61245
as(dp61246
g9
V17034
p61247
stp61248
a((dp61249
g2
(lp61250
VNo, it's a bad idea
p61251
aVThe Form class was very much designed as a single-use class
p61252
aVOnce a form object is disposed it is dead and cannot be revived
p61253
aVYou'll get an ObjectDisposedException when you try to display it again
p61254
aVTo prevent this, you'll have to intercept the FormClosing event and stop the default processing
p61255
aVYou could call Hide() and set e
p61256
aVCancel = true
p61257
aVBut now you've got the hassle of killing it when you really want to get rid of it
p61258
aVBut perhaps more convincingly, you should only ever cache objects that are very expensive to create but don't take a lot of resources
p61259
aVThe Form class is the exact opposite
p61260
aVCreating it is cheap but it takes a very large amount of both managed and unmanaged resources
p61261
aVEspecially the latter, a window is a very costly OS object
p61262
aVIt may look like a Form is expensive to create but what you see is the cycles that are burned on painting the form
p61263
aVYou'll burn the exact same number of cycles when you show a hidden form
p61264
as(dp61265
g9
V17034
p61266
stp61267
a((dp61268
g2
(lp61269
VThat's not in general how theming works
p61270
aVIt overrides the default properties of controls according to the user selected theme
p61271
aVA more stark example is ProgressBar
p61272
aVForeColor, it's going to be the pulsing green bar on Vista, no matter what color you select in the designer
p61273
aVFwiw, there's a fair amount of pain you can get into when you try to override this
p61274
aVGroupBox
p61275
aVForeColor is a very notable example
p61276
aVIt is only going to have the theme color (it is faked btw) if you never assign ForeColor yourself
p61277
aVOnce you do, you can never reset it back
p61278
aVEven if you assign ControlText again you'll get black, not the theme color
p61279
aVThis is somewhat inevitable from the way 'ambient properties' are implemented in Windows Forms
p61280
aVCalling it a bug would not be unjustified
p61281
aVNot tinkering with it is the best way to avoid this trouble, your user isn't going to be complaining
p61282
as(dp61283
g9
V17034
p61284
stp61285
a((dp61286
g2
(lp61287
VNot sure what 'some software' might be, but sure, UAC stops you from poking messages into the windows of elevated programs
p61288
aVIt is called UIPI, User Interface Privilege Isolation
p61289
aVIn general, faking input with PostMessage doesn't work well at all
p61290
aVIt is especially a problem for keyboard input but mouse input has trouble too
p61291
aVThere is no good way to alter the keyboard state for another process
p61292
aVThat matters when the program checks the state of the Shift, Ctrl and Alt keys when it processes the input message
p61293
aVMany do
p61294
aVThe only real solution is to emulate input with SendInput()
p61295
aVNow you got a focus problem to solve
p61296
as(dp61297
g9
V17034
p61298
stp61299
a((dp61300
g2
(lp61301
VWhat happened to Gotdotnet was quite ugly, lots of valuable stuff disappeared for good
p61302
aVKen Tucker preserved the source code for that power pack, download it from this url
p61303
as(dp61304
g9
V17034
p61305
stp61306
a((dp61307
g2
(lp61308
VYou are probably talking about warning CS1690, repro code:
p61309
aVIn a remoting scenario, the Test
p61310
aVRun method will work with a proxy of the Remotable object
p61311
aVBuilding a proxy for a property, method or event isn't much of a problem, just a matter of creating a MethodTable that contains the substitutes
p61312
aVFields are a problem however, there's nothing to 'hook'
p61313
aVFor a MBRO, the JIT compiler no longer generates code to access the field directly, it injects a call to a helper method built into the CLR, JIT_GetField32() in this case
p61314
aVThat helper checks if the object is a proxy and uses the remoting plumbing to obtain the remote value if that's the case
p61315
aVOr just accesses the field directly if it isn't
p61316
aVMaking the ToString() call however requires the value to be boxed
p61317
aVThat's a problem, boxing isolates the value from the proxy
p61318
aVThere is no way to ensure that the boxed value is always an accurate copy of the remoted value
p61319
aVCalling JIT_GetField32() again whenever the ToString() method uses the value to format the string isn't possible
p61320
aVThe workaround for CS1690 is simple, just copy the field value in a local variable
p61321
aVNow it is crystal clear that the code is working with a copy and there is never a surprise so the compiler won't have to emit a warning
p61322
as(dp61323
g9
V17034
p61324
stp61325
a((dp61326
g2
(lp61327
VAn #ifdef jumps to mind, using a "eval" key that you don't care about
p61328
as(dp61329
g9
V17034
p61330
stp61331
a((dp61332
g2
(lp61333
VThis is rather a train wreck, you are really not close
p61334
aVSuggested fixes:
p61335
as(dp61336
g9
V17034
p61337
stp61338
a((dp61339
g2
(lp61340
VComplete ownerdraw of TreeView is hard
p61341
aVIt is so hard that Lutz Roeder of Reflector fame didn't implement it fully
p61342
aVIt is so hard that even Microsoft gave up on it
p61343
aVConsider the Windows 7 style:
p61344
aVNote the black triangle for an expanded node, the hollow one for a collapsed node
p61345
aVEsthetically pleasing, very easy to implement yourself and your app will automatically be ready for the Win7 look
p61346
aVWin win
p61347
as(dp61348
g9
V17034
p61349
stp61350
a((dp61351
g2
(lp61352
VWell, the finalizer for buffer will never run
p61353
aVHard to see how that could matter, you wouldn't be able to pin it if it was an object with anything interesting inside
p61354
aVIt is very unfriendly to the garbage collector, it has to constantly work around the obstacle and can't compact the heap well enough to give your app the best use of the CPU cache
p61355
aVEspecially bad if it is in gen #0, it will be
p61356
aVThere is very rarely a good reason to give the GC such a hard time, just allocate real unmovable memory
p61357
aVUse Marshal
p61358
aVAllocCoTaskMem() and Marshal
p61359
aVStructureToPtr() (if and where needed)
p61360
aVNow you do care about releasing that memory when unloading the AppDomain doesn't also terminate the process
p61361
aVThat IntPtr will be gonzo
p61362
aVBut do note that the lifetime of the AppDomain is not in any way associated with the lifetime of unmanaged code
p61363
aVThat DLL you loaded will not be unloaded along with the AppDomain
p61364
aVIt isn't clear from your question whether this unmanaged code could still use that buffer, it could since it is still there
p61365
aVIf it does, it is really important that you don't use pinned memory
p61366
as(dp61367
g9
V17034
p61368
stp61369
a((dp61370
g2
(lp61371
VThis isn't exclusive to ShowDialog(), Show() does it too
p61372
aVAnd no, there is no IsDisposed property to check
p61373
aVIsLoaded is only half a solution, it will be false for the 1st invocation as well
p61374
aVFirst approach is to just make a dialog that can be re-shown:
p61375
aVThe next one is to explicitly keep track of the health of the object reference:
p61376
as(dp61377
g9
V17034
p61378
stp61379
a((dp61380
g2
(lp61381
VIt's pretty simple
p61382
aVIf all you've got is a bitmapped font instead of an outline font then you have very limited choices in picking an anti-aliasing pixel color
p61383
aVFor example, if the bitmapped font point size is exactly four times as large as the desired display point size then you can only ever get 16 distinct choices
p61384
aVThe number of 'lit' pixels in the 4x4 mapping rectangle
p61385
aVHaving to deal with fractional mapping is a programming exercise but not one that improves the quality
p61386
as(dp61387
g9
V17034
p61388
stp61389
a((dp61390
g2
(lp61391
VWe'll have to work on fixing your intuition because getting an error out of the compiler is not an option
p61392
aVIt is partially implemented, you can get this warning:
p61393
aVerror BC42104: Variable 'mumble' is used before it has been assigned a value
p61394
aVA null reference exception could result at runtime
p61395
aVAnd elevate it from a warning to an error with Project + Properties, Compile tab
p61396
aVHowever, as the warning message indicates, this is only supported for reference type references, it won't budge for a variable of a value type
p61397
aVOkay, intuition
p61398
aVIf the runtime would implement your desired behavior then it would have to allocate a new variable for each iteration of the loop
p61399
aVWhich implies that the number of local variables is bounded only by the number of iterations
p61400
aVThis is very wasteful and a very easy trigger for StackOverflowException
p61401
aVThe JIT compiler doesn't do this, it re-uses the variable
p61402
aVThis happens in C# as well, minus the option of letting you not initialize the value explicitly of course
p61403
aVFwiw: I very much agree with you that this is unhelpful behavior
p61404
aVYou'll probably find receptive ears at connect
p61405
aVmicrosoft
p61406
aVcom, post your feature request there and the VB
p61407
aVNET team will see it
p61408
aVThere has been strong backing from customers as well as within MSFT to make VB
p61409
aVNET and C# feature comparable
p61410
aVIf you post a link to your feedback report then I'll be happy to vote it up
p61411
as(dp61412
g9
V17034
p61413
stp61414
a((dp61415
g2
(lp61416
s(dp61417
g9
V17034
p61418
stp61419
a((dp61420
g2
(lp61421
VThis fails because the CLR just has no hope of being able to find the assembly, you put it in an unfindable location
p61422
aVTrivially solve this by adding a reference to the assembly and setting its Copy Local property to True so that server
p61423
aVdll gets copied into your build directory
p61424
aVIf you want to keep it where it is at then you'll have to implement AppDomain
p61425
aVAssemblyResolve to help the CLR finding it
p61426
as(dp61427
g9
V17034
p61428
stp61429
a((dp61430
g2
(lp61431
VTrying to find out by loading the assembly is a chicken-and-egg proposition
p61432
aVIf you don't get a BadImageFormatException then the arch is appropriate and you no longer care what it is
p61433
aVIf you do get the exception then the program's configuration is wrong
p61434
aVNothing you can do about that in code
p61435
as(dp61436
g9
V17034
p61437
stp61438
a((dp61439
g2
(lp61440
VThat's not possible, bitness is a process property, not an appdomain property
p61441
aVTo make this work, you'll need to load that DLL in a separate process
p61442
aVUse the standard
p61443
aVNET IPC mechanisms to talk to it
p61444
aVNamed pipes, sockets, remoting, WCF
p61445
aVOr force the Platform target setting to x86
p61446
as(dp61447
g9
V17034
p61448
stp61449
a((dp61450
g2
(lp61451
VYou need to create your own designer for your control
p61452
aVStart that by adding a reference to System
p61453
aVDesign
p61454
aVA sample control could look like this:
p61455
aVNote the [Designer] attribute, it sets the custom control designer
p61456
aVTo get yours started, derive your own designer from ControlDesigner
p61457
aVOverride the ActionLists property to create the task list for the designer:
p61458
aVNow you need to create your custom ActionListItem, that could look like this:
p61459
aVBuilding the list in the GetSortedActionItems method is the key to creating your own task item panel
p61460
aVThat's the happy version
p61461
aVI should note that I crashed Visual Studio to the desktop three times while working on this example code
p61462
aVVS2008 is not resilient to unhandled exceptions in the custom designer code
p61463
aVSave often
p61464
aVDebugging design time code requires starting another instance of VS that can stop the debugger on the design-time exceptions
p61465
as(dp61466
g9
V17034
p61467
stp61468
a((dp61469
g2
(lp61470
VYes, this code will work only once
p61471
aVAfter you called Save(), you've got a lock on the file
p61472
aVSaving again will bomb
p61473
aVYou must call Dispose() after calling Save() so the bitmap is disposed properly and the file lock is released
p61474
aVNot using the using statement or calling Dispose() on a disposable class object is something you often get away with in
p61475
aVNET
p61476
aVBut rarely on bitmaps
p61477
as(dp61478
g9
V17034
p61479
stp61480
a((dp61481
g2
(lp61482
VYes, that's the standard build model for Visual Studio
p61483
aVOne project normally produces one assembly
p61484
aVOne solution can contain more than one project
p61485
aVThere is no direct support for creating modules, you'll have to do that by hand so you can run csc
p61486
aVexe with the /target:module option
p61487
aVThere are very few scenarios where that makes sense
p61488
as(dp61489
g9
V17034
p61490
stp61491
a((dp61492
g2
(lp61493
VYes you have to
p61494
aVOnly way to find out if the invoked method threw an exception
p61495
aVAnd to cleanup the remoting state of the call so it can be garbage collected instead of letting it linger for another 10 minutes
p61496
as(dp61497
g9
V17034
p61498
stp61499
a((dp61500
g2
(lp61501
Vgenerally users can change there IP or modify their IP Address
p61502
aVNo they don't, it is a very privileged operation
p61503
aVAn administrator account is necessary
p61504
aVOn Vista and Win7 the UAC prompt has to be acknowledged
p61505
aVPreventing an admin from administering the machine is a lost cause and in general a hostile act
p61506
aVAnd pointless, the admin has all the required powers to kill your app
p61507
aVFix the real problem
p61508
aVThe days that you could count on having your app run with an admin account are long gone
p61509
aVAnybody that runs Vista or Win7 is quickly going to uninstall your app
p61510
as(dp61511
g9
V17034
p61512
stp61513
a((dp61514
g2
(lp61515
VThe difference is that HashSet<> implements ISerializable, List<> doesn't
p61516
aVThe workaround is to call its OnDeserialization() method explicitly, albeit that I'm not sure whether that's the right thing to do
p61517
as(dp61518
g9
V17034
p61519
stp61520
a((dp61521
g2
(lp61522
VYou cannot know until the assembly is loaded
p61523
aVThe assembly resolution algorithm is complicated and you can't reliably guess up front what it will do
p61524
aVCalling the Assembly
p61525
aVLoad(AssemblyName) override will get you a reference to the assembly, its Location property tells you what you need
p61526
aVHowever, you really don't want to load assemblies up front, before the JIT compiler does it
p61527
aVIt is inefficient and the likelihood of problems is not zero
p61528
aVYou could for example fire an AppDomain
p61529
aVAssemblyResolve event before the program is ready to respond to it
p61530
aVAvoid asking this question
p61531
as(dp61532
g9
V17034
p61533
stp61534
a((dp61535
g2
(lp61536
VThe big deal about classes derived from Control (including TabPage) is the Dispose() method
p61537
aVThey are immune from automatic garbage collection, Winforms keeps an internal table that maps the Handle of a control to the control reference
p61538
aVThat's why, say, your main form doesn't suddenly get garbage collected, even though your program doesn't keep a reference to it
p61539
aVAdding the TabPage to the TabControl's collection takes care of automatic disposal
p61540
aVThe same applies for the TabControl, it would be added to the form's Controls collection
p61541
aVThe normal chain of events is that either your program or the user closes the form
p61542
aVThe Form class iterates its child controls and calls their Dispose() method
p61543
aVTabControl does the same thing in its Dispose() method, disposing the tab pages
p61544
aVThe Windows window gets destroyed in the process, removing the Handle from that mapping table and now allowing the garbage collector to, eventually, collect the managed wrapper for the controls
p61545
aVThere is a nasty trap that gets many Winforms programmers in trouble
p61546
aVIf you remove a control from its parent's collection then you get the responsibility of disposing it yourself
p61547
aVRemoving it does not automatically dispose it
p61548
aVWinforms keeps the native window alive by temporarily re-parenting the control to a hidden window named the "parking window"
p61549
aVNice feature, it allows you to move a control from one parent to another without having to destroy and re-create the control
p61550
aVBut the keyword there is "temporarily"
p61551
aVIt is only temporarily if you next reparent the control
p61552
aVSo it gets moved from the parking window to the new parent
p61553
aVIf you don't actually reparent it then it will stay alive for ever on the parking window
p61554
aVGobbling up resources until the program terminates
p61555
aVThis is otherwise known as a leak
p61556
aVIt can crash your program when Windows refuses to create another window when you've already created 10,000 of them
p61557
aVThe ControlCollection
p61558
aVClear() method is especially harmful here
p61559
aVIt does not dispose the controls, they all get moved to that parking window
p61560
aVIf that's not intended, it rarely is, you'll have to call Dispose() on them yourself
p61561
as(dp61562
g9
V17034
p61563
stp61564
a((dp61565
g2
(lp61566
VYou are asking for a lot
p61567
aVIn general, making components aware of the form they are dropped on is quite difficult
p61568
aVThis answer can help you get the event handler implemented
p61569
aVYou'll need to implement ISupportInitialize to get the EndInit() call to setup the event handler
p61570
aVPreventing multiples is quite hard too, I can only think of a custom designer that can step in early enough to prevent the 2nd one from being added
p61571
as(dp61572
g9
V17034
p61573
stp61574
a((dp61575
g2
(lp61576
VRevision 4927 is a Windows 7 specific version, probably used by Microsoft binaries
p61577
aVYour build should not create a dependency on it, 4053 is the last one for VS2005
p61578
aVDon't troubleshoot this with depends
p61579
aVexe btw, it isn't good at tracking winsxs dependencies
p61580
aVStart troubleshooting this by double-checking what dependency your build generates
p61581
aVFirst look in vc\u005cinclude\u005ccrtassem
p61582
aVh, the _CRT_ASSEMBLY_VERSION macro generates the manifest entry
p61583
aVNext is to check the manifest that's embedded in your executable
p61584
aVYour project's Release directory contains the
p61585
aVembed
p61586
aVmanifest file that was embedded
p61587
aVAnd File + Open + File on your executable lets you peek at the actual embedded RT_MANIFEST resource
p61588
as(dp61589
g9
V17034
p61590
stp61591
a((dp61592
g2
(lp61593
VShutter speed is encoded in the EXIF metadata as an SRATIONAL, 32-bits for the numerator and 32-bits for the denominator
p61594
aVSample code that retrieves it, using System
p61595
aVDrawing:
p61596
aVOutput: Shutter speed = 553859/65536, sample image retrieved here
p61597
as(dp61598
g9
V17034
p61599
stp61600
a((dp61601
g2
(lp61602
VThe exception is crystal clear
p61603
aVFind the bar class in your source code and give it the [Serializable] attribute
p61604
aVDo pause a minute to consider whether that deserializing an object of that class can work
p61605
as(dp61606
g9
V17034
p61607
stp61608
a((dp61609
g2
(lp61610
VYou can't
p61611
aVManaged [ComVisible] class libraries need to be registered with Regasm
p61612
aVexe
p61613
aVYou can do it from the IDE with Project + Properties, Build tab, Register for COM interop checkbox
p61614
aVIf you run Regasm
p61615
aVexe you usually want the /codebase command line option so you don't have to put the assembly in the GAC
p61616
aVYet another option is to let Regasm
p61617
aVexe generate a
p61618
aVreg file with the /regfile option
p61619
aVYou'd just run that on the target machine to get the registry updated
p61620
aVEdit: just saw the "major problems" remark
p61621
aVNote sure what they are, short from /codebase
p61622
aVYou do have to pick the right version on 64-bit machines
p61623
aVThere are two
p61624
aVAnd you need an elevated command prompt so that UAC don't put a stop to it
p61625
as(dp61626
g9
V17034
p61627
stp61628
a((dp61629
g2
(lp61630
VNo
p61631
aVGo find out what happened to SerialPort
p61632
aVGetPortNames()
p61633
aVListening for the WM_DEVICECHANGE message in a window can give you better info
p61634
as(dp61635
g9
V17034
p61636
stp61637
a((dp61638
g2
(lp61639
VThe strArr() variable is not actually an array of strings
p61640
aVIt is an array of variants
p61641
aVFix:
p61642
aVNow it is the same as your first snippet
p61643
as(dp61644
g9
V17034
p61645
stp61646
a((dp61647
g2
(lp61648
VThere is nothing bare-bones about a COM server that supports late binding from Javascript running inside IE
p61649
aVIf you don't know how to implement DllGetClassObject() then you need all the help you can get
p61650
aVYou get a lot of help from ATL and the wizards built into Visual Studio
p61651
aVThe vast majority of the fugly plumbing code is auto-generated, including those 4 exports
p61652
aVAnd IDispatch, the interface that the Javascript needs
p61653
aVStart the project with the ATL + ATL Project template
p61654
aVThe defaults are good
p61655
aVRight-click the project, Add, Class and select ATL + ATL Simple Object
p61656
aVSwitch to Class View, locate your interface type and right-click it to add methods and properties
p61657
as(dp61658
g9
V17034
p61659
stp61660
a((dp61661
g2
(lp61662
VYou can trivially solve this by using a System
p61663
aVThreading
p61664
aVTimer
p61665
aVYou make it a one-shot timer by setting its period to zero
p61666
aVRestart the timer in the callback
p61667
aVOverlapped execution of the callback is now impossible
p61668
aVSince you run this so frequently, a different approach is to use a thread instead
p61669
aVYou'll need an AutoResetEvent to signal the thread to stop in the OnStop() method
p61670
aVIts WaitOne() method gives you a free timer when you use the overload that takes the millisecondsTimeout argument
p61671
aVBtw: note that the autoEvent
p61672
aVWaitOne() call in OnStart() is troublesome
p61673
aVIt may timeout the service controller if the first email takes a long time to send
p61674
aVJust omit it, you got the timer started == service started
p61675
as(dp61676
g9
V17034
p61677
stp61678
a((dp61679
g2
(lp61680
VUse Graphics
p61681
aVCopyFromScreen to copy a 1x1 bitmap, Bitmap
p61682
aVGetPixel() to get its color
p61683
as(dp61684
g9
V17034
p61685
stp61686
a((dp61687
g2
(lp61688
VNope, [size_is] is an attribute that only midl
p61689
aVexe knows how to use
p61690
aVIt does so when it generates the proxy/stub for the interface, something that's used when you want to make the call across process boundaries
p61691
aVIt isn't otherwise expressible in a type library
p61692
aVThe argument gets emitted as "pointer to BSTR" which could either indicated a BSTR passed by reference or an array of BSTRs
p61693
aVTlbimp
p61694
aVexe can't tell the difference, it picks the former
p61695
aVIt has to, it cannot reasonably infer the array size
p61696
aVYou get junk at runtime because the CLR interop layer only passes a single element of the array
p61697
aVAny COM client has a big problem using this method, it isn't
p61698
aVNET specific
p61699
aVThe
p61700
aVNET pinvoke marshaller has a workaround for this problem, note the SizeParamIndex property of the [MarshalAs] attribute
p61701
aVIf you cannot modify the C++ code then you'll need to edit the interop library by hand to inject that [MarshalAs] attribute
p61702
aVThat's quite fugly, you have to decompile the library with ildasm
p61703
aVexe, edit the
p61704
aVil and put it back together with ilasm
p61705
aVexe
p61706
aVYou don't want to do that often
p61707
aVIf you can then you should use the Automation compatible way to pass arrays
p61708
aVUse a SAFEARRAY
p61709
aVThis is fully supported by type libraries and the CLR interop plumbing, no work on your end is needed on the managed side
p61710
aVAlso note that you now no longer need the number argument, safe arrays know how long they are
p61711
aVNot unlike managed arrays
p61712
as(dp61713
g9
V17034
p61714
stp61715
a((dp61716
g2
(lp61717
VYou didn't include the MOUSEEVENTF_MOVE flag, so the cursor isn't going to move
p61718
aVI would recommend making 3 distinct calls (move, down, up), doing everything at the same time is iffy
p61719
aVBut might work, experiment if you really want to cut that down
p61720
aVBtw, SendInput is what the SDK recommends you use
p61721
as(dp61722
g9
V17034
p61723
stp61724
a((dp61725
g2
(lp61726
VYes, it is a bad practice
p61727
aVI scanned the question a few times but I don't exactly feel informed well enough to give a good answer
p61728
aVThat's a problem, if you can't easily explain your locking model and you've got trouble coming up with a good picture that makes it clear then it also becomes very difficult to reason about the number of possible state permutations
p61729
aVNot being able to reason about all possible state permutations has a potentially very nasty runtime penalty
p61730
aVDeadlock
p61731
as(dp61732
g9
V17034
p61733
stp61734
a((dp61735
g2
(lp61736
VYou are using MMFs in the absolute worst possible way
p61737
aVMapping them once, hitting every page and immediately closing the mapping
p61738
aVYour program is generating a massive number of page faults
p61739
aVSomething you can easily see in Taskmgr
p61740
aVexe, Processes tab, View + Select Columns to add the page fault columns
p61741
aVYes, page faults are fairly expensive in getting so many of them is going to noticeably affect the machine's operation
p61742
aVRAM is par for the course, you are using a lot of it
p61743
aVI realize this is a synthetic test
p61744
aVIf your real code looks anything like this (never taking advantage of the caching and the lazy writeback) then don't use MMFs
p61745
as(dp61746
g9
V17034
p61747
stp61748
a((dp61749
g2
(lp61750
VA message posted with PostThreadMessage() has a NULL window handle
p61751
aVSo forget about any of the window methods, DispatchMessage() isn't going to deliver them
p61752
aVAll you got is CWinThread::PreTranslateMessage()
p61753
aVBut there's a big hazard here, this isn't going to be called anymore when any code in that thread start pumping its own message loop
p61754
aVYour messages now fall in the bit bucket because other code is now calling Peek/GetMessage()
p61755
aVThat's a lot more likely then you think, MessageBox() is enough
p61756
aVOr the COM modal loop
p61757
aVEtcetera
p61758
aVYou can only safely use PostThreadMessage() to send messages to a thread that does not create any windows of its own
p61759
aVThe workaround is simple enough, provide the thread with a window handle so it can call PostMessage() instead
p61760
aVThat could be a hidden window, dedicated to handling these messages for example
p61761
as(dp61762
g9
V17034
p61763
stp61764
a((dp61765
g2
(lp61766
VA panel scrolls its content by adjusting the Location property of its child controls when you move the scrollbar
p61767
aVYou need to do this yourself when you add a picture
p61768
aVFix:
p61769
as(dp61770
g9
V17034
p61771
stp61772
a((dp61773
g2
(lp61774
VYou are asking the wrong question
p61775
aVUnfortunately it is a trap that many programmers fall into
p61776
aVThe C++/CLI compiler is a bit too good at compiling 'native' C++ code
p61777
aVIt will readily convert it to IL and the JIT compiler will generate machine code for it at runtime
p61778
aVIt only has trouble with non-standard extension, of which I only know of __fastcall to be a problem
p61779
aVBut that's wasteful, the point of C++/CLI is for it to be the interop language
p61780
aVYou want to compile your native C++ code with the native compiler
p61781
aVSo that you'll get the advantage of the code optimizer being able to take its sweet old time generating the best possible machine code
p61782
aVWrite the glue code, the ref classes, in their own source file and compile that one with the /clr option
p61783
aVThe "C++ interop" feature ensures that it efficiently thunks from managed to native execution
p61784
aVThe final assembly is mixed-mode with both IL for the C++/CLI code and machine code for the native C++ bits
p61785
as(dp61786
g9
V17034
p61787
stp61788
a((dp61789
g2
(lp61790
VYou made the wrong class generic
p61791
aVSelectedItems[0] is a ListViewItem, not a ListView
p61792
aVThere isn't anything you can do to change the type of the Items and SelectedItems properties
p61793
aVYou can certainly derive your own class from ListViewItem and just add the property you want to store
p61794
aVNo need for another Tag property
p61795
aVYou'll have no trouble adding them but you'll need to cast back to your derived class when you retrieve them back from the Selected/Items collection
p61796
aVIn general, avoid this kind of code by using the ListView only as a view of your model
p61797
aVThe ListViewItem
p61798
aVIndex should then always be good to get a typesafe reference back from your model
p61799
as(dp61800
g9
V17034
p61801
stp61802
a((dp61803
g2
(lp61804
VThis is a warning from a Managed Debugging Assistant, the docs are here
p61805
aVWhile it is a warning, it is not one that you should ignore if it happens during an event callback
p61806
aVIt is most typically a threading problem, the thread that owned a COM object has exited
p61807
aVOr called CoUnitialize() to tear down its apartment
p61808
aVSame thing, an exiting thread calls CoUnitialize()
p61809
aVThere is little in your question that really helps coming up with a decent diagnostic for it
p61810
aVDo consider the possibility that this 3rd party COM component might have something to do with it, like raising the event on another thread
p61811
aVThe Debug + Windows + Threads window should help with that
p61812
aVAnd pay attention to the Output window, it shows thread termination notifications
p61813
as(dp61814
g9
V17034
p61815
stp61816
a((dp61817
g2
(lp61818
VIf the web page you visit contains frames then the DocumentCompleted event will fire multiple times, once for each frame
p61819
aVAnd thus you'll subscribe the event multiple times
p61820
aVFilter this by checking e
p61821
aVUrl
p61822
aVEquals(webBrowser1
p61823
aVUrl), it is only true for the last one
p61824
aVAnother problem you'll have to solve is unsubscribing the event, right now you'll leak the HtmlDocument
p61825
aVBe sure to unsubscribe before calling Navigate()
p61826
as(dp61827
g9
V17034
p61828
stp61829
a((dp61830
g2
(lp61831
VRight, they are not virtual from the language point of view
p61832
aVBut they actually are as far as the CLR is concerned
p61833
aVThis sample code:
p61834
aVProduces this IL for the Dispose() method:
p61835
aVNote the attributes on the method: virtual and final
p61836
aVThe final is what ensures that you can't override the method in a derived class
p61837
aVMaking the interface method implementation behave like a non-virtual method in the language but a virtual one at runtime
p61838
aVThis then also answers your question about early/late binding
p61839
aVIt's early, the v-table slot is filled in when the class is loaded
p61840
as(dp61841
g9
V17034
p61842
stp61843
a((dp61844
g2
(lp61845
VYes, a Timer would work
p61846
aVHere's a clever trick I saw used in a Microsoft example that showed how to use XNA in a Winforms project
p61847
aVIt uses the Application
p61848
aVIdle event:
p61849
aVI used a PictureBox instead of a Panel to hide the flicker, PB has the DoubleBuffered property turned on
p61850
aVThat isn't very relevant to XNA though
p61851
aVUsing vsync isn't going to work afaik
p61852
aVYou probably ought to check out that example, the 'spinning triangle' was completely smooth without any tearing when I tried it
p61853
aVThis thread talks about it
p61854
as(dp61855
g9
V17034
p61856
stp61857
a((dp61858
g2
(lp61859
VYour code doesn't compile, TestClass doesn't implement the Dispose() method
p61860
aVI can guess what you are seeing though
p61861
aVThere's a known bug in the Edit+Continue support code that the VB
p61862
aVNET compiler generates
p61863
aVIt uses a WeakReference to track assigned event handlers, that WR object is leaked when you run your code without a debugger
p61864
aVCheck if you can fix your problem by either commenting out the Event or by running the Release build of your code
p61865
aVYou cannot ship the Debug build of your project, it will bomb with OOM when those leaked WeakReference objects consume all memory
p61866
aVOnly ever ship the Release build
p61867
as(dp61868
g9
V17034
p61869
stp61870
a((dp61871
g2
(lp61872
VIt is pretty clear from the answers that few C++ programmers have ever seen a real refactoring tool
p61873
aVYes, they are quite rare and highly specific to the IDE you use
p61874
aVThat's inevitable, there is otherwise no good way to find out what source code files contribute code to the final executable
p61875
aVThe preprocessor makes it extra challenging, you need to know the macro values
p61876
aVA source code parser is required but not enough
p61877
aVVisual Assist for VS is one I know of
p61878
as(dp61879
g9
V17034
p61880
stp61881
a((dp61882
g2
(lp61883
VYes, GetPrivateProfileSection will return it
p61884
aVGetPrivateProfileString() can obviously only ever retrieve "Ryan"
p61885
aVYou won't get the string handed to you like you want, the name/value pairs are separated by a zero
p61886
aVThe end of the list is indicated by two zeros
p61887
aVYou'll need to account for that when you parse it
p61888
as(dp61889
g9
V17034
p61890
stp61891
a((dp61892
g2
(lp61893
VHard to see why the script interpreter balks at indexing the array
p61894
aVThis might have something to do with the lower-bound of the array being zero, there is no Option Base statement in VBScript
p61895
aVCreating an array that doesn't start at zero in
p61896
aVNET is technically possible through Array
p61897
aVCreateInstance(), one of its overloads lets you create an array that has non-zero lower bounds
p61898
aVI'll mention the VariantWrapper class but don't think it's relevant
p61899
aVMaking the array the return value is something else to try as a workaround
p61900
as(dp61901
g9
V17034
p61902
stp61903
a((dp61904
g2
(lp61905
VIt is an old tool back from the
p61906
aVNET 1
p61907
aVx days and is no longer distributed
p61908
aVGoogle "clrdump" for an equivalent freeware tool, take the first hit
p61909
as(dp61910
g9
V17034
p61911
stp61912
a((dp61913
g2
(lp61914
VA common cause for the 1st error is to run Regasm
p61915
aVexe without the /codebase command line option
p61916
aVThe 2nd error is 0x8007002, a Windows error, "File not found"
p61917
aVThis is likely to be generated by an exception in your managed code
p61918
aVThe 3rd error is 0x80131506, the managed exception code for "Fatal execution engine error"
p61919
aVThat's a bad one, usually induced by having unmanaged code corrupt the garbage collected heap
p61920
aVClearly you don't really have registration problems, you are getting managed exceptions
p61921
aVBut yes, they are hard to diagnose when you can no longer see the nice
p61922
aVNET exceptions with their stack traces
p61923
aVFix this by using the debugger
p61924
aVProject + Properties, Debug tab, select "Start external program" and select your vb6 program
p61925
aVSet a breakpoint on the code you want to test
p61926
aVIt will hit as soon as the vb6 program calls it
p61927
aVDebug + Exception, Thrown checkboxes is another good way to troubleshoot managed exceptions, the debugger stops at the throw statement
p61928
aVAlbeit that it might not be your code that's throwing, look at the call stack
p61929
aVYou can even select vb6
p61930
aVexe from the VS6 install directory
p61931
aVNow you can debug both the vb6 code and the managed code
p61932
as(dp61933
g9
V17034
p61934
stp61935
a((dp61936
g2
(lp61937
VUgh, all the bad stories I heard about Notes must be true
p61938
aVTry setting Environment
p61939
aVCurrentDirectory to the directory that contains that
p61940
aVini file
p61941
as(dp61942
g9
V17034
p61943
stp61944
a((dp61945
g2
(lp61946
VI know I'm doing your homework but it is interesting because the problem statement is flawed
p61947
aVIt can't be answered as-is because a important piece of info is missing: the number of cores that the machine has available
p61948
aVRunning more threads than you've got cores doesn't improve throughput
p61949
aVAssuming J jobs, T threads and C cores, the amount of time spent on them is
p61950
aVtime = J x 15 msec / min(T, C) + J x 75 msec / 3
p61951
aVSolving for J per second:
p61952
aVrate = 1000 / (15 / min(T, C) + 25)
p61953
as(dp61954
g9
V17034
p61955
stp61956
a((dp61957
g2
(lp61958
VThis is a well known limitation in the Windows version of the CLR
p61959
aVIt uses Windows' built-in support for exception handling (SEH)
p61960
aVProblem is, it is stack frame based and a method has only one stack frame
p61961
aVYou can easily solve the problem by moving the inner try/catch block into another helper method, thus creating another stack frame
p61962
aVAnother consequence of this limitation is that the JIT compiler won't inline any method that contains a try statement
p61963
as(dp61964
g9
V17034
p61965
stp61966
a((dp61967
g2
(lp61968
VI don't often get what Patterns+Practices does but this one seems straight forward
p61969
aVIt is explicitly useful for an app that you want to create for both WPF and Silverlight
p61970
aVYou have to have separate projects, the assembly references are very different
p61971
aVWhich is painful, any change you make to one project you also have to make to the other
p61972
aVThe tool makes it automatic
p61973
as(dp61974
g9
V17034
p61975
stp61976
a((dp61977
g2
(lp61978
VWell, you are explicitly violating the contract for GlobalAlloc()
p61979
aVYour hope that Marshal
p61980
aVPtrToStructure() will call GlobalLock is unfounded, it has no way to tell whether the passed IntPtr is a handle or a pointer
p61981
aVGlobalAlloc is a fairly hopelessly outdated legacy function from the Windows 3
p61982
aVx era
p61983
aVYes, it is quite likely to return the address as the handle value with GlobalLock() being a no-op
p61984
aVBut it is certainly not documented to do this
p61985
aVCoTaskMemAlloc() is the better mouse trap
p61986
as(dp61987
g9
V17034
p61988
stp61989
a((dp61990
g2
(lp61991
VThis is also reported in this workitem
p61992
aVIt contains a suggested workaround from DarthObiwan
p61993
aVYou can change this without recompiling
p61994
aVThe ElementFlags list is a
p61995
aVstatic property on the HtmlNode class
p61996
aVIt can be removed with
p61997
aVbefore doing the document load
p61998
as(dp61999
g9
V17034
p62000
stp62001
a((dp62002
g2
(lp62003
VA control is an expensive object
p62004
aVYou've got too many here, painting the form will start to get noticeably slower
p62005
aVUse a DataGridView instead, add columns of type DataGridViewCheckBoxColumn
p62006
as(dp62007
g9
V17034
p62008
stp62009
a((dp62010
g2
(lp62011
VThe 2nd error is caused by the first one
p62012
aVThe Embed Interop Types feature only supports embedding interfaces, not classes
p62013
aVOther than just setting that option on the WIA reference to False and deploy the interop library, you could also fix it like this:
p62014
aVUnintuitive but creating COM interfaces with the new operator is allowed
p62015
aVYou need to prefix the namespace name because CommonDialog is ambiguous with the Winforms CommonDialog class
p62016
as(dp62017
g9
V17034
p62018
stp62019
a((dp62020
g2
(lp62021
VNot really, you can only make an estimate
p62022
aVTrueType hinting, kerning and glyph overhang makes measuring individual characters next to impossible
p62023
aVSome code:
p62024
aVThat returns 13
p62025
aV1 on my machine
p62026
aVAvoid doing this
p62027
as(dp62028
g9
V17034
p62029
stp62030
a((dp62031
g2
(lp62032
VYes, that's what you'll need to pinvoke
p62033
aVGraphics
p62034
aVGetHdc() gets you a device context handle
p62035
aVFont
p62036
aVToHfont() gets you a font handle
p62037
aVPinvoke SelectObject to select the font into the device context and its ready for use
p62038
aVBe sure to restore everything when you're done
p62039
aVVisit pinvoke
p62040
aVnet for the declarations you'll need
p62041
as(dp62042
g9
V17034
p62043
stp62044
a((dp62045
g2
(lp62046
VThat's part of the reason you're having trouble
p62047
aVThe Elapsed event runs on a threadpool thread, forcing you to do the BeginInvoke song and dance
p62048
aVUse a System
p62049
aVWindows
p62050
aVForms
p62051
aVTimer instead, its Tick event runs on the UI thread
p62052
aVYou'll also run into trouble with memory management, these classes need to implement IDisposable
p62053
as(dp62054
g9
V17034
p62055
stp62056
a((dp62057
g2
(lp62058
VAltering the device data is what the GPS Intermediate Driver is supposed to do
p62059
aVIt isolates your app from the implementation details of the GPS device so that your code can work with any GPS device
p62060
aVI can't diagnose the exact problem you are having from your question, I can only recommend the docs
p62061
as(dp62062
g9
V17034
p62063
stp62064
a((dp62065
g2
(lp62066
VThe workaround you found is actually a pretty decent one
p62067
aVThere might be small odds that LoadLibraryEx() with the LOAD_LIBRARY_AS_IMAGE_RESOURCE option will work
p62068
aVThat option allows you to load it multiple times
p62069
aVI seriously doubt it though, the DLL almost certainly relies on getting its runtime support code initialized through DllMain
p62070
aVOne thing I didn't hear you mention is the pain of having to use GetProcAddress()
p62071
aVMake sure you do or you'll still stomp global variables when you start threading
p62072
aVEach thread must use its own address
p62073
as(dp62074
g9
V17034
p62075
stp62076
a((dp62077
g2
(lp62078
VWell, message queuing is great for its guaranteed delivery over a transactional queue
p62079
aVWhich helps making your system resilient to crashes and unexpected reboots
p62080
aVBut that will typically only work out well when you can restart your app from such a mishap and be able to restore state before you start receiving messages again
p62081
aVThat's a non-trivial requirement
p62082
aVIf you cannot meet it, any stateful messages tend to take the machine down again
p62083
aVThere's almost always explicit state in messages, even if their content is not stateful, simply by the order in which they are received and mutate your program state
p62084
aVThis has been the curse for middleware, software that assumes that networking is an implementation detail that can be abstracted away does not work well in practice
p62085
aVI thought this answer at SO expressed this problem particularly well
p62086
as(dp62087
g9
V17034
p62088
stp62089
a((dp62090
g2
(lp62091
VAppDomain
p62092
aVUnhandledException is your friend
p62093
aVBeware that the exception info you can get out of the e
p62094
aVExceptionObject is almost always more useful than the minidump
p62095
aVHave you tried minidump debugging yet
p62096
aVThey are invaluable to C/C++ programmers when created in the callback set by SetUnhandledExceptionFilter()
p62097
aVThat's not appropriate in a managed program though, the CLR already installs one
p62098
aVNot having to screw around with minidumps anymore and getting clean stack traces is one of
p62099
aVNET's great advantages
p62100
as(dp62101
g9
V17034
p62102
stp62103
a((dp62104
g2
(lp62105
VWell, same thing minus the extra yield you got
p62106
as(dp62107
g9
V17034
p62108
stp62109
a((dp62110
g2
(lp62111
VThat setting is only appropriate if you use the environment variable
p62112
aVI'm pretty sure from previous questions that you actually use Visual Studio
p62113
aVThe MSDN page is here
p62114
aVOr press F1 when you've got the dialog up
p62115
as(dp62116
g9
V17034
p62117
stp62118
a((dp62119
g2
(lp62120
VHmm, unusual
p62121
aVIs there a Debugger
p62122
aVLaunch() statement in your code
p62123
as(dp62124
g9
V17034
p62125
stp62126
a((dp62127
g2
(lp62128
VYes, when the DGV is not bound then cells default to storing strings
p62129
aVSetting the column's CellType property can solve that, Decimal is most appropriate for handling money values
p62130
aVYou'll also need to implement the DataError event so you can warn the user that the string cannot be converted
p62131
aVThus:
p62132
as(dp62133
g9
V17034
p62134
stp62135
a((dp62136
g2
(lp62137
VI think you'd want System
p62138
aVEnterpriseServices
p62139
aVRegistrationHelper
p62140
aVUninstallAssembly()
p62141
as(dp62142
g9
V17034
p62143
stp62144
a((dp62145
g2
(lp62146
VYeah, looks like something you shouldn't ignore
p62147
aVThey are the threadpool thread that the Timer class uses to make the callback
p62148
aVThey are deadlocked, looks like they are waiting for a method call that's marshaled by COM to complete
p62149
aVThere should be another thread in your program, one of the other 10 on which you created the GIS object
p62150
aVThat thread is not pumping a message loop, a hard requirement for an STA thread that creates single apartment threaded COM components
p62151
aVOr it is stuck itself, not re-entering the message loop
p62152
aVGetting a managed stack trace ought to make it easier to see where the thread is stuck
p62153
aVTrying to use threads on a COM object that explicitly doesn't support them (very few do) is pointless
p62154
aVBe sure to create the GIS object on your program's main UI thread
p62155
aVAnd use a DispatcherTimer
p62156
aVCreating your own STA thread that pumps a message loop can be a solution when the GIS component is taking too much of a hit on your user interface
p62157
as(dp62158
g9
V17034
p62159
stp62160
a((dp62161
g2
(lp62162
VThe source of the problem is likely on the other end of the wire
p62163
aVTo let SerialPort
p62164
aVReadLine() complete and not generate a time-out error you must transmit a line end character sequence
p62165
aVThe value of SerialPort
p62166
aVNewLine, which defaults to the line feed control character ("\u005cn")
p62167
aVIf you transmit bytes instead of characters then you should use Read() instead
p62168
aVYou should also implement the ErrorReceived event so you can detect communication errors
p62169
aVThe kind you'll get when the communication parameters do not match, like Baudrate, Parity, Databits and Stopbits
p62170
as(dp62171
g9
V17034
p62172
stp62173
a((dp62174
g2
(lp62175
VFrom the docs:
p62176
aVGO is not a Transact-SQL statement; it
p62177
aVis a command recognized by the sqlcmd
p62178
aVand osql utilities and SQL Server
p62179
aVManagement Studio Code editor
p62180
aVEither use such a tool to execute the script or omit the GO commands
p62181
as(dp62182
g9
V17034
p62183
stp62184
a((dp62185
g2
(lp62186
VIt isn't exactly clear what kind of problem you are having
p62187
aVIt is very unlikely that the quoted MSDN article is relevant, a Dell Optiplex 760 doesn't have multiple processors
p62188
aVJust one with multiple cores, it is not subject to this kind of bug
p62189
aVYou can easily test this by running your program with the start
p62190
aVexe, it allows setting the processor affinity:
p62191
aVstart /affinity 1 yourapp
p62192
aVexe
p62193
aVPerhaps more relevant is that newer machines take shortcuts on the frequency source, using whatever source happens to be available in the chipset
p62194
aVThey typically have a much higher return value for QueryPerformanceFrequency
p62195
aVTwo billion isn't unusual, maybe that screws up your math
p62196
aVWorking with 'currency' instead of a true 64-bit integer is rather toe-curling
p62197
aVAlso check the BIOS revision for your machine, they had rather a large number of them, all the way up to A08
p62198
as(dp62199
g9
V17034
p62200
stp62201
a((dp62202
g2
(lp62203
VNot quite sure I follow
p62204
aVUsing the text box' Changed event would be a good trigger instead of a button
p62205
aVJust iterate the list items and check for a match with String
p62206
aVStartsWith
p62207
aVFor example:
p62208
as(dp62209
g9
V17034
p62210
stp62211
a((dp62212
g2
(lp62213
VIf you dig through the code for DataTable with Reflector, you'll encounter this method, called by the private Clone(DataSet) method:
p62214
aVIn other words, it creates a new instance of your class, not DataTable
p62215
aVBe careful, this clone will have a deep copy of the typical DataTable properties but any fields you might have added but do not assign in your constructor will have their default values
p62216
as(dp62217
g9
V17034
p62218
stp62219
a((dp62220
g2
(lp62221
VThey are SAL annotations in the Source-code Annotation Language
p62222
aVMicrosoft tooling depends on it
p62223
aVThe MSDN Library article is here
p62224
aVA good example is Code Analysis
p62225
aVAnother quite unrelated tool, but empowered by these annotations is the Pinvoke Interop Assistant
p62226
as(dp62227
g9
V17034
p62228
stp62229
a((dp62230
g2
(lp62231
VYou ought to add another property to the Asteroid class
p62232
aVSay MotionVector
p62233
aVInitialize its X and Y members from Random
p62234
aVNext()
p62235
aVNow you just need to add these to the X and Y properties inside this loop
p62236
as(dp62237
g9
V17034
p62238
stp62239
a((dp62240
g2
(lp62241
VThe Visual Studio hosting process is capable of redirecting console output to the Output window
p62242
aVHow exactly it manages to do this is not documented at all, but it gets in the way here
p62243
aVIt intercepts the WriteFile() call that generates the output of puts()
p62244
aVProject + Properties, Debug tab, untick "Enable the Visual Studio hosting process"
p62245
aVOn that same page, enabling unmanaged debugging also fixes the problem
p62246
as(dp62247
g9
V17034
p62248
stp62249
a((dp62250
g2
(lp62251
VYou should never get yourself into a situation where you might be holding onto a handle that isn't valid
p62252
aVIf necessary, set the handle to NULL after calling DeleteObject() so it is completely obvious
p62253
aVAssuming that a GDI function will give you a FALSE return value because you passed a bad handle isn't safe
p62254
as(dp62255
g9
V17034
p62256
stp62257
a((dp62258
g2
(lp62259
VThis extra padding is necessary to get the members aligned properly when you create an array of these structures
p62260
aVWithout it, the 2nd element of the array would have the ident member aligned on an address that's not a multiple of 4
p62261
aVIt is probably too late to do anything about it, you probably wrote files with this structure before
p62262
aVChanging the packing will make these files unreadable
p62263
aVBut, yes, having file data that's dependent on compiler settings isn't the greatest idea
p62264
aVHaving data stored in a human-readable format is common these days
p62265
aVNeither the disk bytes nor the CPU cycles are worth it
p62266
as(dp62267
g9
V17034
p62268
stp62269
a((dp62270
g2
(lp62271
VIt is a sucky comment, designed by the author to cover his ass
p62272
aVBut pointless when he doesn't explain what it means
p62273
aVYour mental model about how Visual Studio works is intact, one project creates one assembly
p62274
aVBut as you guessed, the CLR doesn't have this requirement
p62275
aVAn assembly can be built-up from multiple modules
p62276
aVThe important ingredients are the /target:module option for the C# compiler and the al
p62277
aVexe tool to link the modules into an assembly
p62278
aVThese options are very important to Microsoft, that's how core assemblies like mscorlib
p62279
aVdll get built
p62280
aVSoul of the machine stuff, you shouldn't ever have to decent that far
p62281
as(dp62282
g9
V17034
p62283
stp62284
a((dp62285
g2
(lp62286
VWrite code to recognize the WM_MOUSEWHEEL message in your control's window procedure
p62287
as(dp62288
g9
V17034
p62289
stp62290
a((dp62291
g2
(lp62292
VSwitch back to VS and use Tools + Attach to Process
p62293
aVClick No on the JIT debugger prompt :)
p62294
as(dp62295
g9
V17034
p62296
stp62297
a((dp62298
g2
(lp62299
VI'd rather not have to change the GUID's or names for individual types in the assembly for versioning purposes
p62300
aVBut that exactly what you have to do to prevent COM types from interfering with each other
p62301
aVThe [Guid] is used to select the registry key in HKLM\u005cSoftware\u005cClasses\u005cCLSID where the COM class is registered
p62302
aVTwo distinct versions with the same Guid will overwrite each others keys
p62303
aVOtherwise known as DLL Hell
p62304
aVChanging the public interface requires a new Guid to ensure that clients that use the old one don't die with impossible to diagnose misbehavior
p62305
aVA rock-hard COM requirement
p62306
aVOmitting the [Guid] attribute is very possible, you now leave it up to the CLR to generate one for you
p62307
aVNow the assembly attributes start to play a role, the guid value is auto-generated by a slick algorithm that includes the assembly name and the version as well as the set of methods on the interface and their arguments
p62308
aVThus ensuring that any changes automagically produce a different guid
p62309
aVAnd, as expected and required, a different [AssemblyVersion] will generate a different [Guid]
p62310
aVAnother approach, which is what I assumed you meant with 'side-by-side', is to not register the assembly but rely on a manifest instead
p62311
aVIt must be embedded in the client program, you use the  element to declare your [ComVisible] class
p62312
aVVersioning now becomes a deployment detail
p62313
aVThe MSDN how-to is here
p62314
aVKeep in mind that it has to be embedded in the client program, not your [ComVisible] assembly
p62315
aVThat tends to be a problem
p62316
as(dp62317
g9
V17034
p62318
stp62319
a((dp62320
g2
(lp62321
VThe default marshaling for strings is as 8-bit characters, LPWSTR is a Unicode string though
p62322
aVThe return type isn't correct either
p62323
aVFix:
p62324
as(dp62325
g9
V17034
p62326
stp62327
a((dp62328
g2
(lp62329
VYou can assign the name in the threaded code, useful for debugging
p62330
aVThis worked:
p62331
as(dp62332
g9
V17034
p62333
stp62334
a((dp62335
g2
(lp62336
VIf you don't get "x64" in the New Platform combo then the x64 C/C++ compilers are not installed
p62337
aVThey are not by default (remarkably) unless you started the VS2008 install with the Custom option and turned the option on
p62338
aVRerun setup
p62339
aVexe to add them, don't forget to rerun the SP1 setup as well
p62340
aVYou can double-check by verifying if the vc\u005cbin\u005camd64 folder is present in the VS install folder, that's the home of the 64-bit build tools
p62341
aVAnother trap exists when the x64 platform already exists in the solution file, brought in by the managed projects
p62342
aVBe sure to untick the "Create new solution platform" checkbox in the dialog
p62343
as(dp62344
g9
V17034
p62345
stp62346
a((dp62347
g2
(lp62348
VUnfortunately, there's no real practical solution to your problem
p62349
aVYou'd have to create a custom TabControl as well and give it its own designer so that it will create instances of your derived class instead of the default TabPage class
p62350
aVSadly, the TabControlDesigner class in System
p62351
aVDesign
p62352
aVdll is internal and can't be derived from
p62353
aVYou'd have to write a complete replacement for it
p62354
aVThat's difficult, it is a pretty advanced designer
p62355
aVYou could have a look-see with Reflector to find out what it takes
p62356
as(dp62357
g9
V17034
p62358
stp62359
a((dp62360
g2
(lp62361
VDrop a PrintDocument on your form
p62362
aVYou'll want a PrintPreviewDialog and PrintDialog as well
p62363
aVSet the dialogs' Document property to the PrintDocument
p62364
aVImplement the PrintPage event handler for it, could be a simple as:
p62365
aVAnd add buttons or menu items to call the dialogs' ShowDialog() method
p62366
as(dp62367
g9
V17034
p62368
stp62369
a((dp62370
g2
(lp62371
VYou can control it in your program, set the SubMenu1's RightToLeft property to RightToLeft
p62372
aVYes
p62373
aVThat has some side effects, the text will now be right-aligned and the arrow will point the correct way
p62374
aVYou'd probably want to set the property in the a DropDownOpening event handler for the "Menu" item
p62375
as(dp62376
g9
V17034
p62377
stp62378
a((dp62379
g2
(lp62380
VYou are creating a new instance of the form
p62381
aVThat form is not going to have anything entered in the textBox4 control, the Parse() method will of course complain about it
p62382
aVYou have to use the existing instance of the form, the one that the user is looking at
p62383
aVPass a reference to it through the Form2 constructor
p62384
aVOr use a property
p62385
aVOr use Application
p62386
aVOpenForms if you really have to
p62387
as(dp62388
g9
V17034
p62389
stp62390
a((dp62391
g2
(lp62392
VThis is already taken care of by Windows
p62393
aVThe timeout counter doesn't start ticking until it detects keyboard or mouse input
p62394
aVFrom the Remarks section of NotifyIcon
p62395
aVShowBalloonTip:
p62396
aVIn addition, if the user does not
p62397
aVappear to be using the computer (no
p62398
aVkeyboard or mouse events are
p62399
aVoccurring) then the system does not
p62400
aVcount this time towards the timeout
p62401
as(dp62402
g9
V17034
p62403
stp62404
a((dp62405
g2
(lp62406
VNo, the memory pages that contain code are write protected
p62407
aVThis kind of damage could only occur at process initialization time
p62408
aVBut the more likely source is soft RAM errors
p62409
aVAsk your customer to run a RAM test program
p62410
aVConsider file damage is the error is repeatable
p62411
as(dp62412
g9
V17034
p62413
stp62414
a((dp62415
g2
(lp62416
VThe 2nd snippet will crash as well
p62417
aVIt just takes a wholeheckofalot longer since it is consuming memory much slower
p62418
aVPay attention to your hard disk access light, it's furiously blinking while Windows chucks pages out of RAM to make room
p62419
aVThe first string constructor immediately fails since the heap manager won't allow you to allocate 4 gigabytes
p62420
as(dp62421
g9
V17034
p62422
stp62423
a((dp62424
g2
(lp62425
VNET Single and Double are already in IEEE-754 format
p62426
aVYou can use BitConverter
p62427
aVToSingle() and ToDouble() to convert byte[] to floating point, GetBytes() to go the other way around
p62428
as(dp62429
g9
V17034
p62430
stp62431
a((dp62432
g2
(lp62433
VThe problem is that you are already using another thread
p62434
aVTry one of the following approaches
p62435
aVSet the  property so it
p62436
aVraises events on your UI thread
p62437
aVNow you can show a UI that won't
p62438
aVfreeze or
p62439
aVUse  in the event handler
p62440
aVThis was a psychic debugging attempt, there was nothing in your question that helped me be sure that's the correct answer
p62441
as(dp62442
g9
V17034
p62443
stp62444
a((dp62445
g2
(lp62446
Vbuff
p62447
aVLength falls from the sky in that snippet
p62448
aVIt has to be at least as large, if not exactly as large as Marshal
p62449
aVSizeOf(typeof(Spell
p62450
aVSpellEntry))
p62451
aVFurthermore, if BitConverter works then you have to set the Pack property of the [StructLayout] attribute to 1
p62452
aVOnce you've got the buffer length problem sorted out you can find declaration problems by checking the fields for the first mangled value
p62453
aVA generic solution is available in my answer here
p62454
as(dp62455
g9
V17034
p62456
stp62457
a((dp62458
g2
(lp62459
VCode injection in
p62460
aVNET is quite difficult
p62461
aVMostly because code doesn't exist until the last possible moment
p62462
aVA fraction of a second before it starts executing, generated by the JIT compiler
p62463
aVPractical approaches uses IL rewriting, common in AOP for example
p62464
aVThis happens off-line, before the program even starts to execute
p62465
aVThis isn't really 'injection' anymore, you physically change the program on disk
p62466
aVThere is an inline IL rewriting technique, it uses the unmanaged profiler interfaces
p62467
aVPretty impractical, a magazine article that documents the approach is available here
p62468
aVIt is quite dated, the profiler API has changed quite a bit since then
p62469
aVNever heard of a tool that uses this
p62470
as(dp62471
g9
V17034
p62472
stp62473
a((dp62474
g2
(lp62475
VThis is hard to get right, Mumble must be a static class since you cannot add any members to SpellEntry
p62476
aVThat screws up Marshal
p62477
aVSizeOf(), making it too large
p62478
aVYou'll need to initialize Mumble so that its static GetString() method can access the string table
p62479
aVMoving the SpellName property into another class solves the problem but makes the code ugly too
p62480
aVThis is liable to confuse you badly
p62481
aVIf you got a version going that uses BitConverter then you're definitely better off by using it instead
p62482
aVSeparating the file format from the runtime format is in fact an asset here
p62483
as(dp62484
g9
V17034
p62485
stp62486
a((dp62487
g2
(lp62488
VWriting Windows device drivers in C++ isn't impossible, there are not many CRT functions that you could use to get you into trouble
p62489
aVThe new operator is unusable for example, you don't have to fear a std::bad_alloc
p62490
aVUnless you replace it, that cuts out a rather large swath of standard C++ library classes
p62491
aVBut that's not really the point of a device driver, it is rather important that you make it as small as possible
p62492
aVC++ pays off when you write complex code
p62493
aVYou explicitly do not want to write complex code in a device driver
p62494
aVDebugging it is redrum
p62495
aVLinus really likes C in the kernel
p62496
aVThere's a good reason for that
p62497
as(dp62498
g9
V17034
p62499
stp62500
a((dp62501
g2
(lp62502
VTry DeviceIoControl with IOCTL_DISK_SET_CACHE_INFORMATION
p62503
as(dp62504
g9
V17034
p62505
stp62506
a((dp62507
g2
(lp62508
VIf you create a GraphicsPath then you both draw it (Graphics
p62509
aVDrawPath) and do hit testing with GrapicsPath
p62510
aVIsVisible
p62511
aVIf the drawing is convoluted with overlapping layers of paint then you could draw to the screen as well as a back-bitmap
p62512
aVWith the latter using color values to indicate specific objects
p62513
aVHit test with GetPixel()
p62514
as(dp62515
g9
V17034
p62516
stp62517
a((dp62518
g2
(lp62519
VDon't use file
p62520
aVFullName to open the file
p62521
aVYou get a FileInfo object back, use one of its OpenXxxx() methods to open the file
p62522
as(dp62523
g9
V17034
p62524
stp62525
a((dp62526
g2
(lp62527
VThere's an easy explanation for this: un/boxing is fast
p62528
aVIt needed to be back in the
p62529
aVNET 1
p62530
aVx days
p62531
aVAfter the JIT compiler generates the machine code for it, there's but a handful of CPU instructions generated for it, all inline without method calls
p62532
aVNot counting corner cases like nullable types and large structs
p62533
aVThe effort of looking up a cached value would greatly diminish the speed of this code
p62534
as(dp62535
g9
V17034
p62536
stp62537
a((dp62538
g2
(lp62539
VYou are asking the wrong question, you should be worried far more about the cost of Regex
p62540
aVEnumerating the tokens will be a very small fraction of that, there's just no point in optimizing code that could be double as fast but only improves program perf by 1%
p62541
aVWrite the code, profile it, you'll know what to do for version 2
p62542
aVGiven that these kind of tools run at 'human time' (no perceptible difference when the program takes twice as long when it needs 20 milliseconds), the most likely result is "nothing needs done"
p62543
as(dp62544
g9
V17034
p62545
stp62546
a((dp62547
g2
(lp62548
VThe generated file needs to use the Implements keyword
p62549
aVHard requirement in the VB
p62550
aVNET language, there is no workaround for that
p62551
aVThat doesn't otherwise have anything to do with partial classes
p62552
as(dp62553
g9
V17034
p62554
stp62555
a((dp62556
g2
(lp62557
VThe sender is the BarManager
p62558
aVUse e
p62559
aVItem instead
p62560
as(dp62561
g9
V17034
p62562
stp62563
a((dp62564
g2
(lp62565
VYou'll want RegistrationHelper
p62566
aVInstallAssemblyFromConfig()
p62567
as(dp62568
g9
V17034
p62569
stp62570
a((dp62571
g2
(lp62572
VThe ToolStripItem classes are special, they don't derive from Control
p62573
aVOne side-effect of that is that they don't take the focus away from the active control
p62574
aVAnd that prevents the Validating event from firing
p62575
aVSeveral things you can do
p62576
aVYou could call the textbox' parent's ValidateChildren() method
p62577
aVOr you could move the focus yourself:
p62578
as(dp62579
g9
V17034
p62580
stp62581
a((dp62582
g2
(lp62583
VUse VerQueryValue()
p62584
as(dp62585
g9
V17034
p62586
stp62587
a((dp62588
g2
(lp62589
VPointers are not supported in VB
p62590
aVNET
p62591
aVThe alternatives are unpleasantly slow as long as VB
p62592
aVNET is your requirement, the Marshal class is all you got
p62593
aVIt shouldn't have to be, adding a C# class library to your solution and using its classes in your VB
p62594
aVNET code is very well supported in Visual Studio
p62595
as(dp62596
g9
V17034
p62597
stp62598
a((dp62599
g2
(lp62600
VA thread doesn't have a parent
p62601
aVThe notion is meaningless
p62602
aVThe 'container' for threads is the process
p62603
as(dp62604
g9
V17034
p62605
stp62606
a((dp62607
g2
(lp62608
VThis is very unusual but it is technically possible
p62609
aVSerialPort uses threadpool threads to call the DataReceived event handler
p62610
aVAs soon as it receives one or more bytes, it grabs a TP thread to notify your app
p62611
aVThere's a lock in the event generation code, only one thread can call your event handler at a time
p62612
aVA potential failure mode here is that one of these calls, likely the first one, enters a loop in your code from which it never exits
p62613
aVIf you haven't set up the Handshake property, the device can keep sending and triggering more TP calls, all of them blocking on that lock
p62614
aVDiagnose this from the Debug + Windows + Threads window
p62615
aVIf my guess is accurate then you should see a large number of threads listed here
p62616
aVOne of them should be inside your DataReceived event handler, double-click it and look at the call stack to see where it is stuck
p62617
aVThe memory you are seeing consumed is eaten by the stacks of these threads, one megabyte each
p62618
aVAnother possibility is that your DataReceived event handling code is very slow, possibly by calling Control
p62619
aVInvoke()
p62620
aVSlow enough to not be able to keep up with the device
p62621
aVYou now really do need to use the Handshake property to setup flow control
p62622
aVOr fix whatever makes it so slow
p62623
aVThere should also be a very large number of ErrorReceived events btw, be sure to implement it so you can see this stuff going wrong
p62624
aVThere's an upper limit on the number of TP threads that can be running at the same time
p62625
aVIt is rather generous, 250 times the number of cores
p62626
aVThat can easily consume half a gigabyte of memory on a typical dual-core machine
p62627
as(dp62628
g9
V17034
p62629
stp62630
a((dp62631
g2
(lp62632
VCompile tab
p62633
aVScroll down and right, click the Build Events button
p62634
aVBut, no need to do it that way, just add it to your project with Project + Add Existing Item
p62635
aVSelect it and in the Property window set Build Action to "Content" if you want it deployed, Copy to Output to "Copy if newer"
p62636
as(dp62637
g9
V17034
p62638
stp62639
a((dp62640
g2
(lp62641
VYour guess is accurate, ProcessCmdKey() is directly called from the Winforms message loop as started by Application
p62642
aVRun()
p62643
aVYou are now running the WPF message loop, it doesn't know anything about the Winforms keyboard handling
p62644
aVTabbing should be dysfunctional too
p62645
aVThere is no clean fix for this, the object models are too different
p62646
aVSystem
p62647
aVWindows
p62648
aVForms
p62649
aVIntegration provides interop between the two but that works at the control level, not the window level
p62650
aVForm
p62651
aVKeyPreview is a possible workaround
p62652
aVSo is Form
p62653
aVShowDialog()
p62654
aVAnd yes, you can start a new STA thread (use Thread
p62655
aVSetApartmentState) and call Application
p62656
aVRun() to start a Winforms message loop
p62657
aVA nasty problem with that however is that these forms have no Z-order relationship with the WPF windows
p62658
aVThey'll easily disappear behind the window of another app
p62659
aVFixing that requires pinvoking SetParent(), the Owner property will throw an exception
p62660
as(dp62661
g9
V17034
p62662
stp62663
a((dp62664
g2
(lp62665
VIt's already there, use either CString (project setting), CStringA or CStringW
p62666
aVAfter 17+ years of Unicode and operating systems that are exclusively Unicode, there are very few reasons left to avoid getting the project setting right
p62667
as(dp62668
g9
V17034
p62669
stp62670
a((dp62671
g2
(lp62672
VProject + Add New Item, select "Application Configuration File"
p62673
aVEdit that one
p62674
aVThe IDE makes sure that it gets copied to the bin\u005cDebug directory and that the vshost version will match
p62675
as(dp62676
g9
V17034
p62677
stp62678
a((dp62679
g2
(lp62680
VAt IBM
p62681
aVThe interop library is just an auto-generated helper assembly that the CLR will use to make the COM calls
p62682
aVIt has a one-to-one mapping to the methods that should be documented by IBM
p62683
aVThis is probably a better link, the docs look quite minimal
p62684
as(dp62685
g9
V17034
p62686
stp62687
a((dp62688
g2
(lp62689
VNo 3rd party app is going to tell you that it moved your ListBoxItem
p62690
aVAt best it will use the text representation and tell you it copied
p62691
aVGetting a move requires a drop target that can recognize your object in its DragEnter event handler and decide that it can take responsibility for it
p62692
aVOnly you could write such an event handler
p62693
as(dp62694
g9
V17034
p62695
stp62696
a((dp62697
g2
(lp62698
VThis is a known problem, it seems to strike particularly often in a unit test scenario
p62699
aVThe bug has been identified by the Debugger team as of October 1st, getting it to your machine is what tends to take a while
p62700
aVThe feedback article is here, vote it up and keep an eye on it
p62701
aVIf this will be a hotfix instead of rolled into the next service pack then it will be published here
p62702
aVUPDATE: this was a regression from VS2008, a post-SP1 hotfix repaired it but the hotfix updates didn't make it into the VS2010 code base
p62703
aVIt was again fixed in VS2010 SP1
p62704
as(dp62705
g9
V17034
p62706
stp62707
a((dp62708
g2
(lp62709
VIt corresponds to a restriction in the x64 architecture
p62710
aVRelative addressing is limited to a signed 32-bit offset value
p62711
aVMatt Pietrek mentions this in this article (near "Luckily, the answer is no")
p62712
aVThis restriction also explains why
p62713
aVNET objects are still limited to 2GB in 64-bit mode
p62714
aVSimilarly, in native x64 C/C++ code memory allocations are limited as well
p62715
aVIt is not that it is impossible, the displacement could be stored in a 64-bit register, it is just that this would make array indexing a lot more expensive
p62716
aVThe mysterious return type of Marshal
p62717
aVOffsetOf() is probably a corner-case
p62718
aVA managed struct could result in an unmanaged version after applying [StructLayout] and [MarshalAs] that's larger than 2GB
p62719
aVYes, this wouldn't map well to some future 128-bit architecture
p62720
aVBut it is extraordinarily difficult to prep today's software for an arch when nobody knows what it will look like
p62721
aVPerhaps the old adage fits, 16 Terabytes ought to be enough for anybody
p62722
aVAnd there's lots of room left to grow beyond that, 2^64 is rather a large number
p62723
aVCurrent 64-bit processors only implement 2^48
p62724
aVSome seriously non-trivial problems need to be solved before machines can move that close
p62725
as(dp62726
g9
V17034
p62727
stp62728
a((dp62729
g2
(lp62730
VThe term "usb port" doesn't mean anything
p62731
aVThe B in USB means "bus", it is a generic way for any kind of device to talk to the machine
p62732
aVA driver is required to make the device usable
p62733
aVJust as you have drivers for your video card and your NIC
p62734
aVA common way make USB device usable from user mode code is for the driver to emulate an old-fashioned serial port
p62735
aVYou'd use the SerialPort class in
p62736
aVNET
p62737
aVCheck the specs of the device to see what its driver does
p62738
as(dp62739
g9
V17034
p62740
stp62741
a((dp62742
g2
(lp62743
VA similar question would be "how do I debug my operating system"
p62744
aVYou don't, you keep your fingers crossed that it will give you a decent error code and message when you use it improperly
p62745
aVEven if you do find a bug in the library, there's nothing you can do about it unless you have the source code and the right to rebuild it
p62746
aVReview the license agreement you've got to use this library for support options
p62747
as(dp62748
g9
V17034
p62749
stp62750
a((dp62751
g2
(lp62752
VThe CLR cannot magically inject unhandled exception handling into native pinvoked code when that code itself doesn't take care of it
p62753
aVParticularly any kind of hardware exception like AccessViolation in a thread that the CLR doesn't know about will terminate the app without a diagnostic
p62754
aVYou'll need to work with the owner or author of that code to improve the reliability and maintainability of that code
p62755
as(dp62756
g9
V17034
p62757
stp62758
a((dp62759
g2
(lp62760
VIt doesn't actually stop you from doing this
p62761
aVIn particular for
p62762
aVNET 4
p62763
aV0, you can use the Browse tab to access c:\u005cwindows\u005cmicrosoft
p62764
aVnet\u005cassembly
p62765
aVThe shell extension handler that stops you from accessing the
p62766
aVNET 2
p62767
aV0 GAC through the shell dialogs isn't included for 4
p62768
ag2512
aVBut yeah, that's a really bad idea
p62769
aVThe GAC is a deployment implementation detail, you cannot presume that the content of your GAC will match the content on another machine
p62770
aVOnly a reference assembly can give you a stable set of type definitions that don't change when, say, you get a security update through Windows Update
p62771
aVThis is even more relevant for
p62772
aVNET 4
p62773
ag2512
aVIts reference assemblies are special
p62774
aVThey are no longer a copy of the assemblies you might find in the GAC or in c:\u005cwindows\u005cmicrosoft
p62775
aVnet
p62776
aVThey only contain metadata, no IL
p62777
aVThis allows Microsoft to deploy updates that change the public types in the assemblies
p62778
aVSomething that went badly wrong in the
p62779
aVNET 2
p62780
aV0 service packs (WaitHandle
p62781
aVWaitOne(int) for example)
p62782
as(dp62783
g9
V17034
p62784
stp62785
a((dp62786
g2
(lp62787
VYou have to create an STA thread that pumps a message loop
p62788
aVThat's the only hospitable environment for an ActiveX component like WebBrowser
p62789
aVYou won't get the DocumentCompleted event otherwise
p62790
aVSome sample code:
p62791
as(dp62792
g9
V17034
p62793
stp62794
a((dp62795
g2
(lp62796
VA COM method that takes a raw pointer like that isn't Automation compatible
p62797
aVIt is quite unusual, COM methods take COM interface pointers in this kind of scenario
p62798
aVYou'd better check with Object Browser what it looks like after the type library got converted
p62799
aVYou've got a problem when the argument type is object
p62800
aVYou might be better off keeping the COM interface code in C++/CLI as well
p62801
as(dp62802
g9
V17034
p62803
stp62804
a((dp62805
g2
(lp62806
VDo not ignore the Obsolete warnings on the Suspend and Resume methods
p62807
aVThey were obsoleted for this exact reason
p62808
aVThe exact place in code where they will freeze is completely unpredictable
p62809
aVQuite bad news if that's inside a lock statement
p62810
aVYou've also created a time slot where both will be running
p62811
aVDon't use threads for this
p62812
as(dp62813
g9
V17034
p62814
stp62815
a((dp62816
g2
(lp62817
VNo, nothing like it
p62818
aVYou can however create your own
p62819
aVThe wave\u005cwavestream\u005cwavefilereader
p62820
aVcs source code file is probably best to get started with
p62821
aVBunch of stuff you can strip from it, replace the waveStream by a properly initialized MemoryStream
p62822
as(dp62823
g9
V17034
p62824
stp62825
a((dp62826
g2
(lp62827
VIt is quite murky how the command interpreter's CD command would do anything to enhance a 'search capability'
p62828
aVStarting one with the right 'CD' directory isn't difficult
p62829
aVJust use CreateProcess to start cmd
p62830
aVexe
p62831
aVThe lpCurrentDirectory argument lets you set the current directory
p62832
aVShellExecuteEx() works too, a bit easier to get right
p62833
as(dp62834
g9
V17034
p62835
stp62836
a((dp62837
g2
(lp62838
VThat's Color
p62839
aVFuchsia
p62840
aVIt's a great fuchsed-up color that is very unlikely to ever be used in a bitmap
p62841
aVVery commonly used in old C/C++ user interface code to make 24-bpp bitmaps, a format that doesn't support transparency, into bitmaps that behave like they do
p62842
aVI'll spare you the C code that's required to make that work, it's quite fuchsed-up
p62843
aVA lot of the bitmaps that are in the image library came from internal Microsoft projects that used this trick
p62844
aVBig chunks of Windows are still native C++ code that uses the raw Win32 api, GDI doesn't support transparency at all so 24-bpp was common
p62845
aVYou'd need a decent graphics editor, the first order of business is to turn it into a 32-bpp bitmap
p62846
aVThen color-replace
p62847
aVI'd personally use a quicky
p62848
aVNET program that uses Bitmap
p62849
aVMakeTransparent(), draw to a 32-bpp bitmap and save that as a
p62850
aVpng
p62851
as(dp62852
g9
V17034
p62853
stp62854
a((dp62855
g2
(lp62856
VThe compiler embeds the [TargetFramework] attribute into the assembly
p62857
aVYou can read it back at runtime with reflection
p62858
aVSome sample code:
p62859
aVDisplayed value on my machine: "Silverlight 4"
p62860
as(dp62861
g9
V17034
p62862
stp62863
a((dp62864
g2
(lp62865
VYou need two casts:
p62866
as(dp62867
g9
V17034
p62868
stp62869
a((dp62870
g2
(lp62871
VChange their Dock property to Fill
p62872
aVA SplitContainer is a common choice btw, gives the user control over the visible panel size
p62873
as(dp62874
g9
V17034
p62875
stp62876
a((dp62877
g2
(lp62878
VUsing FindWindow() would only make sense if the window belongs to another process
p62879
aVWhich explains why GetClients() doesn't return anything, it would only be able to return clients from your process
p62880
aVThis would be in general unsolvable unless this library has some kind of out-of-process support
p62881
aVThat's quite rare
p62882
as(dp62883
g9
V17034
p62884
stp62885
a((dp62886
g2
(lp62887
VThe JIT compiler knows the address of the static o variable
p62888
aVIt allocated it in the loader heap
p62889
aVThat it is a member of a generic class is not relevant
p62890
aVIn other words, resolving the address of a static variable does not require a runtime lookup, it is done at compile time
p62891
aVThe generated machine code is trivial:
p62892
aVNote the hard-coded addresses
p62893
as(dp62894
g9
V17034
p62895
stp62896
a((dp62897
g2
(lp62898
VYeah, you can do this by using more than one platform
p62899
aVTricky to get right though, you can't get the settings initialized from a project template
p62900
aVBest thing to do is to start the project with a SmartDevice project template since it has the most custom settings
p62901
aVThen Build + Configuration Manager, Active solution platform = New and select Type = Win32, Copy = None
p62902
aVThat last one is the painful bit, you'll have to change the Win32 specific settings yourself
p62903
aVBest thing to do is to open a sample Win32
p62904
aVvcproj in a text editor and check with setting overrides it has
p62905
aVSo you can reproduce them in your custom project
p62906
aVCopy and paste works btw, that's the quickest and safest way
p62907
as(dp62908
g9
V17034
p62909
stp62910
a((dp62911
g2
(lp62912
s(dp62913
g9
V17034
p62914
stp62915
a((dp62916
g2
(lp62917
VThere is an active bug report for this problem at Connect
p62918
aVThere's a dire need for a repro, a project with specific steps to let them reproduce the issue in-house
p62919
aVPerhaps you can help, it's what it will take to solve it or recommend a workaround
p62920
aVEDIT: one late addition to this answer, since I've posted this there have been additional questions that note a problem with the IntelliSense parser behaving different from the compiler
p62921
aVThere's an issue with the multi-targeting feature, particularly in VS2010, triggered by the Client Profile option for
p62922
aVNET 4
p62923
aVIt is the default for a new project
p62924
aVWhat goes wrong is adding an assembly reference that requires the full profile, commonly because of a dependency on System
p62925
aVWeb
p62926
aVYou'll get a warning for that, but that's quickly blown away with a large number of errors
p62927
aVThe fix is to change the project's Framework Target from client to full
p62928
as(dp62929
g9
V17034
p62930
stp62931
a((dp62932
g2
(lp62933
VThere is no 'mouse drag event'
p62934
aVYou'll have to sub-class the control
p62935
aVRecord the mouse position in the WM_LBUTTONDOWN message handler and capture the mouse
p62936
aVThen check it against the current mouse position in the WM_MOUSEMOVE message handler
p62937
aVIt the button is still down and the distance is larger than GetSystemMetrics, SM_CXDOUBLECLK and SM_CYDOUBLECLK then make that your mouse drag event
p62938
as(dp62939
g9
V17034
p62940
stp62941
a((dp62942
g2
(lp62943
VUse Debug
p62944
aVWriteLine()
p62945
aVIt's output goes to the Output window
p62946
aVConsole
p62947
aVWriteLine() works the same way in a Winforms app but using Debug is better since that code automatically gets removed in the Release build
p62948
aVAnd of course, you'll want to leverage the debugger first
p62949
as(dp62950
g9
V17034
p62951
stp62952
a((dp62953
g2
(lp62954
VYou have to clear the FPU exception flags in the status word when you catch a floating point exception
p62955
aVCall _clearfp()
p62956
aVConsider using _set_se_translator() to write an exception filter that translate the hardware exception to a C++ exception
p62957
aVBe sure to be selective, only translate the FPU exceptions
p62958
as(dp62959
g9
V17034
p62960
stp62961
a((dp62962
g2
(lp62963
VI wrote a custom CR function a million years ago
p62964
aVThe uffuncs
p62965
aVh header file contained these definitions:
p62966
aVThe documentation you found is compelling though, a HGLOBAL isn't nearly good enough to persist inside a report
p62967
aVIt's a pointer, that's not going to restore properly when the report is loaded again in another session
p62968
aVThose mysterious extra arguments would allow for this
p62969
aVThis header file has a 1997 timestamp
p62970
aVI can only recommend you try to find a more up to date version of the uffuncs
p62971
aVh header file
p62972
aVWherever it might be, I don't remember where I got it from
p62973
aVThe web site docs and links are totally inadequate
p62974
aVPretty typical CR lossage, I resolved to never use CR again after the misery I went through
p62975
as(dp62976
g9
V17034
p62977
stp62978
a((dp62979
g2
(lp62980
VTlbimp
p62981
aVexe can handle a type library resource inside an EXE just fine
p62982
aVFor example:
p62983
aVAutomating this is fairly risky btw
p62984
aVA type library is quite equivalent to an assembly reference
p62985
aVIf it changed you want to know about it
p62986
aVNot just because you may well have to modify your interop code and retest it, DLL Hell is knocking on your door as well
p62987
as(dp62988
g9
V17034
p62989
stp62990
a((dp62991
g2
(lp62992
VIf portability is not a concern then you're basically down to deciding whom you trust more to get this right
p62993
aVA library is generally designed to provide portability
p62994
aVIt otherwise has a tough time competing with an OS provided implementation that's been battle-hardened for over 15 years
p62995
aVCheck this thread to see an example of how the obvious implementation is not in fact the best
p62996
as(dp62997
g9
V17034
p62998
stp62999
a((dp63000
g2
(lp63001
VIf the assembly is not in the GAC then the CLR will search the directories in the probing paths for an executable with the same display name
p63002
aVWhich ever one it finds is then checked for the rest of the assembly attributes, AssemblyVersion, Culture and PublicKeyToken
p63003
aVA mismatch with the reference assembly produces an exception
p63004
aVI'd guess at an assembly version mismatch since culture is normally * and public key token is null
p63005
aVOf course, the exception message will give you a better diagnostic than my answer
p63006
as(dp63007
g9
V17034
p63008
stp63009
a((dp63010
g2
(lp63011
VI assume you mean that the MouseWheel event on the UserControl won't trigger
p63012
aVThat's normal, the TextBox is happy to accept the message when it is multiline
p63013
aVThe reason that the MouseWheel event is not visible in the designer
p63014
aVThe parent window will only see the message when the control with the focus won't process it
p63015
aVNot sure if you should fix this, the user would really expect the text box to scroll
p63016
aVBut you can by intercepting the message so the text box can't see it and passing the message to the parent
p63017
aVAdd a new class to your project, paste the code shown below
p63018
aVCompile
p63019
aVDrop the new control from the top of the toolbox
p63020
as(dp63021
g9
V17034
p63022
stp63023
a((dp63024
g2
(lp63025
VThis code doesn't actually do what you want it to do
p63026
aVIt takes a while for the delegate target to start running
p63027
aVYour worker thread could acquire the write lock many times before that
p63028
aVIt will only fail to acquire the lock when the Update() method happens to be busy executing
p63029
aVA ManualResetEvent is what you want here
p63030
aVInitialize it to be set
p63031
aVReset() it when you BeginInvoke(), Set() it at the end of Update()
p63032
aVNow you can test with WaitOne(0)
p63033
aVNote a corner case with this approach: your UI may well not show the last update
p63034
as(dp63035
g9
V17034
p63036
stp63037
a((dp63038
g2
(lp63039
VThere's nothing quite as nasty as an AccessViolation exception, only StackOverflow is worse
p63040
aVI can make out "communication", that unmanaged code probably runs in a thread that neither the CLR nor the test runner knows anything about
p63041
aVVery limited options there, no way to make a thread like that simply seize to exist
p63042
aVIt's a memory corruption problem, the debug allocator in the CRT fills freed blocks of memory with 0xfeeefeee
p63043
aVThat's not kosher btw, you should only run unit tests on the Release build
p63044
as(dp63045
g9
V17034
p63046
stp63047
a((dp63048
g2
(lp63049
VHmya, no such luck
p63050
aVIt would be very nice indeed if the Type
p63051
aVGetProperty() method would actually say which name was ambiguous
p63052
aVBut it doesn't and you cannot easily find out
p63053
aVThe code lives in the
p63054
aVNET framework and it is optimized, the debugger cannot retrieve the value of the name argument
p63055
aVYour only cue is that your entity model has two properties with the same name
p63056
aVSomething like that anyway
p63057
as(dp63058
g9
V17034
p63059
stp63060
a((dp63061
g2
(lp63062
VThis is an age-old bug in the Windows native combobox control
p63063
aVYes, it selects the text when it gets the WM_SIZE message
p63064
aVThis is specific to DropDownStyle = DropDown
p63065
aVThis is a possible workaround:
p63066
as(dp63067
g9
V17034
p63068
stp63069
a((dp63070
g2
(lp63071
VIt is probably the ActiveX component that bombs, returning E_OUTOFMEMORY
p63072
aVWhich gets translated to OOM
p63073
aVThe problem is that you've got multiple instances of that component running when you runs this code asynchronously
p63074
aVA 50 MB pdf file is going to require a bunch of unmanaged memory, several hundreds of megabytes probably
p63075
aVThe GC
p63076
aVCollect() call works by accident
p63077
aVIt frees your fileBytes arrays
p63078
aVThey are quite large and get put in the Large Object Heap
p63079
aVIt takes a full GC to get them released
p63080
aVWhich your Collect() call does, giving the ActiveX component some breathing room to steal unmanaged memory from the Windows heap manager
p63081
aVYou are just hitting the fundamental memory limitations of a 32-bit process here
p63082
aVYou'll have to at least limit the number of instances of this component to avoid having them gobble too much memory
p63083
aVThreading rarely works on ActiveX components anyway, COM marshals their calls to an STA thread
p63084
as(dp63085
g9
V17034
p63086
stp63087
a((dp63088
g2
(lp63089
VYou are mixing things up rather badly
p63090
aVA setting doesn't have a accessibility modifier, they are always public
p63091
aVHowever, in a Winforms app, you indeed have a "Application settings" property in the Properties window for a control
p63092
aVRight at the top
p63093
aVAnd a Modifier property
p63094
aVThe latter is Friend by default in a VB
p63095
aVNET project, Private in a C# app
p63096
aVThat determines the accessibility of the control variable, not the setting
p63097
aVYes, My
p63098
aVSettings gives you access to the setting that stores the control property value
p63099
aVBut that's where the good news ends
p63100
aVYou should always set the Scope of the setting in the settings designer to User
p63101
aVSo that the value can be saved and restored when your program starts back up
p63102
aVSettings with User scope are stored in a file that's hard to find back
p63103
aVThe typical path of such a file is C:\u005cUsers\u005chpassant\u005cAppData\u005cLocal\u005cWindowsFormsApplication1\u005cWindowsFormsApplication1
p63104
aV_Url_2acx4ldi2zmg42elj3eyqq0snhqco4qe\u005c1
p63105
ag2512
ag2512
ag2512
aVThe first part is me, the current user of my laptop
p63106
aVThe bizarro part of the path name is a hash, a value that's unique for the application name and version
p63107
aVAnd probably something else like the phase of the moon when I compiled the app
p63108
aVThe algorithm to compute that hash isn't documented
p63109
aVJust that it will be unique to my app and cannot be stomped on by another app
p63110
aVAnd that's the rub, one app cannot find the user scoped settings for another app
p63111
aVYou'll have to give up on using settings if that's important to you
p63112
aVAnd replace it with, say, an XmlDocument in a well known location
p63113
as(dp63114
g9
V17034
p63115
stp63116
a((dp63117
g2
(lp63118
VHmya, wrapping Windows messages with a friendly API isn't that difficult
p63119
aVWindows Forms would be a good example
p63120
aVBut that has a knack for running into a very solid wall once you start doing this with another process
p63121
aVThe specific message you need in order to read ListView items is LVM_GETITEM
p63122
aVThat's one of those solid wall messages
p63123
aVThe LPARAM argument you pass to SendMessage() needs to be a pointer to an LVITEM structure
p63124
aVThe control fills in the fields in that structure
p63125
aVProblem is, the pointer you pass is only valid in your process, not the process who owns that window
p63126
aVFixing this takes a great deal of hackery
p63127
aVYou have to allocate memory that's valid inside that process
p63128
aVThat takes VirtualAllocEx() and ReadProcessMemory()
p63129
aVPlus all the glue calls you need to make these work
p63130
aVI assume that this library you are using is not taking care of this
p63131
aVEasy to find out, grep the source code files for these API function names
p63132
as(dp63133
g9
V17034
p63134
stp63135
a((dp63136
g2
(lp63137
VThe timing source for QPC was traditionally never derived from the clock frequency
p63138
aVThe motherboard manufacturers have been cutting corners though, trying to shave off a penny or two
p63139
aVThey typically pick-off a frequency from inside the chipset somewhere
p63140
aVI've heard of somebody's AMD machine that had a QPF value of 2 GHz, dangerously close to a value you'd get for the CPU clock after multiplying
p63141
aVOnly get nervous if you get a large value like that
p63142
aVThe absolute value of QPC should never be your concern
p63143
aVIt is going to heavily depend on the quality of the core
p63144
aVOnly ever use QPC measurements to look for incremental improvements to your code
p63145
as(dp63146
g9
V17034
p63147
stp63148
a((dp63149
g2
(lp63150
VThis is not possible, it is an unsolvable race condition
p63151
aVThe listener could have accepted a connection a microsecond before you want to suspend it
p63152
aVClosing the listener so it won't accept any connections is the only sure way
p63153
aVRethink your logic here
p63154
aVWhatever it is going to do with that connection that makes you want to stop it probably needs to be locked instead
p63155
as(dp63156
g9
V17034
p63157
stp63158
a((dp63159
g2
(lp63160
VYou can find a list here
p63161
aVNo winforms, java rules in that world
p63162
aVDoesn't matter, ERP has little to do with user interface programming
p63163
as(dp63164
g9
V17034
p63165
stp63166
a((dp63167
g2
(lp63168
VWell, it is hardly a slam-dunk, there are a great many
p63169
aVNET compatible compilers out there
p63170
aVBeing able to include relocatable machine code in an assembly has many uses
p63171
aVBut yeah, if you know the assembly was built with Microsoft tools then the C++/CLI compiler was the likely source
p63172
aVThe other compilers they supply only generate pure assemblies
p63173
aVThere's one way to narrow it down, have a look-see with ildasm
p63174
aVexe or Reflector
p63175
aVIf you see a class named  then the odds are very close to 100%
p63176
as(dp63177
g9
V17034
p63178
stp63179
a((dp63180
g2
(lp63181
VNot sure if one size fits all, but yeah, it is largely a mechanical process
p63182
aVYour ref class wrapper should declare a private member that's a pointer to your native C++ class
p63183
aVCreate the instance in the constructor
p63184
aVYou'll need a destructor and a finalizer to delete that instance again
p63185
aVThen for each function in the native C++ class you write a managed version of it
p63186
aVThat's almost always a one-to-one call, you simply call the corresponding native method and let C++ Interop convert the arguments
p63187
aVSometimes you have to write a bit of glue code to convert a managed argument to the native version of it, particularly if your native method uses 8-bit char* or structure arguments
p63188
aVYou'll find that standard pattern in code in my answer here
p63189
aVI also should mention SWIG, a tool that can automate it
p63190
aVNot sure how good it is, never used it myself
p63191
as(dp63192
g9
V17034
p63193
stp63194
a((dp63195
g2
(lp63196
VThese are just warnings, not errors that prevent you from building
p63197
aVThe linker noticed you want to build a debug version of your app and it is a bit surprised that it is asked to include a
p63198
aVlib for which it cannot find any debug info (a
p63199
aVpdb)
p63200
aVIt won't stop you from running the code, you just won't get any relevant debug info when you step into the code of that library or when it crashes
p63201
aVIt's a bit sloppy that the vendor didn't at least provide you with a stripped
p63202
aVpdb, it takes little effort on their end
p63203
aVBut do note that you are not actually using the DLL version of the library, you are linking in a static
p63204
aVlib
p63205
aVThey might have provided the stripped
p63206
aVpdb with the DLL
p63207
aVCheck the distribution files for a
p63208
aVpdb along with the
p63209
aVdll
p63210
aVCheck the library release notes or docs for instructions on how to build your program with the DLL version
p63211
aVUsually it's just a matter of using the /MD option instead of /MT
p63212
aVAnd of course, if you paid a good deal of money for the license, don't hesitate to contact the vendor for support
p63213
as(dp63214
g9
V17034
p63215
stp63216
a((dp63217
g2
(lp63218
VFriend WriteOnly Property _Label1() As String
p63219
aVConfuzzling error message but the problem is induced by the name you picked
p63220
aVThere's a control on that form with the name Label1
p63221
aVThe Windows Forms designer created a declaration for it that you can use in your code with the Handles keyword, handy to create event handlers for the control
p63222
aVThe WithEvents keyword makes the compiler auto-generate some code for that variable
p63223
aVIncluding a hidden field, it looks like this with ildasm
p63224
aVexe:
p63225
aVNote the name that the compiler picked for that hidden field
p63226
aVYup _Label1, exactly the same name you picked for your property
p63227
aVKaboom
p63228
aVPick a name, any name, just not one that starts with an underscore
p63229
as(dp63230
g9
V17034
p63231
stp63232
a((dp63233
g2
(lp63234
VThis is a known problem in the linker for VS2008 SP1
p63235
aVFixed in VS2010, the feedback report is here
p63236
aVI've seen this myself a few times, it only happens when it actually links incrementally
p63237
aVFor me it always resolved itself by forcing a full build through Build + Rebuild so that the
p63238
aVilk file is deleted and re-created
p63239
aVIf that still doesn't work for you then you can turn the feature off with Project + Properties, Linker, General, Enable Incremental Linking
p63240
as(dp63241
g9
V17034
p63242
stp63243
a((dp63244
g2
(lp63245
VNo, nothing like that, standard nor vendor specific nor addon
p63246
aVYou'll have to upgrade to VS2010, it implements auto
p63247
as(dp63248
g9
V17034
p63249
stp63250
a((dp63251
g2
(lp63252
VI think this is a side-effect of a JIT compiler optimization
p63253
aVIf the m() method was virtual, it would have to generate the machine code to dig the method table pointer out of the object, then make the virtual call
p63254
aVBut this method isn't virtual and the JIT compiler already knows the method table pointer for the Derived class
p63255
aVSo it bypasses the pointer retrieval and supplies it directly
p63256
aVMaking the call work as you observed
p63257
aVYou can verify my guess by checking the generated machine code
p63258
aVYeah, the IL verifier isn't scoring any points here
p63259
aVYou could make it more interesting by having the Derived
p63260
aVm() method tinker with a field that's only declared in Derived
p63261
aVI've seen too much Reflection
p63262
aVEmit code crash with an AccessViolation to be greatly surprised by this
p63263
aVIt however may well be intentional, no need to verify IL that crashes anyway
p63264
aVNot sure, exploiting these kind of verification loopholes isn't (yet) common
p63265
aVThankfully
p63266
as(dp63267
g9
V17034
p63268
stp63269
a((dp63270
g2
(lp63271
VUsing Win7 64
p63272
aVThat's somewhat relevant, the declaration is wrong
p63273
aVWorks in 32-bit mode, but troublesome in 64-bit mode
p63274
aVThe last two arguments are pointers, not ints
p63275
aV8 bytes, not 4
p63276
aVFix:
p63277
aVHowever, this may not actually solve your problem
p63278
aVIn x64 mode, the first 4 arguments of a non-instance method are passed in registers, not the stack
p63279
aVIt just so happens that this method has 4 arguments, you won't get the PInvokeStackImbalance MDA warning
p63280
aVAnd the upper 32-bits of the 64-bit register values are often zero by accident so it doesn't matter whether the P/Invoke marshaller generates a 32-bit or a 64-bit argument value
p63281
aVBeware that this approach is quite troublesome in practice
p63282
aVYou cannot control the state of the keyboard in the target process
p63283
aVYou are sending the keystroke for B
p63284
aVThat may turn into B, b, Alt+B or Ctrl+B, depending on the state of the modifier keys
p63285
aVOnly SendInput() can work reliably
p63286
aVWell, short from the window focus problem
p63287
as(dp63288
g9
V17034
p63289
stp63290
a((dp63291
g2
(lp63292
VYeah, that's going to blow
p63293
aVThe timer's Elapsed method will run on a threadpool thread, regardless whether the previous one has finished
p63294
aVYour screen capture + bitmap save is bound to take longer than 40 milliseconds
p63295
aVSooner or later, probably sooner, two Elapsed handlers are going to run concurrently, using the same screenNumber variable value
p63296
aVKaboom on not being able to overwrite a locked file
p63297
aVYou'll need to use a System
p63298
aVThreading
p63299
aVTimer instead
p63300
aVStart it with a period of 0 so the callback only runs once
p63301
aVAfter the screenshot, restart the timer again
p63302
aVNow you can be sure that you'll never get more than one thread running at the same time
p63303
as(dp63304
g9
V17034
p63305
stp63306
a((dp63307
g2
(lp63308
VThe odds that this will overflow the x buffer and stomp some local variable values, like *lpwcx", are very high
p63309
aV70 chars is unreasonably frugal
p63310
aVIf you don't want to use strcat_s() then at least make it bigger
p63311
aVAnd yes, initialize lpwcx
p63312
aVcbSize
p63313
as(dp63314
g9
V17034
p63315
stp63316
a((dp63317
g2
(lp63318
VThe point of the challenge is to make you write the code to handle big numbers
p63319
aVUsing a library definitely isn't the point
p63320
aVYou know how to solve it with a (large) piece of paper and a pencil, right
p63321
aVNote how a large number you write on paper can also be a List(Of Digit)
p63322
aVAll you gotta do is figure out how to add them
p63323
aVAnd declare victory when the Count property turns into 1000
p63324
as(dp63325
g9
V17034
p63326
stp63327
a((dp63328
g2
(lp63329
VA base-36 encoding requires 6 bits to store each token
p63330
aVSame as base-64 but not using 28 of the available tokens
p63331
aVSolving 36^n >= 2^128 yields n >= log(2^128) / log(36) or 25 tokens to encode the value
p63332
aVA base-64 encoding also requires 6 bits, all possible token values are used
p63333
aVSolving 64^n >= 2^128 yields n >= log(2^128) / log(64) or 22 tokens to encode the value
p63334
aVCalculating the base-36 encoding requires dividing by powers of 36
p63335
aVNo easy shortcuts, you need a division algorithm that can work with 128-bit values
p63336
aVThe base-64 encoding is much easier to compute since it is a power of 2
p63337
aVJust take 6 bits at a time and shift by 6, in total 22 times to consume all 128 bits
p63338
aVWhy do you want to use base-36
p63339
aVBase-64 encoders are standard
p63340
aVIf you really have a constraint on the token space (you shouldn't, ASCII rulez) then at least use a base-32 encoding
p63341
aVOr any power of 2, base-16 is hex
p63342
as(dp63343
g9
V17034
p63344
stp63345
a((dp63346
g2
(lp63347
VThese kind of improvements just cannot have any measurable effect
p63348
aVThe real work is done in kernel mode, the many layers in the TCP/IP driver stack
p63349
aVLots of code there wants to take a sniff of the IRP packets
p63350
aVAnd ultimately it hits the NIC
p63351
aVThat's where the real throttling happens
p63352
aVA one gigabit Ethernet interface is the common high end
p63353
aVThat's peanuts compared to the rate at which a CPU can shovel data around
p63354
aVEven the slow RAM bus can easily move data 40 times faster
p63355
aVNot to speak of the latency involved with actually making a connection once it hits the network
p63356
aVThese paths are taken by ws2_32
p63357
aVdll as well as System
p63358
aVNet
p63359
aVYou ought to measure it
p63360
aVMy prediction is that you can't see a signal over the noise
p63361
as(dp63362
g9
V17034
p63363
stp63364
a((dp63365
g2
(lp63366
VIt is a linker error, not a compiler error
p63367
aVThe compiler is happy, it saw the declaration of function in the
p63368
aVh file
p63369
aVThe linker isn't, it cannot find the definition of the function
p63370
aVAdd the
p63371
aVc file to your project
p63372
as(dp63373
g9
V17034
p63374
stp63375
a((dp63376
g2
(lp63377
VThe error code is 0x80070005
p63378
aVThe 7 is the 'facility code', it is Windows
p63379
aVIn other words, you didn't get a message queuing error, you got a Windows error
p63380
aVError code 5 is "Access Denied"
p63381
aVSomething wrong with the user account, typically, not enough privileges
p63382
as(dp63383
g9
V17034
p63384
stp63385
a((dp63386
g2
(lp63387
VThe Windows version matters, but in general this behavior is baked into SysListView32, the native list view control
p63388
aVNo, keyboard handling is hard-baked
p63389
aVSubclassing the control is technically possible, just not practical since it lives inside Explorer
p63390
aVexe
p63391
aVAnd having no clue where the caret is located inside the label, there are no messages for it
p63392
as(dp63393
g9
V17034
p63394
stp63395
a((dp63396
g2
(lp63397
VYou can't reliably use SendMessage() to send keystrokes
p63398
aVYou can't control the process' keyboard state, the state of the Alt, Ctrl and Shift keys
p63399
aVSetKeyboardState() only works for your program, not the one you're trying to control
p63400
aVSendInput is required, which is what SendKeys uses
p63401
aVWhich in turn requires the program's main window to have the focus
p63402
aVPut another way, if there was a better method to fake keyboard input then SendKeys would already be using it
p63403
aVThere's a programmer somewhere trying to put his kids through college that can give you a real solution since he knows the program
p63404
aVAll you gotta do is find him
p63405
as(dp63406
g9
V17034
p63407
stp63408
a((dp63409
g2
(lp63410
VThe DLL has many classes
p63411
aVThis is a strange question but important details are missing
p63412
aVIf you want to use these classes from managed code then you have no choice but to write a C++/CLI wrapper for them
p63413
aVOnly the C++ compiler can properly construct them
p63414
aVP/Invoking the constructor isn't technically impossible, although it is quite painful to find its exported function name, you cannot guess how much memory to allocate for the object
p63415
aVOnly the C++ compiler knows
p63416
aVWriting wrappers isn't very difficult, it is largely mechanical
p63417
aVYou'll find more details about it with links in this answer
p63418
as(dp63419
g9
V17034
p63420
stp63421
a((dp63422
g2
(lp63423
VYou'll need to jump through several pinvoke hoops
p63424
aVStart with GetForegroundWindow() to get the handle of the active toplevel window
p63425
aVThen GetThreadWindowProcessId() to obtain the ID of the thread that owns that window
p63426
aVThen finally GetGUIThreadInfo(), it returns a bunch of into about the windows owned by the thread
p63427
aVThe GUITHREADINFO
p63428
aVhwndCaret member gives you the handle to the window that owns the caret
p63429
aVIt doesn't have to be a text box btw
p63430
aVVisit pinvoke
p63431
aVnet for the declarations you'll need
p63432
as(dp63433
g9
V17034
p63434
stp63435
a((dp63436
g2
(lp63437
VYou are looking at the array object header
p63438
aVAdd 8 to the address to find the array elements
p63439
as(dp63440
g9
V17034
p63441
stp63442
a((dp63443
g2
(lp63444
VAssigning the DocumentText property is a Big Deal, WebBrowser treats it like a navigation command
p63445
aVIt can't tell the difference
p63446
aVWhich normally takes time, hundreds of milliseconds, enough for it to justify displaying the wait cursor
p63447
aVA very different approach would be to load a dummy document and alter the DOM through the Document property
p63448
aVThat's pretty common in web pages, Ajax and javascript and what-not
p63449
aVNo wait cursor for those
p63450
aVNot so sure if that will still fit your editing model, I'd guess at you wanting to load a dummy HTML document with a empty  and change the body content
p63451
aVShould work
p63452
aVBack-up plan is an Update
p63453
aVbutton
p63454
aVWhich would also avoid trying to render half-finished and thus broken HTML
p63455
as(dp63456
g9
V17034
p63457
stp63458
a((dp63459
g2
(lp63460
VYou have to intercept the WM_MOVING notification message that Windows sends
p63461
aVHere's the code:
p63462
as(dp63463
g9
V17034
p63464
stp63465
a((dp63466
g2
(lp63467
VThey will both get the job done
p63468
aVThere's just more than one way to skin a pinvoke cat
p63469
aVSpecifically for this example:
p63470
aVis an optimization, it avoids having the pinvoke marshaller looking for the  and  versions
p63471
aVThey don't exist for this particular API function since it doesn't take a string argument
p63472
aVSeeing an actual difference in run time would be a miracle
p63473
aVis always a good idea since the default (Ansi) is so inefficient
p63474
aVIt just so happens to not make any difference here since the function doesn't take any string arguments
p63475
aVis unnecessary because that's the default
p63476
aVSame idea as  though, being explicit about it helps to create self-documenting code and to remember to deal with the unusual case
p63477
aVBeing able to only use  or  is a pretty big optimization
p63478
aVWhich was a missed opportunity here, the argument is
p63479
aVvs , same idea as above
p63480
aVUsing  is more correct since the API doesn't actually use any passed-in values inside the
p63481
aVIt doesn't however make any difference at runtime since the JIT compiler always initializes a struct anyway
p63482
aVis unnecessary, it is the default marshaling for a Windows
p63483
aVNot sure why pinvoke
p63484
aVnet always includes it
p63485
aVSo in a nutshell, neither is perfect but they both will work
p63486
aVSuch are the hazards of pinvoke
p63487
as(dp63488
g9
V17034
p63489
stp63490
a((dp63491
g2
(lp63492
VSet the AutoScroll property to true and the AutoScrollMinSize property to the size of the image
p63493
aVThe scrollbars will now automatically appear when the image is too large
p63494
aVYou'll want to inherit your own class from Panel so that you can set the DoubleBuffered property to true in the constructor
p63495
aVFlicker would be noticeable otherwise
p63496
aVSome sample code:
p63497
as(dp63498
g9
V17034
p63499
stp63500
a((dp63501
g2
(lp63502
VYes, this will bomb after the Graphics object is disposed
p63503
aVThere is little reason to use this constructor, it only sets the bitmap resolution
p63504
aVIf that's actually important to you then just use the Bitmap
p63505
aVSetResolution() method directly
p63506
as(dp63507
g9
V17034
p63508
stp63509
a((dp63510
g2
(lp63511
VThe Cursor class is rather poorly done
p63512
aVFor some mysterious reason it uses a legacy COM interface (IPicture), that interface doesn't support colored and animated cursors
p63513
aVIt is fixable with some fairly ugly elbow grease:
p63514
aVSample usage:
p63515
as(dp63516
g9
V17034
p63517
stp63518
a((dp63519
g2
(lp63520
VThere is no specific attribute
p63521
aVJust hints
p63522
aVIf you see an assembly reference to Microsoft
p63523
aVVisualBasic then the odds are high that it was written in VB
p63524
aVNET
p63525
aVIf you see a  class then it was written in C++/CLI
p63526
aVAbsence of these hints makes C# likely
p63527
aVIgnoring the possibilities of a Mono assembly or the dozens of language ports to
p63528
aVNET
p63529
as(dp63530
g9
V17034
p63531
stp63532
a((dp63533
g2
(lp63534
VNo, you're mixing it up
p63535
aVThe /MD vs /MT options is only relevant to which CRT version you link
p63536
aVThere are two, the static version (/MT) which you should use only if you don't use any DLLs in your project
p63537
aVAnd the DLL version, a version that every binary in your process can share so that you won't have heap allocation misery
p63538
aVThe kind of misery you get into when memory is allocated by one module and freed by another
p63539
aVChoosing your own libraries is entirely up to you
p63540
aVMixing and matching is fine, the linker just gets another kind of
p63541
aVlib
p63542
aVAn import library instead of a static library
p63543
aVJust keep in mind to use /MD when you use DLLs
p63544
as(dp63545
g9
V17034
p63546
stp63547
a((dp63548
g2
(lp63549
VYou are already using GetWindowThreadProcessId()
p63550
aVThat function returns a thread ID, you can use it with EnumThreadWindows() to get all the toplevel windows owned by the thread
p63551
aVIf necessary, EnumChildWindows() gets you the child windows owned by each toplevel window
p63552
aVThis approach does not give you windows that might be owned by any other thread in the process
p63553
aVThat's however quite rare and you typically don't want to know about them
p63554
aVIf that's a hangup then use Process
p63555
aVThreads to enumerate all the threads in the process, ProcessThread
p63556
aVId gets you the thread ID
p63557
as(dp63558
g9
V17034
p63559
stp63560
a((dp63561
g2
(lp63562
VCOM programming in C is very painful, but not impossible
p63563
aVThe buck stops here though
p63564
aVThe point of a type library is to have a tool auto-generate the COM interface and co-class declarations so that you can use them in your code
p63565
aVQuite similar to a
p63566
aVh file, but language independent
p63567
aVThe
p63568
aVNET equivalent is the metadata in an assembly
p63569
aVProblem is, the tooling isn't available to convert a
p63570
aVtlb to C declarations
p63571
aVI'm sure you are familiar with #import, that's what gets used in MSVC
p63572
aVBut it generates C++ code, smart pointers that help you create the COM object, call its interface methods and deal with errors
p63573
aVIf there is a tool available that generates C then it is a very well hidden secret
p63574
aVOne trick jumps to mind, you can use OleView
p63575
aVexe, File + View TypeLib to view the contents of the type library
p63576
aVThis view is decompiled into IDL, the interface definition language
p63577
aVYou can copy and paste this text into an
p63578
aVidl file and compile it with midl
p63579
aVexe with the /header command line option
p63580
aVThis generates a
p63581
aVh file that contains both C++ and the C declarations for the interfaces
p63582
aVOught to get you close, just make sure that the type library is reasonably stable so you don't have to do this very often
p63583
as(dp63584
g9
V17034
p63585
stp63586
a((dp63587
g2
(lp63588
VGoogle "disable crl checking" and take the first hit
p63589
aVThis isn't a real solution of course
p63590
aVA real one takes different measures, ones that you cannot take care of yourself
p63591
aVSomebody has to fix the Internet connection problem
p63592
aVIf your customer cannot take care of this, I'd recommend you suggest them to accept an unsigned version of your binaries
p63593
aVAsk more questions about this at superuser
p63594
aVcom
p63595
as(dp63596
g9
V17034
p63597
stp63598
a((dp63599
g2
(lp63600
VIt isn't exactly clear where you might want to move the text to, if it doesn't fit the layout then there are no real options
p63601
aVIn general, window layouts are contrained width-wise but have some room for growth vertically
p63602
aVEnforce this by setting the Label's MaximumSize property to, say, (100,0) so it cannot grow in the width and overlap some other control
p63603
aVThat will make it start wrapping text and use more vertical space
p63604
aVIf that's a problem as well then set AutoSize = False and AutoEllipsis = True
p63605
aVThe user can now tell that the text got truncated
p63606
aVAnd automatically gets a tooltip when she hovers the label
p63607
as(dp63608
g9
V17034
p63609
stp63610
a((dp63611
g2
(lp63612
VDon't sweat the small stuff here
p63613
aVThese are just declarations, there is no IL for them in the final assembly
p63614
aVThey just take up some space in the metadata
p63615
aVOdds are very high that they don't even get loaded from the assembly, especially when you keep the declarations together
p63616
aVMetadata is only ever loaded into RAM when it is used, 4096 bytes at a time
p63617
aVBtw, you explicitly don't want to use readonly for these constant declarations
p63618
aVNow you do get them to take space, even when they are not used
p63619
aVOne of the few cases where a public const is a good idea
p63620
aVThese are manifest constants, their value never changes
p63621
aVLike Math
p63622
aVPI
p63623
as(dp63624
g9
V17034
p63625
stp63626
a((dp63627
g2
(lp63628
VIt is the same for the file system as well as the registry, out of the box nothing is shared between users with a limited user account
p63629
aVThis is trivially solved by creating a directory or registry key that has write access by Everyone
p63630
aVBy an admin or a program that runs with admin rights
p63631
as(dp63632
g9
V17034
p63633
stp63634
a((dp63635
g2
(lp63636
VYeah, it does
p63637
aVAs soon as you drop a control on this phantom form, you'll get the design-time code (InitializeComponent) generated into that source code file
p63638
aVThis is compatibility behavior for
p63639
aVNET 1
p63640
aVx, it didn't support the Partial keyword
p63641
aVWhich will break the build, there are now two of them
p63642
aVIt is somewhat avoidable with careful clicking, but you know it's going to happen sooner or later
p63643
aVOther things go wrong too btw, the designer can no longer track an event handler when you move it from one file to another
p63644
aVAnd will readily let you add another, a much trickier source of bugs
p63645
aVThis just doesn't work very well, abandon hope of relying on it to solve your problem
p63646
aVThe generic diagnostic is that a convoluted user interface begets convoluted code
p63647
aVBut that ship has sailed, no doubt
p63648
aVA more structural solution is pursuing the MVC model, separating the data from the view of the data
p63649
aVYou'll still have a lot of event handlers but they won't do anything more than calling a method of a class that does the real work
p63650
aVWhose source code can of course live in another source code file
p63651
aVThe typical hangup is that Windows Forms has no support whatsoever built in for this, you have to craft it by hand
p63652
aVNothing similar to the MVVM model in WPF
p63653
aVSomething that can work well is isolating control + code into a separate UserControl
p63654
aVYou have to do so carefully though, you don't want to have to add a bunch of properties and events that expose internal controls
p63655
as(dp63656
g9
V17034
p63657
stp63658
a((dp63659
g2
(lp63660
VYes, this was a result of the 2001 settlement between Microsoft and Sun over the Microsoft Java Virtual Machine
p63661
aVSeveral products were axed because of this, including Windows 98, Windows Me, Office 2000, Office XP, IE 5
p63662
ag2447
aVBest place to find a license is at an auction site
p63663
aVIt was always available at Ebay for example, prices have been steadily climbing
p63664
as(dp63665
g9
V17034
p63666
stp63667
a((dp63668
g2
(lp63669
VFind an animated gif of such a spinner, like this one
p63670
aVPut it in a PictureBox, set its Visible property to True when you start the job
p63671
aVBeware that you'll have to run the query in a worker thread to keep the animation alive and the user interface responsive
p63672
aVThe BackgroundWorker class is good for that
p63673
as(dp63674
g9
V17034
p63675
stp63676
a((dp63677
g2
(lp63678
VThey are
p63679
aVSome sample code:
p63680
aVWith commands:
p63681
aVtlbexp ClassLibrary1
p63682
aVdll
p63683
aVoleview ClassLibrary2
p63684
aVtlb
p63685
aVProduces this interface dump:
p63686
aVIt's there
p63687
aVYou are doing something wrong, no idea what
p63688
as(dp63689
g9
V17034
p63690
stp63691
a((dp63692
g2
(lp63693
VAssembly
p63694
aVLoadFile() should only ever be used in very special circumstances
p63695
aVThe assembly doesn't have a loading context, that's why bar
p63696
aVdll cannot be found
p63697
aVThe only real use case is tooling, programs that dump assembly metadata
p63698
aVUse Load or LoadFrom()
p63699
aVTroubleshoot problems with fuslogvw
p63700
aVexe
p63701
as(dp63702
g9
V17034
p63703
stp63704
a((dp63705
g2
(lp63706
VThe arguments for an attribute constructor are stored in the assembly metadata
p63707
aVThat puts severe restrictions on what kind of argument types you can use
p63708
aVAnything that requires code is most definitely not supported
p63709
aVWhich is what fails here, accessing Properties
p63710
aVResources requires calling a property getter
p63711
aVNo great alternative here as long as you want to refer to a resource
p63712
aVThe resource name, a string, is all I can think of
p63713
aVObtain the resource object in the attribute constructor with Properties
p63714
aVResources
p63715
aVResourceManager
p63716
aVGetObject()
p63717
as(dp63718
g9
V17034
p63719
stp63720
a((dp63721
g2
(lp63722
VIt is swprintf() and swprintf_s()
p63723
aVNo leading underscore
p63724
as(dp63725
g9
V17034
p63726
stp63727
a((dp63728
g2
(lp63729
VYou didn't get a reference to the Documents object, GetProperty returns a PropertyInfo
p63730
aVFix:
p63731
aVAdding a reference to Microsoft
p63732
aVOffice
p63733
aVWord
p63734
aVInterop can make this a lot less painful
p63735
as(dp63736
g9
V17034
p63737
stp63738
a((dp63739
g2
(lp63740
VThe heap allocator already aligns returned addresses to the native platform word size
p63741
aV4 bytes for x86, 8 bytes for x64
p63742
aVYou are using long, 32-bit on either platform for MSVC
p63743
aVNo need to jump through the _aligned_malloc() hoop
p63744
as(dp63745
g9
V17034
p63746
stp63747
a((dp63748
g2
(lp63749
VThe installer copies it to the top install directory, c:\u005cprogram files\u005cdebugging tools for windows (x86) on my machine
p63750
aVSame directory where you'll find adplus
p63751
aVvbs and windbg
p63752
aVexe for example
p63753
aVMy version is a bit older, 6
p63754
aV10
p63755
as(dp63756
g9
V17034
p63757
stp63758
a((dp63759
g2
(lp63760
VYou need to build and register the proxy/stub DLL
p63761
aVRequired to marshal the interfaces across process boundaries
p63762
aVI can't find a great MSDN page for it, but it is mentioned here
p63763
as(dp63764
g9
V17034
p63765
stp63766
a((dp63767
g2
(lp63768
VThe P8 bucket has a strange value, at least when compared to my machine
p63769
aVCheck this post for a way to reverse-engineer the crashing method
p63770
aVThe crashing assembly is stored in the C:\u005cWindows\u005cMicrosoft
p63771
aVNET\u005cassembly\u005cGAC_MSIL\u005cMicrosoft
p63772
aVVisualStudio
p63773
aVShell
p63774
aV10
p63775
aV0\u005cv4
p63776
aV0_10
p63777
ag2512
ag2512
aV0__b03f5f7f11d50a3a directory on my machine
p63778
aVThe P7 bucket (note that yours doesn't match the linked one) points to ServiceProvider
p63779
aVGetService()
p63780
aVThe P8 bucket gives an IL offset of 0x4b but I see the method end at 0x41
p63781
aVHowever, I haven't yet figured out how accurate that can really be when the JIT compiled code gets optimized
p63782
aVIf this is anywhere accurate then you don't got much for a lead
p63783
aVA GetService() method is hopelessly generic
p63784
aVAlthough it certainly looks like it came up with a bad one that didn't survive a cast
p63785
aVIt is the kind of stuff that addins can mess up
p63786
aVBtw, this doesn't actually affect the build output, MSBuild
p63787
aVexe runs as a separate process
p63788
as(dp63789
g9
V17034
p63790
stp63791
a((dp63792
g2
(lp63793
VNo, that error message is unique
p63794
aVNot being able to create files in your own TEMP directory is not good news
p63795
aVAt least verify the security settings for that folder, you definitely want to run a thorough disk scan
p63796
aVA band aid is to move the TEMP directory elsewhere
p63797
aVControl Panel, System, Advanced, Environment variables and create the TEMP and TMP variables and set them to, say, c:\u005ctemp
p63798
aVAsk more questions about this at superuser
p63799
aVcom
p63800
as(dp63801
g9
V17034
p63802
stp63803
a((dp63804
g2
(lp63805
VYes, they embed the operating specific driver as a resource
p63806
aVHere's a screenshot from Visual Studio after using File + Open + File to open their Handle
p63807
aVexe utility:
p63808
aVNot exactly sure what they are but it certainly looks like they cover Windows 9x, 32-bit and 64-bit
p63809
aVNext thing they'd do is use the resource API functions (FindResource, SizeofResource, LockResource) and WriteFile() the resource content to a file in a writable directory
p63810
aVThen load the driver with CreateService and StartService
p63811
aVThe main program is x86 so it runs on any version of Windows
p63812
aVGenerating binaries at runtime isn't a very customer friendly thing to do btw, they (and their virus scanner) usually like to know what came from where
p63813
as(dp63814
g9
V17034
p63815
stp63816
a((dp63817
g2
(lp63818
VIt is certainly technically possible
p63819
aVIf SomeEvent is fired by a Timer for example
p63820
aVNot that you would not notice, the stack of dialog windows is quite visible
p63821
aVShowDialog() takes counter-measures to prevent this from happening
p63822
aVIt is exactly equivalent to DoEvents(), a method that has gotten a lot of bad rap
p63823
aVBut ShowDialog prevents the vast majority of re-entrancy nastiness by disabling all the windows that are owned by the thread
p63824
aVThe user thus cannot do anything troublesome like again clicking the button that started the dialog, producing two of them
p63825
aVOr closing the main window, leaving the code still running but without a user interface, the typical lossage for DoEvents()
p63826
aVWithout the user being able to intrude and alter the program flow, there isn't much chance that an event fires and you didn't count on it or hadn't seen the behavior while testing
p63827
aVDon't worry too much about it, you'll notice and you'll hear about it
p63828
aVAnd it is easy to fix with a flag
p63829
aVAlthough an exception would be a better idea
p63830
as(dp63831
g9
V17034
p63832
stp63833
a((dp63834
g2
(lp63835
VYou can save s with the  method
p63836
aVHere's a sample C++ program that uses it:
p63837
as(dp63838
g9
V17034
p63839
stp63840
a((dp63841
g2
(lp63842
VDateTime is capable of storing only two distinct times, the local time and UTC
p63843
aVThe Kind property indicates which
p63844
aVDateTimeOffset expands on this by being able to store local times from anywhere in the world
p63845
aVIt also stores the offset between that local time and UTC
p63846
aVNote how DateTime cannot do this unless you'd add an extra member to your class to store that UTC offset
p63847
aVOr only ever work with UTC
p63848
aVWhich in itself is a fine idea btw
p63849
as(dp63850
g9
V17034
p63851
stp63852
a((dp63853
g2
(lp63854
VThe exception you get is hopeless, that's E_FAIL, "Unspecified error"
p63855
aVThere isn't any obvious reason why this would fail, starting another instance of IE when your program starts back up shouldn't be a problem
p63856
aVWell, short from those ghost instances of IE that keep running forever
p63857
aVI would guess that you got this exception for the same reason that IE didn't quit when you called Quit() the last time
p63858
aVDo consider the kind of mishap you'll create when your program aborts and doesn't get around to cleanly shutting down IE
p63859
aVUsing Environment
p63860
aVExit() would be quite unhealthy for example
p63861
aVOr any other kind of nasty kaboom that doesn't let the finalizer thread run at termination
p63862
aVMaybe that has already happened many times before, now IE just refuses to create any more instances
p63863
aVHow many instances do you have to kill when you need to get it going again
p63864
aVThe much better mousetrap here is to run IE in-process in your own program rather than out-of-process with SHDocVw
p63865
aVSo that when your program terminates, it takes IE with it
p63866
aVIt is also much more efficient, there's a lot of overhead involved in making out-of-process COM server calls
p63867
aVYou do this by using WebBrowser in your program
p63868
as(dp63869
g9
V17034
p63870
stp63871
a((dp63872
g2
(lp63873
VIt's a bit fishy
p63874
aVHandleRef is not needed when handle values are stored in a SafeHandle derived object
p63875
aVWhich the code pack declares, ZeroInvalidHandle, with several derived ones from it like SafeWindowHandle
p63876
aVHowever, it doesn't actually use any of these SafeHandle classes anywhere
p63877
aVNot so sure if it really has to, a lot of the Vista and Win7 extensions are actually COM interfaces
p63878
aVNot the traditional handle based C API
p63879
aVThey are kept alive through reference counts and are thus not subject to this kind of garbage collector mishap
p63880
aVPersonally I just never worry about this
p63881
aVGetting a class object collected while the API call is executing is a bug
p63882
aVIt can happen just as easily a microsecond after the API call completed
p63883
aVStill a bug, just not one that makes the API call fail
p63884
aVNot so sure I'd actually want it to not fail, I'd much prefer an exception when I got a bug in my code
p63885
aVMicrosoft needs to protect itself from this, they don't want to get the blame for the exception
p63886
aVI do
p63887
as(dp63888
g9
V17034
p63889
stp63890
a((dp63891
g2
(lp63892
VThis is just not how security works
p63893
aVChanging the clock is a very intrusive operation, it has a very large number of side effects
p63894
aVThere is no mechanism in Windows, or any other operating system for that matter, where you could start a process with limited privileges and then just arbitrarily bypass these limitations and suddenly gain administrator rights
p63895
aVThere wouldn't be any point whatsoever to running programs with limited privileges if that was possible
p63896
aVIf you want to do something like this then you'll have to run your program with elevated rights
p63897
aVOn Vista and Win7 that requires you to run as a service or a scheduled task
p63898
aVWhich require an administrator to get installed
p63899
aVUAC provides a way gain admin rights for regular programs, you have to include a manifest in your program so the user is notified about your privilege elevation
p63900
aVGoogle 'requireadministrator', take the first hit
p63901
as(dp63902
g9
V17034
p63903
stp63904
a((dp63905
g2
(lp63906
VHehe, they just couldn't come up with a good example
p63907
aVAnd punted by showing a generic FooChanged event handler instead
p63908
aVYeah, useless
p63909
aVIt is quite unusual to implement a ParentChanged event handler yourself
p63910
aVIt's a big deal in the Winforms internals, properties like BackColor, ForeColor, Font are 'ambient' properties
p63911
aVIf they are not overridden from the default then they'll get the value of the Parent
p63912
aVWhich of course means that it is really important to notice that the parent changed
p63913
aVThe winforms code already takes care of it, you very rarely have to worry about it
p63914
aVUnless you create your own ambient property of course
p63915
as(dp63916
g9
V17034
p63917
stp63918
a((dp63919
g2
(lp63920
VI'll document the question better
p63921
aVThis code
p63922
aVgenerates:
p63923
aVwarning: CA1047 : Microsoft
p63924
aVDesign : Make member 'Test::blah::raise(Object^, EventArgs^)' private, public, or internal
p63925
aVYes, when you don't specify the event accessors yourself then the compiler will generate them for you
p63926
aVIt auto-generates the add, remove and raise accessors
p63927
aVThe latter one looks like this when you look with ildasm
p63928
aVexe:
p63929
aVThe family attribute is what causes the code analysis warning
p63930
aVThe auto-generated add and remove accessors are of course public
p63931
aVWriting them yourself is a questionable workaround, you really only want to do this if you have a real reason to implement custom accessors
p63932
aVThe boilerplate version would look like this:
p63933
aVWell, that certainly suppresses the warning
p63934
aVI recommend you use the [SuppressMessage] attribute if that doesn't spin your propeller
p63935
as(dp63936
g9
V17034
p63937
stp63938
a((dp63939
g2
(lp63940
VSound to me you forgot to register the COM server
p63941
aVBut that would kill the old app
p63942
aVA hard requirement in COM is that you change the Guids of the co-classes and interfaces when you make breaking changes to them
p63943
aVThat ensures that different versions can live side-by-side and not stomp on each other's registry entries
p63944
aVA reg-free COM manifest would be another way
p63945
aVAlthough it isn't normally a lot of fun to put the manifest together and troubleshoot problems
p63946
aVA really, really cheap trick is to put the COM server DLL in the same directory as the client EXE
p63947
aVAnd create an empty file with the
p63948
aVlocal filename extension
p63949
aVIf the main EXE is named mumble
p63950
aVexe then the file should be named mumble
p63951
aVexe
p63952
aVlocal
p63953
aVThat's enough for the COM resolver to always use the local DLL, not the path that's recorded in the registry
p63954
aVThis is documented here
p63955
as(dp63956
g9
V17034
p63957
stp63958
a((dp63959
g2
(lp63960
VPathCanonicalize() might be worth mentioning, in case the strings are already concatenated
p63961
as(dp63962
g9
V17034
p63963
stp63964
a((dp63965
g2
(lp63966
VThis is a side effect of controls being Windows windows
p63967
aVA window is responsible for drawing itself, the OnPaintBackground and OnPaint methods take care of that
p63968
aVThis rendering model doesn't support transparency well
p63969
aVThere is support for true transparency by using layered windows
p63970
aVThat's implemented by the video adapter, Windows uses it hardware overlay feature
p63971
aVBut that only works for toplevel windows, not child windows
p63972
aVNote the Form
p63973
aVOpacity and Form
p63974
aVTransparencyKey properties
p63975
aVThere's partial support for transparency through a trick
p63976
aVA control can fake it by asking the parent window to draw itself first inside the control window
p63977
aVThat produces the background pixels, it can then draw on top of that
p63978
aVSetting the BackColor property to Color
p63979
aVTransparent enables this trick for controls that support this
p63980
aVAll of the ButtonBase derived classes do
p63981
aVBut not controls that are wrappers for native Windows controls
p63982
aVAsking the parent window" is where the flaw in this trick becomes visible in your screen shot
p63983
aVYou are seeing the form pixels
p63984
aVStacking effects don't work, it never considers any intermediary window in the Z-order, only the parent
p63985
aVThis is fixable but very ugly, there's a KB article that show the code
p63986
aVAlso notable is that WPF doesn't have this restriction
p63987
aVControls are not windows, they render by painting themselves on top of the parent
p63988
aVLayers of paint
p63989
aVTransparency is now trivial, just don't paint
p63990
as(dp63991
g9
V17034
p63992
stp63993
a((dp63994
g2
(lp63995
VYou are using the wrong attributes
p63996
aVDesignWidth and DesignHeight only set the design time size
p63997
aVYou want Width and Height
p63998
as(dp63999
g9
V17034
p64000
stp64001
a((dp64002
g2
(lp64003
VYou got that pretty wrong
p64004
aVOnly COPYDATASTRUCT
p64005
aVlpData is a pointer
p64006
aVdwData indicates the message number
p64007
aVYou pick your own, use 0 if you have only one
p64008
aVcbData is the size of the pointed-to data
p64009
aVMore problems, you are leaking the memory
p64010
aVThe amount of memory you allocate doesn't match the size you pass
p64011
aVThe string conversion is lossy and might not produce as many bytes as string
p64012
aVLength()
p64013
aVFindWindow is notoriously unreliable
p64014
aVUse a socket or a named pipe for this so you don't have to guess a name, WCF is best
p64015
as(dp64016
g9
V17034
p64017
stp64018
a((dp64019
g2
(lp64020
VYou are trying to hook a C++ class instance method
p64021
aVIt has a hidden argument, this
p64022
aVThis argument is commonly passed through the ECX register with the __this calling convention
p64023
aVThat's what you see that Detours version doing
p64024
aVGetting this right is quite untrivial, the CPU register values must be preserved early, ECX in particular
p64025
aVThat requires a stub that uses machine code, no machine code in a managed stub of course
p64026
aVI doubt that EasyHook has any support for it, it certainly isn't promised in the feature list
p64027
as(dp64028
g9
V17034
p64029
stp64030
a((dp64031
g2
(lp64032
VThere are two ways to divide numbers
p64033
aVThe fast way and the slow way
p64034
aVA lot of compilers try to trick you into doing it the fast way
p64035
aVC# is one of them, try this:
p64036
aVOutput: 0
p64037
aVAre you happy with that outcome
p64038
aVIt is technically correct, documented behavior when the left side and the right side of the expression are integers
p64039
aVThat does a fast integer division
p64040
aVThe IDIV instruction on the processor, instead of the (infamous) FDIV instruction
p64041
aVAlso entirely consistent with the way all curly brace languages work
p64042
aVBut definitely a major source of "wtf happened" questions at SO
p64043
aVTo get the happy outcome you would have to do something like this:
p64044
aVOutput: 0
p64045
ag2447
aVThe left side is now a double, forcing a floating point division
p64046
aVWith the kind of result your calculator shows
p64047
aVOther ways to invoke FDIV is by making the right-side a floating point number or by explicitly casting one of the operands to (double)
p64048
aVVB
p64049
aVNET doesn't work that way, the / operator is always a floating point division, irrespective of the types
p64050
aVSometimes you really do want an integer division
p64051
aVThat's what  does
p64052
as(dp64053
g9
V17034
p64054
stp64055
a((dp64056
g2
(lp64057
VI used PropertyInfo
p64058
aVGetProperties() which from what I understand should only return public properties
p64059
aVThat might be your first hang-up, the PropertyInfo class doesn't have a GetProperties method
p64060
aVThe Type class does
p64061
aVYour question otherwise indicates that you are actually using Type
p64062
aVGetMethods()
p64063
aVYes, that returns the get_Blah and set_Blah property accessor methods for a property
p64064
aVUnder the hood, properties are actually implemented as methods
p64065
aVUse Type
p64066
aVGetProperties() to reflect properties
p64067
as(dp64068
g9
V17034
p64069
stp64070
a((dp64071
g2
(lp64072
VThese are the crucial bits in the WDK makefile:
p64073
aVIn other words, lib
p64074
aVexe {options} == link
p64075
aVexe /lib {options}
p64076
as(dp64077
g9
V17034
p64078
stp64079
a((dp64080
g2
(lp64081
VIn general, finding an authoritative reference for P/Invoke declarations is difficult if you don't know enough about C to get the declaration right
p64082
aVThere are a lot of bad declarations out on the Internet
p64083
aVThe typical traps are VB6 declarations, there are a lot of them out there, where arguments that are really int are declared as Long
p64084
aVLong is the 32-bit integral type in VB6, Integer is 16-bit for historical reasons
p64085
aVAnother wide-spread mistake is using int where IntPtr is required
p64086
aVThese declarations work fine in 32-bit mode but misbehave in 64-bit mode
p64087
aVEspecially troublesome are functions that take 4 or less arguments, the wrong argument type doesn't generate the PInvokeStackImbalance MDA warning because the first 4 function arguments are passed in CPU registers
p64088
aVThis bug tends to bite long after the author declared the job done, pretty hard to get back into it and diagnose the trouble
p64089
aVThe next hassle is the tedium of declaring and maintaining either P/Invoke declarations or C++/CLI wrappers
p64090
aVWhen the unmanaged API is big, you'll end up writing a heck of a lot of them
p64091
aVEach of them ready to give you a hard to diagnose runtime error when you get it subtly wrong
p64092
aVThe truly hard interop is with COM servers that have IUnknown based interfaces
p64093
aVSuch servers don't have a type library so there's no opportunity to use Tlbimp
p64094
aVexe to auto-generate the interop library
p64095
aVYou have to re-declare the interfaces in your C# code and make sure you get [Guid] and the method declarations right
p64096
aVThe lack of support for multiple inheritance requires jumping through extra hoops when the interface inherits from an intermediate IUnknown based interface
p64097
aVThe problem that this author incorrectly calls the 'inheritance tax'
p64098
aVThese kind of servers are way more common then meets the eye
p64099
aVJust about anything you'd want to do with the shell (explorer
p64100
aVexe) is IUnknown based for example
p64101
aVSo are the Vista and Win7 extensions, ably wrapped by the Windows API Code Pack btw
p64102
aVAnd yes, error handling
p64103
aVWay too much unmanaged code out there that return nothing but an unfriendly error code like E_FAIL or E_UNEXPECTED
p64104
aVAnd doesn't implement IErrorInfo so all you got is an unhelpful generic message to look at
p64105
aVOr APIs that return BOOL to indicate failure, inviting a programmer to simply ignore the return value
p64106
aVAnd AccessViolation or Fatal Engine Execution Error, unmanaged code blowing up in your face without leaving any breadcrumb to find out what went wrong
p64107
aVThis isn't particular to C# interop, such code is hard for anybody to use
p64108
aVOther than that, it usually is pretty simple to make it work
p64109
aVThe P/Invoke marshaller and the COM interop support in
p64110
aVNET are truly excellent and significantly better than what's available in other VMs
p64111
as(dp64112
g9
V17034
p64113
stp64114
a((dp64115
g2
(lp64116
VThere are 3 kinds of tooltips
p64117
aVYour screenshot shows a tracking tooltip
p64118
aVThen there's a multiline tooltip, send TTM_SETMAXTIPWIDTH and respond to TTN_GETDISPINFO
p64119
aVAnd there are balloon tooltips, specify the TTS_BALLOON window style flag
p64120
aVThe latter two fit your bill
p64121
aVThere are good code examples in the SDK article for them
p64122
as(dp64123
g9
V17034
p64124
stp64125
a((dp64126
g2
(lp64127
VUnfortunately you can't
p64128
aVThe layout is determined by the internal ButtonBaseAdapter
p64129
aVCommonLayout() method, you can't override it
p64130
aVTextImageRelation = Overlay aligns the Text according to the TextAlign setting
p64131
aVThe image is ignored
p64132
aVOnce you set TextImageRelation = ImageBeforeText then the Text is always aligned flush to the right of the image
p64133
aVThe gap size is fixed, 3 pixels
p64134
aVA very silly but otherwise effective way to move the text to the right is to prefix the Text with spaces
p64135
aVNot good enough to ensure it is centered though
p64136
aVYou'd normally wouldn't want this anyway, button captions ought to line up
p64137
aVNote that RightToLeft = Yes gives you more ways to tinker, just not what you are looking for
p64138
as(dp64139
g9
V17034
p64140
stp64141
a((dp64142
g2
(lp64143
VThe BSTR is reference counted, I seriously doubt that will work right if you use GetAddress()
p64144
aVSadly the source code isn't available to double-check that
p64145
aVI've always done it like this:
p64146
as(dp64147
g9
V17034
p64148
stp64149
a((dp64150
g2
(lp64151
VNote the error message that the designer shows:
p64152
aVMethod 'System
p64153
aVWindows
p64154
aVForms
p64155
aVForm
p64156
aVinstantiate' not found
p64157
aVIt is complaining about the Form class not having an instantiate method  Not your form derived class which does have the method
p64158
aVThat's inevitable, the type doesn't yet exist until it is deserialized, it can only reflect on base class members
p64159
aVBut yeah, don't do this, your code is going to get stomped as soon as the designer re-serializes the form and regenerates the InitializeComponent() method
p64160
aVEditing that method is guaranteed lossage
p64161
aVWhy you'd want to do is isn't clear
p64162
aVYou could create a base form with a custom constructor and inherit from that
p64163
as(dp64164
g9
V17034
p64165
stp64166
a((dp64167
g2
(lp64168
VAn IEnumerable always has to be iterated to produce a list
p64169
aVYes, you can avoid writing the code by using IEnumerable<>
p64170
aVToList() extension method
p64171
aVIt is still O(n)
p64172
as(dp64173
g9
V17034
p64174
stp64175
a((dp64176
g2
(lp64177
VHandle values are obfuscated pointers, you cannot rely on their value at all
p64178
aVAnd they get recycled
p64179
aVThe long distance shot is GetWindowThreadProcessId() to get the ID of the thread that owns the window
p64180
aVOpenThread() to get a handle to it
p64181
aVGetThreadTimes() to find out when that thread was created
p64182
aVCloseHandle() to clean up
p64183
aVThe result is however but a guesstimate, do avoid wanting to ask such a question
p64184
aVVisit pinvoke
p64185
aVnet for the declarations
p64186
as(dp64187
g9
V17034
p64188
stp64189
a((dp64190
g2
(lp64191
VEndianness is good
p64192
aVSo just cast:
p64193
as(dp64194
g9
V17034
p64195
stp64196
a((dp64197
g2
(lp64198
VVTRect->left,VTRect->top,VTRect->right - 100 ,VTRect->bottom-iVThumb
p64199
aVThe arguments you pass to CreateWindow() with these values are x, y, nWidth and nHeight
p64200
aVWidth and height, not right and bottom
p64201
aVFix:
p64202
aVVTRect->left, VTRect->top, VTRect->right - VTRect->left, VTRect->bottom - VTRect->top
p64203
as(dp64204
g9
V17034
p64205
stp64206
a((dp64207
g2
(lp64208
VThe error message you got isn't fixable with any of the settings you're browsing through
p64209
aVIt is a straight-forward runtime error, Windows just cannot find the DLL that the tool needs
p64210
aVFirst thing you need to do is find out where the installer put the vld
p64211
aVdll file
p64212
aVYou are clearly running a 64-bit operating system
p64213
aVFirst look in c:\u005cwindows\u005csystem32, move it to c:\u005cwindows\u005csyswow64 if you find it there so that 32-bit programs can find the DLL
p64214
aVAlso check if the installer messed with the system environment PATH variable (Control Panel + System, Advanced), you may have to restart Visual Studio to make the change effective
p64215
aVAdding the install directory to this variable would be another solution
p64216
aVThe last ditch make-it-work effort is to copy vld
p64217
aVdll into your build directory
p64218
as(dp64219
g9
V17034
p64220
stp64221
a((dp64222
g2
(lp64223
VA CheckedListBox can store any kind of class object
p64224
aVYou just need a ToString() override that shows the description of the object
p64225
aVFor example:
p64226
aVYou can add these to the Items collection
p64227
aVReading back the selected ones just takes casting the object back to Subject
p64228
aVFor example:
p64229
as(dp64230
g9
V17034
p64231
stp64232
a((dp64233
g2
(lp64234
VSet the button's AutoEllipsis property to True
p64235
aVThis also automatically enables a tooltip so that the user can see the entire button's Text value when she hovers the mouse over the button
p64236
as(dp64237
g9
V17034
p64238
stp64239
a((dp64240
g2
(lp64241
VIt makes very little sense to make the version number of the interop library different from the version number of the type library that was created by VB6
p64242
aVThere is a one-to-one mapping between what's in the interop library vs the code you wrote in VB6
p64243
aVThe interop library simply contains IL declarations for the VB6 COM interfaces, there is no actual code
p64244
aVThe CLR uses it to quickly generate the RCW for the interface
p64245
aVChange the type library version number in VB6 with Project + Properties, Make tab, Version number
p64246
aVMajor and minor is what counts
p64247
aVDo this only when you make a change in the publicly visible VB6 classes
p64248
aVDoing so is required btw, it avoids DLL Hell
p64249
as(dp64250
g9
V17034
p64251
stp64252
a((dp64253
g2
(lp64254
VIt isn't loading them, you are seeing the time needed just to paint the buttons
p64255
aVYou can easily double-check this: minimize the form and restore it
p64256
aVThis taking 2 seconds is rather on the high end, maybe it just feels that way or you've got very underpowered hardware
p64257
aVHaving 36 buttons does put you close to being able to observe the painting, especially when they have an Image
p64258
aVDo make sure the images you put on the button are sized right, having to rescale them to fit the button is expensive and eats into the painting time
p64259
aVA splash screen isn't going to solve this problem unless you run this on Vista or Win7 with Aero enabled
p64260
aVYou can hide it somewhat with the Opacity property, increasing from 0 to 0
p64261
aV99 with a timer
p64262
aVA true fix is to not use buttons but just draw the roulette table in the form's OnPaint() method override
p64263
aVYou'll however have to then add the code to do mouse hit testing
p64264
aVA Q&D; fix is to double-buffer the entire form, rendering into an off-screen bitmap then getting the result blitted to the screen
p64265
aVThat doesn't speed up the painting, it just isn't noticeable anymore
p64266
aVPaste this code into your form class to use the built-in support for this in Windows XP and up:
p64267
as(dp64268
g9
V17034
p64269
stp64270
a((dp64271
g2
(lp64272
VSimple trick: have the list* always point to the last element in the list
p64273
aVAnd set that last element's next pointer to the start of the list
p64274
aVNow you can always easily find both the start and the end of the list with just one pointer
p64275
aVThe start is at list->next
p64276
aVDon't call it tail, just "list"
p64277
as(dp64278
g9
V17034
p64279
stp64280
a((dp64281
g2
(lp64282
VYou cannot control the implementation of the property
p64283
aVPeriod
p64284
aVForcing them to make the setter private doesn't make sense, no consumer of the interface could ever call it
p64285
aVNo point in declaring a setter that nobody can call anyway, might as well omit it
p64286
aVNow it does work, there is no setter to call
p64287
aVThat's pretty private
p64288
as(dp64289
g9
V17034
p64290
stp64291
a((dp64292
g2
(lp64293
VPut it in the constructor, not InitializeComponent()
p64294
aVAdding using directives to your main class source code file isn't a problem
p64295
as(dp64296
g9
V17034
p64297
stp64298
a((dp64299
g2
(lp64300
VRight-click the toolbox, Choose Items
p64301
aVLocate StatusBar and tick it
p64302
aVThere might be more than one, use the one whose Directory column says "Global Assembly"
p64303
as(dp64304
g9
V17034
p64305
stp64306
a((dp64307
g2
(lp64308
VIt is very important that you read compiler error message from the top down
p64309
aVYou got 3 C2143 errors before you got the C2065 error
p64310
aVIt is typical that error messages get less accurate and informative, an earlier error may produce a slew of additional errors
p64311
aVThe first message complains about the element variable declaration
p64312
aVThen you get additional errors for any line that contains element since the compiler couldn't properly parse the declaration
p64313
aVYour compiler requires you to put all variable declarations before the code that uses them
p64314
aVAlso note that you've got two declarations for the i variable
p64315
aVAnd that line needs to be an array of char:   Moving the file reading code into a separate function would be a rather good idea
p64316
as(dp64317
g9
V17034
p64318
stp64319
a((dp64320
g2
(lp64321
VThe code looks okay
p64322
aVHowever, the BeginPrint event handler is missing
p64323
aVIt is required to set the _listItemCount variable back to zero
p64324
aVWithout it, only the first printout will work, any subsequent attempt to print will only produce an empty page since _listItemCount is already incremented beyond _studentsList
p64325
aVCount
p64326
as(dp64327
g9
V17034
p64328
stp64329
a((dp64330
g2
(lp64331
VThere's a hidden file in that folder named desktop
p64332
aVini
p64333
aVThis is the content on my machine:
p64334
aVThis is the relevant line:
p64335
aVdfrgui
p64336
aVlnk=@%systemroot%\u005csystem32\u005cdfrgui
p64337
aVexe,-103
p64338
aVThe -103 value indicates the string is read from string resource #103 in dfrgui
p64339
aVexe
p64340
aVIn Visual Studio, I used File + Open + File, selecting c:\u005cwindows\u005csystem32\u005cdfrgui
p64341
aVexe
p64342
aVOpened "String table" and double-clicked it:
p64343
aVThis may well be different on your machine, depending on where you live
p64344
aVWhat I showed is for the English version of Win7
p64345
as(dp64346
g9
V17034
p64347
stp64348
a((dp64349
g2
(lp64350
VThe first message you quoted is produced by the Windows heap manager when it discovers that the internal heap structure is destroyed
p64351
aVIt displays that diagnostic when it sees that a debugger is attached
p64352
aVThe 2nd quoted block is what happens when it bypasses the diagnostic (no debugger attached), it bombs on a hardware exception when it tries to release memory in the corrupted heap anyway
p64353
aVThe trouble with heap corruption is that the real damage is done a long time before the diagnostic is generated
p64354
aVYou can see a stack trace leading up to the diagnostic in the Call Stack window, you'll need to enable the Microsoft symbol server to get meaningful symbols for the Windows functions
p64355
aVBut it won't tell you anything useful about the code that really caused the damage, that requires a time machine
p64356
aVThis kind of heap corruption is invariably caused by unmanaged code
p64357
aVThe AccessViolation exception is a well known scourge to C/C++ programmers and a very large reason why managed code became popular
p64358
aVWhile Lutz' source code is all managed, it contains a lot of P/Invoke and COM interface declarations
p64359
aVThere is no good way to debug them, you don't have the source code
p64360
aVGetting one of those declarations subtly wrong when you converted them to VB
p64361
aVNET is certainly one way this could happen
p64362
aVIt could also well be that the bug was always there but reared its ugly head just now
p64363
aVLucky you
p64364
aVBtw, I don't think the code is 64-bit clean, force it to run in 32-mode for a possible quick fix
p64365
aVFor your main EXE project: Project + Properties, Compile tab, scroll down, Advanced Compile Options, Target CPU = x86
p64366
aVThis is only relevant if you run on a 64-bit version of Windows
p64367
aVOther than that, I'd recommend you just use the C# project as-is
p64368
aVMixing languages in a solution is a very well supported scenario in
p64369
aVNET
p64370
as(dp64371
g9
V17034
p64372
stp64373
a((dp64374
g2
(lp64375
VYes, this code is troublesome
p64376
aVIt goes wrong when the user closes the dialog
p64377
aVWindows must then find another window to give the focus to
p64378
aVThere isn't any left in your app, your main window is invisible
p64379
aVIt then picks a window of another app
p64380
aVOdds are good, for example, that this will be a window inside Visual Studio
p64381
aVA big one
p64382
aVYour main form now disappears behind it
p64383
aVYou need to make sure that your main window is visible again before the dialog closes
p64384
aVYou can do so by subscribing to the dialog's FormClosing event handler
p64385
aVFor example:
p64386
as(dp64387
g9
V17034
p64388
stp64389
a((dp64390
g2
(lp64391
VWPF doesn't directly support ActiveX controls
p64392
aVYou'll need Winforms to give it a hospitable runtime environment and leverage the auto-generated AxHost wrapper
p64393
aVThe WindowsFormHost control is available to embed winforms controls in a WPF window
p64394
aVThe walkthrough that shows the technique is available here
p64395
as(dp64396
g9
V17034
p64397
stp64398
a((dp64399
g2
(lp64400
VYou picked the wrong kind of control to get started with
p64401
aVMaking your own text editor from scratch is unreasonably hard
p64402
aVSeemingly simple things like displaying a caret requires pinvoking obscure api functions
p64403
aVCalculating where to show it inside of a string is very hard
p64404
aVPick an easier one to get started with
p64405
aVA calendar for example
p64406
aVEssential skills you'll learn is how to write your own OnPaint() method to give a control a visual appearance, how to do mouse hit testing and how to pick the right kind of events and properties to make the control useful in a program
p64407
as(dp64408
g9
V17034
p64409
stp64410
a((dp64411
g2
(lp64412
VUse the debugger
p64413
aVAfter you closed your main window, use Debug + Break All
p64414
aVDebug + Windows + Threads
p64415
aVLook at the call stack of the threads you see listed there to find the one that is preventing the program from terminating
p64416
as(dp64417
g9
V17034
p64418
stp64419
a((dp64420
g2
(lp64421
VThe screenshot shows you using the shell property sheet extension handler that displays the unmanaged version resource that's embedded in most EXE and DLL files, including
p64422
aVNET ones
p64423
aVUnfortunately, starting with Vista, that handler no longer displays optional fields in that resource
p64424
aVThe ProductVersion field is a standard one but is not the [AssemblyVersion]
p64425
aVYou'd have to add the corresponding attribute in AssemblyInfo
p64426
aVcs
p64427
aVFor example:
p64428
aV[assembly: AssemblyInformationalVersion("1
p64429
ag2584
ag2586
aV4")]
p64430
aVNot a great name match, unfortunately
p64431
aVWhen it is missing, the compiler will copy the value of the [AssemblyVersion], that's how you ended up with the asterisk
p64432
aVThe compiler does actually emit the extra field in the resource
p64433
aVYou can see it with File + Open + File, select your assembly, open the Version node and double-click resource #1:
p64434
aVWhich was generated from:
p64435
aVIt's there, you just can't see in Explorer
p64436
aVBummer, hopefully they'll fix that some day
p64437
aVAlso note the generated [AssemblyVersion], the Revision number is 18404
p64438
aVIt isn't random, I built this EXE at 10:13 am
p64439
aVThat was 18404 * 2 seconds since midnight
p64440
as(dp64441
g9
V17034
p64442
stp64443
a((dp64444
g2
(lp64445
VControl Panel + Mouse
p64446
aVIncrease the double-click time
p64447
aVThis is the base timer for a lot of 'how agile is the user' timers
p64448
aVIncluding the default tooltip autopop delay timer interval
p64449
aVI'll avoid making jokes about it :)
p64450
as(dp64451
g9
V17034
p64452
stp64453
a((dp64454
g2
(lp64455
VIt isn't possible
p64456
aVIf you try by overriding TextBox and calling SetStyle(ControlStyles
p64457
aVUserPaint, true) in the constructor so you can override OnPaintBackground and draw the image, you'll be in for several rude surprises
p64458
aVFalling back to legacy rendering mode is just one of them
p64459
aVTextBox dates from the very early days of Windows, back when it still had to run on 386SUX hardware
p64460
aVOne particular crime it commits to work reasonably on such limited hardware was to draw itself without using the WM_PAINT event
p64461
aVThis destroys the background image
p64462
aVThere's a project at CodeProject
p64463
aVcom that provides one
p64464
aVI cannot recommend it
p64465
as(dp64466
g9
V17034
p64467
stp64468
a((dp64469
g2
(lp64470
VIt is very unusual for a process to create more than one thread that owns a UI window
p64471
aVSometimes it is a interop window which is intentionally hidden, unlikely that you'd want to know about it
p64472
aVVerify your assumptions with Spy++, the owner thread ID is shown in the window properties, Process tab
p64473
aVIf it does have more than one thread creating windows that you want to know about then you'll want to set separate hooks
p64474
as(dp64475
g9
V17034
p64476
stp64477
a((dp64478
g2
(lp64479
s(dp64480
g9
V17034
p64481
stp64482
a((dp64483
g2
(lp64484
Vwith exit code 80131506
p64485
aVThat's a nasty one, ExecutionEngineException
p64486
aVStarting with
p64487
aVNET 4
p64488
aV0, this exception immediately terminates the program
p64489
aVThe generic cause is corruption of the state of the garbage collected heap
p64490
aVWhich in turn is invariably caused by unmanaged code
p64491
aVThe exact location in code at which this exception is raised isn't helpful, the corruption usually occurred well before the damage is detected
p64492
aVFinding the exact cause for this is going to be difficult
p64493
aVReview any unmanaged code your service might be using
p64494
aVSuspect environmental problems if there is no obvious candidate, misbehaving malware scanners are notorious
p64495
aVIf it repeats very poorly then suspect hardware problems like soft RAM errors
p64496
as(dp64497
g9
V17034
p64498
stp64499
a((dp64500
g2
(lp64501
VDisabling items isn't a great idea, the user will have no good feedback that click the check box won't have any effect
p64502
aVYou cannot use custom drawing to make it obvious
p64503
aVBest thing to do is to simply omit the item
p64504
aVYou can however easily defeat the user with the ItemCheck event:
p64505
as(dp64506
g9
V17034
p64507
stp64508
a((dp64509
g2
(lp64510
VYes, set the form's TransparencyKey property
p64511
aVMake the BackColor the same value
p64512
aVYou need to pick a color that won't appear anywhere else in the form
p64513
aVColor
p64514
aVFuchsia is a good choice, it's a fuchsed-up color
p64515
aVThis isn't a good idea for a splash screen
p64516
aVThe point of having one is that the user can see it
p64517
aVThe linked MSDN article is only appropriate for (some) child controls, not the form
p64518
as(dp64519
g9
V17034
p64520
stp64521
a((dp64522
g2
(lp64523
VGoing forward vs backward doesn't usually make much difference
p64524
aVThe file data is read into the file system cache after the first read, you get a memory-to-memory copy on ReadByte()
p64525
aVThat copy isn't sensitive to the file pointer value as long as the data is in the cache
p64526
aVThe caching algorithm does however work from the assumption that you'd normally read sequentially
p64527
aVIt tries to read ahead, as long as the file sectors are still on the same track
p64528
aVThey usually are, unless the disk is heavily fragmented
p64529
aVBut yes, it is inefficient
p64530
aVYou'll get hit with two pinvoke and API calls for each individual byte
p64531
aVThere's a fair amount of overhead in that, those same two calls could also read, say, 65 kilobytes with the same amount of overhead
p64532
aVAs usual, fix this only when you find it to be a perf bottleneck
p64533
as(dp64534
g9
V17034
p64535
stp64536
a((dp64537
g2
(lp64538
VThe
p64539
aVNET tab of that dialog only lists
p64540
aVNET framework assemblies
p64541
aVSometimes some additional ones when an installer messes with the registry entries, that's not common
p64542
aVYou'll have to use the Browse tab and navigate to the assembly in its install directory
p64543
as(dp64544
g9
V17034
p64545
stp64546
a((dp64547
g2
(lp64548
VThere is no difference between kernel and user mode threads
p64549
aVExcept that you can bump up the thread priority higher in kernel mode
p64550
aVTry bumping up the user mode thread priority first
p64551
aVAnd make sure the read is blocking so that the thread scheduler really likes you when the read completes
p64552
aVThis is otherwise no fix for running out of buffer space when you can't process the data fast enough
p64553
as(dp64554
g9
V17034
p64555
stp64556
a((dp64557
g2
(lp64558
VPretty trivial to do yourself by just calling Dequeue when the Count goes up beyond your limit after calling Add()
p64559
aVAn extension method jumps to mind
p64560
as(dp64561
g9
V17034
p64562
stp64563
a((dp64564
g2
(lp64565
VYou can use the ListViewItem
p64566
aVTag property to store a reference to any object, the equivalent of SetItemDataPtr()
p64567
aVThe Name property can be handy to act as a key in a Dictionary<>
p64568
aVAnd the Index property could be useful to index a List<>
p64569
aVThe latter two approaches are the better solutions, you normally want to keep the data separate from the view
p64570
as(dp64571
g9
V17034
p64572
stp64573
a((dp64574
g2
(lp64575
VSelect in in the combobox at the top of the Properties window
p64576
aVHit Ctrl+F6 or click the tab of the design window
p64577
aVPress the Delete key
p64578
aVEditing the Designer
p64579
aVvb file would be another way, but a bit riskier
p64580
aVClick the Show All Files icon in the Solution Explorer window to be able to see it, open the node next to the form
p64581
as(dp64582
g9
V17034
p64583
stp64584
a((dp64585
g2
(lp64586
VThere is no std exception that gives you a highly selective way to catch a 'file not found' error condition
p64587
aVSo, yes, if you want to signal that condition with an exception and you want to allow the client code to do something meaningful then you need to create your own class for that
p64588
aVThere is however also a reason why that exception doesn't already exist, even though it is by far the most common mishap
p64589
aVIt's kinda normal that a file isn't there when you expect it to be
p64590
aVYour program is not in control of the file system
p64591
aVOr maybe the user typed the file name wrong, something like that
p64592
aVIt isn't really exceptional that this goes wrong
p64593
aVDon't use exceptions for non-exceptional cases
p64594
aVThis is a mixed message
p64595
aVDo use it when the client code had a reasonable way to check for itself that the file should exist and continuing program execution without that resource is unlikely
p64596
as(dp64597
g9
V17034
p64598
stp64599
a((dp64600
g2
(lp64601
VYes, it is indeed a red herring
p64602
aVThat message is always displayed:
p64603
aVPay attention to the first few real compiler error messages, whatever they may be
p64604
as(dp64605
g9
V17034
p64606
stp64607
a((dp64608
g2
(lp64609
Vor one of its dependencies
p64610
aVDid you deploy the CRT runtime DLLs on that machine
p64611
aVMake sure to deploy the Release build of your assembly
p64612
aVThe debug version of the CRT is not redistributable
p64613
as(dp64614
g9
V17034
p64615
stp64616
a((dp64617
g2
(lp64618
VIt's called Spy++
p64619
as(dp64620
g9
V17034
p64621
stp64622
a((dp64623
g2
(lp64624
VThere are no possibilities, the CLR version that comes with
p64625
aVNET 3
p64626
aV5 cannot load 4
p64627
aV0 assemblies
p64628
aVThe metadata format was changed
p64629
aVYou have to force your app to use the
p64630
aVNET 4
p64631
aV0 CLR version
p64632
aVDo so by recompiling it with VS2010, targeting 4
p64633
aV0, or by using a
p64634
aVconfig file that contains the  element to ask for "v4
p64635
aV0"
p64636
aVCompatibility for
p64637
aVNET 4
p64638
aV0 is excellent btw
p64639
as(dp64640
g9
V17034
p64641
stp64642
a((dp64643
g2
(lp64644
VVersions earlier than VB10 requires declaring the event with the Custom keyword so you can apply the attribute to the private backing field
p64645
aVThat looks like this:
p64646
as(dp64647
g9
V17034
p64648
stp64649
a((dp64650
g2
(lp64651
VDebug + New Breakpoint + Break at Function
p64652
aVUse wmainCRTStartup if you compile with Unicode support enabled, drop the w if you don't
p64653
aVYou'll be stepping through the CRT initialization code from there
p64654
as(dp64655
g9
V17034
p64656
stp64657
a((dp64658
g2
(lp64659
VI see it
p64660
aVMake the column wider to see the effect it has
p64661
aVThe native Windows control is getting confuzzled by seeing the header control getting created even though it is in list mode
p64662
aVShort from making the column wider, the only real workaround is to remove the column before switching back to View = List
p64663
aVI recommend the latter approach, that header control might have some additional side-effects
p64664
as(dp64665
g9
V17034
p64666
stp64667
a((dp64668
g2
(lp64669
VOverride the ProcessCmdKey() method to detect the arrow keys
p64670
as(dp64671
g9
V17034
p64672
stp64673
a((dp64674
g2
(lp64675
VThat's an Acrobat Reader setting, not an Internet Options setting
p64676
aVEdit + Preferences, Internet
p64677
aVI'd guess that it is buried somewhere in the registry
p64678
as(dp64679
g9
V17034
p64680
stp64681
a((dp64682
g2
(lp64683
VLook at the InnerException, that tells you what went wrong
p64684
aVI'd guess at a security exception
p64685
as(dp64686
g9
V17034
p64687
stp64688
a((dp64689
g2
(lp64690
VThis changes the DPI for the DISPLAY device
p64691
aVUse GetDeviceCaps(), LOGPIXELSX/Y
p64692
aVUse CreateIC(L"DISPLAY", 0, 0, 0) to create the DC
p64693
aVThe percentage value corresponds to 96, 120 and 144 dots-per-inch
p64694
as(dp64695
g9
V17034
p64696
stp64697
a((dp64698
g2
(lp64699
VProcess
p64700
aVKill
p64701
aVNo
p64702
aVUnless you pinvoke TerminateProcess() yourself, uExitCode argument
p64703
aVHave a look at Reflector, this kind of stuff is easy to find with it
p64704
as(dp64705
g9
V17034
p64706
stp64707
a((dp64708
g2
(lp64709
VYou never assign the function return value
p64710
aVYou'll get its default value, False
p64711
aVInstead of assigning to the local variable (blnSaved), assign to SaveChanges instead
p64712
aVOr add Return blnSaved at the end of the function
p64713
as(dp64714
g9
V17034
p64715
stp64716
a((dp64717
g2
(lp64718
VMemory management in VB
p64719
aVNET is very different
p64720
aVVB6 uses reference counting to release COM objects, VB
p64721
aVNET uses the garbage collector
p64722
aVYou can get into a situation, especially when you are unit-testing the component, where the GC doesn't run frequently enough to release the COM objects
p64723
aVThose objects allocate unmanaged memory, that doesn't put pressure on the garbage collector to kick off a collection
p64724
aVStart diagnosing this with Perfmon
p64725
aVexe, Performance Monitor
p64726
aVRight-click the graph, Add Counters and select
p64727
aVNET CLR Memory, # Gen 0 collections and pick your process
p64728
aVVerify that you see the counter incrementing at a reasonable rate, at least one a second
p64729
aVFixing such a problem is fairly unpleasant, make sure that this is not an artificial problem that is induced by isolating the component
p64730
aVOr a plain bug in your code, keeping a reference to the COM object
p64731
aVCalling GC
p64732
aVCollect() followed by GC
p64733
aVWaitForPendingFinalizers() will release COM objects
p64734
aVSo does calling Marshal
p64735
aVReleaseComObject()
p64736
aVUsing GC
p64737
aVAddMemoryPressure() is a possible workaround as well, but you do have to have a reasonable idea how much unmanaged memory the COM object requires
p64738
as(dp64739
g9
V17034
p64740
stp64741
a((dp64742
g2
(lp64743
VNo, you won't lose it
p64744
aVBut move it, the customization isn't discoverable in a file that nobody ever looks at
p64745
as(dp64746
g9
V17034
p64747
stp64748
a((dp64749
g2
(lp64750
VThe QueryContinueDrag event is raised on the drag source
p64751
aVChecking for the state of the keys you are interested in is going to require pinvoke, the event is only designed to help recognize the Escape key and modifier key state changes
p64752
aVWhich is something to keep in mind, that these keys have any special action is very undiscoverable
p64753
aVIt returns a value < 0 when the key is down
p64754
aVI can't say it's guaranteed to work correctly but it looked good when I tried it
p64755
as(dp64756
g9
V17034
p64757
stp64758
a((dp64759
g2
(lp64760
VYou are doing byte x byte multiplies, obviously the intermediate result is going to need more than a byte
p64761
aVYou are also multiplying by AH instead of CH
p64762
as(dp64763
g9
V17034
p64764
stp64765
a((dp64766
g2
(lp64767
VUse the FirstDisplayedScrollingRowIndex property
p64768
as(dp64769
g9
V17034
p64770
stp64771
a((dp64772
g2
(lp64773
VYou'll need to edit the
p64774
aVcsproj file by hand to make it compatible with VS2005
p64775
aVOpen it in notepad
p64776
aVexe, open another VS2005
p64777
aVcsproj file so that you can compare
p64778
aVFocus on the  line near the bottom of the file, that's the one that is producing the error message
p64779
aVThere are no doubt others, I don't have VS2005 anymore to check
p64780
aVMixing and matching like this is of course best avoided, VS2010 has little trouble opening VS2005 projects after it converts them
p64781
as(dp64782
g9
V17034
p64783
stp64784
a((dp64785
g2
(lp64786
VDon't use , the
p64787
aVNET 4
p64788
aV0 CLR has dropped some appcompat code that makes a loaded assembly resemble a regular DLL
p64789
aVBesides, the HMODULE is trouble, you cannot use the VirtualQuery trick to convert a code address to a HMODULE
p64790
aVgives you the full path to the assembly from which the IL for the current method was loaded
p64791
as(dp64792
g9
V17034
p64793
stp64794
a((dp64795
g2
(lp64796
VYou are mixing things up here
p64797
aVA strong name is not the same thing as the certificate that's added to a binary with signtool
p64798
aVexe
p64799
aVThere is also no requirement that dependent assemblies have a certificate or that it needs to match
p64800
aVNor does it make sense to sign a debug build, only your customer is interested in it
p64801
aVYou already know that you can trust yourself
p64802
aVRunning sn
p64803
aVexe to give an assembly a strong name is already supported by msbuild
p64804
as(dp64805
g9
V17034
p64806
stp64807
a((dp64808
g2
(lp64809
VVCF is encoded in utf-8 as demanded by the spec in chapter 3
p64810
ag2588
aVYou need to take this seriously, the format would be utterly useless if that wasn't cast in stone
p64811
aVIf you are seeing some Android app mangling accented characters then work from the assumption that this is a bug in that app
p64812
aVOr more likely, that it got bad info from somewhere else
p64813
aVYour attempt to correct the encoding would then cause more problems because your version of the card will never match the original
p64814
aVYou convert from 1252 to utf-8 with Encoding
p64815
aVGetEncoding(1252)
p64816
aVGetString(), passing in a byte[]
p64817
aVDo not ever try to write code that reads a string and whacks it into a byte[] so you can use the conversion method, that just makes the encoding problems a lot worse
p64818
aVIn other words, you'd need to read the file with FileStream, not StreamReader
p64819
aVBut again, avoid fixing other people's problems
p64820
as(dp64821
g9
V17034
p64822
stp64823
a((dp64824
g2
(lp64825
VPinvoke SendMessage() to send the WM_CLOSE message to the app's main window
p64826
aVAsking it to open its main window is probably going to be quite difficult, you cannot obtain the window handle until the window is created
p64827
aVProcess
p64828
aVStart() would be the normal way
p64829
aVA low cost alternative to WCF and superior to pinvoke is a named pipe or a socket to interface with the app
p64830
aVThis requires being able to modify the source code of the app
p64831
as(dp64832
g9
V17034
p64833
stp64834
a((dp64835
g2
(lp64836
VThe term "visualize" is hopelessly vague
p64837
aVBut your bullet list is well taken care of by Reflector
p64838
aVIt's free from RedGate
p64839
as(dp64840
g9
V17034
p64841
stp64842
a((dp64843
g2
(lp64844
VPutting COM servers on a network share is asking for trouble
p64845
aVIt will randomly fail when the mapped drive letter is no longer mapped or mapped elsewhere
p64846
aVYou'll at least want the UNC path to the server (like ), not so sure you'll get this out of Regasm
p64847
aVexe with the /codebase option
p64848
aVVerify the registry key value, HKLM\u005cSoftware\u005cClasses\u005cCLSID{guid}
p64849
aVDo make sure you used /codebase, this cannot work without it
p64850
aVTrust could be an issue, use fuslogvw
p64851
aVexe to see what's happening
p64852
aVYou'll need caspol
p64853
aVexe to assign trust
p64854
aVThen there's dependent DLLs, neither Windows nor the CLR will be able to find them
p64855
aVTo see what is really going on use SysInternals' ProcMon utility
p64856
aVYou'll see COM looking through registry keys and searching for DLLs, watch for failed calls
p64857
as(dp64858
g9
V17034
p64859
stp64860
a((dp64861
g2
(lp64862
VYou cannot fix this in the graphics code
p64863
aVIf your data is noisy then the graph is going to be noisy as well, no matter what kind of line smoothing algorithm you use
p64864
aVYou'll need to filter the data first
p64865
aVCreate a second data set with points that are interpolated from the original data
p64866
aVA Least Squares fit is a common technique
p64867
aVAveraging is simple to implement but tends to hide extremes
p64868
as(dp64869
g9
V17034
p64870
stp64871
a((dp64872
g2
(lp64873
VThis sounds bad
p64874
aVDo not store references to a Graphics object, it only ever lives temporarily and is only valid while a Paint or PrintPage event handler is running
p64875
aVDo make sure to pass it as an argument to whatever method does the drawing instead of storing it in a field or a global variable
p64876
aVIf the method is altering the state of the object then use the Save() and Restore() methods to prevent this from causing problems in subsequent methods that use that same object
p64877
aVCloning it is never necessary with this approach
p64878
as(dp64879
g9
V17034
p64880
stp64881
a((dp64882
g2
(lp64883
VYou would have to pinvoke LogonUser to obtain a token
p64884
aVI seriously doubt that's going to work, these service accounts are highly privileged
p64885
aVDo ask yourself if this is worth the hassle
p64886
aVMaybe a warning is desirable but there is nothing that you could do yourself to fix the problem
p64887
aVIt is going to require an administrator to really fix the issue
p64888
aVFocus on getting a good diagnostic out of the exception you get
p64889
as(dp64890
g9
V17034
p64891
stp64892
a((dp64893
g2
(lp64894
VYes, that happens when you run a 32-bit installer on a 64-bit operating system
p64895
aVRegistry redirection will redirect the writes from HKLM\u005cSoftware to HKLM\u005cSoftware\u005cWow6432Node
p64896
aVYou'll need a 64-bit installer
p64897
aVThe TargetPlatform property, in case you are using a VS Setup project
p64898
as(dp64899
g9
V17034
p64900
stp64901
a((dp64902
g2
(lp64903
VNo, the designer doesn't 'fix' the TabIndex you set
p64904
aVThere's an interactive tool to set them
p64905
aVUse View + Tab Order and click the controls in the order you want to tab them
p64906
as(dp64907
g9
V17034
p64908
stp64909
a((dp64910
g2
(lp64911
VTop-level windows that you find with EnumWindows and have taskbar buttons will have the WS_VISIBLE and WS_EX_APPWINDOW style flags turned on
p64912
as(dp64913
g9
V17034
p64914
stp64915
a((dp64916
g2
(lp64917
VIt is possible, the TopLevel property controls this
p64918
aVHowever, the designer doesn't support them well, hard to keep control over controls that are also top-level windows at design time
p64919
aVBeyond components like ToolTip and ContextMenuStrip, there is exactly one class that is top-level by design, the Form class
p64920
aVSet its FormBorderStyle to None and ControlBox to False to create a basic top-level window that you can use and populate with other controls
p64921
as(dp64922
g9
V17034
p64923
stp64924
a((dp64925
g2
(lp64926
VYour code doesn't repro the problem
p64927
aVBut you will get a repro if you change the property like this:
p64928
aVBeware that every concrete class generated from a generic type will have its own static fields, they are not shared
p64929
as(dp64930
g9
V17034
p64931
stp64932
a((dp64933
g2
(lp64934
VIt is a standard Windows TreeView control with the Win7 "Explorer" visual style applied
p64935
aVYou can get one in your own program easily by changing the theme for the control
p64936
aVAdd a new class to your project and paste the code shown below
p64937
aVCompile
p64938
aVDrop the new control from the top of the toolbox onto your form
p64939
aVThis isn't directly possible for WPF unless you use the WindowsFormHost class
p64940
as(dp64941
g9
V17034
p64942
stp64943
a((dp64944
g2
(lp64945
VYes, Windows automatically maps folder and file access to  for 32-bit programs to
p64946
aVVisual Studio as well as MSBuild are 32-bit programs
p64947
aVSame is true for c:\u005cwindows\u005csystem32 vs c:\u005cwindows\u005csyswow64
p64948
as(dp64949
g9
V17034
p64950
stp64951
a((dp64952
g2
(lp64953
VA simpler repro of this behavior:
p64954
aVThe problem is that the mouse clicks that are recorded while the UI thread is busy go into the message queue and are stuck there until the event handler completes
p64955
aVWhen that happens, the button is already enabled again, allowed the Click event to run again
p64956
aVFixing this is fugly and includes paying the price of running the code on a worker thread
p64957
aVA possible good fix is to purge the message queue and remove all the mouse messages before re-enabling the button but that's not easy in Winforms
p64958
aVThe code is actually there but it is internal
p64959
aVA really pragmatic fix is one that might get me in trouble but is safe and effective :
p64960
as(dp64961
g9
V17034
p64962
stp64963
a((dp64964
g2
(lp64965
VPretty painful to watch this code, written some of it
p64966
aVThe verbosity of it is, well, best stuck in somebody else's class library
p64967
aVA couple of Red Flags
p64968
aVYou assume that the WaitCommEvent() completion means that you can call ReadFile()
p64969
aVNot typically, the event mask you used isn't visible, but there are lots of other reasons that the serial port wants to tell you something
p64970
aVAnother problem is that WaitCommEvent might complete right away
p64971
aVIt not uncommonly does, something available in the receive buffer
p64972
aVSteal this code from somewhere, it's hard code
p64973
aVIt's been done
p64974
as(dp64975
g9
V17034
p64976
stp64977
a((dp64978
g2
(lp64979
VThe standard
p64980
aVNET ToolStripSplitButton control works like this
p64981
aVYou have to put it on a ToolStrip
p64982
aVYou could undock the strip and set its GripStyle to Hidden to make it resemble a regular button
p64983
as(dp64984
g9
V17034
p64985
stp64986
a((dp64987
g2
(lp64988
Vin which case I would have to recompile to change the file name
p64989
aVYes you do, the LoadLibrary() argument must be changed when you rename the DLL
p64990
aVFix your real problem, it doesn't sound like you check the return value of LoadLibrary() at all
p64991
aVThrow a Win32Exception when it returns NULL
p64992
as(dp64993
g9
V17034
p64994
stp64995
a((dp64996
g2
(lp64997
VUse GetManifestResourceNames()
p64998
aVOnly run the test on the names you discover this way
p64999
as(dp65000
g9
V17034
p65001
stp65002
a((dp65003
g2
(lp65004
VPreventing the form from getting visible but still creating its Handle so that the notify icon works requires overriding SetVisibleCore()
p65005
aVLike this:
p65006
aVBeware that the Load event or OnLoad() method won't run until the form actually gets visible later
p65007
aVSo move any code you got there into this override
p65008
as(dp65009
g9
V17034
p65010
stp65011
a((dp65012
g2
(lp65013
VYou can make this a lot easier by lying about the [DllImport] declaration
p65014
aVJust declare the lpInBuffer argument as the structure type, the pinvoke marshaller will convert it to a pointer anyway
p65015
aVThus:
p65016
aVUsing IntPtr for lpOutBuffer because the driver probably doesn't return anything
p65017
aVPass IntPtr
p65018
aVZero
p65019
aVSame idea with the structure
p65020
aVIf the field isn't used then simply declare it as an IntPtr:
p65021
aVBe careful about the Packing property, it makes a difference here because of the byte sized field
p65022
aVYou may need 1 but that's just a guess without knowing anything about the driver
p65023
aVIf you have working C code then test the value of sizeof(pio_desc) and compare with Marshal
p65024
aVSizeOf()
p65025
aVPass Marshal
p65026
aVSizeOf(typeof(pio_desc)) as the nInBufferSize argument
p65027
aVIf you would have posted the C declarations then this would have been easier to answer accurately
p65028
as(dp65029
g9
V17034
p65030
stp65031
a((dp65032
g2
(lp65033
VFiltering key messages isn't very productive
p65034
aVYou would also have to filter Shift+Ctrl+Tab, Ctrl+PageDn and Ctrl+PageUp
p65035
aVJust prevent tab changes by implementing the Selecting event
p65036
aVLike this:
p65037
aVSet allowTabChanges to true and back to false in any of your own code that wants to change the active tab page
p65038
aVThe key filtering method is described in this answer
p65039
as(dp65040
g9
V17034
p65041
stp65042
a((dp65043
g2
(lp65044
VI think you need CallNtPowerInformation, passing SystemPowerInformation
p65045
aVThe returned SYSTEM_POWER_INFORMATION
p65046
aVTimeRemaining ought to be relevant
p65047
as(dp65048
g9
V17034
p65049
stp65050
a((dp65051
g2
(lp65052
VI'll do the fish
p65053
aVThe FileShare mode is critical, you must allow for write sharing
p65054
aVThat cannot be denied since the process that is writing the file already obtained write access
p65055
aVThe StreamReader() constructor uses FileShare
p65056
aVRead and doesn't have an option to use a different value
p65057
aVUsing the StreamReader(Stream) constructor is instead is indeed the workaround
p65058
aVBeware however that this sharing mode also has implications for your code
p65059
aVYou cannot predict when the other process flushes the file
p65060
aVThe last line you read may contain only part of a line of text
p65061
aVWhen it flushes is file buffer again, later, you'll get the rest of the line
p65062
aVClearly this can mess up your logic
p65063
as(dp65064
g9
V17034
p65065
stp65066
a((dp65067
g2
(lp65068
VDouble is a value type
p65069
aVYou should only use the ^ for reference types
p65070
aVI'm guessing it bombs when it tries to convert a boxed Double (an Object) to a native double
p65071
aVDelete the ^
p65072
as(dp65073
g9
V17034
p65074
stp65075
a((dp65076
g2
(lp65077
VI have no idea what "to come to the other controls" might mean
p65078
aVBut the event handlers in your Form derived class is the switchboard
p65079
aVImplement the button's Click event and have it do whatever you want done with any other controls
p65080
aVA trivial example:
p65081
as(dp65082
g9
V17034
p65083
stp65084
a((dp65085
g2
(lp65086
VThis is dealt with inside Windows with a feature called 'Registry redirection'  On the 64-bit version of Windows, a 32-bit program gets a different view of the registry
p65087
aVAny access to the HKCR alias or the HKLM\u005cSoftware root is redirected for the kind of keys that a COM server uses
p65088
aVA 32-bit program actually sees the key values stored in HKLM\u005cSoftware\u005cWow6432Node
p65089
aVYou can see it with Regedit
p65090
aVexe
p65091
aVThis is normally taken care of by an installer, a VS Setup project has the TargetPlatform property for example
p65092
aVIf you want to make the COM server available in both 32-bit and 64-bit mode then you should use two installers
p65093
aVOr a 64-bit installer that writes both sets of keys
p65094
aVHaving a COM server that can handle both is very unusual in the olden days
p65095
aVBut not unheard of when you implemented in
p65096
aVNET for example
p65097
as(dp65098
g9
V17034
p65099
stp65100
a((dp65101
g2
(lp65102
VIt's possible
p65103
aVAdd a new class to your project and paste the code shown below
p65104
aVCompile
p65105
aVDrop the new control from the top of the toolbox onto your form
p65106
aVIt has tabs at design time so you can easily switch between pages
p65107
aVBut hides them at runtime, use the SelectedIndex or SelectedTab property in your code to switch views
p65108
as(dp65109
g9
V17034
p65110
stp65111
a((dp65112
g2
(lp65113
VYou are testing the effects of memory alignment on code efficiency
p65114
aVThe 32-bit JIT compiler has trouble generating efficient code for value types that are more than 32 bits in size, long and double in C# code
p65115
aVThe root of the problem is the 32-bit GC heap allocator, it only promises alignment of allocated memory on addresses that are a multiple of 4
p65116
aVThat's an issue here, you are incrementing doubles
p65117
aVA double is efficient only when it is aligned on an address that's a multiple of 8
p65118
aVSame issue with the stack, in case of local variables, it is also aligned only to 4 on a 32-bit machine
p65119
aVThe L1 CPU cache is internally organized in blocks called a "cache line"
p65120
aVThere is a penalty when the program reads a mis-aligned double
p65121
aVEspecially one that straddles the end of a cache line,  bytes from two cache lines have to be read and glued together
p65122
aVMis-alignment isn't uncommon in the 32-bit jitter, it is merely 50-50 odds that the 'x' field happens to be allocated on an address that's a multiple of 8
p65123
aVIf it isn't then 'x' and 'y' are going to be misaligned and one of them may well straddle the cache line
p65124
aVThe way you wrote the test, that's going to either make VirtualMethod or SealedMethod slower
p65125
aVMake sure you let them use the same field to get comparable results
p65126
aVThe same is true for code
p65127
aVSwap the code for the virtual and sealed test to arbitrarily change the outcome
p65128
aVI had no trouble making the sealed test quite a bit faster that way
p65129
aVGiven the modest difference in speed, you are probably looking at a code alignment issue
p65130
aVThe x64 jitter makes an effort to insert NOPs to get a branch target aligned, the x86 jitter doesn't
p65131
aVYou should also run the timing test several times in a loop, at least 20
p65132
aVYou are likely to then also observe the effect of the garbage collector moving the class object
p65133
aVThe double may have a different alignment afterward, dramatically changing the timing
p65134
aVAccessing a 64-bit value type value like long or double has 3 distinct timings, aligned on 8, aligned on 4 within a cache line, and aligned on 4 across two cache lines
p65135
aVIn fast to slow order
p65136
aVThe penalty is steep, reading a double that straddles a cache line is roughly three times slower than reading an aligned one
p65137
aVAlso the core reason why a double[] (array of doubles) is allocated in the Large Object Heap even when it has only 1000 elements, well south of the normal threshold of 80KB, the LOH has an alignment guarantee of 8
p65138
aVThese alignment problems entirely disappear in code generated by the x64 jitter, both the stack and the GC heap have an alignment of 8
p65139
as(dp65140
g9
V17034
p65141
stp65142
a((dp65143
g2
(lp65144
VC# requires operators to be static
p65145
aVWrite it like this to make it work:
p65146
as(dp65147
g9
V17034
p65148
stp65149
a((dp65150
g2
(lp65151
VA bit tricky to get right
p65152
aVThis looked good:
p65153
as(dp65154
g9
V17034
p65155
stp65156
a((dp65157
g2
(lp65158
VIt's not that common to actually need a PIA
p65159
aVYou have to have one if you expose any interop types from the Excel type library in one of your public classes
p65160
aVThis goes wrong when other code uses your class and doesn't use the same interop library
p65161
aVA type in
p65162
aVNET is only identical when they came from the same assembly
p65163
aVYou'd get a difficult to interpret error message like "Cannot cast Application to Application"
p65164
aVThe PIA ensures that everybody is using the same type
p65165
aVAs long as everybody is using the same PIA version, which in itself is a difficult problem
p65166
aVDeploying your own interop DLL along with your app is fine if you can avoid this
p65167
aVWhich is not difficult in most scenarios
p65168
aVThis problem was solved in
p65169
aVNET 4
p65170
aV0 through a feature called 'type equivalence'
p65171
aVIt is specific to COM interface types, the CLR considers them compatible when they have the same [Guid] and the same declaration, regardless what assembly contains them
p65172
aVThis was then taken advantage of with the 'embed interop types' feature (same as 'no pia'), the compiler embeds the interop types in the metadata of your assembly
p65173
aVOnly the ones you actually use
p65174
aVSo you don't have to ship the interop library anymore and don't need the PIA
p65175
aVAnd it is a lot smaller since you only pay for the types you actually use
p65176
aVThat's a lot of bang for the buck, strongly recommended
p65177
as(dp65178
g9
V17034
p65179
stp65180
a((dp65181
g2
(lp65182
VI seriously doubt it
p65183
aVIf it would be used then you'll have no chance at guessing at the custom provider data without docs from the driver author
p65184
aVPay attention to the handshake signals, serial port devices routinely ignore anything sent to them when the DTR signal is turned off
p65185
aVAnd not send anything back with DTR off
p65186
aVA driver would emulate that
p65187
aVUse EscapeCommFunction() to turn them on
p65188
aVAlso try a serial comm program like HyperTerminal or Putty to test this so you can isolate the source of the problem
p65189
as(dp65190
g9
V17034
p65191
stp65192
a((dp65193
g2
(lp65194
VYou can track the window state changes through the Resize event
p65195
aVLike this:
p65196
as(dp65197
g9
V17034
p65198
stp65199
a((dp65200
g2
(lp65201
VYour Main() method sets the hooks, then immediately exits and terminates the program
p65202
aVFurthermore, you need a message loop to make the hook callback work
p65203
aVThat requires a Windows Forms or WPF app
p65204
aVUsing a real hot key instead of a hook now also becomes an option
p65205
aVCheck this thread for an example, C# is further down the page
p65206
as(dp65207
g9
V17034
p65208
stp65209
a((dp65210
g2
(lp65211
Vor one of its dependencies
p65212
aVThat's the usual problem, you cannot see a missing unmanaged DLL with Fuslogvw
p65213
aVexe
p65214
aVBest thing to do is to run SysInternals' ProcMon utility
p65215
aVYou'll see it searching for the DLL and not find it
p65216
aVProfile mode in Dependency Walker can show it too
p65217
as(dp65218
g9
V17034
p65219
stp65220
a((dp65221
g2
(lp65222
VYou should have used the EndDrag event, not MouseUp
p65223
as(dp65224
g9
V17034
p65225
stp65226
a((dp65227
g2
(lp65228
VYou can't tell directly
p65229
aVYou'll have to measure first to see if it fits, Graphics
p65230
aVMeasureString()
p65231
as(dp65232
g9
V17034
p65233
stp65234
a((dp65235
g2
(lp65236
VTools + Customize, Keyboard button
p65237
aVRebind the keys
p65238
aVCtrl + M, Ctrl + O is
p65239
as(dp65240
g9
V17034
p65241
stp65242
a((dp65243
g2
(lp65244
VRemove the comment from onDragEnter
p65245
aVThe drop won't be allowed unless you set e
p65246
aVEffect to one of the e
p65247
aVAllowedEffects
p65248
aVThat also changes the cursor
p65249
as(dp65250
g9
V17034
p65251
stp65252
a((dp65253
g2
(lp65254
VFrom the internal WebBrowserSite class:
p65255
aVHard-baked, you cannot override this
p65256
aVPutting the Winforms WebBrower inside a WindowsFormsHost would be a workaround, it's got a smarter implementation of this method that uses the IsWebBrowserContextMenuEnabled property and allows you to create your own context menu
p65257
as(dp65258
g9
V17034
p65259
stp65260
a((dp65261
g2
(lp65262
Vtest *obj = new test();
p65263
aVThis is a memory management problem
p65264
aVWhen does obj get deleted
p65265
aVIt can take a while for the thread to actually start running, the object needs to stay around long enough
p65266
aVI'm guessing you've got some code that's not in the snippet that is deleting that object again
p65267
aVToo soon
p65268
aVThe only code that can safely and accurately delete the object is the thread itself
p65269
as(dp65270
g9
V17034
p65271
stp65272
a((dp65273
g2
(lp65274
V/EHa does two things
p65275
aVFirst and foremost, it suppresses an optimization that omits exception filters that automatically call the destructors of local class variables if the code analyzer cannot see any code that might throw a C++ exception
p65276
aVThis makes stack unwinding safe for any kind of exception, not just a C++ exception
p65277
aVOverhead for these exception filters is time on x86 and space on both x86 and x64
p65278
aVAnd yes, it alters the behavior of catch(
p65279
aV, it now also filters any SEH exception, not just C++
p65280
aVThis is indeed a gamble because you catch all the really nasty stuff, the asynchronous hardware exceptions
p65281
aVAlthough I personally don't think that catching all C++ exceptions is very defensible either, you still have but a vague idea to what degree the program state got mutated and why it failed
p65282
aVRealistically, you'll need to switch to using  so that you can write your own exception filter and avoid catching the bad ones
p65283
aVThe exception code for C++ exceptions is 0xe04d5343 ("MSC")
p65284
aVUsing _set_se_translator() would be another approach
p65285
as(dp65286
g9
V17034
p65287
stp65288
a((dp65289
g2
(lp65290
VIt is relevant in remoting scenarios, passing true allows another call to be delivered
p65291
aVThis exact same argument was also the reason that the WaitHandle
p65292
aVWaitOne(int) overload was added to
p65293
aVNET 2
p65294
aV0 SP1
p65295
aVA compatibility breaking change that caused plenty of misery
p65296
aVPreviously only the WaitOne(int, bool) overload was available and nobody knew what that exitContext argument meant
p65297
aVPassing false is the normal usage
p65298
aVI count myself pleasantly ignorant of any practical example where using true could either make sense or come to a good end
p65299
aVRemoting is at its core quite complicated and poorly documented
p65300
aVWCF made it irrelevant
p65301
as(dp65302
g9
V17034
p65303
stp65304
a((dp65305
g2
(lp65306
VCreate a UITypeEditor
p65307
aVIt's GetEditStyle() override should return UITypeEditorEditStyle
p65308
aVDropDown
p65309
as(dp65310
g9
V17034
p65311
stp65312
a((dp65313
g2
(lp65314
VThat a form has an associated
p65315
aVresx file is an implementation detail that's specific to forms
p65316
aVYou cannot otherwise associate an arbitrary class with a
p65317
aVresx file
p65318
aVI assume that you actually want to use a ResourceManager here
p65319
aVDo note that there's one already built-in through Properties
p65320
aVResources, giving you access to resources that you added to Project + Properties, Resources tab
p65321
as(dp65322
g9
V17034
p65323
stp65324
a((dp65325
g2
(lp65326
VWe are 100% sure that the libraries are correctly placed
p65327
aVGetting that wrong would produce a different error
p65328
aVJust putting the
p65329
aVlib file in a directory isn't enough, you also have to tell the linker to link the
p65330
aVlib file
p65331
aVProject + Properties, Linker, Input, Additional Dependencies
p65332
aVIf that doesn't help then document your question better
p65333
aVPost a link to the specific download you used and copy your test project to a file sharing service
p65334
as(dp65335
g9
V17034
p65336
stp65337
a((dp65338
g2
(lp65339
VThe function returns data through the second argument
p65340
aVThe return value is an integer, indicating any possible error
p65341
aVThe proper declaration is:
p65342
aVYou'll have to declare the structure like this:
p65343
aVA sample call:
p65344
as(dp65345
g9
V17034
p65346
stp65347
a((dp65348
g2
(lp65349
VThat's the point of STA, COM will automatically marshal the call from your worker thread to the STA thread
p65350
aVSo that the COM server methods are always called in a thread-safe way
p65351
aVAnd if the method blocks, that will also block your STA thread
p65352
aVUsually the UI thread
p65353
aVThis means for one that using this COM object in a thread doesn't actually accomplish anything
p65354
aVFor another that the real problem is in the COM server, it shouldn't be blocking
p65355
aVDo make sure this isn't a deadlock situation
p65356
aVA possible workaround is to create the COM server on another STA thread so at least your UI thread doesn't get blocked
p65357
aVCheck this answer for sample code
p65358
aVBoth the Thread
p65359
aVSetApartmentState and the Application
p65360
aVRun calls are crucial to create a hospitable home for the server
p65361
as(dp65362
g9
V17034
p65363
stp65364
a((dp65365
g2
(lp65366
VA real fix requires replacing the designer for the control
p65367
aVThat's quite hard to do, the LabelDesigner class in System
p65368
aVDesign
p65369
aVdll is internal so you can't inherit it
p65370
aVThe hacky way is this:
p65371
as(dp65372
g9
V17034
p65373
stp65374
a((dp65375
g2
(lp65376
VOutput: Approx area = 141, real area = 134
p65377
aV126147876595
p65378
aVKeep this result in mind, the Region class was designed to be used in graphic code
p65379
aVIt is only accurate to a pixel with a knack for rounding errors to accumulate
p65380
aVThe larger you make diam, the smaller the relative error
p65381
as(dp65382
g9
V17034
p65383
stp65384
a((dp65385
g2
(lp65386
VTo create a child from another child, just write it like this:
p65387
aVOr fire a custom event that the parent can respond to
p65388
as(dp65389
g9
V17034
p65390
stp65391
a((dp65392
g2
(lp65393
VFrom the horse's mouth:
p65394
aVNone of BCPL, B, or C supports
p65395
aVcharacter data strongly in the
p65396
aVlanguage; each treats strings much
p65397
aVlike vectors of integers and
p65398
aVsupplements general rules by a few
p65399
aVconventions
p65400
aVIn both BCPL and B a
p65401
aVstring literal denotes the address of
p65402
aVa static area initialized with the
p65403
aVcharacters of the string, packed into
p65404
aVcells
p65405
aVIn BCPL, the first packed byte
p65406
aVcontains the number of characters in
p65407
aVthe string; in B, there is no count
p65408
aVand strings are terminated by a
p65409
aVspecial character, which B spelled
p65410
aVThis change was made partially
p65411
aVto avoid the limitation on the length
p65412
aVof a string caused by holding the
p65413
aVcount in an 8- or 9-bit slot, and
p65414
aVpartly because maintaining the count
p65415
aVseemed, in our experience, less
p65416
aVconvenient than using a terminator
p65417
as(dp65418
g9
V17034
p65419
stp65420
a((dp65421
g2
(lp65422
VIntegrating a
p65423
aVNET app into the shell without trouble is technically possible since
p65424
aVNET 4
p65425
ag2512
aVGoogle IContextMenu to find sample C# code that implements the required COM interface
p65426
aVBeware of the difficulty of getting it right, debugging is very unpleasant
p65427
aVBut that's a long way from what you are asking for, the shell extension handler lets you create a menu entry in the context menu for Explorer windows
p65428
aVText boxes in other apps don't expose a standard extensibility interface like the shell does
p65429
aVIt is not quite impossible, it requires injecting code into the app with a windows hook
p65430
aVBut you can't write that kind of code in C#
p65431
as(dp65432
g9
V17034
p65433
stp65434
a((dp65435
g2
(lp65436
VThat's an integer division, 1 / 2 = 0, not 0
p65437
ag2447
aVSince counter will never be larger than Count, the expression always produces 0
p65438
aVOne possible fix is to calculate a percentage:
p65439
as(dp65440
g9
V17034
p65441
stp65442
a((dp65443
g2
(lp65444
VYou didn't initialize the pointer
p65445
aVFix:
p65446
as(dp65447
g9
V17034
p65448
stp65449
a((dp65450
g2
(lp65451
VThis smells like a problem with ProcessStartInfo
p65452
aVLoadUserProfile
p65453
aVIt defaults to false, with the side effect that the started process will see the HKCU registry settings of your account, not the impersonated one
p65454
aVOffice programs are not going to like this
p65455
aVBeware that afaik you'll also have to set UseShellExecute to false to make this setting effective
p65456
aVThat will hamper your ability to start Word by simply passing a
p65457
aVdoc file as the file name
p65458
aVYou'll need to use "winword
p65459
aVexe" instead
p65460
as(dp65461
g9
V17034
p65462
stp65463
a((dp65464
g2
(lp65465
VRight-click the project in the Solution Explorer window, Properties
p65466
aVConfiguration Properties, C/C++, Preprocessor, Preprocessor Definitions setting
p65467
aVVerify that you see CPLAPPLET_PROGRAM_EXPORTS there
p65468
aVIf you don't then add it
p65469
aVIt is also very likely that you'll need a
p65470
aVdef file so that the export gets renamed
p65471
aVMake sure it is present in your project's list of files
p65472
aVAfter building, use Dumpbin
p65473
aVexe /exports on the generated DLL and ensure that the export is present and properly spelled "DllUnregisterServer" without any additional characters
p65474
aVNeeding the help from the author isn't very unlikely btw, the way the COM exports seem to be handled is pretty nonstandard
p65475
as(dp65476
g9
V17034
p65477
stp65478
a((dp65479
g2
(lp65480
VYou'll need to provide the linker with a
p65481
aVdef file that renames the export
p65482
aVDocs are here, you need EXPORTS
p65483
as(dp65484
g9
V17034
p65485
stp65486
a((dp65487
g2
(lp65488
VThere's some crucial information missing about what RunOnBackground() really does
p65489
aVThis is otherwise a good match for what happens when you use apartment threaded COM objects on a worker thread
p65490
aVCOM automatically marshals any method call on such an object from the worker thread to the STA thread on which it was created
p65491
aVThat can only work well when the STA thread observes STA threading requirements
p65492
aVIt must pump a message loop and cannot block
p65493
aVBreaking those rules makes deadlock very likely, the worker thread call cannot complete until the STA thread dispatches the marshaled call
p65494
aVA sure sign that this is what is going on is seeing Thread
p65495
aVJoin() solve the problem
p65496
aVIt pumps a message loop internally in the CLR when it is called on an STA thread
p65497
aVTo diagnose this, you'll need Debug + Windows + Threads to see what that worker thread is blocking on
p65498
aVIf my guess is right, it will be buried deep inside of the COM plumbing code, waiting for the marshaled call to complete
p65499
aVYou can only see this by enabling unmanaged code debugging and setting up the Microsoft Symbol Server so you get debugging symbols for the plumbing code and get a reliable stack trace
p65500
aVFixing this is going to be difficult
p65501
aVYou cannot magically flip a switch and make code run on a thread when it has explicitly stated that it doesn't support multi-threading
p65502
aVIt is imperative that you create the instance of the COM object on the same thread that calls its methods
p65503
aVAnd that thread has to be an STA thread
p65504
aVCheck this sample code for the approach
p65505
aVIf you don't control the creation of the COM object then you're stuck
p65506
as(dp65507
g9
V17034
p65508
stp65509
a((dp65510
g2
(lp65511
VYou are excluding the exact thing you have to do to solve your problem
p65512
aVIf you don't set InitialDirectory then the dialog uses the last used directory
p65513
aVThis info is stored in the registry, indexed by process name
p65514
aVYou cannot selectively turn this behavior off
p65515
aVThe registry key that's used has been changing between Windows version
p65516
aVI think on Win7 it is now HKEY_CURRENT_USER\u005cSoftware\u005cMicrosoft\u005cWindows\u005cCurrentVersion\u005cExplorer\u005cComDlg32\u005cLastVisitedPidlMRU
p65517
aVIt is no longer in cleartext like it used to be on earlier versions
p65518
aVIf you want to risk trying to parse the key values listed there then do make sure you verify the Windows version
p65519
aVFrankly, this isn't worth the simple code you'd have to write to initialize the InitialDirectory property
p65520
as(dp65521
g9
V17034
p65522
stp65523
a((dp65524
g2
(lp65525
VYes, doesn't work
p65526
aVThe callback is executed on a threadpool thread, there's nobody there to catch the exception
p65527
aVYou'll need to, say, raise an event that the UI can subscribe to
p65528
aVMarshaling is required, the UI code needs to use something like Control
p65529
aVBeginInvoke() if it needs to update the UI
p65530
as(dp65531
g9
V17034
p65532
stp65533
a((dp65534
g2
(lp65535
VThe IDE is smart enough to figure this out by itself
p65536
aVTry this in a sample project: Project + Add New Item, Class, named it Foo
p65537
aVcs
p65538
aVRepeat, now name it Foo
p65539
aVDesigner
p65540
aVcs
p65541
aVNote how it automatically becomes a sub-item of Foo
p65542
aVcs
p65543
aVThe "
p65544
aVDesigner" part of the name matters
p65545
as(dp65546
g9
V17034
p65547
stp65548
a((dp65549
g2
(lp65550
VIContextMenu::QueryContextMenu()
p65551
aVShell extensions are in the domain of C++, very unpleasant in C#,
p65552
aVNET 4
p65553
aV0 required
p65554
aVA sample project that uses it is here
p65555
as(dp65556
g9
V17034
p65557
stp65558
a((dp65559
g2
(lp65560
VThe IDE isn't smart enough to parse your source and see that you are pinvoking a DLL
p65561
aVIn your regular project, Project + Add Existing Item and select that DLL
p65562
aVSelect it in the Solution Explorer window
p65563
aVProperties window, set Build Action to "Content"
p65564
aVThat ensures that the IDE knows that it needs to be published as well
p65565
aVSet Copy to Output Directory to "Copy if Newer"
p65566
aVThat ensures that the DLL ends up in the right place, the same folder as your EXE
p65567
aVNow go back to your Declare statements and delete the directory off the file name
p65568
aVThat can't work, there won't be a Celina on the target machine
p65569
as(dp65570
g9
V17034
p65571
stp65572
a((dp65573
g2
(lp65574
VThis answer has a list of optimizations and strategies used by the JIT optimizer
p65575
aVThey are not fundamentally different from what a native code optimizer does
p65576
aVOne constraint in the jitter is that it cannot spend a great deal of time analyzing the code
p65577
aVEvery millisecond it burns affects the responsiveness of the program
p65578
aVTwo strategies help
p65579
aVAssemblies can be pre-jitted by ngen
p65580
aVexe, all of the
p65581
aVNET assemblies are and it is wise to do the same with your own assemblies
p65582
aVAs long as they are 'large', less time might be spent jitting the code than finding and loading the
p65583
aVni
p65584
aVdll file on disk
p65585
aVAnd the jitter compiles code on demand, just before a method starts executing
p65586
aVWhich tends to spread the cost over time, relevant to code that runs at human time where responsiveness matters
p65587
aVOne detail worth noting is that a jitter can take advantage of core specific instructions
p65588
aVThat's an edge that is largely gone, cores are not that different these days
p65589
aVBut it will readily generate 64-bit code on a x64 operating system without doing anything special
p65590
aVA typical number that's bandied about is that jitted machine code is 85% as efficient as native precompiled code
p65591
aVTake that with several large lumps of salt, the quality and nature of the source code is always first
p65592
as(dp65593
g9
V17034
p65594
stp65595
a((dp65596
g2
(lp65597
VVery unhappy number
p65598
aVSharing memory isn't going to solve it either, your VB
p65599
aVNET program easily loses access to the CPU for 35 msec or more
p65600
aVMissing updates
p65601
aVAnd you really don't want to burn the cycles to try to keep up, polling is fugly
p65602
aVThe other option is to use a socket or a named pipe
p65603
aVYou won't lose any data and won't burn cycles
p65604
aVA corner case is that your C++ program might get bogged down if your VB
p65605
aVNET program isn't responsive
p65606
aVDo keep in mind that the human eye can't perceive updates that happen faster than about 30 times per second
p65607
aVIf this is a GUI requirement then 150 updates per sec is wasted effort that can actually make your GUI freeze
p65608
as(dp65609
g9
V17034
p65610
stp65611
a((dp65612
g2
(lp65613
VThe actual dialog is a private class named ColorUI, nested inside the System
p65614
aVDrawing
p65615
aVDesign
p65616
aVColorEditor class
p65617
aVThat prevents you from altering it
p65618
aVYou'll need to create a complete replacement for this UITypeEditor derived class
p65619
aVYou can get implementation hints on getting this right by using Reflector
p65620
aVBeware that you cannot override the [Editor] attribute on existing controls, your new version of the dialog will only be usable on your own custom controls
p65621
as(dp65622
g9
V17034
p65623
stp65624
a((dp65625
g2
(lp65626
Vwhen I try to use "GetLastError" it return number like "-529697949"
p65627
aVThe error code is 0xe06d7363, the last 3 hex digits spell "MSC"
p65628
aVThat's the exception code for a C++ exception in Microsoft's compiler
p65629
aVYour code is bombing on a uncaught C++ exception, probably thrown in DllMain()
p65630
aVYou'll need a debugger if you can't reverse-engineer it from this hint
p65631
as(dp65632
g9
V17034
p65633
stp65634
a((dp65635
g2
(lp65636
VThere's a bug in the implementation of the internal MdiControlStrip class, the control that displays the icon and the min/max/restore glyphs in the parent window
p65637
aVI haven't characterized it as yet, the code isn't that easy
p65638
aVA classic side effect of the bug is that the glyphs get doubled up, you found some other side-effects
p65639
aVThe fix is simple though, delay creating the child windows until after the constructor is completed
p65640
aVLike this:
p65641
as(dp65642
g9
V17034
p65643
stp65644
a((dp65645
g2
(lp65646
VWindows sends the WM_MOUSEWHEEL message to the control that has the focus
p65647
aVThat won't be Panel, it is not a control that can get the focus
p65648
aVAs soon as you put a control on the panel, say a button, then the button gets the focus and the message
p65649
aVThe button however has no use for the message, it's got nothing to scroll
p65650
aVWindows notices this and sends the message to the parent
p65651
aVThat's the panel, now it will scroll
p65652
aVYou'll find code for a custom panel that can get the focus in this answer
p65653
as(dp65654
g9
V17034
p65655
stp65656
a((dp65657
g2
(lp65658
VIt doesn't work because the DragEnter event handler is missing
p65659
aVYou need to set e->Effect to one of the e->AllowedEffects to get the DragDrop event to run
p65660
aVDragOver is only meant to provide feedback
p65661
aVStarting a drag on MouseDown indeed interferes with the Click event, there won't be a mouse up event to trigger the click
p65662
aVIf you want to support both then you need to make it more selective and only start the drag when you see the user making a dragging motion
p65663
aVThat requires storing the mouse position in the MouseDown event
p65664
aVUse the MouseMove event to check if the left button is still down
p65665
aVAnd call DoDragDrop() when you see the mouse moved by more than SystemInformation::DoubleClickSize
p65666
aVFurthermore, you should check in the DragEnter event handler that an object is being dragged that you know how to handle
p65667
aVYou wouldn't want to, say, accept a drag a file from Explorer
p65668
as(dp65669
g9
V17034
p65670
stp65671
a((dp65672
g2
(lp65673
VUsing double quotes around path names is wise
p65674
aVIt is required when they contain spaces
p65675
aVPost the compile command line you find in buildlog
p65676
aVhtm if that doesn't help
p65677
as(dp65678
g9
V17034
p65679
stp65680
a((dp65681
g2
(lp65682
VClick the lightning bolt icon in the Properties window
p65683
aVDouble-click KeyPressed to add an event handler
p65684
as(dp65685
g9
V17034
p65686
stp65687
a((dp65688
g2
(lp65689
VThe CRT is not localizable
p65690
aVThere are a handful of error messages, all hard-coded in English with #define statements
p65691
aVYou'll find them in crt\u005csrc\u005ccmsgs
p65692
ag6193
aVThe only one that a user is ever liable to see is
p65693
aVThis application has requested the
p65694
aVRuntime to terminate it in an unusual
p65695
aVway
p65696
aVPlease contact the
p65697
aVapplication's support team for more
p65698
aVinformation
p65699
aVA useless message, translating it doesn't make it any clearer
p65700
as(dp65701
g9
V17034
p65702
stp65703
a((dp65704
g2
(lp65705
VYes, the Office 2003 PIA will fix your problem
p65706
aVClearly it isn't installed so there's little reason to fear you breaking anything
p65707
aVAnother way is to not use the PIA, it is pretty uncommon to actually need one
p65708
aVOpen the Reference node in the Solution Explorer window, select the Outlook reference
p65709
aVIn the Properties window set Copy Local to True
p65710
aVBuild
p65711
aVYou'll get the interop libraries (office
p65712
aVdll and microsoft
p65713
aVoffice
p65714
aVinterop
p65715
aVoutlook
p65716
aVdll) in the build directory
p65717
aVDeploy them along with your own assemblies
p65718
as(dp65719
g9
V17034
p65720
stp65721
a((dp65722
g2
(lp65723
VThere's no faster way then taking advantage of the sparse file support built into NTFS, the file system for Windows used on hard disks
p65724
aVThis code create a one gigabyte file in a fraction of a second:
p65725
aVWhen read, the file contains only zeros
p65726
as(dp65727
g9
V17034
p65728
stp65729
a((dp65730
g2
(lp65731
VNothing jumps out
p65732
aVThere is however a very serious race condition in your code
p65733
aVIt is related to the SystemEvents class
p65734
aVThat class provides important notifications to controls so they can respond to the user changing the Windows theme
p65735
aVThat class needs a hidden notification window to receive messages about the changes the user made
p65736
aVThis goes very wrong if your program's first window is created on a worker thread instead of the UI thread
p65737
aVThat makes the SystemEvents class create that notification window on the wrong thread (not your worker thread btw)
p65738
aVAnd the events it raises will be called from that thread
p65739
aVGetting the event on that wrong thread creates havoc, controls are not thread-safe
p65740
aVThe most typical outcome is that you'll have odd painting problems or the form deadlocks when you lock the workstation
p65741
aVI can imagine what you see going wrong could be explained by this as well
p65742
aVThe
p65743
aVNET framework already has excellent and time-tested support for splash screens
p65744
aVI recommend you use it instead of spinning your own
p65745
aVCheck this answer for the code
p65746
aVIf you want to keep your own then you can work around the race problem by pasting this line of code into your Main method, before the ShowSplashAsync call:
p65747
as(dp65748
g9
V17034
p65749
stp65750
a((dp65751
g2
(lp65752
VThe constructor of your control runs at both design time and run time
p65753
aVSo as soon as you drop the control on the form, it will fill the tree view
p65754
aVProblem is, the nodes will be serialized to InitializeComponent()
p65755
aVTake a look at the Designer
p65756
aVcs file for your form, you'll find them back there
p65757
aVWhen you run the form, the constructor runs again, doubling the list
p65758
aVYou need to prevent the constructor from adding the nodes at design time
p65759
aVThat's a bit difficult to do, you'd normally use the DesignMode property but it isn't set to true yet in the constructor
p65760
aVDo it like this instead:
p65761
aVOr do it explicitly by adding a public method that you call in the form's constructor or OnLoad method
p65762
aVWhich is rather wise, you might want to catch exceptions
p65763
aVAlways likely when you tinker with the file system
p65764
as(dp65765
g9
V17034
p65766
stp65767
a((dp65768
g2
(lp65769
VThere's no standard COM cataloging service that I know of, although COM+ might have something
p65770
aVTake a look at , you'll find GUIDs of type of components
p65771
aVLike 0DE86A57-2BAA-11CF-A229-00AA003D7352, described as "Class implements IPersistPropertyBag"
p65772
aVA coclass declares this same guid in its
p65773
aVThis seems like a good match for your scenario
p65774
aVYou would have to pick a guid and tell the component authors about it
p65775
aVThey have to write the Implemented Categories key with their installer
p65776
aVIt is still a fairly awkward slog through the CLSID keys, you don't want to do this very often
p65777
aVBut at least you won't have to load DLLs to discover interfaces, that could have all kinds of nasty side-effects
p65778
aVI'd recommend a dialog in your Options menu that lets the user start a scan and choose, also a good way to disable misbehaving components
p65779
aVBtw, the support pain that this can cause usually makes apps work from an 'approved' list
p65780
as(dp65781
g9
V17034
p65782
stp65783
a((dp65784
g2
(lp65785
VThat's a definite Yes for a
p65786
aVNET jitter
p65787
aVIt merely loads IL from a DLL, just-in-time code generation makes the fact that it came from a DLL disappear
p65788
aVAll code from any DLL goes into the same loader heap
p65789
aVOne consequence of this is that a DLL cannot be unloaded unless the entire AppDomain is unloaded
p65790
aVA definite No for the C++ compiler, the exported functions are precompiled and located at a fixed address, an offset from the DLL base address
p65791
aVAn indirect jump through the IAT is required, although optimizations are possible
p65792
aVBut not inlining, that has to be done by the compiler
p65793
as(dp65794
g9
V17034
p65795
stp65796
a((dp65797
g2
(lp65798
VThe exact same thing happened with the base class libraries (like System
p65799
aVdll) for the desktop versions of
p65800
aVNET 2
p65801
aV0, 2
p65802
aV0SP1, 2
p65803
aV0SP2, 3
p65804
aV0, 3
p65805
aV0SP1, 3
p65806
aV5 and 3
p65807
aV5SP1, they all have the exact same [AssemblyVersion], 2
p65808
ag2512
ag2512
ag2512
aVNot until
p65809
aVNET 4
p65810
aV0 did this version get bumped to 4
p65811
ag2512
ag2512
ag2512
aVThe assembly version represents the public interface of an assembly
p65812
aVA breaking change in the types members that are accessible to other assemblies requires a new [AssemblyVersion]
p65813
aVNecessarily so, because that requires client code that uses these types to be recompiled
p65814
aVI checked for the System
p65815
aVCore
p65816
aVdll versions you mentioned
p65817
aVBit of a painful slog through the Reflector export output for the assembly
p65818
aVPlenty of changes in the private and internal classes and methods
p65819
aVBut not the public ones, the same types and methods
p65820
aVNot entirely true, and this happened in the desktop version as well, the StrongBox class acquired a default constructor in version 4
p65821
ag2512
aVSaving grace perhaps is that the constructor is documented as "This API supports the
p65822
aVNET Framework infrastructure and is not intended to be used directly from your code
p65823
aVAnd that specifically in Silverlight an app that targets 4
p65824
aV0 is never going to see the 3
p65825
aV0 version of that class by accident, unlike the desktop case
p65826
as(dp65827
g9
V17034
p65828
stp65829
a((dp65830
g2
(lp65831
VNo repro, I don't see anything wrong
p65832
aVThe C# compiler already embeds a UAC manifest into the assembly since VS2008 (possibly VS2005 SP1 for Vista)
p65833
aVIf you want to modify it then use Project + Add New Item and select the "Application Manifest File" item template
p65834
as(dp65835
g9
V17034
p65836
stp65837
a((dp65838
g2
(lp65839
VThese tools are installed in the Windows SDK directory
p65840
aVFor VS2010, the default install path is C:\u005cProgram Files\u005cMicrosoft SDKs\u005cWindows\u005cv7
p65841
aV0A\u005cbin
p65842
as(dp65843
g9
V17034
p65844
stp65845
a((dp65846
g2
(lp65847
VIt is not possible to use Reflection to retrieve method argument values
p65848
aVOnly a debugger can have a shot at it, but even a debugger is powerless when the code is optimized
p65849
aVArgument passing is heavily optimized by the JIT compiler
p65850
aVSuppressing this optimization isn't worth the considerable cost, nor can an app debug itself
p65851
aVAs long as you want to keep this style of exception reporting, you'll have to explicitly pass the argument values to some kind of formatter
p65852
aVA helper function that takes a Params array and returns an exception object that you can throw jumps to mind
p65853
as(dp65854
g9
V17034
p65855
stp65856
a((dp65857
g2
(lp65858
VThe build system for VS2010 was dramatically changed and only directly supports building for 4
p65859
ag2512
aVTargeting 3
p65860
aV5 requires having VS2008 on your machine
p65861
aVMore about this in this answer
p65862
as(dp65863
g9
V17034
p65864
stp65865
a((dp65866
g2
(lp65867
VThe project property changes you've made to get it to build in the Debug configuration are not automatically applied to the Release configuration as well
p65868
aVNote the "Configuration" combo in the upper left corner of the dialog
p65869
aVAltered property values are shown in bold type
p65870
aVIf you cannot remember what changes you've made then open the
p65871
aVvcproj file in a text editor like Notepad
p65872
aVexe
p65873
aVThe settings that were changed from their default value are listed in the Debug|Win32 configuration section
p65874
as(dp65875
g9
V17034
p65876
stp65877
a((dp65878
g2
(lp65879
VI repro
p65880
aVThere is a Note in the MSDN article about this:
p65881
aVIn Visual C#, EditorBrowsableAttribute
p65882
aVdoes not suppress members from a class
p65883
aVin the same assembly
p65884
aVOddly, I don't see it suppress it either when I put the UserControl in a different assembly in the same solution
p65885
aVYou may want to ping connect
p65886
aVmicrosoft
p65887
aVcom about this, something isn't right
p65888
as(dp65889
g9
V17034
p65890
stp65891
a((dp65892
g2
(lp65893
VThis appearance is controlled by the Visual Styles theme selected in your operating system
p65894
aVIn general, users do not appreciate any program that ignores their theme settings, especially when they paid money for a custom one
p65895
aVBut you can get what you want, you'll have to set the DrawMode property to OwnerDrawFixed and implement a handler for the DrawItem event
p65896
aVThere's a good example to get you started in the MSDN Library article for this event
p65897
aVJust change the font assignment in that sample code
p65898
as(dp65899
g9
V17034
p65900
stp65901
a((dp65902
g2
(lp65903
VNo repro
p65904
aVSounds to me that you are doing more than just changing the Visible property
p65905
aVWhenever you assign the Location property, you have to add the AutoScrollPosition to compensate for the scroll state
p65906
aVPost code if this doesn't help
p65907
as(dp65908
g9
V17034
p65909
stp65910
a((dp65911
g2
(lp65912
VDon't use Dependency Walker, it unmangles the exported name of the function and doesn't tell you the real export name
p65913
aVNote that it is smart enough to see that it takes no arguments and has no return value
p65914
aVIt can only do this if it sees the name as decorated by the C++ compiler
p65915
aVUse Dumpbin
p65916
aVexe /exports on the DLL to see the real name
p65917
aVIt ought to be "
p65918
aVCreateScanEngine@@YGXXZ", use the EntryPoint property in the [DllImport] attribute
p65919
aVYou may also want to declare the function with extern "C" so this name mangling doesn't happen
p65920
as(dp65921
g9
V17034
p65922
stp65923
a((dp65924
g2
(lp65925
VCopy the DLLs into the same folder as the EXE
p65926
aVIt you put them in a sub directory then you are going to have to use the  element in an app
p65927
aVexe
p65928
aVconfig file so that the CLR can find them there
p65929
as(dp65930
g9
V17034
p65931
stp65932
a((dp65933
g2
(lp65934
VThe only possible interpretation I can make of this is:
p65935
as(dp65936
g9
V17034
p65937
stp65938
a((dp65939
g2
(lp65940
VWindows Forms doesn't make it particularly easy unless it is the dialog itself that takes care of the side-effects
p65941
aVWhich isn't always common, it is usually done in the form that calls ShowDialog(), based on the return value
p65942
aVNo biggie though, add your own event to the form:
p65943
aVAnd the code in your main form could then look like this:
p65944
as(dp65945
g9
V17034
p65946
stp65947
a((dp65948
g2
(lp65949
VI've heard of this problem before but never realized it was related to the TransparencyKey choice
p65950
aVNice find
p65951
aVIt is almost certainly caused by Aero
p65952
aVWith it disabled, the effect is implemented by use of a hardware overlay in the video adapter
p65953
aVWith it enabled, the desktop window compositing feature implements it
p65954
aVYou can typically tell by a very brief flash of the transparency color before DWM catches up and replaces the area with the pixels from the windows in the background
p65955
aVTurning DWM off for your window might fix the problem but you'll also lose the glass effects
p65956
aVI can see little rhyme or reason to the color value, looks pretty random to me
p65957
aVHard to call this anything else than a bug
p65958
aVI never ran into this before myself, I always use the same transparency key
p65959
aVColor
p65960
aVFuchsia, an excellent fuchsed-up color
p65961
aVRecommended
p65962
as(dp65963
g9
V17034
p65964
stp65965
a((dp65966
g2
(lp65967
VLeaking window handles is a common mishap in a Winforms app
p65968
aVInduced by calling Controls
p65969
aVClear() or Controls
p65970
aVRemove() without calling Dispose() on the removed control(s)
p65971
aVYou can troubleshoot that with Taskmgr
p65972
aVexe, Processes tab
p65973
aVView + Select Columns and tick USER objects, GDI objects and Handles
p65974
aVObserve the values of these columns while your app runs
p65975
aVIf you see USER objects climb steadily then you are not calling Dispose() on a control when you should
p65976
aVClimbing GDI objects tend to be bitmaps that you don't dispose
p65977
aVIf that doesn't pan out then a memory profiler is your next resource
p65978
aVSpend money on a decent one
p65979
as(dp65980
g9
V17034
p65981
stp65982
a((dp65983
g2
(lp65984
VThat's not possible, the point of ClickOnce is to not alter the configuration of the target machine in any way
p65985
aVQuite the opposite of what is required to get an ActiveX component functioning, it has to be registered and that requires altering the registry with an admin account
p65986
as(dp65987
g9
V17034
p65988
stp65989
a((dp65990
g2
(lp65991
VThis is the core problem of multi-threading, you cannot demand that the client code uses your object in a thread-safe manner
p65992
aVNor can you really do anything to help the client code fall into the pit of success, it has to take care of the locking by itself
p65993
aVPutting the onus of making your code work on the person that is least likely to get it right
p65994
aVYou can make it easier by returning a copy of the object from your accessor
p65995
aVThat's thread-safe, there will only be one copy owned by one thread
p65996
aVYou probably ought to make that copy's type immutable to re-inforce that modifying the object won't likely have the desired outcome
p65997
aVAn unsolvable side-effect that might bite badly is that this copy is by definition stale
p65998
aVThese are band-aids that are likely to do more harm than good
p65999
aVDocument the stuffing out of the method so that the client programmer knows what to do
p66000
as(dp66001
g9
V17034
p66002
stp66003
a((dp66004
g2
(lp66005
VYes, this cannot work, the DLR has no type info available about the COM object
p66006
aVThis is a notorious problem in shell programming, it uses interfaces that are derived from IUnknown, not IDispatch so late binding isn't supported
p66007
aVAnd there is no type library available for them that lets
p66008
aVNET easily generate an interop library for the interface types
p66009
aVIShellItem is declared in ShObjIdl
p66010
aVidl, it is filled with cpp_quote()
p66011
aVWhich defeats any attempt to use midl
p66012
aVexe to generate a type library, only a
p66013
aVh file can be created
p66014
aVAlready provided btw, ShObjIdl
p66015
ag6193
aVOnly a C++ compiler can use it
p66016
aVRe-declaring the interface in C# is technically possible with the [ComImport], [Guid] and [PreserveSig] attributes
p66017
aVYou have to do so very carefully, luckily IShellItem derives directly from IUnknown so you can dodge the multiple inheritance bullet
p66018
aVWhat doesn't help is that the interface method uses native C types that don't marshal automatically
p66019
aVNotably GetDisplayName() takes an LPWSTR, a raw pointer to a Unicode string
p66020
aVNot a BSTR, the automation compatible string type
p66021
aVThat requires you to mess with unsafe pointers in your C# code
p66022
aVBest thing to do is to declare it IntPtr, allocate a chunk of memory with Marshal
p66023
aVAllocCoTaskMem() and marshal the string yourself after the call with Marshal
p66024
aVPtrToStringUni()
p66025
aVYuck, shell programming is a complete pita
p66026
aVGoogle the heck out of this so you can copy/paste something that's known to work
p66027
aVIf that comes up empty, using C++/CLI so you can use ShObjIdl
p66028
aVh is definitely a better way
p66029
aVGood luck with it
p66030
as(dp66031
g9
V17034
p66032
stp66033
a((dp66034
g2
(lp66035
VThe error message is hopeless, you'll need to debug the COM server to see what is going wrong
p66036
aVIf you don't have the source code for it then you may get something out of the trace you get from SysInternals' ProcMon
p66037
aVRealistically, you need help from the component vendor or author
p66038
as(dp66039
g9
V17034
p66040
stp66041
a((dp66042
g2
(lp66043
VSeveral possibilities:
p66044
aVYou are redirecting output and error but not reading it
p66045
aVThe process will stall when its stdout or stderr buffer fills up to capacity
p66046
aVThe program might be displaying an error message and waiting for a keypress
p66047
aVYou are not redirecting input nor check stderr, that keypress will never come
p66048
aVSome programs, xcopy
p66049
aVexe is a very good example, require stdin to be redirected when you redirect stdout
p66050
aVAlthough the failure mode for xcopy
p66051
aVexe is an immediate exit without any diagnostic
p66052
aVSeeing it fixed when you kill your C# program makes the first bullet the likeliest reason
p66053
as(dp66054
g9
V17034
p66055
stp66056
a((dp66057
g2
(lp66058
VIt is simple to do, RTB actually implements support for password entry
p66059
aVIt just isn't exposed in the
p66060
aVNET wrapper
p66061
aVAdd a new class to your project and paste the code shown below
p66062
aVCompile
p66063
aVDrop the new control from the top of the toolbox onto your form
p66064
as(dp66065
g9
V17034
p66066
stp66067
a((dp66068
g2
(lp66069
VYou can override a control's ProcessCmdKey() method to implement custom shortcut keystrokes
p66070
aVBig advantage of doing it this way is that the keystroke will work only when the tab control or one of the controls on the tab pages has the focus
p66071
aVProject + Add Class, paste the code shown below and compile
p66072
aVDrop the new control from the top of the toolbox onto your form
p66073
aVIf you want the function keys to work no matter what control on the form has the focus then you should override the ProcessCmdKey method of the form
p66074
as(dp66075
g9
V17034
p66076
stp66077
a((dp66078
g2
(lp66079
VYour error handling isn't kosher, the real error you are probably getting is 0x80010106, the last word is 262
p66080
aVThe error code is RPC_E_CHANGED_MODE, "Cannot change thread mode after it is set"
p66081
aVWhich is what CoInitialize/Ex returns when it was called before and you are trying to change from STA to MTA or the other way around
p66082
aVThis isn't possible, the apartment state for a thread is locked in on the first call to CoInitializeEx()
p66083
aVYou need to find out where the first call happened
p66084
aVThis could have been done by the CLR for a managed thread for example
p66085
aVThe apartment state for a thread is determined by the [STAThread] or [MTAThread] on the Main() method for the startup thread
p66086
aVOr the Thread
p66087
aVSetApartmentState() for a managed thread that you create yourself
p66088
aVA threadpool thread is always MTA, that cannot be changed
p66089
aVAltering the apartment state for a thread can have many side effects
p66090
as(dp66091
g9
V17034
p66092
stp66093
a((dp66094
g2
(lp66095
VIt is called deadlock
p66096
aVYour main thread is blocked, waiting for the process to exit
p66097
aVThat stops it from taking care of essential duties
p66098
aVLike keeping the UI updated
p66099
aVAnd making sure that Control
p66100
aVInvoke() requests are dispatched
p66101
aVThat stops the AppendText() method from completing
p66102
aVWhich stops the process for exiting
p66103
aVWhich stops your UI thread from ever getting past the WaitForExit() call
p66104
aV"Deadly embrace", aka deadlock
p66105
aVYou cannot block your main thread
p66106
aVUse the Process
p66107
aVExited event instead
p66108
as(dp66109
g9
V17034
p66110
stp66111
a((dp66112
g2
(lp66113
VThe return type for total_microseconds() is , not long
p66114
aVLooks like you're compiling this with a compiler that has a 32-bit long type
p66115
aVMuch to small to store 40 years worth of microseconds
p66116
as(dp66117
g9
V17034
p66118
stp66119
a((dp66120
g2
(lp66121
VYou have to set it to null
p66122
aVLike this:
p66123
as(dp66124
g9
V17034
p66125
stp66126
a((dp66127
g2
(lp66128
VIf you use TCP/IP then you are quite likely using threads
p66129
aVIf a thread dies with an unhandled exception, very common when calling EndXxxx(), then your app terminates
p66130
aVThis may be silent if Windows Error Reporting is turned off on the machine, not uncommon on servers
p66131
aVAt least catch ObjectDisposedException so you can deal with a connection that abruptly disconnects or is closed forcibly
p66132
aVAnd yes, write an event handler for AppDomain
p66133
aVCurrentDomain
p66134
aVUnhandledException, subscribe it in your Main() method
p66135
aVLog or display the value of e
p66136
aVExceptionObject
p66137
aVToString() so you can tell exactly what it is dying on
p66138
as(dp66139
g9
V17034
p66140
stp66141
a((dp66142
g2
(lp66143
VA nice trick to deal with events that you cannot process when they are raised is to delay the processing
p66144
aVWhich you can do with the Control
p66145
aVBeginInvoke() method, it runs as soon as all events are dispatched, side-effects are complete and the UI thread goes idle again
p66146
aVOften helpful for TreeView as well, another cranky control
p66147
aVJust in case: this has nothing to do with threading and the trick is quite cheap
p66148
aVWhy no ItemChecked event
p66149
aVNot really sure
p66150
aVCheckedListBox just isn't a very good control
p66151
aVDefinitely not done by one of the gurus in the original Winforms team
p66152
as(dp66153
g9
V17034
p66154
stp66155
a((dp66156
g2
(lp66157
VI can't say I see any difference between 78 and 79
p66158
aVYour code is hard to interpret, RightToLeft is not a boolean property
p66159
aVIt does look iffy, the 2nd column doesn't seem to be properly aligned
p66160
aVNot sure, you didn't mention your Windows version either
p66161
aVSolve you problem by drawing the listbox content yourself
p66162
aVUse the DrawItem event, there's a good example in the MSDN Library article for it
p66163
as(dp66164
g9
V17034
p66165
stp66166
a((dp66167
g2
(lp66168
VThis is just an educated guess, the exact details of the collector are not available anywhere
p66169
aVThe Shared Source version of the CLR doesn't have the goodies
p66170
aVAs blogged, a concurrent collection only happens during the gen #2 collection, the one that can bite because there is no reasonable upper limit on the number of objects that might be in that generation
p66171
aVAnd can visibly affect the responsiveness of a GUI app on a workstation
p66172
aVGen #0 and #1 are already collected, leaving a decent chunk of memory to allocate
p66173
aVIt can have started the graph of gen #2 objects that it found while collecting 0 and 1
p66174
aVI think the GC first suspends all threads so it can safely walk their stack and CPU registers to find object references
p66175
aVThat can happen pretty quickly
p66176
aVAnd adds them to the graph
p66177
aVIt can now release the threads, they can keep running without fear of object references getting invalid because nothing is being moved yet
p66178
aVAllocations from gen #0 are no problem, maybe it can even collect #0 if it fills up
p66179
aVThe blog post suggests it does
p66180
aVMeanwhile, the collector can walk gen #2 and add references to the graph from the objects there
p66181
aVAnd find out what objects are no longer referenced
p66182
aVThreads are running while this happens
p66183
aVUnless the lower generations fill up, then a thread that allocates runs into a lock
p66184
aVNext it needs to suspend the threads again so it can compact gen #2, moving objects and updating their references
p66185
aVThe amount of time that could take is pretty unpredictable
p66186
aVI have no insight if it will move a gigabyte of objects to fill up a hole of 16 bytes that became free early in the heap
p66187
aVI seriously doubt it, that takes an easy 200 msec
p66188
aVOne consequence of this theory is that it won't release gen #2 objects that became unreferenced while the threads were running during the collection
p66189
aVThat might a way to test this theory, although I don't really see a good way to do so
p66190
as(dp66191
g9
V17034
p66192
stp66193
a((dp66194
g2
(lp66195
VI remember this problem from a question a while back
p66196
aVThe Parse() methods are affected by the user overrides in the Control Panel + Region and Language applet
p66197
aVIIRC, it is especially sensitive to the "Negative sign symbol" setting
p66198
aVAsk your user to correct the settings there
p66199
aVThe reference question is here
p66200
as(dp66201
g9
V17034
p66202
stp66203
a((dp66204
g2
(lp66205
VYes, you need a reference to the SingleInstanceApplication object
p66206
aVSince there is only ever one of them, you can cheat:
p66207
aVNow you can use instance
p66208
aVSplashScreen to always get a reference to the splash screen and make SetSplashInfo() static
p66209
aVA clean fix should be possible but I can't see how you are creating the SingleInstanceApplication instance
p66210
as(dp66211
g9
V17034
p66212
stp66213
a((dp66214
g2
(lp66215
VYou have to set the SelectedTab property of the TabControl
p66216
aVLike this:
p66217
aVReplace "SomeTabControl" with the name of the tab control, I can't tell from your code
p66218
aVAvoid the ugly KeyDown overrides by overriding the form's ProcessCmdKey()
p66219
aVLike this:
p66220
as(dp66221
g9
V17034
p66222
stp66223
a((dp66224
g2
(lp66225
VYour [DllImport] declaration is equivalent to the VB6 declare statement
p66226
aVIt is probably best to assume that the VB6 declaration was wrong to begin with an that you got away with it by luck
p66227
aVThe return type is quite odd, but that can't cause a stack problem since the return value is passed through a CPU register, not the stack
p66228
aVStart diagnosing this with Debug + Windows + Registers
p66229
aVPay attention to the value of ESP before and after the call
p66230
aVIf it is not the same then you really do have a declaration problem and lots of calls to this function can blow the stack
p66231
aVNot that likely btw, this normally generates an MDA warning
p66232
aVIf it matches then it can only be the Fortran code that overflows the stack
p66233
aVAlso keep in mind that you might be blaming the wrong function
p66234
aVThe function that generates the SOE might not be the one that screwed the stack up
p66235
aVLooking at the ESP value lets you quickly find the trouble-maker
p66236
as(dp66237
g9
V17034
p66238
stp66239
a((dp66240
g2
(lp66241
VThe PixelFormat of the image is critical
p66242
aVThe vast majority of machines today run their video adapter in 32bpp mode
p66243
aVThat makes the Format32bppPArgb more than 10 times faster than any other ones, including 32bppArgb and 24bppRgb
p66244
aVDo make sure to create the image in that format, convert it if necessary
p66245
aVAlso very crucial is that you draw the image with its original size
p66246
aVYou do so in the native code but not necessarily with the PictureBox
p66247
aVIt uses high quality interpolation on the image if it needs to resize the image
p66248
aVThat takes time
p66249
as(dp66250
g9
V17034
p66251
stp66252
a((dp66253
g2
(lp66254
VYes, opacity can only work on top-level windows
p66255
aVIt uses a hardware feature of the video adapter, that doesn't support child windows, like Panel
p66256
aVThe only top-level Control derived class in Winforms is Form
p66257
aVSeveral of the 'pure' Winform controls, the ones that do their own painting instead of letting a native Windows control do the job, do however support a transparent BackColor
p66258
aVPanel is one of them
p66259
aVIt uses a trick, it asks the Parent to draw itself to produce the background pixels
p66260
aVOne side-effect of this trick is that overlapping controls doesn't work, you only see the parent pixels, not the overlapped controls
p66261
aVThis sample form shows it at work:
p66262
aVIf that's not good enough then you need to consider stacking forms on top of each other
p66263
aVLike this
p66264
aVNotable perhaps is that this restriction is lifted in Windows 8
p66265
aVIt no longer uses the video adapter overlay feature and DWM (aka Aero) cannot be turned off anymore
p66266
aVWhich makes opacity/transparency on child windows easy to implement
p66267
aVRelying on this is of course future-music for a while to come
p66268
aVWindows 7 will be the next XP :)
p66269
as(dp66270
g9
V17034
p66271
stp66272
a((dp66273
g2
(lp66274
VGetting a WM_ACTIVATEAPP message is quite normal, part of the usual notifications that Windows sends
p66275
aVDon't assume that the first message you'll get is WM_COPYDATA, keep looking
p66276
aVIf you don't get it at all then the window handle that you used to send the message was wrong
p66277
aVWhich is a very common problem, it is not that easy to accurately find a window back
p66278
aVThe
p66279
aVNET framework already has very good support for single-instance apps that can retrieve the command line from a second instance
p66280
aVConsider using it instead
p66281
aVCheck this blog post
p66282
as(dp66283
g9
V17034
p66284
stp66285
a((dp66286
g2
(lp66287
VRe 1: physical addresses play no role, everything involved here is virtual memory
p66288
aVThe physical address is only established when a virtual memory page gets mapped into RAM, triggered by a page fault
p66289
aVMany basic DLLs appear at the same virtual memory address in several processes, like kernel32
p66290
aVdll
p66291
aVThe processes simply share the same pages of code (not data)
p66292
aVRe 2: no actual 'loading' takes place, the feature used is the same one that supports memory mapped files
p66293
aVThe backing of these pages is the DLL file itself, not the paging file
p66294
aVNothing gets loaded until a page fault forces Windows to read the page from the file into RAM
p66295
aVBut yes, the entire code section of the DLL gets mapped
p66296
aVRe 3: yes, that would work
p66297
aVBut it is next to impossible to make it work in practice since you will have to write replacement functions for all the user32 exports that your program uses
p66298
aVIncluding the ones that other Win32 functions use, you cannot know
p66299
aVAPI hooking is the typical technique used, Detours from Microsoft Labs is a good one
p66300
aVWindows Internals edition 5 is an excellent book to learn more about the plumbing
p66301
as(dp66302
g9
V17034
p66303
stp66304
a((dp66305
g2
(lp66306
VThere is no direct way to detect that the scrollbar became visible
p66307
aVAn indirect way though, write an event handler for the ClientSizeChanged event:
p66308
aVAlso change the DPI setting on your machine to verify that your tile size is still appropriate
p66309
aVThat normally changes the size of the controls
p66310
aVClientSize
p66311
aVWidth is your friend
p66312
as(dp66313
g9
V17034
p66314
stp66315
a((dp66316
g2
(lp66317
VThis has been turned on and off a few times in FxCop
p66318
aVIts current state is on again, at least for the version that comes with VS2010
p66319
aVIt generates CA2000 on this code:
p66320
aVWarning   5   CA2000 :
p66321
aVMicrosoft
p66322
aVReliability : In method
p66323
aV'Form1
p66324
aVOnPaint(PaintEventArgs)', call
p66325
aVSystem
p66326
aVIDisposable
p66327
aVDispose on object
p66328
aV'pen' before all references to it are
p66329
aVout of scope
p66330
aVBeware that the reliability of this warning isn't great, it is a difficult problem to solve
p66331
as(dp66332
g9
V17034
p66333
stp66334
a((dp66335
g2
(lp66336
VYes, changing the focus during a Validating event is quite troublesome
p66337
aVThe event is raised at the exact time the focus changes
p66338
aVThe next control has already obtained the focus as far as Windows is concerned but the logical form state still has the focus at the control being validated
p66339
aVWhen you set e
p66340
aVCancel to true, Winforms must undo the Windows focus state
p66341
aVWhen you don't, it must update the logical state after the event
p66342
aVThere are a wide variety of things that can go wrong when you change focus yourself
p66343
aVIt is important that you wait until the focus has been sorted out
p66344
aVBest thing to do is to delay your code until everything is done running and the form goes idle again
p66345
aVYou can cleanly do so by using the Control
p66346
aVBeginInvoke() method
p66347
aVSomething like this:
p66348
as(dp66349
g9
V17034
p66350
stp66351
a((dp66352
g2
(lp66353
VThe IAudioMeterInformation interface in Vista and up
p66354
aVThis is only easy to use in C++ code, there's no type library for the audio interfaces
p66355
aVMaybe you can google somebody that already wrapped this
p66356
as(dp66357
g9
V17034
p66358
stp66359
a((dp66360
g2
(lp66361
VLibrary writers don't have great options to point out that mixing and matching does not work
p66362
aVThey have to trigger linker errors, always tricky and confuzzling
p66363
aVWhat doesn't work here is that you cannot mix a library that uses the STL classes with iterator debugging enabled with code that has it disabled
p66364
aVPretty fundamental mismatch, those template class objects are not the same size
p66365
aVIf you really want to do this then you'll have to disable the diagnostics you get from the feature
p66366
aVThat requires building the debug version of your code with the _HAS_ITERATOR_DEBUGGING macro #defined to 0
p66367
aVAre you sure you want to do this
p66368
as(dp66369
g9
V17034
p66370
stp66371
a((dp66372
g2
(lp66373
VIt's a bit of a slamdunk
p66374
aVExitThreadCore is a protected method of the ApplicationContext class
p66375
aVYou cannot call it directly, other than calling ExitThread
p66376
aVUnless you override the class
p66377
aVNot so sure why you'd want to do that, you haven't given a good reason to do so
p66378
aVUse ApplicationContext
p66379
aVExitThread
p66380
aVOr Application
p66381
aVExitThread
p66382
aVOr just close you main window, it's all the same
p66383
as(dp66384
g9
V17034
p66385
stp66386
a((dp66387
g2
(lp66388
VThese are the kind of keys you'd find on the right-hand side of a keyboard
p66389
aVThere is no standard way in the C runtime to let a program recognize these keystrokes
p66390
aVSo there have been all kinds of non-standard extensions to fix this problem
p66391
aVOne scheme is to let getch() return 0 when such an extended key is pressed, the next getch() call then returns a key code for that extended key
p66392
aVThat key code could be the original keyboard scan code
p66393
aVAnything is possible, you'd have to know the original keyboard vendor and CRT supplier to have a clue
p66394
aVClearly it is ancient, proprietary keyboard interfaces was an excellent vendor lock-in strategy back in the neolithic days of computing
p66395
as(dp66396
g9
V17034
p66397
stp66398
a((dp66399
g2
(lp66400
VYou can only set the SelectedNode to null if the tree view doesn't have the focus
p66401
aVAs soon as it gets the focus back, the control is going to select the node again
p66402
aVFor example:
p66403
aVOutput:
p66404
aVokay
p66405
aVokay
p66406
aVThis is by design, the native TreeView control really likes having a selection
p66407
as(dp66408
g9
V17034
p66409
stp66410
a((dp66411
g2
(lp66412
VUnable to cast object of type 'SerializedMessage' to type 'SerializedMessage'
p66413
aVI'd focus on this problem for the core of your issue
p66414
aVThe real message should be "of type Foo
p66415
aVSerializedMessage to type Bar
p66416
aVSerializedMessage"
p66417
aVIn other words, there are two types involved here, from different assemblies
p66418
ag3471
aVNET type's identity is not just the class name, it also includes the fully qualified assembly name
p66419
aVWhich is the assembly display name and assembly version and culture
p66420
aVA DLL Hell counter-measure
p66421
aVCheck how your assemblies are built and verify that SerializedMessage only appears once in any of your assemblies
p66422
aVIt can also be caused by the way the assembly got loaded into the second AppDomain, using LoadFile() will cause it for example
p66423
aVIt loads assemblies without a loading context and any types loaded from such an assembly are not even compatible with the exact same type from the exact same assembly that was loaded normally
p66424
aVAnd you'd better stay away from GetFunctionPointerForDelegate(), unmanaged pointers don't observe AppDomain boundaries
p66425
aVAlbeit that I have no clue why you're using it
p66426
as(dp66427
g9
V17034
p66428
stp66429
a((dp66430
g2
(lp66431
VYou already calculated the required scaling, 800/600
p66432
aVDon't multiply by the image size
p66433
aVFix:
p66434
as(dp66435
g9
V17034
p66436
stp66437
a((dp66438
g2
(lp66439
VI'll assume this is a Winforms question, it is not a problem in WPF with the Keyboard class
p66440
aVKeeping track of the KeyDown and KeyUp events isn't reliable, you can miss a notification when your app gains or loses the focus with the key down
p66441
aVYou need a bit of pinvoke help:
p66442
as(dp66443
g9
V17034
p66444
stp66445
a((dp66446
g2
(lp66447
VThe typical approach here is a UserControl in which you put both the label and the text box
p66448
aVIt is painful though, you have to add a lot of the properties and events of the text box to the user control so it at least resembles a text box
p66449
aVUgly boilerplate code
p66450
aVAnother way to do it is to make a custom text box that sneaks in a label control on the parent
p66451
aVThat completely behaves like a TextBox without having to do any work
p66452
aVAdd a new class to your project and paste the code shown below
p66453
aVCompile
p66454
aVDrop the new control from the top of the toolbox onto your form
p66455
aVSet the Description property to the text you want to see appear in the label
p66456
as(dp66457
g9
V17034
p66458
stp66459
a((dp66460
g2
(lp66461
VFirst make sure you've got a solution with both projects
p66462
aVRight-click the C++ project, Properties, Configuration Properties, General
p66463
aVChange the Output Directory setting to
p66464
aV$(SolutionDir)bin\u005c$(ConfigurationName)
p66465
aVRepeat for the Release configuration (upper left combo)
p66466
aVThat ensures the C++ build is using the same folder naming strategy as the
p66467
aVNET build (bin\u005cDebug and bin\u005cRelease)
p66468
aVNow right-click the
p66469
aVNET project, Project Dependencies and tick the C++ project
p66470
aVThat ensures that the C++ project gets built first and that the build output gets copied to your
p66471
aVNET build folder
p66472
as(dp66473
g9
V17034
p66474
stp66475
a((dp66476
g2
(lp66477
VIt is a Windows error, facility code 7
p66478
aVThe last word gives the Windows error, 0x6be == 1726:
p66479
aVInterop with Office programs like Outlook happens through out-of-process COM
p66480
aVRPC is the low-level Remote Procedure Call mechanism
p66481
aVThere are several reasons for such a remote call to fail
p66482
aVBoth the error code and the error name google well
p66483
aVThe simplest explanation is just that Outlook fell over
p66484
aVThat happens
p66485
aVThe advantage of in-process interop is that when the host program crashes then it will take out your code as well
p66486
aVNot in an out-of-process scenario, you just get a hard to diagnose error
p66487
aVAsk your customer's IT staff to use their typical Office troubleshooting strategies
p66488
as(dp66489
g9
V17034
p66490
stp66491
a((dp66492
g2
(lp66493
VThere is no documented way to discover the layout of a managed struct
p66494
aVThe JIT compiler takes readily advantage of this, it will reorder fields of the struct to get the best packing
p66495
aVMarshaling is always required to get a predictable layout, as directed by the  attribute
p66496
aVYou have to jump through the  hoop
p66497
aVWhether you do it yourself or let the pinvoke marshaller do it for you
p66498
aVgives you the size of the marshaled
p66499
aVMore background on why it works this way is available in this answer
p66500
as(dp66501
g9
V17034
p66502
stp66503
a((dp66504
g2
(lp66505
VThe compiler goes out hunting for an operator+() that can take a null argument first
p66506
aVNone of the standard value types qualify, null is not a valid value for them
p66507
aVThe one and only match is System
p66508
aVString
p66509
aVoperator+(), there's no ambiguity
p66510
aVThe 2nd argument of that operator is also a string
p66511
aVThat goes kapooey, cannot implicitly convert bool to string
p66512
as(dp66513
g9
V17034
p66514
stp66515
a((dp66516
g2
(lp66517
VKaren Liu of the C# IDE team responded to this in a feedback report:
p66518
aVThanks for submitting this suggestion
p66519
aVThis is something we are aware of and
p66520
aVhad tried to do as a Design Change
p66521
aVRequest before
p66522
aVUltimately, based on
p66523
aVcost to implement this where we were
p66524
aVin the product cycle, we made the
p66525
aVtough decision that since references
p66526
aVwould be something you would need to
p66527
aVadd only once, this did not make it
p66528
aVinto VS2005
p66529
aVThis is something we are
p66530
aVlooking to do in the future though and
p66531
aVhearing feedback on this is valuable
p66532
aVOnly nine upvotes, not enough to make it a popular request
p66533
aVI'd recommend you vote it up, they do pay attention to that
p66534
as(dp66535
g9
V17034
p66536
stp66537
a((dp66538
g2
(lp66539
VLIB = lib
p66540
aVThat screws up the LIB environment variable
p66541
aVYes, /E will fix it but your next project that actually needs lib
p66542
aVexe is going to fail
p66543
aVPick another name, win32
p66544
aVmak uses "implib"
p66545
as(dp66546
g9
V17034
p66547
stp66548
a((dp66549
g2
(lp66550
VA "statically referenced dll" is an oxymoron, the d in dll means "dynamic"
p66551
aVThere are implicitly referenced dlls but only unmanaged code uses those
p66552
aVYou cannot start a program with such a DLL missing, the dll is loaded before the program's entrypoint starts executing
p66553
aVNET loads dlls on demand, triggered by the JIT compiler
p66554
aVAs soon as it compiles a method of a type that's stored in that DLL will the DLL be loaded
p66555
aVShipping code with such a DLL missing is technically possible, you have to be careful to write your code so that a type from such a DLL is never used
p66556
aVThis is the desktop version behavior, not quite sure if the CF version works the same way
p66557
as(dp66558
g9
V17034
p66559
stp66560
a((dp66561
g2
(lp66562
VYou can just create a borderless form, using its BackgroundImage to show the image
p66563
aVMake it as large as the secondary screen
p66564
aVLike this:
p66565
aVNote that it returns a Form object, call its Close() method to get rid of the image again
p66566
as(dp66567
g9
V17034
p66568
stp66569
a((dp66570
g2
(lp66571
VThe key ingredient is that an instance method of a class isn't fundamentally different from a static method
p66572
aVWith one small detail, they have a hidden argument
p66573
aVFor example, the String
p66574
aVIndexOf(char) method actually looks like this to the CLR:
p66575
aVThe thisRef argument is what supplies the string reference whenever you use this in your code or access a member of the class
p66576
aVAs you can see, it is a very small step from an extension method to an instance method
p66577
aVNo changes were necessary in the CLR to support the feature
p66578
aVOne other minor difference is that the compiler emits code that checks if this is null for an instance method but does not do so for an extension method
p66579
aVYou can call an extension method on a null object
p66580
aVWhile that might look like a feature, it is actually a restriction induced by the extension method not actually being a member of the class
p66581
aVInternally, the CLR keeps a list of methods for the class, the MethodTable
p66582
aVExtension methods are not in them, preventing the compiler from emitting the callvirt IL instruction, the 'trick' that it uses to get the cheap null check
p66583
aVExplicitly emitting code to make the null check would have been possible but they elected not to do so
p66584
aVNot quite sure why
p66585
aVAnother automatic consequence of this is that an extension method cannot be virtual
p66586
as(dp66587
g9
V17034
p66588
stp66589
a((dp66590
g2
(lp66591
VI repro, Win7 and VS2008
p66592
aVThat looks like a fairly nasty deadlock, you can get out of it by pressing Ctrl+Esc on the keyboard
p66593
aVBy default, SendKeys uses a windows hook to inject the keys
p66594
aVWindows hooks can have fairly unpleasant side effects but I wouldn't hesitate to call this a Windows bug
p66595
aVTo fix it, use Project + Add New Item and select the Application Configuration File item template
p66596
aVMake it look like this:
p66597
aVIf this is really meant to send a keystroke to your form then there are better ways to accomplish that
p66598
as(dp66599
g9
V17034
p66600
stp66601
a((dp66602
g2
(lp66603
VCreate a new project, not a new
p66604
aVcs file
p66605
aVFile + New + Project, Windows, Console Application
p66606
as(dp66607
g9
V17034
p66608
stp66609
a((dp66610
g2
(lp66611
VIt's mostly true
p66612
aVA very clever programmer named Lutz Roeder wrote an excellent decompiler named Reflector (now owned by redgate)
p66613
aVIt's quite good at translating IL back to either C# or VB
p66614
aVNET code
p66615
aVIt isn't complete magic, it cannot
p66616
aVtranslate constants back to their constant identifier
p66617
aVrecover the names of local variables
p66618
aVdecompile anonymous methods except in their intermediate form
p66619
aVdecompile iterators, as above
p66620
aVdecompile lambdas, as above
p66621
aVdecompile the code that uses the promised C# 5 async and await keywords, as above
p66622
aVrecover the comments in your code
p66623
aVAnd has a few bugs that makes it resort to goto statements or fall over
p66624
aVIt is otherwise very useful as a debugging aid, helping you discover and diagnose bugs in code you didn't write
p66625
aVThere are no documented cases of anyone using it to start a successful business from pirated source code obtained through decompilation
p66626
aVIt works too well for that
p66627
aVIt has otherwise started a lively market segment for 'obfuscators', tools that rewrite the contents of an assembly to make it hard to decompile it
p66628
aVTypical strategies are to rewrite identifiers so they become very hard to interpret and/or to tinker with the structure of the assembly so a decompiler will crash but the CLR will not
p66629
aVRedgate, the current owner of Reflector, also sells an obfuscator
p66630
aVThere is one included with Visual Studio paid licenses, called 'Dotfuscator Community Edition'
p66631
aVNo idea how good it is, this never gets put to the test
p66632
aVJust using lots of lambdas and iterators in your code is already an excellent way to obfuscate your code
p66633
aVReverse-engineering it to the original code is very difficult
p66634
aVI don't doubt that Lutz could do it, but he's pretty busy with other projects right now
p66635
aVMicrosoft hired him
p66636
as(dp66637
g9
V17034
p66638
stp66639
a((dp66640
g2
(lp66641
VYes, the Resources and Settings designers work the same way in a WPF app
p66642
aVThe
p66643
aVresx associated with a Form is however not usable
p66644
as(dp66645
g9
V17034
p66646
stp66647
a((dp66648
g2
(lp66649
VThe
p66650
aVNET Micro Framework was open-sourced not long ago
p66651
aVAs were IronPython and IronRuby
p66652
aVBeyond that it gets difficult
p66653
aVSSCLI20 was released 5 years ago but not as open source
p66654
aVIts Shared Source license allows it to be used to implement your own CLR, the Mono project took advantage of that
p66655
aVSelected portions of the framework source code are released under the Reference Source license
p66656
aVYou can look at it to assist in debugging but you can't modify it
p66657
as(dp66658
g9
V17034
p66659
stp66660
a((dp66661
g2
(lp66662
VIt is a fairly natural consequence of setting the value in the constructor
p66663
aVBy design, the constructor of a class initializes the object's initial state
p66664
aVNothing has changed just yet when you assign the property, there is no Changed event that should be raised
p66665
aVAs written, the event does actually get raised, there's just no opportunity for anybody to subscribe to the event yet
p66666
aVThis works by accident, what you really should do is assign the m_value member
p66667
aVSo if the form is curious about the default value of the property then it should just read it back
p66668
aVYou could also call the userControl11_ValueChanged() method directly for example to take advantage of its side-effects
p66669
aVIf you do want to always generate the event with good odds that a subscriber sees it then assign the property in the UserControl's OnLoad method override (or Load event)
p66670
as(dp66671
g9
V17034
p66672
stp66673
a((dp66674
g2
(lp66675
Vusing IRibbonExtensibility interface which is available from Addins only
p66676
aVWhich means that it won't work through Automation, the interface is not exposed in the out-of-process type library
p66677
aVYou'll have to use VSTO to write an add-in, use the C# + Office + Word 2007 Add-in project template to get started
p66678
as(dp66679
g9
V17034
p66680
stp66681
a((dp66682
g2
(lp66683
VThis has 'not checking return values' written all over it
p66684
aVPretty crucial in raw Win32 programming, most every API function returns a boolean or a handle where FALSE or NULL indicates failure
p66685
aVGetLastError() provides the error code
p66686
aVA cheap way to check for this without modifying code is by using the debugger to look at the EAX register value after the API call
p66687
aVA 0 indicates failure
p66688
aVIn Visual Studio you can do so by using the @eax and @err pseudo variables in the Watch window, respectively the function return value and the GetLastError value
p66689
aVThis goes bad once Windows starts failing API calls, probably because of a resource leak
p66690
aVYou can see it with TaskMgr
p66691
aVexe, Processes tab
p66692
aVView + Select Columns and tick Handles, USER objects and GDI objects
p66693
aVIt is usually the latter, restoring the device context and releasing drawing objects is very easy to fumble
p66694
aVYou don't have to wait until it fails, a steadily climbing number in one of those columns is the giveaway
p66695
aVIt goes belly-up when the value hits 10,000
p66696
as(dp66697
g9
V17034
p66698
stp66699
a((dp66700
g2
(lp66701
VIntelliSense support is a feature of the text editor you use
p66702
aVThere isn't anything in the
p66703
aVNET framework that would make it easier or harder to implement it
p66704
aVYou'll need to focus on what kind of editor you want to have available on the target machine and what kind of languages it supports
p66705
aVScintilla is a typical open source choice
p66706
as(dp66707
g9
V17034
p66708
stp66709
a((dp66710
g2
(lp66711
VFeature, not a bug
p66712
aVIt is a DLL Hell counter-measure
p66713
aVThe operative term is 'loading context', search Suzanne Cook's blog for the phrase to learn more about it
p66714
aVIn a nutshell, the CLR memorizes previous attempts to load an assembly
p66715
aVFirst and foremost, it records successful bindings and guarantees that the exact same assembly will be loaded again, even if the disk contents have changed
p66716
aVYou can no doubt see the benefit of that, suddenly getting another assembly is almost always disastrous
p66717
aVThe same is true for failed assembly binds
p66718
aVIt memorizes those as well, for much the same reason, it will fail them in the future
p66719
aVThere is no documented way to reset the loading context that I know of
p66720
aVAssembly
p66721
aVLoadFile() loads assemblies without a loading context
p66722
aVBut that causes a whole range of other problems, you really don't want to use it
p66723
as(dp66724
g9
V17034
p66725
stp66726
a((dp66727
g2
(lp66728
VYou can use the form's Controls
p66729
aVFind() method to retrieve a reference back:
p66730
aVBeware that this returns an array, the Name property of a control can be ambiguous, there is no mechanism that ensures that a control has a unique name
p66731
aVYou'll have to enforce that yourself
p66732
as(dp66733
g9
V17034
p66734
stp66735
a((dp66736
g2
(lp66737
VThis was fixed in
p66738
aVNET 4
p66739
aV0, the TimeSpan struct acquired a ToString() overload that lets you specify a format string
p66740
aVIf you cannot upgrade then you might consider this extension method:
p66741
aVSample usage:
p66742
aVProduces 1:02:03
p66743
as(dp66744
g9
V17034
p66745
stp66746
a((dp66747
g2
(lp66748
VYes, you can catch the WM_CHAR message by overriding WndProc():
p66749
aVBeware that you've also got a problem with the clipboard (Ctrl+V)
p66750
aVThat's message WM_PASTE, 0x302
p66751
aVA possible workaround is:
p66752
as(dp66753
g9
V17034
p66754
stp66755
a((dp66756
g2
(lp66757
VThe native Windows control doesn't produce a notification for this
p66758
aVTrying to work around this restriction is a recipe for pain, you just can't tell where the caret is located
p66759
aVThe SelectionStart property is not a reliable indicator, the caret can appear at either end of the selection, depending in what direction the user selected text
p66760
aVPinvoking GetCaretPos() gives the caret position when the control has the focus, but mapping that back to a character index is not so easy due to inaccuracies in TextRenderer
p66761
aVMeasureText()
p66762
aVDon't go there
p66763
aVInstead, explain why you think you need this
p66764
as(dp66765
g9
V17034
p66766
stp66767
a((dp66768
g2
(lp66769
VYes, the array gets marshaled as a SAFEARRAY
p66770
aVNot crashing the pinvoke marshaller is pretty unusual
p66771
aVDeclare the Data member as IntPtr, then use Marshal
p66772
aVCopy() to copy the data
p66773
aVBeware that this would be hard to use in C as well
p66774
aVThere's a memory management problem, it isn't clear who owns the array
p66775
aVMost typically, the C function would use malloc() to allocate the array
p66776
aVThat's a big problem, you cannot release that array in C#, no way to call free()
p66777
aVYou'll have an unpluggable memory leak
p66778
aVIf you can't rewrite the C code then you'll need to write a wrapper in the C++/CLI language so that you can call free()
p66779
aVEven that is tricky if the C dll doesn't use the same CRT as the C++/CLI code
p66780
aVYou have to compile the C code with the /MD option
p66781
as(dp66782
g9
V17034
p66783
stp66784
a((dp66785
g2
(lp66786
VJust for the record, this is possible
p66787
aVYou can turn a Form into a child control by setting its TopLevel property to false
p66788
aVLike this:
p66789
aVA user control has less overhead
p66790
as(dp66791
g9
V17034
p66792
stp66793
a((dp66794
g2
(lp66795
VThe Minimize command has a very well defined meaning to a user, it shouldn't be messed with
p66796
aVWinforms accordingly doesn't have an event for it
p66797
aVBut not a real problem, you can detect any Windows message by overriding WndProc()
p66798
aVLike tihs:
p66799
as(dp66800
g9
V17034
p66801
stp66802
a((dp66803
g2
(lp66804
VBlatantly copied from this blog post, 3rd google hit:
p66805
as(dp66806
g9
V17034
p66807
stp66808
a((dp66809
g2
(lp66810
VIt is a heavy platform implementation detail
p66811
aVIn general, the exception plumbing is somewhat likely to be able to unwind the stack through C function activation frames
p66812
aVNecessary because the CRT is often written in C
p66813
aVHowever, the C code is pretty unlikely to be happy about it, state got mutated that cannot be restored
p66814
aVJust in case this is Windows, the C code does have a shot at it
p66815
aVC++ exceptions are piggy-backed onto the generic exception support built into Windows, called Structured Exception Handling (SEH)
p66816
aVYou use the __try and __except keywords to call an exception filter that can restore the C code state
p66817
aVObviously this is not portable
p66818
aVNever ask an implementation detail question without mentioning the implementation details, please
p66819
as(dp66820
g9
V17034
p66821
stp66822
a((dp66823
g2
(lp66824
VToolTip
p66825
aVSetToolTip uses the TTM_SETTOOLINFO message to update the tool tip
p66826
aVThe SDK docs for this message contain this phrase:
p66827
aVWhen calling TTM_SETTOOLINFO, the
p66828
aVstring pointed to by the lpszText
p66829
aVmember of the TOOLINFO structure must
p66830
aVnot exceed 80 TCHARs in length,
p66831
aVincluding the terminating NULL
p66832
aVWhich is an expensive way of saying that the updated tip text cannot be longer than 80 characters
p66833
aVThis limit has been expanded in later versions of Windows, you didn't say which one you are using
p66834
aVIn general, you really want to avoid displaying lots of text in a tip
p66835
aVIt isn't visible long enough to allow the user to read the novella
p66836
aVConsider implementing F1 help as an alternative
p66837
as(dp66838
g9
V17034
p66839
stp66840
a((dp66841
g2
(lp66842
VIt isn't required
p66843
aVIt is an optimization, a hint to the compiler that the DLL is going to export the function pointer directly rather than just an entry in the IAT of the DLL
p66844
aVThe exported function pointer for a function named foo() will be __imp_foo
p66845
aVWhich allows it to generate better code, saving a function pointer load from the IAT and an indirect jump
p66846
aVIt is a time optimization, not space
p66847
aVThis blog post has the details
p66848
as(dp66849
g9
V17034
p66850
stp66851
a((dp66852
g2
(lp66853
VTrying to reason this out within the
p66854
aVNET type system doesn't get you very far
p66855
aVThere is core support built into the JIT compiler and the CLR to deal with creating arrays
p66856
aVA statement like this:
p66857
aVGenerates this IL:
p66858
aVWhich the JIT compiler then translate into this machine code:
p66859
aVCore ingredients here are the dedicated IL opcode, newarr, instead of the usual newobj opcode that creates an instance of a class
p66860
aVAnd the simple translation to a CLR helper function that actually gets the object created
p66861
aVYou can have a look-see at this helper function with the SSCLI20 source code,
p66862
aVToo large to post here, but it is heavily optimized to make this kind of code run as fast possible, having direct access to the type internals available to CLR code
p66863
aVThere are two of these helpers available, JIT_NewArr1() creates one-dimensional (vector) arrays and JIT_NewMDArr() creates multi-dimensional arrays
p66864
aVCompare to the two overloads available for Type
p66865
aVMakeArrayType()
p66866
as(dp66867
g9
V17034
p66868
stp66869
a((dp66870
g2
(lp66871
VThis is a crucial difference between value types and reference types
p66872
aVAutoScrollOffset is of type Point, a struct which makes it a value type
p66873
aVWhen you use the property getter, you get a copy of the value
p66874
aVSetting the Y property only sets the property on the copy
p66875
aVThe C# compiler can recognize this particular usage problem
p66876
aVBut not this one:
p66877
aVTo make it work if you have to assign the property with a value of type Point:
p66878
aVWhich does not actually work to scroll the listbox, it will only affect the position of the control when it is embedded in a scrollable container, like Panel
p66879
aVCheck ScrollControlIntoView for reference
p66880
aVAssign the TopIndex property instead
p66881
as(dp66882
g9
V17034
p66883
stp66884
a((dp66885
g2
(lp66886
VThe amount of RAM has nothing to do with the amount of memory available to a
p66887
aVNET program
p66888
aVAll modern operating systems provide virtual memory
p66889
aVOn Windows, the typical amount of virtual memory available to a program is a bit less than 2 gigabytes
p66890
aVThere's a special boot option (/3GB) that increases that to 3 gigabytes, at a cost of taking addressable memory away from the operating system
p66891
aVIt doesn't work anymore on most modern machines, the video card tends to eat up too much addressable physical memory
p66892
aVIt isn't impossible to actually get less than 2GB because of this
p66893
aVIf the machine runs a 64-bit operating system then you'll get close to 4 gigabytes if the code runs in x86 mode
p66894
aVAnd oodles of virtual memory in x64 mode, limited only by the maximum size of the paging file
p66895
aVThese virtual memory sizes are completely independent of the actual amount of RAM installed on the machine
p66896
aVIf you have less RAM than addressable virtual memory space, very common 15 years ago, then it is possible to invoke so-called 'paging file thrashing'
p66897
aVYou see the operating system trying to provide enough available RAM to honor the program's need to use too much virtual memory at the same time
p66898
aVIt swaps data between RAM and the paging file
p66899
aVThat can severely slow down the machine, you run out of patience before you run out of memory
p66900
aVAn OutOfMemoryException tells you that the program ran out of addressable virtual memory
p66901
aVThe most typical cause is not actually completely depleting all address space, it is running out of holes big enough to fit the object you're trying to allocate
p66902
aVVirtual memory can become fragmented
p66903
aVThe SysInterals' VMMap utility can give you insight in how the virtual memory of your program is divvied-up
p66904
aVRunning out of virtual memory is quite difficult to deal with, it is essentially an asynchronous exception that you cannot recover from
p66905
aVWith the exception of doing something like loading a bitmap, the kind of object that requires lots of (unmanaged) memory and therefore almost always has trouble with finding a large enough hole
p66906
aVIn general, your program should never get any closer than using up half of the available space
p66907
aVThat's not usually difficult, a gigabyte is a lot of memory
p66908
aVWhen your program's needs are fundamentally beyond that limit then you must specify a 64-bit operating system requirement for your program
p66909
aVA two hundred dollar solution
p66910
as(dp66911
g9
V17034
p66912
stp66913
a((dp66914
g2
(lp66915
VExplaining this problem away by UIPI is a very long stretch
p66916
aVIt doesn't have anything to do with whether or not the user is logged-in as an admin, that doesn't affect UAC and your program will be running with that same account anyway
p66917
aVThe only way UIPI could kick in to stop a D+D is when your program is elevated and Excel is not
p66918
aVTo get yourself elevated requires work and doesn't happen by accident
p66919
aVYou'd have to include a manifest so that the user gets the UAC prompt, you'd know about that
p66920
aVOr the user would have to change the desktop shortcut and tick the "Run this program as an administrator" option, she's know about that
p66921
aVWhile UIPI can be bypassed for Windows messages (ChangeWindowMessageFilter), it cannot for Drag and Drop so if any elevation is going on then your stuck
p66922
aVThe ultimate test is to simply ask the user to put the UAC slider all the way down
p66923
aVThe much more likely scenario is that your DragEnter event handler simply isn't happy with the data it sees and therefore doesn't assign the e
p66924
aVEffect property
p66925
aVIf you can't get a debugger on-site then write a little test program that logs the values of e
p66926
aVData
p66927
aVGetFormats() plus whatever else you use to check if the drop is acceptable
p66928
aVAnd don't forget the obvious: the user simply fumbling the drag somehow
p66929
as(dp66930
g9
V17034
p66931
stp66932
a((dp66933
g2
(lp66934
VThe closest equivalent is the Form
p66935
aVPaint event
p66936
aVIt isn't exactly a very good match, each control in Winforms gets its own event
p66937
aVA fundamental difference between WPF and Winforms
p66938
aVA child control may need to paint itself (compare Control
p66939
aVInvalidate) without the parent ever getting the event
p66940
as(dp66941
g9
V17034
p66942
stp66943
a((dp66944
g2
(lp66945
s(dp66946
g9
V17034
p66947
stp66948
a((dp66949
g2
(lp66950
VNo, not really
p66951
aVThis kind of button background is drawn by VisualStyleRenderer
p66952
aVDrawBackground()
p66953
aVWhich in turns pinvokes DrawThemeBackground()
p66954
aVThese methods don't take a color
p66955
aVNone is needed because the color is already specified in the theme
p66956
aVSimulating the appearance with a LinearGradientBrush is your only real hope
p66957
aVNote that custom drawing a button is quite difficult, all the code is internal and no owner-draw is provided
p66958
aVConsider using an image
p66959
as(dp66960
g9
V17034
p66961
stp66962
a((dp66963
g2
(lp66964
VSystem
p66965
aVEventHandler
p66966
aVInvoke(Object sender, EventArgs e)
p66967
aVThat was the PropertyChanged(this, e) call
p66968
aVIt isn't the cause of the exception, your stack trace went well beyond this
p66969
aVUnfortunately into code you didn't write, it's part of the Winforms binding plumbing
p66970
aVSomething is screwed up with the binding
p66971
as(dp66972
g9
V17034
p66973
stp66974
a((dp66975
g2
(lp66976
VSomebody is calling Thread
p66977
aVAbort()
p66978
aVThat could be the CLR, trying to shut your program down because of an unhandled exception
p66979
aVThe reason you might see the ThreadAbortException instead of the real exception is because you are using a COM server (like Excel) in a thread that isn't a single threaded apartment
p66980
aVCheck the docs for Thread
p66981
aVSetApartmentState()
p66982
aVThreadpool threads like the ones that FileSystemWatcher uses to raise events cannot be STA
p66983
aVAlso check the Output window for debugger notifications and use Debug + Exceptions, Thrown box to make the debugger stop on the first exception
p66984
as(dp66985
g9
V17034
p66986
stp66987
a((dp66988
g2
(lp66989
VCOM is quite agnostic about how you allocate your own COM objects
p66990
aVThey get created by the class factory and your IUnknown::AddRef and Release methods keep the reference count
p66991
aVUsing operator new in the class factory and  in Release is fine
p66992
aVYou do have to be careful about any pointers you return in your interface methods
p66993
aVTypical Automation objects like BSTR and SAFEARRAY do indeed need to be allocated in the COM heap so that the client code can release them
p66994
aVPretty hard to mess that up, the API does the work
p66995
aVThe client code can be responsible for the leak, fumbling the reference count is a pretty standard COM bug
p66996
aVUsually easy to diagnose when you have access to the AddRef/Release implementations
p66997
aVDebugging this in Vista or Win7 is also strongly recommended, they have a much better heap manager that doesn't silently ignore attempts to free memory from the wrong heap
p66998
aVIf you're pretty sure it is the COM server that leaks then isolate the problem with the  header and unit tests to exercise the interface methods
p66999
as(dp67000
g9
V17034
p67001
stp67002
a((dp67003
g2
(lp67004
VDo make sure that you have the application framework option turned off and Sub Main selected as the starting method
p67005
aVMake it look similar to this:
p67006
as(dp67007
g9
V17034
p67008
stp67009
a((dp67010
g2
(lp67011
VDo try to avoid controlling this directly, it just doesn't work really well
p67012
aVSet the TextBox
p67013
aVSelectionStart property to ensure the caret is the line you want to make visible
p67014
aVThen call ScrollToCaret
p67015
aVThe control must have the focus to make this work
p67016
aVYour user won't have any trouble finding it back
p67017
aVTextBox is a wrapper for the grand-daddy of controls, it's 23 years old already, older than many SO users I reckon
p67018
aVBack when 640 KB was enough for everybody and Window 2
p67019
aV0 had to run on a 386SUX or less
p67020
aVThe WPF version has more whistles
p67021
as(dp67022
g9
V17034
p67023
stp67024
a((dp67025
g2
(lp67026
VLook back toward the beginning of the source code file, inside InitializeComponent()
p67027
aVYou should have no trouble seeing the button1->Click event handler assignment
p67028
aVDo you see the one for button2->Click
p67029
aVDelete the button in the designer, add it back
p67030
aVDouble click it
p67031
aVOr just leave it out, no point in having two buttons doing the same thing
p67032
as(dp67033
g9
V17034
p67034
stp67035
a((dp67036
g2
(lp67037
VThis is built-in to Windows, it is called 'mouse capture', SetCapture(hWnd)
p67038
aVIt ensures you get mouse messages even though the mouse has moved outside of the window
p67039
aVYou call it on the WM_LBUTTONDOWN message notification
p67040
as(dp67041
g9
V17034
p67042
stp67043
a((dp67044
g2
(lp67045
VCORE_RL_Magick++_
p67046
aVlib does contain
p67047
aVInitializeMagick@Magick@@YAXPEBD@Z, but not
p67048
aVInitializeMagick@Magick@@YAXPBD@Z
p67049
aVUsing the undname
p67050
aVexe utility, these names undecorate to:
p67051
aVNote the __ptr64 declarator you got on the argument
p67052
aVYou've got some kind of compile setting that turns that char* into a 64-bit pointer
p67053
aVLike compiling this code targeting a 64-bit operating system
p67054
aVBut linking the 32-bit
p67055
aVlib
p67056
aVThis normally generates a linker error about the bit-ness of the
p67057
aVlib being wrong, not so sure why you don't see this
p67058
aVMaybe a mingw artifact, not sure how it works
p67059
as(dp67060
g9
V17034
p67061
stp67062
a((dp67063
g2
(lp67064
VDebug + Exceptions, click the Add Button
p67065
aVSet the type to "Common Language Runtime Exceptions" and the Name to the full name of the custom exception, including the namespace name
p67066
aVYou can now untick the Thrown box for this one, expand the node first if necessary
p67067
as(dp67068
g9
V17034
p67069
stp67070
a((dp67071
g2
(lp67072
VAssigning an object reference is atomic in
p67073
aVNET
p67074
aVThat isn't very likely to help you, some thread might be loading that global variable multiple times while using the object
p67075
aVWorking with one version of it, then getting another isn't that likely to come to a good end
p67076
aVYou can't call it immutable anymore
p67077
aVOr for that matter loading the global variable and it getting stale while the thread is using it
p67078
aVIf you really need to update that object reference then you need to work out a locking strategy so that all threads are aware of it
p67079
aVAlways hard to do with global variables
p67080
as(dp67081
g9
V17034
p67082
stp67083
a((dp67084
g2
(lp67085
VTry to replicate the ddeexec keys that you'll find under, say,
p67086
aVThe VisualStudio
p67087
aVmk
p67088
aV10
p67089
aV0 progid is missing them
p67090
as(dp67091
g9
V17034
p67092
stp67093
a((dp67094
g2
(lp67095
Vc:\u005clogger
p67096
aVexe /clog "%1"
p67097
aVThe %1 is the place holder for the selected file, double quotes to ensure that path names with spaces don't cause trouble
p67098
as(dp67099
g9
V17034
p67100
stp67101
a((dp67102
g2
(lp67103
VThis used to be supported through a feature called OLE Embedding
p67104
aVSupport for it has been disappearing from Microsoft software and tools over the past 10 years
p67105
aVNotably
p67106
aVNET has no support for it whatsoever
p67107
aVOffice was one of the last hold-outs with 2007 already getting pretty cranky about it
p67108
aVBut this indeed looks to be completely gonzo in the 2010 edition
p67109
aVAll download links to the DSOFramer control, a generic ActiveX embedding control were removed around the time that 2010 went into beta
p67110
aVThere's no future here, look at VSTO for the road ahead
p67111
as(dp67112
g9
V17034
p67113
stp67114
a((dp67115
g2
(lp67116
VThis is going to require another form that you display on top of the existing one
p67117
aVIts Opacity property can create the intended effect
p67118
aVAdd a new class to your project and paste the code shown below
p67119
aVCall the Close() method to remove the effect again
p67120
as(dp67121
g9
V17034
p67122
stp67123
a((dp67124
g2
(lp67125
VExcel cannot terminate until all its out-of-process objects are released
p67126
aVSo it just hides its user interface and keeps running
p67127
aVUntil either your program quits or you null all your Excel object references and the finalizer thread runs
p67128
aVQuitting your program would be an obvious solution
p67129
aVOr you can force the finalizer thread to run with:
p67130
aVReleaseComObject() rarely works because it is so easy to forget an intermediary COM object reference
p67131
aVLike WorkBooks[index], that's an enumerator you don't see
p67132
aVLetting the GC make that decision for itself would be the wiser choice, if you keep running and doing work then that will happen
p67133
as(dp67134
g9
V17034
p67135
stp67136
a((dp67137
g2
(lp67138
VUse Tools + Attach to Process to attach the debugger to the hung process
p67139
aVDebug + Break All
p67140
aVDebug + Windows + Threads, double-click the Main thread and look at its call stack to see what it is doing
p67141
aVPost the stack trace in your question if that doesn't help
p67142
as(dp67143
g9
V17034
p67144
stp67145
a((dp67146
g2
(lp67147
VGetting read access to a file that's already opened elsewhere isn't usually difficult
p67148
aVMost code would open a file for reading with FileShare
p67149
aVRead, allowing somebody else to read the file as well
p67150
aVStreamReader does so for example
p67151
aVGetting write access is an entirely different ball of wax
p67152
aVThat same FileShare
p67153
aVRead does not include FileShare
p67154
aVWrite, allowing you to write the file while somebody else is reading it
p67155
aVThat's very troublesome, you're jerking the mat out from under that somebody else, suddenly providing entirely different data
p67156
aVAll you have to do is find out who that 'somebody else' might be
p67157
aVSysInternals' Handles utility can tell you
p67158
aVHopefully it is your own program, you could do something about that
p67159
as(dp67160
g9
V17034
p67161
stp67162
a((dp67163
g2
(lp67164
VAnchoring the buttons to the bottom of the form smells like a solution
p67165
aVIf not, you can throw more panels at the problem but that's fugly
p67166
aVSimply using the Resize event can do wonders:
p67167
as(dp67168
g9
V17034
p67169
stp67170
a((dp67171
g2
(lp67172
VThat cannot work, you must use Show() to get the Deactivate event to fire
p67173
aVA dialog disables all of the other windows to make itself modal
p67174
aVSo there's nothing that can be clicked on outside of the dialog window with the parent maximized
p67175
aVAccordingly, the Deactivate event isn't going to fire
p67176
aVWhen you use the Show(owner) method instead, this side-effect of ShowDialog() no longer gets in the way and Deactivate is fine
p67177
aVUse the FormClosing/Closed event to do what you would do after a ShowDialog() call
p67178
aVThe way this is normally done, with a context menu strip or menu dropdown for example, is by capturing the mouse, Control
p67179
aVCapture property
p67180
aVSo that you can detect mouse events even outside of the window
p67181
aVBut that can't work reliably with forms, the controls inside the form will use the Capture property for their own use
p67182
aVSo stick with Show and Deactivate
p67183
as(dp67184
g9
V17034
p67185
stp67186
a((dp67187
g2
(lp67188
VIt is LoadIcon, not LoadIconW, this compiles by accident
p67189
aVThe MFC method uses the LoadIcon() API function
p67190
aVFrom the SDK documentation:
p67191
aVLoadIcon can only load an icon whose
p67192
aVsize conforms to the SM_CXICON and
p67193
aVSM_CYICON system metric values
p67194
aVUse
p67195
aVthe LoadImage function to load icons
p67196
aVof other sizes
p67197
aVUse LoadImage() instead so you can pass an appropriate size
p67198
aVMake two calls to retrieve a large and a small version
p67199
aVOr store the small icon image in another icon with another resource ID
p67200
as(dp67201
g9
V17034
p67202
stp67203
a((dp67204
g2
(lp67205
V controls the alignment of members of a structure
p67206
aVThe common default setting is 8, ensuring that members that are up to 8 bytes long get aligned on an address that's a multiple of their size
p67207
aVA double or 64-bit pointer for example
p67208
aVReading or writing a mis-aligned double can be quite expensive, typically three times slower if it straddles a CPU cache line boundary
p67209
aVThis alignment can produce unused space between members, called padding
p67210
aVThis kind of alignment is often inappropriate for network frames, they tend to be tightly packed without any padding, #pragma pack(push, 1)
p67211
as(dp67212
g9
V17034
p67213
stp67214
a((dp67215
g2
(lp67216
Vboth methods have a precision of milliseconds
p67217
aVThey don't
p67218
aVThey have a resolution of a millisecond, the precision is far worse
p67219
aVMost machines increment the value only at intervals of 15
p67220
aV625 msec
p67221
aVThat's a heckofalot of CPU cycles, usually not good enough to get any reliable indicator of code efficiency
p67222
aVQPF does much better, no idea why you couldn't use it
p67223
aVA profiler is a the standard tool to measure code efficiency
p67224
aVBeats taking dependencies you don't want
p67225
as(dp67226
g9
V17034
p67227
stp67228
a((dp67229
g2
(lp67230
VClick Yes
p67231
aVIt is trying to be helpful and show you what unhandled exception is bombing your program
p67232
aVWhether that will provide a quick solution is unguessable
p67233
as(dp67234
g9
V17034
p67235
stp67236
a((dp67237
g2
(lp67238
VYou forgot to make the class public
p67239
as(dp67240
g9
V17034
p67241
stp67242
a((dp67243
g2
(lp67244
VYou can go from a char* to a BSTR with SysAllocStringByteLen()
p67245
aVBut this is only safe if the char* contains only ASCII characters, no character conversion takes place
p67246
aVThis not causing problems would be pretty rare
p67247
aVNext hop is MultiByteToWideChar(), you typically want to set the CodePage argument to CP_ACP unless you know that the string is encoded another way
p67248
aVThat produces a wide string which you can then pass to SysAllocString() to get the BSTR
p67249
aVThe other way around is WideCharToMultiByte(), passing the BSTR directly will work unless it contains embedded 0 chars
p67250
aVThe conversion is lossy anyway however, beware the considerable headache this can cause when you work with strings that contain accented characters or anything else that cannot be represented in the code page you use
p67251
as(dp67252
g9
V17034
p67253
stp67254
a((dp67255
g2
(lp67256
VYou are running afoul of COM trying to protect an object model that isn't thread-safe
p67257
aVSuch complicated object models, like the Visual Studio automation interface never are
p67258
aVCOM tries to do so by automatically marshaling a call made on a background thread to the STA thread
p67259
aVThis is done through a proxy, a replica of the original COM interface that has all the same methods but marshal any calls made on them to an interface that runs the methods on the STA thread
p67260
aVThis proxy has thread affinity, it can only be used on the thread that created it
p67261
aVDTE2 is your problem here
p67262
aVIf any extensibility code ran before and created the DTE2 interface instance then DTE2 will be the 'real' interface pointer, not a proxy
p67263
aVIf you then use it on a worker thread, like the one that Timer creates for its Elapsed event then you get the bomb
p67264
aVIt works the other way around too, if DTE2 is first created by your code then you'll bomb any extensibility code that runs the normal way
p67265
aVMaybe DTE2
p67266
aVDTE will fix your problem, not sure
p67267
aVUltimately it doesn't fix anything, the code is always going to run on the Visual Studio STA thread anyway
p67268
aVJust don't use a System
p67269
aVTimer
p67270
aVTimer, use a synchronous timer like System
p67271
aVWindows
p67272
aVForms
p67273
aVTimer
p67274
as(dp67275
g9
V17034
p67276
stp67277
a((dp67278
g2
(lp67279
VThe UpdateWindow() function can only complete until the thread that owns the window has dispatched the WM_PAINT event
p67280
aVThat cannot happen here, the UI thread is blocked in the WaitForSingleObject call
p67281
aVThat call can never complete, the thread is blocked on UpdateWindow
p67282
aVDeadlock
p67283
aVThis kind of code is going to eat you alive if you don't observe the stone cold hard rules of threading with a user interface
p67284
aVNeither user32 nor gdi are thread-safe
p67285
aVThe UI thread can never block without pumping messages
p67286
aVYou have to use MsgWaitForMultipleObjectsEx()
p67287
aVA worker thread should never directly use any API functions that affect a window
p67288
aVOnly the system messages are automatically marshaled, use PostMessage() instead so that the UI thread can do the updates
p67289
as(dp67290
g9
V17034
p67291
stp67292
a((dp67293
g2
(lp67294
VYou can make this automatic in Visual Studio so that the user of your DLL can't forget this
p67295
aVThe typical DLL header file could look like this:
p67296
aVThe #pragma directive injects a linker option into the
p67297
aVobj file that ensures the linker always looks for the
p67298
aVlib when a client program #includes the header file
p67299
aVThis is the same mechanism by which it always looks for the correct version of the CRT
p67300
aVlib file even though you never explicitly mention it on the Additional Dependencies setting
p67301
aVThis is otherwise non-standard, but using DLLs is non-standard anyway
p67302
as(dp67303
g9
V17034
p67304
stp67305
a((dp67306
g2
(lp67307
VSelect the reference in the References node and check its Copy Local property in the Properties window
p67308
aVShould be True
p67309
aVDo check the build order and ensure B is always built before A
p67310
aVShould be automatic but you can enforce it by right-clicking A, Project Dependencies
p67311
aVThere is otherwise no mechanism by which the build system is aware that the assembly was built with another compiler, it's just a DLL
p67312
as(dp67313
g9
V17034
p67314
stp67315
a((dp67316
g2
(lp67317
VCOM, the grandfather of
p67318
aVNET, does something that
p67319
aVNET doesn't do
p67320
aVYou can write a
p67321
aVNET program that use a List<> in a thread and if you don't lock properly it will fail miserably without a diagnostic
p67322
aVCOM however is aware of the threading requirements of a COM component
p67323
aVAnd if the component says it is not thread-safe then you can't ignore that
p67324
aVWhich is what the error message means, it can only be used in a 'single-threaded apartment', STA
p67325
aVAn STA thread has the plumbing to automatically marshal a call made on the component from a worker thread to the thread that created the component
p67326
aVQuite similar to Control
p67327
aVInvoke(), but done automatically
p67328
aVThat limits your options to use it in a multi-threaded way severely
p67329
aVOther than keeping this running on the UI thread of a GUI app, the only other thing you can do is create an STA thread in which you create both the IE and watin instances
p67330
aVThis answer shows you how
p67331
aVNote that BackgroundWorker cannot do this, its DoWork method always runs on an MTA thread
p67332
aVKey parts of the linked code is Thread
p67333
aVSetApartmentState to switch the thread to STA and the message loop started by Application
p67334
aVRun()
p67335
aVBoth are required to let these COM components function correctly
p67336
as(dp67337
g9
V17034
p67338
stp67339
a((dp67340
g2
(lp67341
VPretty typical Infragistics lossage
p67342
aVThis can happen in general when any code is executed by the constructor that requires the Handle property to be valid
p67343
aVThat causes the CreateHandle method to run, which in turn gets the Load event triggered
p67344
aVYou didn't post a stack trace so there's no way to see what kind of code causes this to happen
p67345
aVI don't doubt it's Infragistics code
p67346
aVGet their latest updates, post to their support forum if you want their support
p67347
aVAnd try to move code from your Load event handler to the constructor, you only ever need Load if you have code that requires the form size to be known
p67348
as(dp67349
g9
V17034
p67350
stp67351
a((dp67352
g2
(lp67353
VYou very likely need to look at the other end of the wire for the source of the exception
p67354
aVDon't forget, you're using Soap
p67355
aVThe SoapMessage
p67356
aVException property gets thrown inside SoapHttpClientProtocol
p67357
aVReadResponse() when it is not null
p67358
aVThe exception text hints at a so-called Soft Stack Overflow
p67359
aVWindows exception code 0xe053534f (googles well), thrown when interop code discovers there is not enough stack space left to run a function without causing a hard stack overflow
p67360
as(dp67361
g9
V17034
p67362
stp67363
a((dp67364
g2
(lp67365
VIt's a pretty silly warning and ultimately unproductive
p67366
aVBut keeping it happy is simple, just add a static class to your project named NativeMethods and put the [DllImport] declarations inside it
p67367
aVNo need for separate classes
p67368
aVDeclare them internal
p67369
aVBeware that you cannot call these functions on an emulator, testing them is going to require running it on the device itself
p67370
aVTo keep your program debuggable in the emulator be sure to wrap the code that calls them with #ifdef DEBUG
p67371
as(dp67372
g9
V17034
p67373
stp67374
a((dp67375
g2
(lp67376
VFirst off, you really need to do this with a Validating event handler so that you can catch junk and avoid ignoring the return value of TryParse
p67377
aVLike this:
p67378
aVExplaining -1 is difficult
p67379
aVTryParse normally writes 0 if it cannot parse the text
p67380
aVWatch out for changing the UI thread's CurrentCulture property
p67381
aVAnd any changes made to the format settings in Control Panel + Region and Language applet
p67382
as(dp67383
g9
V17034
p67384
stp67385
a((dp67386
g2
(lp67387
VA very effective way to stop
p67388
aVNET from telling you what you did wrong
p67389
aVNot knowing why it doesn't work is however the inevitable outcome
p67390
aVDelete that
p67391
as(dp67392
g9
V17034
p67393
stp67394
a((dp67395
g2
(lp67396
VUse the BackgroundWorker class
p67397
aVIt takes care of all this
p67398
aVNote the ReportProgress event
p67399
as(dp67400
g9
V17034
p67401
stp67402
a((dp67403
g2
(lp67404
VNot really
p67405
aVAny language has the ultimate burden of having to be able to run on commodity hardware to be successful
p67406
aVThe CTS is a pretty good model for types that can be efficiently handled on current hardware
p67407
aVWhat may be needed is a big chunk of runtime support to adapt between the language's type system and the CLI's
p67408
aVA classic example is the DLR, the runtime support system for dynamic languages like Python and Ruby
p67409
aVIt essentially does what such a language interpreter must do as well, it has comparable perf
p67410
aVNo tricks btw, everything is pure C# code
p67411
aVSuch a runtime support library may get slow when the language has features that are not available at all
p67412
aVMultiple inheritance for example
p67413
aVIt is natively 'supported' by the CLR and JIT compiler
p67414
aVYou can take about any standard compliant C++ program that uses MI, run it through the C++ compiler with the /clr option and you'll end up with an assembly that contains pure IL that will be just-in-time compiled at runtime
p67415
aVBy no stretch of the imagination could you call the result a managed program, it won't be verifiable and it won't use the garbage collector
p67416
aVSolving that is going to require a support library that's going to have to emulate multiple inheritance
p67417
aVPossible, I doubt it will be competitive
p67418
as(dp67419
g9
V17034
p67420
stp67421
a((dp67422
g2
(lp67423
VAssuming that the process has enough rights to write to the registry, you'll have to take care of that by running it from an elevated command prompt, this is likely to only add the COM registry keys to the registry view that 64-bit processes can see
p67424
aV32-bit COM clients get a different view of the registry, HKLM\u005cSoftware\u005cWow6432Node
p67425
aVIt is not going to find the registry keys there
p67426
aVReview RegCreateKeyEx() in the SDK docs
p67427
aVNote the link at the bottom and the talk about the KEY_WOW64_32KEY option
p67428
aVThe online article is here
p67429
aV32-bit clients accessing a 64-bit out-of-process COM server is otherwise a pretty well supported scenario, with some caveats
p67430
aVLike building and registering both the 32-bit and 64-bit proxy/stub DLLs
p67431
as(dp67432
g9
V17034
p67433
stp67434
a((dp67435
g2
(lp67436
VThis is the declaration of the native cvSaveImage() function, retrieved from highgui
p67437
aVh:
p67438
aVThis is the pinvoke declaration for it, retrieved from the wrapper, HighGui
p67439
aVcs:
p67440
aVNote how the native declaration has three arguments, the pinvoke declaration has only two
p67441
aVIt is possible to call the native function from a C++ program and pass only two arguments, the compiler automatically applies the default value for the 3rd argument
p67442
aVBut that doesn't work that way with the pinvoke marshaller, it has no clue that the 3rd argument even exists
p67443
aVThe result is that the native function gets an arbitrary value for the params parameter
p67444
aVIt works when it is 0 by accident
p67445
aVBut there are 4 billion other ways for the function to get a non-null argument and nose-dive on an access violation when it dereferences the pointer
p67446
aVFailure will be random
p67447
aVFix the problem by editing the pinvoke declaration and adding an IntPtr as the 3rd parameter
p67448
aVPass IntPtr
p67449
aVZero in your C# code
p67450
aVThis is rather a basic mistake, expect more trouble with this wrapper
p67451
as(dp67452
g9
V17034
p67453
stp67454
a((dp67455
g2
(lp67456
VNo
p67457
aVIt requires the UI thread to do the pumping
p67458
aVIf it doesn't then Invoke() won't complete
p67459
aVClassic source of deadlock btw
p67460
aVDiagnose with Debug + Windows + Threads, check the main thread call stack
p67461
as(dp67462
g9
V17034
p67463
stp67464
a((dp67465
g2
(lp67466
VJonathan is a heckofalot closer then he might have thought
p67467
aVAdd a GroupBox, set the Text property to an empty string, change the Size property to make the Height equal to 2
p67468
aVPresto, horizontal carved battle-ship gray line like seen on many dialogs
p67469
as(dp67470
g9
V17034
p67471
stp67472
a((dp67473
g2
(lp67474
VYou don't need an instance here, everything can be static
p67475
aVSomething like this, with the necessary error checking added:
p67476
aVThe point of keeping lookupSenior in a separate method is to allow SeniorFunc() to get inlined so it is fast
p67477
aVIf you know you'll always use these functions in your program then you can also write a static constructor for the class and do the lookup there
p67478
aVSaves the null check but makes an exception a bit harder to interpret
p67479
as(dp67480
g9
V17034
p67481
stp67482
a((dp67483
g2
(lp67484
VYou are violating a hard requirement for an STA thread, it must pump a message loop
p67485
aVYou patched your way out of trouble with the Navigate method by calling Application
p67486
aVDoEvents()
p67487
aVThat pumps the message loop
p67488
aVBut you are not doing this for InvokeClick
p67489
aVCheck this answer for the solution
p67490
aVPut the code in the DocumentCompleted event
p67491
aVThere is no obvious way I see to decide when to stop the thread, you'd have to poll for some kind of side-effect of the click with a timer perhaps
p67492
as(dp67493
g9
V17034
p67494
stp67495
a((dp67496
g2
(lp67497
VThis is not possible, you'll invoke the infamous and dreaded DLL Hell problem
p67498
aVA stone cold hard rule in COM is that you have to change the [Guid] attribute values on public interfaces when you make a breaking change in either the publicly visible interfaces or the implementation of them
p67499
aVChanging the guids ensures that you don't overwrite the registry keys of an old version of your component when you use Regasm
p67500
aVexe
p67501
aVExisting programs that use your component and were not recompiled to use the latest version will continue running without problems
p67502
aVThe typical outcome of DLL Hell is a nasty hardware exception like AccessViolation, very difficult to troubleshoot
p67503
aVNone of which applies in your specific case here
p67504
aVThere is no point in trying to use the component through COM
p67505
aVIt is a
p67506
aVNET assembly, just add the reference to it directly
p67507
aVThe IDE will in fact stop you from adding a reference to the interop library
p67508
aVBut not the
p67509
aVtlb
p67510
aVThe GAC keeps you out of DLL Hell, assuming you properly increment [AssemblyVersion]
p67511
as(dp67512
g9
V17034
p67513
stp67514
a((dp67515
g2
(lp67516
Vit should be 11 as the default value of A1 is 0;
p67517
aVThis is exactly the reason that the C# compiler won't let you get away with using uninitialized variables
p67518
aVThe result would be 10, not 11
p67519
aVAfter a good 30 years of experience with C and C++, languages that allow you to use uninitialized variables, the C# team decided that this was a major source of bugs and to not allow this in a C# program
p67520
aVThere are lots of little tweaks like this
p67521
aVAnother great example is not allowing fall through to another case in a switch statement
p67522
aVForgetting to write break is such a classic bug
p67523
aVOutlawing these C-isms is rather an excellent idea and a big part of why C# is such a great language
p67524
aVUnless you dislike the idea of a compiler as a police officer
p67525
aVFwiw: using an uninitialized variable is permitted in VB
p67526
aVNET
p67527
as(dp67528
g9
V17034
p67529
stp67530
a((dp67531
g2
(lp67532
VI'll do the fish and explain why this is verboten
p67533
aVBefore a C or C++ program can start running, the CRT has to be initialized first
p67534
aVOpen stdin/out/err, call initializers, that sort of thing
p67535
aVThere are two basic strategies to get this done, a heavy platform implementation detail
p67536
aVThe program's start address points to the CRT init function, which eventually calls main()
p67537
aVCommon on full-featured operating systems that have a fancy loader which can support arbitrary sections in the executable image
p67538
aVThe compiler injects code into the main() function that calls the CRT initialization function
p67539
aVThe start function is always main()
p67540
aVCommon on embedded platforms with limited loader capabilities
p67541
aVRecursing main() is now a problem, the CRT startup code will be called again with an unpredictable stack state
p67542
as(dp67543
g9
V17034
p67544
stp67545
a((dp67546
g2
(lp67547
VI figured you'd be back about this
p67548
aVThe extensibility object model has no great support for observing scripting execution
p67549
aVIt isn't practical, scripting code can run completely asynchronous from the page state at unpredictable times
p67550
aVIf there are no reliable DOM modifications made by the script that you can read back then you have no great options beyond just spinning your wheels for a couple of seconds to give it 'enough time'
p67551
aVShouldn't be a problem given that you run this in a worker thread, just use a System
p67552
aVWindows
p67553
aVForms
p67554
aVTimer who's Tick event calls Application
p67555
aVExitThread to end the thread
p67556
as(dp67557
g9
V17034
p67558
stp67559
a((dp67560
g2
(lp67561
VString types in common use in Microsoft code are char*, wchar_t*, LPSTR, LPTSTR, LPWSTR, LPCSTR, LPCTSTR, LPCWSTR, BSTR, OLESTR, UNICODE_STRING, String, string, wstring, _bstr_t, CString
p67562
aVThe last 5 are classes
p67563
aVYou pick the one that gives you the least conversion headaches, depending on what API you need to use:
p67564
aVstd::string and wstring, standard C++ library
p67565
aVSystem::String, the string type for managed code
p67566
aV_bstr_t, wrapper for a BSTR, used in COM automation
p67567
aVCString, string type for the ATL and MFC libraries
p67568
aVYou're likely to encounter additional string types when you work with other APIs
p67569
as(dp67570
g9
V17034
p67571
stp67572
a((dp67573
g2
(lp67574
VThis is a case of a leaky abstraction
p67575
aVA property is actually a method, the get and set accessors for an indexer get compiled to get_Index() and set_Index methods
p67576
aVThe compiler does a terrific job hiding that fact, it automatically translates an assignment to a property to the corresponding set_Xxx() method for example
p67577
aVBut this goes belly up when you pass a method parameter by reference
p67578
aVThat requires the JIT compiler to pass a pointer to the memory location of the passed argument
p67579
aVProblem is, there isn't one, assigning the value of a property requires calling the setter method
p67580
aVThe called method cannot tell the difference between a passed variable vs a passed property and can thus not know whether a method call is required
p67581
aVNotable is that this actually works in VB
p67582
aVNET
p67583
aVFor example:
p67584
aVThe VB
p67585
aVNET compiler solves this by automatically generating this code for the Run method, expressed in C#:
p67586
aVNot quite sure why the C# team didn't use the same approach
p67587
aVPossibly because they didn't want to hide the potentially expensive getter and setter calls
p67588
aVOr the completely undiagnosable behavior you'll get when the setter has side-effects that change the property value, they'll disappear after the assignment
p67589
aVClassic difference between C# and VB
p67590
aVNET, C# is "no surprises", VB
p67591
aVNET is "make it work if you can"
p67592
as(dp67593
g9
V17034
p67594
stp67595
a((dp67596
g2
(lp67597
VThe SSCLI20 source code for clr/src/vm/class
p67598
aVcpp, MethodTableBuilder::HandleExplicitLayout can provide some insight
p67599
aVIt is unusually heavily commented, this comment describes the rules (edited for readability):
p67600
aVRule 1 ensures that a reference assignment stays atomic
p67601
aVRule 2 says why you can do what you did, any object type reference may overlap
p67602
aVOverlap with a value type value is not permitted, that screws up the garbage collector
p67603
aVRule 3 states the consequence, it only makes the type non-verifiable
p67604
aVIt is otherwise not the only way to screw up a string without the unsafe keyword
p67605
aVJust pinvoke a function that stomps the string
p67606
aVIt gets a pointer to the string content on the GC heap or loader heap (interned strings), no copy is made
p67607
aVThat's unverifiable code as well and just as un-exploitable when running in a sandbox
p67608
aVDriving the point home: the C# unsafe keyword is not at all related to what the CLR considers verifiable, and thus actually safe code
p67609
aVIt takes care of the blatant cases, using pointers or custom value types (fixed)
p67610
aVWhether that's a leak in the C# language spec is debatable
p67611
aVPinvoke being the more obvious edge case
p67612
aVPinvoking a operating system function is pretty doggone safe
p67613
aVPinvoking some 3rd party C library is not
p67614
aVBut I have to agree with @fej, [FieldOffset] should have gotten the "are you sure" treatment
p67615
aVToo bad there's no syntax for that
p67616
aVAdmittedly, I haven't figured out yet why this actually needed to affect the managed layout
p67617
aVIt would make much more sense that this attribute would only apply to the marshaled layout
p67618
aVWeird, somebody holding a ace his sleeve in the early days, maybe
p67619
as(dp67620
g9
V17034
p67621
stp67622
a((dp67623
g2
(lp67624
VAuto-starting services are subject to problems with service initialization order
p67625
aVYou have plenty of dependencies, the TCP/IP stack better be in working order before you try to send an email, for example
p67626
aVLook in the Windows event log for an exception message that prevented OnStart() from getting the service started
p67627
aVThis can be configured for a service, check out the Dependencies tab for the Print Spooler service for example
p67628
aVThis is however difficult to deal with, hard to figure out exactly which services need to be running and hard to write the registry entries that configure the dependencies
p67629
aVPunt the problem: don't send an email message right away
p67630
aVWait a while, 30 minutes for example
p67631
as(dp67632
g9
V17034
p67633
stp67634
a((dp67635
g2
(lp67636
Vlike VK_OEM1 is "o with an umlaut"
p67637
aVMaybe on your machine
p67638
aVNot on mine, it is ';' or ':', depending on the Shift key state
p67639
aVThese are virtual key codes
p67640
aVThe ones that represent a typing key get converted to a character by ToUnicodeEx(), a function that takes a keyboard layout
p67641
aVAnd of course you have the non-typing keys that produce no character at all, like VK_F1 or VK_NUMLOCK
p67642
aVThis gets a lot more complicated when the keyboard layout has dead keys, the kind you use to get a diacritic on top of a character
p67643
aVThat why the function also requires a keyboard state
p67644
aVAvoid this like the plague, WM_CHAR is your friend
p67645
as(dp67646
g9
V17034
p67647
stp67648
a((dp67649
g2
(lp67650
VThere is no clean fix for this, you will have to give up on TLP
p67651
aVA control is a much too expensive object, any form that has more than a hundred of them is going to suck mud
p67652
aVFirst look at the built-in control types that support a grid-like display
p67653
aVListView with View = Details for non-editable grids, DataGridView for editable ones
p67654
aVIf that doesn't fit your bill then you'll have to make your own
p67655
aVKey things you'll need to implement is the OnPaint() method to draw the visual appearance of the control and OnMouseDown or OnClick to do hit-testing and implement behavior
p67656
as(dp67657
g9
V17034
p67658
stp67659
a((dp67660
g2
(lp67661
VA web page is not made up from a single HTTP GET request
p67662
aVThe stackoverflow
p67663
aVcom front page for example requires 16 requests
p67664
aVStuff like javascript code, images, page visit counters, coming from different web sites as well
p67665
aVSome of it retrieve from cache instead of downloaded
p67666
aVWebBrowser (aka Internet Explorer) doesn't support enumerating these individual requests
p67667
aVYou'd have to use the HttpWebRequest class, but that of course doesn't make a web page
p67668
as(dp67669
g9
V17034
p67670
stp67671
a((dp67672
g2
(lp67673
VThis is by design
p67674
aVA form acts as a container for other windows, controls
p67675
aVThe controls get the focus, the user interacts with, say, a button or text box
p67676
aVOnly when the form doesn't have any controls will it get the focus, only because there's nothing else that can get it
p67677
aVThe same thing will happen with the MDI child form as soon as you put a control on it
p67678
aVOr with a Panel or UserControl, other container control types
p67679
aVA form has the Activate and Deactivate events
p67680
aVActiveForm tells you with one is currently active
p67681
aVNote the distinction between active and focused
p67682
as(dp67683
g9
V17034
p67684
stp67685
a((dp67686
g2
(lp67687
VA user interface that changes faster than the human eye can observe (~25 updates/sec) is not a usable user interface
p67688
aVA typical user will observe the spectacle for at most a minute before giving up completely
p67689
aVYou are well past this if you made the UI thread freeze
p67690
aVYou have to design for a human, not a machine
p67691
as(dp67692
g9
V17034
p67693
stp67694
a((dp67695
g2
(lp67696
VThis is a never-ending question in the C++ tag: "What is the predictable undefined behavior"
p67697
aVEasy to resolve all by yourself: get every C++ compiler implementation and check if the predictable unpredictable still works
p67698
aVThis is however something you have to do by yourself
p67699
aVDo post back what you found out, that would be quite useful to know
p67700
aVAs long as the unpredictable has consistent and annotated behavior across the board
p67701
aVIt makes it really hard for somebody that writes a C++ compiler to get anybody to pay attention to his product
p67702
aVStandardization by convention, happens a lot with a language that has a lot of undefined behavior
p67703
as(dp67704
g9
V17034
p67705
stp67706
a((dp67707
g2
(lp67708
VYou seem to confuse bits with nibbles
p67709
aVOne hexadecimal digit represents 4 bits
p67710
aVThe opcode can store a 24 bit constant, 6 nibbles
p67711
aVRead the value from the string with strtol() and left-shift it by 8
p67712
aVOr with the opcode
p67713
as(dp67714
g9
V17034
p67715
stp67716
a((dp67717
g2
(lp67718
VYes, it isn't selected yet when the NodeMouseClick event fires
p67719
aVYou ought to use the AfterSelect event instead
p67720
aVThat ensures it also works when the user uses the keyboard to select the node
p67721
aVOr do it like this:
p67722
aVBut beware that the selection can be canceled by BeforeSelect
p67723
as(dp67724
g9
V17034
p67725
stp67726
a((dp67727
g2
(lp67728
VThere is no upper limit, other than memory
p67729
aVA 32-bit process normally peters somewhat shy of 2000 threads when the stacks of the threads have consumed all available address space
p67730
aVKeep the rules in mind, you cannot call an object that was created in one STA from another STA without marshaling
p67731
aVAnd don't forget the required message loop, an STA thread must pump to keep the marshaling alive and prevent deadlock
p67732
aVObviously getting anywhere close to the memory limit should be strongly avoided
p67733
as(dp67734
g9
V17034
p67735
stp67736
a((dp67737
g2
(lp67738
VCheck out the warnings you get on this code:
p67739
aVwarning C4717:
p67740
aV'cpptemp5::Form1::WndProc' : recursive
p67741
aVon all control paths, function will
p67742
aVcause runtime stack overflow
p67743
aVWhich is why your code crashes with this web site name
p67744
aVThat could have been a bit more than a warning
p67745
aVFix:
p67746
aVOr use the __super keyword
p67747
aVIt should be called first, before you change the return value
p67748
aVwarning C4490: 'override' : incorrect
p67749
aVuse of override specifier;
p67750
aV'cpptemp5::Form1::get' does not match
p67751
aVa base ref class method
p67752
aVWhich prevents your attempt at overriding from working, the form still has borders
p67753
aVThe better mousetrap is to assign the FormBorderStyle property in the constructor:
p67754
aVAlthough you'd normally just do this with the designer, using the Properties window
p67755
aVFor completeness, the override doesn't work because you made it a function, not a property
p67756
aVThe correct syntax is:
p67757
aVBut not quite good enough to make the form borderless
p67758
as(dp67759
g9
V17034
p67760
stp67761
a((dp67762
g2
(lp67763
Vthen it cannot run code marked with [MTAThread] attribute
p67764
aVThat's not how it works
p67765
aVThe apartment type is a property of a thread, not of a method
p67766
aVYou see the [STAThread] attribute applied only to the Main() method of a
p67767
aVNET program
p67768
aVIt determines the apartment type of the very first thread that is created to run the program
p67769
aVNecessary because you can't call SetApartmentState() after the thread is running
p67770
aVBeyond that, the attribute has no meaning, the thread stays in an STA for its lifetime
p67771
aVYou never see [MTAThread] because that's the default
p67772
aVA thread that's STA has some limitations
p67773
aVIt can never block because that will block and often deadlock any code that tries to call a method of an apartment threaded COM object
p67774
aVAnd it must pump a message loop so that COM can marshal the method call from another thread
p67775
aVMarshaled method calls can only be executed when a thread is 'idle', not busy executing any code
p67776
aVA message loop provides that 'not busy' state
p67777
aVThere are requirements on the COM component as well
p67778
aVIt must support marshaling, either by restricting itself to the subset of types that are supported by Automation so that the standard marshaller can be used
p67779
aVOr by providing a proxy/stub pair for custom marshaling
p67780
aVThe  registry key determines how the marshaling is done
p67781
aVSharing an apartment threaded object between an STA and an MTA thread is explicitly supported
p67782
aVThe STA thread must create it, any calls on the MTA thread (or other STA threads) is marshaled
p67783
aVWhich ensures that the component only ever sees calls made on the same thread, thus ensuring thread-safety
p67784
aVNo additional locking is required
p67785
aVLast but not least, if you create an apartment threaded COM object on an MTA thread then COM will automatically create an STA thread to give it a safe home
p67786
aVThe only failure mode for this is when the COM component doesn't support marshaling
p67787
aVThe one disadvantage of doing it this way is that every call will be marshaled
p67788
aVThat's slow
p67789
as(dp67790
g9
V17034
p67791
stp67792
a((dp67793
g2
(lp67794
VI repro
p67795
aVThe Remarks section of the Window
p67796
aVRestoreBounds property docs is relevant to your problem:
p67797
aVIf you query RestoreBounds before the
p67798
aVwindow has been shown or after it has
p67799
aVbeen closed, Empty is returned
p67800
aVUse the Closing event instead so the RestoreBounds property is still valid
p67801
as(dp67802
g9
V17034
p67803
stp67804
a((dp67805
g2
(lp67806
VDecent TimeSpan parsing is only available in
p67807
aVNET 4
p67808
ag2512
aVFor earlier version you can hijack the DateTime parsing methods, converting from a date to a timespan through the Ticks property
p67809
aVLike this:
p67810
aVAdditional work is required when you need to parse negative time spans
p67811
as(dp67812
g9
V17034
p67813
stp67814
a((dp67815
g2
(lp67816
VYou need a bunch more pinvoke
p67817
aVFirst off, you need to allocate memory in the target process so it can read and write the TEXTRANGE structure value
p67818
aVThat requires OpenProcess and VirtualAllocEx
p67819
aVNow you need to initialize the structure, first order of business is to get memory for the lpstrText member
p67820
aVVirtualAllocEx again to allocate a buffer large enough to store the string, WriteProcessMemory to initialize the structure
p67821
aVNow your ready to call SendMessage
p67822
aVReadProcessMemory to read the lpstrText back
p67823
aVCleanup with two times VirtualFreeEx and CloseHandle to close the process handle
p67824
aVAbout a hundred ways to shoot the foot
p67825
aVThis is popular kind of code at codeproject
p67826
aVcom, I know it is there but their search is completely borked as of late
p67827
aVGood luck
p67828
as(dp67829
g9
V17034
p67830
stp67831
a((dp67832
g2
(lp67833
VDon't write code like this
p67834
aVIt is speed-bump code, somebody will read this some day and go Whoa
p67835
aVand lose 5 minutes of his life trying to figure out why you did this
p67836
aVThat's 5 minutes he'll never get back, you'll owe him for no good reason
p67837
aVIf constricting the scope of result is really that important then use an extra set of braces:
p67838
aVNow put this on top and you'll have written not just readable code but re-usable code:
p67839
as(dp67840
g9
V17034
p67841
stp67842
a((dp67843
g2
(lp67844
VThis is irrelevant
p67845
aVA virus that uses the wrong ordinal cannot replicate
p67846
aVYou cannot catch viruses that cannot replicate, you'll never see them
p67847
aVNor does it matter that you do, it isn't functional
p67848
as(dp67849
g9
V17034
p67850
stp67851
a((dp67852
g2
(lp67853
VIt is a feature of Windows, designed to help the user cope with unresponsive programs
p67854
aVWhen you display the splash screen, Windows sends your main form a message to tell it that it is no longer the active window
p67855
aVThis normally causes it to redraw the window caption, using the color for inactive windows
p67856
aVThat same message also fires the Form
p67857
aVDeactivated event
p67858
aVBut that doesn't work anymore, your main thread is busy executing code and not going idle to 'pump the message loop'
p67859
aVWindows notices this, the message isn't getting delivered
p67860
aVAfter a couple of seconds, it replaces your window with the 'ghost window'
p67861
aVIt has the same size and border as your main window but with no content, just a white background
p67862
aVAnd a caption that reads "Not responding"
p67863
aVEnough for the user to know that trying to use the window isn't going to work
p67864
aVAvoid this by using a real splash screen, support for it is already built into
p67865
aVNET
p67866
as(dp67867
g9
V17034
p67868
stp67869
a((dp67870
g2
(lp67871
VNope, that doesn't make it go through its full paint cycle
p67872
aVWhich needs to include WM_ERASEBKGND to solve your problem
p67873
aVUse InvalidateRect() instead
p67874
aVYou can now also call BeginPaint() in the WM_PAINT handler, like you should
p67875
as(dp67876
g9
V17034
p67877
stp67878
a((dp67879
g2
(lp67880
VVerifiable code is code that gets compiled to IL and can be proven to not produce any IL that can execute unsafe code, bypass code access security checks or in any way corrupt the state of the CLR
p67881
aVThe exact rules are complex however
p67882
aVThe ten-thousand feet view is code written in managed languages like VB
p67883
aVNET or C# without the unsafe keyword
p67884
aVNevertheless, you can write unverifiable code in C# without using the unsafe keyword
p67885
aVCheck this answer for example
p67886
aVThere's a dedicated tool to check an assembly, PEVerify
p67887
aVexe
p67888
aVIt executes the same checks the JIT compiler and the CLR perform
p67889
aVThe bottom of the linked page has links to MSDN articles about verification
p67890
as(dp67891
g9
V17034
p67892
stp67893
a((dp67894
g2
(lp67895
VThis is a known bug in the MDI implementation, triggered when you create a maximized child window in the parent constructor
p67896
aVThis is an example:
p67897
aVYou'll see the min/max/restore glyphs displayed twice, restoring the child window leaves the MDI bar on the screen, just as in your first screen shot
p67898
aVThe workaround is to move the child creation code to the OnLoad() method
p67899
aVLike this:
p67900
as(dp67901
g9
V17034
p67902
stp67903
a((dp67904
g2
(lp67905
VThis is off by default 'for performance reasons'
p67906
aVTools + Options, Text Editor, C/C++, Formatting, Miscellaneous, Enumerate Comment Tasks = True
p67907
aVFeedback article is here
p67908
aVAlso note the comment in the MSDN article about task list comments:
p67909
aVWith Visual C++ projects, the Task
p67910
aVList displays only the comments that
p67911
aVare found in the file that is
p67912
aVcurrently active in the editor
p67913
as(dp67914
g9
V17034
p67915
stp67916
a((dp67917
g2
(lp67918
VFrom the horse's mouth:
p67919
aVB introduced generalized assignment
p67920
aVoperators, using x=+y to add y to x
p67921
aVThe notation came from Algol 68
p67922
aV[Wijngaarden 75] via McIlroy, who had
p67923
aVincorporated it into his version of
p67924
aVTMG
p67925
aV(In B and early C, the operator
p67926
aVwas spelled =+ instead of += ; this
p67927
aVmistake, repaired in 1976, was induced
p67928
aVby a seductively easy way of handling
p67929
aVthe first form in B's lexical
p67930
aVanalyzer
p67931
as(dp67932
g9
V17034
p67933
stp67934
a((dp67935
g2
(lp67936
Vwuapi
p67937
aVdll has an OS dependency so the interop library does as well
p67938
aVJudging from the interface names there may be 6 versions of it out there
p67939
aVI see IUpdate through IUpdate5 for example on Win7
p67940
aVTrying to use a newer interface is liable to fail if you're running on an old version of Windows
p67941
aVWhich interface is available on what version of Windows isn't documented in the MSDN library articles, you'll have to test this yourself
p67942
aVYou can get old versions of Windows through an MSDN subscription
p67943
aVNothing but the interop library should be deployed, this is an operating system component
p67944
as(dp67945
g9
V17034
p67946
stp67947
a((dp67948
g2
(lp67949
VThat doesn't work, WatchdogActive isn't declared volatile
p67950
aVIn the Release build the variable is very likely to get stored in a CPU register, it never sees the update that some other thread makes to the variable
p67951
aVIn other words, the watch dog will still be active, even though you turned it off
p67952
aVYou should use a ManualResetEvent here, its WaitOne(int) method automatically takes care of the Sleep() and gives you a much quicker thread termination as a bonus
p67953
aVSome strange inconsistencies
p67954
aVYou quote a failure at 3 seconds but you only check for >= 5 seconds
p67955
aVThe Sleep() is longer than the check, making it possible to miss failures
p67956
aVYou seem to like empty catch blocks, always giving great opportunities for code failing to work without any diagnostic
p67957
aVI'm guessing we're not looking at the real code, that makes it difficult to see subtle threading problems
p67958
aVDo work from the assumption that this is not a bug in C#
p67959
as(dp67960
g9
V17034
p67961
stp67962
a((dp67963
g2
(lp67964
VThe open source 7-zip file manager can browse and extract content from a
p67965
aVchm file
p67966
aVRight-click and select Open Inside
p67967
aVDownload is here
p67968
as(dp67969
g9
V17034
p67970
stp67971
a((dp67972
g2
(lp67973
VPostpone executing the Focus() method until after the event is finished executing
p67974
aVElegantly done by using the Control
p67975
aVBeginInvoke() method
p67976
aVLike this:
p67977
as(dp67978
g9
V17034
p67979
stp67980
a((dp67981
g2
(lp67982
VThen SendMessage(), WM_SETTEXT
p67983
as(dp67984
g9
V17034
p67985
stp67986
a((dp67987
g2
(lp67988
VLooks like you are using MFC
p67989
aVIt already has a DllMain entrypoint, required to initialize MFC properly
p67990
aVCheck this KB article for recommended workarounds
p67991
aVHard to otherwise provide a better answer, you didn't provide a link and it looks to me like this is Apple code, very un-mfc-ish
p67992
as(dp67993
g9
V17034
p67994
stp67995
a((dp67996
g2
(lp67997
VThis is not possible as-is, the linker can only set the entrypoint for an EXE to a function that's inside the EXE
p67998
aVRename the wWinMain() in the DLL to something else
p67999
aVWrite a wWinMain() in a source code file that gets linked into your EXE, simply call the DLL's exported function
p68000
as(dp68001
g9
V17034
p68002
stp68003
a((dp68004
g2
(lp68005
VThis is by design
p68006
aVThe CLR honors the contract of a single-threaded apartment (STA)
p68007
aVThe main thread of a GUI app is STA as is required in Windows programming, the [STAThread] attribute on the Main() method ensures that
p68008
aVHard rules for an STA thread are that it must pump a message loop (like Application
p68009
aVRun) and can never block
p68010
aVBlocking an STA thread is highly likely to cause deadlock when background threads use any COM apartment threaded objects
p68011
aVThere are many of them, the clipboard and WebBrowser are common ones you'll encounter in a
p68012
aVNET program
p68013
aVMany less visible ones as well, available as
p68014
aVNET wrapper classes
p68015
aVThe CLR ensures blocking can't cause deadlock by pumping a message loop when you use the lock statement or call the Wait method of the synchronization classes
p68016
aVOr Thread
p68017
aVJoin()
p68018
aVThat message loop dispatches the WM_PAINT message, causing the Paint event to run
p68019
aVYou need to restructure your program to ensure this doesn't cause a problem
p68020
aVPretty important to focus on not blocking the main thread at all
p68021
aVIt is very rarely needed when you have, say, the BackgroundWorker class or Control
p68022
aVBeginInvoke() at your disposal
p68023
aVFor some kind of odd reason the Mutex class doesn't do this kind of pumping, that could be another way
p68024
aVAlthough deadlock is lurking around the corner if you do
p68025
as(dp68026
g9
V17034
p68027
stp68028
a((dp68029
g2
(lp68030
VLook at the InnerException to get the reason that the static constructor of the Main class  failed
p68031
aVIt is usually caused by static variable initializers throwing an exception
p68032
aVUpdate: my Portuguese is quite rusty, but it looks like you are using an assembly that was written in C++/CLI and built targeting the
p68033
aVNET 2
p68034
aV0 version of the CLR
p68035
aVSqlLite fits that description
p68036
aVOther than getting an update for that assembly, you need to tell the CLR that it is okay to load the assembly with the
p68037
aVNET 4
p68038
aV0 version of the CLR
p68039
aVProject + Add New Item, select Application Configuration File
p68040
aVMake it look like this:
p68041
as(dp68042
g9
V17034
p68043
stp68044
a((dp68045
g2
(lp68046
VNot possible
p68047
aVA WebBrowser control displays HTML, it cannot contain any Winforms controls
p68048
aVYou could consider modifying the HTML with the WebBrowser
p68049
aVDocument property, use the  element
p68050
aVYou can detect a click with the HtmlElement
p68051
aVClick event
p68052
aVYou'd need to have a pretty good idea what the original HTML looks like to know where to insert the element
p68053
as(dp68054
g9
V17034
p68055
stp68056
a((dp68057
g2
(lp68058
VIt is an implementation detail of the C/C++ compiler
p68059
aVYou should go by the comment and declare it IntPtr
p68060
aVIf the code is compiled by the MSVC compiler then it isn't going to work in 64-bit mode, it uses 32-bits for a long
p68061
aVNot enough to store a pointer
p68062
as(dp68063
g9
V17034
p68064
stp68065
a((dp68066
g2
(lp68067
VNo, that is the right way to do it
p68068
aVTrying to use something like a TableLayoutPanel is not only excruciatingly painful, it also sucks serious mud taking a second or more to paint itself
p68069
aVIt will take a bunch of code, but it isn't hard code
p68070
aVPlenty of for loop opportunities as well
p68071
aVGet the scrolling view with panel's AutoScrollMinSize
p68072
aVUse Graphics
p68073
aVTranslateTransform() passing AutoScrollPosition in the Paint event or OnPaint override
p68074
aVThe latter is recommended, derive your own control from Panel to keep the code separate
p68075
aVYou have lots of flexibility here to customize the appearance, have fun
p68076
as(dp68077
g9
V17034
p68078
stp68079
a((dp68080
g2
(lp68081
VNah, Winforms events happen in human time, not CPU time
p68082
aVNobody can move the mouse fast enough to put any kind of serious pressure on a modern machine
p68083
aVThere is no message for each individual traversed pixel
p68084
aVMore to the point, the delegate argument objects are always gen #0 objects
p68085
aVThey don't stick around long enough to ever get promoted
p68086
aVBoth allocating and garbage collecting them is dirt cheap
p68087
aVThis is just not a real problem, don't chase that ghost
p68088
as(dp68089
g9
V17034
p68090
stp68091
a((dp68092
g2
(lp68093
VI'm guessing you are talking about the Exception Handling Block
p68094
aVI studied it for a while, trying to find the point behind it
p68095
aVAdmittedly I still don't really get it, but that's a professional liability
p68096
aVAs far as I can tell, it gives IT staff some measure of control over the way exceptions are reported and dealt with
p68097
aVWhich is relevant in an enterprisey setting where the departmental gap between the people that create exceptions (software engineers) and the people that have to deal with them (IT staff and users) can be difficult to bridge
p68098
aVCode crashing with an impenetrable exception message is all too common, getting them fixed with lots of middle management layers in between can be quite difficult and time-consuming
p68099
aVIn this kind of scenario, being able to improve the diagnostic and help the user avoid to make the same mistake,  instead of having to slay the enterprise dragon, makes a lot of sense
p68100
as(dp68101
g9
V17034
p68102
stp68103
a((dp68104
g2
(lp68105
VIt's possible, LoadLibrary() and GetProcAddress to the get the DllGetClassObject() entrypoint
p68106
aVYou are bypassing a bunch of COM plumbing code that was designed to make you fall into the pit of success
p68107
aVEspecially the stuff that takes care of the ThreadingModel
p68108
aVOr the tricks you can use to make 32-bit code run in a 64-bit process, tends to be important with video
p68109
aVUsing reg-free COM with a manifest can make you fall back into that pit
p68110
as(dp68111
g9
V17034
p68112
stp68113
a((dp68114
g2
(lp68115
VYes, this is a problem with the native Windows control
p68116
aVIt doesn't have any way to specify a custom item bounds
p68117
aVThe TVN_GETDISPINFO notification is probably closest, but NMTVDISPINFO is missing a way to specify the bounds
p68118
aVThe
p68119
aVNET wrapper doesn't implement it
p68120
aVIt is really only good enough to implement a VirtualMode
p68121
aVThat keeps hit testing and TreeNode
p68122
aVBounds based on the original metrics
p68123
aVIt is especially a problem with the horizontal scrollbar, it won't scroll far enough to reveal all the custom-drawn text if it is wider than the original
p68124
aVYou can somewhat solve the hit testing problem by implementing MouseDown and iterating the TreeNode
p68125
aVBounds properties but not the scrollbar problem
p68126
aVThere's no clean fix for this, only an fugly one
p68127
aVSet the TreeNode
p68128
aVText to an arbitrary string that's wide enough to solve the problem
p68129
aVYou could use the Tag property to store the actual text, if necessary
p68130
aVIt depends on how custom you draw, prefixing the Text with a couple of M's might be good enough
p68131
aVNot pretty
p68132
as(dp68133
g9
V17034
p68134
stp68135
a((dp68136
g2
(lp68137
VAlways a Big Mistake to ask a question about an error without quoting the exact error message
p68138
aVBut the one you'd typically see has this phrase in it:
p68139
aVAre you missing an assembly reference
p68140
as(dp68141
g9
V17034
p68142
stp68143
a((dp68144
g2
(lp68145
VThat's wrong, the ID is a number, not a string
p68146
aVUse MAKEINTRESOURCE(IDB_PNG1)
p68147
as(dp68148
g9
V17034
p68149
stp68150
a((dp68151
g2
(lp68152
VIt has to be an assembly, there's no other way to build code with a managed type like that
p68153
aVMixing managed and native code in one assembly is fine
p68154
aVWhich automatically solves the problem, the function will be available in the metadata, no need to export it
p68155
aVYou need to drop all the decoration, it cannot be applied to a managed method
p68156
aVAnd it should be in a ref class to allow other managed languages to use it
p68157
aVA C# program now can use var lst = Mumble
p68158
aVInitSystem()
p68159
aVUsing a namespace is recommended
p68160
aVWatch out for /clr btw, it will readily convert native code to IL without complaint
p68161
aVEither turn off /clr on a source code file or use #pragma managed
p68162
as(dp68163
g9
V17034
p68164
stp68165
a((dp68166
g2
(lp68167
VYou need to make up your mind whether the want the DLL or the static link library
p68168
aVAdvantage of a DLL is that the build times can be quicker if you make local changes
p68169
aVAdvantage of a
p68170
aVlib is that you'll end up with only one deployable file
p68171
aVGetting it linked (either the static
p68172
aVlib or the dll's import
p68173
aVlib) is otherwise automatic
p68174
aVYou want to make sure that the library is built first, can't link the
p68175
aVexe without it
p68176
aVRight-click the exe project in the Solution Explorer window, Project Dependencies, tick the library project
p68177
aVThat automatically adds the
p68178
aVlib to the exe project's additional dependencies
p68179
aVUsing #pragma comment(lib, "engine
p68180
aVlib") in the engine's header file is another way
p68181
aVRepeat for other dependencies like the OS import libraries
p68182
aVGetting the library path right is a // todo item
p68183
as(dp68184
g9
V17034
p68185
stp68186
a((dp68187
g2
(lp68188
VFinding the window back isn't too hard, use EnumThreadWindows() and GetCurrentThreadId()
p68189
aVNote that DirectInput doesn't need a window handle anywhere
p68190
aVIt just needs the instance handle in DirectInput8Create()
p68191
aVGetModuleHandle(NULL) is good for an SFML app
p68192
as(dp68193
g9
V17034
p68194
stp68195
a((dp68196
g2
(lp68197
VWhat you are trying to do only works for
p68198
aVNET assemblies, not native COM servers
p68199
aVThe type library for them is almost always embedded inside the DLL
p68200
aVIn Visual Studio, use File + Open + File and select the DLL
p68201
aVOpen the "TYPELIB" node, right-click the resource (usually 1), Export
p68202
aVSave it to, say, a project directory, use the
p68203
aVtlb filename extension
p68204
as(dp68205
g9
V17034
p68206
stp68207
a((dp68208
g2
(lp68209
VNo, you are running out of magic here
p68210
aVYou took the bluepill to solve your problem, the real issue is that the background image is too expensive to draw
p68211
aVNext workaround is to not have the panel resize itself when the user resizes the form
p68212
aVReset the Anchor and/or Dock properties, override the form's OnResizeEnd() method to change the size of the panel
p68213
aVIt now snaps into place as soon as the user stops dragging, there's only one paint instead of many
p68214
as(dp68215
g9
V17034
p68216
stp68217
a((dp68218
g2
(lp68219
VCtrl+Z
p68220
aVTools + Options, Text Editor, General
p68221
aVTick "Include insertion point movements in Undo list"
p68222
as(dp68223
g9
V17034
p68224
stp68225
a((dp68226
g2
(lp68227
s(dp68228
g9
V17034
p68229
stp68230
a((dp68231
g2
(lp68232
VThis is the declaration for :
p68233
aVYou have no choice, you have to implement the non-generic IEnumerable interface as well
p68234
aVYou'll get a compile error if you omit the IEnumerable
p68235
aVGetEnumerator() implementation
p68236
aVThis is baggage left over from the
p68237
aVNET 1
p68238
aVx days where generics weren't available yet and the transition period for
p68239
aVNET 2
p68240
aV0 where it needed to support interop with
p68241
aVNET 1
p68242
aVx assemblies
p68243
aVWe're stuck with it
p68244
as(dp68245
g9
V17034
p68246
stp68247
a((dp68248
g2
(lp68249
VThe C declaration isn't valid, makes it hard to give a good answer
p68250
aVYou cannot normally deal with bit fields but in this special case it works since they're all a multiple of 8 bits
p68251
aVYou need [StructLayout(LayoutKind
p68252
aVExplicit)] and use [FieldOffset(x)] for each field
p68253
aVThe badly named unsigned long, std_flags and a are at offset 0
p68254
aVb at 1
p68255
aVhigh and high_word at 2
p68256
as(dp68257
g9
V17034
p68258
stp68259
a((dp68260
g2
(lp68261
VSounds to me like the custom build rules for
p68262
aVasm files isn't enabled
p68263
aVRight-click the project, Custom Build Rules, tick "Microsoft Macro Assembler"
p68264
aVWith the "END clear" directive and disabling incremental linking I'm getting a clean build
p68265
aVIt's different for VS2010
p68266
aVRight-click project, Build customizations, tick "masm"
p68267
aVRight-click the
p68268
aVasm file, Properties, change Item Type to "Microsoft Macro Assembler"
p68269
as(dp68270
g9
V17034
p68271
stp68272
a((dp68273
g2
(lp68274
VNever implement BGW without checking the e
p68275
aVError property in the RunWorkerCompleted event handler:
p68276
aVThe somewhat mysterious invalid cast exception is caused by using the ReadyState property on a worker thread
p68277
aVWebBrowser is not threadsafe
p68278
aVCheck this answer for a way to create a WB on a worker thread
p68279
aVThat's not however a good way if you need to keep the browser visible to the user
p68280
aVYou'll have to give up on using threading in that case
p68281
aVNot a real problem, just count up the array index in the DocumentCompleted event handler
p68282
aVAlbeit that it makes little sense to flash these web pages
p68283
as(dp68284
g9
V17034
p68285
stp68286
a((dp68287
g2
(lp68288
VFatal Engine Execution Error and an access violation are both symptoms of the same problem
p68289
aVFEEE is raised when the
p68290
aVNET garbage collector detects that the internal structure of the garbage collected heap is destroyed
p68291
aVAn access violation is a hardware exception, raised by the processor when it is asked to access memory with an invalid address
p68292
aVA common cause of an AV is heap corruption
p68293
aVThese kind of mishaps are very commonly caused by unmanaged code
p68294
aVIt is also quite common for unmanaged code to have latent memory management bugs that can go unnoticed for a long time
p68295
aVThe kind of damage the bug can do tends to be quite random
p68296
aVJust running it on another operating system which has a different memory allocation pattern can be enough to trigger the bomb
p68297
aVYou have an excellent candidate for the source of the trouble
p68298
aVYou'll need to work with the COM server vendor or author to chase the bug
p68299
as(dp68300
g9
V17034
p68301
stp68302
a((dp68303
g2
(lp68304
VThat's the error you get when the DLL itself requires another COM server to be registered first or has a dependency on another DLL that's not available
p68305
aVThe Regsvr32
p68306
aVexe tool does very little, it calls LoadLibrary() to load the DLL that's passed in the command line argument
p68307
aVThen GetProcAddress() to find the DllRegisterServer() entry point in the DLL
p68308
aVAnd calls it to leave it up to the COM server to register itself
p68309
aVWhat that code does is fairly unguessable
p68310
aVThe diagnostic you got is however pretty self-evident from the error code, for some reason this COM server needs another one to be registered first
p68311
aVThe error message is crappy, it doesn't tell you what other server it needs
p68312
aVA sad side-effect of the way COM error handling works
p68313
aVTo troubleshoot this, use SysInternals' ProcMon tool
p68314
aVIt shows you what registry keys Regsvr32
p68315
aVexe (actually: the COM server) is opening to find the server
p68316
aVLook for accesses to the CLSID key
p68317
aVThat gives you a hint what {guid} it is looking for
p68318
aVThat still doesn't quite tell you the server DLL, you should compare the trace with one you get from a machine that works
p68319
aVThe InprocServer32 key has the DLL path
p68320
as(dp68321
g9
V17034
p68322
stp68323
a((dp68324
g2
(lp68325
VI can't get a repro of this problem
p68326
aVSomething that might help is to set the focus to the first control of the page instead, just like what happens when you fix the problem by clicking a control
p68327
aVAnd to do so later, after the combobox event is completed
p68328
aVUse this:
p68329
aVCall setFocusToPage instead of the Focus() method in your SelectedIndexChanged event handler
p68330
as(dp68331
g9
V17034
p68332
stp68333
a((dp68334
g2
(lp68335
VYou started off on the wrong foot
p68336
aVThere is no way that you can read an file that contains EBCDIC into a string
p68337
ag3471
aVNET text file reader is going to assume the text in the file is encoded in some way
p68338
aVLike StreamReader, it will use utf-8 by default
p68339
aVThat cannot work properly on a EBCDIC file, it will mis-interpret some of the characters and turn them into Unicode codepoints that are >= 256
p68340
aVWhich will then blow up your array indexing code
p68341
aVYou have to change the input argument to byte[]
p68342
aVRead the file with FileStream or File
p68343
aVReadAllBytes()
p68344
aVThe next problem is that your table isn't valid for
p68345
aVNET strings, they are encoded in utf-16
p68346
aVFor example, 128 isn't an ASCII code and doesn't encode a valid Unicode code point
p68347
aVNot sure what code page was used to construct the table, code page 1252 perhaps
p68348
aVAfter replacing the byte, you'd then next have to use Encoding
p68349
aVGetString() to convert that code page to Unicode
p68350
aVTo slay this dragon another way, note that the Encoding class already supports EBCDIC code pages
p68351
aVReview the docs of the Encoding
p68352
aVGetEncodings() method
p68353
aVYou'll have to know the IBM code page
p68354
aVYou can pass the proper encoding to the StreamReader(String, Encoding) constructor and won't have to write any of this code
p68355
as(dp68356
g9
V17034
p68357
stp68358
a((dp68359
g2
(lp68360
VI don't think it is any different
p68361
aVYou however have to change the version number in the registry key name HKEY_LOCAL_MACHINE\u005cSOFTWARE\u005cMicrosoft\u005cVisualStudio\u005c8
p68362
aV0\u005cLanguages\u005cFile
p68363
aVExtensions
p68364
aVVS2008 is 9
p68365
aV0, VS2010 is 10
p68366
ag2512
aVThese kind of registry hacks don't scale very well
p68367
aVIt stops working when you open the project on another machine or use a different VS version
p68368
aVAs you found out
p68369
aVJust renaming the file is the much lower pain-point
p68370
as(dp68371
g9
V17034
p68372
stp68373
a((dp68374
g2
(lp68375
VNot possible with the standard
p68376
aVNET wrappers
p68377
aVReject the path with the FileOk event
p68378
aVIf you can count on your program running on Vista and up then you could consider using the CommonFileDialog class in the Windows API Code Pack
p68379
aVIt has a FolderChanging event that can be canceled
p68380
as(dp68381
g9
V17034
p68382
stp68383
a((dp68384
g2
(lp68385
VRight-click the project in the Solution Explorer window, Custom Build Rules, tick "Microsoft Macro Assembler"
p68386
aVThis ensures that any
p68387
aVasm files you add to your project get compiled with the custom build rule for
p68388
aVasm files
p68389
aVIf you still have problems, do make sure you document the error message you see
p68390
aVThey are meant to be helpful
p68391
as(dp68392
g9
V17034
p68393
stp68394
a((dp68395
g2
(lp68396
VIf this is just a matter of detecting whether you can replace the file then it is easy
p68397
aVJust try to open it with a share flag that denies reading
p68398
aVThat's going to fail if the DLL is loaded in another process
p68399
aVUse _fsopen() or CreateFile()
p68400
aVBeware of the race condition
p68401
aVDetecting which processes have the file loaded is a harder problem, CreateToolhelp32Snapshot() and Process32First/Next plus Module32First/Next to enumerate processes and the DLLs they have loaded
p68402
aVStill tough to generate a good diagnostic for the user, the process name isn't that helpful
p68403
as(dp68404
g9
V17034
p68405
stp68406
a((dp68407
g2
(lp68408
VYou need to keep in mind why
p68409
aVNET wraps the exception with a TargetInvocationException instead of just letting the original exception through
p68410
aVThere's a really good reason for that, it isn't obvious where the real reason for the exception came from
p68411
aVWas it because the DynamicInvoke() call is borked
p68412
aVNot unlikely, there's nothing that the compiler can do to ensure that the correct arguments were passed
p68413
aVOr did the invoked target method throw all by itself
p68414
aVYou need to know both to judge the real reason for the exception
p68415
aVIntentionally hiding the TargetInvocationException is going to give you a hard time to diagnose the source of the trouble if it was indeed a problem with the DynamicInvoke() call
p68416
aVAvoid doing this
p68417
as(dp68418
g9
V17034
p68419
stp68420
a((dp68421
g2
(lp68422
VThat could be part of your problem
p68423
aVThe Show() method forces the Windows window to be created, the Handle property gets a value
p68424
aVYou then change the MdiParent property, which requires an entirely different kind of window, an MDI child
p68425
aVWhich requires Winforms to destroy the Windows window and recreate it
p68426
aVThe Handle value changes
p68427
aVMeanwhile, you've started a thread that is using the form's InvokeRequired and Invoke members
p68428
aVWhich require the Handle property to be valid
p68429
aVIt's a matter of timing whether or not that's going to blow
p68430
aVSwap the two statements
p68431
as(dp68432
g9
V17034
p68433
stp68434
a((dp68435
g2
(lp68436
VThe Visible property is a big deal in Winforms, setting it to true is what causes the native Windows window to be created
p68437
aVOne side effect of which is that setting it to false in the OnLoad method or Load event doesn't work
p68438
aVThere's nothing special about Hide(), it just sets Visible to false and thus doesn't work either
p68439
aVOverriding SetVisibleCore() is a way to do it
p68440
aVIt is however important that you still let the native window get created
p68441
aVYou cannot Close() the form otherwise
p68442
aVMake it look like this:
p68443
aVYou can now call Show() or set Visible = true to make the window visible any time you wish
p68444
aVAnd call Close() even if you never made it visible
p68445
aVThis is a good way to implement a NotifyIcon with a popup window that only is shown through a context menu
p68446
aVDo note that this has a side-effect, the OnLoad() method and Load event won't run until the first time it actually gets visible
p68447
aVYou may need to move code
p68448
as(dp68449
g9
V17034
p68450
stp68451
a((dp68452
g2
(lp68453
VIterating a two-dimensional array would normally be expensive enough to hide the cost of the single method call
p68454
aVAnd makes it likely that the method doesn't get inlined anyway, even without the attribute, just because there's too much machine code
p68455
aVBut have a look-see
p68456
aVTools + Options, Debugging, General, untick "Suppress JIT optimization on module load"
p68457
aVSelect the Release build
p68458
aVSet a breakpoint on the method call and run
p68459
aVWhen it breaks, right-click the source code and click Go To Disassembly
p68460
aVIf you see a call instruction then it didn't get inlined
p68461
aVYou might see some machine code before the call if the method takes arguments
p68462
as(dp68463
g9
V17034
p68464
stp68465
a((dp68466
g2
(lp68467
VYou are competing Big Time over the Escape key
p68468
aVAlong with the Enter key, that's a very important key in the standard Windows user interface
p68469
aVJust drop a button on form and set the form's CancelButton property to some other button, that will suck the keystroke to that button
p68470
aVTo compete with that, you have to create a control that tells Winforms that you really think that the Escape key is more important
p68471
aVThat requires overriding the IsInputKey property
p68472
aVLike this:
p68473
as(dp68474
g9
V17034
p68475
stp68476
a((dp68477
g2
(lp68478
VYou will have to use the CallingConvention property in the [DllImport] attribute
p68479
aVThe default is StdCall, you need Cdecl here since the C++ declaration didn't used __stdcall
p68480
as(dp68481
g9
V17034
p68482
stp68483
a((dp68484
g2
(lp68485
VSet the form's Enable property to false when you use this
p68486
as(dp68487
g9
V17034
p68488
stp68489
a((dp68490
g2
(lp68491
VWindows has bubbling but it is purely based on the message
p68492
aVMouseWheel bubbles for example, but neither MouseEnter nor Leave do
p68493
aVAdding bubbling behavior is technically possible but very hard to get right
p68494
aVEvery window in the parent/child tree needs to co-operate and bubble to their parent explicitly
p68495
aVIt doesn't solve the problem in this specific case anyway
p68496
aVKey issue is that there's no guarantee that a MouseLeave for a child control will ensure a MouseEnter for the parent
p68497
aVMouse move messages are not accurate enough, they don't guarantee that every traversed pixel is reported
p68498
aVWhen you have a child window close to the edge of its parent, it is quite easy to not get the MouseEnter for the parent when you move the mouse fast enough
p68499
aVThis is solved with mouse capture, the Control
p68500
aVCapture property
p68501
aVThat ensures a mouse move message is generated even when the mouse is no longer inside the window client rectangle
p68502
aVHowever, that works well when monitoring the mouse for a single window, not for multiple windows
p68503
aVAs soon as you click a control, the control itself usually wants to capture the mouse, canceling the one you started
p68504
aVA button does so for example, it wants to see the MouseUp event so it can redraw the button to show the button-up state
p68505
aVTough cookies
p68506
aVThe only decent approach I know for this particular problem is to use a Timer
p68507
aV200 msec is usually good enough, start it when the mouse enters
p68508
aVIn the Tick event handler, use Mouse
p68509
aVPosition and Control
p68510
aVPointToClient to check if the mouse is still located inside the outer window rectangle
p68511
as(dp68512
g9
V17034
p68513
stp68514
a((dp68515
g2
(lp68516
VThis is by design, an aspect of UAC called UIPI (User Interface Privilege Isolation)
p68517
aVIt prevents a non-elevated process from hijacking an elevated one through Windows messages or drag and drop
p68518
aVIt protects against shatter attacks
p68519
aVThere is a way for the elevated process to explicitly allow messages with ChangeWindowMessageFilter
p68520
aVBut not for drag and drop, it isn't message based
p68521
aVThere's currently no decent workaround for this, you have to run the process without elevation or elevate the drag source
p68522
aVOr temporarily disable UAC
p68523
as(dp68524
g9
V17034
p68525
stp68526
a((dp68527
g2
(lp68528
VYou can't see the argument/local variable values because the code is optimized
p68529
aVThey are stored in CPU registers at the time of the call, not the stack frame
p68530
aVYou can't find the needle in the haystack anymore
p68531
as(dp68532
g9
V17034
p68533
stp68534
a((dp68535
g2
(lp68536
VHopefully never, but it is a basic sanity check in case the stack frame got stomped
p68537
aVWhich isn't unlikely when you try to walk the stack in an exception handler triggered by a nasty hardware exception like AccessViolation
p68538
aVWithout that check the code would enter an endless loop, constantly finding the same stack frame back
p68539
aVAddrPC is the address of the call instruction, AddrReturn is the return address, the address of the previous call instruction (+5)
p68540
aVNot sure what "stack 0" might mean
p68541
as(dp68542
g9
V17034
p68543
stp68544
a((dp68545
g2
(lp68546
VThis is by design when you use an anonymous method like that
p68547
aVAs soon as the thread starts running, it executes the SendParams() method call
p68548
aVWhich then bombs because the "x" variable is already incremented beyond UserInfo
p68549
aVCount
p68550
aVFix:
p68551
as(dp68552
g9
V17034
p68553
stp68554
a((dp68555
g2
(lp68556
VNever use MessageBox in an event handler
p68557
aVControls often get very confused when the focus is jerked away in one of their events
p68558
aVIt keeps scrolling like this because it uses a timer to allow continuous scrolling when you lean on the next/prev button
p68559
aVEach timer tick scrolls the calendar again
p68560
aVThat timer doesn't get disabled until the mouse button goes up
p68561
aVWhich it cannot see, the message box got the mouse up message because it grabbed the focus
p68562
aVIt is a bug in the native Windows control but this just never gets put to the test
p68563
aVUsing Debug
p68564
aVWriteLine() or a temporary Console
p68565
aVWriteLine() is helpful, output goes to the Output window and doesn't mess with the control events
p68566
aVOne way to get the event fired more than once is by accidentally subscribing the event more than once
p68567
aVIn general you cannot assume how many events you'll get, there's a human clicking away at it
p68568
aVBe sure that your code is resilient to this
p68569
aVA way to work around this behavior is to delay handling the event until after the event stopped running
p68570
aVElegantly done with Control
p68571
aVBeginInvoke()
p68572
aVLike this:
p68573
as(dp68574
g9
V17034
p68575
stp68576
a((dp68577
g2
(lp68578
VClickOnce is all about installing programs without altering the configuration of the machine
p68579
aVEven if you could deploy a DLL, nobody would be able to find it back
p68580
as(dp68581
g9
V17034
p68582
stp68583
a((dp68584
g2
(lp68585
VYes, doesn't work, the Text property gets the label value after this event runs
p68586
aVWhich is why e
p68587
aVCancel works
p68588
aVSo the Text value you assigned will be overwritten again by code that runs after raising this event
p68589
aVCode inside of the native Windows control
p68590
aVThere is no AfterAfterLabelEdit event and you cannot alter e
p68591
aVLabel in the event handler, you need a trick
p68592
aVChange the Text property after the event stopped running
p68593
aVElegantly done by using Control
p68594
aVBeginInvoke()
p68595
aVLike this:
p68596
as(dp68597
g9
V17034
p68598
stp68599
a((dp68600
g2
(lp68601
VYeah, that doesn't work
p68602
aVYou are intentionally bypassing the printer driver, the chunk of code that presents a universal interface to any printer
p68603
aVWhich leaves you to deal with the peculiarities of each specific printer model
p68604
aVThere are some common interfaces, the one you used in your code is the one that dot matrix printers of old used
p68605
aVPCL is common on Hewlett Packard laser printers
p68606
aVPostscript is common on high-end printers
p68607
aVThe latter two have their own incantations to get a form feed
p68608
aVThen there's the ocean of cheap laser and ink jet printers
p68609
aVThey often don't have a well defined interface at all
p68610
aVInstead of having a processor inside the printer that translates printer commands to dots on paper, they let the printer driver do all the hard work
p68611
aVYou'll never get one of those going, the interface is proprietary and undocumented
p68612
aVThe printer driver is your friend here
p68613
aVPrintDocument the class to use it
p68614
aVGetting a form feed is easy, just set e
p68615
aVHasMorePages = true and exit the PrintPage event handler
p68616
aVYou already saw the StreamPrinter class I linked
p68617
as(dp68618
g9
V17034
p68619
stp68620
a((dp68621
g2
(lp68622
VYou can't, you won't have write access to this file
p68623
aVAn app
p68624
aVconfig file is not a database, write it somewhere else
p68625
aVA file, a database, whatever you like
p68626
as(dp68627
g9
V17034
p68628
stp68629
a((dp68630
g2
(lp68631
VAssuming that the CalculateScore Function returns a double
p68632
aVNo, it's the other way around
p68633
aVDeclaring it As Double will always be as fast as is possible
p68634
aVOmitting the declaration will only be as fast when Option Infer On is in effect
p68635
aVIf it is not then it will be a variable of type Object
p68636
aVThe double will be boxed
p68637
aVUnboxing is pretty expensive in VB
p68638
aVNET because it allows unboxing to any compatible type, not just Double
p68639
aVUnlike C# which throws an exception if there's a mismatch
p68640
as(dp68641
g9
V17034
p68642
stp68643
a((dp68644
g2
(lp68645
VNotepad doesn't know anything about the Winforms TreeNode class
p68646
aVUse Clipboard
p68647
aVSetText() instead:
p68648
as(dp68649
g9
V17034
p68650
stp68651
a((dp68652
g2
(lp68653
VUsing InvokeRequired like this is an anti-pattern
p68654
aVYou know that this method is getting called from a thread, InvokeRequired should always be true
p68655
aVNow you can use it to troubleshoot your problem
p68656
aVIf it is false then there's something seriously wrong
p68657
aVThrow an exception, the debugger will stop and let you find out why it isn't working properly
p68658
aVAnd always call Invoke(), invoke to a little helper method that does the rest of LoadReports()
p68659
aVAlso note that you are using it wrong in the rest of your code
p68660
aVYou know that the remainder of LoadReports() runs on the UI thread, you used Invoke()
p68661
aVNo point in testing it again, including inside SetCtlVisible()
p68662
aVThe typical reason for getting the bomb is because the thread is running LoadReports() too soon, before the form's window is created
p68663
aVYou need to interlock that
p68664
aVThe form's Load event is the signal
p68665
as(dp68666
g9
V17034
p68667
stp68668
a((dp68669
g2
(lp68670
VYou are leaking window handles
p68671
aVRun TaskMgr
p68672
aVexe, Processes tab
p68673
aVView + Select Columns, tick USER objects
p68674
aVWatch that column for your process
p68675
aVYou'll see it climbing up while you use the program, it bombs when the number reaches 10000
p68676
aVThis happens when you don't call Dispose() on controls that you remove in your code
p68677
aVEither with Controls
p68678
aVClear or Controls
p68679
aVRemove
p68680
as(dp68681
g9
V17034
p68682
stp68683
a((dp68684
g2
(lp68685
VYou need the
p68686
aVxml file that contains the IntelliSense info for the assembly
p68687
aVMake sure it is stored in the same directory as the reference assembly for these libraries, it has the same name as the assembly but with the
p68688
aVxml filename extension
p68689
aVMaybe you forgot to copy it or cleaned-up too aggressively
p68690
as(dp68691
g9
V17034
p68692
stp68693
a((dp68694
g2
(lp68695
VAssuming Windows: use ReadConsoleInput()
p68696
aVThat gets you an array of INPUT_RECORD with keyboard and mouse events
p68697
aVUse GetStdHandle() to get the stdin handle you'll need to call this function
p68698
as(dp68699
g9
V17034
p68700
stp68701
a((dp68702
g2
(lp68703
VThat's not how it works
p68704
aVYou are capturing the screen, not directly the output of the program
p68705
aVThe setting of the video adapter matters, it will be 32bpp for any recent machine
p68706
aVMaybe 16bpp for old ones
p68707
aVTrying to copy such a non-indexed pixel format into a bitmap with a palette isn't supported
p68708
aVThe algorithm to create a palette that provides the best color fidelity is computationally quite non-trivial
p68709
aVJust don't bother, the 32bpp image will be indistinguishable from the program's output
p68710
aVIf squeezing the file is really important then store it as a
p68711
aVgif
p68712
aVIt isn't going to look great, the GIF encoder uses dithering to compress the color table
p68713
as(dp68714
g9
V17034
p68715
stp68716
a((dp68717
g2
(lp68718
VDelegate objects are garbage collected objects, just like any other non-value type in
p68719
aVNET
p68720
aVWhich means that the garbage collector can move them
p68721
aVWhich means that getting their address cannot work, the address will change when the GC compacts the heap
p68722
aVI'm guessing you need to do this to pass unmanaged code some kind of reference to the delegate
p68723
aVA handle is the typical solution
p68724
aVJust keep a counter around that you increment each time you create a new object
p68725
aVStore it in a  and pass the counter value to the unmanaged code
p68726
aVMarshal::GetFunctionPointerForDelegate() is another approach, the unmanaged code can now directly invoke the delegate target
p68727
aVNot a long but a void*
p68728
aVYou do however still have to store the delegate object somewhere safe so it won't get garbage collected
p68729
aVI recommend the former
p68730
as(dp68731
g9
V17034
p68732
stp68733
a((dp68734
g2
(lp68735
VWrite an event handler for AppDomain
p68736
aVCurrentDomain
p68737
aVUnhandedException and log or display the value of e
p68738
aVExceptionObject
p68739
aVToString()
p68740
aVThat's good enough to give you enough info about the unhandled exception 95% of the time without having to drag a debugger to the machine
p68741
as(dp68742
g9
V17034
p68743
stp68744
a((dp68745
g2
(lp68746
VIrp->MdlAddress is probably NULL, use Irp->UserBuffer instead
p68747
aVGet familiar with the kernel debugger and diagnosing blue screens
p68748
aVYou'll need it
p68749
as(dp68750
g9
V17034
p68751
stp68752
a((dp68753
g2
(lp68754
VYou bought a commercial software license and it doesn't tell you how to add its controls to the toolbox
p68755
aVThat's probably because it doesn't have any controls
p68756
aVIf it does, right-click the toolbox, Choose Items, click the Browse button
p68757
aVGet support from the vendor if that doesn't help, you paid them good money for it
p68758
as(dp68759
g9
V17034
p68760
stp68761
a((dp68762
g2
(lp68763
VI'll work from the assumption that this was intentional
p68764
aVCouple of things you have to do to meet the STA contract
p68765
aVYou have to pump a message loop, call Application
p68766
aVRun()
p68767
aVAnd you cannot pause, that blocks any marshaled call and makes deadlock very likely
p68768
aVNot a problem, when you pump a message loop you're always in an idle 'pause' state
p68769
aVMake code run just as you'd normally do in a GUI main thread
p68770
aVApplication
p68771
aVExitThread ends the thread
p68772
as(dp68773
g9
V17034
p68774
stp68775
a((dp68776
g2
(lp68777
VWould be an example
p68778
aVUsing a string to initialize the value is a necessary evil, the kind of types you can use in an attribute constructor are very limited
p68779
aVOnly the simple value types, string, Type and a one-dimensional array of them
p68780
aVTo make this work, you have to write a TypeConverter for your struct:
p68781
aVDocumentation on type converters in the MSDN library isn't great
p68782
aVUsing the
p68783
aVNET type converters whose source you can look at with the Reference Source or reverse-engineer with Reflector is a great starting point to get your own working
p68784
aVWatch out for culture btw
p68785
as(dp68786
g9
V17034
p68787
stp68788
a((dp68789
g2
(lp68790
VThis problem is documented in the fix-list for VS2010 SP1
p68791
aVThe feedback article is here
p68792
aVBeware that SP1 is still in beta right now so avoid installing it on important production machines
p68793
aVDownload is here
p68794
as(dp68795
g9
V17034
p68796
stp68797
a((dp68798
g2
(lp68799
VWhen you use /EHsc, the compiler will only emit code for exception filters when it can detect that the code wrapped in the try {} block might throw a C++ exception
p68800
aVAn exception filter ensures that the destructor of any local C++ objects get called when the stack is unwound while handling an exception
p68801
aVIt makes RAII work
p68802
aVThat's an optimization, space and time for x86 code, space for x64 code
p68803
aVSpace because it can omit the exception filter code, which is modest btw
p68804
aVTime because on x86 it can avoid registering the exception filter upon entering the try {} block
p68805
aVVery modest btw
p68806
aVx64 uses a different way to find exception filters, it is table-based
p68807
aVThe key phrase in the first paragraph is "might throw a C++ exception"
p68808
aVOn Windows there are other sources of exceptions
p68809
aVLike the "a" in /EHa, asynchronous exceptions that are raised by the hardware
p68810
aVThings like floating point exceptions, division by zero, and the all-mighty access violation exception
p68811
aVBut also notably the kind of exceptions that are raised by code that you might interop with
p68812
aVLike managed code, basically anything that runs in a VM
p68813
aVWhen you want to make your objects safe for these kind of exceptions as well then you'll need to use /EHa, that tells the compiler to always register the exception filter
p68814
aVBeware of a nasty side-effect of /EHa, it makes catch(
p68815
aVswallow all exceptions
p68816
aVIncluding the ones you should never catch, like AV and SO
p68817
aVLook at  and _set_se_translator() if that's important to you
p68818
as(dp68819
g9
V17034
p68820
stp68821
a((dp68822
g2
(lp68823
VPrintForm only supports printing an exact copy of what you see on the screen
p68824
aVThe print-out will have a visible scrollbar as well
p68825
aVAnd of course not show the controls that are scrolled out of view
p68826
aVThere's an excellent workaround for this, use the PrintDocument component
p68827
aVThe print-out will look much better as well, not the grainy bitmap you get out of PrintForm
p68828
aVYou do however have to write the code for the PrintPage event handler yourself
p68829
aVA fair amount of code, but it isn't hard code
p68830
aVUse PrintPreviewDialog so that you don't waste a tree debugging and fine-tuning your code
p68831
as(dp68832
g9
V17034
p68833
stp68834
a((dp68835
g2
(lp68836
VThis is the traditional user interface for a console mode program
p68837
aVIt is quite inappropriate for a GUI app, the kind that Winforms let you build
p68838
aVThe closest approximation is buttons for each menu item
p68839
aVSo the user can just click one directly, rather than having to type a number
p68840
aVThe keyboard still works too, pressing Tab to move through the buttons, Space to activate one
p68841
aVLook around a bit at user interfaces of other programs you use
p68842
aVNote their use of a menu and a toolbar
p68843
as(dp68844
g9
V17034
p68845
stp68846
a((dp68847
g2
(lp68848
VListView already has the CheckedIndices property
p68849
aVYou probably ought to use it directly, but you can get a List<> out of it with a Linq one-liner:
p68850
as(dp68851
g9
V17034
p68852
stp68853
a((dp68854
g2
(lp68855
VThis generates a StackOverflowException
p68856
aVYour property getter is returning itself and the property setter is assigning itself
p68857
aVGive it a different name
p68858
aVFurthermore, you want to assign the image, not the control
p68859
aVFix:
p68860
aVNext time you ask a question like this, be sure to document the kind of error you see
p68861
aVExceptions are meant to help you
p68862
aVOr to help us help you
p68863
as(dp68864
g9
V17034
p68865
stp68866
a((dp68867
g2
(lp68868
VAre you missing an assembly reference
p68869
aVIt's one of those psychic error messages that tends to be right 95% of the time
p68870
aVGo back to the blog post and note this line:
p68871
aVUsage is very simple, you must reference the `gmcs
p68872
aVexe' assembly
p68873
as(dp68874
g9
V17034
p68875
stp68876
a((dp68877
g2
(lp68878
VOh Lord no
p68879
aVYou make it dramatically slower by using that flag
p68880
aVIt bypassing the file system cache, that wonderful piece of code that can guess with almost psychic accuracy that you'll want to read sector N+1 after reading N
p68881
aVAnd just pre-loads it if it is cheap to get
p68882
aVEspecially bad for writing, which is why the option exists, you don't get the lazy write-back
p68883
aVWhich means that your program can only run as fast as the disk can write
p68884
aVWhich is very, very slow
p68885
aVThe advantage of the flag is that you can be sure it was written
p68886
aVHelps implement transactional disk updates, the kind that dbase engines care about
p68887
aVBut try this for yourself to see the effect
p68888
as(dp68889
g9
V17034
p68890
stp68891
a((dp68892
g2
(lp68893
VThe Form class doesn't have a property named "picbox"
p68894
aVOnly your custom designed form does
p68895
aVMake your code look similar to this:
p68896
aVWhere "Form2" is the type name of your form class
p68897
as(dp68898
g9
V17034
p68899
stp68900
a((dp68901
g2
(lp68902
VForeach is a fairly big deal, its underlying plumbing is a very simple forward-only iterator that doesn't require having to know up front how many items are in the collection
p68903
aVIEnumerator<>
p68904
aVWhich is in general is a rather nasty mismatch with a ProgressBar
p68905
aVYou can only meaningfully update the standard one when you know up front how many items you're iterating
p68906
aVSo you can set its Maximum property
p68907
aVIf that's possible then you no doubt have access to a Count property and have an indexer as well
p68908
aVWhich then lets you use a for() statement, problem solved
p68909
aVBut it is pretty common that you have no idea up front how many items there are to iterate
p68910
aVTypical with dbase queries for example
p68911
aVSince you can't find out how long it might take to iterate, you've only got one option on the progress bar: Style = Marquee
p68912
aVThe "I'm not dead, I'm working" way of reporting progress
p68913
aVProblem solved
p68914
as(dp68915
g9
V17034
p68916
stp68917
a((dp68918
g2
(lp68919
VThere's your problem, you didn't call imgPhoto
p68920
aVDispose() first
p68921
aVThe file is locked until the finalizer thread runs, that can take a while
p68922
aVUse the using statement to avoid mistakes like this
p68923
as(dp68924
g9
V17034
p68925
stp68926
a((dp68927
g2
(lp68928
VWrite an event handler for AppDomain
p68929
aVCurrentDomain
p68930
aVUnhandledException
p68931
aVLog or display the value of e
p68932
aVExceptionObject
p68933
aVToString() to get the exception message and the stack trace
p68934
as(dp68935
g9
V17034
p68936
stp68937
a((dp68938
g2
(lp68939
VWrong name
p68940
aVAdding the following keys worked on my machine with VS2008:
p68941
as(dp68942
g9
V17034
p68943
stp68944
a((dp68945
g2
(lp68946
VThe syntax is a bit, well, odd
p68947
aVYou have to list multiple constraints with { braces }
p68948
aVLike this:
p68949
as(dp68950
g9
V17034
p68951
stp68952
a((dp68953
g2
(lp68954
VYou can use Console
p68955
aVSetBufferSize() to make the console buffer larger:
p68956
aV--Small Addition--
p68957
aVIf hoping to get the maximum possible buffer:
p68958
aVYou're not allowed anything >= Int16
p68959
aVMaxValue
p68960
as(dp68961
g9
V17034
p68962
stp68963
a((dp68964
g2
(lp68965
VYou are casting yourself into trouble
p68966
aVThe 3rd and 4th arguments are double, not int
p68967
aVThe 6th argument is an object, not an int, pass nullptr
p68968
aVThe array is not an array of a managed type, use Byte
p68969
aVThe last argument is an int,  not an unsigned int
p68970
aVI'd have to recommend you review your programming style
p68971
as(dp68972
g9
V17034
p68973
stp68974
a((dp68975
g2
(lp68976
VWell, the alternative will likely work too
p68977
aVBut the Marshal
p68978
aVAllocHGlobal sample isn't complete, you've now got the data in unmanaged memory
p68979
aVYou still need to do work to get it into a managed object (array) so you can easily access it, you must call Marshal
p68980
aVCopy()
p68981
aVInefficient since that copies the data twice
p68982
aVAnd don't forget to call Marshal
p68983
aVFreeHGlobal()
p68984
aVThe fixed sample does the same thing as the vendor sample, it implicitly pins the memory
p68985
aVAwkwardness here is that the API takes an IntPtr, not a byte*
p68986
aVAnd you must change compile settings to allow the unsafe keyword
p68987
aVIt isn't otherwise more efficient
p68988
aVYou're not ahead by doing this differently
p68989
as(dp68990
g9
V17034
p68991
stp68992
a((dp68993
g2
(lp68994
VYou have to call WaitForDebugEvent(), you do so in a loop
p68995
aVIf you're not interested in the notification then simply ignore it
p68996
aVJust omit the case in your switch statement on DEBUG_EVENT
p68997
aVdwDebugEventCode
p68998
aVThat's filtering it
p68999
as(dp69000
g9
V17034
p69001
stp69002
a((dp69003
g2
(lp69004
VYes, you create the image list over and over again
p69005
aVAnd every item has the same imageIndex, 0
p69006
aVSo the items can only ever have the same icon, the last one you added
p69007
aVThis will solve the problem:
p69008
aVBut don't do this if the listview contains a lot of items
p69009
aVThe image list will get quite large with, probably, a lot of duplicates
p69010
aVWhich makes it slow
p69011
aVExplicitly managing the image list then becomes important
p69012
aVYou can fill the image list up front with the designer, maybe that's appropriate
p69013
as(dp69014
g9
V17034
p69015
stp69016
a((dp69017
g2
(lp69018
VNot sure what you fear
p69019
aVBoth OnTextChanged and RunWorkerCompleted run on the UI thread
p69020
aVIt won't be re-entrant, you don't need the lock either
p69021
aVEither method can only start running when the UI thread is idle, pumping the message loop
p69022
as(dp69023
g9
V17034
p69024
stp69025
a((dp69026
g2
(lp69027
VWell, the
p69028
aVNET framework is free, recommended
p69029
aVNET 4
p69030
aV0 supports the System
p69031
aVIO
p69032
aVMemoryMappedFiles namespace classes
p69033
aVShared memory is a fairly drastic impedance mismatch with the notion of a garbage collector, that's why it took a while
p69034
aVUnless you use pointers, copying from the GC heap to the MMF view is inevitable
p69035
aVThe other IPC mechanisms use shared memory too, it just isn't explicit since its built into the kernel
p69036
aVThis all runs at roughly the same speed, a microsecond to setup the mapping and then just the bus bandwidth to do the memory-to-memory copy
p69037
aVFive gigabytes per second is the slowest you'll run into
p69038
as(dp69039
g9
V17034
p69040
stp69041
a((dp69042
g2
(lp69043
VWell, yes, you do:
p69044
aVWhich closes the dialog, it will only stay running as long as its DialogResult property is None
p69045
aVIt isn't strictly necessary, you can also use the designer
p69046
aVChange the button's DialogResult property, now you don't need to write the code
p69047
aVThat is however not often appropriate, you usually want to check if the user provided all the information you require
p69048
aVYmmv
p69049
as(dp69050
g9
V17034
p69051
stp69052
a((dp69053
g2
(lp69054
VThere's no practical way to do this, the project file format for C++ projects has dramatically changed in VS2010
p69055
aVAs a result of a re-engineering effort to make them use MSBuild to build projects, just like the other supported languages
p69056
aVEven the filename extension has changed, from
p69057
aVvcproj to
p69058
aVvcxproj
p69059
aVYou'll need to re-create the project in VS2008
p69060
as(dp69061
g9
V17034
p69062
stp69063
a((dp69064
g2
(lp69065
VIt is caused by a mismatch on the calling convention, the default for [DllImport] is Stdcall but the C compiler's default is Cdecl
p69066
aVUse the CallingConvention property in the declaration
p69067
aVThat's not the only problem though, this code will crash on Vista and Win7
p69068
aVReturning a string from a C function is quite troublesome, there's a memory management problem
p69069
aVIt isn't clear who is responsible for freeing the string buffer
p69070
aVYou are returning a literal now but that's going to stop being useful pretty soon
p69071
aVNext stop is using malloc() for the return string with the intent for the caller to call free()
p69072
aVThat's not going to work, the pinvoke marshaller cannot call it since it doesn't know what heap the C code is using
p69073
aVIt will call Marshal
p69074
aVFreeCoTaskMem()
p69075
aVThat's wrong, the string wasn't allocated by CoTaskMemAlloc()
p69076
aVThat goes unnoticed on XP and earlier, other than the very hard to diagnose memory leak this causes
p69077
aVAnd goes kaboom on Vista and Win7, they have a much more stricter memory manager
p69078
aVYou need to rewrite the C function like this:
p69079
aVNow the caller supplies the buffer, through the output argument, there's no longer a guess who owns the memory
p69080
aVYou use StringBuilder in the C# declaration
p69081
aVBe careful to use the outLen argument in your C code so that you can be sure not to overflow the buffer
p69082
aVThat corrupts the garbage collected heap, crashing the app with a Fatal Execution Engine Error
p69083
as(dp69084
g9
V17034
p69085
stp69086
a((dp69087
g2
(lp69088
VThe compiler is objecting because you're trying to store a managed object in an unmanaged class
p69089
aVThat cannot work, the garbage collector needs to be able to find object references so it can properly collect garbage
p69090
aVAnd since it cannot find unmanaged objects, it cannot find the managed reference either
p69091
aVI'd strongly advice to not use STL/CLR, it combines all the disadvantages of STL with those of the CLR
p69092
aVIf you really, really want to use vector<> then gcroot<> can solve the problem
p69093
aVHowever, using System::Collections::Generic::List<> is by far the best solution
p69094
as(dp69095
g9
V17034
p69096
stp69097
a((dp69098
g2
(lp69099
VCrystal Reports is no longer included with VS2010
p69100
aVI suspect that might have something to do with it
p69101
aVHere's a blog post from the company that owns it now that tells you why you should be happy about that
p69102
aVI don't understand much of it, but then again I also don't understand why companies like SAP are still in business
p69103
as(dp69104
g9
V17034
p69105
stp69106
a((dp69107
g2
(lp69108
VThat's not how the volume control window works
p69109
aVIt disappears when you click anywhere, including the notification icon
p69110
aVThe icon isn't relevant
p69111
aVThis is a standard Win32 trick, it captures the mouse so it can see clicks outside of its window
p69112
aVMouse
p69113
aVCapture in WPF
p69114
aVNot nearly as easy to do because it requires an IInputElement instead of a window handle
p69115
as(dp69116
g9
V17034
p69117
stp69118
a((dp69119
g2
(lp69120
VThis looks like a bug in GDI+
p69121
aVI'm guessing it doesn't handle running out of resources real well
p69122
aVWindows gives a process a quota on things like handles, windows and GDI resources like pens and brushes
p69123
aVWhen it exceeds 10000 of them, it refuses to give anymore, assuming that a leak in the program is the problem
p69124
aVYou can see this with Taskmgr
p69125
aVexe, Processes tab
p69126
aVView + Select Columns, tick Handles, USER objects and GDI objects
p69127
aVOnce one of these get close to the quota, all manner of misery starts to happen
p69128
aVUsually painting oddities btw
p69129
aVBut certainly code can crash when it doesn't check that the API call returns NULL
p69130
aVAll too common in unmanaged code
p69131
aVGDI+ was much improved for Vista, devs really shouldn't be running XP anymore these days
p69132
aVWin7 is quite nice
p69133
aVAlso the only real way to learn to deal with UAC and session 0 isolation
p69134
aVAs a possible workaround, ask at superuser
p69135
aVcom how to increase the default process quota
p69136
aVIts somewhere in the registry
p69137
as(dp69138
g9
V17034
p69139
stp69140
a((dp69141
g2
(lp69142
VNo idea what you are asking
p69143
aVMaybe this: I keep it in the VS Tools menu so it is always handy and opens in the right folder, even for temporary projects
p69144
aVTools + External Tools, Add:
p69145
aVTitle = "Command prompt"
p69146
aVCommand = cmd
p69147
aVexe
p69148
aVArguments = /k "c:\u005cProgram Files\u005cMicrosoft Visual Studio 9
p69149
aV0\u005cVC\u005cvcvarsall
p69150
aVbat" x86
p69151
aVInitial Directory = $(BinDir)
p69152
aVTweak as necessary for other VS editions or platforms
p69153
as(dp69154
g9
V17034
p69155
stp69156
a((dp69157
g2
(lp69158
VIt's a typo, but that definitely isn't a ushort, it's an uint
p69159
aVDon't use FieldOffset either, let the compiler figure it out
p69160
aVNow Marshal
p69161
aVSizeOf() will return 24, the proper amount of padding is inserted
p69162
aVThe  member should be IntPtr btw
p69163
as(dp69164
g9
V17034
p69165
stp69166
a((dp69167
g2
(lp69168
Vthe IDE fails with an Out of memory exception
p69169
aVNo, your program fails with that exception, not the IDE
p69170
aVYou'd have to run editbin
p69171
aVexe in a post build event to set the flag:
p69172
aVThat will not work on the vshost
p69173
aVexe version, you'll have to turn off the hosting process
p69174
aVProject + Properties, Debug tab
p69175
as(dp69176
g9
V17034
p69177
stp69178
a((dp69179
g2
(lp69180
VThis is a
p69181
aVNET implementation detail
p69182
aVHaving instance operator overloads is a C++ feature, the code analyzer chokes on it
p69183
aVThe
p69184
aVNET way is to have operator overloads as static functions
p69185
aVNotably C# requires this
p69186
aVSolve your problem similar to this:
p69187
as(dp69188
g9
V17034
p69189
stp69190
a((dp69191
g2
(lp69192
VThat's the kind of perf counter you have to sample yourself
p69193
aVProcessor time is a measure over an interval
p69194
aVIt tells you how long the processor was turned off, versus it running at 100%
p69195
aVThe ratio is the value you get, times 100
p69196
aVOne second is the typical interval time, like TaskMgr
p69197
aVexe and Perfmon uses
p69198
aVThe smaller you make the interval, the 'noisier' it gets
p69199
aVDown to one sample, like you did, where you get no data at all since there wasn't an interval
p69200
aVFix:
p69201
as(dp69202
g9
V17034
p69203
stp69204
a((dp69205
g2
(lp69206
VYou are doing battle with something that's called 'call context' in the
p69207
aVNET framework
p69208
aVI need to wave my hands a bit at it because I don't understand it completely
p69209
aVThe basic premise is that the current principal is a Big Deal in
p69210
aVNET security
p69211
aVIt makes sandboxing work, helping to isolate code so it cannot do anything unsafe
p69212
aVCode running in a browser, a phone, a plug-in, that sort of thing
p69213
aVThe current principal is associated with a thread, Thread
p69214
aVCurrentPrincipal property
p69215
aVThat makes Control
p69216
aVBegin/Invoke() tricky, some sort of plugin could hijack the rights of the program's main thread by using it to run code on that thread
p69217
aVThe call context is a counter-measure against this
p69218
aVYour code is updating the principal of the call context, not the thread
p69219
aVAfter the invoked call is complete that falls in the bit bucket, it doesn't flow back to the originating thread in the case of Control
p69220
aVInvoke()
p69221
aVFinding a workaround for this boggles me right now
p69222
aVIt really has to be code that originates from your main thread that sets the property, nothing that gets invoked
p69223
aVI can only think of a silly fix, using a one millisecond Timer:
p69224
aVIt does work
p69225
aVBeware the possible race
p69226
as(dp69227
g9
V17034
p69228
stp69229
a((dp69230
g2
(lp69231
VCalling SetForegroundWindow() on an invisible window isn't going to work
p69232
aVThere are many other possible failure mode, FindWindow() is a miserable one when you start passing null
p69233
aVDon't invent this yourself,
p69234
aVNET already has great built-in support for single instance apps
p69235
aVYou can even get a notification when a 2nd copy starts and pass the command line
p69236
aVWhich is what you want here, simply restore the window instead of hacking the API
p69237
aVThe code you need is here
p69238
as(dp69239
g9
V17034
p69240
stp69241
a((dp69242
g2
(lp69243
VYour code snippet isn't good enough to see where "ret_5" is located
p69244
aVYou'll get an automatic crash if it is a member of a class
p69245
aVThe ecx register stores the "this" pointer, you're messing it up
p69246
aVNot sure what this does, sound to me like you need to use the _ReturnAddress intrinsic
p69247
aVIt returns the address of the instruction after the call instruction that called this code
p69248
aVAssign it to an unsigned char*, no need for assembly this way
p69249
as(dp69250
g9
V17034
p69251
stp69252
a((dp69253
g2
(lp69254
VI don't know how many stack frames will be on the stack that are owned by Detours code
p69255
aVEasy to find out in the debugger, the odds are good that there are none
p69256
aVThat makes it easy, use the _ReturnAddress intrinsic to get the caller's address
p69257
aVVirtualQuery() to get the base address, cast it to HMODULE and use GetModuleFileName()
p69258
aVWell, the non-detoured one :)
p69259
aVIf there are Detours stack frames then it gets a lot harder
p69260
aVStackWalk64() to skip them, perilous if there are FPO frames present
p69261
as(dp69262
g9
V17034
p69263
stp69264
a((dp69265
g2
(lp69266
VIt is declared in a namespace, as it should
p69267
aVFix:
p69268
as(dp69269
g9
V17034
p69270
stp69271
a((dp69272
g2
(lp69273
V[AssemblyVersion] is a very big deal in
p69274
aVNET
p69275
aVEvery type in your program is imprinted with the assembly version, it is part of the type identity
p69276
aVIn other words, when the version of your type changes then you should also change the assembly version
p69277
aVThis forces all other assemblies that use your type to be recompiled
p69278
aVOne thing you can do is to let the build system automatically increment the version
p69279
aVYou can't call this 'managing the version' by any stretch of imagination
p69280
aVBecause now just rebuilding your assembly, even without making any change in the source code, will make your assembly incompatible with other code that uses the types in that assembly
p69281
aVClearly this can only work well if you recompile all the code in your solution
p69282
aVWell, that's not great unless you like sword fighting
p69283
aVFurthermore, sometimes you want to make a simple bug-fix in your code
p69284
aVThe result is an assembly that's still 100% compatible with the original version
p69285
aVAnd you don't need nor want to recompile everything else that uses it
p69286
aVYou just want to send that one assembly to your customer
p69287
aVClearly that can only work well if you don't let the version increment automatically
p69288
aVSo what you really need is some kind of tool that can magically determine that your source code, the publicly visible part of it, is no longer compatible with a previous version
p69289
aVOr the changes you made to the non-visible part of it are changing the behavior of the code too much to disallow other code that use your types to continue to use it without some changes in their code
p69290
aVThere's only one tool that I know of that can do this, the one we have between our ears
p69291
as(dp69292
g9
V17034
p69293
stp69294
a((dp69295
g2
(lp69296
VYou can't do it with the designer but you can do it in code:
p69297
as(dp69298
g9
V17034
p69299
stp69300
a((dp69301
g2
(lp69302
VThere's no good way to do this, you can't inject the #pragma warning disable in the auto-generated file
p69303
aVAlso a problem with Winforms designer files btw
p69304
aVProject + Properties, Build tab, Suppress warnings = 1591
p69305
aVBut that will disable the diagnostic also where you might want it turned on
p69306
aVA #pragma warning restore doesn't fix that
p69307
as(dp69308
g9
V17034
p69309
stp69310
a((dp69311
g2
(lp69312
VI see it
p69313
aVOuch, my condolences
p69314
aVTheir advice is about as best as it is going to get if you don't want to compile with /MD
p69315
aVI think I know the source of the problem, this isn't that easy to fix for them either
p69316
aVIt's going to require them getting the VS2010 CRT header file fixed first, then recompile and issue an SDK update
p69317
aVThat takes some major doing
p69318
aVIt is getting linked because it is listed in the "Core Windows Libraries" property sheet
p69319
aVView + Property Manager to see it
p69320
aVNot linking it is not an option, you are probably actually using it when you #include
p69321
aVThe Vista version indeed doesn't have the same problem, it was probably built with an earlier version of VS
p69322
aVProject + Properties, Linker, Input, Additional Dependencies = "c:\u005cprogram files\u005cmicrosoft sdks\u005cwindows\u005cv6
p69323
aV0a\u005clib\u005codbccp32
p69324
aVlib"
p69325
aVThis injects the vista version before the 7
p69326
aV0 version
p69327
aVYou may have to live with this for a while, be sure to keep VS2008 installed on your build machines
p69328
as(dp69329
g9
V17034
p69330
stp69331
a((dp69332
g2
(lp69333
VOther than side effects they may have, no, there's nothing in the metadata for it
p69334
aVThey only have an affect at compile time
p69335
aVEasy enough to make it have such a side effect, you could wrap a dummy class with it and then at runtime use Reflection to see if it's there
p69336
as(dp69337
g9
V17034
p69338
stp69339
a((dp69340
g2
(lp69341
VNot so much reliability, it throttles access
p69342
aVThe stated 'safe' usage is less than 50 requests per minutes and less than 1000 characters per requests
p69343
aVLooks like there are licensing options to increase this
p69344
aVThe canonical answer is here
p69345
as(dp69346
g9
V17034
p69347
stp69348
a((dp69349
g2
(lp69350
VUse generics here so the function can handle any type:
p69351
aVSample usage:
p69352
as(dp69353
g9
V17034
p69354
stp69355
a((dp69356
g2
(lp69357
VYou'll need to give the panel the same kind of treatment, except that you return HTTRANSPARENT
p69358
aVThat makes it transparent to hit tests and the form will get the message
p69359
aVNow it works
p69360
aVAdd a class to your project and paste the code shown below
p69361
aVCompile
p69362
aVReplace your existing panel with this one
p69363
as(dp69364
g9
V17034
p69365
stp69366
a((dp69367
g2
(lp69368
V30 seconds is an eternity
p69369
aVMuch easier to put the FreeHGlobal in a finally block to ensure it's released
p69370
aVSaves you from having to do to do the finalizer and IDisposable song and dance
p69371
aVWell, the client's code
p69372
aVFavoring the caching over the heap churn doesn't start to pay off until it gets in the millisecond range
p69373
as(dp69374
g9
V17034
p69375
stp69376
a((dp69377
g2
(lp69378
VThis is purely a deployment problem, you should never have to maintain different projects
p69379
aVIt is an awkward one though, and boo on Oracle for not taking care of this themselves
p69380
aVAnother consideration is that this assembly really should be ngen-ed on the target machine
p69381
aVSome options
p69382
aVCreate two installers, one for x64 and one for x86
p69383
aVThe customer picks the right one, based on the operating system she uses
p69384
aVSimple enough, you just copy the right file
p69385
aVDeploy both assemblies to the GAC
p69386
aVNow it is automatic,
p69387
aVNET picks the right one on either type of machine
p69388
aVBig companies should almost always use the GAC so they can deploy security updates, not sure why Oracle doesn't do this
p69389
aVDeploy the assemblies to a x86 and x64 subdirectory of the install directory
p69390
aVYou'll need to write an AppDomain
p69391
aVAssemblyResolve event handler that, based on the value of IntPtr
p69392
aVSize, picks the right directory
p69393
aVChange the target platform on your EXE project to x86
p69394
aVGiven that your code needs to work on a 32-bit machine as well as on a 64-bit machine, there isn't/shouldn't be a reason to build for AnyCPU
p69395
as(dp69396
g9
V17034
p69397
stp69398
a((dp69399
g2
(lp69400
VSounds to me like your WPF app is loading a class library that references a Silverlight assembly
p69401
aVThat cannot work, cats and dogs
p69402
aVIf an assembly is referenced by both a WPF and a Silverlight app then it has to be compiled twice with different framework assembly references
p69403
aVThat takes two projects
p69404
aVKeeping the WPF and the Silverlight stuff separate in different solutions is the best way to keep out of trouble
p69405
as(dp69406
g9
V17034
p69407
stp69408
a((dp69409
g2
(lp69410
VIt's pretty useless, doesn't get much use inside the
p69411
aVNET framework either
p69412
aVIt merely is preferable over the alternative: making a copy of the array segment
p69413
aVThat's expensive
p69414
as(dp69415
g9
V17034
p69416
stp69417
a((dp69418
g2
(lp69419
VSounds like you've got a slow or malfunctioning Internet connection
p69420
aVTools + Options, Debugging, Symbols, untick "Microsoft Symbol Servers"
p69421
as(dp69422
g9
V17034
p69423
stp69424
a((dp69425
g2
(lp69426
VTo compile an application that uses
p69427
aVthis function, define _WIN32_WINNT as
p69428
aV0x0501 or later
p69429
aVFor more information,
p69430
aVsee Using the Windows Headers
p69431
as(dp69432
g9
V17034
p69433
stp69434
a((dp69435
g2
(lp69436
VThe problem is that it isn't slow enough
p69437
aVYou are calling ReportProgress() too often
p69438
aVIt depends on how much work the UI thread does, but do it roughly several hundred times per second and the UI thread freezes, not getting around do doing its normal duties anymore
p69439
aVLike painting the list view
p69440
aVYour code is very expensive, clearing and repopulating the ListView requires lots of Windows messages
p69441
aVAt least don't do it for one movie at a time, batch it up and use the AddRange() method
p69442
aVOne call per 50 msec is ideal, a human cannot read any faster than that anyway
p69443
aVSlow down the worker thread by using Invoke() instead of BeginInvoke()
p69444
aVListView
p69445
aVVirtualMode can help
p69446
as(dp69447
g9
V17034
p69448
stp69449
a((dp69450
g2
(lp69451
VIt doesn't require a lot of work from your end
p69452
aVA user that speaks an East Asian language also has a machine that is capable of displaying the glyphs that are used in her language
p69453
aVOf course
p69454
aVMicrosoft distributes fonts with different glyph sets on different language versions of Windows
p69455
aVYou do typically want to localize your form so that button and label captions make sense to the user
p69456
aVThat's well supported by resources stored in satellite assemblies
p69457
aVYou simply set the Localizable property of the form to true, use Language to switch to the language you want to support and change the Text properties
p69458
aVWhich isn't actually simple unless you also master the language
p69459
aVA localization service can help you with that
p69460
aVThat costs money, not a heck of a lot
p69461
aVYou do want to make sure your form autoscales properly
p69462
aVEast Asian machines often use a larger system font to make the intricate glyphs more readable
p69463
aVAn MSDN subscription can get you all the different language versions of Windows that you want to support
p69464
aVRecommended, troubleshooting layout problems with screenshots is no fun
p69465
as(dp69466
g9
V17034
p69467
stp69468
a((dp69469
g2
(lp69470
VMake sure the WindowState property of the form is still set to "Normal"
p69471
aVLook in the form's Designer
p69472
aVcs file for the assignment to the ClientSize property, that's what sets the form size
p69473
aVBeyond this, update your question with any properties for the form that you see shown in bold
p69474
as(dp69475
g9
V17034
p69476
stp69477
a((dp69478
g2
(lp69479
VVB6 completely does not support threading
p69480
aVIt sorta worked in VB5 if you programmed very carefully but that got borked in VB6 runtime
p69481
aVIt is okay to use threading in your
p69482
aVNET code, as long as the VB6 code never sees that
p69483
aVYou have to marshal the event raising call to the STA thread on which VB6 created your class object
p69484
aVThat's done with Control
p69485
aVBeginInvoke() or Dispatcher
p69486
aVBeginInvoke()
p69487
aVIf you don't have a form or dispatcher to make this call then create a hidden Winforms form so you can use it to marshal
p69488
aVGetting this right isn't terribly easy
p69489
as(dp69490
g9
V17034
p69491
stp69492
a((dp69493
g2
(lp69494
VThe appropriate thing to do here is to not throw an exception if you can help it
p69495
aVThere are two basic pieces of information that are missing to do the Right Thing
p69496
aVFirst there's the string argument, apparently the caller of this method has some secret knowledge of how GetObject() works to know what the appropriate string should be
p69497
aVYou thus need to treat the caller as an authority, he knows a lot more about GetObject() than you do
p69498
aVSecond is the GetObject() behavior
p69499
aVApparently the author designed it so that it is non-exceptional and expected for it to return a null
p69500
aVA much stronger contract would be two methods, TryGetObject() and GetObject(), the latter one throwing
p69501
aVOr more commonly an extra argument for GetObject() named throwOnFailure
p69502
aVBut that didn't happen, null is returned and normal
p69503
aVYou are breaking that contract here
p69504
aVYou are trying to turn it from non-exceptional to exceptional, but without having any clue what is wrong
p69505
aVThe very best thing to do is to not change that contract and leave it up to the caller of your method deal with this
p69506
aVAfter all, that's the one that knows what GetObject() does
p69507
aVChange the name of the method, use the word "Try", and return a bool
p69508
aVThis is all assuming that the author of GetObject() knew what he was doing
p69509
aVIf he didn't, there's little you can do to improve the situation
p69510
aVThrow ArgumentException if you have reason to think that the caller might have screwed up, NullReferenceException if you think that the GetObject() author might have a bug in his code
p69511
as(dp69512
g9
V17034
p69513
stp69514
a((dp69515
g2
(lp69516
VThe compiler verifies this
p69517
aVWhich almost surely means that at runtime, when Regasm
p69518
aVexe loads the assembly, it doesn't load the assembly you think it does
p69519
aVThere's plenty of opportunity for this since you use the GAC
p69520
aVWhich can produce an old version of a dependent assembly, based on an [AssemblyVersion] number in the reference assembly
p69521
aVTroubleshoot this with Fuslogvw
p69522
aVexe, log all the binds
p69523
aVIt shows you where every assembly came from
p69524
aVStay out of this kind of trouble by not putting your assemblies in the GAC
p69525
aVIt is a deployment detail and not appropriate on your dev machine where assembly versions can rapidly change, especially when you let the build system automatically increment them
p69526
aVYou do so by using the /codebase option for Regasm
p69527
aVexe
p69528
as(dp69529
g9
V17034
p69530
stp69531
a((dp69532
g2
(lp69533
VIt's accurate
p69534
aVIf the Dispose(bool) method did its job then there is no longer any point to let the finalizer do it again
p69535
aVCalling GC
p69536
aVSuppressFinalize() is an optimization, you stop
p69537
aVNET from bothering to call a finalizer that does nothing
p69538
aVI noticed that you wrote Class with a capital C
p69539
aVThat's a hint that you are writing your code in VB
p69540
aVNET
p69541
aVWatch out, the IDE does the wrong thing in 99
p69542
aV99% of all cases
p69543
aVAs soon as you press Enter after typing "Implements IDisposable", it inserts the wrong code:
p69544
aVYuck
p69545
aVThat's the boilerplate implementation of a finalizer, well documented in the MSDN Library btw
p69546
aVIt's wrong
p69547
aVIt is extremely rare to actually need a finalizer, the
p69548
aVNET classes already take care of it themselves
p69549
aVIf you really do use an operating system handle then you should use one of the SafeHandle derived classes
p69550
aVOr write your own wrapper
p69551
aVEdit it back to this:
p69552
as(dp69553
g9
V17034
p69554
stp69555
a((dp69556
g2
(lp69557
VIt is quite unclear what buffer should contain and in which direction its data flows
p69558
aVYour dictionary suggests it should be an array
p69559
aVJust declare it that way:
p69560
aVAnd use msgs[key]
p69561
aVToArray() in the call
p69562
aVUsing constants in the write_buffer() call does not make that a likely scenario though, there ought to be msgs[key]
p69563
aVCount in there somewhere
p69564
as(dp69565
g9
V17034
p69566
stp69567
a((dp69568
g2
(lp69569
VCOM has very poor support for structures
p69570
aVAt a minimum you need to use IRecordInfo to discover the layout of the structure, the 4th argument to SafeArrayCreateEx()
p69571
aVNot actually sure if the CLR supports this
p69572
aVOr how you obtain the IRecordInfo interface pointer
p69573
aVYour C++ code otherwise has the right idea
p69574
aVDon't use a struct, use a [ComVisible] class
p69575
aVThe struct members can just be properties
p69576
as(dp69577
g9
V17034
p69578
stp69579
a((dp69580
g2
(lp69581
VYou are not going to get an exception when you get this wrong, at most a blue screen
p69582
aVPick one of:
p69583
aVyou are using the wrong address (0x3bc, 0x2f8)
p69584
aVyou wired the LED wrong
p69585
aVyou broke into the wrong museum to get the hardware
p69586
aVThe question is too poorly documented to help you beyond this
p69587
as(dp69588
g9
V17034
p69589
stp69590
a((dp69591
g2
(lp69592
VYes, you are doing this the wrong way around
p69593
aVThe actual size of the form is only the same as the design size if the machine you run this on has the exact same user preferences, system font size and video DPI setting
p69594
aVIf it is off a lot then the DPI setting is different
p69595
aVIf it is off a little then the user preferences are different
p69596
aVLike a larger title bar font or bigger buttons
p69597
aVFix:
p69598
aVIf that's too noticeable then you should let the Form2's Load event do this
p69599
aVPass a reference to your main form or use the Owner property and Show(owner)
p69600
aVIn other words:
p69601
aVin Form2:
p69602
as(dp69603
g9
V17034
p69604
stp69605
a((dp69606
g2
(lp69607
V(I'm not adding a timer that polls the form, either)
p69608
aVYou exclude the one thing you should do to solve this problem
p69609
aVThen again, you wouldn't use a timer to poll the form, you start one in the DataChanged event handler
p69610
aVThe Tick event handler disables the timer and runs the query
p69611
aVMake it a second or so
p69612
aVAdd a button if you think that slows down the user too much
p69613
aVA distant second choice could be an asynchronous query that you can cancel
p69614
aVLike SqlCommand
p69615
aVBeginExecuteXxxx()
p69616
aVWorks well for the UI, not so well for the dbase server load
p69617
as(dp69618
g9
V17034
p69619
stp69620
a((dp69621
g2
(lp69622
VYou get the most bang out of WMI, Win32_Thread class
p69623
aVThe linked article has a link to the C++ code you need
p69624
aVExperiment with the WMI Code Creator tool
p69625
as(dp69626
g9
V17034
p69627
stp69628
a((dp69629
g2
(lp69630
VCOM is completely agnostic of the memory layout of your object
p69631
aVAll that it wants and needs is a table of function pointers when it calls
p69632
aVHow you implement it is completely up to you
p69633
aVMFC uses nested classes, just about anything else leverages the built-in support for multiple inheritance in the C++ compiler
p69634
aVThe way the MSVC++ compiler implements it is completely compatible with what COM needs
p69635
aVThis is no accident
p69636
aVUse the boilerplate code you see listed in books about COM that shows how to properly implement IUnknown
p69637
as(dp69638
g9
V17034
p69639
stp69640
a((dp69641
g2
(lp69642
VSorry, wsh
p69643
aVRun() is not threading my any stretch of the imagination
p69644
aVIt starts a new process, not a thread
p69645
aVGetting 0 as a return is the expected outcome if you don't use the 4th argument
p69646
aVDocs are here
p69647
as(dp69648
g9
V17034
p69649
stp69650
a((dp69651
g2
(lp69652
VWebClient detects this just fine
p69653
aVThus the exception
p69654
aVYou need to find the server that's misbehaving
p69655
aVNot quite sure what to do if you find that server, maybe you can send the admin a nice email message
p69656
aVLog the server URL
p69657
as(dp69658
g9
V17034
p69659
stp69660
a((dp69661
g2
(lp69662
VThis is a "why on Earth would you do that" message
p69663
aVProject + Add Reference, Browse tab, select the DLL, not the TLB
p69664
aVSo you'll use the
p69665
aVNET class(es) directly instead of going through the COM interop twice
p69666
as(dp69667
g9
V17034
p69668
stp69669
a((dp69670
g2
(lp69671
VIf you're really desperate then you can reverse-engineer this watson dump back to the failing statement in your code with the hints in this answer
p69672
aVBy far the better approach is to write an event handler for AppDomain
p69673
aVCurrentDomain
p69674
aVUnhandledException and log or display the value of e
p69675
aVExceptionObject
p69676
aVToString()
p69677
aVGets you the stack trace as well, invaluable in troubleshooting
p69678
as(dp69679
g9
V17034
p69680
stp69681
a((dp69682
g2
(lp69683
VWell, this is pretty unusual
p69684
aVIn general, it doesn't make a lot of sense to provide the user with a nice GUI and still leave a console window up and interactive
p69685
aVBut yes, calling Application
p69686
aVRun() or Form
p69687
aVShowDialog() is going to block the thread
p69688
aVIt has to, the message loop needs to be running to keep the GUI alive
p69689
aVIf you do this, be sure to put the [STAThread] attribute on the Main() method
p69690
aVThe only other decent alternative is to start a thread
p69691
aVThis isn't a problem, a UI thread doesn't burn any CPU cycles
p69692
aVCode only ever runs when the user does something, it's otherwise idle 99% of the time
p69693
aVBe sure to call the thread's SetApartmentState() method before you start it, STA is required
p69694
as(dp69695
g9
V17034
p69696
stp69697
a((dp69698
g2
(lp69699
VThe value-add is rather small for the amount of pinvoke you'll need
p69700
aVBut it is possible
p69701
aVUse GetSystemMenu() to retrieve the system menu handle
p69702
aVThen InsertMenuItem to add an entry
p69703
aVYou have to do this in an override of OnHandleCreated() so you recreate the menu when the window gets recreated
p69704
aVOverride WndProc() to recognize the WM_SYSCOMMAND message that's generated when the user clicks it
p69705
aVVisit pinvoke
p69706
aVnet for the pinvoke declarations you'll need
p69707
as(dp69708
g9
V17034
p69709
stp69710
a((dp69711
g2
(lp69712
VThis is an XY question
p69713
aVYou are asking for a solution for Y while the real problem is X
p69714
aVAppSettings are supposed to be easy to read
p69715
aVWhen you find yourself in a situation where it is suddenly no longer easy to read then an AppSetting is useless to you
p69716
aVNot so sure what a better solution might be, no great hints in your question
p69717
aVSounds to me that ClickOnce is what's getting you in trouble
p69718
aVThe W problem
p69719
as(dp69720
g9
V17034
p69721
stp69722
a((dp69723
g2
(lp69724
VIt's kind of a miracle that this works for non-Chinese text
p69725
aV"\u005cn" is not the line separator in RTF, "\u005cpar" is
p69726
aVThe odds that more damage is done to the RTF header are certainly greater for Chinese
p69727
aVC++ is not the best language to tackle this
p69728
aVIt is a trivial 5 minute program in C# as long as the file doesn't get too large:
p69729
aVIf C++ is a hard requirement then you'll have to find an RTF parser
p69730
as(dp69731
g9
V17034
p69732
stp69733
a((dp69734
g2
(lp69735
VCould not load file or assembly 'Vex Connector Client,
p69736
aVPretty standard kind of error for a Remoting app, it just can't find the assembly
p69737
aVMake sure it's there, preferably in the same directory as the exe
p69738
aVUse Fuslogvw
p69739
aVexe if you have trouble diagnosing the reason it cannot find the assembly
p69740
aVThe fuslogvw traces show the problem clearly
p69741
aVThe server is looking for "vex connector client
p69742
aVexe" in its own directory, Final Vex Connector/Vex Connector/Vex Connector Service/
p69743
aVbin/Debug/
p69744
aVBut the file isn't there, it is stored in Final Vex Connector/Vex Connector/Vex Connector Client/bin/Debug/
p69745
aVCopy the file to fix the problem
p69746
aVIf you find it distasteful that the server needs the client
p69747
aVexe then put the classes they share in a separate project
p69748
as(dp69749
g9
V17034
p69750
stp69751
a((dp69752
g2
(lp69753
VTrying to block a shutdown is a lossy proposition these days, it's no longer possible to do so in Vista and up
p69754
aVA prompt isn't readable nor reachable
p69755
aVUsing a service is highly indicated here, lets you survive a user log-off
p69756
aVAnd a reboot, your service will start running again automatically, letting you complete the job
p69757
as(dp69758
g9
V17034
p69759
stp69760
a((dp69761
g2
(lp69762
VAlways hard to answer an "it doesn't work" question
p69763
aVBut I can speculate
p69764
aVMicrosoft has warned about printing from a service in the past
p69765
aVI think the problem is that printer drivers are rarely designed to run in the kind of service environment that Windows 2008 provides
p69766
aVServices run in an isolated session, they cannot interact with the desktop anymore
p69767
aVPrinter drivers tend to be too chatty, doing stuff like prompting the user that there's a paper jam
p69768
aVOr that it is time to buy a new factory approved toner cartridge
p69769
aVThat doesn't work well in session 0, nobody can hear it scream
p69770
aVQuite undiagnosable, you just can't tell why the service seized-up
p69771
aVMaybe they nailed this down in 2008 and blocked it completely
p69772
aVNo idea, you'll find the people that know this at serverfault
p69773
aVcom
p69774
as(dp69775
g9
V17034
p69776
stp69777
a((dp69778
g2
(lp69779
VYou found an interesting loop hole, it tripped everybody up
p69780
aVNo, it is not thread-safe
p69781
aVWhile it looks like the EventHandler<> reference is copied through the method argument, this is not what happens at runtime
p69782
aVExtension methods are subject to being inlined, just like a regular instance method
p69783
aVIn fact, it is extremely likely to get inlined since it is so small
p69784
aVThere's no copy, you have to make one yourself
p69785
as(dp69786
g9
V17034
p69787
stp69788
a((dp69789
g2
(lp69790
VNot possible, GetProcAddress() requires a module handle
p69791
aVA HMODULE is only valid inside the process in which it was obtained
p69792
aVYou would have to do the same kind of thing that GetProcAddress() does, iterating the IAT to find the entrypoint
p69793
aVAnd apply the base address offset
p69794
aVThis is beyond painful to do for another process since you cannot directly access the memory to read the IAT
p69795
aVReadProcessMemory is required
p69796
aVInjecting code in the target process is the only reasonable approach
p69797
aVWhich is also required to do what I presume you'd want to do next, call the function
p69798
aVCode injection techniques are covered well at codeproject
p69799
aVcom
p69800
as(dp69801
g9
V17034
p69802
stp69803
a((dp69804
g2
(lp69805
VIt is a file produced by the ResolveAssemblyReference build target
p69806
aVMSDN has this to say about it:
p69807
aVVisual Studio attempts to execute
p69808
aVtargets with certain names when it
p69809
aVloads a project
p69810
aVThese targets include
p69811
aVCompile, ResolveAssemblyReferences,
p69812
aVResolveCOMReferences,
p69813
aVGetFrameworkPaths, and
p69814
aVCopyRunEnvironmentFiles
p69815
aVVisual Studio
p69816
aVruns these targets so that the
p69817
aVcompiler can be initialized to provide
p69818
aVIntelliSense, the debugger can be
p69819
aVinitialized, and references displayed
p69820
aVin Solution Explorer can be resolved
p69821
aVIf these targets are not present, the
p69822
aVproject will load and build correctly
p69823
aVbut the design-time experience in
p69824
aVVisual Studio will not be fully
p69825
aVfunctional
p69826
aVIf I interpret this correctly, I'd say that the file is used to help the IDE provide proper IntelliSense and assembly reference status in the References node
p69827
aVIt is a fairly expensive operation since there are potentially a lot of assemblies that can be referenced
p69828
aVSo instead of doing this repeatedly, the
p69829
aVcache file can help make this quick
p69830
aVDeleting it isn't an issue, it will be recreated when the project is reloaded
p69831
as(dp69832
g9
V17034
p69833
stp69834
a((dp69835
g2
(lp69836
VIt's available from Intel
p69837
aVStart here, pick a model, click on "Download Datasheet", then the "Specification Update" to find the cpuid
p69838
as(dp69839
g9
V17034
p69840
stp69841
a((dp69842
g2
(lp69843
VHehe, this used to be a serial port protocol, they probably just moved it unchanged to use sockets instead
p69844
aVNot that uncommon, although it isn't very suitable for a stream like TCP implements
p69845
aVWell, follow the instructions
p69846
aVAssuming you are the client, read one byte and verify its is 0x02
p69847
aVIf it is, send back one byte, 0x06
p69848
aVIf not, keep reading until you see the 0x02
p69849
aVYou're now 'connected', but you already knew that
p69850
aVNext, read 4 bytes so you know the packet length, read as many bytes + 2 to get the rest of the packet
p69851
aVI'd ignore the 'MD5 digest', TCP is reliable enough to not have to double-check the validity of the received data
p69852
aVSend back one byte, 0x06
p69853
aVThe only thing that isn't clear is whether you should expect a 0x02 before the packet length or not
p69854
aVThe text says you don't, the diagram says you do
p69855
as(dp69856
g9
V17034
p69857
stp69858
a((dp69859
g2
(lp69860
VRight-click your class library project, Set as Startup Project if necessary
p69861
aVAgain, Properties, Debug tab
p69862
aVSelect "Start external program" and select your 'demo' program's EXE
p69863
aVPressing F5 now automatically starts the demo program with the debugger attached
p69864
aVDon't forget to take advantage of Edit+Continue
p69865
as(dp69866
g9
V17034
p69867
stp69868
a((dp69869
g2
(lp69870
VThis can be elegantly done by Winforms' support for reparenting a control
p69871
aVYou could move it to a temporary form that's displayed full-screen
p69872
aVAll the normal event handlers still work as usual
p69873
aVHere's a sample implementation, it works for any control:
p69874
aVSample usage:
p69875
as(dp69876
g9
V17034
p69877
stp69878
a((dp69879
g2
(lp69880
VFormatMessage is already used internally by Win32Exception
p69881
aVFor example:
p69882
aVOutput: Unspecified error
p69883
aVBe sure to avoid bypassing the normal HRESULT checking that's done by the CLR in its COM interop layer
p69884
aVIt uses IErrorInfo to get rich error text from the COM server
p69885
aVThat gets you the 'real' error message rather the generic one
p69886
as(dp69887
g9
V17034
p69888
stp69889
a((dp69890
g2
(lp69891
V63 is the ASCII code for
p69892
aVThere's some relevance to the values, ASCII doesn't have character codes for values over 127
p69893
aVAn ASCII encoder commonly replaces invalid codes like this with a question mark
p69894
aVDefault behavior for the
p69895
aVNET Encoding
p69896
aVASCII encoder for example
p69897
aVIt isn't exactly clear where that might happen
p69898
aVDefinitely not in your snippet
p69899
aVProbably on the other end of the wire
p69900
aVWrite bytes, not characters
p69901
as(dp69902
g9
V17034
p69903
stp69904
a((dp69905
g2
(lp69906
VI don't think you can
p69907
aVFixable another way though
p69908
aVTools + Customize, Commands tab
p69909
aVSelect Toolbar and pick a toolbar you have always visible
p69910
aVLike Standard
p69911
aVSelect the place where you want to insert in the lower left Controls panel
p69912
aVAdd Command, Tools, select "Record TemporaryMacro", OK
p69913
aVYou'll now always have it available to start recording a macro
p69914
as(dp69915
g9
V17034
p69916
stp69917
a((dp69918
g2
(lp69919
VCSV file parsing is I/O bound, determined by how fast you can read the data off the disk
p69920
aVThe fastest that could ever go is around 50 to 60 MB per second for a consumer level hard drive
p69921
aVSounds like this LumenWorks is close to that limit
p69922
aVYou'll only ever get this kind of throughput though on a nice clean unfragmented disk with one large file
p69923
aVSo that the disk reader head is just pumping data without having to move a lot, just track-to-track moves
p69924
aVMoving the head is the slow part, usually around 16 milliseconds average
p69925
aVThere's lots of head movement when you're reading 3000 files
p69926
aVJust opening a file takes about 50 milliseconds
p69927
aVAt least do a comparable test to find the bottleneck
p69928
aVUse a good text editor and copy/paste to make one giant file as well
p69929
aVRun a disk defragger first, Defraggler is a decent free one
p69930
aVAs far as code improvements, watch out for strings
p69931
aVThey can generate a lot of garbage and have poor CPU cache locality
p69932
aVThreads can't make I/O bound code faster
p69933
aVThe only possible improvement is one thread that reads the file, another that does the conversion so that reading and converting is overlapped
p69934
aVHaving more than one thread doing the reading is pointless, they'll just take turns waiting for the disk
p69935
aVAnd watch out for the file system cache
p69936
aVThe second time you run a test on the same file, you'll get the data from memory, not the disk
p69937
aVThat's fast but won't tell you how it will perform in production
p69938
as(dp69939
g9
V17034
p69940
stp69941
a((dp69942
g2
(lp69943
VClearly you are using Winforms
p69944
aVYes, transparency is simulated by drawing the pixels of the Parent
p69945
aVWhich is the form, you only see the form pixels, stacking effects don't work
p69946
aVThere's a KB article that shows a workaround for this
p69947
aVIt is painful
p69948
aVAnother approach is to not use PictureBox controls but just draw the images in the form's Paint event
p69949
aVConsider WPF, it has a very different rendering model that easily supports transparency
p69950
as(dp69951
g9
V17034
p69952
stp69953
a((dp69954
g2
(lp69955
VThe docs are confuzzling, it uses the term "name" and "key" interchangeably
p69956
aVThe Find() method finds node by key, not the node text
p69957
aVBe sure to set it when you add the node
p69958
aVThis works:
p69959
as(dp69960
g9
V17034
p69961
stp69962
a((dp69963
g2
(lp69964
VYou need to know the code page that the LED matrix uses
p69965
aVIt is bound to be a standard one like 1252, the Windows code page for Western Europe and the Americas
p69966
as(dp69967
g9
V17034
p69968
stp69969
a((dp69970
g2
(lp69971
VOnly one, really, SetUnhandledExceptionFilter()
p69972
aVFollowed by TerminateProcess()
p69973
aVWhich is in the code path when the function has detected a buffer overflow
p69974
aVThis prevents malware from getting activated by hooking the unhandled exception filter and intentionally causing an access violation
p69975
aVUnfortunately also making it quite difficult to do custom crash reporting when the overflow is triggered by a simple programming bug
p69976
aVCode is in vc/crt/gs_report
p69977
ag36104
as(dp69978
g9
V17034
p69979
stp69980
a((dp69981
g2
(lp69982
VNote the version number, you are getting the wrong version of the
p69983
aVtargets file
p69984
aVFor VS2010 that should be 4
p69985
ag2512
aV30319
p69986
aVNot sure what you did to get msbuild started but be sure to use the VS2010 Command Line Prompt
p69987
aVThat might not be the end of your troubles, not sure, the assembly lives in C:\u005cProgram Files\u005cMicrosoft Visual Studio 10
p69988
aV0\u005cCommon7\u005cIDE\u005cPublicAssemblies, a directory pretty specific to VS
p69989
as(dp69990
g9
V17034
p69991
stp69992
a((dp69993
g2
(lp69994
VI've seen this before, it's been a while
p69995
aVThis is a bug in the driver, it is writing junk to the registry
p69996
aVBobby gave you the location, have a look-see with Regedit
p69997
aVexe
p69998
aVSome kind of USB device, I imagine
p69999
aVThrow it away and find another from a different manufacturer
p70000
aVCr*ppy drivers is not something you want to deal with
p70001
as(dp70002
g9
V17034
p70003
stp70004
a((dp70005
g2
(lp70006
VCan't quite follow this, but it sounds like an XY problem
p70007
aVUsing VisibleChanged is tricky, it doesn't follow the value of Visible that you assign
p70008
aVOnly the actual visibility state
p70009
aVDo not in any way make the ListViewItems aware of the changed state of the underlying data
p70010
aVI'm guessing you are using a derived class with an event
p70011
aVYes, that's going to leak the items if the event source doesn't get collected
p70012
aVInstead, call the list view's Invalidate() method to force it to repaint itself
p70013
aVIt will raise the RetrieveVirtualItem event again for any visible items so they'll show the updated data
p70014
aVIf you want to optimize this, only calling Invalidate if a visible item is updated, then implement the CacheVirtualItems event
p70015
as(dp70016
g9
V17034
p70017
stp70018
a((dp70019
g2
(lp70020
VYes, special treatment
p70021
aVThe JIT compiler is keenly aware of the way boxed value types work
p70022
aVWhich is in general what makes value types acting a bit schizoid
p70023
aVBoxing involves creating a System
p70024
aVObject value that behaves exactly the same way as a value of a reference type
p70025
aVAt that point, value type values no longer behave like values do at runtime
p70026
aVWhich makes it possible, for example, to have a virtual method like ToString()
p70027
aVThe boxed object has a method table pointer, just like reference types do
p70028
aVThe JIT compiler knows the method tables pointers for value types like int and bool up front
p70029
aVBoxing and unboxing for them is very efficient, it takes but a handful of machine code instructions
p70030
aVThis needed to be efficient back in
p70031
aVNET 1
p70032
aV0 to make it competitive
p70033
aVA very important part of that is the restriction that a value type value can only be unboxed to the same type
p70034
aVThis avoids the jitter from having to generate a massive switch statement that invokes the correct conversion code
p70035
aVAll it has to do is to check the method table pointer in the object and verify that it is the expected type
p70036
aVAnd copy the value out of the object directly
p70037
aVNotable perhaps is that this restriction doesn't exist in VB
p70038
aVNET, it's CType() operator does in fact generate code to a helper function that contains this big switch statement
p70039
aVThe problem with Enum types is that this cannot work
p70040
aVEnums can have a different GetUnderlyingType() type
p70041
aVIn other words, the unboxed value has different sizes so simply copying the value out of the boxed object cannot work
p70042
aVKeenly aware, the jitter doesn't inline the unboxing code anymore, it generates a call to a helper function in the CLR
p70043
aVThat helper is named JIT_Unbox(), you can find its source code in the SSCLI20 source, clr/src/vm/jithelpers
p70044
aVcpp
p70045
aVYou'll see it dealing with enum types specially
p70046
aVIt is permissive, it allows unboxing from one enum type to another
p70047
aVBut only if the underlying type is the same, you get an InvalidCastException if that's not the case
p70048
aVWhich is also the reason that Enum is declared as a class
p70049
aVIt's logical behavior is of a reference type, derived enum types can be cast from one to another
p70050
aVWith the above noted restriction on the underlying type compatibility
p70051
aVThe values of an enum type have however very much the behavior of a value type value
p70052
aVThey have copy semantics and boxing behavior
p70053
as(dp70054
g9
V17034
p70055
stp70056
a((dp70057
g2
(lp70058
VThis usually indicates either an invalid assembly path or you are not admin
p70059
aVThat's as good an error message as you can expect
p70060
aVThe path could be wrong because you don't specify the full path of the assembly (i
p70061
ag9581
aVc:\u005cmumble\u005cfoo
p70062
aVdll)
p70063
aVYou commonly don't have admin rights because of UAC
p70064
aVUse a manifest to get the privilege elevation or run Visual Studio in admin mode (change the desktop shortcut)
p70065
as(dp70066
g9
V17034
p70067
stp70068
a((dp70069
g2
(lp70070
VHard to tell from the snippet
p70071
aVThe standard mistake is to draw through Control
p70072
aVCreateGraphics() instead of the OnPaint() method
p70073
aVWon't work, Windows lets the OnPaint method run when parts of the control get uncovered
p70074
aVWhich wipes out whatever you drew
p70075
aVAnother failure mode is deriving from a control that's a wrapper for a native Window control
p70076
aVUserPaint is not supported for these type of controls, the native Windows code has to do the drawing
p70077
aVIt is clear from the screen shot, note how the text is staggered
p70078
aVThat's because the OnPaint() override is using the e
p70079
aVClipRectangle property to figure out where to draw
p70080
aVThat value always changes when you slowly drag a window across your control, it only tells you what part of the control needs to be redrawn
p70081
aVIt does not tell you where to draw
p70082
aVThat has to be based on the control bounds, routinely the rectangle from (0,0) to (ClientSize
p70083
aVWidth, ClientSize
p70084
aVHeight)
p70085
aVOnly ever use e
p70086
aVClipRectangle to optimize the drawing
p70087
aVLike skipping an expensive drawing detail when it is outside of the clipping rectangle
p70088
aVIt is otherwise a small one, Windows is already quite good at clipping automatically
p70089
as(dp70090
g9
V17034
p70091
stp70092
a((dp70093
g2
(lp70094
VRight, no copy is made
p70095
aVWhich is why the Remarks section of the MSDN Library says:
p70096
aVThe caller is responsible for
p70097
aVallocating and freeing the block of
p70098
aVmemory specified by the scan0
p70099
aVparameter, however, the memory should
p70100
aVnot be released until the related
p70101
aVBitmap is released
p70102
aVThis wouldn't be a problem if the pixel data was copied
p70103
aVIncidentally, this is normally a difficult problem to deal with
p70104
aVYou can't tell when the client code called Dispose(), there's no way to intercept that call
p70105
aVWhich makes it impossible to make such a bitmap behave like a replacement for Bitmap
p70106
aVThe client code has to be aware that additional work is needed
p70107
as(dp70108
g9
V17034
p70109
stp70110
a((dp70111
g2
(lp70112
VSystem
p70113
aVTimers
p70114
aVTimer is an ugly timer
p70115
aVOne nasty thing it does is swallow exceptions raised by the Elapsed event handler
p70116
aVWhich will kill your timer since you stop it when entering the method
p70117
aVNo notification whatsoever, it just stops working
p70118
aVYou have to at least add exception handling to this code so you can log the exception and stop the service
p70119
aVAlso beware the bug in your OnStart() method, you'll keep adding an event handler each time the service gets started
p70120
aVThe Elapsed event runs multiple times, in itself a good way to bomb something
p70121
aVConsider System
p70122
aVThreading
p70123
aVTimer, it doesn't have any of these problems
p70124
as(dp70125
g9
V17034
p70126
stp70127
a((dp70128
g2
(lp70129
VHmya, awkward type there
p70130
aVIt isn't a STR of course, should have been a PVOID
p70131
aVJust cast it to whatever type you need:
p70132
as(dp70133
g9
V17034
p70134
stp70135
a((dp70136
g2
(lp70137
Vwhich I then have bring to the front if there is a window covering it
p70138
aVThat shouldn't happen, but can happen if you display the message box from a thread in your program
p70139
aVThe window has the desktop as the parent and has no Z-order relationship with the windows in your user interface
p70140
aVAnd yes, can easily disappear behind the window of another app, including your own
p70141
aVThere's a MessageBoxOptions option that isn't exposed in Winforms, MB_TOPMOST, which ensures the window is top-most
p70142
aVYou'd use it like this:
p70143
aVBut by far the best thing to do is to display the message box on your UI thread
p70144
aVUse Control
p70145
aVInvoke() to do so
p70146
aVThat way the other windows of your app are disabled, no way for the user to not notice the box
p70147
aVStill one problem with this, the user won't expect the box to show up since it is shown asynchronously from anything she does
p70148
aVWhich means the box can easily get dismissed by accident when the user just happened to press the Enter or Space key
p70149
aVOr clicked at just the wrong spot
p70150
aVNothing much you can do about that
p70151
aVCentering the box in your main window is technically possible, but fugly to do
p70152
aVCheck this answer
p70153
as(dp70154
g9
V17034
p70155
stp70156
a((dp70157
g2
(lp70158
VYes, you need an ImageList with 3 images of a unchecked, checked and indeterminate checkbox
p70159
aVCall ListView_SetImageList() to assign the LVSIL_STATE image list
p70160
aVManipulate LVITEM
p70161
aVstate to display the kind of checkbox you want
p70162
as(dp70163
g9
V17034
p70164
stp70165
a((dp70166
g2
(lp70167
VYou are not going to find a control like this
p70168
aVYou can make one yourself, the Control
p70169
aVRegion property lets you create a non-rectangular control
p70170
aVYou'll have to draw the outline and the title yourself, do so in the OnPaintBackground override
p70171
aVBut, realistically this control isn't going to be very interesting as a re-usable control that might be of use in other forms or projects
p70172
aVKeep in mind that it only has to look like a groupbox to the user
p70173
aVSince you have to write the drawing code yourself anyway, just do so in the form's Paint event
p70174
aVIf you really need a box because of radiobuttons then use a Panel instead
p70175
aVDo keep in the Form
p70176
aVAutoScaleMode property in mind, you can't hard-code the line positions
p70177
as(dp70178
g9
V17034
p70179
stp70180
a((dp70181
g2
(lp70182
VThis is because you set to the WordWrap property to True
p70183
aVSet it to False, set Multiline to True and ScrollBars to Both
p70184
aVAppend Environment
p70185
aVNewLine to the string you generate, every 16 bytes is the norm for hex viewers
p70186
aVUse byte
p70187
aVToString("X2") to generate a hex string instead of a decimal string
p70188
aVYou now have a full scrollable view of the data, any amount is supported
p70189
aVAllow the user to resize the window so she won't have to scroll horizontally
p70190
aVOr just make it big enough
p70191
as(dp70192
g9
V17034
p70193
stp70194
a((dp70195
g2
(lp70196
VThis is because the cursor keys get intercepted early, before the KeyDown event fires
p70197
aVWinforms uses it to move the focus, just like Tab
p70198
aVWhen you hold down the Ctrl key, it is no longer a navigating key and your KeyDown event can see it
p70199
aVYou'd normally fix that by overriding IsInputKey() but that won't work if the form has any controls
p70200
aVThey probably do if you set KeyPreview to true
p70201
aVThe form never gets the focus, the controls do
p70202
aVYou need to give up on KeyPreview, it's an old VB6 anachronism anyway, you catch the cursor keys by overriding ProcessCmdKey()
p70203
aVLike this:
p70204
as(dp70205
g9
V17034
p70206
stp70207
a((dp70208
g2
(lp70209
VThat dumps the image off the clipboard, it can only hold one item
p70210
aVDelete the line to solve your problem
p70211
aVAnd code defensively:
p70212
aVTo get both pieces of info on the clipboard, first declare a little helper class to store this info
p70213
aVFor example:
p70214
as(dp70215
g9
V17034
p70216
stp70217
a((dp70218
g2
(lp70219
VThe Update() method ensures that the label is painted, now showing the Text property you assigned
p70220
aVWithout it, the painting doesn't happen until the unzipping code stops running and your program goes idle again
p70221
aVOtherwise known as 'pumping the message loop'
p70222
aVCalling Update() is only a partial fix, your window is still catatonic and won't respond to mouse clicks for example
p70223
aVIf it takes longer than a couple of seconds, Windows displays the "Not responding" ghost window
p70224
aVGet some experience with coding in C#, then tackle threading with the BackgroundWorker class
p70225
as(dp70226
g9
V17034
p70227
stp70228
a((dp70229
g2
(lp70230
VThis is not possible, the GC just doesn't provide this information
p70231
aVGood reason for that, it isn't just two states that the object can be in
p70232
aVIt also might already be on the finalization queue or it might already have been finalized
p70233
aVA custom CLR host isn't going to help you with that, the hosting interface don't provide any hooks into the gc
p70234
aVYou can check if SuppressFinalize has been called when it should have simply by checking this in the finalizer
p70235
aVLog it (quickly)
p70236
aVYou can't prove the opposite
p70237
aVFwiw, the
p70238
aVNET frame classes don't do this, they just let the finalizer run anyway
p70239
as(dp70240
g9
V17034
p70241
stp70242
a((dp70243
g2
(lp70244
VThis is largely because it is there anyway
p70245
aVIt gets inherited from the Control class, no extra work is needed to make it functional
p70246
aVIn fact, extra work is needed to hide it, required for native Windows controls that don't support a background image
p70247
aVLike TreeView:
p70248
aVNote the override keyword and the attributes required to hide it in both the property grid and the editor
p70249
aVExtra work to stop it from working
p70250
as(dp70251
g9
V17034
p70252
stp70253
a((dp70254
g2
(lp70255
Vif I just type this
p70256
aVOpacity =
p70257
aV55; it works ok
p70258
aVYour virtual machine is running with the wrong system locale, not the Netherlands
p70259
aVWhich is where I think you're from
p70260
aVUnfortunately, "0,55" is a valid value for a string in locations like the USA, the comma is treated like a thousands separator
p70261
aVThe result of the Parse statement is 55, a value that the Opacity property silently truncates to 1 without raising an exception
p70262
aVControl Panel + Regional and Language Options, switch your machine to your home country
p70263
aVCheck the "Decimal Symbol" setting in the Formats tab, Advanced afterwards to verify it is a comma and not a period
p70264
aVAlso check the type for the Setting, you want a double, not a string
p70265
as(dp70266
g9
V17034
p70267
stp70268
a((dp70269
g2
(lp70270
VStandard C# team wisdom
p70271
aVDeclarations should be self-documenting
p70272
aVAnd most of all, a change in one type declaration should not alter the behavior of an unrelated other type without generating a diagnostic
p70273
aVThe -100 points principle put into design is another take on that
p70274
as(dp70275
g9
V17034
p70276
stp70277
a((dp70278
g2
(lp70279
VReally rather the easiest way is to just use a Form with FormBorderStyle = SizeableToolWindow
p70280
aVThat's what it was made for
p70281
aVDisplay it with the Show(owner) overload so it is always on top of your main window
p70282
aVIf you want to salvage the UserControl then just Dock = Fill in the form
p70283
aVAlbeit that exposing its properties get harder to do cleanly
p70284
aVCheck out Weifenluo's DockPanel Suite for a windowing model that resembles Visual Studio's
p70285
as(dp70286
g9
V17034
p70287
stp70288
a((dp70289
g2
(lp70290
VRight-click your project, Properties, C/C++, Code Generation, Runtime Library setting
p70291
aVThat's the source of your problem
p70292
aVSettings there are /MT and /MD
p70293
aVYou are linking code that has conflicting values for this setting, everything must be compiled with the same one
p70294
aVBoost could be the one
p70295
aVCheck your linker's Additional Dependencies setting
p70296
aVIIRC, the
p70297
aVlibs have mt or md in their name
p70298
as(dp70299
g9
V17034
p70300
stp70301
a((dp70302
g2
(lp70303
VThis requires GetFileInformationByHandleEx(), asking for FileStreamInfo
p70304
aVThat returns the stream name
p70305
aVThis warning in the SDK docs should be noted:
p70306
aVCertain file information classes
p70307
aVbehave slightly differently on
p70308
aVdifferent operating system releases
p70309
aVThese classes are supported by the
p70310
aVunderlying drivers, and any
p70311
aVinformation they return is subject to
p70312
aVchange between operating system
p70313
aVreleases
p70314
aVAvoid relying on recovering info that is (or should be) readily available in your program
p70315
as(dp70316
g9
V17034
p70317
stp70318
a((dp70319
g2
(lp70320
VUse the debugger
p70321
aVSet breakpoints on the AssemblyResolve assignment and the lambda body
p70322
aVSingle step the code
p70323
aVYes, that's too late
p70324
aVMove the assignment
p70325
aVIf SingleInstanceController is in such a DLL then the Main() method never even gets started
p70326
aVMove that code into a separate helper method and give it the [MethodImpl(MethodImplOptions
p70327
aVNoinlining)] attribute
p70328
aVDistributing your program in a single file is already very well supported, it doesn't require any code nor merging DLLs
p70329
aVAlso takes care of the desktop shortcut, the file associations and getting
p70330
aVNET installed on old machines
p70331
aVIt's called setup
p70332
aVexe
p70333
as(dp70334
g9
V17034
p70335
stp70336
a((dp70337
g2
(lp70338
VPass the name of the file
p70339
aVA string
p70340
aVUse the SDK example code
p70341
as(dp70342
g9
V17034
p70343
stp70344
a((dp70345
g2
(lp70346
VIt makes very little sense to start x threads to do x jobs when you intentionally don't let them do any work at all for y minutes
p70347
aVJust have one thread do x jobs
p70348
aVIt will take x times longer to complete the work (a bit less, actually) but that's no issue at all as long as that takes less than y minutes
p70349
aVAdditional benefits from this is that the service cannot easily impact the responsiveness of the machine, other cores remain available
p70350
aVAnd that your code becomes a heckofalot easier to implement and debug
p70351
aVUse the System
p70352
aVThreading
p70353
aVThread timer to activate the work
p70354
aVThe callback runs on a threadpool thread
p70355
aVStarting and stopping the service is easy, just enable/disable that timer
p70356
as(dp70357
g9
V17034
p70358
stp70359
a((dp70360
g2
(lp70361
VThe linker needs to be told which of your functions should be exported, making them usable by other code that uses your DLL
p70362
aV__declspec(dllexport) does this
p70363
aVBut you can also do it by providing the linker with a
p70364
aVdef file, a list of exported function names
p70365
aVSomewhat painful because it now is up to you to keep that file in sync with your code
p70366
aVDocs are here
p70367
as(dp70368
g9
V17034
p70369
stp70370
a((dp70371
g2
(lp70372
VYou create additional taskbars with SHAppBarMessage(), ABM_NEW
p70373
aVYou just need a window handle, a Winforms form will work fine
p70374
aVVisit pinvoke
p70375
aVnet if you want to do this from C# code
p70376
as(dp70377
g9
V17034
p70378
stp70379
a((dp70380
g2
(lp70381
VThat's an array with one element
p70382
aVYou are copying a much bigger string into it, that corrupts the stack frame
p70383
aVFix:
p70384
as(dp70385
g9
V17034
p70386
stp70387
a((dp70388
g2
(lp70389
VAn array is simply  the wrong collection type to do this
p70390
aVIt is trivial with a list:
p70391
aVYou can always whack it back to an array, if really necessary:
p70392
as(dp70393
g9
V17034
p70394
stp70395
a((dp70396
g2
(lp70397
VHehe, kinda funny
p70398
aVRemove the line breaks between the DLL names
p70399
aVI'll edit your post to make them obvious
p70400
aVWith a DLL on a single line, it is interpreted as a build command instead of an argument to ILMerge
p70401
aVIt invokes the default action for a
p70402
aVdll file, which in your case is "open in Reflector"
p70403
as(dp70404
g9
V17034
p70405
stp70406
a((dp70407
g2
(lp70408
VIt doesn't have anything to do with the code snippet you posted, the code bombs before ManagedClassWrapper gets created
p70409
aVThe  class is a wrapper class around all of the non-ref class code that you wrote
p70410
aVIt bombs when it tries to call the initializers of your unmanaged code
p70411
aVIt's an AccessViolation, the usual way for unmanaged code to take a nose-dive
p70412
aVTo debug this you'll have to enable unmanaged debugging in your C# project
p70413
aVProject + Properties, Debug tab, tick "Enable unmanaged code debugging"
p70414
aVThen Debug + Exceptions, tick the Thrown flag on "Win32 Exceptions"
p70415
aVRun your code until the crash happens, the debugger will stop at the crash location
p70416
aVShould give you some idea where the bug is located
p70417
aVUse the normal debugging techniques that you're familiar with when working with unmanaged code
p70418
aVGood luck with it
p70419
as(dp70420
g9
V17034
p70421
stp70422
a((dp70423
g2
(lp70424
VThat's where the buck stops, IUnknown derived interfaces are not Automation compatible
p70425
aVThey are usable from C++ code, note the
p70426
aVh files generated by midl and the amount of cpp_quote() in the
p70427
aVidl file
p70428
aVAn Automation compatible COM interface is derived from IDispatch and uses the sub-set of Automation compatible types for the function arguments
p70429
aVVariant, BSTR and SafeArray are popular choices
p70430
aVTechnically it is possible to re-declare the interface types in C# code, you just don't get any help from a type library to get that right
p70431
aVAnd you'll have to deal with the no-multiple-inheritance headache (not this one)
p70432
aVTlbimp
p70433
aVexe is powerless without a type library
p70434
aVUse C++/CLI to get this going, you can write a ref class wrapper and you can #include the
p70435
aVh file
p70436
as(dp70437
g9
V17034
p70438
stp70439
a((dp70440
g2
(lp70441
VThis code works to catch the user closing the console window:
p70442
aVBeware of the restrictions
p70443
aVYou have to respond quickly to this notification, you've got 5 seconds to complete the task
p70444
aVTake longer and Windows will kill your code unceremoniously
p70445
aVAnd your method is called asynchronously on a worker thread, the state of the program is entirely unpredictable so locking is likely to be required
p70446
aVDo make absolutely sure that an abort cannot cause trouble
p70447
aVFor example, when saving state into a file, do make sure you save to a temporary file first
p70448
as(dp70449
g9
V17034
p70450
stp70451
a((dp70452
g2
(lp70453
VIt is because DateTime
p70454
aVNow is a property, not a literal
p70455
aVProperty getters can have side-effects, simply calling one can be useful by itself
p70456
aVNot that this is a good idea, it is however not verboten to do so and the compiler isn't smart enough to tell whether or not it does
p70457
aVIt can't anyway, it ultimately calls operating system code to obtain the current system time
p70458
as(dp70459
g9
V17034
p70460
stp70461
a((dp70462
g2
(lp70463
VIt is quite explicitly mentioned in the linked article:
p70464
aVDo not use REGCLS_SINGLEUSE
p70465
aVRegistration fails if you use this
p70466
aVflag
p70467
aVThe operating system allows a
p70468
aVsingle instance of a service
p70469
aVFor this
p70470
aVreason, the COM component must be
p70471
aVavailable to multiple clients
p70472
aVsimultaneously
p70473
aVYou have to use a regular out-of-process server if you want multiple instances of it
p70474
as(dp70475
g9
V17034
p70476
stp70477
a((dp70478
g2
(lp70479
s(dp70480
g9
V17034
p70481
stp70482
a((dp70483
g2
(lp70484
VThe compatibility problem and the workaround is described in this KB article
p70485
aVThere is no down-conversion option to go from a
p70486
aVvcxproj to a
p70487
aVvcproj
p70488
aVPerhaps the changed filename extension is the strongest hint, but the project file format was changed dramatically in VS2010
p70489
aVThe build plumbing was completely changed to support building with msbuild
p70490
aVexe
p70491
aVYou'll have to recreate the project from scratch in VS2008
p70492
as(dp70493
g9
V17034
p70494
stp70495
a((dp70496
g2
(lp70497
VThe generic diagnostic is that you didn't export anything
p70498
aVYou can double-check with Dumpbin
p70499
aVexe /exports on your DLL
p70500
aVBe sure to decorate the functions you want to export with __declspec(dllexport)
p70501
aVOr use a
p70502
aVdef file
p70503
as(dp70504
g9
V17034
p70505
stp70506
a((dp70507
g2
(lp70508
VThe 0xe0434f4d exit code is quite meaningful
p70509
aVThat's the native exception code for a managed exception
p70510
aVIn other words, your app is crashing with an unhandled exception when it is run by task manager
p70511
aVI could guess at reasons why, but it is fairly pointless
p70512
aVFind out yourself, write an event handler for AppDomain
p70513
aVCurrentDomain
p70514
aVUnhandledException and log the value of e
p70515
aVExceptionObject
p70516
aVToString()
p70517
aVThat gives you the exception message and the stack trace, almost always good enough to find out why it is bombing
p70518
as(dp70519
g9
V17034
p70520
stp70521
a((dp70522
g2
(lp70523
VCan event handlers from two different serial ports interrupt each other and corrupt List data
p70524
aVAbsolutely, the DataReceived event is raised on a threadpool thread
p70525
aVYou've got a three-ring circus going on here, two threads that can receive something at the same time, an UI thread that's reading the received data at the same time
p70526
aVLocking is required to protect the List<>
p70527
as(dp70528
g9
V17034
p70529
stp70530
a((dp70531
g2
(lp70532
VThe trick is to obtain the HwndSource and call its AddHook() method
p70533
aVThis works:
p70534
aVThe same code for a Winforms Form:
p70535
as(dp70536
g9
V17034
p70537
stp70538
a((dp70539
g2
(lp70540
VMy crystal ball says you didn't just upgrade to Win7, you also got the 64-bit version
p70541
aVPreviously you had the 32-bit version of Vista
p70542
aVYour mouse_event() declaration is wrong
p70543
aVThe last argument is IntPtr, not int
p70544
aVHow did the ball do
p70545
as(dp70546
g9
V17034
p70547
stp70548
a((dp70549
g2
(lp70550
VThere is no mov [esp+x], [ebp+y] instruction, too many operands
p70551
aVIt would take two instructions and use a register
p70552
aVPush does it in one instruction
p70553
as(dp70554
g9
V17034
p70555
stp70556
a((dp70557
g2
(lp70558
VI see it
p70559
aVRight-click the gtest project, Properties, Configuration properties, General
p70560
aVEnsure that the Debug configuration is selected (upper left combo)
p70561
aVChange the Target Name property to
p70562
aVNote the added "d" to change the name from gtest to gtestd
p70563
aVThe warning is otherwise benign
p70564
as(dp70565
g9
V17034
p70566
stp70567
a((dp70568
g2
(lp70569
VIt is very hard to find a machine that only has 4
p70570
aV0 installed
p70571
aVNET 2
p70572
aV0 compatible versions are pre-installed on Vista and Win7 machines, they'll run your program without a hitch
p70573
aVYou'd have to have a virgin XP machine that never had
p70574
aVNET installed
p70575
aVMaybe a server core
p70576
aVIn which case somebody made a bit of a blunder by installing the wrong version of
p70577
aVNET
p70578
aVNot sure how that happened, smells like a communication problem
p70579
aVMaybe you shouldn't leave it up to somebody else to get this wrong
p70580
aVWhen the system requirements for your app include support for XP then you'd better make sure it is available
p70581
aVPretty simple with a Setup project
p70582
aVYour app
p70583
aVconfig is otherwise wrong,  has been obsolete since
p70584
aVNET 1
p70585
ag2512
aVThe proper incantation is  and ask for both 2
p70586
ag2512
aV50727 and 4
p70587
ag2512
as(dp70588
g9
V17034
p70589
stp70590
a((dp70591
g2
(lp70592
VUse Long to avoid the overflow:
p70593
aVThe And operator ensures no overflow exception is thrown
p70594
aVThis however does lose one bit of "precision" in the computed hash code, the result is always positive
p70595
aVVB
p70596
aVNET has no built-in function to avoid it, but you can use a trick:
p70597
aVNow you can write:
p70598
as(dp70599
g9
V17034
p70600
stp70601
a((dp70602
g2
(lp70603
VYou can solve the first problem by installing the 32-bit version of the provider
p70604
aVDownload is here
p70605
aVThe second problem is very strange, an interop library should contain IL only and not have a dependency on the processor architecture
p70606
aVWhen I create an interop DLL from c:\u005cwindows\u005csystem32\u005cshdocvw
p70607
aVdll and run CorFlags
p70608
aVexe on it then I get this:
p70609
aVNote how ILONLY is on, 32BIT is off
p70610
aVThis should run on a 64-bit machine just fine
p70611
aVI'm not close to one right now to check, try this yourself to compare
p70612
aVTo get a better answer you should document which version of Internet Explorer you have installed and whether you used the 64-bit or the 32-bit version of the DLL to generate the interop
p70613
aVThe latter is in the c:\u005cwindows\u005csyswow64 directory
p70614
as(dp70615
g9
V17034
p70616
stp70617
a((dp70618
g2
(lp70619
VTo find the
p70620
aVconfig file for your service, do not use the service name
p70621
aVThat's not how the CLR works, it selects the
p70622
aVconfig file based on the EXE name
p70623
aVFix:
p70624
as(dp70625
g9
V17034
p70626
stp70627
a((dp70628
g2
(lp70629
VThis requires support from the disk device driver
p70630
aVThe kind of driver that you'd find in an upscale server, not a consumer level machine
p70631
aVAsk more questions about this at serverfault
p70632
aVcom
p70633
as(dp70634
g9
V17034
p70635
stp70636
a((dp70637
g2
(lp70638
VYou should in general leave it up to the specific UI class library to set this correctly
p70639
aVWinforms automatically installs a WindowsFormsSynchronizationContext instance, WPF installs a DispatcherSynchronizationContext, ASP
p70640
aVNET installs a AspNetSynchronizationContext, a Store app installs WinRTSynchronizationContext, etcetera
p70641
aVHighly specific synchronization providers that are tuned to the way the UI thread dispatches events
p70642
aVThere's something special about the way these application environments use their main thread
p70643
aVThey all implement a dispatcher loop and use a thread-safe queue to receive notifications
p70644
aVGenerally known as the "message loop" in Windows GUI programming
p70645
aVThis is a generic solution to the producer/consumer problem, with the dispatcher loop implementing the consumer
p70646
aVCreating your own synchronization provider for a worker thread first requires that such a thread implements this same mechanism
p70647
aVIn other words, you will need a thread-safe queue, like ConcurrentQueue, and the thread needs to be written to retrieve notifications from the queue and execute them
p70648
aVA delegate object would be a good choice
p70649
aVYou will now have no problem implementing the Post method, simply add the SendOrPostCallback delegate to the queue
p70650
aVExtra work is required to implement the Send method, the thread needs to signal back that the delegate was retrieved and executed
p70651
aVSo the queue object also needs an AutoResetEvent
p70652
aVDo note how your thread now stops becoming a generally useful thread, it is bogged down by having to dispatch these notifications
p70653
aVAnd how the existing synchronization providers already do all of this
p70654
aVSo if your app is a Winforms app then you might as well call Application
p70655
aVRun() on your worker thread with a dummy invisible form
p70656
aVAnd you'll automatically get its synchronization provider for free
p70657
as(dp70658
g9
V17034
p70659
stp70660
a((dp70661
g2
(lp70662
VThe Intel manuals are good for this
p70663
aVThis is what it documents for the TEST instruction:
p70664
aVSF is the sign flag, the one that's tested by the JS opcode
p70665
aVIt is set to the most significant bit of eax here, the sign bit
p70666
aVThe jump is thus taken when eax contains a negative number
p70667
as(dp70668
g9
V17034
p70669
stp70670
a((dp70671
g2
(lp70672
VThis is a problem that's commonly induced by the SystemEvents class when you have a non-standard way to initialize your user interface
p70673
aVUsing threads, specifically
p70674
aVStart your program, Debug + Break All, Debug + Windows + Threads
p70675
aVIf you see a thread named "
p70676
aVNET SystemEvents" then you're pretty much guaranteed to get this hang
p70677
aVSome background: the SystemEvent class supports both console mode apps and GUI apps
p70678
aVFor the latter, it should fire its event handlers on the UI thread
p70679
aVThe very first time one of its events is subscribed, it creates a little invisible helper window to get the system notifications
p70680
aVIt can do this two ways, either by creating the window on the calling thread or by starting up a helper thread
p70681
aVIt makes the decision based on the value of Thread
p70682
aVGetApartmentState()
p70683
aVIf it is STA then it can create the window on the calling thread and all event callbacks can be properly marshaled to that thread
p70684
aVThis goes wrong if the first window you create is not created on the UI thread
p70685
aVA splash screen for example
p70686
aVThat window may contain controls that are interested in a system event like UserPreferenceChanged so they can properly repaint themselves
p70687
aVIt now uses the helper thread and any event will be fired from that helper thread, not the UI thread
p70688
aVPoison to any window that runs on the UI thread
p70689
aVThe session switch out of a locked workstation (including the screen saver) is for some mysterious reason very likely to cause deadlock
p70690
aVYou may also see an occasional painting mishap, the less nasty result of using windows from the wrong thread
p70691
aVShort from fixing the initialization order, a workaround is to put this in your Main() method, before any windows are created:
p70692
as(dp70693
g9
V17034
p70694
stp70695
a((dp70696
g2
(lp70697
VThis commentary sounds really relevant
p70698
as(dp70699
g9
V17034
p70700
stp70701
a((dp70702
g2
(lp70703
VBecause VirtualPath is marked internal
p70704
aVOnly code inside System
p70705
aVWeb
p70706
aVdll can use it
p70707
aVThat has to be bad news, there's no decent workaround for this
p70708
as(dp70709
g9
V17034
p70710
stp70711
a((dp70712
g2
(lp70713
VIt isn't SAException, that's the inner exception
p70714
aVIt isn't clear from the stack trace what the outer exception type is
p70715
aVEasy to find out with the debugger or some diagnostic code:
p70716
as(dp70717
g9
V17034
p70718
stp70719
a((dp70720
g2
(lp70721
VIt is a jitter implementation detail, the x86 and x64 jitters have subtly different rules
p70722
aVThis is casually documented in blog posts of team members that worked on the jitter but the teams certainly reserve the right to alter the rules
p70723
aVLooks like you already found them
p70724
aVInlining methods from other assemblies is most certainly supported, a lot of the
p70725
aVNET classes would work quite miserably if that wasn't the case
p70726
aVYou can see it at work when you look at the machine code generated for Console
p70727
aVWriteLine(), it often gets inlined when you pass a simple string
p70728
aVTo see this for yourself, you need to switch to the Release build and change a debugger option
p70729
aVTools + Options, Debugging, General, untick "Suppress JIT optimization on module load"
p70730
aVThere is otherwise no good reason to consider MethodImpOptions
p70731
aVNoInlining maligned, it's pretty much why it exists in the first place
p70732
aVIt is in fact used intentionally in the
p70733
aVNET framework on lots of small public methods that call an internal helper method
p70734
aVIt makes exception stack traces easier to diagnose
p70735
as(dp70736
g9
V17034
p70737
stp70738
a((dp70739
g2
(lp70740
VJust don't include the filename in the target path:
p70741
aVif not exist c:\u005cbar\u005cbin md c:\u005cbar\u005cbin
p70742
aVxcopy /y c:\u005cfoo\u005cbin\u005cmumble
p70743
aVpdb c:\u005cbar\u005cbin
p70744
as(dp70745
g9
V17034
p70746
stp70747
a((dp70748
g2
(lp70749
VThere are subtle mistakes in this code
p70750
aVThe first snippet's Array
p70751
aVResize() does nothing, maybe buffer needs to be resized instead
p70752
aVThe second snippet bombs on a TimeoutException when more bytes were received than expectedSize
p70753
aVWhich is certainly possible and not a timeout problem
p70754
aVBut I think the real problem is what you do with the array outside of this code
p70755
aVIn general, calling SerialPort
p70756
aVRead() only gets you a couple of bytes
p70757
aVSerial ports are slow
p70758
aVYou need some kind of protocol to know when a 'full' response is received
p70759
aVA very common (non-binary) one is simply terminating the response with a line-feed
p70760
aVThen you'd just use ReadLine() in the DataReceived event handler
p70761
aVIt isn't obvious what the proper approach would be in your case
p70762
aVAlso implement the ErrorReceived event
p70763
aVIt will tell you when something bad happened, like SerialError
p70764
aVOverrun or RXOver, errors that also make bytes disappear
p70765
as(dp70766
g9
V17034
p70767
stp70768
a((dp70769
g2
(lp70770
VThere are in general no restrictions on what you do in a Winforms event handler
p70771
aVBut it has side-effects that are easy to see for yourself, if you do a lot of work then the user interface goes catatonic
p70772
aVIt no longer responds to mouse clicks, it doesn't repaint itself anymore
p70773
aVAfter about 3 seconds, Windows replaces the form with the ghost window with "Not Responding" in the title bar
p70774
aVYou'd have to write a great deal of code to trigger that condition, one second is over 4 billion machine instructions
p70775
aVThe typical UI freeze is caused by waiting for something else to get the job done, a dbase query for example
p70776
aVThat is ugly and doesn't make a great impression
p70777
aVAnd can make it uncomfortable to use your user interface
p70778
aVNothing very pretty about a user banging away on a button that doesn't respond
p70779
aVYou'd use a work threader to solve this problem, BackGroundWorker is made for that
p70780
aVThis is not so easy to get right, only use this if you have a real problem to solve
p70781
aVDon't assume anything
p70782
as(dp70783
g9
V17034
p70784
stp70785
a((dp70786
g2
(lp70787
VUse the Path property, that gives you the path to the target
p70788
aVSystem
p70789
aVIO
p70790
aVDirectory
p70791
aVExists() can then tell you if it is directory or not
p70792
as(dp70793
g9
V17034
p70794
stp70795
a((dp70796
g2
(lp70797
VThe Windows thread scheduler distributes ready-to-run threads across cores
p70798
aVIt is entirely automatic
p70799
as(dp70800
g9
V17034
p70801
stp70802
a((dp70803
g2
(lp70804
VThe WS_EX_NOACTIVATE window style flag was designed to do this
p70805
aVHere's a sample form that implements it:
p70806
as(dp70807
g9
V17034
p70808
stp70809
a((dp70810
g2
(lp70811
VIn the Windows SDK version that macro expands to
p70812
aVThe first one allows use of the __uuidof keyword which is a nice way to get the guid of an interface from the typename
p70813
aVThe second one suppresses the generation of the v-table, one that is never used for an interface
p70814
aVA space optimization
p70815
as(dp70816
g9
V17034
p70817
stp70818
a((dp70819
g2
(lp70820
VLarry Osterman, the MSFT programmer that worked on the audio sub-system since Vista blogged about the fate of the Beep driver
p70821
aVHis post is here
p70822
as(dp70823
g9
V17034
p70824
stp70825
a((dp70826
g2
(lp70827
VThe first one ought to be easiest to get going because that leaves it up to the callee to figure out the required size
p70828
aVIt is however not obvious how you are supposed to know the size of the allocation
p70829
aVMaybe the return value
p70830
aVYou can always pinvoke GlobalSize() to get the size from the HGLOBAL handle
p70831
aVYou should pinvoke GlobalLock() to convert the handle to a pointer, then Marshal
p70832
aVCopyMemory() to copy it into a byte[]
p70833
aVCleanup by calling GlobalUnlock() and  Marshal
p70834
aVFreeHGlobal() to release the memory, put it inside a finally block so you cannot leak
p70835
aVFor the second one, you should declare the 2nd argument as byte[] (not ref)
p70836
aVTrouble is that you'll have to guess the size of the array up front
p70837
aVA failure mode would be guessing the size too small
p70838
aVThe third one requires a COM IStream
p70839
aVDeclare it as out System
p70840
aVRuntime
p70841
aVInteropServices
p70842
aVComTypes
p70843
aVIStream
p70844
aVIt behaves a lot like a
p70845
aVNET Stream, you'd call Seek to seek to the beginning and Read to read the data
p70846
aVI'd go for the first one, least likely to blow up in your face
p70847
as(dp70848
g9
V17034
p70849
stp70850
a((dp70851
g2
(lp70852
VI'm fairly sure they got renamed because of their grating violation of the
p70853
aVNET framework naming standards
p70854
aVAn interface type name needs to start with the letter "I"
p70855
aVThere are a few very subtle differences between the declarations, nothing that's going to get you into trouble
p70856
as(dp70857
g9
V17034
p70858
stp70859
a((dp70860
g2
(lp70861
VIt depends on the state of your disk and whether or not the DLLs might be used in other processes
p70862
aVA cold start happens when your program and its DLLs were never loaded before
p70863
aVAn EXE without DLLs has a faster cold start since only one file needs to be found
p70864
aVYou would have to have a badly fragmented disk that's almost full to not have this case
p70865
aVA DLL can start to pay off when it is already loaded in another process
p70866
aVNow the code pages of the DLL are simply shared, startup overhead is very low and memory usage is efficient
p70867
aVA somewhat similar case is a warm start, a startup where the DLL is still available in the file system cache from a previous time it was used
p70868
aVThe difference between a cold and a warm start can be quite significant on a sluggish disk
p70869
aVThe one reason that everybody likes a SSD
p70870
as(dp70871
g9
V17034
p70872
stp70873
a((dp70874
g2
(lp70875
VMake the image property setter smarter
p70876
aVFor example:
p70877
aVNow the visible image refreshes automatically
p70878
as(dp70879
g9
V17034
p70880
stp70881
a((dp70882
g2
(lp70883
VNot through the IDE
p70884
aVYou could write a macro to achieve this, EnvDTE
p70885
aVDebugger
p70886
aVBreakpoints
p70887
aVAdd() method
p70888
aVIt lets you specify the Condition property directly
p70889
aVNot so sure that the time you'll burn on this is equivalent to pressing F5 repeatedly
p70890
as(dp70891
g9
V17034
p70892
stp70893
a((dp70894
g2
(lp70895
VYou are fooling the compiler, preventing it from checking that you wrote the correct code
p70896
aVAn Object
p70897
aVFoo() call is late bound, it is sorted out at runtime which exact function should be called
p70898
aVThe compiler can't do any checking, it doesn't know what methods the object supports
p70899
aVThe underlying plumbing is COM's IDispatch interface
p70900
aVNeedless to say perhaps, this doesn't solve anything, it just makes a loud bang at runtime
p70901
aVNot sure why you are doing this, maybe the
p70902
aVidl in the MFC project is missing the [out,retval] attribute for the function return value
p70903
as(dp70904
g9
V17034
p70905
stp70906
a((dp70907
g2
(lp70908
VIt's never been a particularly quick dialog, there's a ton of info buried in it, but a minute is outrageous
p70909
aVThe symbol server settings does not affect this dialog, that can't be it
p70910
aVDo watch out for using the Add option, maybe used in a previous project with an exception type that was defined in an assembly that's not there anymore
p70911
aVMaybe on a network share, long delays like that are almost always network timeouts
p70912
aVGet better insight in what's cranking away during this minute with SysInterals' ProcMon utility
p70913
as(dp70914
g9
V17034
p70915
stp70916
a((dp70917
g2
(lp70918
VYou'll have to customize it
p70919
aVLike this:
p70920
aVSample usage:
p70921
aVYou get no help from System
p70922
aVGlobalization to make this work in other languages
p70923
as(dp70924
g9
V17034
p70925
stp70926
a((dp70927
g2
(lp70928
VThe difference is that Notepad is using the printer driver, you are bypassing it
p70929
aVZebra printers have some support for using its built-in fonts
p70930
aVIt's got character sets for codepage 950 and something it calls "Latin 1" and "Latin 9"
p70931
aVKey problem is that none of them contain the glyphs you need
p70932
aVThe printer driver solves this problem by sending graphics to the printer, not strings
p70933
aVThe programming manual is here btw
p70934
aVI would imagine that these printers have some kind of option to install additional fonts, hard to make the sale in the rest of the world if that wouldn't be the case
p70935
aVContact your friendly printer vendor for support and options
p70936
as(dp70937
g9
V17034
p70938
stp70939
a((dp70940
g2
(lp70941
VWell, if you create multi-page documents then you should already have a page counter in your code
p70942
aVYou set it to zero in the BeginPrint event handler and increment it in the PrintPage event handler
p70943
aVAnd use the value to figure out what page needs to be printed
p70944
aVYou set e
p70945
aVHasMorePages to true if you are not done yet
p70946
aVThat strategy makes it simple to implement PrintRange
p70947
aVJust set set the page number in the BeginPrint event to the start page - 1 instead of 0
p70948
aVAnd avoid setting e
p70949
aVHasMorePages to true when the last page in the range was printed
p70950
as(dp70951
g9
V17034
p70952
stp70953
a((dp70954
g2
(lp70955
VIt isn't clear what kind of class library you are using
p70956
aVHowever, invoking Update() is fundamentally wrong
p70957
aVPainting the UI is a low priority task, it should only be done when nothing more important needs to be taken care of
p70958
aVThe proper thing to do is call Invalidate()
p70959
aVYou can call it as many times as you want, it cannot 'backup'
p70960
aVWhen the UI thread is ready and willing, then it will paint the user interface
p70961
aVIf the changes happen faster then the UI thread can keep up with then no harm is done, the intermediary paint just didn't happen
p70962
aVWhich is in general something else you need to take care of
p70963
aVIt is pretty easy to shoot the foot and invoke hundreds of times per second
p70964
aVWhich is pointless, a human cannot perceive changes that fast
p70965
aVForty times per second is plenty, it looks as smooth as a movie in cinema
p70966
aVRealistically you should use less
p70967
as(dp70968
g9
V17034
p70969
stp70970
a((dp70971
g2
(lp70972
VThe first part of your question is the expected outcome, CLR version 2 cannot load
p70973
aVNET 4
p70974
aV0 assemblies, the metadata format has changed
p70975
aVThe last paragraph is harder to explain
p70976
aVIt might have something to do with using LoadFile(), it's a frikin gawdawful way to load assemblies
p70977
aVOne possible failure mode is that your plug-in assembly might still have references to 2
p70978
aV0 assemblies
p70979
aVThis is pretty normal when it has a reference to yet another assembly that was compiled to target an earlier framework
p70980
aVThis is normally silently resolved by the assembly loader, it just replaces the 2
p70981
aV0 reference with the corresponding 4
p70982
aV0 reference
p70983
aVYou can verify this theory with ildasm
p70984
aVexe, run it on the plug-in assembly and looks through the manifest for
p70985
aVassembly directives
p70986
aVThe version number is easy to see, you'd get something like
p70987
aVAlways favor Assembly
p70988
aVLoadFrom()
p70989
as(dp70990
g9
V17034
p70991
stp70992
a((dp70993
g2
(lp70994
VYour code just isn't the same
p70995
aVIn the Python code you are clearly using the common "Application" object
p70996
aVIn many automation object models, that's the object from which you create other ones
p70997
aVLike IQXDM2 from the GetIQXDM2() method
p70998
aVYour C# code seems to be trying to create the class that implements IQXDM2 directly
p70999
aVCannot work, you have to go through the Application interface
p71000
aVIt's just like the error message says, there's no "class factory" for that object, the Application interface creates it
p71001
aVWhatever it is called, it is almost always has "application" in the name
p71002
aVUse Object Browser on the interop reference to have a look-see
p71003
aVLook for the one that has the GetIQXDM2 method
p71004
aVIf you don't see anything resembling it then you may have added the wrong DLL
p71005
aVLook in the registry for the name of the right one
p71006
aVStart Regedit
p71007
aVexe and look at HKCR\u005cQXDM
p71008
aVApplication
p71009
aVYou'll find a CLSID key with a guid
p71010
aVThen look at  where {guid} is the guid you found
p71011
aVThe InprocServer32 key has the DLL name
p71012
aVAn out-of-process server uses the LocalServer32 key
p71013
aVIf that doesn't pan out then maybe the COM server was only meant to be used by scripting languages
p71014
aVVery unusual but it can happen
p71015
aVIn which case you'll have to use it late-bound in your C# code
p71016
aVThat's only easy to do with the C# 4
p71017
aV0 dynamic keyword or VB
p71018
aVNET
p71019
as(dp71020
g9
V17034
p71021
stp71022
a((dp71023
g2
(lp71024
VNot sure I can follow this
p71025
aVEnvironment variable values are only ever inherited from the process that starts a new process
p71026
aVWhen you set them in a
p71027
aVbat or
p71028
aVcmd file, you are altering only the variable values of the cmd
p71029
aVexe process that executes the batch file
p71030
aVIf you then start devenv
p71031
aVexe from that same cmd
p71032
aVexe session then Visual Studio will have those altered/added environment variables as well
p71033
aVWhat does not work is starting Visual Studio from Explorer
p71034
aVThat got started way back when you logged in
p71035
aVIt got initialized with the system environment
p71036
aVWhich you can modify with the Control Panel + System applet
p71037
aVAdvanced, Environment variables button
p71038
aVTo make the changes here effective, you have to restart a process so it gets initialized with these altered settings
p71039
aVWhich in effect means that you have to restart Explorer
p71040
aVYes, logging out does that
p71041
as(dp71042
g9
V17034
p71043
stp71044
a((dp71045
g2
(lp71046
VJust use the  property, set it back to
p71047
aVSet the  property to, say,  so it can't grow horizontally, only vertically
p71048
as(dp71049
g9
V17034
p71050
stp71051
a((dp71052
g2
(lp71053
VIt was a Very Big Deal in versions of VS prior to 2010
p71054
aVmt
p71055
aVexe embeds the auto-generated manifest in the executable image, important to get the DLL dependencies that are stored in the Windows side-by-side cache listed
p71056
aVNot much of a big deal anymore, it only embeds an "I'm compatible with Vista" manifest now
p71057
aVThe side-by-side cache was rather a big headache and abandoned for VS2010
p71058
aVYou ought to check the
p71059
aVmanifest file in the build directory and make sure nothing important is in it
p71060
aVLike the common dialogs version 6 entry that enables visual styles
p71061
as(dp71062
g9
V17034
p71063
stp71064
a((dp71065
g2
(lp71066
VThe technical answer is that this is impossible to measure or quantify, it heavily depends on the state of the CPU memory write-back buffers
p71067
aVWhich is very non-deterministic
p71068
aVThe practical answer is that it is waaaay cheaper than the amount of time you'll burn on debugging your code when you think you can skip a lock
p71069
as(dp71070
g9
V17034
p71071
stp71072
a((dp71073
g2
(lp71074
VAlthough thread collision is inherently a random process
p71075
aVNot at all
p71076
aVIt is critically dependent on timing
p71077
aVAnd timing can be repeatable, systems tend to settle into specific patterns
p71078
aVA thread race diagnostic tool like Microsoft Research's CHESS works by injecting random delays into a thread's execution
p71079
aVTo get the system to fall out of such a pattern
p71080
aVLike it occasionally does by itself, but only once a week or so
p71081
aVThat is random, just not random enough to ever give you a shot a debugging the problem
p71082
aVThus, seeing one server fail and not the other doesn't mean anything
p71083
aVThe load balancer probably has something to do with it
p71084
aVYou'll just never be able to figure out the exact reason because you cannot find out what happened those 50 times
p71085
aVIt isn't enough
p71086
as(dp71087
g9
V17034
p71088
stp71089
a((dp71090
g2
(lp71091
VWell, it certainly matters
p71092
aVWhen you use an "ignore case" equality comparison then you're invoking a fairly massive chunk of code in the
p71093
aVNET framework that's aware of how casing rules work in the current culture
p71094
aVThe rules of which are very interesting to a former-postage-stamp collector geek like me, there are some pretty odd-ball rules depending where you look
p71095
aVThe Turkish I problem is famous, the Unicode dudes had to make an explicit exception for them
p71096
aVIt isn't actually code btw, it's lookup tables
p71097
aVInteresting in itself because it requires MSFT to maintain the /linkres command line option for the C# compiler
p71098
aVA compile option you cannot use in your own projects
p71099
aVIt's solely there to get mscorlib to be able to find the
p71100
aVnlp files, the conversion tables for culture rules
p71101
aVStored in the same subdirectory of the GAC as mscorlib
p71102
aVdll, the effect of the compile option
p71103
aVBut I digress
p71104
aVIt stands to reason that StringComparison
p71105
aVOrdinalIgnoreCase is a wee bit quicker than StringComparison
p71106
aVInvariantCultureIgnoresCase
p71107
aVJust because 'invariant' means USA, home of MSFT
p71108
aVHard to measure, this clocks in at nanoseconds
p71109
aVStringComparison
p71110
aVCurrentCultureIgnoreCase hits those translation tables
p71111
aVDead slow when you first use it, just slower when you use them later
p71112
as(dp71113
g9
V17034
p71114
stp71115
a((dp71116
g2
(lp71117
VHmm, that doesn't make a lot of sense
p71118
aVYou don't reference a 'library project', you reference the DLL that it produces
p71119
aVProject + Add Reference, Browse tab
p71120
aVThere's no known problem with that, within a 95% accuracy guess, mixed mode assemblies have a few hairs
p71121
aVIf you actually try to load a vs2005 project into a vs2010 solution, then yes, it's going to try to convert the project file
p71122
aVAnd that turns vs2005 catatonic, it doesn't have the time machine to guess what a vs2010 project looks like
p71123
aVJust making a copy of the project directory solves that problem
p71124
as(dp71125
g9
V17034
p71126
stp71127
a((dp71128
g2
(lp71129
VThis happens with local variables and memory allocated from the heap with malloc()
p71130
aVLocal variables are the more typical mishap
p71131
aVThey are stored in the stack frame of the function
p71132
aVWhich is created simply by adjusting the stack pointer by the amount of storage required for the local variables
p71133
aVThe values those variables will have upon entry of the function is essentially random, whatever happened to be stored in those memory locations from a previous function call that happened to use the same stack area
p71134
aVIt is a nasty source of hard to diagnose bugs
p71135
aVNot in the least because the values aren't really random
p71136
aVAs long as the program has predictable call patterns, it is likely that the initial value repeats well
p71137
aVA compiler often has a debug feature that lets it inject code in the preamble of the function that initializes all local variables
p71138
aVA value that's likely to produce bizarre calculation results or a protected mode access violation
p71139
aVNotable perhaps as well is that managed environments initialize local variables automatically
p71140
aVThat isn't done to help the programmer fall into the pit of success, it's done because not initializing them is a security hazard
p71141
aVIt lets code that runs in a sandbox access memory that was written by privileged code
p71142
as(dp71143
g9
V17034
p71144
stp71145
a((dp71146
g2
(lp71147
VIt is important that you document the type name that it complains about to get a good answer
p71148
aVAvoid targeting the
p71149
aVNET client profile whenever you do something webby
p71150
aVSystem
p71151
aVWeb
p71152
aVdll is not part of it
p71153
aVProject + Properties, Application tab, Target framework combo
p71154
as(dp71155
g9
V17034
p71156
stp71157
a((dp71158
g2
(lp71159
VWell, this makes no sense the way you described it
p71160
aVWhich probably means that what you think is going on is not what is really happening
p71161
aVDebugging threaded code is quite difficult, very hard to capture the state of the program at the exact moment it misbehaves
p71162
aVA generic approach is to add logging to your code
p71163
aVSprinkle your code with Debug
p71164
aVWriteLine() statements that shows the current value of the variable, along with the thread's ManagedId
p71165
aVYou get potentially a lot of output, but somewhere you'll see it going wrong
p71166
aVOr you get enough insight in how thread(s) are interacting to guess the source of the problem
p71167
aVJust adding the logging can in itself solve the problem because it alters the timing of code
p71168
aVSucks when that happens
p71169
as(dp71170
g9
V17034
p71171
stp71172
a((dp71173
g2
(lp71174
VIt is because of the prerequisites
p71175
aVThe
p71176
aVNET 4
p71177
aV0 installer requires the target machine to be updated to
p71178
aVXP SP3
p71179
aVVista SP1
p71180
aVServer 2003 SP2
p71181
aVServer 2008 or Win7
p71182
aVThe 3
p71183
aV5 SP1 installer is much more lenient, it can even run on the original version of XP
p71184
aVTo make that work, it needs to include updates of many of the core Windows components
p71185
aVA significant chunk of that 231 MB installer are not actually
p71186
aVNET components
p71187
aVAlso notable is that in
p71188
aVNET 4
p71189
aV0, the difference between the client profile and the full version has largely disappeared
p71190
aVThe full version is only 15% bigger, there isn't much point in targeting the client profile
p71191
as(dp71192
g9
V17034
p71193
stp71194
a((dp71195
g2
(lp71196
VThe Visible property is a bit special, its getter doesn't return the value you assigned
p71197
aVIt tells you if the control is actually visible
p71198
aVWhich it is not if it is placed on a tab page that isn't selected
p71199
aVThis is by design
p71200
aVGetting the actual "intends to be visible" state isn't supported
p71201
aVYou'd get it out of GetState(2) but that's an internal method
p71202
aVIf you're really desperate then you could use Reflection
p71203
aVBut the proper way is to just keep track of it yourself
p71204
as(dp71205
g9
V17034
p71206
stp71207
a((dp71208
g2
(lp71209
VThis is entirely normal
p71210
aVThe tab order is set by the controls' TabIndex property
p71211
aVIt starts out at 0 and increments each time you add a new control
p71212
aVWinforms otherwise has no way to guess that you want a different order
p71213
aVShort from editing the TabIndex values, you can use View + Tab Order to set it quickly
p71214
aVYou'll see light blue numbers that indicate the current order
p71215
aVClick the controls in the order you want
p71216
aVIf these controls are added at runtime then it is up to you to write the code to set their TabIndex property correctly
p71217
as(dp71218
g9
V17034
p71219
stp71220
a((dp71221
g2
(lp71222
VIt is called ClickOnce
p71223
aVProject + Add Existing Item and select that DLL
p71224
aVThat adds it to your project
p71225
aVSelect it and look in the Properties window
p71226
aVBuild Action should be set to "Content", that makes ClickOnce publish it
p71227
aVCopy to Output Directory should be set to "Copy if newer", that ensures that the DLL is copied to your build output directory
p71228
aVWhat you did by hand previously
p71229
as(dp71230
g9
V17034
p71231
stp71232
a((dp71233
g2
(lp71234
VCreated a dependency
p71235
aVNobody ever says that
p71236
aVWhich I'd have to guess is the source of the problem, you "add a reference"
p71237
aVProject + Add Reference
p71238
as(dp71239
g9
V17034
p71240
stp71241
a((dp71242
g2
(lp71243
VJust use the TreeView
p71244
aVAfterSelect event
p71245
aVIt fires anytime the user selects another node, either by keyboard or mouse
p71246
aVBe sure to dispose the old DGV if you replace it completely
p71247
as(dp71248
g9
V17034
p71249
stp71250
a((dp71251
g2
(lp71252
VI actually create a new instance of the moblist class every time I pass the list
p71253
aVWhich only prevents the list from changing, not the list elements
p71254
aVYou'd have to clone the element objects as well
p71255
aVI don't have a clue with radars and mobs do, you might want to consider using Send instead of Post
p71256
as(dp71257
g9
V17034
p71258
stp71259
a((dp71260
g2
(lp71261
VThis is not possible, BGW uses a threadpool thread
p71262
aVTP threads are always MTA, it cannot be changed
p71263
aVYou will have to use a regular Thread, call SetApartmentState() before you start it
p71264
aVThis thread also should pump a message loop, call Application
p71265
aVRun()
p71266
aVMaybe you ought to consider calling this code from the UI thread
p71267
aVBecause in all likelihood, the COM server is running its methods on the UI thread anyway
p71268
aVMarshaling calls from a worker thread to the STA thread that created the COM server is automatic, COM takes care of it
p71269
aVOr take the bull by the horns and marshal yourself
p71270
aVYou can create your own STA thread to give the server a happy home
p71271
aVYou'll find code in this post, be sure to create the COM object in your Initialize() override
p71272
as(dp71273
g9
V17034
p71274
stp71275
a((dp71276
g2
(lp71277
VDispatcherUnhandledException isn't the right one
p71278
aVThat is only raised when code on the UI thread bombs
p71279
aVYou probably got something going kaboom on a worker thread or before the app even managed to get started
p71280
aVYou have to write an event handler for AppDomain
p71281
aVCurrentDomain
p71282
aVUnhandledException
p71283
aVCalling Environment
p71284
aVExit() stops the WER dialog from showing
p71285
aVDo make sure to log something, nobody much cares for apps that just suddenly flicks out of existence with some traceable reason why
p71286
aVLog e
p71287
aVExceptionObject
p71288
aVToString() to get the exception message and the stack trace recorded
p71289
aVOften good enough to diagnose the problem
p71290
as(dp71291
g9
V17034
p71292
stp71293
a((dp71294
g2
(lp71295
VIt's a bit odd that you mention C#
p71296
aVIt has very powerful keywords to keep the usual inheritance misery in check
p71297
aVThe first one ought to be the internal keyword
p71298
aVThe notion of restricting the visibility to a module
p71299
aVThat concept is completely absent in C++, the build model just doesn't support it
p71300
aVOtherwise a great concept, "I only trust the members of my team to get it right"
p71301
aVOf course you do
p71302
aVThen there's the slammer one, the sealed keyword
p71303
aVExtraordinary powerful, "the buck stops here, don't mess with me"
p71304
aVUsed with surgical precision in the
p71305
aVNET framework, I've never yet found a case where sealed was used inappropriately
p71306
aVAlso missing in C++, but with obscure ways to get that working
p71307
aVBut yes, the WPF object model sucks fairly heavy
p71308
aVInheriting 6 levels deep and using backdoors like a dependency property is offensive
p71309
aVInheritance is hard, let's go shopping
p71310
as(dp71311
g9
V17034
p71312
stp71313
a((dp71314
g2
(lp71315
VSure, use the ListBox
p71316
aVDrawMode property
p71317
aVImplement the DrawItem event to draw anything you like, it doesn't have to be just text
p71318
aVThe Pen
p71319
aVDashStyle is interesting here
p71320
as(dp71321
g9
V17034
p71322
stp71323
a((dp71324
g2
(lp71325
VYou're a bit limited in being able to create marshalable interfaces in C#
p71326
aVNo easy way to setup the proxy
p71327
aVNo such problem in ATL, declare a callback interface in the IDL
p71328
aVAnd pass an instance pointer with the RegisterWorker() call
p71329
aVThe server should store it until it gets the unregister call
p71330
aVUse that callback interface to generate notifications
p71331
as(dp71332
g9
V17034
p71333
stp71334
a((dp71335
g2
(lp71336
VJust in case you're thinking of pushing pixels around, that's not going to work
p71337
aVYou need to make a mathematical model of the wave propagation first
p71338
aVTen-thousand feet view is a class Ripple that can model the propagation of a wave
p71339
aVThen a List(Of Ripple) that stores the state of the box
p71340
aVEvery time the timer ticks, update the state of the ripples
p71341
aVAnd draw the image to go with that
p71342
aVKey point is that the image gets recreated from scratch on each tick
p71343
aVOne important reason why the web site's image is so small
p71344
as(dp71345
g9
V17034
p71346
stp71347
a((dp71348
g2
(lp71349
VYes, installing a service isn't particularly complicated
p71350
aVIt just takes writing a handful of registry keys
p71351
aVYou can have a look-see with Regedit
p71352
aVexe, navigate to HKEY_LOCAL_MACHINE\u005cSYSTEM\u005cCurrentControlSet\u005cservices
p71353
aVSc
p71354
aVexe can write these keys too, using the supplied command line arguments
p71355
aVNevertheless, this is not the right way to do it
p71356
aVThe point of InstallUtil
p71357
aVexe is that it can activate custom installation code
p71358
aVCode that the service author wrote
p71359
aVWhich is not that uncommon, services tend to stuff config info in their registration keys for their own use
p71360
aVYou'll see plenty of evidence for that when you have a look with Regedit
p71361
as(dp71362
g9
V17034
p71363
stp71364
a((dp71365
g2
(lp71366
VYour regasm command destroyed the registry keys for the COM server
p71367
aVYou'll have to reinstall it
p71368
aVOnly use regasm on your own [ComVisible] code
p71369
aVOne reason you may have trouble using the component, beyond it just not having been installed correctly, is because you are trying to run this on a 64-bit operating system
p71370
aVAnd the component is 32-bit, by far the most common case
p71371
aVYou need to force your app to run in 32-bit mode to be able to use it
p71372
aVIn the VB
p71373
aVNET IDE, that's done with Project + Properties, Compile tab, scroll down, Advanced Compile Options, set Target CPU to "x86"
p71374
aVThe ultimate troubleshooting tool for problems like this is SysInternals' ProcMon utility
p71375
aVIt shows you how COM is using the HKLM\u005cSoftware\u005cClasses\u005cCLSID key to search for the DLL to load
p71376
as(dp71377
g9
V17034
p71378
stp71379
a((dp71380
g2
(lp71381
VYes, but you'll have to do it in code, the designer doesn't support it
p71382
aVLike this:
p71383
as(dp71384
g9
V17034
p71385
stp71386
a((dp71387
g2
(lp71388
VYou'll have to take advantage of the MouseHover event you can get out of the control
p71389
aVThis worked well enough:
p71390
as(dp71391
g9
V17034
p71392
stp71393
a((dp71394
g2
(lp71395
VYour premise isn't very realistic
p71396
aVMaybe your process has the optimum number of threads, the rest to the operating system has many hundred other threads
p71397
aVSome of which might be ready to run and will gladly grab a CPU core when your thread yields
p71398
aVFurthermore, if the thread is about to be blocked, it is likely to happen because of a lock held by one of the other threads in your process
p71399
aVWhich might release it during the spin-wait time
p71400
aVThe number of threads isn't relevant to that
p71401
aVIt thus still make sense to spin-wait
p71402
as(dp71403
g9
V17034
p71404
stp71405
a((dp71406
g2
(lp71407
VYou need to store the references so you can compare them later
p71408
aVSomething like:
p71409
aVDon't forget to dispose them in the form's Dispose() method
p71410
as(dp71411
g9
V17034
p71412
stp71413
a((dp71414
g2
(lp71415
VYou should be using the Interlocked class here, the Decrement() method to decrease the count
p71416
aVYes, everywhere the variable is accessed
p71417
aVUsing SyncLock Me is as bad as SyncLock GetType(Me)
p71418
aVYou should always use a private object to lock on so nobody can accidentally cause a deadlock
p71419
aVThe golden rule is that you cannot lock data, you can only block code from accessing data
p71420
aVSince the code is your private implementation detail, the object that holds the lock state must also be a private detail
p71421
aVNeither your object (Me) nor the Type of that object is private
p71422
aVAllowing other code to lock it by accident
p71423
as(dp71424
g9
V17034
p71425
stp71426
a((dp71427
g2
(lp71428
VPinning would be required
p71429
aVHowever, you are storing this 'reference', requiring the object to stay pinned
p71430
aVThat's quite unhealthy, the garbage collector would constantly have to work around it
p71431
aVAnother problem is that just pinning isn't enough, there has to be a recognizable reference to the object so that the GC won't collect the object
p71432
aVThe stored void* isn't good enough
p71433
aVYou'd normally solve this with gcroot<> but that can't work here either
p71434
aVA better approach is to simply pass a 'handle'
p71435
aVUse a  to convert the void* back to the object
p71436
aVOr a , now the index could be the handle
p71437
as(dp71438
g9
V17034
p71439
stp71440
a((dp71441
g2
(lp71442
VYour explicitly implemented ITest
p71443
aVFind method is private
p71444
aVYou'll need to use BindingFlags in your GetMethods call:
p71445
as(dp71446
g9
V17034
p71447
stp71448
a((dp71449
g2
(lp71450
VUgh, that's fugly
p71451
aVHard to characterize this as anything other than a bug
p71452
aVThe default formatting for NaN when you let the IDE generate the method signature shows what language the VB
p71453
aVNET team uses, that's the way the C++ runtime library formats NaN
p71454
aVAttempts to convince it you know what you are doing are indeed futile, afaict
p71455
aVYou can report this at connect
p71456
aVmicrosoft
p71457
aVcom
p71458
aVWhile you wait for the 'fixed in the next version of Visual Studio' to see the light of day, you might consider using nullable types as the workaround:
p71459
aVFwiw, it does work when you use Double
p71460
aVEpsilon as the default value
p71461
aVKinda silly but not an entirely unreasonable workaround either
p71462
aVJust don't let the IDE generate the implementation, then it gets silly
p71463
as(dp71464
g9
V17034
p71465
stp71466
a((dp71467
g2
(lp71468
VThis MSDN Library page is very relevant
p71469
aVIt says this about the D or d format specifier:
p71470
aVThe "D" (or decimal) format specifier
p71471
aVconverts a number to a string of
p71472
aVdecimal digits (0-9), prefixed by a
p71473
aVminus sign if the number is negative
p71474
aVThis format is supported only for
p71475
aVintegral types
p71476
aVWhich is a problem, TimeSpan
p71477
aVHours returns a double value, not an integral value, like TimeSpan
p71478
aVMinutes does
p71479
aVYou can fix this problem by truncating (not rounding) the double value, like this:
p71480
as(dp71481
g9
V17034
p71482
stp71483
a((dp71484
g2
(lp71485
VThis was added back to the language in the version of VB
p71486
aVNET that came with VS2005
p71487
aVBy popular demand, VB6 programmers had a hard time with seeing the difference between a type and a reference to an object of that type
p71488
aVForm1 vs frm in your snippet
p71489
aVThere's history for that, VB didn't get classes until VB4 while forms go all the way back to VB1
p71490
aVThis is otherwise quite crippling to the programmer's mind, understanding that difference is very important to get a shot at writing effective object oriented code
p71491
aVA big part of the reason that C# doesn't have this
p71492
aVYou can get this back in C# as well, albeit that it won't be quite so clean because C# doesn't allow adding properties and methods to the global namespace like VB
p71493
aVNET does
p71494
aVYou can add a bit of glue to your form code, like this:
p71495
aVYou can now use Form2
p71496
aVInstance in your code, just like you could use Form2 in VB
p71497
aVNET
p71498
aVThe code in the if statement of the property getter should be moved into its own private method to make it efficient, I left it this way for clarity
p71499
aVIncidentally, the [ThreadStatic] attribute in that snippet is what has made many VB
p71500
aVNET programmers give up threading in utter despair
p71501
aVA problem when the abstraction is leaky
p71502
aVYou are really better off not doing this at all
p71503
as(dp71504
g9
V17034
p71505
stp71506
a((dp71507
g2
(lp71508
VThis is not supported by the IDE
p71509
aVThese resources are not the kind that you're familiar with, they are unmanaged resources
p71510
aVThe VB
p71511
aVNET compiler does support the option, /win32resource, you'll however have to run it by hand
p71512
aVYou'll also need to run the rc
p71513
aVexe tool by hand to create the
p71514
aVres file
p71515
aVUsing VB
p71516
aVNET is just not the best way to get this done
p71517
aVIt is natively supported by the C++ IDE
p71518
aVFile + New + Project
p71519
aVSelect Visual C++, Win32, Win32 Project
p71520
aVNext, select DLL
p71521
aVRight-click the Resource Files folder in the Solution Explorer window
p71522
aVAdd + Resource, Import and select the icon
p71523
aVRepeat as necessary for every icon you want to add
p71524
aVBuild + Build
p71525
aVYou can use View + Other Windows + Resource View to edit the content
p71526
aVOne thing you almost certainly want to do is change the ID of the icon from a symbol to a number
p71527
aVThat's the number you'll use in the registry entry
p71528
as(dp71529
g9
V17034
p71530
stp71531
a((dp71532
g2
(lp71533
VYou could download symbol packages too
p71534
aVStart point is here
p71535
as(dp71536
g9
V17034
p71537
stp71538
a((dp71539
g2
(lp71540
VRun rc
p71541
aVexe to compile the
p71542
aVrc script into a
p71543
aVres
p71544
aVPass that to the linker to get it embedded in the final image
p71545
aVThere are preciously few reasons to not just let the IDE take care of this btw
p71546
aVIt does a lot of other stuff automagically
p71547
aVLike getting the proper manifest embedded
p71548
aVAnd creating a debug build that helps you diagnose uninitialized variables and stack corruption
p71549
aVAnd supporting edit + continue
p71550
aVBut yes, you can do this too if you know all the command line switches
p71551
aVBest way to find them is to build some sample projects with the IDE and look at the build log files to see what's being used
p71552
as(dp71553
g9
V17034
p71554
stp71555
a((dp71556
g2
(lp71557
VDebug + Exceptions, tick the Thrown checkbox for "Common Language Runtime Exceptions"
p71558
aVThe debugger will now stop on the first chance notification
p71559
aVThe usual cause is a catch statement in your code, maybe the VB
p71560
aVNET On Error statement
p71561
aVOr a bug in the 64-bit debugger's interaction with Windows Forms
p71562
aVAfter it breaks, use Debug + Windows + Call stack and check if the form's Load event handler is on the call stack
p71563
aVThe bug causes unhandled exceptions to be swallowed without a diagnostic
p71564
aVTo work around that, use Project + Properties, Compile tab, scroll down, Advanced Compile Options
p71565
aVChange the Target CPU setting to "x86"
p71566
aVThis is the default setting for VS2010 projects btw
p71567
aVYou'll now use the 32-bit debugger, it doesn't have this problem
p71568
aVAnd you can use Edit + Continue
p71569
as(dp71570
g9
V17034
p71571
stp71572
a((dp71573
g2
(lp71574
VIt shouldn't
p71575
aVThe RichEdit control itself determines the scroll range of the scroll bar
p71576
aVWhich it does depending on how much text it displays
p71577
aVOverriding it isn't going to last long, if at all
p71578
aVYou can only use GetScrollInfo() to find out what it is using currently
p71579
aVThis is going to change as soon as the user adds text
p71580
as(dp71581
g9
V17034
p71582
stp71583
a((dp71584
g2
(lp71585
VThe compiler is happy with your code, which indicates that the reference assembly does not match the assembly that's found at runtime
p71586
aVUse the Fuslogvw
p71587
aVexe tool to find out what assembly is getting loaded
p71588
aVBe sure to log all the binds, not just the failed ones
p71589
aVThe odds are good that it is finding the wrong version of FileNet
p71590
aVApi
p71591
aVdll, possibly because an old version is stored in the GAC
p71592
aVAvoid using the GAC on your dev machine
p71593
as(dp71594
g9
V17034
p71595
stp71596
a((dp71597
g2
(lp71598
VYou'll want to use a ColorMatrix here
p71599
aVThe source image is grayscale, all its R, G and B values are equal
p71600
aVThen it is just a matter of replacing black with RGB = (0, 0, 255) for dark blue, white with RGB = (255, 255, 255) to get white
p71601
aVThe matrix thus can look like this:
p71602
aVThis sample form reproduces the right side image:
p71603
as(dp71604
g9
V17034
p71605
stp71606
a((dp71607
g2
(lp71608
VYou forgot to initialize that
p71609
aVFix:
p71610
as(dp71611
g9
V17034
p71612
stp71613
a((dp71614
g2
(lp71615
VThat's because there is no active form anymore, you've hidden the one that could be active
p71616
aVThis has other side effects, your app will lose the focus
p71617
aVWhat you need to do is keep track of the previously active form and get it to show again before the dialog closes
p71618
aVLike this:
p71619
as(dp71620
g9
V17034
p71621
stp71622
a((dp71623
g2
(lp71624
VYes, there is no worse bug then the one you can't see, code that's off the right of the screen edge
p71625
aVI had some real doozies before discovering that by myself and making a Stone Cold Hard Rule about that
p71626
aVIf you don't have VB 10 yet then you can use space + underscore to break the line:
p71627
as(dp71628
g9
V17034
p71629
stp71630
a((dp71631
g2
(lp71632
VDon't use GetHashCode() here
p71633
aVJust number your hot keys, start at 0
p71634
aVThere isn't any danger of getting the ids mixed up, hot key ids are specific for each Handle
p71635
aVYou'll get the id back in the WndProc() method
p71636
aVUse m
p71637
aVWParam
p71638
aVToInt32() to get the value:
p71639
as(dp71640
g9
V17034
p71641
stp71642
a((dp71643
g2
(lp71644
VWIC, what you see on the top of the stack trace, is the underlying imaging library for WPF
p71645
aVIt is a COM component, written in C++
p71646
aVIt is not unusual for unmanaged code to bomb with AccessViolation
p71647
aVYou could possibly wring some more info out of the stack trace by enabling unmanaged code debugging and enabling the Microsoft Symbol Server
p71648
aVNevertheless, the odds are not good to put any kind of dent in this problem
p71649
aVThe only knobs you can tweak is the image itself, it might be corrupt in a way that makes the code bomb
p71650
aVAnd make sure that service pack 1 is installed on the machine
p71651
aVBeyond this, you'll need the help from Microsoft Support
p71652
aVThey'll need a minidump of the crashing program and the image that causes the trouble
p71653
as(dp71654
g9
V17034
p71655
stp71656
a((dp71657
g2
(lp71658
VDon't try to run the Debug build of your program on another machine, only deploy the Release build
p71659
aVFor small programs like these, you don't have any need for the shared CRT dlls
p71660
aVRight-click your project in the Solution Explorer window, Properties, C/C++, Code Generation
p71661
aVBe sure the Release configuration is selected (upper left combo)
p71662
aVChange Runtime Library to /MT
p71663
as(dp71664
g9
V17034
p71665
stp71666
a((dp71667
g2
(lp71668
VThe normal rules apply, a managed process is not treated differently by the Windows memory manager
p71669
aVThe ultimate source for chunks of memory is the Windows memory manager
p71670
aVIf it cannot find a hole in the virtual memory address space to fit the requested memory allocation then it fails the VirtualAlloc() call and the CLR generates OOM
p71671
aVSame for swapping behavior, if pages in RAM are needed to map pages of other processes or even pages of the same process then they'll get swapped out
p71672
aVThis is not otherwise associated with OOM
p71673
aVYou cannot assume it will work exactly the same on XP as it does on Win7 x64
p71674
aVGetting OOM on x64 when you build your program targeting AnyCPU is quite unusual, a 64-bit operating system has a very large virtual memory address space
p71675
aVThe upper limit is set by the maximum size of the paging file
p71676
aVA 32-bit program will run in the WOW emulation layer, it can have a 4 GB address space if you set the LARGEADDRESSAWARE option bit with Editbin
p71677
aVexe
p71678
aVYou can use SysInteral's VMMap utility to see how the address space of your process is carved up
p71679
as(dp71680
g9
V17034
p71681
stp71682
a((dp71683
g2
(lp71684
VNo, you just need a window
p71685
aVBest thing is to startup a thread so you can pump a message loop and receive the icon notifications
p71686
aVCreate a little hidden window that you can use for the Shell_NotifyIcon() call
p71687
as(dp71688
g9
V17034
p71689
stp71690
a((dp71691
g2
(lp71692
VOnce you created a task bar out of your window with SHAppBarMessage, the window's location is controlled by the shell, depending on what edge you selected
p71693
aVYou need to use either ABM_REMOVE, which destroys the task bar completely, or ABM_SETSTATE which lets you change it to an auto-hide task bar
p71694
aVMoving another window on top of the task bar doesn't work, the shell prevents it to allow a task bar to behave like, well, a task bar
p71695
as(dp71696
g9
V17034
p71697
stp71698
a((dp71699
g2
(lp71700
VYou need to use unchecked to suppress the exception:
p71701
aVIf desired, you can then convert to DateTime with DateTime
p71702
aVFromFileTimeUtc()
p71703
as(dp71704
g9
V17034
p71705
stp71706
a((dp71707
g2
(lp71708
VThat's not correct C++ code
p71709
aVIt merely changes the pointer that was passed to the function
p71710
aVThis has no side effects whatsoever
p71711
aVFix:
p71712
aVBut never write interop code like this, the C++ function can easily destroy the garbage collected heap this way
p71713
aVWhich is exactly what happens in your code, the StringBuilder's Capacity isn't enough
p71714
aVYou should add an extra argument that provides the size of the passed buffer
p71715
aVFix:
p71716
aVPass the string builder's Capacity for that extra argument, like this:
p71717
as(dp71718
g9
V17034
p71719
stp71720
a((dp71721
g2
(lp71722
VThat's because you are not using the friendly IDE that takes care of these details for you
p71723
aVSince you're doing this by hand, it is up to you to copy the DLLs yourself
p71724
aVThe DLLs are now in the EXE's 'probing path', it won't have any trouble finding them
p71725
as(dp71726
g9
V17034
p71727
stp71728
a((dp71729
g2
(lp71730
VAre you running this on the 64-bit version of Windows
p71731
aVThen copy the DLL to c:\u005cwindows\u005csyswow64
p71732
aVOr better yet, in the same directory as your EXE so you don't mess with the operating system directories
p71733
as(dp71734
g9
V17034
p71735
stp71736
a((dp71737
g2
(lp71738
s(dp71739
g9
V17034
p71740
stp71741
a((dp71742
g2
(lp71743
VJust uncheck the "Use ValidatingType" checkbox in the task dialog
p71744
as(dp71745
g9
V17034
p71746
stp71747
a((dp71748
g2
(lp71749
VRight now you're trying to write to your own stdin handle, not the one for the cmd
p71750
aVexe process
p71751
aVYou'll have to do a lot more work to redirect the input handle for that one
p71752
aVIt requires a pipe
p71753
aVHere's a KB article that shows the boilerplate code
p71754
aVBtw: always check the return value of API functions
p71755
as(dp71756
g9
V17034
p71757
stp71758
a((dp71759
g2
(lp71760
VThis is part of the session 0 isolation feature that was added to Vista
p71761
aVServices now run their own session with their own workstation and desktop
p71762
aVMuch like the session that the login prompt and screen saver run in
p71763
aVYou are taking a screenshot of that session's desktop, there's nothing in it
p71764
aVGetting access to the user desktop is no longer possible
p71765
aVIt is a security feature, it prevents shatter attacks
p71766
aVAdmittedly, I don't understand why the 'interact with desktop' checkbox wasn't removed
p71767
aVYou'll need to change your program to run as a "windows application", not a service
p71768
aVPut a shortcut in the Startup folder or use the Run registry key
p71769
aVWhich is okay, there's nothing much worth snapping when no user is logged in
p71770
as(dp71771
g9
V17034
p71772
stp71773
a((dp71774
g2
(lp71775
VThat's because msbuild was able to find c
p71776
aVdll
p71777
aVIt doesn't know anything about the copy local setting of the B project
p71778
aVIt simply looks at the
p71779
aVassembly directives in the metadata of b
p71780
aVdll and sees that c
p71781
aVdll is a dependency
p71782
aVAnd if it can find c
p71783
aVdll then it will copy it
p71784
aVIf it cannot find it then nothing happens, no complaints either
p71785
aVThe odd part, and your solution, is that c
p71786
aVdll is present in the same directory as b
p71787
aVdll
p71788
aVHow did it get there
p71789
aVJust stop it from getting copied there and it won't get copied to the A build directory either
p71790
aVIt is otherwise quite murky how you'd expect this to ever run
p71791
as(dp71792
g9
V17034
p71793
stp71794
a((dp71795
g2
(lp71796
VYou are doing battle with a nasty bug in the 64-bit debugger
p71797
aVAny exceptions in the Load event are swallowed without a diagnostic
p71798
aVThe workaround is Project + Properties, Compile tab, Platform Target = x86
p71799
aVNow the debugger will stop at the exception
p71800
aVFixing it is your next task
p71801
aVJust in case: avoid catching exceptions that you shouldn't handle
p71802
aVUsing try/catch is not typically a real solution
p71803
aVJust a band-aid that spackles the injury
p71804
as(dp71805
g9
V17034
p71806
stp71807
a((dp71808
g2
(lp71809
VNote the name mismatch, "Setup" is missing from the one you downloaded
p71810
aVRename the file so its name matches the name VS is complaining about
p71811
as(dp71812
g9
V17034
p71813
stp71814
a((dp71815
g2
(lp71816
VThe settings designer embeds the default value in a [DefaultSettingValue] attribute
p71817
aVThe following section in the Remarks section of the attribute is relevant:
p71818
aVDifferent settings providers may have
p71819
aVdifferent requirements or limitations
p71820
aVon the use of the
p71821
aVDefaultSettingValueAttribute
p71822
aVFor
p71823
aVexample, the LocalFileSettingsProvider
p71824
aVdoes not require this attribute, and
p71825
aVwill override any value provided by
p71826
aVthis attribute if there are any
p71827
aVvalues\u2014default or user-modified\u2014
p71828
aValready present in the data store
p71829
aVLocalFileSettingsProvider is the default provider
p71830
aVSo, it's there but it doesn't get used
p71831
as(dp71832
g9
V17034
p71833
stp71834
a((dp71835
g2
(lp71836
VThat is not an exception, merely a warning from the debugger that it has trouble giving you the information you asked for
p71837
aVThat happens
p71838
aVDo make sure you have set the breakpoint correctly and haven't ended up in non-managed code with Debug + Break All
p71839
as(dp71840
g9
V17034
p71841
stp71842
a((dp71843
g2
(lp71844
VThis sounds like a classic XY question
p71845
aVSurely the X question is "how do I check if
p71846
aVNET is installed myself
p71847
aVBy checking the registry, well covered in other questions at SO
p71848
aVIf you really want to know what dotnetchk
p71849
aVexe does (not documented) then it is easy enough to reverse-engineer
p71850
aVUse SysInternals' ProcMon utility, have tracing turned on while you run dotnetchk
p71851
aVYou'll see all the registry keys and files it looks at in the trace
p71852
as(dp71853
g9
V17034
p71854
stp71855
a((dp71856
g2
(lp71857
VDebug + Windows + Memory + Memory 1, set the Address field to "array"
p71858
aVYou'll see this when you switch the view to "4-byte Integer":
p71859
aVThe first address is the address of the object in the garbage collected heap, plus the part of the object header that's at a negative offset (syncblk index)
p71860
aVYou cannot guess this value, the GC moves it around
p71861
aVThe 2nd hex number is the 'type handle' for the array type (aka method table pointer)
p71862
aVYou cannot guess this value, type handles are created by the CLR on demand
p71863
aVThe 3rd number is the array length
p71864
aVThe rest of them are the array element values
p71865
aVThe odds of reliably finding this array back at runtime without a debugger are quite low
p71866
aVThere isn't much point in trying
p71867
as(dp71868
g9
V17034
p71869
stp71870
a((dp71871
g2
(lp71872
VThat's a problem, that's not an Automation compatible function signature
p71873
aVArrays must be passed as a SafeArray and the function must return an HRESULT
p71874
aVRight now, the type library importer has no way guess that the first argument is an array, it could just as easily be a pointer to a single float value
p71875
aVWhich is what it guessed at, ref float
p71876
aVIf you cannot change the native code then you can technically edit the interop library that was generated and change the signature to use float[]
p71877
aVYour disassembly of it is very strange btw, never seen this before
p71878
aVThe CLR normally generates the COM stubs dynamically from the declaration of the function in the interop library
p71879
aVNo real clue how you got what you posted
p71880
aVTechnically it is possible to get module exports into a type library
p71881
aVThat however is not an OCX
p71882
aVIt does however explain the non-Automation compatible signature and the IL stub
p71883
aVIn that case, it might be easier to create a small C++/CLI ref class wrapper that uses the exported function directly rather than using the type library
p71884
aVConverting an array to a float* is easy with pin_ptr<>
p71885
as(dp71886
g9
V17034
p71887
stp71888
a((dp71889
g2
(lp71890
VAn NRE is a very low-level exception
p71891
aVIt is a hardware exception (a 'trap') generated by the processor when it is asked to read data from an address below 64K
p71892
aVThat region of the virtual memory space is always unmapped, specifically to trap pointer bugs
p71893
aVIt starts as an AccessViolation and gets turned into NRE by the CLR when the address is less than 0x00010000
p71894
aVAt that point there is very little context for the exception, all that's known is the address of the machine code instruction that caused the trap
p71895
aVReverse-engineering that machine code instruction address back to a named variable in your program isn't possible
p71896
aVIt is important that it works that way, a jitter would have to generate very inefficient code otherwise
p71897
aVAll that can be reasonably done is recover the source code line number
p71898
aVThat requires debugging info (a
p71899
aVpdb) that contains line number info
p71900
aVThe CLR knows how to read the
p71901
aVpdb file and uses it to generate the exception's stack trace
p71902
aVHowever, this is often still inaccurate due to optimizations performed by the JIT optimizer, it moves code around
p71903
aVYou'll only get a guaranteed match for the Debug build
p71904
aVThe reason why the PDB for the Release build doesn't contain source line number info
p71905
aVYou can change that
p71906
aVThis problem has a very simple solution
p71907
aVCheck for null yourself and generate your own exception before letting the runtime do it
p71908
aVThe test is quite cheap, well less than a nanosecond
p71909
as(dp71910
g9
V17034
p71911
stp71912
a((dp71913
g2
(lp71914
VThere is no mechanism by which a keyboard can tell Windows what its physical layout looks like
p71915
aVEasy to see with the Windows version of an on-screen keyboard, osk
p71916
aVexe
p71917
aVIt seems to be able to guess the form-factor of the machine (laptop vs desktop) but on my laptop it doesn't match the layout of the keyboard
p71918
aVUse the osk
p71919
aVexe layout as a template so nobody can complain that yours doesn't match well
p71920
as(dp71921
g9
V17034
p71922
stp71923
a((dp71924
g2
(lp71925
VI don't know what you are doing, a UserControl is meant to be a child control, it should be embedded in a Form
p71926
aVIt is technically possible to turn a UC into a top level window (like Form), you'd have to set the TopLevel property to True
p71927
aVThat however isn't very productive, the window doesn't have the chrome to make it friendly to use
p71928
aVIt is missing the title bar, no easy way for the user to move it around, minimize it, close it
p71929
aVAnd no easy way to solve focus problems, it can disappear behind another window with no easy way for the user to bring it back to the front
p71930
aVMaking it top-most is a hack of sorts to get at least the focusing problem solved, but at rather a deer cost
p71931
aVJust use the UC as it was intended to be used: put it inside a form
p71932
aVThat form should probably be the child form you open
p71933
aVIt could also be a third form, say a tool window
p71934
aVUse the Show(owner) overload to keep its Z-order in check and cannot do the disappearing act
p71935
aVThat also causes it to automatically close when the owner closes
p71936
as(dp71937
g9
V17034
p71938
stp71939
a((dp71940
g2
(lp71941
VI assume this will be always a same for the same piece of code in the same computer and not effected by other processes
p71942
aVThat's just not the way computers work
p71943
aVCode very much is affected by other processes running on the machine
p71944
aVA typical Windows machine has about 1000 active threads, you can see the number in the Performance tab of Taskmgr
p71945
aVexe
p71946
aVThe vast majority of them are asleep, waiting for some kind of event signaled by Windows
p71947
aVNevertheless, if the machine is running code, including yours, that is ready to go and take CPU time then Windows will give them all a slice of the pie
p71948
aVWhich makes measuring the amount of time taken by your code a pretty arbitrary measurement
p71949
aVThe only thing you can estimate is the minimum amount of time taken
p71950
aVWhich you do by running the test dozens of times, odds are decent that you'll get a sample that wasn't affected by other processes
p71951
aVThat will however never happen in Real Life, you'd be wise to take the median value as a realistic perf measurement
p71952
aVThe only truely useful measurement is measuring incremental improvements to your algorithm
p71953
aVChange code, see how the median time changes because of that
p71954
as(dp71955
g9
V17034
p71956
stp71957
a((dp71958
g2
(lp71959
VWell, it's working
p71960
aVYour screen shot shows the cell in the 3rd row getting different values and getting repainted without the BackColor erasing what was there before
p71961
aVIt's several digits drawn on top of each other, looks like a 4, 5 and 6
p71962
aVYou get more interesting effects by making the DGV smaller so a horizontal scrollbar appears
p71963
aVDragging it produces a 'smear' of digits
p71964
aVThis just doesn't work very well, not sure why you want to do this
p71965
aVYou want a good opaque background to draw new values on
p71966
aVThat requires an alpha of 255
p71967
as(dp71968
g9
V17034
p71969
stp71970
a((dp71971
g2
(lp71972
VYou can pinvoke MoveWindow
p71973
aVLike this:
p71974
as(dp71975
g9
V17034
p71976
stp71977
a((dp71978
g2
(lp71979
VEverytime I add an ICustomerService It gets boxed
p71980
aVThat would be highly unusual
p71981
aVOnly value type values get boxed
p71982
aVIt is technically possible to have a struct implement an interface
p71983
aVBut very uncommon to do so
p71984
aVThe only overhead you got here is the cast
p71985
aVThat's very quick on a reference type and pretty unavoidable by the looks of your snippet
p71986
as(dp71987
g9
V17034
p71988
stp71989
a((dp71990
g2
(lp71991
VThis is primarily a deployment problem, getting the right DLLs selected for the right operating system
p71992
aVPretty straight-forward if you create two setup projects, one for x86 and another for x64
p71993
aVMaking it work transparently is possible too
p71994
aVYou'd create, say, an x86 and an x64 sub-directory in the directory that contains your EXE and put respectively the 32-bit and the 64-bit builds of the DLLs in those sub-directories
p71995
aVAt startup, check IntPtr
p71996
aVSize to know the bit-ness of your process
p71997
aVThen pinvoke SetDllDirectory accordingly so that Windows will find the correct DLL
p71998
aVLike this:
p71999
aVUse a post build event to copy the DLLs
p72000
aVUsing Environment
p72001
aVSetEnvironmentVariable() to append the directory to the PATH environment variable is yet another approach
p72002
as(dp72003
g9
V17034
p72004
stp72005
a((dp72006
g2
(lp72007
VA global hook like WH_KEYBOARD indeed requires a DLL that can be injected
p72008
aVYou typically have to add some IPC code to tell somebody else about it
p72009
aVBeware that you are crossing a process boundary doing this so you need something like a pipe to talk
p72010
aVHave you considered using a low-level keyboard hook (WH_KEYBOARD_LL)
p72011
aVIt doesn't require an injectable DLL, Windows switches context to your process to call the hook
p72012
aVIt is almost always good enough to detect a specific keystroke, perhaps combined with GetAsyncKeyState() to check for modifier keys
p72013
aVA hotkey registered with RegisterHotKey() could perhaps work as well
p72014
aVIt should be your first choice since it has much less impact on the machine
p72015
as(dp72016
g9
V17034
p72017
stp72018
a((dp72019
g2
(lp72020
VSome reverse-engineering with ProcExp revealed a rundll32
p72021
aVexe command line that worked
p72022
aVHere's a sample program that uses it:
p72023
aVTested on Win7, I cannot guess how well this will work on other versions of Windows
p72024
as(dp72025
g9
V17034
p72026
stp72027
a((dp72028
g2
(lp72029
VThe ToolStrip classes have plenty of hairs like this
p72030
aVI think the appropriate selection here is LayoutStyle = Flow to get the menu items wrapped
p72031
aVThis is the way the built-in Windows menus work
p72032
aVYou do however have to take care of the layout problem this causes
p72033
aVPut a Panel on the form with Dock = Fill so that all controls automatically move down when the menu strip needs more space
p72034
as(dp72035
g9
V17034
p72036
stp72037
a((dp72038
g2
(lp72039
VThe value you get out of Process
p72040
aVMainWindowHandle is unfortunately a guess
p72041
aVThere is no API function available to a program that lets it tell Windows "this is my main window"
p72042
aVThe rule it uses is documented, it is the first window that's created by a process when it gets started
p72043
aVThat causes trouble if that first window is, say, a login window or a splash screen
p72044
aVNot much you can do about this, you have to know more about how the program behaves to find that real main window
p72045
aVEnumerating windows with EnumThreadWindows() could help you find it, as long as the first window was created on the same thread as the main window
p72046
aVA more elaborate EnumWindows() will be necessary if that is not the case
p72047
as(dp72048
g9
V17034
p72049
stp72050
a((dp72051
g2
(lp72052
VThere is no good fix for this, regions cannot be anti-aliased
p72053
aVThis is inevitable, anti-aliasing only works when you know the background colors so you can blend properly
p72054
aVThat's not an option for windows, the background is by design unpredictable
p72055
aVIf this is a splash screen then you can fake it by taking a screen shot of the background and drawing your fake window on top of it
p72056
aVWon't work for more than a few seconds
p72057
aVBest thing to do is to keep the corner radius small so it is not so noticeable
p72058
aVAlso use a tool like SysInternals' ZoomIt and take a close look at the rounded corners of a program like Windows Media Player
p72059
aVNote the gray tones it uses to draw the border
p72060
as(dp72061
g9
V17034
p72062
stp72063
a((dp72064
g2
(lp72065
VThis exception can have more than one cause
p72066
aVIt isn't very likely that Visual Studio is actually running out of memory, the system might be running low on resources
p72067
aVThe desktop heap is one of them
p72068
aVA simple reboot will fix that
p72069
aVIf this reoccurs, use Taskmgr
p72070
aVexe to try to find the processes that are hogging resources
p72071
aVView + Select Columns, tick Handles, USER objects and GDI objects
p72072
aVIf it is Explorer then you have a misbehaving shell extension handler
p72073
as(dp72074
g9
V17034
p72075
stp72076
a((dp72077
g2
(lp72078
VNo, it is actually reading the memory at [edx + edi]
p72079
aVProblem is that it is reading 32-bits at a time
p72080
aVWhich is not okay, you are comparing string content
p72081
aVThat requires comparing one byte at a time
p72082
aVFix:
p72083
as(dp72084
g9
V17034
p72085
stp72086
a((dp72087
g2
(lp72088
VOnce the AppDomain is created, the configuration data that affects binding is fixed
p72089
aVWhich happens on the default CLR when the primary AD is created, before your code starts running
p72090
aVIf you are really desperate then you could create a secondary AppDomain and give it a custom AppDomainSetup with another ConfigurationFile
p72091
aVAnd loads and run your regular startup code in that AD
p72092
aVNot exactly sure what kind of side effects this might have
p72093
as(dp72094
g9
V17034
p72095
stp72096
a((dp72097
g2
(lp72098
VThe original Win32 API is C-based
p72099
aVThere are however a substantial number of services within Windows that are COM based
p72100
aVGood examples are the clipboard, drag+drop, the shell, the user mode driver framework, DirectX
p72101
aVWhile it is technically possible to write COM code in C, it is excruciatingly painful to do so
p72102
aVRealistically you use C++ there
p72103
aVAnd a C++ class library to make the original C-based API less painful, especially for GUI code
p72104
as(dp72105
g9
V17034
p72106
stp72107
a((dp72108
g2
(lp72109
VThis will happen when either your service or one of the assemblies it uses was built with the Target Platform setting changed to x86
p72110
aVIn which case you have to use the right version of Installutil
p72111
aVexe to register the service
p72112
aVThere are two, in c:\u005cwindows\u005cmicrosoft
p72113
aVnet\u005cframework and \u005cframework64, respectively the 32-bit and the 64-bit version
p72114
aVOdds are good that you need the former
p72115
aVIf you created a Setup project then you'd change the TargetPlatform property to x86
p72116
aVAlso check if you really need to have the target platform set, you only do if you have a dependency on unmanaged code like a COM server
p72117
aVThe C# setting is in Project + Properties, Compile tab
p72118
aVThe default for VS2010 is x86, just flip it to AnyCPU if you have no such dependency
p72119
as(dp72120
g9
V17034
p72121
stp72122
a((dp72123
g2
(lp72124
VThe application manifest is named after the exe that starts the service
p72125
aVYes, this does not work
p72126
aVWindows always looks for a manifest in the EXE itself, embedded as an unmanaged resource
p72127
aVOnly when it cannot find one in there will it look for a
p72128
aVmanifest file on disk
p72129
aVProblem is, a managed program built with VS2008 and up already has a manifest
p72130
aVThe default one says "I'm Vista aware" only
p72131
aVYou can verify this for yourself by using File + Open + File and selecting your EXE
p72132
aVOpen the RT_MANIFEST node and double-click resource 1
p72133
aVIf you don't see your reg-free COM manifest entries there then it isn't going to work
p72134
aVTo fix, use Project + Add New Item and select the Application Manifest File item template
p72135
aVYou'll get the boilerplate manifest, copy and paste your regfree COM entries in there
p72136
as(dp72137
g9
V17034
p72138
stp72139
a((dp72140
g2
(lp72141
VImageList
p72142
aVDraw() is a bit unusual, it takes advantage of the built-in support that the native image list code inside of Windows has for rendering an image in the list
p72143
aVThis is an optimization, it avoids the cost of converting the internal image as stored in the native image list back to a managed Image object
p72144
aVOne side-effect however is that this drawing happens without regard for any of the transforms that were applied to the Graphics object
p72145
aVA 16x16 image in the list is going to be rendered as 16x16 pixels on paper
p72146
aVWhich is indeed a bit hard to find back, printers have very high resolution (600 dots per inch is typical), that image turns into a decimal point
p72147
aVImage lists were really meant to be the source of images for the TreeView and ListView controls, it is not a good general purpose collection object for images
p72148
aVLike a
p72149
aVYour workaround is good, the Image property converts the internal bitmap back to a managed Image, Graphics
p72150
aVDrawImage() will then scale it appropriately to get a size on paper that's close to the size on the screen
p72151
aVHowever with the graininess you get from making an image 6 times larger
p72152
aVNote that you should Dispose() that object
p72153
as(dp72154
g9
V17034
p72155
stp72156
a((dp72157
g2
(lp72158
VYes, this is normal
p72159
aVThe first call to CoCreateInstance will load the CLR into your process
p72160
aVWhich creates the primary AppDomain to load the managed code, with a garbage collected heap, the loader heap and a smattering of internal data structures
p72161
aVCalling the Release() method on the interface pointer does not unload the CLR
p72162
aVIt sticks around to service any future requests to load and execute managed code
p72163
aVThe primary appdomain doesn't get unloaded until the process terminates
p72164
aVAn unmanaged memory diagnostic tool is not going to know that this is normal
p72165
aVA true memory leak is one that increases the VM size of the process without an upper bound
p72166
aVConvince yourself that this is not a true memory leak by running this code a billion times
p72167
as(dp72168
g9
V17034
p72169
stp72170
a((dp72171
g2
(lp72172
VThere's little point in doing this, just start the reader thread yourself after you open the port and don't bother with DataReceived
p72173
aVDoing it your way is difficult, tough to cleanly unsubscribe from the DataReceived event after you started the thread, especially at the very moment data is being received
p72174
aVYou can't afford to have them both
p72175
as(dp72176
g9
V17034
p72177
stp72178
a((dp72179
g2
(lp72180
VThis will get written to the serial port driver transmit buffer without any extra help
p72181
aVFlush is not required
p72182
aVIf it doesn't make it to the device then you've probably got a handshake problem
p72183
aVA classic mistake is to leave it set to None and not setting the DtrEnable and RtsEnable properties to true
p72184
aVIt can also be a wiring problem, shake that out by using another program like HyperTerminal or Putty
p72185
aVLast but not least: it is difficult to keep a device happy that uses timeouts when you're debugging your code
p72186
as(dp72187
g9
V17034
p72188
stp72189
a((dp72190
g2
(lp72191
VNegative zero has the sign bit set
p72192
aVThus:
p72193
aVEdit: as the OP pointed out, this doesn't work in Release mode
p72194
aVThe x86 JIT optimizer takes the if() statement seriously and loads zero directly rather than loading value
p72195
aVWhich is indeed more performant
p72196
aVBut that causes the negative zero to be lost
p72197
aVThe code needs to be de-tuned to prevent this:
p72198
aVThis is quite typical behavior for the x86 jitter btw, it doesn't handle corner cases really well when it optimizes floating point code
p72199
aVThe x64 jitter is much better in that respect
p72200
aVAlthough there's arguably no worse corner case than giving meaning to negative zero
p72201
aVBe forewarned
p72202
as(dp72203
g9
V17034
p72204
stp72205
a((dp72206
g2
(lp72207
VI have set the Autosize property to true for both controls, but
p72208
aVI can tell from the "but" what you are asking for
p72209
aVThat's the AutoEllipsis property of the Label
p72210
aVSet it to true and set the MaximumSize property so the label cannot get bigger than its container
p72211
aVThe user will see
p72212
aVso she'll realize the text is truncated
p72213
aVShe'll hover the mouse over the label to get a tooltip with the full text
p72214
aVLetting everything grow to accommodate a label is drastically impractical
p72215
aVYou typically can manipulate MaximumSize to let it grow vertically for a while, up to a point
p72216
as(dp72217
g9
V17034
p72218
stp72219
a((dp72220
g2
(lp72221
VI'll keep this short, you just cannot make this work
p72222
aVYou'll need to change the LogError() method to accept an Exception object
p72223
aVIf any additional state is required (like Info) then add that as an argument to the LogError() method
p72224
aVOr make an overload
p72225
as(dp72226
g9
V17034
p72227
stp72228
a((dp72229
g2
(lp72230
VNET uses the underlying plumbing of Windows' structured exception handling
p72231
aVThere's a Big Difference in the way x64 exception handling is implemented
p72232
aVIt uses tables of addresses, generated by the compiler to locate the proper exception filter
p72233
aVx86 uses a linked list of function pointers, much easier to implement by a compiler
p72234
aVOne of the reasons the x64 way was changed was for security reasons, viral code managed to inject itself by patching the linked list and causing an exception, allowing its payload to execute
p72235
aVThere were counter-measures against that in XP SP1, at a cost of efficiency
p72236
aVThe x64 redesign avoids that cost
p72237
aVWell, you can see where that's heading
p72238
aVYou ought to debug code with the Platform Target set to x86 anyway
p72239
aVThis also enables Edit + Continue, a very valuable debugging aid
p72240
aVIt is the default setting for VS2010 projects
p72241
aVOnly flip to AnyCPU for the Release build
p72242
as(dp72243
g9
V17034
p72244
stp72245
a((dp72246
g2
(lp72247
VYou cannot create a C++ class instance through pinvoke from C#
p72248
aVThis is a troublesome implementation detail, only the C++ compiler knows how much memory needs to be allocated and when and how to properly call the constructor and destructor
p72249
aVThe object size is by far the hardest nut to crack, there is no way whatsoever to make that reliable
p72250
aVIf you cannot flatten the C++ class out into static methods then you need to write a managed wrapper
p72251
aVThat's done with the C++/CLI language, you'd write a "ref class" that has the unmanaged class object stored as a pointer, created in the constructor and deleted in the destructor and finalizer
p72252
as(dp72253
g9
V17034
p72254
stp72255
a((dp72256
g2
(lp72257
VWell, it's not the greatest use of CPU cycles, removing bytes from a List(Of Byte) is an O(n) operation
p72258
aVMaking the overall processing step O(n^2)
p72259
aVIt is still quite difficult to put any kind of pressure on the cpu doing so, serial ports are glacially slow
p72260
aVYou should only ever modify working code if you have measured it to be a perf problem
p72261
aVIf you're not there yet then consider creating a new array or List from the old one
p72262
aVThat's O(n), the extra storage cannot hurt considering the slow data rates
p72263
aVThe code should be cleaner too
p72264
aVAs far as threading goes, be sure to do this in the DataReceived handler
p72265
aVThat's thread-safe and avoids putting undue pressure on the UI thread in case you invoke
p72266
as(dp72267
g9
V17034
p72268
stp72269
a((dp72270
g2
(lp72271
VCOM automation support for structures is very weak, CComVariant doesn't support it directly
p72272
aVYou need to use IRecordInfo and create a variant of type VT_RECORD
p72273
aVObtain the IRecordInfo interface pointer from GetRecordInfoFromTypeInfo or GetRecordInfoFromGuids
p72274
aVGood luck
p72275
as(dp72276
g9
V17034
p72277
stp72278
a((dp72279
g2
(lp72280
VThe harder part is to get A to move when B moves
p72281
aVThat requires a NativeWindow derived class
p72282
aVUse AssignHandle to attach the window handle you got
p72283
aVIn the WndProc() override you can detect the WM_MOVE message, allowing you to move A
p72284
aVAnd WM_DESTROY to clean up
p72285
aVThat however only works if the window is owned by your process
p72286
aVThe more typical scenario is that this is a window belonging to some code you don't control, running in another program
p72287
aVYou are quite screwed if that's the case, the NativeWindow approach cannot work
p72288
aVYou'd need to inject an unmanaged DLL into the process with SetWindowsHookEx() so you can monitor WH_CALLWNDPROC
p72289
aVWith some kind of IPC mechanism to get that notification into your process
p72290
aVVery hard to get right, you can't write the DLL code in C#
p72291
as(dp72292
g9
V17034
p72293
stp72294
a((dp72295
g2
(lp72296
VThis is what you see when you use Reflector to look at a COM interop library that was created by tlbimp
p72297
aVexe
p72298
aVOr by adding a reference in the IDE to a COM server from the COM tab or Browse tab, same thing
p72299
aVIf you look at the outer class or interface that contains this method then you'll see the COM coclass or interface that contains this method
p72300
aVImportant attributes on it are [ComImport] to indicate that it is implemented in another DLL and [Guid], the all important interface IID or coclass CLSID
p72301
aVCOM classes and interfaces are uniquely identified by a guid, not a name
p72302
aVThe CLSID guid is present in the registry,  key
p72303
aVCOM servers like this are almost always implemented in an unmanaged language, C++ is most typical, but also Delphi or VB6
p72304
aVDecompiling C++ code after it is compiled is a fruitless exercise but you can get something out of Dumpbin
p72305
aVexe with the /disasm option
p72306
aVAssembly language programming skills and reams of free time are required
p72307
aVIt is almost always expressly forbidden in the license agreement
p72308
as(dp72309
g9
V17034
p72310
stp72311
a((dp72312
g2
(lp72313
VYou could override OnHandleDestroyed(), called when IE destroys the control window
p72314
as(dp72315
g9
V17034
p72316
stp72317
a((dp72318
g2
(lp72319
VFinding a download for the x64 version of just the ACE provider is indeed impossible afaict
p72320
aVThis seems intentional
p72321
aVSelect your EXE project in the Solution Explorer window
p72322
aVProject + Properties, Compile tab, scroll down, Advanced Compile Options
p72323
aVChange Target CPU to "x86"
p72324
aVYou always want that setting when you debug code, it enables Edit + Continue on a 64-bit machine and avoids a few 64-bit specific hairs
p72325
aVAnd keep that setting for the Release build when you have a dependency on any 32-bit unmanaged code, like you do in this case
p72326
as(dp72327
g9
V17034
p72328
stp72329
a((dp72330
g2
(lp72331
VIt is unlikely that a BindData() method takes anything else but an argument of type object
p72332
aVOr that anything good happens when this method is called with an object that cannot act as a binding source, you'll want to know about it
p72333
aVThus:
p72334
aVA form that accepts a binding on both an object and a collection of objects is very unusual
p72335
aVIt requires a very different kind of user interface
p72336
as(dp72337
g9
V17034
p72338
stp72339
a((dp72340
g2
(lp72341
VYou'd use Bitmap
p72342
aVLockBits to get direct access to the pixels in a bitmap
p72343
aVHere's a sample implementation, it returns one scanline from the passed bitmap as an int[]:
p72344
as(dp72345
g9
V17034
p72346
stp72347
a((dp72348
g2
(lp72349
VI'd have to recommend tackling the perf problem before bringing out the thread canon
p72350
aV50 milliseconds is a looong time
p72351
aVThis sample code had no effect on interactivity nor made a blip on the cpu load, even though it isn't optimized:
p72352
as(dp72353
g9
V17034
p72354
stp72355
a((dp72356
g2
(lp72357
VA pragmatic solution is to use the form's GetChildAtPoint() method, passing the 4 corners of the control
p72358
aVIf one of them returns true then the control is definitely visible
p72359
aVIt is not 100% reliable, all 4 corners could be overlapped by another control but still leave part of interior visible
p72360
aVI would not worry about that, too bizarre
p72361
as(dp72362
g9
V17034
p72363
stp72364
a((dp72365
g2
(lp72366
V"Not reflecting" is very unclear
p72367
aVBut as posted, these regasm
p72368
aVexe commands are not sufficient to let a VB6 program find the assembly
p72369
aVIf it doesn't complain about creating the class object then you've used gacutil
p72370
aVexe some time in the past
p72371
aVAnd the GAC contains an old copy of your DLL
p72372
aVYou will have to remove that old copy, use gacutil
p72373
aVexe /u
p72374
aVModify the regasm
p72375
aVexe command line, add the /codebase option so it always uses the copy of DLL in the build directory instead of looking for the DLL in the GAC
p72376
as(dp72377
g9
V17034
p72378
stp72379
a((dp72380
g2
(lp72381
VThis is normal
p72382
aVWhen the receive buffer contains at least one byte, you'll get back whatever is in the buffer
p72383
aVWhich is usually but a fraction of what you expect, serial ports are quite slow
p72384
aVYou'll have to keep reading until you get the full response
p72385
as(dp72386
g9
V17034
p72387
stp72388
a((dp72389
g2
(lp72390
VComparing the handle to the value returned by GetDesktopWindow() could be useful
p72391
as(dp72392
g9
V17034
p72393
stp72394
a((dp72395
g2
(lp72396
VUnlike C#, VB
p72397
aVNET doesn't require a local variable to be initialized with an expression
p72398
aVIt gets initialized to its default value by the runtime
p72399
aVJust what you need as a substitute for the default keyword:
p72400
aVDon't forget the comment, it is going to make somebody go 'Huh
p72401
aVa year from now
p72402
as(dp72403
g9
V17034
p72404
stp72405
a((dp72406
g2
(lp72407
VNo, this requires help from a compiler
p72408
aVA VB
p72409
aVNET module gets translated to a class under the hood
p72410
aVWhich is very similar to a static class in C#, another construct that doesn't have a real representation in the CLR
p72411
aVOnly a compiler could then pretend that the members of such a class belong in the global namespace
p72412
aVThis is otherwise a compat feature of the VB
p72413
aVNET compiler, modules were a big deal in the early versions of visual basic
p72414
aVA static class declared without a namespace is the closest you'll get in C#
p72415
aVUtil
p72416
aVFoo(), something like that
p72417
as(dp72418
g9
V17034
p72419
stp72420
a((dp72421
g2
(lp72422
VThe native Windows month calendar control got a pretty major overhaul at Vista, also the underlying code base for Windows 2008
p72423
aVThat affected the DateTimePicker and MonthCalendar classes, they are pretty simple
p72424
aVNET wrappers around the native Windows provided code
p72425
aVLots of Winforms classes are like this
p72426
aVThis is otherwise considered a nicety, your UI automagically adapts itself to the look-and-feel of the new operating system and the way other programs behave on it without you having to do anything at all
p72427
aVNot displaying dates that you've made unselectable does arguably make an enormous amount of sense
p72428
aVThere is otherwise not anything you can do to change the way that native Windows code behaves, those wrappers are very thin
p72429
aVMostly because the native Windows controls don't have a lot of knobs
p72430
aVFeature, not a bug
p72431
as(dp72432
g9
V17034
p72433
stp72434
a((dp72435
g2
(lp72436
VThis is intentional, so you don't try to catch this exception
p72437
aVIt is a serious one, it is not meaningless, do not ignore it
p72438
aVFix the real problem
p72439
aVI can't help you diagnose the reason without a stack trace
p72440
as(dp72441
g9
V17034
p72442
stp72443
a((dp72444
g2
(lp72445
VDiagnose this with Taskmgr
p72446
aVexe, Processes tab
p72447
aVView + Select Columns and tick USER objects
p72448
aVObserve this value for your process while it runs
p72449
aVIt should be steadily climbing
p72450
aVWhen it reaches 10,000 then your program will bomb with this exception
p72451
aVThis is caused by not calling Dispose() on controls that you remove from the Controls collection yourself, either by calling Remove() or Clear()
p72452
as(dp72453
g9
V17034
p72454
stp72455
a((dp72456
g2
(lp72457
VYou have to use PostMessage, not SendMessage
p72458
aVYour pinvoke declaration is wrong too, the return value and the last 2 arguments are IntPtr, not int
p72459
aVThe ultimate downfall is that you cannot control the state of the modifier keys, Ctrl, Shift and Alt
p72460
aVWhich makes this randomly fail, depending on whether or not the user has one of those keys pressed
p72461
aVSendInput is required, forcing you now to also get the focus correct with SetForegroundWindow()
p72462
aVUse SendKeys in a Winforms app
p72463
aVTo inject typing keys you can use SendMessage() to send WM_CHAR
p72464
as(dp72465
g9
V17034
p72466
stp72467
a((dp72468
g2
(lp72469
VThis is an okay strategy for fonts, the Windows font mapper isn't that cheap and the number of fonts that a typical program uses is finite
p72470
aVBut not for brushes and pens, they are dirt-cheap so just create and destroy them on the fly
p72471
aVThe ultimate endorsement for this strategy comes from Microsoft's own code, Winforms does this
p72472
aVBeware that caching creates a new problem, you have to invalidate the cache when the user changes system settings
p72473
aVSystem colors, DPI, that sort of thing
p72474
aVYou have to listen for WM_SETTINGCHANGE in a toplevel window
p72475
as(dp72476
g9
V17034
p72477
stp72478
a((dp72479
g2
(lp72480
VThe linker's /delayload option only works for DLLs that contain functions compiled to native machine code
p72481
aVThe linker already told you that you don't have any
p72482
aVThe likely scenario here is that your DLL actually contains IL, not machine code
p72483
aVWhich will happen when you compile the source code with /clr in effect and haven't used #pragma managed to turn off IL generation
p72484
aVIL code needs to be converted to machine code by the jitter
p72485
aVYour DLL is going to get loaded dynamically, same as /delayload, as soon as the jitter needs type info from the assembly's metadata to generate machine code
p72486
aVTo avoid the dependency on the DLL, you'd have to carefully craft your code so the jitter never needs to load types from your assembly
p72487
aVWhich is a different problem from avoiding executing a delay-loaded function
p72488
aVThe exception's InnerException's stack trace should give you a strong hint how that happened
p72489
as(dp72490
g9
V17034
p72491
stp72492
a((dp72493
g2
(lp72494
VIt is always a pretty sad sight to watch a user banging away at a retry button without ever getting anywhere
p72495
aVThey keep it up for a while too, hoping for a miracle
p72496
aVThey'll switch the mouse to the left hand after half a minute of it
p72497
aVThe generic problem with this is that they'll blame you for the problem
p72498
aVEven though you have nothing to do with it and cannot do anything at all to solve the problem
p72499
aVAfter all, it was you that promised that a retry would make sense
p72500
aVThey'll quickly lose confidence in you as a programmer and your product as being usable and worth their money
p72501
aVDon't do this unless you actually have a way in your code to execute a different strategy
p72502
aVThat's quite rare
p72503
as(dp72504
g9
V17034
p72505
stp72506
a((dp72507
g2
(lp72508
VThe appropriate DropDown property value here is DropDownList
p72509
aVIt doesn't have this problem
p72510
aVComing up with a workaround for your specific problem with the DropDown style set to DropDown is quite difficult
p72511
aVIt allows the user type arbitrary text and even a perfect match with one of the dropdown items doesn't change the SelectedIndex
p72512
aVYou'd have to implement the Validating event and look for a match yourself
p72513
aVThe DropDownClosed event would be good for your specific scenario
p72514
aVBut really, always use DropDownList if you want perfect matches
p72515
as(dp72516
g9
V17034
p72517
stp72518
a((dp72519
g2
(lp72520
VUsing the e
p72521
aVGraphics object that OnPaint() supplies to you is the correct way of doing it
p72522
aVIt will run right after the OnLoad() method
p72523
aVThe form isn't visible yet in OnLoad
p72524
aVGetting a Graphics object from Control
p72525
aVCreateGraphics() is supported
p72526
aVHowever, whatever you draw with this will be wiped out as soon as the form repaints itself
p72527
aVWhich happens when the user moves another window across yours (pre-Aero) or when she minimizes and restores or otherwise resizes the window
p72528
aVUse CreateGraphics only ever when animating at a high rate
p72529
as(dp72530
g9
V17034
p72531
stp72532
a((dp72533
g2
(lp72534
VI can't think of any compelling reason to do this any differently then the way all other GUI class libraries do it
p72535
aVJust scale window sizes between the 'design' DPI setting and the target machine DPI setting
p72536
aVUsing DPI-independent constants is pretty painful in MFC since everything is pixel based
p72537
aVSo keep your workstation at the common 96 DPI setting, scale from there on the target machine
p72538
aVYou do have to keep a bit of slack because of TrueType hinting
p72539
as(dp72540
g9
V17034
p72541
stp72542
a((dp72543
g2
(lp72544
VI think you're a bit confuzzled about what's happening here
p72545
aVYes, you use the Browse tab to add references to your assemblies
p72546
aVOr the Projects tab if those projects are part of the solution
p72547
aVBut that does not add these assemblies to the
p72548
aVNET tab
p72549
aVThat one is filled from directories whose names are listed in a registry key
p72550
aVPut there by an installer
p72551
aVYou should never alter those keys yourself, that just causes misery whenever you switch machines
p72552
aVYou don't have to do anything
p72553
as(dp72554
g9
V17034
p72555
stp72556
a((dp72557
g2
(lp72558
VBizarre
p72559
aVRPC is an oddball API though, it's very old and quirks are heavily preserved
p72560
aVI'd recommend you use StringFromGUID2() instead
p72561
aVHaving two ways to accomplish the same thing is always a telltale sign, later is better
p72562
as(dp72563
g9
V17034
p72564
stp72565
a((dp72566
g2
(lp72567
VYes, odds are quite good
p72568
aVThe library still gets linked to the 2010 version of the CRT so there is no issue with different heaps getting used
p72569
aVYou will however run into trouble if you used any of the C++ template classes
p72570
aVJust because their internal structure may have changed
p72571
aVParticularly an issue with the iterator debugging feature
p72572
as(dp72573
g9
V17034
p72574
stp72575
a((dp72576
g2
(lp72577
VWell, it's okayish to use a BGW in a service, it just doesn't do anything especially useful
p72578
aVIts reason for being is its ability to raise the ProgressChanged and RunWorkerCompleted events on a specific thread
p72579
aVGetting code to run on a specific thread is a very non-trivial thing to do
p72580
aVYou cannot simply inject a call into the thread while it is executing code
p72581
aVThat causes horrible re-entrancy problems
p72582
aVThe thread has to be 'idle', in a state where inject code doesn't cause trouble
p72583
aVHaving a thread in an idle state is a fairly unnatural condition
p72584
aVYou use threads to run code, not for them to be idly spinning its heels
p72585
aVThis is however the way a UI thread works
p72586
aVIt spends 99% of its time in the message loop, waiting for Windows to tell it to do something
p72587
aVA button click, a paint request, a keyboard press, that sort of thing
p72588
aVWhile it is inside the message loop, it is in fact idle
p72589
aVA very good time to execute injected code
p72590
aVWhich is what Winforms' Control
p72591
aVBegin/Invoke and WPF's Dispatcher
p72592
aVBegin/Invoke do
p72593
aVThey put a delegate in a queue, the queue is emptied and the delegate targets executed by the message loop
p72594
aVThe WindowsFormsSynchronizationContext and DispatcherSynchronizationContext classes are the synchronization providers that uses them
p72595
aVWinforms and WPF replace SynchronizationContext
p72596
aVCurrent with an instance of them
p72597
aVWhich in turn gets used by BGW to raise the events
p72598
aVWhich makes them run on the UI thread
p72599
aVWhich allows you to update the non thread-safe user interface components from a worker thread
p72600
aVYou can probably see where this is heading, a service uses neither
p72601
aVThe default synchronization provider doesn't synchronize anything
p72602
aVIt simply uses a threadpool thread to call the Send or Post callback
p72603
aVWhich is what will happen when you use BGW in a service
p72604
aVNow there is actually no point at all in having these events
p72605
aVYou might as well let the DoWork handler call the event handling methods directly
p72606
aVAfter all, the thread on which DoWork runs is just another threadpool thread as well
p72607
aVWell, no real harm done, other than making it quite a bit slower
p72608
as(dp72609
g9
V17034
p72610
stp72611
a((dp72612
g2
(lp72613
VThis is supported in Winforms as well
p72614
aVSet the MultiColumn property to True, the ColumnWidth property to, say, 15
p72615
aVProducing:
p72616
as(dp72617
g9
V17034
p72618
stp72619
a((dp72620
g2
(lp72621
V-532462766 == 0xe0434352
p72622
aVThe last three hex pairs spell "CCR", a common trick that Microsoft programmers use to try to come up with an easily recognizable exception code
p72623
aVThe exact meaning is quite mysterious, beyond it being commonly associated with managed code and seemingly being very low level in a sub-system that doesn't normally fail to produce a meaningful managed exception
p72624
aVThere is an excellent candidate reason for that mysterious exception, your EnumResources pinvoke declaration is wrong
p72625
aVThe 2nd argument is IntPtr, not int
p72626
aVThat has some odds of going kaboom on a 64-bit operating system
p72627
aVPlease post back if you ever figure out what CCR means
p72628
as(dp72629
g9
V17034
p72630
stp72631
a((dp72632
g2
(lp72633
VSomething is basically wrong
p72634
aVYou declared a delegate, as though the function is a callback
p72635
aVDoesn't look like a callback at all, it look like something you should declare with [DllImport]
p72636
aVTo make it work like you did, you'd have to pinvoke LoadLibrary and GetProcAddress()
p72637
aVWhat [DllImport] does under the hood
p72638
aVI don't see you using that
p72639
as(dp72640
g9
V17034
p72641
stp72642
a((dp72643
g2
(lp72644
VThe upvoted answer is incorrect, a property accessor indirection does not in general prevent the JIT optimizer from omitting dead code
p72645
aVMost simple ones get inlined, their compile time values are considered
p72646
aVWhich means that it will not optimize away the expression since the value of condition is only known at run time
p72647
aVThe fact that the code is jitted after the condition value is already known doesn't change this, the optimizer must be able to determine the value statically
p72648
aVOnly a literal will suffice here, you'd get one with conditional compilation (#if in C#)
p72649
aVCheck this answer for more background info on the optimizer
p72650
as(dp72651
g9
V17034
p72652
stp72653
a((dp72654
g2
(lp72655
VYou need to implement the DragOver event
p72656
aVCheck if the mouse is located close to the top or the bottom of the control (use PointToClient)
p72657
aVWhen it is, enable a timer with an interval of ~200 msec
p72658
aVIn the Tick event handler scroll the DGV by a row
p72659
aVDisable the timer when the mouse isn't close and after DoDragDrop returns
p72660
aVThe user can now easily and intuitively scroll the grid just be hovering near the ends
p72661
as(dp72662
g9
V17034
p72663
stp72664
a((dp72665
g2
(lp72666
VThe JIT compiler will spackle a lot of this over, also the source of the error message if the change was breaking
p72667
aVYou are however playing a very dangerous game called DLL Hell
p72668
aVThe problem is not that they don't recompile their code, it is when they do
p72669
aVThey will, eventually
p72670
aVIf then there's a subtle mistake, somebody ran an old version of your installer, copied the wrong file, etcetera then all hell breaks loose
p72671
aVThe code won't run and they'll have an impossible job figuring out why
p72672
aVThis will happen long after you made the change, you won't have any way to guess what went wrong either and cannot help them
p72673
aVDon't mess around with this, bump up [AssemblyFileVersion] and [AssemblyVersion]
p72674
aVYes, they'll have to recompile when you change the latter one
p72675
aVOr use , which is fine too, now there's a traceable record of it
p72676
aVBtw: this happened in the
p72677
aVNET Framework too
p72678
aVWaitHandle
p72679
aVWaitOne(int) got added in a service pack but without an [AssemblyVersion] change
p72680
aVProgrammers targeted
p72681
aVNET 2
p72682
aV0 but their code wouldn't run when the target machine had the original 2
p72683
aV0 installed
p72684
aVVery painful
p72685
as(dp72686
g9
V17034
p72687
stp72688
a((dp72689
g2
(lp72690
VI would recommend some caution against doing this
p72691
aVA ListView is really meant to display information, it is not a great collection class
p72692
aVGetting the data out of it is slow and crummy, it can only store strings
p72693
aVKeep the data in your program in its original form, maybe a
p72694
aVNow it is simple and fast
p72695
as(dp72696
g9
V17034
p72697
stp72698
a((dp72699
g2
(lp72700
VAs long as you are creating this window in a worker thread then you really are stuck with TopMost = true
p72701
aVWinforms won't let you use the Show(owner) overload, it throws an InvalidOperationException when it detects that the parent is owned by the UI thread
p72702
aVJust calling Show() makes the desktop window the owner
p72703
aVWhich is a problem, the progress window can disappear behind another window and the user can't easily get it back
p72704
aVSince it is asynchronous, this can easily happen while the user is working in a UI window, she might never even notice the popup
p72705
aVJust punt this problem, use Control
p72706
aVBeginInvoke() to let a method create the dialog on the UI thread
p72707
aVNow you can call ShowDialog(), all your problems are solved
p72708
as(dp72709
g9
V17034
p72710
stp72711
a((dp72712
g2
(lp72713
VYes, no problem
p72714
aVDo a clean build occasionally to catch circular dependencies
p72715
as(dp72716
g9
V17034
p72717
stp72718
a((dp72719
g2
(lp72720
VThis requires either a
p72721
aVconfig file with the  element or implementing AppDomain
p72722
aVAssemblyResolve so that the CLR can find these DLLs
p72723
aVYou'll have a deployment problem too, you have to convince ClickOnce to publish these DLLs
p72724
aVRealistically should only attempt this with the retail edition of Visual Studio so you can create a Setup project
p72725
aVFwiw: your customer won't mind that the DLLs are in the same folder as the EXE
p72726
aVI think most actually strongly prefer this
p72727
aVI do
p72728
as(dp72729
g9
V17034
p72730
stp72731
a((dp72732
g2
(lp72733
VYou enable the DTR and RTS signals right away
p72734
aVThe meter will immediately start sending data when you open the port
p72735
aVThat data gets buffered in the driver's receive buffer
p72736
aVYou didn't have a buffer before in the DOS code
p72737
aVIt depends how long it takes for you to call serial_notready()
p72738
aVYou'll have a pretty full buffer if that takes a second or so
p72739
aVYes, that makes it look like the meter is just sending data
p72740
aVAnd you are always reading an old sample
p72741
aVStart with the DCB values set to DISABLE
p72742
aVBeware that the scheme is brittle, you could turn the signal off pretty reliably back in the DOS
p72743
aVNow you've got a driver in between
p72744
aVYou may well end up turning RTS off too late
p72745
aVWhich risks getting a stale reading
p72746
aVAn alternative is to startup a thread that just reads continuously
p72747
aVAnd have your main code just use the last value that it read
p72748
aVThe overhead is quite low, serial ports are slow
p72749
as(dp72750
g9
V17034
p72751
stp72752
a((dp72753
g2
(lp72754
VI'm not aware of a known problem with this, it smells environmental
p72755
aVThe error is very low level, probably the wow64 emulation layer
p72756
aVI can only suggest you punt and use a different way to get the same info
p72757
aVYou can use WMI, Win32_Process class
p72758
aVRun a select query on ProcessId, the ExecutablePath property gives you what you are looking for
p72759
aVUse the WMI Code Creator utility to experiment, it auto-generates the C# code you need
p72760
aVThe odds are however not zero that this will fail the same way
p72761
as(dp72762
g9
V17034
p72763
stp72764
a((dp72765
g2
(lp72766
VIt isn't clear enough what kind of transparency is required there
p72767
aVThe simple way is to invert the problem
p72768
aVUse a TextureBrush to draw the image with Graphics
p72769
aVFillEllipse()
p72770
as(dp72771
g9
V17034
p72772
stp72773
a((dp72774
g2
(lp72775
VIt's a bug
p72776
aVReference examples are here and here
p72777
aVSome secondary evidence that the Longhorn project was indeed a very troubled one
p72778
aVThe Windows team doesn't take feedback like DevDiv does, hard to get bugs fixed
p72779
aVYou can leave an annotation at the bottom of the MSDN Library page
p72780
as(dp72781
g9
V17034
p72782
stp72783
a((dp72784
g2
(lp72785
VThis isn't specific to a TabPage, the same thing happens when you put the combo on a form
p72786
aVIt is affected by visual styles, the container paint requests stop when you turn that off
p72787
aVI'm guessing it has something to do with the rounded corners you get when the DropDown property is set to DropDownList, the combo glows on a mouse hover
p72788
aVWith it probably asking the container control to draw the pixels in the corner
p72789
aVExplaining it for DropDown = DropDown is harder
p72790
aVSame thing happens with a Button, the container control paint is documented in the Reference Source to support transparency effects
p72791
aVEven if the button doesn't have anything transparent
p72792
aVVisual styles is less than optimized like this, perhaps
p72793
aVIt is otherwise very similar to what WPF does
p72794
aVLong story short, this is normal
p72795
as(dp72796
g9
V17034
p72797
stp72798
a((dp72799
g2
(lp72800
VNo, VS2010 came with SDK version 7
p72801
aV0A
p72802
aVThe installer for 7
p72803
aV1 should automatically make it use the version
p72804
aVBut I'm fairly sure that won't happen for VS2005
p72805
aVI think, it's been a while since I used a machine that had it installed
p72806
aVYou can set the directories it searches with Tools + Options, Projects and Solutions, VC++ Directories
p72807
aVI wouldn't do this myself btw, not much point in installing an old version unless to maintain old projects
p72808
as(dp72809
g9
V17034
p72810
stp72811
a((dp72812
g2
(lp72813
VYou are assigning a function pointer here, not making a call
p72814
aVThus no passing of arguments
p72815
aVHaving to store extra state with a HWND isn't unusual, a very common requirement for a C++ class wrapper around a window for example
p72816
aVYou should keep a map<> to help you retrieve the wrapper object from the window handle value
p72817
aVUsing SetWindowLongPtr() with GWLP_USERDATA is possible too but less ideal if you don't control the window creation
p72818
as(dp72819
g9
V17034
p72820
stp72821
a((dp72822
g2
(lp72823
VI struggle to see how you can get thousands of windows from a user interface like this
p72824
aVIf you create one label control for each individual notification then, yes, this can get badly out of hand in a hurry
p72825
aVMakes it dreadfully slow too
p72826
aVDon't use label controls, use a ListBox, ListView, TreeView or DataGridView
p72827
aVControls that can display multiple items but only consume a single window handle
p72828
as(dp72829
g9
V17034
p72830
stp72831
a((dp72832
g2
(lp72833
VIt is not
p72834
aVYou don't use CoCreateInstance(), the interface types are not declared in IDL, you have to link to a
p72835
aVlib
p72836
as(dp72837
g9
V17034
p72838
stp72839
a((dp72840
g2
(lp72841
VNo, you don't inherit the interface
p72842
aVYou can create an instance of IISVersionManager with the new keyword
p72843
aVHow that gets you a reference to an IIISExpressProcessUtility instance is completely unclear
p72844
aVThe MSDN docs are awful
p72845
aVMaybe you can new one but it doesn't look like it supports that
p72846
as(dp72847
g9
V17034
p72848
stp72849
a((dp72850
g2
(lp72851
VSet the PixelOffsetMode property to HighQuality to get a better blend with the background at the edges
p72852
as(dp72853
g9
V17034
p72854
stp72855
a((dp72856
g2
(lp72857
VIDispatch is a COM interface
p72858
aVThe CLR will automatically implement it if you use [ComVisible(true)] and [ClassInterface(ClassInterfaceType
p72859
aVAutoDispatch)] attributes on your class
p72860
aVYou can then pass an instance of the class and the cast will succeed
p72861
aVThe code is then probably going to call some kind of method on that class so be sure that it is implemented
p72862
aVIt isn't clear from the question what method that might be and what its signature should look like
p72863
aVIt must exactly match, a mismatch is liable to prevent the callback from ever occurring without a diagnostic
p72864
as(dp72865
g9
V17034
p72866
stp72867
a((dp72868
g2
(lp72869
VProject + Properties, Debugging
p72870
aVSet the Command setting to an EXE that loads the DLL, that 3rd party app
p72871
aVSet breakpoints in your DLL code, they'll activate as soon as the DLL gets loaded
p72872
aVThe hollow looking breakpoint indicator changes to a filled circle
p72873
aVAnd the debugger breaks as soon as your code is called
p72874
as(dp72875
g9
V17034
p72876
stp72877
a((dp72878
g2
(lp72879
VWell, each EXE will have its own private DLL
p72880
aVNo overwriting here, you'd put each EXE in its own install directory
p72881
aVThey can have different versions of the DLL by design, DLL Hell is non-existent
p72882
aVOther than that those DLLs might touch other parts of the file system or the registry and step on each other toes doing that
p72883
aVThe reference to "must be designed to work side-by-side"
p72884
aVThis is rarely hard to achieve
p72885
as(dp72886
g9
V17034
p72887
stp72888
a((dp72889
g2
(lp72890
VProject + Properties, Application tab
p72891
aVChange Target Framework from "Client Profile" to the full version
p72892
aVSystem
p72893
aVWeb is not included in the client profile
p72894
aVA very boring problem, considering that the client profile is only 15% smaller than the full install for
p72895
aVNET 4
p72896
ag2512
as(dp72897
g9
V17034
p72898
stp72899
a((dp72900
g2
(lp72901
VFormatting complex document types like
p72902
aVpdf and
p72903
aVdoc for a printer is not something you'd want to get into
p72904
aVYou'll need gobs of software to even read the file, let alone format it
p72905
aVAnd it is invariably pointless, the user will already have the native application that handles the file format installed on her machine
p72906
aVMicrosoft Office, Adobe Reader, etc
p72907
aVThere's a standard protocol in Windows to get files printed
p72908
aVYou use the Process and ProcessStartInfo classes
p72909
aVSet the filename to the path of the file, the Verb to "Print"
p72910
aVProcess
p72911
aVStart() that, the native app will print the document
p72912
aVSame thing you get when you right-click the file in Explorer and click Print
p72913
as(dp72914
g9
V17034
p72915
stp72916
a((dp72917
g2
(lp72918
VThe SDK docs always explicitly mention how a handle needs to be released
p72919
aVNothing for HMONITOR, you are just getting a handle to an internal object that's around anyway
p72920
as(dp72921
g9
V17034
p72922
stp72923
a((dp72924
g2
(lp72925
VThe first reason it doesn't work is because you use the wrong DLL, coredll
p72926
aVdll is Windows Mobile
p72927
aVIn the desktop version of Windows, keybd_event is exported by user32
p72928
aVdll
p72929
aVThe second reason it doesn't work is because sending the keystroke isn't good enough
p72930
aVNot quite sure why, this seems to be intercepted before the generic input handler
p72931
aVYou can use WM_APPCOMMAND, it supports a range of commands and APPCOMMAND_VOLUME_MUTE is one of them
p72932
aVIt acts as a toggle, turning muting on and off
p72933
aVMake your code look like this:
p72934
aVThis code needs to be inside a instance method of the form, note how it uses DefWndProc()
p72935
aVIf you want to put it elsewhere then you need to fallback to SendMessage()
p72936
aVThe actual window handle doesn't matter, as long as it is a valid toplevel one
p72937
as(dp72938
g9
V17034
p72939
stp72940
a((dp72941
g2
(lp72942
VCopying the DLLs is required, it cannot work otherwise
p72943
aVWhich leaves the location of the file
p72944
aVYou are only giving the relative location of the file, not the full path (like "c:\u005cmumble\u005cfoo
p72945
aVmp4")
p72946
aVOn your machine, this file needs to be stored in the bin\u005cDebug folder of your project directory to make it work
p72947
aVAnother machine you deploy your program to isn't going to have a bin\u005cDebug (or Release) folder
p72948
aVIt still needs to be present in the same directory as the EXE
p72949
aVMaybe you forgot to copy the
p72950
aVmp4 file
p72951
aVClearly you'll want to provide the user with a way to select the file
p72952
aVUse OpenFileDialog
p72953
as(dp72954
g9
V17034
p72955
stp72956
a((dp72957
g2
(lp72958
Vmy list class must have several public properties (including IsSynchronized and SyncRoot
p72959
aVIt doesn't
p72960
aVThis dates back to
p72961
aVNET version 1 and is widely considered a giant mistake
p72962
aVIt created a false sense of thread-safety that got a lot of programmers in deep trouble
p72963
aVSuch a class wasn't actually thread-safe in all cases, iterating for one wasn't
p72964
aVIt was completely dropped in the
p72965
aVNET 2
p72966
aV0 generic collection classes
p72967
aVAnd you should not implement ICollection, a modern collection class should be generic and implement
p72968
aVThat unfortunately still requires implementing IEnumerable, a legacy we'll probably never get rid of
p72969
aVYou implement it with an explicit implementation, such methods are not public
p72970
aVA secondary consideration is whether implementing ICollection<> is a good idea
p72971
aVA linked list makes a member like Count expensive, it is O(n) by nature
p72972
aVYou need to track the number of elements in the list separately to make it O(1)
p72973
aVThe
p72974
aVNET LinkedList<> class, also a doubly linked-list collection class, does do this
p72975
as(dp72976
g9
V17034
p72977
stp72978
a((dp72979
g2
(lp72980
VCustomEvent should indeed not be declared as a field in ISlider
p72981
aVIt should be declared as an event:
p72982
aVAnd fix your code so typenames and reference variable names are distinct:
p72983
as(dp72984
g9
V17034
p72985
stp72986
a((dp72987
g2
(lp72988
VYou need to give up on using auto properties here
p72989
aVThey generate a private backing field that is not sequential with the property, it's added to the end
p72990
aVYou can see them with ildasm
p72991
aVexe, they have a name like
p72992
aVYou need to make this expression return the correct value:
p72993
aVI cannot see what SZLDataSet contains but without it this returns 0 right now
p72994
aVNot correct, you'd want 2
p72995
aVBest thing to do is to declare a struct with public fields whose layout is an exact match with the data in the buffer
p72996
aVInitialize the class object from the value
p72997
as(dp72998
g9
V17034
p72999
stp73000
a((dp73001
g2
(lp73002
VThere is no Windows API function by that name
p73003
aVI'm guessing you've found some DLL that exports this function
p73004
aVOdds are always good that the regex this DLL uses is of some kind that doesn't quite match the syntax that
p73005
aVNET's Regex class uses
p73006
aVThere are a lot of dialects
p73007
aVBest thing to do is to pinvoke EnumWindows()
p73008
aVYou can use your own Regex in the callback to filter, GetClassName() gets you the window class name
p73009
aVIf you already know the window name then just use FindWindow()
p73010
as(dp73011
g9
V17034
p73012
stp73013
a((dp73014
g2
(lp73015
VIt isn't clear why you just wouldn't set the timer's Interval to the target date/time
p73016
aVThere's a limit on the number of milliseconds, you can time up to 2^31 milliseconds, 27 days
p73017
aVYou'll be good as long as you can stay in that range
p73018
as(dp73019
g9
V17034
p73020
stp73021
a((dp73022
g2
(lp73023
VThe Text property is inherited from UserControl
p73024
aVWhere it is hidden, a user control has no meaningful way of of showing text
p73025
aVYou have to inherit it again and turn all the attributes off that make it hidden
p73026
aVLike this:
p73027
as(dp73028
g9
V17034
p73029
stp73030
a((dp73031
g2
(lp73032
VYou created a string with 256 characters that are 0
p73033
aVThe debugger cannot display them
p73034
aVUse this to trim the string:
p73035
as(dp73036
g9
V17034
p73037
stp73038
a((dp73039
g2
(lp73040
VThe first question is straight forward, it is a wrapper, not a replacement
p73041
aVThe term is RCW, Runtime Callable Wrapper
p73042
aVThe second is a what-if situation
p73043
aVA simple bug fix that doesn't change anything in the publicly visible interface of the COM server doesn't require any action on your end beyond verifying that the change didn't break your program
p73044
aVIt is however a stone cold hard rule in COM that a change in a public interface requires using a new guid for the interface and the coclass
p73045
aVThis is very important to avoid DLL Hell
p73046
aVBecause such a change can cause very hard to detect breakage, an AccessViolation is not uncommon
p73047
aVYou will have no decent way to troubleshoot this
p73048
aVSuch a change requires that you run Tlbimp
p73049
aVexe again, the guids are part of the interop library declaration
p73050
aVAnd recompile your app
p73051
as(dp73052
g9
V17034
p73053
stp73054
a((dp73055
g2
(lp73056
VJust set the grid's Visible property to false if you have nothing to show
p73057
as(dp73058
g9
V17034
p73059
stp73060
a((dp73061
g2
(lp73062
VThis is technically possible by putting the printer in graphics mode and sending pixel data
p73063
aVYou'll have to create a monochrome bitmap in your program, the Bitmap and Graphics classes can get the job done
p73064
aVYou'd use Graphics
p73065
aVDrawText with a Font initialized with Arial to get the text the way you want it
p73066
aVEncoding the bitmap pixels into printer commands is the non-trivial part, be sure to have a decent programming manual for the printer
p73067
aVThis is otherwise exactly what the printer driver does
p73068
aVIt will be just as slow
p73069
as(dp73070
g9
V17034
p73071
stp73072
a((dp73073
g2
(lp73074
VSounds to me you've forgotten to set the event handler
p73075
aVLightning icon in the Properties window
p73076
aVBest thing to do in general is to override the OnXxx method of the form, you don't need an event to listen to your own class object's events
p73077
aVType this:
p73078
aVand the IntelliSense window pops up to let you pick OnFormClosing
p73079
aVAfter which it should look like this:
p73080
as(dp73081
g9
V17034
p73082
stp73083
a((dp73084
g2
(lp73085
VYou need to call Thread
p73086
aVSetApartmentState() to switch the thread to STA before starting it
p73087
aVAnd pump a message loop to keep any windows created on that thread alive, Application
p73088
aVRun()
p73089
aVApplication
p73090
aVExitThread() will terminate the message loop and cause the thread to exit
p73091
aVUsing Run(Form) makes that automatic, just as it does on the main thread
p73092
aVBeware however that the user may well have a hard time dealing with the windows you create on that thread
p73093
aVThey have no Z-order relationship with the windows in the main thread, the desktop is their parent
p73094
aVThat tends to make them easily get lost behind another window, including your own
p73095
aVAwkward workarounds for that are TopMost and pinvoking SetParent()
p73096
as(dp73097
g9
V17034
p73098
stp73099
a((dp73100
g2
(lp73101
VIt is because MessageBox
p73102
aVShow() is implemented with pinvoke, it calls the native Windows MessageBox() function
p73103
aVWhich doesn't mind getting a NULL for the lpText argument
p73104
aVThe C# language has much stricter rules for pure
p73105
aVNET instance methods (like ToString), it always emits code to verify that the object isn't null
p73106
aVThere's some background info on that in this blog post
p73107
as(dp73108
g9
V17034
p73109
stp73110
a((dp73111
g2
(lp73112
VIt is fairly rare to explicitly link a DLL
p73113
aVMostly because it is painful and error prone
p73114
aVYou need to write a function pointer declaration for the exported function and get the LoadLibrary + GetProcAddress + FreeLibrary code right
p73115
aVYou'd do so only if you need a runtime dependency on a plug-in style DLL or want to select from a set of DLLs based on configuration
p73116
aVOr to deal with versioning, an API function that's only available on later versions of Windows for example
p73117
aVExplicit linking is the default for COM and
p73118
aVNET DLLs
p73119
aVMore background info in this MSDN Library article
p73120
as(dp73121
g9
V17034
p73122
stp73123
a((dp73124
g2
(lp73125
VThis isn't very healthy, do make sure that Build + Rebuild works to verify that no circular dependency snuck in
p73126
aVNext step is to get more diagnostic info out of msbuild to see why it thinks it needs to build A
p73127
aVTools + Options, Projects and Solutions, Build and Run
p73128
aVChange the MSBuild project build output verbosity setting to "Diagnostic"
p73129
as(dp73130
g9
V17034
p73131
stp73132
a((dp73133
g2
(lp73134
VData breakpoints is what I remember, your description matches
p73135
aVIt used a processor feature, it requires the address of the variable and the size, the processor automatically generates a trap when it detects a write to the memory address
p73136
aVVery nice debugging tool
p73137
aVSadly no longer available in managed code, the garbage collector messes it up because it moves objects around while compacting the heap
p73138
aVWhich changes their address
p73139
aVThe interface between the garbage collector and the debugger isn't strong enough to allow the debugger to track these moves while the compacting is taking place at runtime
p73140
aVNo doubt to avoid a serious amount of overhead
p73141
aVThe next best thing you got is a property setter
p73142
aVYou can set a breakpoint on it
p73143
as(dp73144
g9
V17034
p73145
stp73146
a((dp73147
g2
(lp73148
VThis is hard-coded behavior inside the UserControl class, it traps the WM_SETFOCUS message and passes the focus to a child control
p73149
aVI do not know of a way to override this, even trapping it in WndProc() doesn't work since there is no good way to get the UC base class to handle it
p73150
aVThe best approach is to avoid the battle and use a docked Panel control to be the stand-in for focusing events you want the UC to handle
p73151
aVThat requires some hacking as well, Panel is also a container control, but that can be bypassed
p73152
aVCheck out my answer here for a focusable panel
p73153
as(dp73154
g9
V17034
p73155
stp73156
a((dp73157
g2
(lp73158
VThis is because you use a debugger
p73159
aVWinforms detects this and disables the event handler for Application
p73160
aVThreadException
p73161
aVThat's important, it lets you debug exceptions
p73162
aVTo get your catch clause to work without a debugger, you'll have to add this statement to your Main() method, before the Run() call:
p73163
aVIt now does make more sense to write an event handler for AppDomain
p73164
aVCurrent
p73165
aVUnhandledException instead, you'll also get notified about unhandled exceptions in worker threads
p73166
as(dp73167
g9
V17034
p73168
stp73169
a((dp73170
g2
(lp73171
VGDI+ has never been hardware accelerated
p73172
aVNo significant complaints after Win7 was introduced, this is likely to be fud
p73173
as(dp73174
g9
V17034
p73175
stp73176
a((dp73177
g2
(lp73178
VHard to guess what the problem might be without a snippet to look at
p73179
aVI'll just post something simple that works:
p73180
as(dp73181
g9
V17034
p73182
stp73183
a((dp73184
g2
(lp73185
VSaved file: C:\u005cTempNorlander
p73186
aVYou are trying to save a file that has the same name as the folder
p73187
aVThat's not allowed, UnauthorizedAccessException is the result
p73188
aVFix the file name to, say, C:\u005cTempNorlander\u005cmumble
p73189
aVtxt
p73190
as(dp73191
g9
V17034
p73192
stp73193
a((dp73194
g2
(lp73195
VIt is explained quite well in the MSDN Library docs for CLSCTX
p73196
aVLots of rules, the default behavior is:
p73197
aVIf neither the client nor the server
p73198
aVspecifies a preference, then:
p73199
aVIf the computer that hosts the server is running Windows XP or
p73200
aVWindows Server 2003 without Service
p73201
aVPack 1 (SP1) or later installed, then
p73202
aVCOM will prefer a 64-bit version of
p73203
aVthe server if available; otherwise it
p73204
aVwill activate a 32-bit version of the
p73205
aVserver
p73206
aVIf the computer that hosts the server is running Windows Server 2003
p73207
aVwith SP1 or later installed, then COM
p73208
aVwill try to match the server
p73209
aVarchitecture to the client
p73210
aVarchitecture
p73211
aVIn other words, for a
p73212
aV32-bit client, COM will activate a
p73213
aV32-bit server if available; otherwise
p73214
aVit will activate a 64-bit version of
p73215
aVthe server
p73216
aVFor a 64-bit client, COM
p73217
aVwill activate a 64-bit server if
p73218
aVavailable; otherwise it will activate
p73219
aVa 32-bit server
p73220
aVCheck the MSDN article if you want to override this behavior
p73221
as(dp73222
g9
V17034
p73223
stp73224
a((dp73225
g2
(lp73226
VSomething went seriously wrong during the install
p73227
aVRevision 42 was the original
p73228
aVNET 2
p73229
aV0 release
p73230
aVThe trace also shows 2
p73231
ag2512
aV50727
p73232
aV3053, that's a good one
p73233
aVRight now, the machine has a mix-match of assembly versions
p73234
aVThe exception is indeed expected with that
p73235
aVNo idea of course how this happened, I'm guessing a bad 3
p73236
aV5 install on top of an existing 2
p73237
aV0 install
p73238
aVOr you forgot to reboot the machine after installing
p73239
as(dp73240
g9
V17034
p73241
stp73242
a((dp73243
g2
(lp73244
VIt isn't clear what "AppDomain space" might mean
p73245
aVGuessing: here's an excellent blog post that describes the hazards of loading controls in a secondary AppDomain
p73246
aVThe key part is this one, followed by advice on how to make it work:
p73247
aVWindows Forms only supports isolating
p73248
aVtop-level windows via app domains
p73249
aVIt
p73250
aVdoes not support parent-child
p73251
aVrelationships across domains
p73252
aVMany
p73253
aVpeople have assumed that because
p73254
aVControl ultimately derives from
p73255
aVMarshalByRefObject that it can
p73256
aVsuccessfully be remoted; this is not
p73257
aVtrue
p73258
aVCertain interfaces on a control
p73259
aVcan be remoted across domains, but the
p73260
aVcontrol\u2019s API itself does not support
p73261
aVremoting
p73262
aVWhen you see exceptions
p73263
aVstating that the object cannot be
p73264
aVremoted because it isn\u2019t serializable,
p73265
aVwhat you\u2019re seeing is that someone has
p73266
aVtried to cast the remote proxy to
p73267
aVControl
p73268
as(dp73269
g9
V17034
p73270
stp73271
a((dp73272
g2
(lp73273
VIt's possible
p73274
aVYou have to prevent the Application class from making the form visible
p73275
aVYou cannot tinker with Application, that's locked up
p73276
aVBut this works:
p73277
aVThis is a one-time cancellation, your next call to Show() or setting Visible = true will make it visible
p73278
aVYou'd need some kind of trigger, a NotifyIcon context menu is typical
p73279
aVBeware that the Load event won't run until it actually gets visible
p73280
aVEverything else works like normal, calling the Close() method terminates the program
p73281
as(dp73282
g9
V17034
p73283
stp73284
a((dp73285
g2
(lp73286
VThere's not a whole lot predictable about a process that crashes violently
p73287
aVIf it was due to an hardware exception, like AccessViolation, then there are some reasonable odds that the process exit code will be a good indicator
p73288
aVUse Process
p73289
aVExitCode after WaitForExit() to read it
p73290
aVA value of 0 usually indicates success, although that's up to the app as well
p73291
as(dp73292
g9
V17034
p73293
stp73294
a((dp73295
g2
(lp73296
VYes, this an awkward quirk of the ValidateChildren method
p73297
aVIt doesn't know that canceling was intended
p73298
aVPaste this code to fix the problem:
p73299
aVTo avoid having a Validate event handler running that causes side-effects, like a message box, add this statement to the top of the method:
p73300
aVPaste this code into your form to get the DialogResult set before it tries to validate the form:
p73301
as(dp73302
g9
V17034
p73303
stp73304
a((dp73305
g2
(lp73306
VThere isn't any reason why you couldn't use SendKeys from a class
p73307
aVJust be sure to put the  directive at the top of the file
p73308
aVAdd the reference if this class lives in its own class library project
p73309
as(dp73310
g9
V17034
p73311
stp73312
a((dp73313
g2
(lp73314
VIt is the same message
p73315
aVYou'll need to use CreateWindowW() or compile with UNICODE defined to get a Unicode enabled edit control
p73316
as(dp73317
g9
V17034
p73318
stp73319
a((dp73320
g2
(lp73321
VBecause it has a version of FindFirstFile that is declared as:
p73322
aVWhy use a C API when you've got a nice C++ implementation for it lying around
p73323
aVIt is an internal Microsoft library, not documented
p73324
as(dp73325
g9
V17034
p73326
stp73327
a((dp73328
g2
(lp73329
VOpen the form in design mode
p73330
aVLocate the PrintDocument control in the toolbox
p73331
aVDrag and drop it onto your form
p73332
aVThat adds a field to your form class named "printDocument1"
p73333
aVNext, double-click the printDocument1 image displayed below the form
p73334
aVThat adds the PrintPage event handler
p73335
aVUse the code from your book
p73336
aVReview the instructions in the book, it should have mentioned this
p73337
aVBest to use its step-by-step instructions rather than mine
p73338
as(dp73339
g9
V17034
p73340
stp73341
a((dp73342
g2
(lp73343
VIt doesn't require an extension, you can alter the menu to your heart's content without coding
p73344
aVTools + Customize, Commands tab
p73345
aVClick the Toolbar radio button and select "Context Menus | Project and Solution Context Menus | Solution"
p73346
aVYou'll should see your too-long context menu
p73347
aVMove a favorite command in a better spot with the Move Up button
p73348
aVUse the Add New Menu button to add a sub-menu
p73349
as(dp73350
g9
V17034
p73351
stp73352
a((dp73353
g2
(lp73354
VA wee bit of surgery is required
p73355
aVOpen the node next to your form in the Solution Explorer window
p73356
aVDouble-click the Designer
p73357
aVcs file for the form
p73358
aVLocate the Dispose() method and cut-and-paste it into your form's source code file
p73359
aVNow you can alter it and call the Dispose methods on the disposable object references in your form class
p73360
aVPre-empting: no, it is okay to edit this part of the designer file
p73361
aVOnly the section in the #region is off limits
p73362
as(dp73363
g9
V17034
p73364
stp73365
a((dp73366
g2
(lp73367
VYou need to pinvoke GetWindowRect() to find out where the window is located
p73368
aVSo you can adjust x and y by the window position
p73369
aVVisit pinvoke
p73370
aVnet for the declarations
p73371
as(dp73372
g9
V17034
p73373
stp73374
a((dp73375
g2
(lp73376
VYes, that will go kaboom
p73377
aVYou will always get a WM_MOUSEMOVE message before you get a WM_LBUTTONDOWN message
p73378
aVYou didn't create the sh object yet
p73379
aVChange
p73380
aVto
p73381
aVfor a first-order fix
p73382
as(dp73383
g9
V17034
p73384
stp73385
a((dp73386
g2
(lp73387
VTo get the console to filter out alphabetical keystrokes you have to take over input parsing
p73388
aVThe Console
p73389
aVReadKey() method is fundamental to this, it lets you sniff the pressed key
p73390
aVHere's a sample implementation:
p73391
aVYou could add, say, Decimal
p73392
aVTryParse() in the if() statement that detects the Enter key to verify that the entered string is still a valid number
p73393
aVThat way you can reject input like "1-2"
p73394
as(dp73395
g9
V17034
p73396
stp73397
a((dp73398
g2
(lp73399
VThis is an XY problem, just don't use FastZip
p73400
aVFollow the first example on this web page to avoid accidents
p73401
as(dp73402
g9
V17034
p73403
stp73404
a((dp73405
g2
(lp73406
VBytesToRead is going to be 0 when you run this code without a debugger
p73407
aVIt takes time for the serial port device to send a response
p73408
aVThis ought to solve your problem:
p73409
aVReadLine() keeps reading until it detects a SerialPort
p73410
aVNewLine in the response
p73411
as(dp73412
g9
V17034
p73413
stp73414
a((dp73415
g2
(lp73416
VBeware of code that you copied off a website, maybe a blog post
p73417
aVThe author may well have used a word processor, one that implements 'smart quotes'
p73418
aVIf you look closely at the first and the second line you'll see the difference
p73419
aVYour compiler will only like the straight double-quotes
p73420
aVIt doesn't quite explain your problem with the Immediate Window, it works when I try your string as shown
p73421
aVMaybe it doesn't quite look like it either
p73422
as(dp73423
g9
V17034
p73424
stp73425
a((dp73426
g2
(lp73427
VThis is allowed because the C# team cannot control this
p73428
aVThey heavily rely on the implementation details of delegates (CLR + BCL) and the JIT compiler's optimizer
p73429
aVThere already is quite a proliferation of CLR and jitter implementations right now and there is little reason to assume that's going to end
p73430
aVThe CLI spec is very light on rules about delegates, not nearly strong enough to ensure all these different teams will end up with an implementation that guarantees that delegate object equality is consistent
p73431
aVNot in the least because that would hamper future innovation
p73432
aVThere's lots to optimize here
p73433
as(dp73434
g9
V17034
p73435
stp73436
a((dp73437
g2
(lp73438
VThere are two distinct kind of arrays in
p73439
aVNET, a one dimensional 'vector' and multidimensional arrays
p73440
aVYou got the latter back, a multidimensional array with a rank of 1
p73441
aVThis will happen if the unmanaged code has returned a SAFEARRAY whose lower-bound isn't 0
p73442
aVYou can read the content of the array with Array
p73443
aVGetValue()
p73444
aVOr convert it, like this:
p73445
aVTest:
p73446
as(dp73447
g9
V17034
p73448
stp73449
a((dp73450
g2
(lp73451
VI think I see what you did
p73452
aVYou are using MDI and you put the menu labels and buttons on the MDI parent form
p73453
aVYou did something with the MDI client window, it is normally dark-gray
p73454
aVMaybe you figured out how to change its BackColor or changed the Windows system color
p73455
aVYes, your screen shot it the result
p73456
aVThe problem is that MDI client forms are parented to the MDI client window
p73457
aVWhich makes them show up behind the controls you put on the parent form
p73458
aVThere is no workaround for this, you are going to have to change your UI
p73459
aVTo keep MDI, put a Panel on the parent form and set its Dock property to Left
p73460
aVMove the menu controls on that
p73461
aVThe MDI client window will now shrink, occupying the remainder of the parent form
p73462
aVAnd the child forms will constrain themselves to that area
p73463
aVThe wee painful bit is that you'll have to reorganize the menu to fit the much smaller space available in the panel
p73464
as(dp73465
g9
V17034
p73466
stp73467
a((dp73468
g2
(lp73469
VHelpProvider gets in the way here, use the Help class
p73470
aVFirst off, putting the
p73471
aVchm file in the same directory as your EXE is a very good idea
p73472
aVProject + Add Existing Item and select your
p73473
aVchm file so it is added to your project
p73474
aVSelect it in the Solution Explorer window, in the Properties window set Build Action = Content, Copy to Output Directory = Copy if newer
p73475
aVSample code for your form:
p73476
as(dp73477
g9
V17034
p73478
stp73479
a((dp73480
g2
(lp73481
VThe InvalidateEx() method isn't correct, you need to map the rectangle from panel coordinates to parent coordinates
p73482
aVLike this:
p73483
aVThe best way to get the scroll bar is to use the AutoScrollMinSize property:
p73484
aVThis should fix your problems, except one
p73485
aVYou'll notice the effect of the "Show window content while dragging" system option
p73486
aVIt is best described as 'doing the pogo'
p73487
aVNo fix for this, you cannot reasonably turn the system option off
p73488
aVThis just can't work well
p73489
as(dp73490
g9
V17034
p73491
stp73492
a((dp73493
g2
(lp73494
VStopping a System
p73495
aVTimers
p73496
aVTimer reliably is indeed a major effort
p73497
aVThe most serious problem is that the threadpool threads that it uses to call the Elapsed event can back up due to the threadpool scheduler algorithm
p73498
aVHaving a couple of backed-up calls isn't unusual, having hundreds is technically possible
p73499
aVYou'll need two synchronizations, one to ensure you stop the timer only when no Elapsed event handler is running, another to ensure that these backed-up TP threads don't do any harm
p73500
aVLike this:
p73501
aVConsider setting the AutoReset property to false
p73502
aVThat's brittle another way, the Elapsed event gets called from an internal
p73503
aVNET method that catches Exception
p73504
aVVery nasty, your timer code stops running without any diagnostic at all
p73505
aVI don't know the history, but there must have been another team at MSFT that huffed and puffed at this mess and wrote System
p73506
aVThreading
p73507
aVTimer
p73508
aVHighly recommended
p73509
as(dp73510
g9
V17034
p73511
stp73512
a((dp73513
g2
(lp73514
VPut this line in the Main() method of the 2nd project:
p73515
aVThat brings up the just-in-time debugger prompt as soon as the 2nd process starts running
p73516
aVYou can pick either a new or an existing instance of visual studio to debug it
p73517
aVUse Debug + Step Out to get back into managed code
p73518
as(dp73519
g9
V17034
p73520
stp73521
a((dp73522
g2
(lp73523
VThis is built-in behavior for the VB
p73524
aVNET compiler
p73525
aVThis sample class triggers it:
p73526
aVThe attribute matters
p73527
aVIt is not otherwise generically useful behavior, you cannot tell the compiler to make it generate a similar warning using your own attribute
p73528
as(dp73529
g9
V17034
p73530
stp73531
a((dp73532
g2
(lp73533
VPut Console
p73534
aVWriteLine(e) in the catch block
p73535
aVSwitch to the release build and press Ctrl+F5
p73536
aVYou'll see this:
p73537
aVNote that the HideMe() method is not visible in the stack trace
p73538
aVMission accomplished
p73539
aVThat's what happens when the JIT optimizer inlines a method
p73540
aVThe only way to hide methods in the stack trace
p73541
aVIt is not something you can control well, the method has to be 'small' and not throw any exception itself
p73542
aVThis is otherwise normally considered a problem, not a feature
p73543
aVHard to figure out how to code got from A to B
p73544
as(dp73545
g9
V17034
p73546
stp73547
a((dp73548
g2
(lp73549
VIt's possible
p73550
aVAdd a class to your project and paste this code:
p73551
aVYou use it like this, the BeginInvoke call is important:
p73552
as(dp73553
g9
V17034
p73554
stp73555
a((dp73556
g2
(lp73557
VHandles requires WithEvents in the DIM statement:
p73558
aVThe scope of this declaration isn't obvious from the snippet
p73559
aVIf it is a local variable then you have to use AddHandler and remove the Handles keyword:
p73560
as(dp73561
g9
V17034
p73562
stp73563
a((dp73564
g2
(lp73565
VYou are mixing bytes and strings
p73566
aVMSComm was very lax about it but SerialPort cares about text encoding
p73567
aVClearly you are using a binary protocol, it is likely that your received string is containing question marks for bytes that could not be converted to the SerialPort
p73568
aVEncoding (default is ASCII)
p73569
aVYou have to use the Read() method to get the response
p73570
as(dp73571
g9
V17034
p73572
stp73573
a((dp73574
g2
(lp73575
VNo, there is no identifiable focus during the D+D and the D+D events don't report back mouse wheel motion
p73576
aVA typical trick is using DragOver and checking if the dragging cursor is close to either end of a scrollable region
p73577
aVAnd scroll with a timer
p73578
aVAn example is here
p73579
as(dp73580
g9
V17034
p73581
stp73582
a((dp73583
g2
(lp73584
VDon't do this, it cannot work reliably by design
p73585
aVThe first obvious flaw you'll run into is that all the Windows dialogs won't change their language (MessageBox, OpenFileDialog, etc)
p73586
aVThey always use the system language
p73587
aVMuch more serious are the non-obvious flaws
p73588
aVYou cannot control the culture of any threads easily, especially threadpool threads
p73589
aVThey'll do something nasty like fill a SortedList, a list that's isn't sorted anymore in the UI thread
p73590
aVMany other subtle problems like this
p73591
aVMoreover, it is a feature that no user ever needs
p73592
aVThey don't switch their mother tongue  on-the-fly
p73593
aVIf the machine really is used by multilingual users then it will have a version of Windows that allows switching the system language
p73594
aVYour app automatically follows suit
p73595
as(dp73596
g9
V17034
p73597
stp73598
a((dp73599
g2
(lp73600
VIt is possible to time gen #2 collections (the slow ones) with the GC
p73601
aVRegisterForFullGCNotification() method
p73602
aVThat however requires the server version of the collector ( element in the
p73603
aVconfig file)
p73604
aVClassic Heisenbergian, it defeats the point since only the workstation version supports concurrent gen #2 collections, they can significantly improve latency
p73605
aVThe actual latency it produces is very unpredictable, it highly depends on at what rate threads in your program are allocating and filling gen #0 and #1 while a concurrent collection is in progress
p73606
aVNot having to ask this question is strongly recommended
p73607
as(dp73608
g9
V17034
p73609
stp73610
a((dp73611
g2
(lp73612
VYou have a problem with the Oracle data provider
p73613
aVIt is best to reinstall it
p73614
as(dp73615
g9
V17034
p73616
stp73617
a((dp73618
g2
(lp73619
VThe As New syntax is causing the problem
p73620
aVDelayed initialization does not work here, the compiler generates code in the constructor to initialize the MyFoo property
p73621
aVThis injected code always runs before any code you write yourself
p73622
aVNo clean fix, you will have to use a private backing field:
p73623
as(dp73624
g9
V17034
p73625
stp73626
a((dp73627
g2
(lp73628
VThe mouse position you get (e
p73629
aVX, e
p73630
aVY) is in screen coordinates
p73631
aVYou have to map it to the chart control
p73632
aVFix:
p73633
as(dp73634
g9
V17034
p73635
stp73636
a((dp73637
g2
(lp73638
VWindows doesn't support notifications for this
p73639
aVUse a 'few second' timer to periodically retry
p73640
as(dp73641
g9
V17034
p73642
stp73643
a((dp73644
g2
(lp73645
VYou can use _control87 to enable division-by-zero exceptions
p73646
aVLike this:
p73647
aVUse this only to diagnose the bug
p73648
aVChanging the FPU control word is very destabilizing to libraries that expect the FPU to have its default initialization
p73649
as(dp73650
g9
V17034
p73651
stp73652
a((dp73653
g2
(lp73654
VI'm not aware of an option to generate or preserve a minidump beyond Environment
p73655
aVFailFast
p73656
aVYou can reverse-engineer the Watson log with the hints in this answer
p73657
aVBut, really, that's painful and not that informative
p73658
aVWrite an event handler for AppDomain
p73659
aVCurrentDomain
p73660
aVUnhandledException and log or display the value of e
p73661
aVExceptionObject
p73662
aVToString()
p73663
aVThe stack trace you'll get is almost always good enough to figure out the problem
p73664
as(dp73665
g9
V17034
p73666
stp73667
a((dp73668
g2
(lp73669
VIt improves the warm startup time of your program
p73670
aVA warm start is one where the assembly data is already in the file system cache so no time is spent by the disk drive to locate the DLL on the disk
p73671
aVAs opposed to a cold start, one you'll get when the assembly has never been loaded before or was loaded long ago, the disk drive has to find the file first
p73672
aVWhich is slow
p73673
aVYou almost always only care about cold start time because that's the one that's so noticeable to the user
p73674
aVWhich is the rub, ngen
p73675
aVexe creates an extra file that needs to be found by the disk drive
p73676
aVThe one that contains the prejitted machine code (
p73677
aVni
p73678
aVdll)
p73679
aVPossibly making the cold start slower
p73680
aVFor 'small' assemblies, it actually makes sense to let the JIT compiler jit the code because that can take less time than needed by the disk drive to find the prejitted DLL
p73681
aVWhat exactly is 'small', the break-even point, depends a great deal on how fast the disk drive can seek and its fragmentation state
p73682
aVYou'd have to experiment, but keep in mind that this won't repeat well on another machine
p73683
aVAnd that experiments like this are difficult in themselves, you'll easily get a warm start
p73684
as(dp73685
g9
V17034
p73686
stp73687
a((dp73688
g2
(lp73689
VStripped down to bare essentials, to understand COM you have to understand GUIDs and IUnknown
p73690
aVThe equivalent for Automation is ProgIDs and IDispatch
p73691
aVA ProgID helps you create a COM coclass
p73692
aVA typical ProgID is "Word
p73693
aVAutomation", the progid for Microsoft Word
p73694
aVYou'll find them listed in the Registry under HKEY_CLASSES_ROOT
p73695
aVA typical name for a helper function in your language is CreateObject()
p73696
aVYou pass it the ProgID, optionally a machine name, and you get back an interface reference
p73697
aVWhich you can then use to make method calls and get/set properties
p73698
aVThe language runtime uses the IDispatch interface (retrieved with IUnknown::QueryInterface) to discover the names and parameters of the methods that are implemented by the COM server
p73699
aVThis is called late-binding, the way any scripting language uses Automation
p73700
aVIt has only 4 methods:
p73701
aVIDispatch::GetTypeInfoCount(), returns 1 if the server can provide type info
p73702
aVIDispatch::GetTypeInfo(), returns type information, helpful to make type-safe calls
p73703
aVIDispatch::GetIDsOfNames(), maps an identifier name to a number
p73704
aVIDispatch::Invoke(), calls a numbered method or property getter/setter
p73705
aVThat's all it takes
p73706
as(dp73707
g9
V17034
p73708
stp73709
a((dp73710
g2
(lp73711
VTwo possible explanations
p73712
aVFirst is the Dock property, docking it to the top keeps the control at the top of the container, no matter what you assign to the Top or Location properties
p73713
aVThe other one is value types, the Location property is Point, a struct
p73714
aVThis code will not move the control:
p73715
as(dp73716
g9
V17034
p73717
stp73718
a((dp73719
g2
(lp73720
VThis is probably covered by the Unicode FAQ "What is a surrogate
p73721
aVIt is completely unclear what you are actually trying to accomplish but it sure sounds like you should use a FileStream and not a StreamWriter
p73722
aVBytes and characters are not interchangeable
p73723
as(dp73724
g9
V17034
p73725
stp73726
a((dp73727
g2
(lp73728
VThat's okay on modern machines, especially with a baudrate of 2400, but now it is up to you to control the handshake lines
p73729
aVYou have to turn the DTR and RTS signals on so the device knows that you're online and ready to receive data
p73730
as(dp73731
g9
V17034
p73732
stp73733
a((dp73734
g2
(lp73735
VUSB ports don't have names
p73736
aVIt is a bus, it doesn't matter what connector you use
p73737
aVJust like it doesn't matter where you plug in a card in the bus inside of the machine
p73738
aVIf you are actually talking about a USB device whose driver emulates a serial port (like "COM5"), pretty common, then you can get some info about the driver out of a WMI query, Win32_SerialPort class
p73739
aVUse the WMI Code Creator tool to play with such a query and to auto-generate the C# code you need
p73740
as(dp73741
g9
V17034
p73742
stp73743
a((dp73744
g2
(lp73745
Vhasfocus falls out of the sky
p73746
aVYou'll burn 100% core when it is true, there's nothing inside the if() statement that will make your program wait for anything
p73747
aVSleep(1) would fix that but it isn't otherwise obvious what you intend to do
p73748
as(dp73749
g9
V17034
p73750
stp73751
a((dp73752
g2
(lp73753
VCalling Refresh on a form merely forces it to be repainted
p73754
aVThere isn't any reason to assume that it will repaint differently
p73755
aVYou would have to override the OnPaint() method in that form
p73756
aVClearly you are not using OnPaint to draw an image, you are using a PictureBox
p73757
aVSetting that control's Visible property to false will make the image disappear, no additional help is needed
p73758
as(dp73759
g9
V17034
p73760
stp73761
a((dp73762
g2
(lp73763
VUse Type
p73764
aVGetEvents(), not GetFields()
p73765
aVYou can then use EventInfo
p73766
aVAddEventHandler()
p73767
as(dp73768
g9
V17034
p73769
stp73770
a((dp73771
g2
(lp73772
VThat's not how it really works
p73773
aVYou have to write dramatically different code in a console app vs a native Windows app
p73774
aVIn a console app, you use printf or cout to produce output, don't have much if any use for a mouse
p73775
aVA native Windows app requires a message loop and creating a window with a window procedure that detects the WM_PAINT message to update the window
p73776
aVEtcetera
p73777
aVBut you can write code that does both
p73778
aVJust write both a main() and a WinMain() function, the CRT automatically calls the correct one
p73779
as(dp73780
g9
V17034
p73781
stp73782
a((dp73783
g2
(lp73784
VThe linker embeds the
p73785
aVres file in the DLL
p73786
aVVerify this with File + Open + File, select your DLL, you can browse the embedded resources
p73787
aVThere is otherwise no mechanism to make embedded resources disappear when you copy the DLL, they are firmly embedded
p73788
as(dp73789
g9
V17034
p73790
stp73791
a((dp73792
g2
(lp73793
VThe operation is called 'flood fill'
p73794
aVPossible algorithms and their implementations, there are several, are well described here
p73795
as(dp73796
g9
V17034
p73797
stp73798
a((dp73799
g2
(lp73800
VYour solution works but is fundamentally the wrong approach
p73801
aVYou should have written your property like this:
p73802
aVWhich lets anybody that uses your class, including yourself, fall into the pit of success
p73803
aVAfter which you'd have found the proper solution, something similar to this:
p73804
aVYou can then further improve this by having the property setter raise a PropertyChanged event
p73805
aVAn event you can subscribe in your UI to set the button's Enabled property to false so it is immediately obvious to the user that clicking the button is no longer useful
p73806
as(dp73807
g9
V17034
p73808
stp73809
a((dp73810
g2
(lp73811
VThat's an integer division
p73812
aVTurn it into a floating point division by making at least one of the operands a floating pointer number:
p73813
aVor:
p73814
as(dp73815
g9
V17034
p73816
stp73817
a((dp73818
g2
(lp73819
VConsider pinvoking GetMouseMovePointsEx()
p73820
aVIt can give you move history for up to 64 points
p73821
aVEach point has a time stamp, allowing you to accurately calculate speed
p73822
aVIt gets you much more accuracy since the time stamp is not affected by any delays you may get from having the mouse move messages buffered in the message queue
p73823
aVAnd you can get points in native mouse units instead of pixels
p73824
aVVisit pinvoke
p73825
aVnet for the declarations
p73826
as(dp73827
g9
V17034
p73828
stp73829
a((dp73830
g2
(lp73831
VThere's little point that I see to do this in the ItemCheck event
p73832
aVJust calculate the delta when you save
p73833
aVCuts out a bunch of code and trouble with spurious events
p73834
as(dp73835
g9
V17034
p73836
stp73837
a((dp73838
g2
(lp73839
VThis is the source of the problem, the data you encrypt gets padded with zeros to get a block size that's a multiple of 32 bytes (32 x 8 = 256)
p73840
aVYou get those binary zeros back in the decrypted value
p73841
aVTricky about them is that the debugger cannot display them
p73842
aVWhich is okayish, you expect the value to roundtrip through ASCII, you can remove the zeros again after decrypting
p73843
aVThe decrypting code needs some work too, you assume too much about the size of the decrypted data
p73844
aVFix:
p73845
aVYou ought to dispose the streams btw, use the using statement
p73846
as(dp73847
g9
V17034
p73848
stp73849
a((dp73850
g2
(lp73851
VTroubleshoot this with Spy++, pay attention to the WM_SETCURSOR message
p73852
aVA scrollbar doesn't have any reason to change the cursor, you'll see it return FALSE (shown as 'fHaltProcessing:False in the Spy++ trace)
p73853
aVWhich cause the message to be sent to the parent of the control
p73854
aVFollow the trace, eventually you'll run into a parent window that returns TRUE
p73855
aVThat's the one that changed the cursor
p73856
aVOdds are decent that this will be Outlook
p73857
aVNo idea from your question why it thinks the UI is dead
p73858
aVDeriving your own class from Panel and overriding WndProc() to catch the message would be a workaround of sorts
p73859
aVI would however definitely focus on Outlook first
p73860
as(dp73861
g9
V17034
p73862
stp73863
a((dp73864
g2
(lp73865
VUsing UTF8
p73866
aVGetString() doesn't make sense here, the hashing function doesn't return a string encoded in utf-8
p73867
aVIt's just a byte[] with arbitrary byte values
p73868
aVUse Convert
p73869
aVToBase64String() instead
p73870
aVIt is still gobbledygook but it is supposed to be
p73871
aVIt's hashed
p73872
aVYou can roundtrip it back to byte[] with Convert
p73873
aVFromBase64String()
p73874
as(dp73875
g9
V17034
p73876
stp73877
a((dp73878
g2
(lp73879
VI repro
p73880
aVIt has some kind of odd problem with the bool member in the structure
p73881
aVReplace it with byte and it will work
p73882
aVBeware that there were a lot of mistakes in your code, I made this version work:
p73883
as(dp73884
g9
V17034
p73885
stp73886
a((dp73887
g2
(lp73888
VDon't use the WM_RBUTTONDOWN message, use the WM_CONTEXTMENU message instead
p73889
aVIt is automatically generated when the default window procedure sees the WM_RBUTTONUP message
p73890
aVNote UP, not DOWN
p73891
as(dp73892
g9
V17034
p73893
stp73894
a((dp73895
g2
(lp73896
VWell, no, your first order approach should be to check if the user entered the right number
p73897
aVA human mistyping a number or string is 99% of the problem
p73898
aVThat's well established in practice, the check digit is used in many common codes, UPC and ISBN being the ones that you'd see everyday
p73899
aVYou can flag it, they can re-type it again
p73900
aVError correcting codes are common too but have a very different application
p73901
aVTraditionally it is used in digital signaling media, aiming to detect and correct bit errors
p73902
aVReed-Solomon is the hundred pound gorilla there, really put on the map by the music CD
p73903
aVThat doesn't really work well in practice with a human, they'll introduce at least 6 bits of bad data by mis-typing one key
p73904
aVThat's very hard to correct, you'd have to add lots and lots of redundancy bits to the adjacent letters, making it more likely for the code to be mis-typed
p73905
aVThe best way for human-readable codes is for the code to make sense to a human
p73906
aVSomething that triggers the 'that looks wrong' response
p73907
aVLike a given name, as long as you're not Frank Zappa's kid
p73908
aVBut otherwise the foundation of codes like letter-letter + numbers
p73909
aVEtcetera
p73910
as(dp73911
g9
V17034
p73912
stp73913
a((dp73914
g2
(lp73915
VMy crystal ball says that the problem is located in the form's
p73916
aVresx file
p73917
aVOpen it in a text editor, navigate to line 2380 and change 4
p73918
ag2512
ag2512
aV0 to 2
p73919
ag2512
ag2512
ag2512
aVLook for additional ones
p73920
aVBe careful when trying to back-port forms that were designed on Visual Studio 2010
p73921
as(dp73922
g9
V17034
p73923
stp73924
a((dp73925
g2
(lp73926
VThis just isn't possible
p73927
aVA user with sufficient privileges can always alter security settings and run a program to access your file
p73928
aVSo, work from the assumption that you cannot stop this and focus on what the program or the user could do with the data in the file
p73929
aVEncrypt it
p73930
as(dp73931
g9
V17034
p73932
stp73933
a((dp73934
g2
(lp73935
VOptimizing code to make it less likely that a human can keep up with the blur of scrolling lines of text doesn't make a lot of sense
p73936
aVRethink this approach
p73937
aVOutput to a text file, use HTML perhaps to make it look decent, then start a program to display the result
p73938
aVEasier on your user's eyes
p73939
aVIt's going to run a lot faster as well, no auto-flushing and no time spent scrolling the console
p73940
aVOnly the disk I/O is your bottleneck now
p73941
as(dp73942
g9
V17034
p73943
stp73944
a((dp73945
g2
(lp73946
VMostly because it is pointless to use the property
p73947
aVYes, it ensures that the Elapsed event handler runs on the UI thread
p73948
aVBut now it just does the same thing as a System
p73949
aVWindows
p73950
aVForms
p73951
aVTimer
p73952
aVNot quite though, it is worse
p73953
aVBecause it doesn't guarantee that Elapsed won't be called after you disable it
p73954
aVDisabling it doesn't flush any pending invokes nor TP threads that aren't ready to run yet
p73955
aVThere could be hundreds if the Interval is small compared to the amount of work done by the handler
p73956
aVYou absolutely want a System
p73957
aVWindows
p73958
aVForms
p73959
aVTimer here
p73960
aVYou are not doing any useful work on the threadpool thread
p73961
as(dp73962
g9
V17034
p73963
stp73964
a((dp73965
g2
(lp73966
VThreadException does work here yet, the exception is raised too early
p73967
aVWrite an event handler for AppDomain
p73968
aVCurrentDomain
p73969
aVUnhandledException, subscribe it in your Main() method (Program
p73970
aVcs) before the Application
p73971
aVRun() and/or form constructor call
p73972
aVIn the event handler log or display the value of e
p73973
aVExceptionObject
p73974
aVToString()
p73975
aVThe exception message and the stack trace you'll get is almost always good enough to diagnose and correct the cause of the exception
p73976
as(dp73977
g9
V17034
p73978
stp73979
a((dp73980
g2
(lp73981
V"IPv6MachineAddress" seems like an incredibly unusual name for a machine
p73982
aVBe sure to specify the machine name, not the registry key name
p73983
as(dp73984
g9
V17034
p73985
stp73986
a((dp73987
g2
(lp73988
VPoking around a bit with Reflector, this seems to happen when you use the XmlSerializer(Type, string) constructor, specifying a custom namespace
p73989
aVTry using the XmlSerializer(Type) constructor instead
p73990
as(dp73991
g9
V17034
p73992
stp73993
a((dp73994
g2
(lp73995
VAlternative
p73996
aVWinforms isn't dead, it is fully supported on
p73997
aVNET 4
p73998
ag2512
aVAnd about nothing you did in a Winforms project is salvageable when you convert it completely to a WPF app
p73999
as(dp74000
g9
V17034
p74001
stp74002
a((dp74003
g2
(lp74004
VYou are looking at the bowels of PresentationCore, code written in C++/CLI
p74005
aVThe name  is the class name for all global C++/CLI functions
p74006
aVIt bombs early, right after the assembly got loaded, the module initializer failed
p74007
aVThe exact job done by LoadWpfGfx() isn't documented anywhere that I know but can be easily guessed
p74008
aVIt is loading a unmanaged DLL that implements the graphics interface, probably the DirectX interface layer
p74009
aVThis is machine specific problem
p74010
aVThe function checks the registry for the proper DLL to load, then uses LoadLibrary() to load it
p74011
aVClearly the DLL is missing
p74012
aVYour customer needs to get their machine stable again, then reinstall
p74013
aVNET
p74014
aVIf they still have trouble then they can use SysInternals' ProcMon tool to see what registry keys and what DLL are being searched
p74015
as(dp74016
g9
V17034
p74017
stp74018
a((dp74019
g2
(lp74020
VMarshaling a call from one thread to specific other thread is highly untrivial
p74021
aVIt is not possible to arbitrarily interrupt the thread and make it execute some code
p74022
aVThat causes horrible re-entrancy problems
p74023
aVTrying to protect against that with, say, a semaphore is guaranteed to cause deadlock
p74024
aVThe target thread has to cooperate, it must be 'idle' and not actively mutating the state of the program
p74025
aVA common mechanism for that is a thread-safe queue
p74026
aVThe event raising thread puts a request on the queue, the target thread needs a loop that reads the requests off the queue and executes them
p74027
aVMaybe this sounds familiar, yes, that's the way the UI thread of a program works
p74028
as(dp74029
g9
V17034
p74030
stp74031
a((dp74032
g2
(lp74033
VUse a real timer, not a counting loop
p74034
aVReview SetTimer()
p74035
aVUnderstanding the event driven programming model for Windows is pretty important, it is well covered by any book about Windows programming, like Petzold's
p74036
as(dp74037
g9
V17034
p74038
stp74039
a((dp74040
g2
(lp74041
VYou are starting the process with the current working directory as the default
p74042
aVThat can cause problems if that directory isn't valid for the user you specify
p74043
aVUse the Process
p74044
aVStart(ProcessStartInfo) overload instead
p74045
aVSet the ProcessStartInfo
p74046
aVWorkingDirectory to a directory that's good for any user
p74047
aVLike c:\u005c
p74048
aVMore info in this KB article
p74049
as(dp74050
g9
V17034
p74051
stp74052
a((dp74053
g2
(lp74054
VI assume you mean C++/CLI, anonymous methods is a C# term
p74055
aVNo, not supported
p74056
aVIt doesn't support the C++0x lambdas either
p74057
as(dp74058
g9
V17034
p74059
stp74060
a((dp74061
g2
(lp74062
VFormStartPosition
p74063
aVCenterScreen can be a problem if the form rescales, adjusting itself to the video DPI setting
p74064
aVPaste this code in your form to fix it:
p74065
as(dp74066
g9
V17034
p74067
stp74068
a((dp74069
g2
(lp74070
VYou have to pinvoke SystemParametersInfo() with SPI_GETDESKWALLPAPER
p74071
aVThat returns the path to the wallpaper bitmap file
p74072
aVVisit pinvoke
p74073
aVnet for the required declarations
p74074
as(dp74075
g9
V17034
p74076
stp74077
a((dp74078
g2
(lp74079
VThat forces C# to create a delegate object on-the-fly
p74080
aVIt translates the code to this:
p74081
aVwhich is a problem, that delegate object isn't referenced anywhere
p74082
aVThe next garbage collection is going to destroy it, pulling the rug out from under the unmanaged code
p74083
aVYou already did the proper thing in your code, you just forgot to use it
p74084
aVFix:
p74085
aVDeriving your own class from NativeWindow and uses its AssignHandle() method is the better mousetrap btw
p74086
aVCall ReleaseHandle() when you see the WM_DESTROY message
p74087
as(dp74088
g9
V17034
p74089
stp74090
a((dp74091
g2
(lp74092
VThere is no correspondence whatsoever
p74093
ag3471
aVNET assembly is a data file, it contains 5 bytes of machine code
p74094
aVThe rest is metadata and IL
p74095
aVGibberish enough without the tools to decompile it, like ildasm
p74096
aVexe or Reflector
p74097
as(dp74098
g9
V17034
p74099
stp74100
a((dp74101
g2
(lp74102
s(dp74103
g9
V17034
p74104
stp74105
a((dp74106
g2
(lp74107
VAdd this line:
p74108
as(dp74109
g9
V17034
p74110
stp74111
a((dp74112
g2
(lp74113
VJust export a function that accepts a function pointer
p74114
aVThe C# code can call it, passing a delegate object
p74115
aVThe pinvoke marshaller does the heavy lifting, same thing as Marshal
p74116
aVGetFunctionPointerForDelegate()
p74117
aVWhich creates a stub that stores the delegate's Target and Method
p74118
aVThe function pointer you'll get points to that stub
p74119
aVThe exact same thing happens when C# code pinvokes, say, EnumWindows()
p74120
as(dp74121
g9
V17034
p74122
stp74123
a((dp74124
g2
(lp74125
VThat could have a side-effect
p74126
aVThe gauge might be jumping up and down, eager to send the reading
p74127
aVAfter all, somebody pressed the button to tell it that it's okay to send
p74128
aVBut its transmit routine is observing the handshake protocol, Data Terminal Ready is not on
p74129
aVJump, jump, ah
p74130
aVit's on
p74131
aVSend
p74132
aVThat takes a while, depends on the baudrate
p74133
aVWell, why did somebody press the button even though the computer wasn't ready
p74134
aVWhy isn't it always ready
p74135
aVAnswer that question, then you can delete Sleep()
p74136
aVAlso find out what happens when that somebody presses the button a hundred times before the computer is ready
p74137
aVYour Sleep() might well be too short
p74138
as(dp74139
g9
V17034
p74140
stp74141
a((dp74142
g2
(lp74143
VThis is a pretty serious warning, don't ignore it
p74144
aVThe scenario is that you created a COM object on a thread and that thread exited
p74145
aVBut you keep using that object
p74146
aVCOM takes care of objects that announced themselves to be not thread-safe (aka apartment threaded), it automatically marshals any calls on that object to the thread that created it
p74147
aVThat can't work when that thread is no longer around
p74148
aVIgnoring the warning can produce occasional and very hard to troubleshoot threading race errors
p74149
aVStuff that goes subtly wrong only once a week
p74150
aVReview your code, pay attention to how the object that it complains about got created
p74151
as(dp74152
g9
V17034
p74153
stp74154
a((dp74155
g2
(lp74156
VThat's just a subdirectory of your project directory
p74157
aVYour program doesn't use it at runtime, it should use the embedded resources
p74158
aVAnything you add to the
p74159
aVresx file gets copied there, not just images
p74160
aVBut you can rename the folder if you really want to, right-click it and click Rename
p74161
aVInstead of adding a
p74162
aVresx file to your project, I'd recommend you use the existing one
p74163
aVProject + Properties, Resources tab
p74164
aVMakes it very easy to retrieve the resource at runtime, just use Properties
p74165
aVResources
p74166
aVSomething in your code
p74167
as(dp74168
g9
V17034
p74169
stp74170
a((dp74171
g2
(lp74172
VThis is done by capturing the mouse
p74173
aVWhich forces any mouse event to be directed to you, even if it moves outside of the window
p74174
aVMouse
p74175
aVCapture() method
p74176
as(dp74177
g9
V17034
p74178
stp74179
a((dp74180
g2
(lp74181
VIf your app doesn't crash with an AccessViolationException after using it for a while (past a garbage collection) then it is pretty safe to assume that the unmanaged code made a copy of the array elements you passed it
p74182
aVThis is the normal thing to do, the library would otherwise be very hard to use from native code as well
p74183
aVThere also ought to be an API function that lets you clear or re-initialize the model, that one should be releasing the memory
p74184
as(dp74185
g9
V17034
p74186
stp74187
a((dp74188
g2
(lp74189
VThat's a bug
p74190
aVProbably in Windows, the MSDN Library documentation for TrackPopupMenu documents a very similar problem
p74191
aVI don't see an obvious workaround, other than avoiding using MessageBox
p74192
aVCreate a little form to be your About box
p74193
aVDisplay it with the Show() method
p74194
as(dp74195
g9
V17034
p74196
stp74197
a((dp74198
g2
(lp74199
s(dp74200
g9
V17034
p74201
stp74202
a((dp74203
g2
(lp74204
VYou'll need to elevated your privileges through a UAC prompt
p74205
aVAdd a manifest to your program as described in this answer
p74206
as(dp74207
g9
V17034
p74208
stp74209
a((dp74210
g2
(lp74211
VYour code works fine, there are not a lot of possible failure modes I can think of
p74212
aVExcept one, there's a bug in the interaction between the debugger and Windows SEH when you debug your code on a 64-bit operating system
p74213
aVThis causes exceptions to be swallowed without any diagnostic when you throw an exception in a form's OnLoad() override on Load event handler
p74214
aVWork around this bug with Project + Properties, Build tab, Platform Target = AnyCPU
p74215
aVIn general, you are doing the appropriate thing by not letting the default exception handling of an Application
p74216
aVThreadException display the dialog
p74217
aVBut keep it simple, do it like this:
p74218
aVNow you never have to worry about a ThreadException anymore, all exceptions trigger the AppDomain
p74219
aVUnhandledException event handler
p74220
aVAnd the #ifdef around the code still lets you debug an unhandled exception, the debugger will automatically stop when the exception is raised
p74221
aVAdd this to the UnhandledException method to prevent the Windows crash notification from showing up:
p74222
as(dp74223
g9
V17034
p74224
stp74225
a((dp74226
g2
(lp74227
VIt is a clumsy warning
p74228
aVThere are two aspects to COM DLL Hell
p74229
aVThe really bad one is modifying the public interfaces and not assigning new GUIDs
p74230
aVA client app that wasn't recompiled tends to crash and burn when it calls an entirely wrong method or bombs with a nasty AccessViolationException that gives no clue at all what the cause might be
p74231
aVThe second one is doing everything right (assigning new GUIDs) but then overwriting the existing DLL with the new version
p74232
aVYou'll still crash that stale client app but more mildly with an E_NOINTERFACE hresult that generates a pretty specific exception that helps you diagnose the cause
p74233
aVThe user isn't any happier though
p74234
aVThat scenario has a ready solution in
p74235
aVNET, the GAC supports side-by-side deployment of assemblies with different version numbers so that both the old and the new version can co-exist and the stale client app continues to be happy with the old version
p74236
aVWhich requires a strong name
p74237
aVYes, that warning could certainly have been suppressed when you use /codebase since that makes it quite clear you are not going to use the GAC
p74238
aVAlthough it doesn't hurt to tweak your nose a bit at using /codebase
p74239
aVAlso, you never use the GAC on your dev machine while testing but certainly should consider it when deploying
p74240
as(dp74241
g9
V17034
p74242
stp74243
a((dp74244
g2
(lp74245
V[ThreadStatic] is no free lunch
p74246
aVEvery access to the variable needs to go through a helper function in the CLR (JIT_GetThreadFieldAddr_Primitive/Objref) instead of being compiled inline by the jitter
p74247
aVIt also isn't a true substitute for a local variable, recursion is going to byte
p74248
aVYou really have to profile this yourself, guesstimating perf with that much CLR code in the loop isn't feasible
p74249
as(dp74250
g9
V17034
p74251
stp74252
a((dp74253
g2
(lp74254
VThe method exists in the CLR
p74255
aVThe JIT compiler has access to a table inside the CLR that contains the addresses of all MethodImplOptions
p74256
aVInternalCall functions
p74257
aVThe section of the table that's relevant to your question looks like this in the SSCLI20 source code (clr/src/vm/ecall
p74258
aVcpp):
p74259
aVTo jit the method call, it merely looks up the function name in that table and generates a direct CALL instruction to the function address as listed in the table
p74260
aVVery fast, direct transition from managed code to code written in C++ inside the CLR
p74261
aVThe ReflectionSerialization::GetUninitializedObject() method lives inside clr/src/vm/reflectioninvocation
p74262
aVcpp, it's too big to post here
p74263
aVYou can have a look-see at the downloadable SSCLI20 source code
p74264
aVThere's a bunch of error checking, then a call to a raw Allocate() method to allocate the memory for the object
p74265
aVNo constructor call
p74266
as(dp74267
g9
V17034
p74268
stp74269
a((dp74270
g2
(lp74271
VYou didn't create any window, not even a hidden one, so there's no way to get the loop to exit by sending a message to a window
p74272
aVAlso the reason that WM_DESTROY never fires
p74273
aVAll that's left is PostThreadMessage() to post WM_QUIT
p74274
aVYou'd have to be able to find the thread ID somehow
p74275
aVUsing Shell_NotifyIcon() would be wise
p74276
as(dp74277
g9
V17034
p74278
stp74279
a((dp74280
g2
(lp74281
VUse a namespace so these identifiers don't get added to the global namespace
p74282
as(dp74283
g9
V17034
p74284
stp74285
a((dp74286
g2
(lp74287
VIt addition to Dennis' comment about JPEG files, it is also important whether or not you compile with UNICODE in effect
p74288
aVIf you do then you'll have to specify the file as L"C:\u005ctest
p74289
aVjpg"
p74290
aVNote the L in front of the string, that makes it a wide string
p74291
aVOr use SystemParametersInfoA(), note the A (but it's archaic)
p74292
as(dp74293
g9
V17034
p74294
stp74295
a((dp74296
g2
(lp74297
VYes, this will happen when ConsoleApp
p74298
aVdll gets loaded twice
p74299
aVOnce by the main app, again by a plugin, using its local copy
p74300
aVA type's identity is determined by the assembly it was loaded from
p74301
aVIt isn't that clear to me how that happened
p74302
aVYour first weapon of choice is Fuslogvw
p74303
aVexe, set it up to log all the binds
p74304
aVFirst thing to do is to doctor the plugin project and set the Copy Local property of the ConsoleApp
p74305
aVdll reference to False so that extra copy isn't there to get accidentally used
p74306
aVCopying the plugin DLLs to the main app build folder is the never-have-trouble solution, you can load them with Assembly
p74307
aVLoad()
p74308
aVOr a subdirectory with a
p74309
aVconfig file that uses the  element to allow the CLR to find them
p74310
as(dp74311
g9
V17034
p74312
stp74313
a((dp74314
g2
(lp74315
VI have to sputter at the horrid waste of burning up such expensive resources as a Control and a Windows window, just to draw a dinky icon
p74316
aVTo save one line of code:
p74317
as(dp74318
g9
V17034
p74319
stp74320
a((dp74321
g2
(lp74322
VYou are using out-of-process COM
p74323
aVThat requires marshaling support, to make a method call the arguments of the method need to be serialized
p74324
aVThat's normally done by building the proxy/stub DLL from the code generated by midl
p74325
aVexe from the
p74326
aVidl file
p74327
aVOr by using the standard marshaller which works with the type library
p74328
aVBoth require registry entries in HKCR\u005cInterface
p74329
aVYou get the E_NOINTERFACE because COM cannot find a marshaller
p74330
aVThis is trivial to solve if you have an
p74331
aVidl file but you don't, the server is implemented in
p74332
aVNET
p74333
aVNo idea how to solve this, I never tried to make this work
p74334
aVA remote possibility is that the CLR interop layer provides marshaling support
p74335
aVBut you'd surely at least have to use ComInterfaceType
p74336
aVInterfaceIsDual
p74337
aVThis is just a guess
p74338
aVIf I tried to make this work, I'd start from an
p74339
aVidl first
p74340
as(dp74341
g9
V17034
p74342
stp74343
a((dp74344
g2
(lp74345
VYes, this is a very nasty exception
p74346
aVIt is raised by the finalizer of the SQLBaseCommand class
p74347
aVWhich will happen when the finalizer thread runs
p74348
aVThis is completely asynchronous from your code, it can strike at any point in time
p74349
aVThe CLR will immediately terminate your program
p74350
aVThis is rather a nasty bug in the database provider you are using, SQLBase by the sound of it
p74351
aVHard to believe they ship a provider with a bug like that
p74352
aVShort from looking for an update for that provider, take a good look at the SqlCommand objects that you create in your code
p74353
aVIf none of this helps then you really need support from the vendor (Unify)
p74354
as(dp74355
g9
V17034
p74356
stp74357
a((dp74358
g2
(lp74359
VCOM doesn't support function overloading
p74360
aVIt isn't that clear how you are making the call, but late binding will certainly fail
p74361
aVIDispatch::GetIDsOfNames() is going to return the wrong dispid when asked for "Send"
p74362
aVThat's not strongly indicated in this case since you derive from IUnknown
p74363
aVBut in itself is enough reasons to give these methods distinct names
p74364
aVI'd suggest SendText vs SendBytes
p74365
aVQuite justified in itself, bytes and characters are not at all equivalent in Unicode
p74366
as(dp74367
g9
V17034
p74368
stp74369
a((dp74370
g2
(lp74371
VYour picture box is at the bottom of the Z-order, covered by other controls
p74372
aVAdd this line:
p74373
as(dp74374
g9
V17034
p74375
stp74376
a((dp74377
g2
(lp74378
VWell, you found out that looking at the
p74379
aVvcproj file isn't enough
p74380
aVYou need to know the
p74381
aVsln file as well
p74382
aVYou're kinda stuck until you resolve this
p74383
aVVisual Studio will always create a
p74384
aVsln file when it loads a
p74385
aVvcproj file and cannot find a matching
p74386
aVsln
p74387
aVMaybe you want to do that too
p74388
as(dp74389
g9
V17034
p74390
stp74391
a((dp74392
g2
(lp74393
VOutput: 944
p74394
ag2447
as(dp74395
g9
V17034
p74396
stp74397
a((dp74398
g2
(lp74399
VAccess to the path 'C:\u005cinetpub\u005cwwwroot\u005cmysite\u005cimages\u005csavehere' is denied
p74400
aVRead the message carefully
p74401
aVYou are trying to save to a file that has the same name as the directory
p74402
aVThat's not permitted
p74403
aVYou need to use a name like 'C:\u005cinetpub\u005cwwwroot\u005cmysite\u005cimages\u005csavehere\u005cmumble
p74404
aVjpg'
p74405
as(dp74406
g9
V17034
p74407
stp74408
a((dp74409
g2
(lp74410
VDelete all the code after RunWorkerAsync(), it will only make your app crash when the user closes the form while zipping is in progress
p74411
aVIn the DoWork() method, use the bgw's ReportProgress() method to report progress
p74412
aVYou can write an event handler for the event to update the UI
p74413
aVMove refreshAll() into the bgw's RunWorkerCompleted event handler
p74414
aVDo review the examples giving the MSDN Library article for BackgroundWorker
p74415
aVBGW was designed to make multi-threading with the UI easy but if you are using it wrong then you'll just buy a lot of grief
p74416
aVPractice the examples first before making it work in your own code
p74417
as(dp74418
g9
V17034
p74419
stp74420
a((dp74421
g2
(lp74422
VWhen doing calculations with constantly incrementing counters
p74423
aVA classic example is Environment
p74424
aVTickCount:
p74425
aVIf that were checked, the program has odds to bomb 27 days after Windows was booted
p74426
aVWhen TickCount ticks beyond int
p74427
aVMaxValue while DoSomething was running
p74428
aVPerformanceCounter is another example
p74429
aVThese types of calculations produce an accurate result, even though overflow is present
p74430
aVA secondary example is the kind of math you do to generate a representative bit pattern, you're not really interested in an accurate result, just a reproducible one
p74431
aVExamples of those are checksums, hashes and random numbers
p74432
as(dp74433
g9
V17034
p74434
stp74435
a((dp74436
g2
(lp74437
Vand create a folder in the project called 'Data'
p74438
aVThat doesn't work
p74439
aVYour program is running in the bin\u005cDebug subdirectory of your project
p74440
aVIt doesn't have a Data subdirectory
p74441
aVYou'd have to use  to find that file
p74442
aVWell, that would solve your problem right now but it isn't going to be useful once you copy your program to another machine
p74443
aVThere won't be a  directory there
p74444
aVThink about ways that your user is going to tell you where the
p74445
aVcsv file is located
p74446
aVA GUI with OpenFileDialog is the friendly way but not very compatible with a console app
p74447
aVThe standard way for that is to pass command line arguments
p74448
aVEnvironment
p74449
aVCommandLine
p74450
aVNot very compatible with the typical user
p74451
aVYou'll have to weigh these options by yourself
p74452
as(dp74453
g9
V17034
p74454
stp74455
a((dp74456
g2
(lp74457
VI'm ready to declare this a bug in VS2010, this has bitten way too many programmers already
p74458
aVThe fix is easy: Project + Properties, Application tab, change Target Framework to "
p74459
aVNET Framework 4" instead of the Client Profile that is selected by default
p74460
aVSystem
p74461
aVWeb is not included in the client profile
p74462
aVHaving this option in the first place is quite silly, the client profile is only 15% smaller than the full version of
p74463
aVNET 4
p74464
ag2512
aVHaving it selected by default is even sillier
p74465
aVBut I digress
p74466
aVUPDATE: mercifully this all got fixed in VS2012
p74467
aVWhich no longer makes the client profile the default for a new project
p74468
aVAnd the client profile got retired completely in
p74469
aVNET 4
p74470
aV5, good riddance
p74471
as(dp74472
g9
V17034
p74473
stp74474
a((dp74475
g2
(lp74476
VNot quite sure what the problem might be
p74477
aVYou'll have to take charge of the StartPosition property of the form
p74478
aVThe default is "WindowsDefaultLocation" which is very apt to put it in a place you don't particularly like
p74479
aVChange it to "Manual", set the Location property before you call Show()
p74480
aVYes, those are screen coordinates, nothing relative
p74481
as(dp74482
g9
V17034
p74483
stp74484
a((dp74485
g2
(lp74486
VI can repro that, your startup project must be a C++ project
p74487
aVRight-click it, Properties, Debugging, Working Directory setting
p74488
aVYours is empty
p74489
aVThe default is $(ProjectDir)
p74490
as(dp74491
g9
V17034
p74492
stp74493
a((dp74494
g2
(lp74495
VThe debugger visualizers used by the
p74496
aVNET framework classes are internal
p74497
aVWhich makes them a bit hard to use, you cannot use typeof()
p74498
aVThere's a backdoor though, the [DebuggerTypeProxy] attribute also has a constructor that accepts a string
p74499
aVThe one you want to use is named Mscorlib_CollectionDebugView, it is capable of visualing any class that implements ICollection<>
p74500
aVHere's an example of usage:
p74501
aVThis works for
p74502
aVNET 4
p74503
aV0 as well, even though the version number is wrong
p74504
aVThis otherwise has a risk of breaking with the next version of
p74505
aVNET if they decide to rename the internal class
p74506
as(dp74507
g9
V17034
p74508
stp74509
a((dp74510
g2
(lp74511
VIt's a pretty classic bug when using the CreateProcess() function
p74512
aVThe last argument, lpProcessInformation, gives you a PROCESS_INFORMATION back
p74513
aVYou have to call CloseHandle() on the returned hProcess and hThread members if you are not interested in them
p74514
as(dp74515
g9
V17034
p74516
stp74517
a((dp74518
g2
(lp74519
VIt is the C/C++ way of passing a value by reference
p74520
aVYou should use the ref or out keyword:
p74521
aVIn C++/CLI that would look roughly like this:
p74522
as(dp74523
g9
V17034
p74524
stp74525
a((dp74526
g2
(lp74527
VPublicKeyToken=null
p74528
aVThe assembly isn't strong named
p74529
aVThat means it can't be located in the GAC, the CLR isn't going to look there
p74530
aVNot sure what you did to get in the GAC, but it shouldn't be possible as-is
p74531
as(dp74532
g9
V17034
p74533
stp74534
a((dp74535
g2
(lp74536
VThe compiler isn't aware of any particular
p74537
aVNET Framework version
p74538
aVAll it sees is the reference assemblies
p74539
aVNor is there any guarantee that your program will run with the
p74540
aVNET version that you target
p74541
aVIt is quite possible to run with the
p74542
aVNET 4
p74543
aV0 CLR even if you built for 2
p74544
ag2512
aVUse  instead
p74545
as(dp74546
g9
V17034
p74547
stp74548
a((dp74549
g2
(lp74550
VWell, there are always two places in the file that you can find with 100% reliability
p74551
aVThe beginning and the end
p74552
aVSo, when you add the hidden file, add another 4 bytes that stores the original length of the file and a special signature that's always distinct
p74553
aVWhen reading it back, first seek to the end - 8 and read that length and signature
p74554
aVThen just seek to that position
p74555
as(dp74556
g9
V17034
p74557
stp74558
a((dp74559
g2
(lp74560
VAn event is an accessor for a delegate
p74561
aVJust like a property is an accessor for a field
p74562
aVA property has the get and set accessors, an event has the add, remove and raise accessors
p74563
aVUnlike a property, you don't have to explicitly write these accessors, the compiler generates a default implementation for them
p74564
aVWhich is often good enough
p74565
as(dp74566
g9
V17034
p74567
stp74568
a((dp74569
g2
(lp74570
VThe debugger starts debugging with CreateProcess using the DEBUG_PROCESS option
p74571
aVThe main thread's handle is returned in PROCESS_INFORMATION
p74572
aVhThread so no guessing there
p74573
aVAttaching is a bit trickier, presumably the first CREATE_THREAD_DEBUG_EVENT notification its sees from WaitForDebugEvent after attaching with DebugActiveProcess()
p74574
aVThe source code for MDbg is available if you want to take a closer look
p74575
as(dp74576
g9
V17034
p74577
stp74578
a((dp74579
g2
(lp74580
VReverse-engineering the Watson dump, it is crashing in MS
p74581
aVInternal
p74582
aVAutomation
p74583
aVUiaCoreProviderApi
p74584
aVRawUiaClientsAreListening
p74585
aVThis is a pinvoked function from UIAutomationCore
p74586
aVdll
p74587
aVYou'll need to find out what happened to that DLL
p74588
aVIt is present in c:\u005cwindows\u005csystem32, mine has a time-stamp of July 13th 2009, 6:27:31 pm CST
p74589
as(dp74590
g9
V17034
p74591
stp74592
a((dp74593
g2
(lp74594
VRead this blog post about the very poorly chosen name for UnmanagedType
p74595
aVLPStruct and how it does not do what everybody thinks it does
p74596
aVFix your declaration like this:
p74597
as(dp74598
g9
V17034
p74599
stp74600
a((dp74601
g2
(lp74602
VKnowing the error message would be rather valuable
p74603
aVIt is meant to provide info, even though it doesn't make any sense to you it does to us
p74604
aVBeing forced to guess, I'd say that the DLL is a 32-bit DirectX filter
p74605
aVIn which case this should be the proper course of action:
p74606
aVThis must be run at an elevated command prompt so that UAC cannot stop the registry access that's required
p74607
aVAsk more questions about this at superuser
p74608
aVcom
p74609
as(dp74610
g9
V17034
p74611
stp74612
a((dp74613
g2
(lp74614
VSurely you don't want to shut down the entire application after the user adds a phone number
p74615
aVYou just need to make sure that your main window becomes visible again
p74616
aVWrite that like this:
p74617
as(dp74618
g9
V17034
p74619
stp74620
a((dp74621
g2
(lp74622
VUse Fuslogvw
p74623
aVexe to find out where the CLR looked for the assembly
p74624
aVThere are two basic reasons
p74625
aVFirst is that you incremented the [AssemblyVersion] of the assembly in a recent update and are trying to deserialize data that was saved with the old version of the assembly
p74626
aVThe second is that it simply cannot find the DLL
p74627
aVThere are but a few places where you can store an assembly so that it can be found when VS is running
p74628
aVEither the GAC or the PrivateAssemblies or PublicAssemblies subdirectory of Visual Studio's Common7\u005cIDE directory
p74629
as(dp74630
g9
V17034
p74631
stp74632
a((dp74633
g2
(lp74634
VWinforms has no reason to do anything special just because you changed a private field in your code
p74635
aVYou have to tell it that conditions you use in the Paint event handler changed and a new paint is required
p74636
aVMake your Click event handler look like this:
p74637
as(dp74638
g9
V17034
p74639
stp74640
a((dp74641
g2
(lp74642
VThis comes straight out of Windows, the IsThemePartDefined() API function
p74643
aVWhat's significant about this function is that it doesn't have any way to report an error, it can only return TRUE or FALSE
p74644
aVA possible failure mode here is that it may run into some kind of internal error and can only reasonably return FALSE
p74645
aVThat's a kaboom in Winforms
p74646
aVThese kind of 'runs for days, then crashes' kind of errors do have an almost universal reason
p74647
aVThe process has exhausted one of the Windows resources quotas
p74648
aVPretty typical when your app is leaking handles
p74649
aVThe first order diagnostic for this is looking at the resources used by your app from the Taskmgr
p74650
aVexe Processes tab
p74651
aVView + Select Columns and tick Handles, USER objects and GDI objects
p74652
as(dp74653
g9
V17034
p74654
stp74655
a((dp74656
g2
(lp74657
VThere is only one resource you can take advantage of by using Parallel
p74658
aVFor: CPU cycles
p74659
aVWhen you have N cores then you can theoretically speed up your code by a factor of N
p74660
aVWhat is however required is that it is actually CPU cycles that is the constraint in your code
p74661
aVWhich is not often the case unless you execute computationally expensive code
p74662
aVOther constraints are the speed of the hard disk, the network connection, a dbase server, in select cases the bandwidth of the memory bus
p74663
aVYou've only got one of those, Parallel
p74664
aVFor cannot magically give you another disk
p74665
aVTesting whether Parallel
p74666
aVFor will speed up your code is pretty simple
p74667
aVJust run the code without parallelizing and observe the CPU load in Taskmgr
p74668
aVexe or Perfmon
p74669
aVIf one core isn't running at 100% then your code is not compute bound
p74670
aVIf it is running at, say, 10% then you can only ever hope to make it take 90% of the time no matter how many cores you have
p74671
aVWhich you'll get by overlapping I/O wait time with processing time, two threads will get that done
p74672
as(dp74673
g9
V17034
p74674
stp74675
a((dp74676
g2
(lp74677
VThat code got messed up, there is a space or tab inserted in LPCWSTR
p74678
aVDeleting it will fix the problem
p74679
aVHowever, that changed the timestamp on the file as well, you may run into trouble when you install a future service pack
p74680
aVOne thing to try is to rename the file, then run a Repair to get the original file back
p74681
aVOr copy it off another machine
p74682
as(dp74683
g9
V17034
p74684
stp74685
a((dp74686
g2
(lp74687
VUncheck the "Create directory for solution" checkbox when you save the solution for the first time
p74688
aVVisual Studio memorizes this choice, it will stay unchecked when you create and save new solutions, until you change it again
p74689
as(dp74690
g9
V17034
p74691
stp74692
a((dp74693
g2
(lp74694
VThe official term is "cue banner"
p74695
aVHere's another way to do it, just inheriting TextBox gets the job done too
p74696
aVAdd a new class to your project and paste the code shown below
p74697
aVCompile
p74698
aVDrop the new control from the top of the toolbox and set the Cue property
p74699
aVYou get a live preview of the Cue value in the designer, localized to the form's Language property
p74700
aVLots of bang for very little buck, an excellent demonstration of the good parts of Winforms
p74701
as(dp74702
g9
V17034
p74703
stp74704
a((dp74705
g2
(lp74706
VThe format for negative numbers is a configurable item in Windows
p74707
aVIn Win7 that's done by Control Panel + Region and Language, Format tab, Additional Settings button
p74708
aVThe settings you select are written to the registry
p74709
aVSelecting a format with two trailing parentheses isn't an option it lets you enter, suggesting that the registry is messed up
p74710
aVIt's got a Reset option, try that first
p74711
aVAsk more questions about this at superuser
p74712
aVcom
p74713
as(dp74714
g9
V17034
p74715
stp74716
a((dp74717
g2
(lp74718
VBecause it is impossible to make it thread-safe
p74719
aVClasses that guarantee that the programmer will shoot his leg off without any way to fix the problem don't belong in a framework
p74720
aVYou are free to shoot your own leg off
p74721
as(dp74722
g9
V17034
p74723
stp74724
a((dp74725
g2
(lp74726
VYes, there's a difference
p74727
aVThe first one doesn't compile
p74728
aVMaybe you meant this:
p74729
aVThe #using directive allows you to reference an assembly without going through the Framework and References project setting
p74730
as(dp74731
g9
V17034
p74732
stp74733
a((dp74734
g2
(lp74735
VYou are missing the fact that arrays are objects themselves
p74736
aVThey have an object header like any managed reference type and a private field that stores the array size
p74737
aVYou have to overwrite those first before you start overwriting the array elements
p74738
aVOn a 32-bit machine, you'll start overwriting the first element of ptr_str2 with this:
p74739
aVOf course, it had to be 13
p74740
aVObserve this by setting a breakpoint on the for loop
p74741
aVDebug + Windows + Memory + Memory 1, type "ptr_str" in the Address box
p74742
aVStep the code to see the memory getting changed
p74743
aVYou'll see ptr_str2 right after that, 4 bytes for the syncblk, 4 bytes for the method table pointer and 4 bytes for the array length
p74744
aV12 bytes total, 6 chars
p74745
as(dp74746
g9
V17034
p74747
stp74748
a((dp74749
g2
(lp74750
VYes, this cannot work properly
p74751
aVThe native code is storing a function pointer for the delegate object but the garbage collector cannot see this reference
p74752
aVAs far as it is concerned, there are no references to the object
p74753
aVAnd the next collection destroys it
p74754
aVKaboom
p74755
aVYou have to store a reference to the object yourself
p74756
aVAdd a field in the class to store it:
p74757
aVThe rule is that the class that stores the object must have a lifetime at least as long as native code's opportunity to make the callback
p74758
aVIt must be static in this particular case, that's solid
p74759
as(dp74760
g9
V17034
p74761
stp74762
a((dp74763
g2
(lp74764
VThis is quite normal
p74765
aVUpdating an existing file is quite dangerous since it can cause irretrievable data loss
p74766
aVA disk error (like disk full) while writing is very bad news
p74767
aVThe common algorithm used:
p74768
aVrename the original file
p74769
aVwrite a new file using the original name
p74770
aVno error: delete the renamed file
p74771
aVerror: delete the new file, rename original file back
p74772
aVClearly this doesn't cause a Changed event to be raised, no file was changed
p74773
aVSorry, I didn't read the question well enough
p74774
aVThere is no notification whatsoever for an app just opening a file for reading
p74775
aVFSW can only detect changes to the file system
p74776
aVThere is no ready alternative either, this requires a custom file system filter driver that snoops on driver requests
p74777
aVLike the kind that SysInternals' ProcMon utility uses
p74778
aVI'm not aware of such a driver ready for use in a C# program, you can't write them in C# either
p74779
aVThis just isn't a common requirement
p74780
as(dp74781
g9
V17034
p74782
stp74783
a((dp74784
g2
(lp74785
VCOM servers can generate their own HRESULT error codes
p74786
aVThe IErrorInfo interface helps a client to get a description of the error
p74787
aVYou are not giving the _com_error class a chance to do that job, you don't pass the IErrorInfo interface pointer to the constructor
p74788
aVFirst QI the interface for ISupportErrorInfo and call its InterfaceSupportsErrorInfo() method to verify that error reporting is supported
p74789
aVNext call GetErrorInfo() to obtain the IErrorInfo interface pointer
p74790
aVMSDN docs are here
p74791
as(dp74792
g9
V17034
p74793
stp74794
a((dp74795
g2
(lp74796
VYou are using wchar_t, sizeof(String) will be 800, not 400
p74797
aVFix:
p74798
as(dp74799
g9
V17034
p74800
stp74801
a((dp74802
g2
(lp74803
VIt is crashing while trying to create an ActiveX control
p74804
aVThe error code indicates that the control is not installed
p74805
aVThere's a good candidate in your assembly list
p74806
aVInstall Adobe Shockwave on the machine
p74807
as(dp74808
g9
V17034
p74809
stp74810
a((dp74811
g2
(lp74812
VVisual Studio always creates a solution
p74813
aVIf it cannot find one in the same folder as the
p74814
aVcsproj file then it will create one itself, based on what it can reverse-engineer from the project file content
p74815
aVThe solution is hidden by default if the solution only contains one project
p74816
aVFixing this is recommended: Tools + Options, Projects and Solutions, General, "Always show solution" checkbox
p74817
as(dp74818
g9
V17034
p74819
stp74820
a((dp74821
g2
(lp74822
VYou'll have to turn the LabelEdit property on and off as needed:
p74823
aVBeware that this has side effects, the LabelEdit property is a style flag for the native Windows control
p74824
aVChanging it requires completely destroying the window and re-creating it from scratch
p74825
aVThe most visible side-effect is a small flicker when the window redraws itself after getting created
p74826
aVThere could be other ones, I didn't see anything go wrong myself
p74827
as(dp74828
g9
V17034
p74829
stp74830
a((dp74831
g2
(lp74832
VGive the control(s) you add to the form a Name
p74833
aVThen it is
p74834
as(dp74835
g9
V17034
p74836
stp74837
a((dp74838
g2
(lp74839
VBy default ATL creates "auto-dual" COM classes
p74840
aVThey support both early binding and IDispatch
p74841
aVYou'll see IDispatchImpl<> in their inheritance list
p74842
aVYou declare the dispid in the IDL
p74843
aVNo extra work is required
p74844
as(dp74845
g9
V17034
p74846
stp74847
a((dp74848
g2
(lp74849
VThe usual approach is to give the panels distinct BackColors so that it is obvious where to place the cursor to start dragging
p74850
aVAnother thing you could do is put a Panel on the left side and set its Dock property to Right
p74851
aVGive it a distinct BackColor and set its width to 2
p74852
as(dp74853
g9
V17034
p74854
stp74855
a((dp74856
g2
(lp74857
VNot so sure this has a name
p74858
aVIt is quite standard, the _callCountUp/Dn fields avoid trouble when changing the Checked property of a node causes the AfterCheck event handler to run again
p74859
aVStackOverflow is a very typical outcome when the event handler recurses without bound
p74860
aVThe generic pattern resembles this:
p74861
aVThe finally block ensures that a handled exception (such as through ThreadExceptionDialog) doesn't permanently leave the state variable set to true
p74862
aVIt's optional of course
p74863
as(dp74864
g9
V17034
p74865
stp74866
a((dp74867
g2
(lp74868
VWell, it is all relative
p74869
aVA process in Windows is in general an expensive resource, but only if you compare it to an operating system like Unix
p74870
aVThe normal Windows resource sharing rules are in effect for a managed process
p74871
aVThere will only ever be one copy in physical memory for the code in the CLR, JIT compiler and any assembly that is ngen-ed which includes all of the
p74872
aVNET framework assemblies
p74873
aVThe Windows memory manager simply maps the same pages in all processes that uses these DLLs
p74874
aVWhat is not shared is the Private Bytes, you can see this number with a tool like SysInternal's Process Explorer
p74875
aVThe bigger chunks of private bytes in a
p74876
aVNET process are
p74877
aVthe garbage collected heap
p74878
aVstacks used by threads, by default 1 MB a piece
p74879
aVany static variables used by the code loaded in an AppDomain
p74880
aVjust-in-time generated code for assemblies that weren't ngen-ed
p74881
aVthe private data for the CLR and the jitter
p74882
aVClearly using ngen
p74883
aVexe can significantly cut down on the amount of private bytes, as long as you use the assembly in more than one process
p74884
aVAn AppDomain is
p74885
aVNET's way to cut down on the cost of a process and still achieve a level of isolation, used to great effect in custom CLR hosts like ASP
p74886
aVNET and SQL Server
p74887
aVIf you have the option to run code in a thread vs running it in another process then a thread should always be the preferred choice
p74888
as(dp74889
g9
V17034
p74890
stp74891
a((dp74892
g2
(lp74893
VThese kind of design decisions tend to make little sense until you've tried to make this work yourself
p74894
aVYour assignment: write asynchronous code and make it stop whenever you want to
p74895
aVYour constraints: you cannot use Thread
p74896
aVAbort() and can never cause deadlock
p74897
as(dp74898
g9
V17034
p74899
stp74900
a((dp74901
g2
(lp74902
VYou have to call the base class method to keep the original framework code working
p74903
aVFix:
p74904
aVYou've got a choice between calling the base class method first or last
p74905
aVWhile last is usually the right way, you are changing the button's state enough to warrant call the base class method first
p74906
aVIt depends
p74907
as(dp74908
g9
V17034
p74909
stp74910
a((dp74911
g2
(lp74912
VI suppose you selected a more strict rule set in the Analyze + Configure dialog
p74913
aVThe default is "Microsoft Mininum Recommended Rules"
p74914
as(dp74915
g9
V17034
p74916
stp74917
a((dp74918
g2
(lp74919
VChange the BackStyle property from "Transparent" to "Opaque"
p74920
aVClick around some more to see what effects the properties have, the designer support is pretty good
p74921
as(dp74922
g9
V17034
p74923
stp74924
a((dp74925
g2
(lp74926
VYou haven't accomplished anything, the UpdateInstruments() method still runs on the UI thread, just like it did before
p74927
aVNot so sure why you see such a long delay, that must be a large number of instruments
p74928
aVYou can possibly make it is less slow by first appending all of them into a StringBuilder, then append its ToString() value to the TextBox
p74929
aVThat cuts out the fairly expensive Windows call
p74930
as(dp74931
g9
V17034
p74932
stp74933
a((dp74934
g2
(lp74935
VThe With keyword has nothing to do with IDisposable or the Using keyword
p74936
aVIt is just a handy short-cut to avoid having to type the name of the object reference
p74937
aVWhich is the same as:
p74938
aVSince FileInfo doesn't implement IDisposable, you otherwise do not have any use for Using
p74939
aVDo avoid assuming that With takes care of disposing the object reference used in the With statement
p74940
aVIt doesn't
p74941
aVDoes kinda make sense that it would but a good 15+ years of it being around stops the VB
p74942
aVNET team from altering its behavior so dramatically
p74943
aVIt was never more than a short-cut to type less code
p74944
aVFeatured pretty heavily in the "Why doesn't C# has the with keyword" questions of yore
p74945
aVHot potato in the early days of C# but it hasn't been for a while now
p74946
as(dp74947
g9
V17034
p74948
stp74949
a((dp74950
g2
(lp74951
VIt is best to put the control on the form in the constructor
p74952
aVThat way the ActiveX control is properly initialized by the time the Load event runs
p74953
aVYou can probably fix this right now by moving the ax_DSN property assignment after the Controls
p74954
aVAdd() call
p74955
aVNote that the OcxState assignment is going to break sooner or later as well, you cannot leave it the way it is
p74956
aVLooks to me you originally had this control placed on the form with the designer, then moved the code out of InitializeComponent()
p74957
aVAvoid that, it causes more trouble then it solves
p74958
as(dp74959
g9
V17034
p74960
stp74961
a((dp74962
g2
(lp74963
VIt causes the file data that's buffered in the file system cache to be written to disk
p74964
aVThat data is normally lazily written, based on the position of the disk write head
p74965
aVHaving a gigabyte of cached data is technically possible so it can take quite a while
p74966
aVIf this is important to you then consider the  option instead
p74967
aVIt disables write caching completely
p74968
aVThis can be very expensive; you'll discover how slow hard disks really are
p74969
as(dp74970
g9
V17034
p74971
stp74972
a((dp74973
g2
(lp74974
VIn the Output window, change the "Show output from" combo to Debug if necessary
p74975
aVRight-click the window and tick "Module load messages"
p74976
aVAnd any others you might want to see
p74977
as(dp74978
g9
V17034
p74979
stp74980
a((dp74981
g2
(lp74982
VYou are not using the using keyword appropriately here
p74983
aVAfter the Register() call, the server will be immediately disposed
p74984
aVWhich does indeed make it pretty unlikely that it will still be alive by the time the Load event runs
p74985
aVMake the server variable a field in your form class
p74986
aVDon't dispose it until the form is closed, do so in the OnFormClosed() method override or FormClosed event handler
p74987
as(dp74988
g9
V17034
p74989
stp74990
a((dp74991
g2
(lp74992
VYou need a Timer
p74993
aVIn the Tick event handler calculate a new position for the object and call the panel's Invalidate() method so it gets repainted
p74994
aVYou can use a PictureBox instead of a Panel if the flicker is getting too noticeable
p74995
aVWork on the ArrayList as well
p74996
aVThis needs to become a  where the Ball class stores the position as well as the velocity vector
p74997
aVPlus whatever other properties you'll add in the future like color or radius
p74998
as(dp74999
g9
V17034
p75000
stp75001
a((dp75002
g2
(lp75003
VThat's a very fishy cast, it should never be necessary
p75004
aVThis problem is otherwise explained by a borked window procedure
p75005
aVYou didn't post it
p75006
aVStart by deleting the cast and solve any compile error you get
p75007
aVMake sure that it always calls DefWindowProc() for messages you don't process yourself
p75008
aVConsider using the boilerplate code you get from selecting the Win32 Project project template to get these details right
p75009
as(dp75010
g9
V17034
p75011
stp75012
a((dp75013
g2
(lp75014
VJust don't use Debug + Break All
p75015
aVIt is typically useless anyway because it is pretty unlikely that you'll break your own code
p75016
aVWhich is what the window is telling you
p75017
aVSet a breakpoint on a line of your own code, the code you want to debug or verify
p75018
aVClicking in the left margin will set one
p75019
as(dp75020
g9
V17034
p75021
stp75022
a((dp75023
g2
(lp75024
VThat's a problem, the Validating event will only be raised when btnFinish loses focus
p75025
aVWhich isn't very appropriate since this code should run when the check box controls change state
p75026
aVWorse, it will never happen when the button is disabled since that prevents it from getting the focus
p75027
aVWhich is why you couldn't make it work
p75028
aVYou'll need to have this code called by all of the check box controls' CheckedChanged event handlers
p75029
aVJust as an alternative, you can also run these kind of state update methods from the Application
p75030
aVIdle event
p75031
aVSaves you from having to write a bunch of event handling code
p75032
aVBut at a cost of doing some unnecessary work
p75033
aVDoesn't matter because it is cheap and runs when no other work needs to be done
p75034
as(dp75035
g9
V17034
p75036
stp75037
a((dp75038
g2
(lp75039
VIt is SpeechVoiceEvents
p75040
aVSVEPhoneme
p75041
aVThis is all a lot easier if you make this code early bound:
p75042
aVOr better yet, use the
p75043
aVNET wrapper for the sapi, System
p75044
aVSpeech assembly
p75045
as(dp75046
g9
V17034
p75047
stp75048
a((dp75049
g2
(lp75050
VThis is very subjective
p75051
aVVBA has a bad reputation but that's only because it was designed to be a very accessible scripting language for programmers that didn't have a lot of skill
p75052
aVThe ultimate irony of using a language like that for a big project is that it takes a very skilled programmer to not let it spiral out of control
p75053
aVLike somebody that understands what you have to do from the get-go when the language doesn't support namespaces, you'd better come up with a very good naming convention from the start
p75054
aVI can guess why you are asking this question
p75055
aVAnd the answer is that it is extremely difficult to throw away years of work just because the language isn't appealing
p75056
aVThe lodestone for this is Netscape version 6
p75057
aV0, well covered by Spolsky's "Things You Should Never Do"
p75058
aVThe best cure for discovering that you work for an employer that has brown-field products is to find another one
p75059
as(dp75060
g9
V17034
p75061
stp75062
a((dp75063
g2
(lp75064
VThis is a well-known problem with the XP visual style implementation for the native tab control, only tabs aligned to the top render properly
p75065
aVThis bug hasn't been addressed until Windows 7
p75066
aVThe workaround is to selectively turn off the style
p75067
aVAdd a new class to your project and paste the code shown below
p75068
aVCompile
p75069
aVDrop the new control from the top of the toolbox onto your form and change the Alignment property to your liking
p75070
aVIt isn't going to look prettier than that
p75071
as(dp75072
g9
V17034
p75073
stp75074
a((dp75075
g2
(lp75076
VAny of the methods you find back with Reflector or the Reference Source that have the MethodImplOptions
p75077
aVInternalCall attribute are actually implemented in C++ inside the CLR
p75078
aVYou can get the source code for these from the SSCLI20 distribution
p75079
aVThe relevant file is clr/src/vm/ecall
p75080
aVcpp, it contains a table of method names with function pointers, used by the JIT compiler to directly embed the call address into the generated machine code
p75081
aVThe relevant table section is
p75082
aVWhich takes you to clr/src/classlibnative/float/comfloat
p75083
aVcpp
p75084
aVIt just calls the CRT function
p75085
aVBut that's not what happens in the x86 jitter, note the 'intrinsic' in the table declaration
p75086
aVYou won't find that in the SSLI20 version of the jitter, it is a simple one unencumbered by patents
p75087
aVThe shipping one however does turn it into an intrinsic:
p75088
aVtranslates to
p75089
aVIn other words, Math
p75090
aVSqrt() translates to a single floating point machine code instruction
p75091
aVCheck this answer for details on how that beats native code handily
p75092
as(dp75093
g9
V17034
p75094
stp75095
a((dp75096
g2
(lp75097
VYou are on the wrong track with this, Tessnet already is a managed class wrapper around Tesseract
p75098
aVYou don't use [DllImport], just add a reference to the assembly and use the classes directly
p75099
aVSample code and assembly download is available here
p75100
as(dp75101
g9
V17034
p75102
stp75103
a((dp75104
g2
(lp75105
VThat's a bug, you call the setter again
p75106
aVThis will crash the designer with a stack overflow as soon as you put the control on a form
p75107
aVFix:
p75108
aVYou must also apply the attribute on the property, not the getter
p75109
as(dp75110
g9
V17034
p75111
stp75112
a((dp75113
g2
(lp75114
VYou have to declare the argument as StringBuilder, don't use out
p75115
aVBe sure to initialize the string builder you pass properly, you have to set its Capacity high enough so that this native code cannot destroy the garbage collected heap
p75116
aVFixing the COM code would be something to consider since it is so fundamentally unsafe, it really should use a BSTR
p75117
as(dp75118
g9
V17034
p75119
stp75120
a((dp75121
g2
(lp75122
VThis is a nasty problem induced by the Windows wow64 emulation layer that allows 32-bit code to run on the 64-bit version of Windows
p75123
aVIt swallows exceptions in the code that triggers the  event
p75124
aVPreventing the debugger from seeing it and stepping in
p75125
aVThis is apparently hard to fix, the Windows and DevDiv groups at Microsoft are pointing fingers back and forth
p75126
aVDevDiv can't do anything about it, Windows thinks it is the correct behavior, mysteriously as that sounds
p75127
aVIt is only a problem with a debugger attached, your code will bomb as usual without one
p75128
aVProject + Properties, Build tab, change Platform target to AnyCPU
p75129
aVThe unfortunately disables  Edit + Continue and might not always be possible when you have a dependency on 32-bit code
p75130
aVOther possible workarounds:
p75131
aVDebug + Exceptions, tick the Thrown box for CLR exceptions
p75132
aVWrite try/catch in the  event handler
p75133
aVUse  in the  method so that the exception trap in the message loop isn't disabled in debug mode
p75134
aVThis setting however makes all unhandled exceptions hard to debug, the  event is pretty useless
p75135
aVConsider if your code really belongs in the  event handler
p75136
aVIt is very rare to need it, it is however popular with VB6 programmers where  was a big deal
p75137
aVYou only ever need  when you are interested in the actual window size after user preferences and autoscaling is applied
p75138
aVEverything else belongs in the constructor
p75139
aVUpdate to Windows 8, it doesn't have this problem
p75140
aVA good write-up about this problem is available in this blog post
p75141
as(dp75142
g9
V17034
p75143
stp75144
a((dp75145
g2
(lp75146
VC++/CLI works different from any other managed language
p75147
aVYou don't explicitly implement IDisposable, just adding the destructor is enough to coax the compiler into adding IDisposable to the inheritance list
p75148
aVYou dispose them just like normal in C# by calling Dispose() on the object
p75149
aVIf the ref class object is a member of the C# class then it in turn needs to implement IDisposable and simply dispose the object in its Dispose() implementation
p75150
aVUnlike a C# class, you need to implement the finalizer in your C++/CLI ref class as well since you cannot enforce the client code to call Dispose()
p75151
aVYou really do manage an unmanaged resource, the native class object pointer
p75152
as(dp75153
g9
V17034
p75154
stp75155
a((dp75156
g2
(lp75157
VYou can't make this work the way you describe
p75158
aVIf there is nobody listening to the event then there is no way to respond to it
p75159
aVTrivially solve your problem by starting the
p75160
aVNET app with a shortcut in the Startup folder so it always runs while a user is logged-in
p75161
aVYou don't have to create a window until you get the notification from the server
p75162
aVStealing the focus away isn't going to work btw so you'll probably want a NotifyIcon with a balloon
p75163
as(dp75164
g9
V17034
p75165
stp75166
a((dp75167
g2
(lp75168
VYes, this doesn't work
p75169
aVThe registry-free COM manifest needs to be embedded in the EXE that uses the COM server
p75170
aVEasy enough for your console app
p75171
aVNot easy when you use NUnit because the EXE is now the unit test runner
p75172
aVYou can't/shouldn't mess with it
p75173
aVHard to do anyway because there are a bunch of them
p75174
aVJust don't bother, this is a deployment detail that's not relevant for the testing you want to do
p75175
aVJust register the server with regsvr32
p75176
aVexe on the machine that executes the tests and be done with it
p75177
as(dp75178
g9
V17034
p75179
stp75180
a((dp75181
g2
(lp75182
VYou are looking at the wrong memory statistic
p75183
aVThat's "working set", the amount of virtual memory that's mapped to physical memory
p75184
aVRAM
p75185
aVWindows aggressively trims the working set when it detects the main window getting minimized
p75186
aVIt assumes the user won't be using the program for a while so it unmaps pages from RAM to make room for other processes
p75187
aVWhen you give it the focus back, Windows only maps pages back to RAM that are actually needed
p75188
aVWhich isn't many of them when the app is otherwise idle
p75189
aVGarbage collection is a virtual memory operation
p75190
as(dp75191
g9
V17034
p75192
stp75193
a((dp75194
g2
(lp75195
VSomebody edited your question, fixing your mistake by accident
p75196
aVUse double backslashes or put a @ in front of the string
p75197
as(dp75198
g9
V17034
p75199
stp75200
a((dp75201
g2
(lp75202
VSet the AutoScroll property to True
p75203
aVMake sure that the default rows that get added by the designer do not cause any trouble
p75204
aVMake your constructor look like this:
p75205
as(dp75206
g9
V17034
p75207
stp75208
a((dp75209
g2
(lp75210
VYou are going to have to convert the string to a ConsoleColor
p75211
aVLike this:
p75212
aVNot the greatest solution, the French won't understand why "Blanc" doesn't work
p75213
as(dp75214
g9
V17034
p75215
stp75216
a((dp75217
g2
(lp75218
VYou can catch AVs with the __try and __except keywords in the MSVC compiler
p75219
aVNot all that useful, you have no idea what kind of damage was done
p75220
aVThe state of your program might well be corrupted
p75221
aVThe heap might be blown for example, causing subsequent random failure
p75222
aVHosting the DLL in its own process and using IPC to talk to it is the only decent approach
p75223
as(dp75224
g9
V17034
p75225
stp75226
a((dp75227
g2
(lp75228
VYou are hardcoding the property value
p75229
aVSo assign the value in the constructor, make it non-browsable so it won't show up in the properties window and ensure that the value cannot be changed and doesn't get serialized
p75230
aVLike this:
p75231
as(dp75232
g9
V17034
p75233
stp75234
a((dp75235
g2
(lp75236
VYou have to be talking about the old
p75237
aVcom MS-Dos executable file format
p75238
aVNo, they run in a virtual machine implemented by ntvdm
p75239
aVexe
p75240
aVIt takes advantage of virtual 8086 mode, implemented by the processor
p75241
aVAn execution mode that emulates a 16-bit 8086 processor
p75242
aVFollow the link to learn more about it
p75243
as(dp75244
g9
V17034
p75245
stp75246
a((dp75247
g2
(lp75248
VUse SHChangeNotify()
p75249
aVNot actually sure which wEventId you'd use in this particular case
p75250
aVStart with SHCNE_ALLEVENTS
p75251
as(dp75252
g9
V17034
p75253
stp75254
a((dp75255
g2
(lp75256
VThe classic mistake is forgetting to turn the handshake signals on, either by enabling hardware handshake or by setting the SerialPort
p75257
aVDtrEnable and RtsEnable properties to true
p75258
aVSerial port devices should ignore anything until they detect the other end powered up and ready to receive
p75259
aVLess likely is that the microcontroller isn't responding fast enough to received bytes
p75260
aVEither because it is slow to respond to the interrupt or is using polling
p75261
aVThat can cause a receiver overrun error with loss of the received byte
p75262
aVLowering the baudrate would fix that
p75263
as(dp75264
g9
V17034
p75265
stp75266
a((dp75267
g2
(lp75268
VPut this in your BGW worker loop, after the ReportProgress call:
p75269
aVOdds are good that you now see the ListView updating
p75270
aVWhat's going on here is that the UI thread is getting flooded with delegate invoke requests
p75271
aVWhich always get dispatched before the paint notification
p75272
aVIf the next invoke request arrives before the previous one has finished running then it never gets around to doing the normal housekeeping tasks
p75273
aVLike painting and responding to input
p75274
aVThe items actually do get added to the list view, you just can't see it being done
p75275
aVCall ReportProgress less often
p75276
aVDoing it more than 25 times per second is a waste of resources, no human can see the difference
p75277
aVLet the BGW store the items in a List<> and cut down on the UI thread overhead by calling AddRange()
p75278
as(dp75279
g9
V17034
p75280
stp75281
a((dp75282
g2
(lp75283
VYour program bombs because you abort the thread but do not take care of the window
p75284
aVIt is liable to try to run code because of a Windows notification, that will nosedive on ThreadStateException because the thread is aborted
p75285
aVYou simply cannot end the thread by aborting it
p75286
aVHere's a general class to solve this problem, it takes care of shutting down the waiting form and the thread cleanly
p75287
aVSample usage:
p75288
as(dp75289
g9
V17034
p75290
stp75291
a((dp75292
g2
(lp75293
VYou can only get 100% wall time if
p75294
aVyour machine has at least as many cores as you have threads
p75295
aVa thread does nothing but burn cpu cycles and never gets blocked by a synchronization object (like lock) or an I/O request
p75296
aVNeither is very likely, few problems scale well
p75297
aVAmdahl's law is relevant
p75298
as(dp75299
g9
V17034
p75300
stp75301
a((dp75302
g2
(lp75303
VWell, just delete the InitializeComponent() call in the constructor and the designer generated code is out of your hair
p75304
as(dp75305
g9
V17034
p75306
stp75307
a((dp75308
g2
(lp75309
VYou've got a pretty big problem if CodeScannedEventHandler runs again before the previous one has finished running
p75310
aVSerialPort does not do this btw, its DataReceived event is serialized
p75311
aVA lock cannot reliably solve this problem, the order in which threads acquire the lock isn't guaranteed
p75312
aVWhich is what you see happening, there's a lock inside Debug
p75313
aVWriteLine()
p75314
aVIf the sequence is really important then all you can do is keep the event handler as short and snappy as possible so it always takes less time than the rate at which the events run
p75315
aVQuickly store the scan result in a thread-safe queue and get out
p75316
aVYou need another thread that empties the queue
p75317
aVIt is still not a 100% guarantee, you'll need help from whomever wrote MyOpticalScanner to get that guarantee
p75318
as(dp75319
g9
V17034
p75320
stp75321
a((dp75322
g2
(lp75323
VSure
p75324
aVWe wouldn't have to cope with deadlock if that wasn't the case
p75325
aVThe scenario is that the blocked thread acquired a synchronization object that another thread tries to acquire as well
p75326
aVIt will block
p75327
aVOkay, I get the question now
p75328
aVGenerally, yes
p75329
aVSome other code needs to run to release the blocking condition
p75330
aVThe non-obvious cases are kernel threads that run code in drivers if the thread is blocked on I/O
p75331
aVOr the thread scheduler, in case the thread is blocked because it is waiting to acquire the processor or is waiting with a non-infinite time-out
p75332
as(dp75333
g9
V17034
p75334
stp75335
a((dp75336
g2
(lp75337
VThese properties only exist in the Properties Window, magic provided by the IExtenderProvider interface
p75338
aVThey don't exist at runtime
p75339
aVExtended properties are:
p75340
aVColumnSpan
p75341
aVRuntime: GetColumnSpan() and SetColumnSpan()
p75342
aVRowSpan
p75343
aVRuntime: GetRowSpan() and SetRowSpan()
p75344
aVRow
p75345
aVRuntime: GetRow() and SetRow()
p75346
aVCell
p75347
aVRuntime: GetCellPosition() and SetCellPosition()
p75348
aVColumn
p75349
aVRuntime: GetColumn() and SetColumn()
p75350
aVObviously TLP was highly optimized to be used from the designer
p75351
aVIt's kinda of a pain at runtime
p75352
as(dp75353
g9
V17034
p75354
stp75355
a((dp75356
g2
(lp75357
VThat's a problem
p75358
aVAfter swapping the bytes, the value is no longer a proper double
p75359
aVStoring it back to a double is going to cause subtle problems when the FPU normalizes the value
p75360
aVYou have to store it back into an __int64 (long long)
p75361
aVModify the return type of the method
p75362
as(dp75363
g9
V17034
p75364
stp75365
a((dp75366
g2
(lp75367
VYou don't often need a wrapper, many DLLs with straight-forward exported C functions can be pinvoked with the [DllImport] attribute
p75368
aVAn exception for C exports would be a poorly designed DLL that requires the client code to release memory, that can't be done by the managed code since it doesn't have access to the allocator
p75369
aVThe case where you have to have a wrapper is a native C++ class
p75370
aVManaged code cannot pinvoke it directly since it doesn't know how to create an instance of the class (which requires knowing the size of the object and calling the constructor) nor how to destroy it (which requires calling the destructor)
p75371
aVIt is pretty easy to do in C++/CLI
p75372
aVVery mechanical, the SWIG project can do it automatically
p75373
aVLearning that tool is however more of an investment than learning how to write the wrapper
p75374
as(dp75375
g9
V17034
p75376
stp75377
a((dp75378
g2
(lp75379
VThese are the kind of configuration names you get for an ATL project, back in the Visual Studio 6 days
p75380
aVThe names hint at the selected settings:
p75381
aVMinDependency - embeds ATL in the final binary instead of relying on atl
p75382
aVdll
p75383
aVMinSize - uses the "Minimize size" optimizer option, instead of "Maximize speed"
p75384
aVUnicode - makes all strings utf-16, matching the operating system use
p75385
aVThis kind of fine-grained control doesn't make make sense anymore these days
p75386
aVUnicode should always be your choice, especially for ATL
p75387
aVYou'll want to embed ATL, size is pretty irrelevant today
p75388
aVThe optimizer setting is "Maximize speed" these days, /O2 in VS2008
p75389
as(dp75390
g9
V17034
p75391
stp75392
a((dp75393
g2
(lp75394
VThe proper way is to retrieve the DefaultItemAttribute for the class
p75395
aVIt has the name of the indexer property
p75396
aVIt doesn't have to be "Item", languages like VB
p75397
aVNET allows specifying any property to be the indexer
p75398
aVJason's code will also fail on them, there can be more than one indexed property
p75399
aVBut only one default
p75400
as(dp75401
g9
V17034
p75402
stp75403
a((dp75404
g2
(lp75405
VOnly by using Debug + Exceptions, Thrown checkbox
p75406
aVThat makes the debugger stop on the "first chance"
p75407
aVAt the point the exception is thrown
p75408
aVYou typically want to do this:
p75409
aVNote that this already works that way for Application
p75410
aVThreadException, Winforms already avoids catching exceptions if it sees a debugger
p75411
aVFor the exact same reason
p75412
as(dp75413
g9
V17034
p75414
stp75415
a((dp75416
g2
(lp75417
VGetting asynchronous code to execute on a specific thread requires a synchronization provider
p75418
aVThere are two main ones in the
p75419
aVNET framework, WindowsFormsSynchronizationContext which helps Control
p75420
aVBeginInvoke() to run code on the UI thread
p75421
aVAnd DispatcherSynchronizationContext, supporting Dispatcher
p75422
aVBeginInvoke() for WPF
p75423
aVThese providers are automatically installed when you call Application
p75424
aVRun() for these class libraries
p75425
aVThey can only invoke to the UI thread
p75426
aVThere is no sync provider for a console mode program
p75427
aVAnd a delegate's BeginInvoke() method always executes on a threadpool thread
p75428
aVIf you cannot use these class libraries and the component you use has no support for multi-threading (very few do, unless it is a COM server) then using threading is not an option available to you
p75429
as(dp75430
g9
V17034
p75431
stp75432
a((dp75433
g2
(lp75434
VThis happens because of the way the JIT compiler works
p75435
aVIt needs to generate the code for the Main() method before it can start to run
p75436
aVSince you are referencing the ClassLibrary1
p75437
aVClass1() type, it needs to load that assembly to retrieve type info
p75438
aVThat requires it to load the assembly before your code starts running
p75439
aVChange it like this to get the exception:
p75440
aVNow the static constructor can run first and register the AssemblyLoad event handler before the ClassLibrary1 assembly gets loaded
p75441
as(dp75442
g9
V17034
p75443
stp75444
a((dp75445
g2
(lp75446
VYou just can't this info in CF, GetAvailableThreads isn't supported
p75447
aVYes, frequent and fast is best done with the ThreadPool instead of trying to manage it yourself
p75448
as(dp75449
g9
V17034
p75450
stp75451
a((dp75452
g2
(lp75453
VUse one of the interprocess communication mechanisms to have app1
p75454
aVexe talk to app2
p75455
aVexe
p75456
aVSockets, named pipes, Remoting, WCF
p75457
aVSince you only need to pass a command line, a simple socket can get the job done
p75458
aVJust exit app1
p75459
aVexe when you get a message back from app2
p75460
aVexe that the job was done, no need to kill anything
p75461
as(dp75462
g9
V17034
p75463
stp75464
a((dp75465
g2
(lp75466
VNot so sure how you made that work
p75467
aVThe sender is the menu item, not the picture box
p75468
aVIf this actually works then you already have the reference to the picture box you want to tinker with
p75469
aVIt's Origin
p75470
aVNo need for the switch statement
p75471
aVAnother way that works is to use the Opening event:
p75472
aVAnd you can now use currentBox in any of the menu item Click event handlers
p75473
aVIt works because there can be only one menu open at the same time
p75474
as(dp75475
g9
V17034
p75476
stp75477
a((dp75478
g2
(lp75479
VUse the Show(owner) overload to get form B on top of A
p75480
aVYou'll need to set the size and location in the Load event so you can be sure it is exactly the right size even after scaling
p75481
aVAnd listen for the LocationChanged event so you can move the bottom form as well
p75482
aVThis works well, other than a few interesting minimizing effects on Win7
p75483
as(dp75484
g9
V17034
p75485
stp75486
a((dp75487
g2
(lp75488
VFileStream writes bytes, StreamWriter writes text
p75489
aVThat's all
p75490
as(dp75491
g9
V17034
p75492
stp75493
a((dp75494
g2
(lp75495
VIt is the OpenGL driver for your NVidia video card
p75496
aVYes, you're not going to get the
p75497
aVpdb from Microsoft, they didn't write it
p75498
aVGetting it from NVidia is very unlikely
p75499
aVThis is not software you want to debug anyway
p75500
as(dp75501
g9
V17034
p75502
stp75503
a((dp75504
g2
(lp75505
VNotice the complete absence of the word "error"
p75506
aVIt is not an error, just a notification from the debugger that a DLL got loaded
p75507
aVDo not mess with the file, you'll break Visual Studio
p75508
aVIf you don't want to see the message then right-click the Output window and untick "Load messages"
p75509
as(dp75510
g9
V17034
p75511
stp75512
a((dp75513
g2
(lp75514
VMMX is an integer instruction set, not floating point
p75515
aVIt only supports 64-bit packed byte, word and double-word integers
p75516
aVSSE has floating point support
p75517
aVUse #pragma managed in your code to switch between machine code and MSIL generation
p75518
as(dp75519
g9
V17034
p75520
stp75521
a((dp75522
g2
(lp75523
VThis cannot be a real problem, the user typed in the text herself a minute ago
p75524
aVShe knows that the text got clipped
p75525
aVDo make sure that you don't use a TextBox to display text yourself
p75526
aVThat requires a Label
p75527
aVAnd it has the AutoEllipsis property to automatically display
p75528
aVif the text doesn't fit the MaximumSize of the label
p75529
aVAnd an automatic tooltip to display the rest
p75530
as(dp75531
g9
V17034
p75532
stp75533
a((dp75534
g2
(lp75535
VThe typical problem is that the other process has the file open for writing
p75536
aVAll of the standard File methods and StreamReader constructors open the file with FileShare
p75537
aVRead
p75538
aVThat cannot work, that denies write sharing
p75539
aVYou cannot deny writing, the other process was first and got write access
p75540
aVYou have to use FileShare
p75541
aVReadWrite, like this:
p75542
aVBeware that you'll still have a tricky problem, you are reading a half-written file
p75543
aVThe other process flushes data to the file at random points in time, you may well read only half a line of text
p75544
aVYMMV
p75545
as(dp75546
g9
V17034
p75547
stp75548
a((dp75549
g2
(lp75550
VThere's a hidden Range interface pointer that you can't see, the Cells property returns it
p75551
aVYou then apply the indexer expression to it, dereferencing the default Item property of that Range
p75552
aVTo get another Range
p75553
aVThis is why it is such a bad, bad idea to try to manage COM interface pointers yourself
p75554
aVTrust the garbage collector to always get it right
p75555
aVGC
p75556
aVCollect() and GC
p75557
aVWaitForPendingFinalizers() if you really, really want to make it quit on demand
p75558
as(dp75559
g9
V17034
p75560
stp75561
a((dp75562
g2
(lp75563
VYou didn't specify the image file format
p75564
aVThe default is PNG, not BMP
p75565
aVYou now probably have a
p75566
aVbmp file on disk that actually contains a PNG image
p75567
aVThat can go undetected for quite a while, lots of graphics programs pay attention to the file header instead of the file name extension
p75568
aVMSPaint for example will have no trouble loading the file
p75569
aVJust like any other program that uses GDI+
p75570
aVYou might not be so lucky with a program that blindly assumes that the file contains a BMP and does no checking at all
p75571
aVFix:
p75572
as(dp75573
g9
V17034
p75574
stp75575
a((dp75576
g2
(lp75577
VWinforms doesn't support AppDomains
p75578
aVIt bombs because the form won't close
p75579
aVIt doesn't even know it exists, it is in another AD
p75580
aVDon't try to make this work, only create forms in the default domain
p75581
as(dp75582
g9
V17034
p75583
stp75584
a((dp75585
g2
(lp75586
VThere's a comment left in the source code for TabPage by an exasperated Microsoft programmer (edited to fit the page):
p75587
aVVisual Styles have been a major bug factory, particularly so for TabControl
p75588
aVCheck this answer for a way to selectively turn it off for the TabControl so you'll get the behavior you are used to
p75589
aVOf course it does change the appearance
p75590
as(dp75591
g9
V17034
p75592
stp75593
a((dp75594
g2
(lp75595
VYour project settings are wrong
p75596
aVSpecifically Configuration Properties, General, Common Language Runtime support
p75597
aVFall in the pit of success by starting your project by picking one of the project templates in the CLR node
p75598
as(dp75599
g9
V17034
p75600
stp75601
a((dp75602
g2
(lp75603
VNo, accessing the metadata of the file isn't going to change the last access time (name, attributes, timestamps)
p75604
aVWouldn't work well in practice, just looking at the directory with Explorer would change it
p75605
aVYou have to actually open the file
p75606
aVExtractIconEx() would normally be an excellent candidate, except that Windows can play tricks with it
p75607
aVA hidden desktop
p75608
aVini file can redirect the icon to another file
p75609
aVUsing the last access time is pretty worthless for forensics
p75610
aVYou'd need a file system filter driver
p75611
aVSimilar to the one embedded in SysInternals' ProcMon utility
p75612
aVIt might be using ETW btw, that got pretty powerful at Vista time
p75613
aVNevertheless, your project just got 10 times more complicated
p75614
as(dp75615
g9
V17034
p75616
stp75617
a((dp75618
g2
(lp75619
VStart Taskmgr
p75620
aVexe, Processes tab
p75621
aVView + Select columns, tick "Page Fault Delta"
p75622
aVYou'll see the impact of allocating hundreds of megabytes, just to store the stacks of all these threads you created
p75623
aVEvery time that number blips for your process, your program blocks waiting for the operating system paging in data from the disk into RAM
p75624
aVTANSTAAFL, There ain't no such thing as a free lunch
p75625
as(dp75626
g9
V17034
p75627
stp75628
a((dp75629
g2
(lp75630
VYou can overload constructors
p75631
aVThe designer is going to require the default constructor at design time so be sure to supply that one as well
p75632
aVOf course, the client code has to create that user control itself
p75633
aVFavor properties to keep the user control useful in the designer
p75634
aVThrow an exception in OnLoad() if DesignMode is false and you're not happy about the way the client code used your control
p75635
as(dp75636
g9
V17034
p75637
stp75638
a((dp75639
g2
(lp75640
VThis comes from Berkeley, back when LSD was still legal
p75641
aVSo very obvious in their naming choices :/
p75642
aVAll kidding aside, this dates back to very early K&R; C where structure members didn't have their own namespace
p75643
aVWhich required you to come up with distinct names for the structure members that wouldn't collide with identifiers in the global namespace
p75644
aVPainful
p75645
aVPrefixing the names with an abbreviation of the structure name was the common approach
p75646
aVThus "sockaddr_in" becomes "sin"
p75647
as(dp75648
g9
V17034
p75649
stp75650
a((dp75651
g2
(lp75652
VPut this at the top of the file:
p75653
aVYour declarations are wrong, this won't work on a 64-bit operating system
p75654
aVGet the right ones from the pinvoke
p75655
aVnet website
p75656
aVAlso add error checking, SetLastError property
p75657
as(dp75658
g9
V17034
p75659
stp75660
a((dp75661
g2
(lp75662
VApplication setting binding in the Properties window is only supported for Winforms projects, not WPF
p75663
as(dp75664
g9
V17034
p75665
stp75666
a((dp75667
g2
(lp75668
VNo
p75669
aVJust make your own
p75670
aVDerive a class from Control and override OnPaint() to draw the bar and the text
p75671
as(dp75672
g9
V17034
p75673
stp75674
a((dp75675
g2
(lp75676
VYou are doing something that the control users probably never did before
p75677
aVRuntime environments like VB6, the most common place where
p75678
aVocx are used, do not allow creating multiple STA threads
p75679
aVIt is pretty likely that the code inside the control contains global variables without any of the locking required to make that safe
p75680
aVRandom failure is the outcome
p75681
aVDitch it,
p75682
aVNET has excellent support for TCP with the System
p75683
aVNet namespace
p75684
aVSocket, TcpClient and TcpServer classes
p75685
as(dp75686
g9
V17034
p75687
stp75688
a((dp75689
g2
(lp75690
VYou have to prevent the keystroke from reaching the native control
p75691
aVSet e
p75692
aVHandled = true
p75693
as(dp75694
g9
V17034
p75695
stp75696
a((dp75697
g2
(lp75698
VThey are not environment variables
p75699
aVMacros is the name used in the MSDN literature
p75700
aVMaybe that makes sense if you realize that a solution can contain more than one project
p75701
aV$(ProjectDir) constantly changes as the build progresses
p75702
aVYou already know their values, $(ProjectDir) is the directory where you found the
p75703
aVvcproj file, $(SolutionDir) is the directory where you found the
p75704
aVsln file
p75705
aV(This sounds familiar)
p75706
as(dp75707
g9
V17034
p75708
stp75709
a((dp75710
g2
(lp75711
VNo, it's transparent
p75712
aVSee this by giving the form's BackgroundImage a value
p75713
aVYou'll see it through the transparent panel
p75714
aVOf course, that's not the kind of transparency you want, you want stacking effects to work
p75715
aVThere is no direct support for that
p75716
aVIf you want layers to work then don't use controls
p75717
aVUse the Paint event to draw
p75718
aVNow there's no problem, if you want transparency then just don't paint
p75719
aVDraw a line across an image simply by drawing the image first
p75720
aVThis is also the rendering model of WPF
p75721
as(dp75722
g9
V17034
p75723
stp75724
a((dp75725
g2
(lp75726
VThe file 'e:\u005cexcel
p75727
aVxls' exists
p75728
aVIt doesn't
p75729
aVMapped drive letters like E: are per-user
p75730
aVThe drive is valid only under your user account, the scheduled task is probably running using another account
p75731
aVInstead of tinkering with accounts, the best thing to do is to use a universal name
p75732
aVLike , that's valid for any account
p75733
aVAsk more questions about it at serverfault
p75734
aVcom
p75735
as(dp75736
g9
V17034
p75737
stp75738
a((dp75739
g2
(lp75740
VThe C# compiler doesn't use the [DefaultParameterValue] attribute to set the default value, it uses the
p75741
aVparam directive to get the value embedded in the metadata
p75742
aVBarely documented in the CLI spec btw, only Partition II, chapter 15
p75743
ag2588
aV1 mentions that it can have a FieldInit value, 15
p75744
ag2588
ag2582
aV4 is silent about it
p75745
aVThat's where the buck stops, the C++/CLI compiler doesn't know how to generate the directive
p75746
aVYou cannot make this work
p75747
as(dp75748
g9
V17034
p75749
stp75750
a((dp75751
g2
(lp75752
VThe WH_GETMESSAGE hook is a global hook
p75753
aVIt requires a DLL that can be injected into another process
p75754
aVThe hMod argument
p75755
aVThere's a problem, you can't write such a DLL in a managed language
p75756
aVThe target process won't have the CLR initialized
p75757
aVThere's a code project that offers such a DLL, maybe you can make it work
p75758
aVBlack belt required
p75759
as(dp75760
g9
V17034
p75761
stp75762
a((dp75763
g2
(lp75764
VFrom the MSDN Library article for RichTextBox
p75765
aVDrawToBitmap():
p75766
aVThis method is not relevant for this class
p75767
aVA crummy way to say that the native Windows richedit control doesn't support WM_PRINT
p75768
aVTaking a screen shot is an option, Novikov gave you a link to my answer
p75769
as(dp75770
g9
V17034
p75771
stp75772
a((dp75773
g2
(lp75774
VThe simple explanation is that the
p75775
aVmanifest file isn't being used
p75776
aVWhich is highly likely in this scenario, your
p75777
aVexe almost certainly already contains a manifest, embedded as a resource
p75778
aVVery common for a MFC app to enable visual styles
p75779
aVAnd for code compiled by the VS2005 or 2008 compilers which embeds a manifest to find the runtime DLLs
p75780
aVTo verify this, use File + Open + File and select the compiled
p75781
aVexe file
p75782
aVLook for the RT_MANIFEST node
p75783
aVIf Windows finds such an embedded manifest it isn't going to continue looking for a file-based one
p75784
aVYou need to merge your regfree COM entries into the embedded one
p75785
aVI wish I could give you a good MSDN Library link but the docs about manifests suck serious rock
p75786
as(dp75787
g9
V17034
p75788
stp75789
a((dp75790
g2
(lp75791
VIt is a JIT implementation detail
p75792
aVThe x86 jitter must setup 16 bytes in the stack frame to help the CLR find the proper catch block in case the exception is thrown
p75793
aVThat should take about 3 nanoseconds
p75794
aVNo work at all for the x64 jitter, exception filtering is implemented differently on the 64-bit version of Windows (table based instead of stack based)
p75795
aVThe extra memory required is about equivalent (code vs table data)
p75796
aVNone of this should ever matter with code like this, converting a string to an integer is an I/O operation
p75797
aVThe cost of getting the data in the first place is an easy 3 or 4 orders of magnitude larger than any parsing you do
p75798
aVAnd you'd of course use TryParse() if you don't trust the source of the data
p75799
aVProcessing an exception is quite expensive
p75800
as(dp75801
g9
V17034
p75802
stp75803
a((dp75804
g2
(lp75805
VYou have no such guarantee
p75806
aVThe exact time the RaisePropertyChanged() method runs greatly depends on the state of the UI thread
p75807
aVAnd if it just happens to be ready to look at the invoke queue for invoke targets to execute at the exact time your worker thread calls RaiseIfChanged and the worker thread loses it processor quantum then, yes, that call is going to be made before the worker can return and set the property value
p75808
aVUnlikely, but the road of good threading intentions is littered with roadkill like this
p75809
aVYou have to assign the property before raising the event
p75810
aVThe un-dry test-and-set is pretty simple
p75811
aVKeep dry but ugly by using PropertyInfo
p75812
aVSetValue() or passing the backing variable by reference
p75813
aVPersonally I wouldn't, using reflection to read the property value is an easy three orders of magnitude slower than just coding this directly
p75814
as(dp75815
g9
V17034
p75816
stp75817
a((dp75818
g2
(lp75819
VIt really is [Browsable]
p75820
aVOmitting the setter would be another way, that makes sense in this scenario
p75821
aVI'm guessing the real problem you have is an old copy of this control stored in the toolbox assembly folder
p75822
aVSuch a copy is made if you add the control to the toolbox yourself with Choose Items, Browse tab
p75823
aVYou might be updating your local copy but not the toolbox version
p75824
aVI need to wave my hands at this a bit, I know it can happen but never discovered how it happens
p75825
aVThis never went wrong for me personally, but I always make sure to let the toolbox auto-populate itself instead of adding the control explicitly
p75826
aVIf you did add it like this then start by removing it
p75827
aVRight-click the item in the toolbox and select Delete
p75828
aVThe copy is stored in c:\u005cusers\u005cyourname\u005cappdata\u005clocal\u005cmicrosoft\u005cvisualstudio\u005cx
p75829
aVx\u005cprojectassemblies
p75830
as(dp75831
g9
V17034
p75832
stp75833
a((dp75834
g2
(lp75835
VActive Directory programming requires COM, there is no lower level API
p75836
aVLooking for alternatives: there is no great advantage to using C++ when dealing with something like email
p75837
aVIt tends to work just as well from a scripting language, the bottleneck is not the language
p75838
aVUsing ADSI from a scripting language (or especially
p75839
aVNET) is quite easy, they have runtime environments that take care of the COM plumbing
p75840
aVThe twenty dollar solution: add the required config instead of trying to read it back from AD
p75841
as(dp75842
g9
V17034
p75843
stp75844
a((dp75845
g2
(lp75846
VA static
p75847
aVlib is not a valid target option for managed code
p75848
aVThere is no implemented mechanism to get the all-important metadata associated with managed types the same kind of treatment as code
p75849
aVIt cannot be carved up in bits in pieces and glued together again
p75850
aVThe MSFT team probably considered it but got scared away by the massive changes required to the
p75851
aVobj file format
p75852
aVThat's a guess
p75853
aVA good error message would have been nice
p75854
aVThat's a fact
p75855
aVYou must select a DLL as the target
p75856
aVAt runtime, the JIT compiler performs the same function as the linker, it only pulls code from the DLL assembly that is actually used by the client
p75857
as(dp75858
g9
V17034
p75859
stp75860
a((dp75861
g2
(lp75862
VSelect the ListView in the designer
p75863
aVClick the triangle at the upper right edge, Edit Columns, Add
p75864
aVRepeat as necessary for as many columns you want in the view
p75865
aVYou can drag the column splitters in the designer to get them to the right width
p75866
as(dp75867
g9
V17034
p75868
stp75869
a((dp75870
g2
(lp75871
VFormB can't find out, the buttons are a private implementation details of FormA
p75872
aVThey might not even be a button, surely you are going to add a menu or a toolbar to FormA some day
p75873
aVThe workaround becomes much simpler if you stop thinking of "calling a form"
p75874
aVYou never call a form, you create an instance of it
p75875
aVAnd then you make it visible by calling its Show() method
p75876
aVLots of things you can do in between those two steps
p75877
aVAdd a public method to FormB
p75878
aVFor lack of a better name:
p75879
aVNow it becomes simple
p75880
aVImplement button2's Click event handler like this:
p75881
aVAdding another constructor to a form that lets you initialize it differently is another very common approach
p75882
aVThese are just classes, standard programming techniques are appropriate
p75883
as(dp75884
g9
V17034
p75885
stp75886
a((dp75887
g2
(lp75888
VLots of red flags here
p75889
aVIt doesn't work because you didn't specify CallingConvention
p75890
aVCdecl
p75891
aVAnd the long arguments are int on the C# side
p75892
aVThat will take care of your original problem, everything should be passed correctly now
p75893
aVStart another question when the pointers cause an AccessViolation
p75894
as(dp75895
g9
V17034
p75896
stp75897
a((dp75898
g2
(lp75899
VIt looks to me like you're only guessing at where all this time is being burned
p75900
aV"Read from disk" would not be high on my list of candidates
p75901
aVLearn more about what's really going on
p75902
aVUse a decent profiler
p75903
as(dp75904
g9
V17034
p75905
stp75906
a((dp75907
g2
(lp75908
VThat's not possible, hard Windows rule
p75909
aVJust don't make the parent of the panel you want to show the panel you want to hide
p75910
aVIt should be parented to the form instead
p75911
aVThe designer doesn't make that easy, you'll have to move it to the right spot after the InitializeComponent() call
p75912
as(dp75913
g9
V17034
p75914
stp75915
a((dp75916
g2
(lp75917
VSupport for flat scrollbars has been removed from the Windows common controls version 6
p75918
aVIt is only available in the legacy version
p75919
aVWhich means you cannot have visual styles at the same time as flat scrollbars
p75920
aVGoogle InitializeFlatSB, you might find somebody that thought the flat bars were more important
p75921
aVI rather doubt it
p75922
as(dp75923
g9
V17034
p75924
stp75925
a((dp75926
g2
(lp75927
VYes, this will happen when you changed the list view's TileSize property and your program runs on a machine with a higher video DPI setting
p75928
aVThat will make the fonts bigger
p75929
aVCausing the text to no longer fit the tile
p75930
aVEverything else is taken care of by the automatic scaling built into the Form class
p75931
aVYou should scale the tile size, making it bigger so that the text fits again
p75932
aVMake it look similar to this:
p75933
aVThis assumes that you designed the form on a machine that has the default 96 dots per inch setting
p75934
aVLeave a bit of slack in the original tile size, the scaling isn't perfect due to TrueType hinting
p75935
as(dp75936
g9
V17034
p75937
stp75938
a((dp75939
g2
(lp75940
VMicrosoft (R) Visual C# 2008 Compiler version 3
p75941
ag2447
aV21022
p75942
ag9173
aVThat's old, original
p75943
aVNET 3
p75944
aV5 release
p75945
aVService Pack 1 has a rather unfortunate name, there were a great many changes
p75946
aVI don't have the time machine to check if it added the MacOSX member
p75947
aVTiming is about right for coinciding with Silverlight
p75948
aVEnable Windows Update or install SP1 directly
p75949
as(dp75950
g9
V17034
p75951
stp75952
a((dp75953
g2
(lp75954
VThe amount of Windows resources of a specific type that a process could allocate is technically only restricted by the amount of virtual memory available to a process
p75955
aVWhich can be a rather large number, especially on the 64-bit version of Windows
p75956
aVSome of these resources are withdrawn from an internal heap from which all other processes withdraw as well
p75957
aVStill a very large number if Windows would let one process consume it all
p75958
aVWhich of course doesn't make sense, a process should never be allowed to gobble up all available resources
p75959
aVWhich is what a quota does, it sets an upper limit to the counted number of resources of a certain type
p75960
aVCommon examples are 10,000 windows, 10,000 GDI objects, 10,000 handles
p75961
aVNot all of them are nice round numbers like this btw
p75962
aVIt would take knowing more about what your PostMessage() call does, but a reasonable guess is that it is pushing the message queue size past the quota
p75963
aVAgain, a resource that's technically only limited to the size of available virtual memory
p75964
aVBut practically should stay well south of that
p75965
aVIf accurate, you are posting messages faster than they can be consumed, throttling is required
p75966
aVThat this happens at the exact time your program is terminating suggests another explanation might be necessary
p75967
aVA thread shutdown order problem, maybe
p75968
as(dp75969
g9
V17034
p75970
stp75971
a((dp75972
g2
(lp75973
VThis is an error code that's specific to the component
p75974
aVIf you don't have documentation that explains what the code might mean then you'll need support from the vendor
p75975
as(dp75976
g9
V17034
p75977
stp75978
a((dp75979
g2
(lp75980
VThe reason it works when you rebuild with VS is because it runs Regasm
p75981
aVexe with the /codebase option
p75982
aVRequired if you don't plan to put the assembly in the GAC
p75983
as(dp75984
g9
V17034
p75985
stp75986
a((dp75987
g2
(lp75988
VThe most serious consequence is a thread that's waiting for the mutex getting unblocked
p75989
aVThe WaitXxx call returns WAIT_ABANDONED
p75990
aVAt which point it would be a really good idea to call TerminateProcess because you have no idea what the hell just happened
p75991
as(dp75992
g9
V17034
p75993
stp75994
a((dp75995
g2
(lp75996
VPInvokeStackImbalance is not an exception
p75997
aVIt is an MDA warning, implemented by a Managed Debugging Assistant
p75998
aVHaving that MDA active is optional, you can configure that from the Debug + Exceptions dialog
p75999
aVIt will never be active when you run without a debugger
p76000
aVGetting the stack imbalanced can cause pretty nasty problems, ranging from strange data corruption to getting SOE or AVE
p76001
aVVery hard to diagnose too
p76002
aVBut it can also cause no trouble at all, the stack pointer gets restored when the method returns
p76003
aVCode compiled to 64-bit tends to be resilient, a lot more of the function arguments get passed through registers instead of the stack
p76004
aVIt will fail when forced to run on x86, the new default for VS2010
p76005
as(dp76006
g9
V17034
p76007
stp76008
a((dp76009
g2
(lp76010
VCalling the base
p76011
aVOnFormClosing() method is a very hard requirement, the FormClosing event isn't going to run otherwise
p76012
aVWhether to do so if you already set e
p76013
aVCancel to true is a judgment call
p76014
aVShould a FormClosing event handler be allowed to override it and set it back to false
p76015
aVIf that makes sense to you then don't shortcut
p76016
aVIs it likely that the event writer is going to be mystified by e
p76017
aVCancel already set to true
p76018
aVThen do shortcut
p76019
aVI'd choose the latter in this specific case since it is a dialog
p76020
as(dp76021
g9
V17034
p76022
stp76023
a((dp76024
g2
(lp76025
VIt means "pass by reference":
p76026
aVSame thing in C++:
p76027
aVor C#:
p76028
aVC++/CLI doesn't distinguish between ref and out
p76029
as(dp76030
g9
V17034
p76031
stp76032
a((dp76033
g2
(lp76034
VHmya, you are using global hooks, very disruptive
p76035
aVNothing you can do with the debugger, it is the copy of the DLL that got injected into Visual Studio that is making the SendMessageTimeout() call that hangs
p76036
aVIsDebuggerPresent() is not going to be useful
p76037
aVOne possible workaround is to check in which process the DLL got injected
p76038
aVUse GetModuleFileHandle, passing NULL, on the first callback you get
p76039
aVIf you see devenv
p76040
aVexe then bypass everything forever
p76041
aVBeware that this is local state, not shared
p76042
aVAnother approach is to switch mode on the first timeout you get
p76043
aVBypass the SendMessage call for a while (say 5 minutes) when that happens so that these timeouts are not so noticeable anymore
p76044
as(dp76045
g9
V17034
p76046
stp76047
a((dp76048
g2
(lp76049
VYes, cannot work
p76050
aVThe 4th argument to SendMessage is a pointer to SYSTEMTIME
p76051
aVThe pointer value is only valid in your process, not the one that owns the control
p76052
aVCrashing the target app with that pointer value is quite possible
p76053
aVYou will need to
p76054
aVcall OpenProcess() on the target process to obtain its handle
p76055
aVcall VirtualAllocEx() to allocate memory in the target process
p76056
aVcall WriteProcessMemory() to copy the SYSTEMTIME value from your process to the target process
p76057
aVcall SendMessage, using the pointer value you got from VirtualAllocEx
p76058
aVcall VirtualFreeEx() to release the memory
p76059
aVcall CloseHandle() to release the process handle
p76060
aVLots of things that can go wrong here, starting with UAC stopping you from executing these highly privileged API functions
p76061
aVThe function names google well, you should have little trouble finding sample code
p76062
as(dp76063
g9
V17034
p76064
stp76065
a((dp76066
g2
(lp76067
VImage
p76068
aVFromFile() puts a write lock on the file
p76069
aVForm1_Load() thus puts a lock on Copied
p76070
aVjpg
p76071
aVYou then press the uploadpic_btn button to assign a new bitmap to the BackgroundImage property
p76072
aVNext pressing saveBTN is however likely to fail the way you've written the code
p76073
aVCopied
p76074
aVjpg is still locked, the Image object still exists
p76075
aVIt doesn't disappear until the garbage collector runs
p76076
aVTo avoid waiting for this, you'll have to dispose the image
p76077
aVFix:
p76078
as(dp76079
g9
V17034
p76080
stp76081
a((dp76082
g2
(lp76083
VIt isn't this particular API call that's the source of the problem
p76084
aVThe API is too obscure and too poorly documented to give a straight answer, but look for an initialization style function that let's you set a callback
p76085
aVThat callback is the cause of the exception
p76086
aVYou must create a delegate object and store it in a field of your class
p76087
aVThat way the garbage collector sees a reference to it and won't garbage collect it
p76088
aVThus, instead of:
p76089
aVDo it like this:
p76090
aVContact the vendor for support if this doesn't help
p76091
as(dp76092
g9
V17034
p76093
stp76094
a((dp76095
g2
(lp76096
VSimply set the AutoSize property to False in the designer
p76097
aVAdjust the size to fit the column
p76098
aVThen set the TextAlign to one of the right-alignment ones
p76099
as(dp76100
g9
V17034
p76101
stp76102
a((dp76103
g2
(lp76104
VRemove this from the top of the file:
p76105
aVThis may cause some new errors, spell out the identifier name in full in your code (like mshtml
p76106
aVIHtmlDocument instead of just IHtmlDocument)
p76107
aVDelete the If statement
p76108
aVRaiseEvent already checks if the event has any subscribers
p76109
as(dp76110
g9
V17034
p76111
stp76112
a((dp76113
g2
(lp76114
VYou can't, this is 'hard' read-only
p76115
aVIt comes out of Windows, GetCommandLine API function, it doesn't allow modifying it either
p76116
aVYou'll have to mock it
p76117
as(dp76118
g9
V17034
p76119
stp76120
a((dp76121
g2
(lp76122
V"Verbose" doesn't make much sense here
p76123
aVDo you really mean "real time"
p76124
aVUse the BackgroundWorker's ReportProgress method
p76125
as(dp76126
g9
V17034
p76127
stp76128
a((dp76129
g2
(lp76130
VThe X belongs to the next word
p76131
aVFeed vs XFeed
p76132
aV"Extended", version 2 of the API
p76133
as(dp76134
g9
V17034
p76135
stp76136
a((dp76137
g2
(lp76138
VMaking the locking too fined-grained could cause this
p76139
aVFor example:
p76140
aVAnd then using it like this:
p76141
aVThat won't work, the dictionary could change between the hasKey and the getValue call
p76142
aVThe entire operation needs to be locked
p76143
aVAnd yes, this goes wrong once a month or so
p76144
as(dp76145
g9
V17034
p76146
stp76147
a((dp76148
g2
(lp76149
VThis particular code snippet appears to only be interested in obtaining the ppv value
p76150
aVNote that it is not that interface pointer being released
p76151
aVThe CDecoder class appears to be the vehicle to get it
p76152
aVThere a new statement to create it, not otherwise the standard COM way to create a COM class, that takes CoCreateInstance()
p76153
aVApparently proper usage of that class requires a Release() call instead of using the delete operator
p76154
aVAgain, not standard at all but not impossible
p76155
aVI can only guess that CDecoder is a C++ class that implements a COM coclass and this code is using it directly rather than going through the normal COM procedures
p76156
aVDon't assume this code is standard
p76157
aVIt is not at all
p76158
as(dp76159
g9
V17034
p76160
stp76161
a((dp76162
g2
(lp76163
VThis is a nice property of just-in-time compiled code
p76164
aVIt runs just as well on a 32-bit machine (using the x86 jitter) as a 64-bit machine (x64 jitter)
p76165
aVThe only time you get in trouble is when you need to use legacy unmanaged code that's only available as 32-bit machine code
p76166
aVNot uncommon with old dbase providers (like Jet) and COM servers
p76167
aVYou've got the right kind of machine to detect these problems early
p76168
aVEmphasizing: you don't have a problem if the target machine is 32-bit, only if it is a 64-bit machine
p76169
as(dp76170
g9
V17034
p76171
stp76172
a((dp76173
g2
(lp76174
VThe hook callback is made on the same thread that called SetWindowsHookEx()
p76175
aVThat bit of magic requires that thread to pump a message loop
p76176
aVWhich is the rub, your timer callback method is called from a threadpool thread
p76177
aVIt doesn't pump, it's not even around long enough to ever be able to get the hook callback
p76178
aVInvoke to your UI thread or use a synchronous timer
p76179
aVOr consider just temporarily disabling whatever you do in the hook callback instead of completely disabling or replacing the hook, that certainly makes most sense
p76180
as(dp76181
g9
V17034
p76182
stp76183
a((dp76184
g2
(lp76185
V/EHa disables an optimization
p76186
aVWith /EHs in effect, the compiler can omit exception filters if it can be sure that no C++ exception is ever thrown by the code wrapped in a try {}
p76187
aVThat's a small space optimization on x86 and x64, very small time optimization on x86
p76188
aVProblem is, those filters are needed if you catch non-C++ exceptions
p76189
aVThe consequence is that the stack gets unwound when such an exception is caught without the destructor of a C++ object getting called
p76190
aVNot good, /EHa avoids it
p76191
aVMixing doesn't cause linker problems
p76192
aVIt causes the above problem
p76193
aVYes, /EHa also makes catch(
p76194
aVdo a very stupid thing, it really catches everything
p76195
aVThat ship wreck sailed a while ago though, Pokemon C++ exception handling is a bad idea too
p76196
as(dp76197
g9
V17034
p76198
stp76199
a((dp76200
g2
(lp76201
VThere was DTP breakage for RTL languages in Windows 7 and Server 2008 R2
p76202
aVThe KB article is here, the forum thread that got that ball rolling is here
p76203
aVNot exactly a slamdunk for your case but compelling nonetheless
p76204
aVTry the hotfix it links to
p76205
as(dp76206
g9
V17034
p76207
stp76208
a((dp76209
g2
(lp76210
VRight-click the tool box, Choose Items
p76211
aVTick "ContextMenu", the one with Namespace = System
p76212
aVWindows
p76213
aVForms and Directory = Global Assembly Cache
p76214
aVThis
p76215
aVNET 1
p76216
aVx component is distinct from ContextMenuStrip, it uses native Windows menus
p76217
aVYou'll lose some capabilities, I doubt you care
p76218
aVYou'll need to write a line of code to assign the menu, the designer only lets you set the ContextMenuStrip property
p76219
aVAdd that line to the constructor, like:
p76220
as(dp76221
g9
V17034
p76222
stp76223
a((dp76224
g2
(lp76225
VYes, the Control
p76226
aVVisible property is special
p76227
aVThe getter does not return the last assigned value, it only returns true when the control is actually visible
p76228
aVThat can have side-effects, you've found one
p76229
aVIn this case probably induced when the control switches out of design mode
p76230
aVTo do this correctly, you must store the assigned state in a backing variable
p76231
aVLike this:
p76232
aVBe sure to initialize the default value of the backing variable to the default value of tsbDelete
p76233
aVVisible
p76234
aVUse the constructor to be sure
p76235
as(dp76236
g9
V17034
p76237
stp76238
a((dp76239
g2
(lp76240
VYou need a driver that gives access to the parallel port
p76241
aVThe inpout32
p76242
aVdll solution is nearly universally used
p76243
aVIt also lets you pinvoke helper routines to execute the INP and OUT cpu instructions
p76244
aVEverything you'd ever want to know about parallel ports, including coding samples for inpout32 is assembled at Jan Axelson's home page
p76245
as(dp76246
g9
V17034
p76247
stp76248
a((dp76249
g2
(lp76250
VJust in case, start with Tools + Options, Projects and Solutions, General, ensure "Always show solution" is ticked
p76251
aVIn the Solution Explorer window, right-click the solution (top), Properties, Common Properties
p76252
aVAdd directories to Debug Source Files
p76253
as(dp76254
g9
V17034
p76255
stp76256
a((dp76257
g2
(lp76258
VYou need to use the MouseMove event and check if the button is down and the cursor is located close to the edge of the panel
p76259
aVSay within 5 pixels
p76260
aVEnable a timer if that's the case, it should tick at ~200 msec
p76261
aVIn the Tick event handler adjust the panel's AutoScrollPosition property to make it scroll
p76262
aVKeep in mind that the effective mouse position is e
p76263
aVLocation plus AutoScrollPosition
p76264
as(dp76265
g9
V17034
p76266
stp76267
a((dp76268
g2
(lp76269
VThe components variable is the equivalent of the form's Controls variable
p76270
aVWhich keeps track of all the controls put on a form
p76271
aVSo that a form can automatically dispose all the controls when it is closed, a very important clean-up duty
p76272
aVThe form class has no equivalent member that keeps track of all the Components that were dropped on it at design time so the designer takes care of it automatically
p76273
aVNote that moving the Dispose() method from the Designer
p76274
aVcs file to the main form source code file is quite acceptable
p76275
aVI strongly recommend you do so, no reason to make the Form class 'special' in any way, it is just a managed class like any other
p76276
aVAdd Dispose() calls to dispose members as needed before the base
p76277
aVDispose call
p76278
as(dp76279
g9
V17034
p76280
stp76281
a((dp76282
g2
(lp76283
VI you write the color to the dbase as a string then you can use the ColorConverter class, ConvertToString() and ConvertFromString() methods
p76284
aVOr you can store it as an integer, use the Color
p76285
aVToArgb() and FromArgb() methods
p76286
as(dp76287
g9
V17034
p76288
stp76289
a((dp76290
g2
(lp76291
VThis is by design, you have SystemInformation
p76292
aVKeyboardDelay and KeyboardSpeed
p76293
aVThe delay is the number of 250 msec that it will wait for the key starts repeating
p76294
aVIt is normally longer than the speed, the delay between repeated key strokes
p76295
aVOnly use the keydown and keyup message
p76296
aVGet repetition from a timer or the natural way in which your game loop works
p76297
aVThis also supports having multiple keys pressed, something else that doesn't work in your current approach
p76298
as(dp76299
g9
V17034
p76300
stp76301
a((dp76302
g2
(lp76303
VThe IntelliSense parser in the C++ IDE was due for an overhaul, it had chronic problems that didn't get better with each release
p76304
aVRandom corruption of the
p76305
aVncb file, the IS database was rampant
p76306
aVFor VS2010, it was completely rewritten, a new parser and a new way to store the results
p76307
aVNow an
p76308
aVsdf file, a SQL Compact database
p76309
aVThe parser was written by the Edison Design Group, they are famous for being the only ones that ever wrote a C++ parser that completely implements the standard
p76310
aVSadly, they didn't have the resources to give C++/CLI the same treatment
p76311
aVThe work is deferred, it definitely won't make it for SP1
p76312
aVThe connect feedback report is here, only 24 votes
p76313
aVCast your vote
p76314
aVEDIT: this was taken care of in VS2012, it again supports IntelliSense for C++/CLI
p76315
aVAnd C++/CX, a language that is very similar to C++/CLI so the likely inspiration to get this work done
p76316
as(dp76317
g9
V17034
p76318
stp76319
a((dp76320
g2
(lp76321
Vonce the current time equals to the time given in app
p76322
aVconfig the database backup will happen
p76323
aVThat has a knack of not working
p76324
aVThe config could say 10:05:00, the timer elapses at 10:04:58 and 10:05:03
p76325
aVThere's no point in firing that timer every 5 seconds
p76326
aVJust fire it once
p76327
aVWhen the backup is due
p76328
aVIf the user changes the due time, stop and re-start the timer to use the altered TimeSpan
p76329
as(dp76330
g9
V17034
p76331
stp76332
a((dp76333
g2
(lp76334
VThere isn't much point in dynamically creating and destroying controls here
p76335
aVIt is just a headache, ensuring the position, size and tab order is correct
p76336
aVJust make the text box visible if you like the choice:
p76337
aVSet the textbox' Visible property to False in the designer
p76338
as(dp76339
g9
V17034
p76340
stp76341
a((dp76342
g2
(lp76343
VIt doesn't make sense to jump through the LabelEdit hoops, just change the Text property
p76344
aVThe typical diagnostic of seeing the property change in the debugger but not on the screen is that you got the wrong object reference
p76345
aVChanging a copy that's not visible instead of the one that the user is looking at
p76346
aVIt is not at all clear how you got the TreeView or Form reference in this code snippet, review your code for this
p76347
as(dp76348
g9
V17034
p76349
stp76350
a((dp76351
g2
(lp76352
VIt behaves as though the OnImageCaptured method runs on a thread
p76353
aVWhich isn't unlikely for camera interfaces
p76354
aVSet a breakpoint and use the debugger's Debug + Windows + Threads window to see what thread is running this code
p76355
aVThe failure mode is then that the UI thread is accessing the image to paint the picture box, simultaneously with this worker thread calling Clone()
p76356
aVGDI+ does not permit two threads accessing the same image object at the same time
p76357
aVIt would indeed be flaky, no telling at what exact moment in the time the UI thread starts painting
p76358
aVPicSent is another accident waiting to happen
p76359
as(dp76360
g9
V17034
p76361
stp76362
a((dp76363
g2
(lp76364
VThe PrintDialog
p76365
aVPrinterSettings property has been around since
p76366
aVNET 1
p76367
ag2512
as(dp76368
g9
V17034
p76369
stp76370
a((dp76371
g2
(lp76372
VThe underlying class for these smart COM pointers is _com_ptr_t
p76373
aVYou are trying to use this constructor:
p76374
aVKey point is that you have to pass the CLSID of the coclass, you are passing the IID of the interface
p76375
aVThat's why __uuidof(Simple) works
p76376
as(dp76377
g9
V17034
p76378
stp76379
a((dp76380
g2
(lp76381
VAlways use a full path name to open a file
p76382
aVIn other words, don't open "foo
p76383
aVtxt", open "c:\u005cbar\u005cfoo
p76384
aVtxt"
p76385
aVTo find the install directory of your EXE use GetModuleFileName(), passing NULL for the module handle
p76386
as(dp76387
g9
V17034
p76388
stp76389
a((dp76390
g2
(lp76391
VChange the FullRowSelect property to True
p76392
as(dp76393
g9
V17034
p76394
stp76395
a((dp76396
g2
(lp76397
VThe 2nd argument is the mouse location, relative to the cell's upper left corner
p76398
aVAs programmed, you make that offset relative from this, the form, which will make the menu appear in the upper left corner of the form
p76399
aVUse the DGV as the 1st argument doesn't work either, now it is in the upper left corner of the grid
p76400
aVA couple of ways to fix this, but this is the easy way:
p76401
aVYou can arbitrarily replace this with grvFieldData
p76402
as(dp76403
g9
V17034
p76404
stp76405
a((dp76406
g2
(lp76407
VCreateNoWindow only applies to console mode apps, it won't create the console window
p76408
aVWindowStyle only applies to native Windows GUI apps
p76409
aVIt is a hint passed to the WinMain() entry point of such a program
p76410
aVFourth argument, nCmdShow, telling it how to show its main window
p76411
aVThis is the same hint that appears as the "Run" setting in a desktop shortcut
p76412
aVNote that "hidden" is not an option there, few properly designed Windows program honor that request
p76413
aVSince that snookers the user, he can't get the program activated anymore and can only kill it with Task Manager
p76414
as(dp76415
g9
V17034
p76416
stp76417
a((dp76418
g2
(lp76419
VGood question
p76420
aVThe VB
p76421
aVNET Language spec only mentions "implicit imports" without giving an authoritative list
p76422
aVI can reverse-engineer it from the command line as shown in the output window, VS2008 and VS2010 uses this /Imports command line option:
p76423
aVMicrosoft
p76424
aVVisualBasic,
p76425
aVSystem,
p76426
aVSystem
p76427
aVCollections,
p76428
aVSystem
p76429
aVCollections
p76430
aVGeneric,
p76431
aVSystem
p76432
aVData,
p76433
aVSystem
p76434
aVDiagnostics,
p76435
aVSystem
p76436
aVLinq,
p76437
aVSystem
p76438
aVXml
p76439
aVLinq
p76440
aVMSBuild sets these in Microsoft
p76441
aVVisualBasic
p76442
aVtargets from the Import variable
p76443
aVWhich is set in the
p76444
aVvbproj file:
p76445
aVAltering the Project + Reference setting does alter this list but there's no obvious one-to-one correspondence since this screen changes assembly references, the  build variable lists name spaces
p76446
aVI'll have to punt, this ultimately is determined by the project template
p76447
as(dp76448
g9
V17034
p76449
stp76450
a((dp76451
g2
(lp76452
VUse mt
p76453
aVexe to embed the manifest into the executable as a resource
p76454
aVThis is a standard part of the build since VS2005, use a project template if you have trouble setting it up properly
p76455
as(dp76456
g9
V17034
p76457
stp76458
a((dp76459
g2
(lp76460
VDouble-buffering is only enabled for the Paint event
p76461
aVYou are directly drawing to the screen with CreateGraphics(), the g
p76462
aVClear() call is very noticeable since it instantly erases the drawn image
p76463
aVNot drawing in the Paint event or OnPaint method is almost always a mistake
p76464
as(dp76465
g9
V17034
p76466
stp76467
a((dp76468
g2
(lp76469
VPort sniffing requires a filter driver, like SysInternals' PortMon utility
p76470
aVYou are taking the wrong kind of approach to secure your application
p76471
aVWhen somebody can install a filter driver, the attacker has more than enough privileges to completely disable your app and replace it with something else of his own making
p76472
aVTrying to detect and prevent information loss through your app is pointless, the system itself has to be secured
p76473
aVA serial port is probably the first thing you'll have to lose, it is trivial to tap its wires
p76474
as(dp76475
g9
V17034
p76476
stp76477
a((dp76478
g2
(lp76479
VI'm almost sure that generics were envisioned from the start
p76480
aVFull well realizing that the job was going to be considerable
p76481
aVThe project was headed by Don Syme (of F# fame), his first publication about the design was dated January 2001
p76482
aVThe CLR is presented as a given, the paper documents additions to the MSIL, although at the time
p76483
aVNET 1
p76484
aV0 had not shipped yet
p76485
aVThat took another year
p76486
aVAll and all, it's probably fair to conclude that it took them close to 4 years to hammer this together into concrete shipping software
p76487
as(dp76488
g9
V17034
p76489
stp76490
a((dp76491
g2
(lp76492
VUsing new HandleRef(pr, pr
p76493
aVMainWindowHandle) might work
p76494
aVAssuming that your program actually has a main window
p76495
aVThere are definitely easier ways to get this info
p76496
aVYour foreach loop is going to need work, that doesn't compile on Process
p76497
aVGetCurrentProcess()
p76498
aVTrying to iterate all the processes is going to bomb the code, you'll get privileged system processes that don't care much about sharing information
p76499
aVIt is impossible to guess why you are trying to do this
p76500
aVUse EnumWindows to enumerate all toplevel windows on the desktop
p76501
as(dp76502
g9
V17034
p76503
stp76504
a((dp76505
g2
(lp76506
VThis is normal, bitmaps are stored upside-down
p76507
aVThe bottom scanline is at BitmapData
p76508
aVScan0
p76509
aVYou'll need to correct for this, possibly by copying one scanline at a time
p76510
aVDepends how you display it
p76511
as(dp76512
g9
V17034
p76513
stp76514
a((dp76515
g2
(lp76516
VThat's not going to work, you'll close the serial port a couple of microseconds after opening it
p76517
aVYes, the DataReceived event handler is not likely to fire
p76518
aVOnly close the port when shutting down your program
p76519
aVThat's a problem too, you'll need to control the handshake signals yourself now
p76520
aVThe vast majority of serial port devices won't send anything until they see the machine powered up and ready to receive
p76521
aVSet the DtrEnabled and RtsEnabled properties to true
p76522
as(dp76523
g9
V17034
p76524
stp76525
a((dp76526
g2
(lp76527
VIt depends on what kind of language you use to develop your program
p76528
aVWhen you use C++, you get the overhead of /RTC and the Edit + Continue support
p76529
aVThey slow down the generated code by a great deal and make it likely your app crashes early on a StackOverflow if you use recursion
p76530
aVThe runtime exceptions you can get from the checking code can be hard to diagnose without a debugger
p76531
aVIf you use VB
p76532
aVNET then you'll easily have a unpluggable memory leak when you use the Debug build without a debugger
p76533
aVA flaw in its Edit + Continue support code causes a WeakReference to be leaked for every instance of a class that contains a WithEvents event
p76534
aVYour app eventually dies on an OutOfMemory exception
p76535
aVIf you use C# then not a heckofalot goes wrong, the JIT compiler is just prevented from generating optimized machine code and garbage collection isn't as efficient
p76536
aVYour program will run slow and consume more memory than necessary
p76537
aVThis applies to VB
p76538
aVNET and C++/CLI as well
p76539
aVPerf is usually foremost on a programmer's mind when writing code
p76540
aVAs such, shipping the debug build is a bit blasphemous
p76541
aVA significant number of programs are however completely throttled by I/O, the disk, network card or the dbase server typically
p76542
aVRaw cpu perf doesn't matter a great deal in that case
p76543
as(dp76544
g9
V17034
p76545
stp76546
a((dp76547
g2
(lp76548
VThe HttpException
p76549
aVErrorCode property gives you the error code you are looking for
p76550
aVMake it look similar to this:
p76551
as(dp76552
g9
V17034
p76553
stp76554
a((dp76555
g2
(lp76556
VYou are voiding the warranty doing this
p76557
aVIt seemed to work okay though when I tried it on a sample MFC app
p76558
aVProject + Properties, Linker, Command line is where to get started
p76559
aVFirst put /VERBOSE in there and rebuild the project to see what
p76560
aVlibs get linked right now
p76561
aVYou need to use /NODEFAULTLIB to disable the release versions of the
p76562
aVlibs and add the debug versions of the
p76563
aVlibs
p76564
aVYou also need to switch the CRT version, /MTd or /MDd depending on which one you use, Project + Properties, C/C++, Code generation, Runtime library
p76565
aVUsing VS2008 I ended up with these linker settings:
p76566
aV/VERBOSE /NODEFAULTLIB:mfc90u
p76567
aVlib /NODEFAULTLIB:mfcs90u
p76568
aVlib mfc90ud
p76569
aVlib mfcs90ud
p76570
aVlib
p76571
as(dp76572
g9
V17034
p76573
stp76574
a((dp76575
g2
(lp76576
VThe debugger shows the last line of code that you wrote
p76577
aVWhich is the ShowDialog() call
p76578
aVIf you look at Debug + Windows + Call stack then you see the methods in the
p76579
aVNET framework that are involved
p76580
aVScroll the window up if necessary to see them all
p76581
aVDataGridView has a lot of built-in functionality, the source code isn't readily available although you can get it from the Reference Source
p76582
aVNot that this will help much, there's rather a lot of it
p76583
aVClearly there's some invalid data in one or more rows
p76584
aVLooks like a leading space, only guessing here without sitting in front of your machine
p76585
aVImplement the CellValidating event so the user cannot enter an improperly formatted number
p76586
as(dp76587
g9
V17034
p76588
stp76589
a((dp76590
g2
(lp76591
VThe SupportedRuntime version lists the CLR version, not the framework version
p76592
aVYou use v2
p76593
ag2512
aV50727 for any
p76594
aVNET framework version between 2
p76595
aV0 and 3
p76596
aV5 SP1
p76597
aVYour app will bomb with a FileNotFound exception when you use an assembly that's only available in 3
p76598
aV0 or 3
p76599
aV5 and you try to run it on 2
p76600
ag2512
aVIncluding the 3
p76601
aV5 bootstrapper in a Setup project (added by default) is a simple way to avoid this mishap
p76602
as(dp76603
g9
V17034
p76604
stp76605
a((dp76606
g2
(lp76607
VThere's only one C# compiler, it emits the exact same IL for whatever platform
p76608
aVWhat's different are the reference assemblies, you have to use the CF versions for the project that targets CF, the desktop versions for the project that targets
p76609
aVNET
p76610
aVWhich requires two projects
p76611
aVThey can reference the same source code files
p76612
aVAdding CF-only source code files is now of course no longer a problem
p76613
aVKeeping projects in sync is a feature available in VS2010
p76614
aVIntended for Silverlight, pointless for a CF project of course since it no longer supports it
p76615
as(dp76616
g9
V17034
p76617
stp76618
a((dp76619
g2
(lp76620
VDo not use a StreamReader to read this file
p76621
aVIt is going to interpret the binary numbers in the file as though they are characters and that will mess up their value
p76622
aVUse a FileStream and a BinaryReader
p76623
aVOnly use Encoding
p76624
aVGetString() when you are translating a group of bytes from the file that represents a string
p76625
as(dp76626
g9
V17034
p76627
stp76628
a((dp76629
g2
(lp76630
VYes, large portions of the source code of the
p76631
aVNET Framework are available as the Reference Source
p76632
aVSearch MSFT for this, basic troubleshooting help is available in this page
p76633
aVAccess to the unpublished parts is available through Redgate's Reflector Pro product
p76634
as(dp76635
g9
V17034
p76636
stp76637
a((dp76638
g2
(lp76639
VYes, these calls only cause the thread to exit
p76640
aVYou created a new thread
p76641
aVThere's little point to be gracious about it in this case, Environment
p76642
aVExit(1) will get the job done
p76643
aVThe huff-and-puff version is Control
p76644
aVBeginInvoke() to run code on the main UI thread
p76645
aVYou'll need a reference to Form1 to make that call
p76646
aVBtw, you'll also have a big problem with SystemEvents, they run on the wrong thread because the very first window you created was created on thread other than the main UI thread
p76647
aVThe most typical mishap is a deadlock when you lock and unlock the work station
p76648
aVYou'll need to wait until at least one window is created on the UI thread
p76649
aVForm1's OnLoad() method override or Load event would be a good place to start the splash
p76650
aVOr just use the built-in support for splash screens
p76651
as(dp76652
g9
V17034
p76653
stp76654
a((dp76655
g2
(lp76656
VUsing the designer, set the center row and column to Absolute, the rest to 50 Percent
p76657
as(dp76658
g9
V17034
p76659
stp76660
a((dp76661
g2
(lp76662
VThe Threading
p76663
aVDispatcher class keeps a list of all active DispatcherTimers
p76664
aVWhen you call Stop() in the Tick event handler then the timer will be removed from that list
p76665
aVThere are now no longer any references to the timer
p76666
aVIt will eventually be garbage collected
p76667
aVWhich is okay because there is no way to get the timer started again
p76668
aVAfter all, you don't have any way to get the reference anymore, the Tick event handler was your last shot at it
p76669
as(dp76670
g9
V17034
p76671
stp76672
a((dp76673
g2
(lp76674
VAllocating many small bits of memory is much more expensive than allocating one large chunk, acquiring the global heap lock isn't that cheap
p76675
aVA List<> runs rings around a LinkedList<>, cpu cache locality is king
p76676
as(dp76677
g9
V17034
p76678
stp76679
a((dp76680
g2
(lp76681
VWell, the turn variable contains the number of the process that's allowed to enter the critical section
p76682
aVHopefully it does some useful work here, then it explicitly allows the other process to enter the critical section by changing the turn variable
p76683
aVAs a result, the processes each take a turn doing work, repeatedly
p76684
aVThis comes to a screeching halt when one of the process terminates
p76685
aVIt will be given the turn by the live process but never gives the turn back because it doesn't run anymore
p76686
aVThe live process won't be doing any useful work
p76687
as(dp76688
g9
V17034
p76689
stp76690
a((dp76691
g2
(lp76692
VNo, the CCW (COM Callable Wrapper) sits in between
p76693
aVIt merely drops the reference to the managed object when the reference count reaches zero so that object can eventually be collected
p76694
aVYou can't wire into the CCW, it is opaque and doesn't generate any events
p76695
as(dp76696
g9
V17034
p76697
stp76698
a((dp76699
g2
(lp76700
VThe only way to enforce this is to write a post-build tool that enumerate all the types in an assembly and verifies if yours were applied to the correct ones
p76701
aVNot much point in doing so, the attribute simply won't have any effect if it was applied wrong, you just cannot find it back
p76702
as(dp76703
g9
V17034
p76704
stp76705
a((dp76706
g2
(lp76707
VMinidump, not "thread dump"
p76708
aVIt is built into Taskmgr
p76709
aVexe for Vista and Win7
p76710
aVRight-click the process in the Processes tab, Create Dump File
p76711
aVAll the different ways are listed here
p76712
as(dp76713
g9
V17034
p76714
stp76715
a((dp76716
g2
(lp76717
VVisual Studio does it well
p76718
aVTools + Attach to Process
p76719
aVThen Debug + Windows + Modules
p76720
as(dp76721
g9
V17034
p76722
stp76723
a((dp76724
g2
(lp76725
VReading unaligned SSE values is extraordinary expensive
p76726
aVCheck the Intel manuals, volume 4, chapter 2
p76727
ag2584
ag2447
ag2582
aVThe core type makes a difference, i7 has extra hardware to make it less costly
p76728
aVBut reading a value that straddles the cpu cache line boundary is still 4
p76729
aV5 times slower than reading an aligned value
p76730
aVIt is ten times slower on previous architectures
p76731
aVThat's massive, get the memory aligned to avoid that perf hit
p76732
aVNever heard of _mm_malloc, use _aligned_malloc() from the Microsoft CRT to get properly aligned memory from the heap
p76733
as(dp76734
g9
V17034
p76735
stp76736
a((dp76737
g2
(lp76738
VThe argument values for an attribute constructor are stored in metadata
p76739
aVThat puts severe restrictions on what you can specify
p76740
aVJust simple value types, a Type from typeof and a simple one dimensional array of these values
p76741
aVNo code is allowed, which is what the compiler complains about, the new operator requires code
p76742
aVThere are no constrictions on what you can do in the body of the attribute constructor, that code runs later when reflection code inspects the attribute
p76743
aVSuggesting something similar to this:
p76744
aVThis obviously needs work, I have no idea what the dictionary means
p76745
aVBe careful about it having side-effects or requiring resources, you don't know the runtime state when the attribute gets constructed
p76746
as(dp76747
g9
V17034
p76748
stp76749
a((dp76750
g2
(lp76751
VSwitching between modes makes the video adapter lose all retained graphics
p76752
aVA workaround for this is to use a 'canvas', an in-memory bitmap that stores the pixels
p76753
aVYou'd make modifications to this bitmap and blit it to the video adapter to make it visible
p76754
aVNot supported by this ancient graphics library you use
p76755
aVReview the CreateCompatibleDC() winapi function in you plan to get ahead
p76756
aVThis is hardly a problem
p76757
aVSimply re-render the graphics when you switch back to graphics mode
p76758
aVYou do have to store a 'model' of the polygon so you can render it
p76759
aVJust store the vertex points
p76760
as(dp76761
g9
V17034
p76762
stp76763
a((dp76764
g2
(lp76765
VYes there's an easier way, handle the exception in the task itself
p76766
aVTrying to handle it when all the state is gone is next to impossible
p76767
aVHandling it in the task is still a formidable job but at least you'll have a much better idea what went wrong where
p76768
as(dp76769
g9
V17034
p76770
stp76771
a((dp76772
g2
(lp76773
VThere's some pretty bad advice in that article, the GAC is a deployment detail and has no relevance to the task of writing and using an assembly on your dev machine
p76774
aVThe entire process also has nothing to do with COM at all
p76775
aVGet ahead by opening your VB
p76776
aVNET solution in Visual Studio
p76777
aVRight-click the solution in the Solution Explorer window, Add, New Project
p76778
aVPick "Class Library" from the C# node
p76779
aVNow right-click your VB
p76780
aVNET project, Add Reference, Project tab and select your C# project
p76781
aVAny of the public C# classes you write are now available in your VB
p76782
aVNET code
p76783
aVYou might not see the solution if it contains only one VB
p76784
aVNET project
p76785
aVFix with Tools + Options, Project and Solutions, General, tick "Always show solution"
p76786
as(dp76787
g9
V17034
p76788
stp76789
a((dp76790
g2
(lp76791
VThe function declaration is wrong, the 2nd and 3rd arguments are passed by ref
p76792
aVExplains "invalid buffer", the API wants a pointer
p76793
aVCareful with Pack, it is only 1 on 32-bit operating systems
p76794
aVSet the Platform target to x86 to be sure
p76795
aVYou are supposed to measure the required structure size first
p76796
aVTricky to do, make the HardwareID nice and big, don't be frugal and throw 16K at it
p76797
as(dp76798
g9
V17034
p76799
stp76800
a((dp76801
g2
(lp76802
VMDI child windows are always shown as a child of the MDI client area
p76803
aVThe dark gray window in an MDI parent
p76804
aVYou cannot cover this up with a docked panel, the child windows will show behind the panel
p76805
aVObviously not visible
p76806
aVYou must leave room for the client area, a hard requirement
p76807
as(dp76808
g9
V17034
p76809
stp76810
a((dp76811
g2
(lp76812
VDelete that
p76813
aVIt makes your window too small on a machine with a higher video dots-per-inch setting
p76814
aVQuite common on Win7
p76815
aVA higher DPI makes the fonts taller in pixels
p76816
aVThe Form
p76817
aVAutoScaleMode property automatically adjusts for that by making the controls larger to fit that bigger font
p76818
aVYour Region doesn't grow though, cutting off the bottom of the controls
p76819
aVNo idea why you use a Region in the first place since its a plain rectangle, I suppose you are looking for FormBorderStyle = None
p76820
aVA form won't allow you to make it too small but you can override that in the OnLoad method
p76821
aVSet the ClientSize large enough to fit the rescaled controls
p76822
as(dp76823
g9
V17034
p76824
stp76825
a((dp76826
g2
(lp76827
VDo not convert a byte[] to a string with an EBCDIC string converter
p76828
aVWhile 0 is a perfectly reasonable byte value, it often acts as a string terminator
p76829
aVIt does so for the debugger (note the missing trailing double quote), it isn't unlikely to do so as well for your dbase provider
p76830
aVIf you don't want to store the value as a binary blob in the dbase then encode it with Convert
p76831
aVToBase64String()
p76832
aVRead it back with Convert
p76833
aVFromBase64String()
p76834
as(dp76835
g9
V17034
p76836
stp76837
a((dp76838
g2
(lp76839
VThis is asserted as "by design" in this feedback article
p76840
aVConsider a post-processing step that hacks the paths the way you want them
p76841
as(dp76842
g9
V17034
p76843
stp76844
a((dp76845
g2
(lp76846
VFor the screen: pixels = Graphics
p76847
aVDpiY * points / 72
p76848
aVFor the printer, mentioned in your question subject, mapping is 1 'pixel' == 0
p76849
aV010 inches by default
p76850
aVThis is quite close to the default video dpi of 96 dots per inch making the copy on paper about the same size as what you see on the monitor
p76851
aVMaking screen shots of your form and printing them is a bad idea
p76852
aVPrinters have much higher resolutions, 600 dpi is typical
p76853
aVThe printout will look grainy as each pixel on the screen becomes a 6x6 blob on paper
p76854
aVEspecially noticeable and fugly for anti-aliased text
p76855
as(dp76856
g9
V17034
p76857
stp76858
a((dp76859
g2
(lp76860
VI think it's covered but add my own interpretation
p76861
aVIt is a code generation optimization
p76862
aVWhen the jitter generates code for a generic class, it only needs to generate a few versions of it
p76863
aVThere's one that covers any reference type, that's why you see object being used in the code
p76864
aVAnd there's one each for each distinct value type
p76865
aVThat's why you see byte, bool, short, int, uint being popular
p76866
aVThis code lives in mscorlib
p76867
aVdll and is therefore available precompiled in the ngen-ed image
p76868
aVWhich the jitter can then directly use without a need to generate the machine code on-the-fly
p76869
aVIn effect, it is a workaround for ngen being incapable of guessing up front which generic instantiations will be required
p76870
aVClearly it isn't practical to exhaustively pregen every possible combination, especially for a class like Dictionary<>
p76871
aVThey no doubt analyzed a bunch of code to see what generic type arguments were most popular, probably starting with the framework itself
p76872
as(dp76873
g9
V17034
p76874
stp76875
a((dp76876
g2
(lp76877
VNo, the operating system cleans up when the process terminates
p76878
as(dp76879
g9
V17034
p76880
stp76881
a((dp76882
g2
(lp76883
VThis is a LoadLibrary() failure
p76884
aVSounds to me that you plugins have a dependency on some unmanaged DLLs
p76885
aVYes, Windows is going to have a hard time finding these DLLs, it has no reason to look in the plugin directories
p76886
aVMaybe it works the first time because your app's default directory happens to be set to the correct directory
p76887
aVWhich would then also be the workaround, use Environment
p76888
aVCurrentDirectory
p76889
aVFinding out exactly which dependencies can not be found is key
p76890
aVUnmanaged ones are not going to show up in fuslogvw
p76891
aVexe, you can dig it out of a trace from SysInternals' ProcMon utility
p76892
as(dp76893
g9
V17034
p76894
stp76895
a((dp76896
g2
(lp76897
VIt's a bug fix
p76898
aVThe feedback report with the bug details is here
p76899
aVMicrosoft's response to the bug report:
p76900
aVNote that this bug affects the following:
p76901
aVArray
p76902
aVSort(), where the array contains Double
p76903
aVNaN
p76904
aVArray
p76905
aVSort(), where the array contains Single
p76906
aVNaN
p76907
aVany callers of above, for example on List
p76908
aVSort(), where list contains Double
p76909
aVNaN
p76910
aVThis bug will be fixed in the next major version of the runtime; until then you can work around this by using a custom IComparer that does the correct sorting
p76911
aVAs mentioned in the workaround comments, don't use Comparer
p76912
aVDefault, because this is special-cased with a shortcut sort routine that doesn't handle NaN correctly
p76913
aVInstead, you can provide your own comparer that provides an equivalent comparision, but won't be special-cased
p76914
as(dp76915
g9
V17034
p76916
stp76917
a((dp76918
g2
(lp76919
VLots of ways to deal with this
p76920
aVA simple way is to just not make the timer periodic, make it a one shot by only setting the dueTime argument
p76921
aVThen re-enable the timer in the callback in a finally block
p76922
aVThat guarantees that the callback cannot run concurrently
p76923
aVThis is of course makes the interval variable by the execution time of the callback
p76924
aVIf that's not desirable and the callback only occasionally takes longer than the timer period then a simple lock will get the job done
p76925
aVYet another strategy is Monitor
p76926
aVTryEnter and just give up on the callback if it returns false
p76927
aVNone of these are particularly superior, pick what you like best
p76928
as(dp76929
g9
V17034
p76930
stp76931
a((dp76932
g2
(lp76933
VUse the Control
p76934
aVDrawToBitmap() method
p76935
aVFor example:
p76936
as(dp76937
g9
V17034
p76938
stp76939
a((dp76940
g2
(lp76941
VThere's no reason for the timer to have to be a member of the form
p76942
aVThis will work just fine:
p76943
as(dp76944
g9
V17034
p76945
stp76946
a((dp76947
g2
(lp76948
VString is a reference type
p76949
aVThe dictionary contains a reference to the actual string object, 4 bytes on a 32-bit operating system
p76950
aVAdding the same string to multiple dictionaries produces only one copy of the string
p76951
aVYou already got what you are looking for
p76952
as(dp76953
g9
V17034
p76954
stp76955
a((dp76956
g2
(lp76957
VYou're in luck, AllowDrop is a virtual property
p76958
aVWhich makes it very easy to raise the event, just override the property and raise the event in the setter
p76959
aVThe boilerplate code looks like this:
p76960
as(dp76961
g9
V17034
p76962
stp76963
a((dp76964
g2
(lp76965
VWhen running in the batch processor, %~dp0 expands to the path where the
p76966
aVbat file is executing
p76967
aVSo in the default install for VS2010, that resolves to c:\u005cprogram files\u005cmicrosoft visual studio 10
p76968
aV0\u005cvc\u005cbin\u005camd64\u005cvcvars64
p76969
aVbat
p76970
aVWhich is indeed missing, that's a bug they don't seem to be interesting in fixing
p76971
aVUse "x86_amd64" instead
p76972
aVYou'll get the cross compiler, the same one that's used by the IDE
p76973
as(dp76974
g9
V17034
p76975
stp76976
a((dp76977
g2
(lp76978
VNo, a
p76979
aVconfig file is associated with an AppDomain, not a thread
p76980
aVOn the default CLR host, the primary appdomain is hard-baked to the app
p76981
aVexe
p76982
aVconfig file, you cannot change it
p76983
aVNew AppDomains can be configured with their own
p76984
aVconfig file through the AppDomainSetup
p76985
aVConfigurationFile property
p76986
aVBeware of the effort required to serialize data from one appdomain to another, this is something you only want to do if you are actually interested in isolating code
p76987
aVWhatever the reason you want to do this, surely there's a better way than an AppDomain to accomplish your goal
p76988
as(dp76989
g9
V17034
p76990
stp76991
a((dp76992
g2
(lp76993
VUse Color
p76994
aVToArgb() and FromArgb() to convert back and forth to an int value that you can store in a dbase column
p76995
aVIf you really want to then you can use the ColorConverter class to convert back and forth to a string, something you can stuff into your PixelColor column
p76996
aVUsing an integer column type is a heckofalot more efficient though
p76997
as(dp76998
g9
V17034
p76999
stp77000
a((dp77001
g2
(lp77002
VA DispatcherTimer is kept alive by the Dispatcher class, it keeps a  internally that stores a reference to any timer that's enabled
p77003
aVAs soon as you Stop() the timer, the object gets removed from that list, making it eligible for garbage collection if you don't store any additional reference to it
p77004
aVWhich you don't in this case, the timer reference is a local variable
p77005
aVYou cannot get a finalizer on the auto-generated class that implements the lambda
p77006
aVNext best thing is to simply run this code a billion times
p77007
aVIf you don't get runaway member consumption and OOM then it obviously doesn't leak
p77008
aVYou'll want to make the Interval shorter so it doesn't take until Christmas, 15 msec is good
p77009
aVUse a Timer to call the method so you don't get too many active timers at the same time and allow the dispatcher to do its job
p77010
as(dp77011
g9
V17034
p77012
stp77013
a((dp77014
g2
(lp77015
VThere are no options at all that affect the way the resource editor makes changes to the
p77016
aVrc file
p77017
aVIt sounds to me that the previous programmer that made changes to the file did so with a text editor instead of using the resource editor
p77018
aVWork this out within your team and agree on a common way to edit
p77019
aVAnd tweak your diff tool, many allow ignoring changes to whitespace
p77020
as(dp77021
g9
V17034
p77022
stp77023
a((dp77024
g2
(lp77025
VNo
p77026
aVJust write the code:
p77027
aVThere an otherwise undocumented way to get the lock owner, it isn't guaranteed to work but usually does
p77028
aVWhen you have a breakpoint active use Debug + Windows + Memory + Memory1
p77029
aVIn the Address input box, type the name of the locking object ("lockObject") and press Enter
p77030
aVThe address box changes to the address of the object in memory
p77031
aVEdit it and append "-4" to the address, press Enter
p77032
aVThe first 4 bytes in the dump gives you the ManagedThreadId in hexadecimal
p77033
aVThis works for 32-bit code, as long as you never called GetHashCode on the locking object
p77034
aVWhich of course you shouldn't
p77035
as(dp77036
g9
V17034
p77037
stp77038
a((dp77039
g2
(lp77040
VThese API functions have existed since the first release of the Win32 API, back in ~1993
p77041
aVNo need to write special code
p77042
aVIf you intend to target ancient operating systems like NT4 and Win95 you will however have to pay a visit to the Microsoft Museum to find an old version of both the SDK and the compiler
p77043
aVSDK and compiler releases for at least the past 6 years are compatible only with Windows 2000 and up
p77044
aVFinding these versions might be harder than it looks, the settlement with Sun made it illegal for Microsoft to still distribute version 5 and 6 of Visual Studio
p77045
aVYou'll have to go back at least to version 4
p77046
ag2584
aVIt has been a long time since I've seen anybody willing to put up with the cost of supporting such ancient relics
p77047
as(dp77048
g9
V17034
p77049
stp77050
a((dp77051
g2
(lp77052
VLocate the AppSettings
p77053
aVhtm file in the vc\u005cvcwizards\u005cappwiz\u005cgeneric\u005capplication\u005chtml\u005cxxxx subdirectory of the VS install directory
p77054
aVxxxx is your language id, it is 1033 for English
p77055
aVMake a copy of the file and open it in a text editor
p77056
aVLocate the InitControls javascript function
p77057
aVAdd the line
p77058
aVto the if() statement that checks CONSOLE_APP
p77059
aVchecked
p77060
aVFurther tweak as needed, I haven't otherwise checked this
p77061
as(dp77062
g9
V17034
p77063
stp77064
a((dp77065
g2
(lp77066
VRegistering [ComVisible]
p77067
aVNET assemblies with Regsvr32
p77068
aVexe is not possible
p77069
aVIt doesn't have the required DllRegisterServer entrypoint that Regsvr32 needs
p77070
aVYou will have to make it work with Regasm
p77071
aVexe or a Setup project
p77072
aVThe latter is necessary when you deploy your server to another machine
p77073
aVThere are few failure modes
p77074
aVOther than:
p77075
aVforgetting to use the /codebase option
p77076
aVRequired if you don't deploy the assembly to the GAC, something you should not do on your dev machine
p77077
aVusing the wrong version of Regasm
p77078
aVexe
p77079
aVThere are two on a 64-bit machine, the Framework64 directory contains the one you have to use if the client code is 64-bit
p77080
aVrunning it from a command prompt that is not elevated
p77081
aVRegasm
p77082
aVexe writes to the HKLM hive of the registry, something that UAC actively prevents
p77083
aVThat's an issue on Vista and Win7
p77084
aVJust getting the assembly grossly wrong is of course possible too
p77085
aVLike not making one or more interfaces and/or classes [ComVisible]
p77086
as(dp77087
g9
V17034
p77088
stp77089
a((dp77090
g2
(lp77091
VClearly the file got corrupted
p77092
aVGet your machine stable again, focus on the hard drive
p77093
aVAsk questions about that at superuser
p77094
aVcom
p77095
aVThen reinstall VS6
p77096
aVIf the book gives sample code that works on VS6 then you really should consider upgrading the book
p77097
as(dp77098
g9
V17034
p77099
stp77100
a((dp77101
g2
(lp77102
VThe SAPI interface got a nice wrapper in
p77103
aVNET 3
p77104
aV0, System
p77105
aVSpeech
p77106
aVSynthesis namespace
p77107
aVUsable in any
p77108
aVNET compatible language
p77109
aVAdd a reference to System
p77110
aVSpeech
p77111
as(dp77112
g9
V17034
p77113
stp77114
a((dp77115
g2
(lp77116
VThe event is raised by the Winforms plumbing code
p77117
aVThe only way it can see that the custom event handler wants to alter the default behavior is through the  object
p77118
aVCreating a new CancelEventArgs object has no side-effects that the plumbing can detect
p77119
aVThere's something else wrong, events are raised for the benefit of external code, letting it know what's going on and giving it an option to alter behavior
p77120
aVThere is no external code here, the event handler is actually part of the same class that raises the event
p77121
aVIn other words, the form is listening to its own events
p77122
aVThere's a much better way to deal with that, you override the method that raises the event
p77123
aVLike this:
p77124
aVNow external code can override the default behavior, events are raised after the OnXxxx method runs
p77125
aVAnd you have a choice, if you do not want the external code to override the behavior, simply swap the two statements
p77126
as(dp77127
g9
V17034
p77128
stp77129
a((dp77130
g2
(lp77131
VYou are reading a string from the device, then seem to make a lot of effort to turn that back into binary
p77132
aVThis doesn't work well, you are for one subject to the conversion of bytes to characters as determined by the SerialPort
p77133
aVEncoding property
p77134
aVWhich defaults to ASCII, turning any byte value > 0x7f to a question mark
p77135
aVRead binary data with the SerialPort
p77136
aVRead() method
p77137
as(dp77138
g9
V17034
p77139
stp77140
a((dp77141
g2
(lp77142
VThere is no good way, avoid this at all cost
p77143
aVThe fundamental problem is that culture is not part of the Thread
p77144
aVExecutionContext, it doesn't flow from one thread to another
p77145
aVThis is a unsolvable problem, culture is a property of a native Windows thread
p77146
aVIt will always be initialized to the system culture as selected in Control Panel's Region and Language applet
p77147
aVMaking temporary thread-local changes to the culture is fine, trying to switch 'the process' to another culture is a source of bugs you'll be hunting for months
p77148
aVThe string collation order is the nastiest source of problems
p77149
aVEDIT: this problem was fixed in
p77150
aVNET 4
p77151
aV5 with the CultureInfo
p77152
aVDefaultThreadCurrentCulture and DefaultThreadCurrentUICulture properties
p77153
as(dp77154
g9
V17034
p77155
stp77156
a((dp77157
g2
(lp77158
VYou always pass the name of the standard (non daylight savings enabled) time zone
p77159
aVIn your case that's "Pacific Standard Time"
p77160
aVTo find these names look in your machine's registry with Regedit
p77161
aVexe
p77162
aVNavigate to HKEY_LOCAL_MACHINE\u005cSOFTWARE\u005cMicrosoft\u005cWindows NT\u005cCurrentVersion\u005cTime Zones
p77163
aVBeware that this list is only deemed reliable for Windows Vista and up, your code isn't going to work well for earlier versions (2000 and XP)
p77164
aVThe one feature that is missing is historic information about previous changes to the daylight savings rule
p77165
aVThe "Dynamic DST" subkey
p77166
aVThe machine must also have Windows Update enabled to receive updates to these rules
p77167
aVAnd of course it doesn't keep track at all over local political decisions about DST rules
p77168
aVCommon in the USA for example for counties in Indiana, Arizona and American Indian tribal territories
p77169
as(dp77170
g9
V17034
p77171
stp77172
a((dp77173
g2
(lp77174
VNo, you're fundamentally looking for the wrong solution
p77175
aVWhat you see in explorer's Details tab is actually an unmanaged resource
p77176
aVThe C# compiler auto-generates one from the assembly attributes (/win32res compiler option), this of course does not happen when you create an interop assembly
p77177
aVOr for that matter try to create one with an AssemblyBuilder
p77178
aVTo make this work, you first have to disassemble the interop library with ildasm
p77179
aVexe /out
p77180
aVNext, you have to create a version resource, best done with a C++ project
p77181
aVUse the resource editor to add a Version resource
p77182
aVAfter building you get a
p77183
aVres file
p77184
aVThen use ilasm
p77185
aVexe to re-create the interop library, using the /resource option to get the
p77186
aVres file embedded
p77187
aVI gave you the 100 miles per hour version, this is hard to automate
p77188
as(dp77189
g9
V17034
p77190
stp77191
a((dp77192
g2
(lp77193
VYou cannot use SendMessage (or PostMessage, the correct one) to simulate the state of the modifiers keys, like CTRL
p77194
aVYou must use SendInput()
p77195
aVA keystroke like Ctrl+S is not untypically translated into a WM_COMMAND message
p77196
aVUse the Spy++ tool to see what happens when you type Ctrl+S by hand
p77197
aVIf you see WM_COMMAND then you're golden, you can use SendMessage() to send that message
p77198
aVThis will of course only work on a specific process
p77199
as(dp77200
g9
V17034
p77201
stp77202
a((dp77203
g2
(lp77204
VThis is pretty typical for COM components, they cannot update their internal state until you pump the message loop
p77205
aVWhich doesn't happen, you're stuck in a loop
p77206
aVUse a Timer instead
p77207
as(dp77208
g9
V17034
p77209
stp77210
a((dp77211
g2
(lp77212
VTwo synchronization objects are required here
p77213
aVOne you already got, a Semaphore models the tables
p77214
aVYou need another one to model the door
p77215
aVAn event
p77216
as(dp77217
g9
V17034
p77218
stp77219
a((dp77220
g2
(lp77221
VYou find these by appending "
p77222
aVnet" to the language name
p77223
aVGoogle "lua
p77224
aVnet", take the second hit
p77225
aVStraight from the guys that made it
p77226
as(dp77227
g9
V17034
p77228
stp77229
a((dp77230
g2
(lp77231
VYou will have to use OutputDebugString() to get output displayed in the Visual Studio Output window
p77232
aVLinking your own version of printf is the easiest way to avoid editing your code
p77233
as(dp77234
g9
V17034
p77235
stp77236
a((dp77237
g2
(lp77238
VNot so sure this make sense, personally I like it when keystrokes don't disappear and I can type ahead
p77239
aVBut you can flush the keyboard buffer like this:
p77240
as(dp77241
g9
V17034
p77242
stp77243
a((dp77244
g2
(lp77245
VBoth
p77246
aVThe Font property is its own
p77247
aVNET object
p77248
aVWinforms however caches the native Windows font, they are fairly expensive to create
p77249
aVThe
p77250
aVNET wrapper object is quite small
p77251
aVYes
p77252
aVThe code is fine, the Font property setter already disposes the previously assigned font
p77253
aVYes, it is disposed by the UserControl
p77254
aVWhich in turn is automatically disposed by its parent
p77255
as(dp77256
g9
V17034
p77257
stp77258
a((dp77259
g2
(lp77260
VWe've got Tony Hoare, an early pioneer that worked on Algol to thank for that
p77261
aVHe rather regrets it:
p77262
aVI call it my billion-dollar mistake
p77263
aVIt was the invention of the null
p77264
aVreference in 1965
p77265
aVAt that time, I was
p77266
aVdesigning the first comprehensive type
p77267
aVsystem for references in an object
p77268
aVoriented language (ALGOL W)
p77269
aVMy goal
p77270
aVwas to ensure that all use of
p77271
aVreferences should be absolutely safe,
p77272
aVwith checking performed automatically
p77273
aVby the compiler
p77274
aVBut I couldn't resist
p77275
aVthe temptation to put in a null
p77276
aVreference, simply because it was so
p77277
aVeasy to implement
p77278
aVThis has led to
p77279
aVinnumerable errors, vulnerabilities,
p77280
aVand system crashes, which have
p77281
aVprobably caused a billion dollars of
p77282
aVpain and damage in the last forty
p77283
aVyears
p77284
aVA billion is a low-ball number, I think
p77285
as(dp77286
g9
V17034
p77287
stp77288
a((dp77289
g2
(lp77290
VThe return type of the dialog procedure is INT_PTR, not bool
p77291
aVReturn (INT_PTR)FALSE if you don't handle the message
p77292
as(dp77293
g9
V17034
p77294
stp77295
a((dp77296
g2
(lp77297
VYou used DECLARE_DYNAMIC but forgot IMPLEMENT_DYNAMIC
p77298
as(dp77299
g9
V17034
p77300
stp77301
a((dp77302
g2
(lp77303
VThose blue rectangles look a lot like controls
p77304
aVDrawing a line on top of a control is hard to do in Winforms
p77305
aVYou have to create a transparent window that overlays the design surface and draw the rectangle on that window
p77306
aVThis is also the way the Winforms designer works
p77307
aVSample code is here
p77308
as(dp77309
g9
V17034
p77310
stp77311
a((dp77312
g2
(lp77313
VThat's what the QueryContinueDrag event is designed to do
p77314
aVIt is raised on the drag source when the user presses the Escape key, the e
p77315
aVEscapePressed property will be true
p77316
aVSet e
p77317
aVAction = DragAction
p77318
aVCancel to cancel the D+D
p77319
as(dp77320
g9
V17034
p77321
stp77322
a((dp77323
g2
(lp77324
VWith the designer: put a control in the 2nd row and set its ColumnSpan property to 2
p77325
aVIn code:
p77326
as(dp77327
g9
V17034
p77328
stp77329
a((dp77330
g2
(lp77331
VThis is because ToolStripComboBox derives from ToolStripControlHost, not ComboBox
p77332
aVYou need to use its Control property to get to the combo box
p77333
aVLike this:
p77334
aVFill in the event handlers with the code you need to measure and draw the font names in their own font style
p77335
as(dp77336
g9
V17034
p77337
stp77338
a((dp77339
g2
(lp77340
VVista and up has auto-sizing for columns for version 6
p77341
aVIts exact behavior isn't documented well
p77342
aVEither drop LVCF_IDEALWIDTH or use LVCF_MINWIDTH and set the cxMin member
p77343
as(dp77344
g9
V17034
p77345
stp77346
a((dp77347
g2
(lp77348
VUnderstanding the difference between posting messages (PostMessage) and sending messages (SendMessage) is important here
p77349
aVWindows calls the window procedure directly for sent messages, they are not dispatched by the message loop
p77350
aVWhich is how WM_CREATE and WM_SHOWWINDOW can be processed before the message loop is started
p77351
aVWM_QUIT, WM_PAINT, WM_KEYDOWN and WM_MOUSEMOVE are examples of messages that are posted
p77352
as(dp77353
g9
V17034
p77354
stp77355
a((dp77356
g2
(lp77357
V"Universal Run Time" was a very early name for the CLR
p77358
aVIts name got preserved in the Windows SDK WinError
p77359
aVh include file
p77360
aVError codes generated by the CLR have facility code 19
p77361
aVLike 0x80131506, the infamous Fatal Execution Engine error
p77362
aVThere's more history like this in error codes, they are archeological artifacts that preserve quite well
p77363
aVThe exception code for a managed exception is 0xe0434f4d
p77364
aVThe last 3 hex pairs spell "COM" in ASCII, an otherwise common technique used by Microsoft to pick memorable exception codes
p77365
aVQuite ironic considering that the
p77366
aVNET framework was designed to be a replacement for COM
p77367
aVBut the CLR started out as a project in Microsoft's COM+ group
p77368
as(dp77369
g9
V17034
p77370
stp77371
a((dp77372
g2
(lp77373
VCodeMetrics is a free add-on for the soon no-longer-free Reflector
p77374
aVNo idea how good it is, I got the right version of VS
p77375
as(dp77376
g9
V17034
p77377
stp77378
a((dp77379
g2
(lp77380
VYes, odds are decent that you can pinvoke these functions
p77381
aVThey look like regular C functions, not instance methods of a C++ class
p77382
aVULONG is uint in C#, double is plain double
p77383
aVThe * means that a pointer to the value is passed
p77384
aVIt is ambiguous though, it could either be an argument that's passed by reference (ref or out keyword in C#) or it could be an array
p77385
aVThe first function definitely passes its 1st argument as "out uint" in C#, it returns a handle value
p77386
aVThe second function is tougher
p77387
aVThere's no decent guess whether dblValue is an array or passed by reference, its name is lousy
p77388
aVStart your guess at "ref double", you have to look in the C++ code to be sure
p77389
aVSame problem with strParam, it should be "string" if its value is passed in, StringBuilder if a value is returned
p77390
aVThe dblArrayValue arguments are definitely arrays, double[] in C#
p77391
as(dp77392
g9
V17034
p77393
stp77394
a((dp77395
g2
(lp77396
VIt is a bug fix
p77397
aVThe feedback article that triggered the fix is here
p77398
as(dp77399
g9
V17034
p77400
stp77401
a((dp77402
g2
(lp77403
VBuild + Configuration Manager
p77404
aVUpper right combo (Active solution platform), pick Edit
p77405
aVSelect the unwanted platform and click Remove
p77406
as(dp77407
g9
V17034
p77408
stp77409
a((dp77410
g2
(lp77411
VUse __declspec(dllexport) on the class declaration instead of using a
p77412
aVdef file
p77413
aVExporting everything doesn't make a lot of sense and is not supported
p77414
aVYou pick what should be visible
p77415
as(dp77416
g9
V17034
p77417
stp77418
a((dp77419
g2
(lp77420
VDon't mix up virtual key codes and characters
p77421
aVIn the KeyPress event you get the actual character that was translated from the virtual key by the active keyboard layout
p77422
aVThus:
p77423
as(dp77424
g9
V17034
p77425
stp77426
a((dp77427
g2
(lp77428
VWell, using  would be wiser here, that at least cuts out on the (one time) cost of looking up the DLL export
p77429
aVBut that's it, they both use the C runtime  function
p77430
aVSpeed is entirely throttled by the RAM bus bandwidth, only buying a more expensive machine can speed it up
p77431
aVBeware that profiling is tricky, accessing the bitmap data the first time causes page faults to get the pixel data into memory
p77432
aVHow long that takes is critically dependent on what your hard disk is doing and the state of the file system cache
p77433
as(dp77434
g9
V17034
p77435
stp77436
a((dp77437
g2
(lp77438
VThe only knobs you have are LockWorkStation() to lock the workstation and SystemParametersInfo(), SPI_SETSCREENSAVEACTIVE to activate the screen saver
p77439
aVEverything else, switching the desktop, looking up the selected screen saver, loading and starting it is buried inside Windows
p77440
aVI'd guess at crss
p77441
aVexe
p77442
aVYour question is too vague to offer help beyond this
p77443
as(dp77444
g9
V17034
p77445
stp77446
a((dp77447
g2
(lp77448
VA right-click doesn't do anything until you give it a meaning
p77449
aVLike setting a control's ContextMenuStrip property or writing an event handler for the MouseDown event
p77450
aVA few controls do have predefined behavior, TextBox for example has its own baked-in context menu
p77451
aVYou don't want to disable it
p77452
aVSo disable it by simply not doing anything to make it work
p77453
aVIMessageFilter is indeed the only other hack
p77454
as(dp77455
g9
V17034
p77456
stp77457
a((dp77458
g2
(lp77459
VIt is automatically initialized to the default printer
p77460
aVDo nothing
p77461
as(dp77462
g9
V17034
p77463
stp77464
a((dp77465
g2
(lp77466
VThis seems all pretty unlikely, especially the part where "func" transformed into "letterList"
p77467
aVNevertheless, you have to tell the linker to also link the import library of the DLL so that it can resolve identifiers that are imported from that DLL
p77468
aVThe easiest way to do that in MSVC is:
p77469
aVin CodeTest
p77470
aVcpp
p77471
aVThe #pragma does the same thing as the linker's Additional Dependencies setting
p77472
as(dp77473
g9
V17034
p77474
stp77475
a((dp77476
g2
(lp77477
VBy far the simplest way to keep a form invisible is just by not showing it
p77478
aVIt is a big deal in Winforms, calling Show() or setting the Visible property to true (same thing) does a lot of things
p77479
aVIt is the way the native Windows window gets created
p77480
aVIn typical
p77481
aVNET 'lazy' fashion
p77482
aVAny attempt to set Visible back to false (like in OnLoad) will be defeated
p77483
aVTechnically it is possible, you have to override the SetVisibleCore() method
p77484
aVLike this:
p77485
aVThis ensures that the window doesn't become visible the first time you call Show()
p77486
aVWhich is handy when you have NotifyIcon for example, you typically want the icon directly in the notification area and only display a window when the user clicks on the icon
p77487
aVBeware that OnLoad() doesn't run until the window actually becomes visible so move code to the constructor or the override if necessary
p77488
as(dp77489
g9
V17034
p77490
stp77491
a((dp77492
g2
(lp77493
VCOM had very lofty goals
p77494
aVOne of them was that threading was a programming detail that was very hard to get right and should be managed by support libraries
p77495
aVVery unlike
p77496
aVNET where it is entirely up to you to use classes that are not thread-safe in a thread-safe manner
p77497
aVThis works through the registry, a COM coclass publishes the ThreadingModel registry key that says what kind of threading it supports
p77498
aVBy far most of them use "Apartment", a somewhat unclear way to say "I don't support multi-threading"
p77499
aVWhich is a signal for COM to make sure that all of the methods are called in a thread-safe manner
p77500
aVIf your program calls a method from a worker thread then COM takes care of marshaling the call from the worker to the thread that created the instance
p77501
aVThus automatically ensuring that the server is used in a thread-safe manner
p77502
aVNot unlike the way Control
p77503
aVInvoke and Dispatcher
p77504
aVInvoke works, but completely automatically
p77505
aVThis is wonderful magic of course, but your program does have to co-operate a bit
p77506
aVCOM cannot marshal calls like that without your help
p77507
aVWhen your program creates a thread, it must call CoInitialize() to tell the COM infrastructure that you want to participate in COM calls
p77508
aVAt that time, you have to tell it what kind of thread you created
p77509
aVThere are two, distinguished by the 'apartment' type
p77510
aVThere is STA (Single Threaded Apartment) and MTA (Multiple)
p77511
aVAn STA thread is a hospitable home to COM components that don't support threading
p77512
aVAn MTA thread is not
p77513
aVThere's a price tag attached with the kind of apartment though
p77514
aVWhen you create an STA then you have to follow STA rules
p77515
aVWhich are a bit draconic:
p77516
aVYou must pump a Windows message loop
p77517
aVYou can never block the thread
p77518
aVThe message loop is the mechanism by which COM marshals calls from one thread to another
p77519
aVThe never-block rule is required to prevent deadlock
p77520
aVWhile draconic, it is however the way a UI thread of a program works
p77521
aVThis is not a coincidence
p77522
aVThere's also a price tag attached to creating an apartment threaded COM object on an MTA thread
p77523
aVSuch a thread is not a good home, it doesn't follow the STA rules
p77524
aVCOM cannot be helpful and get the method calls marshaled
p77525
aVCOM steps in and actually creates its own STA thread to give the object a hospitable home
p77526
aVNice, but not cheap since that burns up a thread and every method call is marshaled, that adds a lot of overhead to every single call
p77527
aVCOM threading support is quite nice, it takes care of everything 98% of the time without having to do anything special
p77528
aVIt is however the 2% that can give you an enormous migraine, there's very little you can do to whack it
p77529
aVIt also scales very poorly, probably the biggest reason that
p77530
aVNET doesn't have anything similar
p77531
aVWhile COM might appear dead, apartments are still a very big deal in Windows programming
p77532
aVThe
p77533
aVNET framework has explicit support for them
p77534
aVCalling Thread
p77535
aVJoin() or Monitor
p77536
aVEnter() on an STA thread for example, explicitly verboten by COM, makes the CLR pump a message loop
p77537
aVOther artifacts are the [STAThread] attribute you see on the Main() method of a GUI app and Thread
p77538
aVSetApartmentState(), the ways to get the CLR call CoInitialize() the correct way
p77539
aVGUI features like the clipboard, drag and drop and the shell dialogs (like OpenFileDialog) explicitly require STA to work
p77540
aVA thread that creates any windows should always be an STA thread
p77541
as(dp77542
g9
V17034
p77543
stp77544
a((dp77545
g2
(lp77546
VOkay, I found it
p77547
aVThis is an interesting failure mode
p77548
aVAll of the PIAs for Microsoft
p77549
aVmshtml that I have installed on machine are outdated
p77550
aVNo less than 4 of them, all version 7
p77551
ag2512
aV3300
p77552
aV0 with a runtime target of 1
p77553
ag2512
aV3705 (which is quite old)
p77554
aVThe fooClass interop class that's generated by the type library importer is the cause
p77555
aVIt is a synthetic class, it exists because a COM coclass can implement multiple interfaces
p77556
aVThe class is a flattened version of all of the combined methods of all interfaces
p77557
aVThe current SDK version of the HTMLDocument coclass is declared as follows (from mshmtl
p77558
aVidl):
p77559
aVIf you use Object Browser on the interop library, you'll see that HTMLDocumentClass is missing the interface methods for IHTMLDocument6, IDocumentSelector and IHTMLDOMConstructor
p77560
aVThe write() method you are using is past these interfaces
p77561
aVWhich means that if you use HTMLDocumentClass
p77562
aVwrite(), you'll call the wrong method
p77563
aVThe exception is raised because whatever method is being called isn't happy about the argument
p77564
aVOf course it is not
p77565
aVThis is a nasty failure mode of course
p77566
aVThis came about because Microsoft broke a very hard COM requirement, changing a COM interface or coclass requires a different guid
p77567
aVThe [uuid] attribute in the above declaration
p77568
aVThat however also makes new versions of Internet Explorer completely incompatible with old code that uses it
p77569
aVRock and a hard place, backwards compatibility is quite sacred at Microsoft
p77570
aVThe order of interface implementations in a coclass is not normally a problem in regular COM clients
p77571
aVExcept in
p77572
aVNET, it breaks the layout of the synthetic XxxClass type that tlbimp generates
p77573
aVI've never seen a case where that synthetic class was actually required and never use it myself
p77574
aVYou can always obtain the correct interface pointer by casting in C#, that calls QueryInterface() and always returns the correct pointer regardless of the version
p77575
aVYour alternative is the proper workaround
p77576
as(dp77577
g9
V17034
p77578
stp77579
a((dp77580
g2
(lp77581
VA publisher policy is explicitly designed to do this, not considering it to solve your problem doesn't make a lot of sense
p77582
aVGiven that your update is 'backward compatible', a no-hassle approach would be to simply not change the [AssemblyVersion] but only increment the [AssemblyFileVersion]
p77583
as(dp77584
g9
V17034
p77585
stp77586
a((dp77587
g2
(lp77588
VThe standard "one thread per one core" doesn't apply here
p77589
aVThe thread does a great deal of waiting for the slow connection and I/O to complete
p77590
aVSince a thread involved with sockets rarely does any real work in general, using asynchronous sockets very quickly become a win
p77591
aVThis changes if the async completion handler itself is doing a lot of waiting for I/O (maybe a disk or dbase), the threadpool scheduler can take a while to catch up with workers that don't complete yet don't burn cycles
p77592
aVExtra TP threads are added only twice a second
p77593
as(dp77594
g9
V17034
p77595
stp77596
a((dp77597
g2
(lp77598
VUse a specific InstanceName, not _Total
p77599
aVUse Perfmon
p77600
aVexe to find the instance names
p77601
as(dp77602
g9
V17034
p77603
stp77604
a((dp77605
g2
(lp77606
VYou were already warned about this in a previous question
p77607
aVDelete that code
p77608
as(dp77609
g9
V17034
p77610
stp77611
a((dp77612
g2
(lp77613
VCheck your preprocessor definitions
p77614
aVRemove _AFXEXT
p77615
as(dp77616
g9
V17034
p77617
stp77618
a((dp77619
g2
(lp77620
VBackgroundWorker explicitly supports marshaling to the UI thread
p77621
aVYou have to use it though, call its ReportProgress() method
p77622
aVWhile optimized for reporting progress, you don't have to use it for that
p77623
aVThere's an overload that accepts an object, you can pass anything you want
p77624
aVThe event handler gets it as the e
p77625
aVUserState value
p77626
aVFrom there, you could use that object directly or use it to re-raise another set of events
p77627
aVDo beware thread-safety requirements for that object
p77628
aVThe worker keeps running and is not in any way synchronized with the execution of the ProgressChanged event handler
p77629
aVSo it should no longer update the object
p77630
aVBest to create a new instance of it after calling ReportProgress()
p77631
as(dp77632
g9
V17034
p77633
stp77634
a((dp77635
g2
(lp77636
VThe 'children' of the ToolbarWindow32 are not windows
p77637
aVThey are toolbar buttons
p77638
aVYou'd use the TB_BUTTONCOUNT message to retrieve the number of buttons, TB_GETBUTTONINFO message to retrieve info about such a button
p77639
aVQuite hard to do btw since the window belongs to another process, just using SendMessage() doesn't work because the pointer isn't valid
p77640
aVAnd ultimately futile, such a button doesn't contain any information about what kind of process is associated with the icon
p77641
aVThat's info that's buried inside the shell, you can't get to it
p77642
as(dp77643
g9
V17034
p77644
stp77645
a((dp77646
g2
(lp77647
VIt is stored as a resource in the System
p77648
aVWindows
p77649
aVForms
p77650
aVdll assembly
p77651
aVYou could get a copy with Reflector
p77652
aVOpen the assembly, open the Resources node, all the way down to "wfc
p77653
aVico"
p77654
aVRight-click, Save As
p77655
aVNot sure why you'd want to use it, given that it is the default
p77656
aVYou set a custom icon for your application with Project + Properties, Application tab, Icon setting
p77657
aVEach form has its own Icon property
p77658
as(dp77659
g9
V17034
p77660
stp77661
a((dp77662
g2
(lp77663
VYou have to specify the configuration after the /build option
p77664
aVAlso, the log file must already exist, it doesn't create one from scratch
p77665
aVThus:
p77666
as(dp77667
g9
V17034
p77668
stp77669
a((dp77670
g2
(lp77671
VThe STL classes, like vector<>, have a layout mismatch between the release and the debug builds, caused by iterator debugging support
p77672
aVYour problem behaves exactly like the kind of trouble you get into when you link a debug build of a
p77673
aVlib or DLL in the release build of your application and exchange an STL object between them
p77674
aVHeap corruption and access violation exceptions are the result
p77675
aVTriple check your build settings and ensure that you only ever link the release build of the
p77676
aVlibs in your Release build and the debug build of the
p77677
aVlibs in your Debug build
p77678
as(dp77679
g9
V17034
p77680
stp77681
a((dp77682
g2
(lp77683
VNothing, it is just a delegate like any other
p77684
aVThere's no logical difference between the snippets, the JIT compiler generates the same code
p77685
aVPick the style you prefer
p77686
as(dp77687
g9
V17034
p77688
stp77689
a((dp77690
g2
(lp77691
VYour GetHashCode() implementation isn't guaranteed to return the same value for two objects that are equal
p77692
aVSince you only require a match on, say, WebId
p77693
aVThe Uri then screws up the hash code
p77694
aVOr the other way around
p77695
aVYou cannot fix this, other than by returning 0
p77696
aVThat's going to kill the HashSet<> perf, lookup will be O(n) instead of O(1)
p77697
as(dp77698
g9
V17034
p77699
stp77700
a((dp77701
g2
(lp77702
VRule number one is that it should not be larger than 16 bytes
p77703
aVTypically 4 fields
p77704
aVThe jitter generated code takes a nasty nosedive when it gets larger than that
p77705
aVThat's not compatible with "bunch of variables"
p77706
aVThere's nothing wrong with a simple class
p77707
as(dp77708
g9
V17034
p77709
stp77710
a((dp77711
g2
(lp77712
VYou have to look at the exception's InnerException to find the reason that the TypeInitializationException got raised
p77713
aVIt's impossible to guess what's wrong without that information
p77714
aVWhat ever code generated the error log needs a bit of work so that it doesn't forget to display the inner exception as well
p77715
aVThat's automatic if you use the Exception
p77716
aVToString() method
p77717
aVImplement an event handler for AppDomain
p77718
aVCurrentDomain
p77719
aVUnhandledException if necessary, log the value of e
p77720
aVExceptionObject
p77721
aVToString()
p77722
as(dp77723
g9
V17034
p77724
stp77725
a((dp77726
g2
(lp77727
VIt is COM's FileNotFound error
p77728
aVIn this case it is very likely to be a bitness problem
p77729
aVThe registry keeps COM registration for 32-bit and 64-bit servers separate
p77730
aVStrongly indicated by it working when you run wscript
p77731
aVexe from the syswow64 directory, that's the home for 32-bit executables
p77732
aVA 64-bit process won't be able to find the 32-bit server in the registry
p77733
aVNor will it be able to use it
p77734
aVRepro that by running c:\u005cwindows\u005csystem32\u005cwscript
p77735
aVexe
p77736
aVYou will first have to build the x64 version of the COM server so a 64-bit process can use it
p77737
aVThen you will have to register it with the 64-bit version of Regsvr32
p77738
aVexe, the one in c:\u005cwindows\u005csystem32, not syswow64
p77739
aVIf you still have trouble then use SysInterals' ProcMon utility to find out where the process is looking in the registry and file system
p77740
aVOr get IIS to run in 32-bit mode
p77741
aVThat's another question that needs different tags
p77742
as(dp77743
g9
V17034
p77744
stp77745
a((dp77746
g2
(lp77747
VThat's difficult in
p77748
aVNET
p77749
aVAn ActiveX control requires a wrapper to give it a hospitable home
p77750
aVThat wrapper is implemented by the AxHost class
p77751
aVUnfortunately you cannot use this class directly in code, its constructors are protected
p77752
aVIt was designed to be used by the AxImp
p77753
aVexe tool
p77754
aVThat tool auto-generates a
p77755
aVNET class that derives from AxHost
p77756
aVThe resulting class is then readily usable as a control
p77757
aVProblem is, that tool needs to be run up front, while you design your form
p77758
aVThat's never a real problem, except here
p77759
aVThe best you could do is create wrappers with AxImp for any of the ActiveX controls you might ever find in that script up front
p77760
aVIt is likely to be a limited subset
p77761
aVThen have the script interpreter select the correct wrapper, based on the clsid
p77762
aVDoing it dynamically like you intended requires you to create your own wrapper
p77763
aVAxHost is however not a small class and ActiveX hosting is quite unpleasant with many details to take care of
p77764
as(dp77765
g9
V17034
p77766
stp77767
a((dp77768
g2
(lp77769
VThis is the kind of app that users hate with a passion, nobody likes a machine forcing them to do things
p77770
aVThey'll try everything they can to get rid of it or sabotage it
p77771
aVAny data it collects is junk
p77772
aVVista partly solved the problem, services cannot do this anymore
p77773
aVDon't waste your time on it
p77774
as(dp77775
g9
V17034
p77776
stp77777
a((dp77778
g2
(lp77779
VHmya, the enduring mystique of DoEvents()
p77780
aVThere's been an enormous amount of backlash against it, but nobody ever really explains why it is "bad"
p77781
aVThe same kind of wisdom as "don't mutate a struct"
p77782
aVErm, why does the runtime and the language supports mutating a struct if that's so bad
p77783
aVSame reason: you shoot yourself in the foot if you don't do it right
p77784
aVEasily
p77785
aVAnd doing it right requires knowing exactly what it does, which in the case of DoEvents() is definitely not easy to grok
p77786
aVRight off the bat: almost any Winforms program actually contains a call to DoEvents()
p77787
aVIt is cleverly disguised however with a different name: ShowDialog()
p77788
aVIt is DoEvents() that allows a dialog to be modal without it freezing the rest of the windows in the app
p77789
aVMost programmers want to use DoEvents to stop their user interface from freezing when they write their own modal loop
p77790
aVIt certainly does that, it dispatches Windows messages and gets any paint requests delivered
p77791
aVThe problem however is that it isn't selective
p77792
aVIt not only dispatches paint messages, it delivers everything else as well
p77793
aVAnd there's a set of notifications that cause trouble
p77794
aVThey come from about 3 feet in front of the monitor
p77795
aVThe user could for example close the main window while the loop that calls DoEvents() is running
p77796
aVThat works, user interface is gone
p77797
aVBut your code didn't stop, it is still executing the loop
p77798
aVThat's bad
p77799
aVVery, very bad
p77800
aVThere's more: the user could click the same menu item or button that causes the same loop to get started
p77801
aVNow you have two nested loops executing DoEvents(), the previous loop is suspended and the new loop is starting from scratch
p77802
aVThat could work, but boy the odds are slim
p77803
aVEspecially when the nested loop ends and the suspended one resumes, trying to finish a job that was already completed
p77804
aVIf that doesn't bomb with an exception then surely the data is scrambled all to hell
p77805
aVBack to ShowDialog()
p77806
aVIt executes DoEvents() but do note that it does something else
p77807
aVIt disables all the windows in the application, other than the dialog
p77808
aVNow that 3 feet problem is solved, the user cannot do anything to mess up the logic
p77809
aVBoth the close-the-window and start-the-job-again failure modes are solved
p77810
aVOr to put it another way, there is no way for the user to make your program run code in a different order
p77811
aVIt will execute predictably, just like it did when you tested your code
p77812
aVIt makes dialogs extremely annoying, who doesn't hate having a dialog active and not being able to copy and paste something from another window
p77813
aVBut that's the price
p77814
aVWhich is what it takes to use DoEvents safely in your code
p77815
aVSetting the Enabled property of all your forms to false is a quick and efficient way to avoid problems
p77816
aVOf course, no programmer ever actually likes doing this
p77817
aVAnd doesn't
p77818
aVWhich is why you shouldn't use DoEvents()
p77819
aVYou should use threads
p77820
aVEven though they hand you a complete arsenal of ways to shoot your foot in colorful and inscrutable ways
p77821
aVBut with the advantage that you only shoot your own foot, it won't (typically) let the user shoot hers
p77822
aVThe next versions of C# and VB
p77823
aVNET will provide a different gun with the new await and async keywords
p77824
aVInspired in small part by the trouble caused by DoEvents and threads but in large part by WinRT's api design that requires you to keep your UI updated while an asynchronous operation is taking place
p77825
aVLike reading from a file
p77826
as(dp77827
g9
V17034
p77828
stp77829
a((dp77830
g2
(lp77831
VThere's a nasty bug in the interaction between the operating system and the 64-bit debugger
p77832
aVIt causes exceptions that are raised in the Load event handler (or OnLoad method override) to be swallowed without a diagnostic
p77833
aVBest way to bypass it is to use Project + Properties, Build tab, Platform target = x86
p77834
aVThat's the default for VS2010 and also re-enables Edit + Continue
p77835
aVNice
p77836
aVIf running in 64-bit mode is really important then you can trap the exception with Debug + Exceptions, tick the Thrown box for Common Language Runtime exceptions
p77837
aVThis bug otherwise doesn't byte in your final program, it only goes wrong when a debugger is attached
p77838
as(dp77839
g9
V17034
p77840
stp77841
a((dp77842
g2
(lp77843
VThe last moment of a day is at midnight minus the smallest measurable time increment
p77844
aVWhich is up to you to define, it will be a second when you format it to a string
p77845
aVIt will be 1/64th of a second for the operating system
p77846
aVIt will be a fraction of a picosecond on NIST's atomic clocks
p77847
aVIt is 100 nanoseconds for the DateTime structure
p77848
as(dp77849
g9
V17034
p77850
stp77851
a((dp77852
g2
(lp77853
VIt is not just for your own benefit, COM requires you to create a message loop
p77854
aVCOM needs it to handle apartment threaded COM servers, an expensive word for "components that don't support multi-threading"
p77855
aVThe vast majority of them don't
p77856
aVIt is best to create a window, it doesn't have to be visible
p77857
aVThat gives you a HWND that you can use in your SendMessage() calls
p77858
aVThe window procedure you write can process the messages
p77859
aVFrom there, it gets to be easy to create a minimal user interface, with Shell_NotifyIcon for example
p77860
aVAlways nice when you can display a notification when something goes wrong
p77861
aVSo much better then an event in a log that nobody ever looks at
p77862
as(dp77863
g9
V17034
p77864
stp77865
a((dp77866
g2
(lp77867
VThe ContextMenuStrip
p77868
aVShow(Point) overload requires the point to be in screen coordinates
p77869
aVFix:
p77870
aVor use Control
p77871
aVPointToScreen()
p77872
as(dp77873
g9
V17034
p77874
stp77875
a((dp77876
g2
(lp77877
VA Word
p77878
aVdoc document is not a text file
p77879
aVIt contains lots of binary data, the stuff that keeps track of styles, fonts, paragraph formatting, etcetera, etcetera
p77880
aVWhich is the junk you see
p77881
aVYou cannot realistically read such a file yourself, or for that matter display the document accurately, you have to use Word
p77882
aVYou can automate it with the classes in the Microsoft
p77883
aVOffice
p77884
aVInterop
p77885
aVWord namespace
p77886
aVAn intermediary solution is to store Word documents in the RTF file format
p77887
aVAs long as the formatting doesn't get too fancy, a RichTextBox can display it accurately
p77888
aVStoring it in a dbase column isn't hard either, it is text
p77889
as(dp77890
g9
V17034
p77891
stp77892
a((dp77893
g2
(lp77894
VDo you really have to read the entire file
p77895
aVRead only half of it
p77896
aVWhen the user is ready to look at another 'file' or set of dates, read the other half
p77897
aVPick your own number here to find the best balance
p77898
as(dp77899
g9
V17034
p77900
stp77901
a((dp77902
g2
(lp77903
V0xE0434F4D is the exception code for a managed exception
p77904
aVBy the time you get that code it is already too late
p77905
aVThe exception was unhandled, there's no live code left to interpret the exception
p77906
aVImproving error handling at such an early stage of the CLR booting up requires hosting the CLR yourself
p77907
aVGoogle CorBindToRuntimeEx to find the boilerplate code that's required
p77908
aVWriting a better installer that ensures that
p77909
aVNET 4
p77910
aV0 is properly deployed on the machine might be a more fruitful plan of attack
p77911
aVIt is really simple with a Setup project
p77912
as(dp77913
g9
V17034
p77914
stp77915
a((dp77916
g2
(lp77917
VEdit and Continue doesn't support all possible code changes
p77918
aVIt is well documented in the MSDN library, I'll repro the list here:
p77919
aVChanges to the current statement or any other active statement
p77920
aVChanges to global symbols, including the following:
p77921
aVAdding new types
p77922
aVAdding methods to a type
p77923
aVChanging the signature of a type
p77924
aVAdding fields, events, or properties to a type
p77925
aVEditing an anonymous method or any method that contains an anonymous method
p77926
aVAdding a new anonymous method
p77927
aVAdding, removing, or changing attributes
p77928
aVAdding, removing, or changing using directives
p77929
aVRemoving or changing local variables
p77930
aVAdding local variables is allowed
p77931
aVAdding a foreach, using, or lock around the active statement
p77932
aVModifying a method that contains a yield return or yield break statement
p77933
aVChanging a constructor with a field that is initialized by an anonymous method
p77934
aVYou are running afoul of the "Changing the signature of a type" limitation
p77935
as(dp77936
g9
V17034
p77937
stp77938
a((dp77939
g2
(lp77940
VThis sure looks like a compiler bug to me
p77941
aVThe IL suggests the compiler is generating code to convert the MyDouble
p77942
aVto a double with the conversion operator, then to a double
p77943
aVBut takes a nosedive when it then uses the conversion operator again on that double
p77944
aVThat's bad, wrong argument type
p77945
aVNor is there a need
p77946
aVThis feedback article resembles this bug
p77947
aVOver 6 years old already, that must be a tricky part of the compiler
p77948
aVI do imagine it is
p77949
as(dp77950
g9
V17034
p77951
stp77952
a((dp77953
g2
(lp77954
VThe BigInteger class was written by Melitta Andersen of the BCL team, her first project
p77955
aVIt was actually shipped in
p77956
aVNET 3
p77957
aV5 but was hidden, the class was marked internal
p77958
aVNot to become public until
p77959
aVNET 4
p77960
ag2512
aVShe also wrote a floating point version, called BigRational
p77961
aVSimilar problem, didn't make it into
p77962
aVNET 4
p77963
ag2512
aVThese are strange and unexplainable decisions whose reasoning I'm not privy to
p77964
aVNevertheless, the source code for BigRational is available
p77965
aVYou can download it here
p77966
as(dp77967
g9
V17034
p77968
stp77969
a((dp77970
g2
(lp77971
VThis is fairly miraculous
p77972
aVGetting the tabbing to stop at a label is very hard, it doesn't want the focus
p77973
aVIts constructor sets the TabStop property to false
p77974
aVWhat is even harder is seeing that the label has the focus, it doesn't have any way to indicate it
p77975
aVWhich begs the question how you know that the label got the focus
p77976
aVTriple check this, you might be mis-interpreting what is really going on
p77977
aVLike having the wrong TabIndex value on the rest of the controls
p77978
aVView + Tab Order is a very handy designer command that makes the tabbing order easy to see and modify
p77979
as(dp77980
g9
V17034
p77981
stp77982
a((dp77983
g2
(lp77984
VThe last line in your question is hard to decode
p77985
aVBut if you mean, "can I use InvokeMember to change the focus" instead of using SendKeys, then yes
p77986
aVUse InvokeMember("focus")
p77987
aVIf you do it right then you don't need SendKeys at all anymore
p77988
aVWhich means that you don't need "focus" either
p77989
aVMost of the important methods and properties of a element in the DOM are documented in the MSDN library docs for IHTMLElement and IHTMLElement2
p77990
aVSeveral of them (but not all, like "click") are wrapped by the Winforms HtmlElement class, including the Focus() method
p77991
aVThe HtmlDocument
p77992
aVActiveElement property provides a reference to the element that currently has the focus
p77993
as(dp77994
g9
V17034
p77995
stp77996
a((dp77997
g2
(lp77998
VUnhandled exception at 0x7c812aeb in "foo
p77999
aVexe": OxE0434f4d: 0xe0434f4d
p78000
aV0xe0434f4d is the exception code for a managed exception
p78001
aVThe managed code you wrote is bombing, there is no handler anywhere that catches that exception
p78002
aVThat's a kaboom without a decent diagnostic if you don't run the debugger in managed mode
p78003
aVYou'll need to use the try/catch keywords in the C++/CLI code to catch System::Exception, generate a diagnostic from the caught exception object's ToString() value and pass some kind of "he's dead Jim" status code back to your native code
p78004
aVDon't try to continue using the managed code after this, it's dead with an unpredictable state
p78005
as(dp78006
g9
V17034
p78007
stp78008
a((dp78009
g2
(lp78010
VYou have to use the CallingConvention property in the [DllImport] attribute, this is Cdecl since you didn't use __stdcall in the native function declaration
p78011
aVWhile that's wrong, it is not a great explanation for the AV
p78012
aVYou need to debug the C code, the AV suggests it has a pointer bug
p78013
aVProject + Properties, Debug, tick "Enable unmanaged code debugging" and set a breakpoint on the C function
p78014
aVFrankly, a date conversion like this should be written in pure C#
p78015
as(dp78016
g9
V17034
p78017
stp78018
a((dp78019
g2
(lp78020
VThere are several ways to deal with this
p78021
aVFirst one is simplest, acknowledge the fact that your app actually does have a dependency on the target architecture
p78022
aVAnd that AnyCPU isn't the proper setting
p78023
aVIt is very rare to need the humongous virtual address memory space you get from x64, especially since you also want and need to make it work on x86
p78024
aVSo set the Platform target of the EXE to x86 and you're done
p78025
aVSecond is concluding that this is simply a deployment problem
p78026
aVAll you have to do is copy the x64 build of the mixed-mode assembly when your app is installed on a 64-bit operating system, the x86 build on a 32-bit operating system
p78027
aVYou'll need to create a Setup project that takes care of this
p78028
aVThe simplest way is to create two of them
p78029
aVAlso the only way afaik
p78030
aVThird is the one with bells on where it works either way, the one you no doubt are asking about
p78031
aVThis requires changes to code, project and installer
p78032
aVWhat you need to do is write a post-build event that create two subdirectories with names like "x86" and "x64"
p78033
aVAnd copy the respective version of the DLL into them
p78034
aVThis ensures that the CLR cannot find these assemblies
p78035
aVIn your code you must write an event handler for the AppDomain
p78036
aVCurrentDomain
p78037
aVAssemblyResolve event
p78038
aVSubscribe it in your Main() method, well before you try to use any types from the assembly
p78039
aVThe event handler must use Assembly
p78040
aVLoadFrom() to load the correct assembly from the subdirectory, based on the value of IntPtr
p78041
aVSize
p78042
aVIt is 8 when you run in 64-bit mode
p78043
aVI should mention yet another approach but that's generally frowned-upon at SO
p78044
aVInstall both assemblies into the GAC
p78045
aVEverything is automatic
p78046
as(dp78047
g9
V17034
p78048
stp78049
a((dp78050
g2
(lp78051
VHKCR is an alias for HKLM\u005cSoftware\u005cClasses but it doesn't show everything
p78052
aVLook in HKLM\u005cSoftware\u005cWow6432Node\u005cClasses\u005cCLSID for the registered {guid}
p78053
aVWhich is where c:\u005csystem32\u005csyswow64\u005cregsvr32
p78054
aVexe writes them
p78055
aVYou did mention that you already tried that
p78056
aVThere's something really wrong with that, you cannot arbitrarily run either version of Regsvr32
p78057
aVexe and get the same DLL registered
p78058
aVA 32-bit DLL cannot be loaded in a 64-bit process
p78059
aVIn other words, there's no way for the 64-bit version of Regsvr32
p78060
aVexe to register a 32-bit COM server
p78061
aVAnd the other way around
p78062
aVWhy you didn't get an error message is unguessable from here, the only sane explanation is that you somehow didn't actually run the right version of Regsvr32
p78063
aVTo really debug this, use SysInternals' ProcMon utility
p78064
aVIts trace shows you how the ATL registrar is writing the keys in the registry
p78065
as(dp78066
g9
V17034
p78067
stp78068
a((dp78069
g2
(lp78070
VThe result is accurate
p78071
aVThe fortran code is using 4 byte floating point (aka float or single), a format that can store only has 6
p78072
aV5 significant digits
p78073
aVPrinting more just produces random noise digits
p78074
aVUse real*8 to improve the accuracy to 15 significant digits
p78075
aVOr modify the print statement to show no more than 6 digits
p78076
as(dp78077
g9
V17034
p78078
stp78079
a((dp78080
g2
(lp78081
VThis is an annoyance of the C++ language, inherited by C++/CLI
p78082
aVIt puts the names of types and the names of class members in the same symbol table
p78083
aVThis is something you'll battle often when you write Winforms code in C++/CLI instead of C# or VB
p78084
aVNET, languages that keep type identifiers separate
p78085
aVThere's an ambiguity between the MouseButtons enum type and the Form class' MouseButtons property, they are both in scope here
p78086
aVIntelliSense stops helping you to get the syntax right which is probably how you ended up with
p78087
aVinstead of :: Leaving no odds anymore to get a decent compiler error message
p78088
aVYou resolve the ambiguity by writing the enum type name in full:
p78089
aVProblems like these are probably one reason that C++/CLI never got very popular
p78090
aVThen again, C# is rather a class act
p78091
aVRecommended
p78092
as(dp78093
g9
V17034
p78094
stp78095
a((dp78096
g2
(lp78097
VThe
p78098
aVNET framework language pack doesn't cover JScript resources
p78099
aVThere's a separate download for that
p78100
aVThe link I gave you is for English, you have to change the Language choice
p78101
aVBut Portuguese is not listed, I seriously doubt that language is supported
p78102
aVAnd is not going to be either, JScript is deprecated
p78103
aVWell, no joy
p78104
aVNothing much you can do but fail the ResourceResolve event
p78105
aVReturn null so it uses the default exception message text
p78106
as(dp78107
g9
V17034
p78108
stp78109
a((dp78110
g2
(lp78111
VToUnicodeEx()
p78112
aVIt doesn't work in practice unless the keyboard layout is simple
p78113
aVThe dead keys is what kills you
p78114
aVMichael Kaplan wrote an 11 part blog serial about it but afaict he just gave up without finishing it
p78115
aVSee what you can salvage from it but don't get your hopes up
p78116
aVChinese use an IME, an Input Method Editor
p78117
aVSoftware, I think it builds up the character by strokes
p78118
as(dp78119
g9
V17034
p78120
stp78121
a((dp78122
g2
(lp78123
VThere are very few ways to explain the problem, other than there's a problem with the app that reads the file
p78124
aVBeware that you are writing a
p78125
aVtxt file, it might not necessarily be compatible with a
p78126
aVtkt file format
p78127
aVWhatever that looks like
p78128
aVFor one, the file will contain a BOM, 3 bytes at the start of the file that says it is a utf-8 formatted text file
p78129
aVOne thing you could try to diagnose the problem better:
p78130
aVThe Encoding argument specifies that the characters should be written in the default code page and without a BOM
p78131
as(dp78132
g9
V17034
p78133
stp78134
a((dp78135
g2
(lp78136
VThis is entirely normal
p78137
aVThe outer quotes are added because this is a string
p78138
aVThe inner quote is doubled to escape it
p78139
aVSame kind of thing you'd see in a SQL query for example
p78140
aVUse the TextFieldParser class to have tried and true framework code care of the parsing of this for you automatically
p78141
as(dp78142
g9
V17034
p78143
stp78144
a((dp78145
g2
(lp78146
VIt is a 'metadata token', it references an item in the tables in the metadata of the assembly
p78147
aVThe first hex pair indicates the table type, the next 3 pairs is just a sequence number for the table row
p78148
aVTable 0x01 is the TypeRef table, table 0x02 is the TypeDef table
p78149
aVThis is described well in excruciating detail in Ecma-335, the standards document for the Common Language Infrastructure
p78150
aVMissed the question, adding: an interface type does not have to inherit anything
p78151
aVUnlike a class which always derives from System
p78152
aVObject
p78153
aVWhich makes metadata token 0x01000000 likely to mean "nothing"
p78154
aVThe actual table entries are however not fixed, you'd normally have to look in the table
p78155
aVIldasm does it for you
p78156
as(dp78157
g9
V17034
p78158
stp78159
a((dp78160
g2
(lp78161
VIf a tree falls in the forest with no one around to hear, does it make a sound
p78162
aVMake sure it does:
p78163
aVThe finalizers of any objects left at program termination are called just before the process terminates
p78164
aVThe only way this won't happen is when the process is rudely aborted
p78165
aVEnvironment
p78166
aVExit() for example
p78167
as(dp78168
g9
V17034
p78169
stp78170
a((dp78171
g2
(lp78172
VThe handling of the pcount variable is really unclear, but sure looks wrong
p78173
aVI'm guessing it counts words written on each line
p78174
aVWhen it reaches 9, you'd only want to output a crlf, then reset the value back to 0
p78175
aVThat's not happening, it will equal 9 only once
p78176
aVThe next thing to watch out for is what the helper functions do to the register variables
p78177
aVI don't remember the exact rules but I think you can only assume that the values of esi and edi are preserved
p78178
aVYou need to push/pop the rest
p78179
aVUse the debugger
p78180
as(dp78181
g9
V17034
p78182
stp78183
a((dp78184
g2
(lp78185
VThe auto-complete list is shown as long as the text box as the focus
p78186
aVClicking outside of the text box is indeed one way to get the text box to lose focus
p78187
aVBut that does require that you click on something that wants to receive the focus
p78188
aVThe form doesn't, it has no use for it, that's why it doesn't work
p78189
aVGetting a window to see mouse events that occur outside of the window requires capturing the mouse
p78190
aVWinforms supports that with the Control
p78191
aVCapture property
p78192
aVSet it to true and all mouse message are directed to the control, even if the mouse is no longer close to the window
p78193
aVYou'd use the MouseDown event and check the mouse position against the window client area to detect that the mouse was clicked outside of the window
p78194
aVThat's the way that menus work for example
p78195
aVClick outside of the menu and it disappears
p78196
aVThis is however very tricky to get right for a text box
p78197
aVThe mouse is only captured until you cancel it yourself or you click a mouse button
p78198
aVWhile there's only one reason to click the mouse for a menu, to click a menu item, there are lots of reasons for the user to click the mouse for a text box
p78199
aVSelecting text, changing the insertion point, bringing up the context menu
p78200
aVAll operations that will cancel the capture, you'd have to re-capture
p78201
aVWhich is very hard to do
p78202
aVThe context menu makes it especially tricky because you can only re-capture after it disappeared
p78203
aVNow you have to write code that detects it closing, not directly supported in Winforms
p78204
aVThis is not practical, which is why the auto-complete list only disappears when the text box loses the focus
p78205
aVMaybe you can make it work by restricting the way the text box work
p78206
aVDisabling the context menu for example
p78207
aVNot so sure that's a good idea
p78208
aVYou can make it work by screening mouse messages before they are delivered
p78209
aVIt is a very heavy handed approach but will work
p78210
aVYou get the messages by implementing IMessageFilter
p78211
as(dp78212
g9
V17034
p78213
stp78214
a((dp78215
g2
(lp78216
VI think you are the victim of a crummy example, it doesn't actually demonstrate the problem
p78217
aVA better example of doing it wrong is adding this constructor:
p78218
aVNow the client code could use the attribute this way:
p78219
aVand this way:
p78220
aVBoth are equally valid, the client programmer won't be able to make up his mind which one to choose
p78221
aVA much nastier example would be this constructor:
p78222
aVwhich allows:
p78223
as(dp78224
g9
V17034
p78225
stp78226
a((dp78227
g2
(lp78228
VThere's no way to crop the image that I see with the MODI object model
p78229
aVThe alternative is to provide it with an image that contains just the order number you want to convert
p78230
aVYou can use the classes in the System
p78231
aVDrawing namespace to create it from the original
p78232
aVCheck this MSDN page for sample code
p78233
as(dp78234
g9
V17034
p78235
stp78236
a((dp78237
g2
(lp78238
VYou cannot use AllUsersApplicationData in this scenario, neither in the installer nor in your application
p78239
aVThe installer cannot guess the version number correctly
p78240
aVJust make your own so that the installer can compute the path and get the right directory
p78241
aVUse Environment
p78242
aVGetFolderPath(Environment
p78243
aVSpecialFolder
p78244
aVCommonApplicationData) and append your company and product name
p78245
aVAnd you probably want to append a version number
p78246
aVThis version should be the version of the application data, not the application
p78247
aVJust make up your own, start at "1
p78248
aV0"
p78249
aVThe installer now has no trouble doing the same
p78250
as(dp78251
g9
V17034
p78252
stp78253
a((dp78254
g2
(lp78255
VIt gets slow with that many controls, 37 of them is just rather a lot
p78256
aVFor comparison, Microsoft Outlook uses about 50 windows, you've got 38 for just a control
p78257
aVIt gets extra slow because of transparency effects on those controls
p78258
aVThe OnPaint() method runs so often to provide the background pixels of the controls
p78259
aVYou can't always fix that, a Button for example is going to let its parent draw the background even if it is not transparent
p78260
aVControls are very convenient but they are not cheap
p78261
aVOnly one way to really get ahead here: stop using so many controls and stop trying to support transparency
p78262
aVNot sure what you use, but a Label for example is especially wasteful
p78263
aVUsing TextRenderer
p78264
aVDrawText in your OnPaint method also can draw a label, minus the cost of a Control
p78265
as(dp78266
g9
V17034
p78267
stp78268
a((dp78269
g2
(lp78270
VOne stack for each thread, all threads share the same heaps
p78271
aVThere is no 'sequential flow' of threads
p78272
aVA thread is an operating system object that stores a copy of the processor state
p78273
aVThe processor state includes the register values
p78274
aVOne of them is ESP, the stack pointer
p78275
aVAnother really important one is EIP, the instruction pointer
p78276
aVWhen the operating system switches between threads, it stores the processor state in the current thread object and reloads the state from the thread object for the thread that was selected to run next
p78277
aVThe processor now simply continues executing where it left off previously
p78278
aVGetting a thread started is perhaps now easy to understand as well
p78279
aVThe operating system allocates a megabyte of memory for the stack
p78280
aVAnd initializes the ESP register value to point to that memory
p78281
aVAnd sets the value of the EIP register to the address of the method where the thread should start executing
p78282
aVThe value of the ThreadStart delegate in C#
p78283
as(dp78284
g9
V17034
p78285
stp78286
a((dp78287
g2
(lp78288
VThe Microsoft CRT supports BOM auto-detection since VS2005
p78289
aVYou enable it by using the "ccs" attribute in the mode argument
p78290
aVLike this:
p78291
aVIt falls back to ansi if the file doesn't have a BOM
p78292
aVYou can use "UTF-8" or "UTF-16LE" for troublemakers like that
p78293
aVThis is of course non-standard
p78294
as(dp78295
g9
V17034
p78296
stp78297
a((dp78298
g2
(lp78299
VThis is not the way it works
p78300
aVI'm guessing the source code got checked-in to source control and the files are now read-only
p78301
aVYou have to check them out to make them editable
p78302
aVTalk to the members of your team about this
p78303
as(dp78304
g9
V17034
p78305
stp78306
a((dp78307
g2
(lp78308
VNo, VS2010 will convert the VS2008 project file
p78309
aVAfter it is converted, VS2008 can no longer open it
p78310
aVThere are ways to hack around this, the simple solution is to just use VS2010 consistently
p78311
aVNext best thing is to only check-in the source code changes
p78312
aVNext best thing is to give the 2010 project a different name and maintain them both, at least for now
p78313
as(dp78314
g9
V17034
p78315
stp78316
a((dp78317
g2
(lp78318
VThat's a rather technical implementation detail
p78319
aVTo get started, you first have to understand the structure of a PE32 file, the file format for DLLs and EXEs in Windows
p78320
aVThe canonical article for that is Matt Pietrik's "Peering Inside the PE, A Tour of the Win32 Portable Executable File Format"
p78321
aVWritten 17 years ago but still relevant and available
p78322
aVThe /filealign setting refers to the value of IMAGE_OPTIONAL_HEADER
p78323
aVFileAlignment field
p78324
aVIt determines how the raw data in a section is aligned
p78325
aVA section is a chunk of code or data in the file
p78326
aVAlmost exclusively data in the case of pure
p78327
aVNET assemblies
p78328
aVThere is a very close relationship between the file format and the disk
p78329
aVAn executable image is used as the backing file of a Memory Mapped File in Windows
p78330
aVExecutables are loaded by mapping the file into the virtual memory address space
p78331
aVVery efficient, loading a DLL only involves creating that mapping, no actual data is read from the file
p78332
aVThat happens in a lazy fashion when the process tries to read a byte from a section
p78333
aVIf it isn't loaded into memory yet, that produces a page fault and the operating system reads 4096 bytes from the file into memory
p78334
aVThe big advantage is that you don't pay for data or code that you don't use
p78335
aVAlso the reason that reading [attributes] is expensive when you read it the first time
p78336
aVThe relevance of the file alignment is how the raw data in the sections line up
p78337
aVMost modern executables that contain machine code use an alignment of 4096 bytes, the size of a virtual memory page
p78338
aVThat isn't very relevant for assemblies containing managed code, IL is just data
p78339
aVWhich would make it sense to use a smaller alignment, one that wastes less space
p78340
aV512 bytes (not kilobytes) is a happy number there, it is the smallest value allowed in the PE32 format
p78341
aVThe only possible reason I can think of for adding the option to the UI at all is that the C# compiler has very few compile options compared to other compilers
p78342
aV"Other" being compilers that generate native code
p78343
aVSo the option is there because the compiler has the option
p78344
aVA lot of the tweaks are covered by [attributes], nicely making the compiler command line short and snappy
p78345
aVBut no attribute for the file alignment, it needs to be known before generating the file, an attribute would be too late
p78346
aVThe opposite example is the C++ compiler and linker, the IDE offers nineteen property pages to set them
p78347
aVBut still not covering them all, the really obscure ones have to be set in the "Command Line" option page
p78348
as(dp78349
g9
V17034
p78350
stp78351
a((dp78352
g2
(lp78353
VYes they did
p78354
aVOCR gets really inaccurate without a relevant dictionary and fragments that don't provide context
p78355
aVSo do humans: ABC123, ABCI23, ABCl23
p78356
aVThree different strings
p78357
aVThis is solved in practice by using special fonts that minimize the odds that letters and numbers are ambiguous, the kind you see on a bank check
p78358
as(dp78359
g9
V17034
p78360
stp78361
a((dp78362
g2
(lp78363
VThere is only one calling convention for 64-bit code
p78364
aVNone of the nonsense of , ,  etcetera
p78365
aVWhoever comes up with another x64 calling convention to save a fraction of a nanosecond is going to be summarily executed
p78366
aVAccordingly, DLL exports no longer have to be decorated with leading underscore and @ characters
p78367
aVThe exported name is just plain SHA512
p78368
aVUnfortunately, that doesn't explain why your compiler still prefixes an underscore
p78369
aVSounds like you're actually using a 32-bit compiler
p78370
as(dp78371
g9
V17034
p78372
stp78373
a((dp78374
g2
(lp78375
VThere are too many nasty details involved to get IPreviewHandler wrapped cleanly
p78376
aVShockingly, it is actually mentioned in the SDK article for the interface:
p78377
aVPreview handlers can be built in
p78378
aVmanaged code
p78379
aVTypically, all preview
p78380
aVhandlers are hosted together in a
p78381
aVsurrogate process called prevhost
p78382
aVexe
p78383
aVThere is one instance of this process
p78384
aVfor preview handlers running at normal
p78385
aVintegrity level, and another instance
p78386
aVfor preview handlers running at low
p78387
aVintegrity level
p78388
aVIf you want to
p78389
aVimplement your handler in managed
p78390
aVcode, your handler should not run
p78391
aVinside either of these shared
p78392
aVprocesses
p78393
aVInstead, arrange for your
p78394
aVhandler to get a new instance of
p78395
aVprevhost
p78396
aVexe by creating a new AppID
p78397
aVentry in the registry (specifying
p78398
aVprevhost
p78399
aVexe as the DllSurrogate
p78400
aVvalue) and then setting that as the
p78401
aVAppID value in the registry value for
p78402
aVyour handler's class ID
p78403
aVThis will
p78404
aVensure that a unique prevhost
p78405
aVexe
p78406
aVinstance is created for your handler,
p78407
aVinstead of the common instances used
p78408
aVby the other handlers
p78409
aVThis is the usual headache with shell interfaces, too much pomp and circumstance to get them going
p78410
aVThe interface isn't wrapped in the code pack, I don't see how it could be wrapped cleanly with this required registry whacking
p78411
aVMaybe you can google something from the interface name
p78412
aVCodeproject
p78413
aVcom usually has something
p78414
as(dp78415
g9
V17034
p78416
stp78417
a((dp78418
g2
(lp78419
VYou have to set e
p78420
aVUseDefaultCursor = False in your GiveFeedback event handler to make your cursor change visible
p78421
aVWithout it, drag and drop always uses the default cursors
p78422
aVThe cursor you get when the mouse hovers a control is set by the Control
p78423
aVCursor property
p78424
aVChanging the Cursor
p78425
aVCurrent property has no effect, the property causes the cursor to change back instantly when you move the mouse
p78426
as(dp78427
g9
V17034
p78428
stp78429
a((dp78430
g2
(lp78431
VA ContextMenuStrip is too attractive a target for custom popup windows that don't act like a context menu
p78432
aVIt is desirable because it automatically pops down when the user clicks outside of the menu
p78433
aVIt has limitations though, it just isn't a very good control host
p78434
aVThe click problem is classical one, CMS captures the mouse to detect when the user clicks outside of the window
p78435
aVThis really ought to be a form
p78436
aVTo give it the same behavior as a CMS requires a bit of work though
p78437
aVYou have to detect mouse clicks that are off the window so you can make the window disappear
p78438
aVCapturing the mouse like CMS does doesn't work
p78439
aVOne trick is using IMessageFilter, it lets you take a peek at input messages before they are delivered to the window with the focus
p78440
aVHere's a sample form that implements this:
p78441
aVUse the designer as normal to design the form
p78442
aVYou want to at least give it a different FormBorderStyle
p78443
aVUse the provided Show() method overload the same way you use it for CMS
p78444
aVDo note that the form pops down only when you click on a window that's owned by the application, unlike a CMS
p78445
aVFeature, not a bug
p78446
as(dp78447
g9
V17034
p78448
stp78449
a((dp78450
g2
(lp78451
VYes, pretty likely
p78452
aVSendInput injects mouse events at a very low level
p78453
aVSendMessage won't work
p78454
aVYou'll need a thread since DoDragDrop is a blocking call
p78455
aVFake the mouse down first, start the thread, call DoDragDrop
p78456
aVThe thread should sleep to give enough time for DoDragDrop to get started, then fake mouse move and mouse up
p78457
aVKeep fingers crossed that it works the first time, it is impossible to debug if it doesn't
p78458
as(dp78459
g9
V17034
p78460
stp78461
a((dp78462
g2
(lp78463
VUse LoadLibraryA(), it takes a const char*
p78464
aVWinapi functions that take strings exist in two versions, an A version that takes a Ansi strings and a W version that takes wide strings
p78465
aVThere's a macro for the function name, like LoadLibrary, that expands to either the A or the W, depending if UNICODE is #defined
p78466
aVYou are compiling your program with that #define in effect, so you get LoadLibraryW()
p78467
aVSimply cheat and use LoadLibraryA()
p78468
as(dp78469
g9
V17034
p78470
stp78471
a((dp78472
g2
(lp78473
VMy crystal ball says you are using VS2010
p78474
aVProject + Properties, Application tab, Target framework setting
p78475
aVChange it from the client profile to the regular version
p78476
aVSystem
p78477
aVWeb is not included in the client profile, that's why you can't find it
p78478
aVDon't worry about the difference, the client profile is only 15% smaller than the regular version
p78479
aVThere's very little point to it
p78480
as(dp78481
g9
V17034
p78482
stp78483
a((dp78484
g2
(lp78485
VYou have a very accurate interval measurement available (gettimestamp - lastticks), but you are not using it all to compute the frame rate
p78486
aVYou assume the interval is a second, it won't be
p78487
aVIt will be more, by a random amount that's determined by how often you call ActualFPS()
p78488
aVIn Release mode you'll call ActualFPS() more frequently so the error is less
p78489
aVDivide runsThisSecond by (gettimestamp - lastticks) converted to seconds
p78490
as(dp78491
g9
V17034
p78492
stp78493
a((dp78494
g2
(lp78495
VYou have to replace it, the native Windows progress bar doesn't support custom colors when visual styles are enabled
p78496
aVThe colors are selected by the theme that the user preferred
p78497
aVReplacing the progress bar used to be quite easy, it didn't do anything fancy
p78498
aVThat got to be a lot harder at Vista though when it got the sub-step interpolation and animation features
p78499
aVReproducing that takes a lot of code that you probably don't want to maintain
p78500
aVRealistically, make your own by deriving a class from Control, using LinearGradientBrush or PathGradientBrush in the OnPaint method and keep it static
p78501
aVOr stick with what the user selected, she won't be disappointed
p78502
as(dp78503
g9
V17034
p78504
stp78505
a((dp78506
g2
(lp78507
VaPokerTable { numPlayers=2990892 numPlaying=9 dealerPos=9
p78508
ag9555
aVNote that dealerPos got assigned the value 9, that's wrong as well
p78509
aVIf you look closely, you'll see that everything is shifted by 4 bytes
p78510
aVTwo possible reasons
p78511
aVThe debugger could have picked the wrong address for aPokerTable, the actual address minus 4
p78512
aVThat's unlikely
p78513
aVOr there's a mismatch between the definition of the PokerTable class as seen by pokertable
p78514
aVcpp and the other
p78515
aVcpp files that #include the pokertable
p78516
aVh include file
p78517
aVWhere pokertable
p78518
aVcpp saw an extra member before the numPlayers member
p78519
aVMaybe you edited the header and deleted that member but ended up not recompiling pokertable
p78520
aVcpp for some mysterious reason
p78521
aVBuild + Rebuild to fix
p78522
aVDo panic a bit if this actually works
p78523
as(dp78524
g9
V17034
p78525
stp78526
a((dp78527
g2
(lp78528
VIt's possible
p78529
aVTools + Customize, Commands tab, Toolbar radio button
p78530
aVUse the combo to select the toolbar you want to change
p78531
aVAdd Command button, Categories = Macros, select the macro in the Command list
p78532
aVModify Selection to alter the button properties
p78533
aVWhat you can't do is select an image for the new button
p78534
aVThat's indeed stunningly lame, looks like they just didn't have time to get it done
p78535
aVYou can add your vote to this feedback article
p78536
aVBut surely on the todo list for the next version already
p78537
as(dp78538
g9
V17034
p78539
stp78540
a((dp78541
g2
(lp78542
VUse the debugger
p78543
aVAttach it if necessary with Tools + Attach to Process
p78544
aVDebug + Break All, Debug + Windows + Threads shows you what threads are still running
p78545
aVUse the Thread
p78546
aVIsBackground property to keep your code behind the left door
p78547
as(dp78548
g9
V17034
p78549
stp78550
a((dp78551
g2
(lp78552
VAdd another class to your project, add this method as a public static helper function
p78553
aVYou'll need to provide more arguments, at least a Graphics object I imagine
p78554
aVA rectangle is also going to need a width and height
p78555
aVAvoid hard-coding these, it is rarely appropriate when your form gets rescaled on a machine with a higher video DPI setting
p78556
as(dp78557
g9
V17034
p78558
stp78559
a((dp78560
g2
(lp78561
VThey don't look like buttons at all, it looks like a row of images
p78562
aVUse a real Button or a ToolStrip with ToolStripButtons, set their Image property
p78563
aVWhen you set their Enabled property to false then they automatically remove all color from the image, making it look disabled
p78564
as(dp78565
g9
V17034
p78566
stp78567
a((dp78568
g2
(lp78569
VUse a delegate to let unmanaged code call a managed method
p78570
aVMarshal::GetFunctionPointerForDelegate() creates a stub that takes care of the transition, calling an instance method is supported
p78571
aVYou can cast the returned pointer to a function pointer usable by the unmanaged code
p78572
aVYou'll find a full code sample in this answer
p78573
as(dp78574
g9
V17034
p78575
stp78576
a((dp78577
g2
(lp78578
VYes, there's a fair amount of overhead involved with CreateThread
p78579
aVOne solution is to use a thread pool, QueueUserWorkItem
p78580
aVAnother is to just start a set of threads and have them retrieve a 'job item' from a thread-safe queue
p78581
as(dp78582
g9
V17034
p78583
stp78584
a((dp78585
g2
(lp78586
VThis is a case of gigo, Garbage In, Garbage Out
p78587
aVThe surrogate is not valid, the second one must be in the range \u005cuDC00
p78588
aV\u005cuDFFF
p78589
as(dp78590
g9
V17034
p78591
stp78592
a((dp78593
g2
(lp78594
VThe JIT compiler needs a definition of a value type that describes its layout when it gets boxed
p78595
aVMost of them are baked into mscorlib, like System
p78596
aVInt32
p78597
aVThe enum keyword lets you create a new value type
p78598
aVThe compiler must thus provide a definition for it in the metadata
p78599
aVWhich is what you are looking at
p78600
aVYou'll see static fields for each enumeration member, used by ToString()
p78601
aVAnd one instance field name value__ that stores the enumeration value
p78602
aVKey point is that this only exists in the boxed version of an enum value
p78603
as(dp78604
g9
V17034
p78605
stp78606
a((dp78607
g2
(lp78608
VThis is a fairly fundamental race, it is another process that takes care of the icon
p78609
aVWindows Explorer
p78610
aVYou can't tell when it took care of things
p78611
aVCalling Thread
p78612
aVSleep(500) after setting Visible = true ought to improve the odds significantly
p78613
aVDo consider displaying the icon when your program starts
p78614
as(dp78615
g9
V17034
p78616
stp78617
a((dp78618
g2
(lp78619
VYes, Windows doesn't care how the screens are distributed across video adapters
p78620
aVIt simply gives each screen its own coordinates, depending how you arrange them in the Display applet
p78621
aVYou get your window to display on a specific one by setting its location and size to fit inside the Screen
p78622
aVBounds
p78623
as(dp78624
g9
V17034
p78625
stp78626
a((dp78627
g2
(lp78628
VYour project uses on or more libraries that were built with VS2008, the previous version of Visual Studio
p78629
aVThey require the C runtime library for that version to be available, that's why it is complaining about msvcr90
p78630
aVdll
p78631
aVYou've got VS2010, you only have msvcr100
p78632
aVdll installed on your machine
p78633
aVJust copying msvcr90
p78634
aVdll isn't going to work, that DLL needs to be installed in the Windows side-by-side cache
p78635
aVYou can get an installer from Microsoft or from your friend
p78636
aVThat's however not the true fix, you still have a problem with your app depending on two versions of the CRT
p78637
aVVery unhealthy, that can cause very hard to diagnose crashes and memory leaks
p78638
aVYou need to get the libraries rebuilt with VS2010
p78639
aVThat's where my advice fizzles out, I can't guess what those libraries are from your question
p78640
as(dp78641
g9
V17034
p78642
stp78643
a((dp78644
g2
(lp78645
VThis post is quite relevant for background info
p78646
aVAn event has three accessors: add, remove and raise
p78647
aVRespectively to add an event handler, remove it and to raise the event
p78648
aVThe compiler auto-generates one when you don't write an accessor explicitly
p78649
aVThe C++/CLI compiler auto-generates the raise accessor if you don't write one
p78650
aVIt uses the pattern you see in C# code with the helper variable that avoids the null reference exception
p78651
aVJust as you see it in the linked post
p78652
aVFor some mysterious reason the C# language doesn't do this
p78653
aVIt doesn't even let you define your own accessor, you have to raise the event yourself
p78654
aVForcing you to write code with the helper variable
p78655
aVI have no clue why the C# team made this decision
p78656
aVAs a rule, the team strongly favors avoiding auto-generated code that slows down execution
p78657
aVThe C++ principle of 'you don't pay for what you don't use'
p78658
aVThere are certainly many cases where the thread-safety is unnecessary, any events in GUI code for example
p78659
aVThis is a heck of an edge-case though, given the low cost and the fact that GUI code contains the pattern anyway
p78660
aVLow-level locking in C++ libraries is however common
p78661
as(dp78662
g9
V17034
p78663
stp78664
a((dp78665
g2
(lp78666
VProject + Add Reference, select Microsoft
p78667
aVmshtml
p78668
aVIf it doesn't appear in the list (it is a PIA) then use the Browse tab and select c:\u005cwindows\u005csystem32\u005cmshtml
p78669
aVtlb
p78670
aVAdd a using directive at the top of the source code file:
p78671
aVBeware that you have a deployment detail
p78672
aVIf the PIA isn't installed on the target machine, which is not unlikely, then the best thing to do is to set the Copy Local property of the assembly reference to True
p78673
aVThat creates the Microsoft
p78674
aVmshtml
p78675
aVdll file in the build folder
p78676
aVCopy it, along with your EXE onto the target machine
p78677
aVThere are a few cases where a PIA is required, not this one
p78678
as(dp78679
g9
V17034
p78680
stp78681
a((dp78682
g2
(lp78683
VYes, DrawItem event
p78684
aVYou didn't post it, impossible to guess what's wrong with it
p78685
aVJust make sure that you don't call e
p78686
aVDrawFocusRectangle()
p78687
aVThis is otherwise a bad idea, the focus rectangle is important
p78688
aVIt tells the user that the tab control has the focus so she can figure out what key to press to move the focus to another control in the form
p78689
aVSupporting keyboard navigation is essential to please power users
p78690
aVThe kind that write purchase order requisitions
p78691
as(dp78692
g9
V17034
p78693
stp78694
a((dp78695
g2
(lp78696
VThe probing path is defined by the AppDomainSetup for the primary app domain
p78697
aVIn the default CLR host, that AD gets automatically created before your code starts running
p78698
aVThe only way to configure its setup is to use a
p78699
aVconfig file, it must have the same name as the exe
p78700
aVAfter which it is frozen, any changes you make in your code won't have an effect
p78701
aVWorkarounds are to create your own AD so you can change its setup or implementing the AppDomain
p78702
aVAssemblyResolve event
p78703
aVNeither of which compares favorably to the simple solutions: a
p78704
aVconfig file or just keeping the assembly in the right directory
p78705
aVYmmv
p78706
as(dp78707
g9
V17034
p78708
stp78709
a((dp78710
g2
(lp78711
VThe two server scenario is sufficient to explain the problem
p78712
aVBeware that they'll have a knack for automatically synchronizing to each other's copy operation
p78713
aVWhatever server is behind will quickly catch up because the file is already present in the target machine's file system cache
p78714
aVYou have to give up on the File
p78715
aVExist test, it just cannot work reliably on a multi-tasking operating system
p78716
aVThe race condition is unsolvable, the reason that neither Windows nor
p78717
aVNET has an IsFileLocked() method for example
p78718
aVJust call File
p78719
aVCopy()
p78720
aVYou'll get an IOException of course if the file already exists
p78721
aVFilter out the exception messages by using Marshal
p78722
aVGetLastWin32Error()
p78723
aVThe ERROR_FILE_EXISTS error code is 80
p78724
as(dp78725
g9
V17034
p78726
stp78727
a((dp78728
g2
(lp78729
VIn your Setup project, select Project + Add, Merge Module
p78730
aVNavigate to c:\u005cprogram files\u005ccommon files\u005cmerge modules and select "Microsoft_VC90_CRT_x86
p78731
aVmsm" to get the C/C++ runtime DLLs deployed to the target machine
p78732
aVThere might be additional ones you need, like ATL, MFC, OpenMP, you didn't specify the exact dependencies in your question
p78733
aVBeware that you'll have these merge modules available only if you have VS2008 installed on your machine
p78734
aVIf you don't then it is strongly recommended that you rebuild the DLLs or libraries you use on VS2010, you cannot effectively support your product otherwise
p78735
aVIf necessary, deploy the installer provided by a 3rd party if that's the way you ended up with a dependency on these DLLs
p78736
as(dp78737
g9
V17034
p78738
stp78739
a((dp78740
g2
(lp78741
VThe STL/CLR library was delivered very late, three years after the original promised shipping date
p78742
aVIt was quickly obvious to everybody why, it combined all the disadvantages of the native C++ container classes with the disadvantages of managed memory management
p78743
aVThere is no upside, the library doesn't have a single redeeming value
p78744
aVIts compatibility with the C++ classes is only a liability, preventing you from doing the right thing
p78745
aVReview this page for the horror story
p78746
aVDo not invest any of your time in making this work, it is utterly wasted effort
p78747
aVUse the classes in the System::Collections::Generic namespace
p78748
as(dp78749
g9
V17034
p78750
stp78751
a((dp78752
g2
(lp78753
VThe first version of this question said this is C++/CLI code
p78754
aVYou don't need pinvoke to use the winapi, C++/CLI was designed as an interop language
p78755
aVJust  and directly call the API functions you want to use
p78756
aVNobody can really help you if you don't document the errors you get
p78757
as(dp78758
g9
V17034
p78759
stp78760
a((dp78761
g2
(lp78762
VYou can do this by pinvoking RegisterHotKey
p78763
aVSearch this site or the web for that name to find sample code
p78764
aVHere's one for example
p78765
aVDo beware that this is probably not a good investment of your time, Windows already supports it
p78766
aVCreate a shortcut to the program
p78767
aVRight-click it, Properties, Shortcut tab
p78768
aVClick the "Shortcut key" text box and press the keystroke combination you want to use
p78769
as(dp78770
g9
V17034
p78771
stp78772
a((dp78773
g2
(lp78774
VUse the SelectedRtf property
p78775
as(dp78776
g9
V17034
p78777
stp78778
a((dp78779
g2
(lp78780
VDon't throw big buffers like that away, you are lucky to have it
p78781
aVVideo gives lots of opportunity for re-use
p78782
aVDon't lose a buffer until you are sure you won't need it anymore
p78783
aVAt which point it doesn't matter when it get collected
p78784
as(dp78785
g9
V17034
p78786
stp78787
a((dp78788
g2
(lp78789
VChase this down with SysInternals' ProcMon, probably the way Ogawa discovered his hack
p78790
aVYou'll drown in the data but you'll have to find the registry or file access that fails
p78791
aVAsk more questions about it at superuser
p78792
aVcom
p78793
aVBeware that this isn't just unsupported because of a missing file or registry key
p78794
aVThese Office programs were designed to be used interactively
p78795
aVThey'll put up a dialog when something goes wrong
p78796
aVOn a desktop where nobody can hear it scream
p78797
aVYour service fails in a completely undiagnosable way, it just stops working and you cannot find out why
p78798
as(dp78799
g9
V17034
p78800
stp78801
a((dp78802
g2
(lp78803
VYes, no problem
p78804
aVBut it has to be a cursor, it can't be an image
p78805
aVYou can turn an image into an icon with Bitmap
p78806
aVGetHicon() method and pass that to the Cursor class constructor
p78807
aVIt does however a very poor job on images that contain a lot of colors
p78808
aVThe color mapping algorithm is miserable, in general that's something that's hard to do well
p78809
aVIt is best to use a good graphics program
p78810
aVCheck my answer here for a trick to use text as a cursor, using the same technique
p78811
as(dp78812
g9
V17034
p78813
stp78814
a((dp78815
g2
(lp78816
VNo, you made that background red, not black
p78817
aVUse Color
p78818
aVTransparent if you want to have the alpha of the background set to 0
p78819
aVOr just omit the Clear(), it is the default for a new bitmap
p78820
aVAnd avoid Original
p78821
aVRawFormat in the Save() call, you don't want to use an image format that doesn't support transparency
p78822
aVPng is always good
p78823
aVAnd be sure that whatever method you use to display the resulting bitmap supports transparency as well
p78824
aVWith a well defined background color
p78825
aVYou'll get black when it doesn't, Color
p78826
aVTransparent has R, G and B at 0
p78827
aVBlack
p78828
as(dp78829
g9
V17034
p78830
stp78831
a((dp78832
g2
(lp78833
VThere's only one way to find out that a process 'did not finish as expected'
p78834
aVThe process exit code is non-zero
p78835
aVSet by the return value of main() in a native program
p78836
aVOr the value passed to Environment
p78837
aVExit() in a managed program
p78838
aVOr the errorlevel in a batch file
p78839
aVIt is automatically set to the exception code if the main thread of the process dies
p78840
aVYou'll have to find out why one of these programs returns a non-zero exit code
p78841
as(dp78842
g9
V17034
p78843
stp78844
a((dp78845
g2
(lp78846
VThere's a bevy of GetThemeXxxx() functions
p78847
aVYou're probably looking for, respectively, GetThemeFont(), GetThemeMetric() and GetThemeColor()
p78848
aVThe metric one was a bit of a guess, there are several other sizing related ones
p78849
aVGetThemeFont also returns the font size
p78850
aVStart here in the MSDN library
p78851
as(dp78852
g9
V17034
p78853
stp78854
a((dp78855
g2
(lp78856
VThere's something missing from this question
p78857
aVA DLL cannot have its own
p78858
aVconfig file, its configuration sections must be merged into the app
p78859
aVexe
p78860
aVconfig file
p78861
aVSounds to me you don't control this file, how do you prevent the owner of the app from breaking you when he reinstalls or updates his
p78862
aVconfig file
p78863
aVAt any rate, the lack of control you have is very troublesome
p78864
aVStoring your own settings without using a
p78865
aVconfig file is strongly indicated
p78866
aVAn
p78867
aVxml file will do just fine
p78868
as(dp78869
g9
V17034
p78870
stp78871
a((dp78872
g2
(lp78873
VUpdate: you want the integral values, not the names
p78874
aVThat still requires Enum::GetValues() to obtain the enumerated values but they have to be cast to int so that the ToString() override doesn't generate the name
p78875
aVMake that look like this:
p78876
aVWhere Form1(void) is the constructor of your form class
p78877
as(dp78878
g9
V17034
p78879
stp78880
a((dp78881
g2
(lp78882
VYou must use BSTR to use VB6 compatible strings
p78883
aVIt is the standard COM string type, it stores Unicode strings in utf-16 encoding, just like the Win32 api
p78884
aVYou can cast the in args to WCHAR* directly, use WideCharToMultiByte() if you need to convert to char* (best avoided)
p78885
aVUse SysFreeString if  is not null to release an existing string before assigning it
p78886
aVUse SysAllocString to allocate the ErrMsg string
p78887
aVIt must be a utf-16 string as well, MultiByteToWideChar() if necessary again to convert from char*
p78888
aVOr use a string literal that's prefixed with L, like L"Oops"
p78889
as(dp78890
g9
V17034
p78891
stp78892
a((dp78893
g2
(lp78894
VIt is a linker error, not a compile error
p78895
aVYou need to tell the linker to search the Windows import libraries for these winapi identifiers
p78896
aVRight-click your project in the Solution Explorer window, Properties, Linker, Input, Additional Dependencies setting
p78897
aVDelete $(NoInherit)
p78898
aVThat allows the defaults from the "Core Windows Libraries" project property sheet to be used, it specifies the
p78899
aVlib files of the most common Windows dlls
p78900
aVIncluding user32
p78901
aVlib, the one that declares GetForegroundWindow()
p78902
aVYou can see the list of the
p78903
aVlibs that were inherited from the project property sheet by clicking the dotted button in the text box
p78904
aV"Inherited values" list
p78905
aVIf you use an 'obscure' winapi whose import library is not in the list then you need to add the name of the
p78906
aVlib to the setting
p78907
aVThe
p78908
aVlib you need is documented in the MSDN Library article for the winapi function in the "Function Information" section at the bottom of the article
p78909
as(dp78910
g9
V17034
p78911
stp78912
a((dp78913
g2
(lp78914
VSupport for condition variables requires Vista or better
p78915
aVThat's usually where the buck stops, supporting XP unfortunately tends to be still important
p78916
aVYour second snippet also does has the considerable advantage that it is trivial to understand
p78917
aVI don't have a clue what you're trying to do in the first one, it looks wrong
p78918
as(dp78919
g9
V17034
p78920
stp78921
a((dp78922
g2
(lp78923
VThe posted answers are not correct, Z-order has nothing to do with tab order
p78924
aVIt is just a coincidence that the order in which you drop controls on a form also sets the z-order and the TabIndex property value in a predictable way
p78925
aVIt gets out of whack as soon as you use the Format menu to move controls to the front or back
p78926
aVOnly TabIndex matters
p78927
aVIntuitively: there wouldn't be a need for the property otherwise
p78928
aVNo shortcuts here, if you can't use the designer to set the TabIndex property for you then you have to set it yourself
p78929
aVYou have to write the code
p78930
aVIt isn't typically that difficult, just assign it sequentially from the last used value, add the controls in tabbing order
p78931
aVLeave a gap in assigned TabIndex values if you need to insert them between controls that you added with the designer
p78932
as(dp78933
g9
V17034
p78934
stp78935
a((dp78936
g2
(lp78937
VThe "Thread Safety" section in the MSDN Library article about a class documents this:
p78938
aVAny instance members are not guaranteed to be thread safe
p78939
aVThis is quite normal for
p78940
aVNET classes, the documentation is boilerplate and in a few selected cases uninformative
p78941
aVThat was the case for MemoryCache as well until the documentation got updated
p78942
aVThe Connect feedback article linked by Davide is helpful to clear this up:
p78943
aVSystem
p78944
aVRuntime
p78945
aVCaching
p78946
aVMemoryCache is threadsafe
p78947
aVMultiple concurrent
p78948
aVthreads can read and write a MemoryCache instance
p78949
aVInternally
p78950
aVthread-safety is automatically handled to ensure the cache is updated
p78951
aVin a consistent manner
p78952
aVWhat this might be referring to is that data stored within the cache
p78953
aVmay itself not be threadsafe
p78954
aVFor example if a List is placed in
p78955
aVthe cache, and two separate threads both get a reference to the cached
p78956
aVList, the two threads will end up stepping on each other if they
p78957
aVboth attempt to update the list simultaneously
p78958
as(dp78959
g9
V17034
p78960
stp78961
a((dp78962
g2
(lp78963
VYou cannot iterate running threads
p78964
aVWhich prevents you from finding out if any have IsBackground = false
p78965
aVThis is rather fundamental, iterating threads can never produce accurate results
p78966
aVThreads are created and terminated dynamically, you cannot "freeze" your process to ensure that the result accurate
p78967
aVYou need to treat this simply as a bug
p78968
aVThe code of a thread that ignores an explicit request to terminate has a defect
p78969
aVYou'd be wise to make this explicit instead of hoping that the programmer gets it right
p78970
aVEither by using the BackgroundWorker class and its CancellationPending property
p78971
aVOr the
p78972
aVNET 4
p78973
aV0 Task class with its CancellationToken structure
p78974
aVA programmer cannot claim ignorance of these features
p78975
aVBe careful to get this right in your UI code btw, deadlock is very likely
p78976
as(dp78977
g9
V17034
p78978
stp78979
a((dp78980
g2
(lp78981
VSince it is possible to predict the outcome of this statement at compile time
p78982
aVIt is not
p78983
aVThe reference assembly doesn't have to match the runtime assembly
p78984
aVA publisher policy or a  element in the
p78985
aVconfig file allows another version of the assembly to get loaded at runtime without getting an exception
p78986
aVAssembly binding in
p78987
aVNET is quite dynamic
p78988
aVYou can use an #if directive in your code (don't use expressions), not untypical when you have to support multiple platform targets, but your original approach is the more universal solution
p78989
as(dp78990
g9
V17034
p78991
stp78992
a((dp78993
g2
(lp78994
VNot much to go by
p78995
aVHowever, do ignore this warning if you get it from terminating the debugging session early
p78996
aVIt is caused by the MDA noticing a thread ending that has an outstanding COM interface call that's being marshaled
p78997
aVUsing Debug + Stop Debugging can certainly trip this warning, it terminates threads
p78998
as(dp78999
g9
V17034
p79000
stp79001
a((dp79002
g2
(lp79003
VIt went wrong from there
p79004
aVYour
p79005
aVh file declares a class inside that namespace, its name is myWrapper::myWrappedService
p79006
aVYour
p79007
aVcpp file declares another class that is not in a namespace, its name is ::myWrappedService
p79008
aVDifferent names, the compiler won't complain about seeing the same class defined twice
p79009
aVThe first class doesn't have an implementation of the Connected method, that's why the linker complained
p79010
aVsad_man's snippets suffer the same flaw
p79011
aVThe first snippet defines the ::myWrappedService::Connected() method
p79012
aVWrong namespace
p79013
aVThe second snippet has the same flaw as yours
p79014
aVWhen you write a class library in managed code then you don't need a
p79015
aVh file
p79016
aVMetadata in an assembly plays the same role, it contains the declarations of the types in the assembly
p79017
aVThere is no other
p79018
aVcpp file in your project that needs the declaration of the class, no need for the
p79019
ag6193
aVSo just write everything in
p79020
aVcpp file:
p79021
as(dp79022
g9
V17034
p79023
stp79024
a((dp79025
g2
(lp79026
VThis function is very difficult to use in a C program as well
p79027
aVReturning strings from functions is a poorly supported scenario
p79028
aVThere's a memory management problem, it isn't clear who owns the string
p79029
aVIn most cases the caller is expected to take ownership of the string and free it after using it
p79030
aVThat's not going to work out well for your function, the program will crash since you returned a string literal
p79031
aVThe
p79032
aVNET pinvoke marshaller needs to solve this problem as well
p79033
aVWith the extra problem that it cannot use the allocator that's used by the C code
p79034
aVIt is going to call CoTaskMemFree (the COM allocator)
p79035
aVThat causes an undiagnosable memory leak on XP, a crash on Vista and Win7
p79036
aVJust don't write C code like this
p79037
aVAlways let the caller pass the buffer for the string
p79038
aVNow there's no guessing who owns the memory
p79039
aVLike this:
p79040
aVWith your C# code like this:
p79041
as(dp79042
g9
V17034
p79043
stp79044
a((dp79045
g2
(lp79046
VAt m_firstChar
p79047
aVThe heap allocation is large enough to fit the entire string, not just the first character
p79048
aVEasy to see in Visual Studio as well:
p79049
aVWhen the breakpoint hits, use Debug + Windows + Memory + Memory1
p79050
aVIn the Address box type s
p79051
aVYou'll see:
p79052
aVThe object starts at the address - 4, the syncblk is stored there (not visible)
p79053
aVNext 4 bytes is the method table pointer (0x6e670ae8, aka type handle)
p79054
aVNext 4 bytes is the m_arrayLength member, the allocated size of the string (0x0b)
p79055
aVNext 4 bytes is the m_stringLength member, the actual number of characters in the string (0x0a)
p79056
aVNext bytes store the string, starting at m_firstChar
p79057
aVThis is for
p79058
aVNET 3
p79059
aV5 SP1
p79060
aVNot sure why the m_arrayLength member isn't visible in your output
p79061
as(dp79062
g9
V17034
p79063
stp79064
a((dp79065
g2
(lp79066
VThis kind of thing happens when there's no window that's enabled when the message box closes
p79067
aVWindows is forced to find another window to give the focus to and will pick one from another application
p79068
aVAlso explains why this isn't a problem when there is no other window
p79069
aVMake sure you don't disable your windows
p79070
aVIn other words, avoid this:
p79071
aVSetting Enabled back to true like that is too late
p79072
as(dp79073
g9
V17034
p79074
stp79075
a((dp79076
g2
(lp79077
VNo, vb6 doesn't support multi-threading
p79078
aVIt sorta worked in vb5 by hacking the winapi but got completely broken in vb6
p79079
aVThe error handling is busted, getting an error in one thread crashes all of them
p79080
aVMove up to vb
p79081
aVnet to get it back
p79082
as(dp79083
g9
V17034
p79084
stp79085
a((dp79086
g2
(lp79087
VMicrosoft Word is a Big Program
p79088
aVRunning several copies of it would quickly make the average consumer level machine keel over
p79089
aVTo avoid this, Word makes sure that only one instance ever runs, taking care of all documents
p79090
aVA so-called single-instance app
p79091
aVSo if you start Word like you do and Word is already running then the 2nd copy you start only asks the 1st instance to open the document
p79092
aVAnd immediately exits
p79093
aVMaking your code bomb
p79094
aVThis also stops you from doing what you are trying to do, you cannot tell when the user closes the 2nd document, only when she closes all documents
p79095
aVOne imperfect workaround would be to try to open the
p79096
aVdoc file periodically
p79097
aVIt is locked as long as Word has it opened
p79098
as(dp79099
g9
V17034
p79100
stp79101
a((dp79102
g2
(lp79103
VA program always bombs on OOM because it is asking for a chunk of memory that's too large, never because it completely exhausted all virtual memory address space
p79104
aVYou could argue that's a problem with the LOH getting fragmented, it is just as easy to argue that the program is using too much virtual memory
p79105
aVOnce a program goes beyond allocating half the addressable virtual memory (a gigabyte), it is really time to either consider making its code smarter so it doesn't gobble so much memory
p79106
aVOr making a 64-bit operating system a prerequisite
p79107
aVThe latter is always cheaper
p79108
aVIt doesn't come out of your pocket either
p79109
as(dp79110
g9
V17034
p79111
stp79112
a((dp79113
g2
(lp79114
VThis is not possible, no workaround for it either
p79115
aVD+D cannot drop an object into an elevated process from an unelevated one
p79116
aVUIPI (the UI component of UAC) prevents this
p79117
aVThe ChangeWindowMessageFilter() workaround doesn't work, D+D isn't message based, it uses COM
p79118
aVWM_DROPFILES dates back to Windows 3 and is no longer used
p79119
aVI suspect some future version of Windows to provide a workaround, it isn't possible yet as of Windows 7
p79120
as(dp79121
g9
V17034
p79122
stp79123
a((dp79124
g2
(lp79125
VThe Send() method is going to access the attachments to embed them into the mail message
p79126
aVThat goes kaboom here, the memory stream was disposed
p79127
aVYou need to move the Send() message inside of the using statements so the stream doesn't get disposed until the message is sent
p79128
aVMentioning that using isn't necessary here because a memory stream doesn't have any unmanaged resources that need to be disposed always gets me into trouble at SO
p79129
aVSo I won't bring that up
p79130
as(dp79131
g9
V17034
p79132
stp79133
a((dp79134
g2
(lp79135
VThe Windows SDKs have had an unpleasant history of installer problems
p79136
aVCheck this answer for the correct registry entry
p79137
as(dp79138
g9
V17034
p79139
stp79140
a((dp79141
g2
(lp79142
VThe Elapsed event handler runs on a threadpool thread
p79143
aVThat's poison to the RowFilter property, assigning it is going to cause the control to be updated
p79144
aVThat can only be done on the UI thread, user interface components are never thread-safe
p79145
aVUse a regular Winforms Timer instead
p79146
as(dp79147
g9
V17034
p79148
stp79149
a((dp79150
g2
(lp79151
VWorks fine when I try it
p79152
aVBeware that you are only changing the Kind, not the time
p79153
aVAnd you don't handle null dates properly, you cannot use date
p79154
aVValue if date
p79155
aVHasValue is false
p79156
aVMake sure that the exception isn't caught silently and bypassing the rest of the property assignments
p79157
aVFix:
p79158
as(dp79159
g9
V17034
p79160
stp79161
a((dp79162
g2
(lp79163
VEnvironment
p79164
aVExit() is a rude abort
p79165
aVIt instantly terminates the process
p79166
aVUse it only when you detect a gross failure, it is appropriate in an AppDomain
p79167
aVUnhandledException event handler for example
p79168
aVWhich runs when your program is about to terminate because of an unhandled exception
p79169
aVWhich is your lead: exceptions are a good way to signal unusual conditions that should terminate the program with an ExitCode that isn't zero
p79170
aVIn fact, it automatically gets set to the HResult property value of the exception
p79171
aVNo code required
p79172
as(dp79173
g9
V17034
p79174
stp79175
a((dp79176
g2
(lp79177
VNo
p79178
aVUse Graphics
p79179
aVDrawText() instead
p79180
aVTextRenderer is a workaround for a GDI+ flaw, CF doesn't use GDI+
p79181
as(dp79182
g9
V17034
p79183
stp79184
a((dp79185
g2
(lp79186
VI'll assume you are talking about out-of-process COM servers although they are far less common than in-process servers
p79187
aVKilling the client app is bad, the server will never get the release calls, the resources for any objects that the client allocated will stay in use until the EXE is terminated
p79188
aVKilling the server app is going to make the client app fail with RPC errors, nothing is leaked
p79189
aVThere's nothing bad about not using Marshal
p79190
aVFinalReleaseComObject(), COM object reference counts are managed by the RCW (runtime callable wrapper)
p79191
aVIt is a managed object like any other in
p79192
aVNET programming, the garbage collector takes care of it
p79193
aVThe reference count is decremented when the finalizer runs
p79194
aVIt is unpredictable when that happens
p79195
aVUsing Final/ReleaseComObject() can make it predictable but you have to call it on every object you create
p79196
aVWhich can be difficult, it isn't always obvious that you created one when you use the indexer for example
p79197
aVIt is also dangerous, mis-timing the call or not properly tracking all references to the object causes the infamous "COM object that has been separated from its underlying RCW cannot be used" exception
p79198
aVA good war story is available here
p79199
as(dp79200
g9
V17034
p79201
stp79202
a((dp79203
g2
(lp79204
VThis is a subtle bug that's induced by the MessageBox
p79205
aVShow() call
p79206
aVMessageBox pumps a message loop to keep the UI alive
p79207
aVWhich allows the Tick event handler to run again, even though it is already active from the previous tick
p79208
aVThe counter variable doesn't get incremented until you click the OK button
p79209
aVAs a result, the screen fills with message boxes and that won't stop until you click the OK button ten times
p79210
aVYou need to increment the counter before showing the message box
p79211
aVFix:
p79212
aVThis kind of problem is also the reason that DoEvents() got such a bad reputation
p79213
aVIt is pretty difficult to write code that can properly deal with the re-entrancy induced by the message loop
p79214
aVYou need to keep boolean flags around that indicate that code is already active
p79215
aVWhich is another way to solve your problem:
p79216
aVYou now get only one message box at a time, probably what you are really looking for
p79217
aVI should mention that this re-entrancy problem is pretty specific to timers
p79218
aVA dialog takes counter-measures to avoid re-entrancy problems, it disables all the windows in the application
p79219
aVThat ensures that the user cannot do things like closing the main window or clicking a button that brings up the dialog again
p79220
aVBoth rather disastrous mishaps
p79221
aVThat takes care of most of the 'unexpected' Windows notifications, basically any of the messages that are generated by the user
p79222
aVThe edge case is a timer (WM_TIMER is not disabled) whose event handler has a UI effect
p79223
as(dp79224
g9
V17034
p79225
stp79226
a((dp79227
g2
(lp79228
VThe Application
p79229
aVIdle event is handy to execute code on the UI thread that is least likely to affect the user interface
p79230
aVYou can easily burn hundreds of milliseconds without the user noticing that the UI is stuttering
p79231
aVThis just isn't an issue in a service, it doesn't have a user interface
p79232
aVJust execute the code directly
p79233
aVIf this is a polling type of operation (you don't have a good trigger or something you can wait on) then use a Timer
p79234
as(dp79235
g9
V17034
p79236
stp79237
a((dp79238
g2
(lp79239
VThis is a Big Deal when you use DLLs in your application
p79240
aVIt is very important that the EXE and the DLLs use the same memory allocator
p79241
aVIn case you return pointers or C++ objects (like std::string) from a DLL function that needs to be released by the caller
p79242
aVTo get the same allocator, all modules must use the same instance of the CRT
p79243
aVYou only get that if you compile with /MD to select the DLL version of the CRT
p79244
aVAnd they must all use the same version of the CRT
p79245
aVUsing /MT anyway causes very hard to diagnose memory leaks, an access violation if you're lucky
p79246
aVUsing /MT makes it easier to deploy your app since you don't have to install the runtime DLLs
p79247
aVAs implied, this is only safe to do if you only have to deploy an EXE
p79248
aVOr when you very carefully control the public interface of your DLLs
p79249
aVAn automation compatible COM server for example can link to the static version of the CRT
p79250
aVAutomation has strict rules about exchanging pointers and managing memory
p79251
as(dp79252
g9
V17034
p79253
stp79254
a((dp79255
g2
(lp79256
VTextBox has a Click event, using it is no problem
p79257
aVYour Handles clause however uses OnClick, that's not a valid event name
p79258
aVDo make sure this Sub is inside a Form class and not a module
p79259
as(dp79260
g9
V17034
p79261
stp79262
a((dp79263
g2
(lp79264
V"How can I get the operating system started" would be the more typical question these days
p79265
aVVideo adapters eat up too much physical address space for this option to still work
p79266
aVGet a 64-bit operating system and you'll have 4 gigabytes
p79267
aVAnd editbin
p79268
aVexe /largeaddressaware on devenv
p79269
aVexe
p79270
aVIt voids the warranty I imagine
p79271
as(dp79272
g9
V17034
p79273
stp79274
a((dp79275
g2
(lp79276
VThe RegSetValueEx() API accepts different kind of data to be written to the registry
p79277
aVIts 5th argument is a pointer to that data, declared as BYTE*
p79278
aVYou are passing it a char*, wrong type
p79279
aVNote that you are doing it right a few lines back in the RegQueryValueEx() call
p79280
aVFix:
p79281
as(dp79282
g9
V17034
p79283
stp79284
a((dp79285
g2
(lp79286
VI think your are a victim of your own message
p79287
aVThe exception didn't actually occur in OnStart, even though your message says it did
p79288
aVIt bombed in the RequestServer class, code you didn't post
p79289
aVNote how the call stack does give you the right info
p79290
aVThe
p79291
aVctor() listed there is the constructor for the class, that's the one that bombed
p79292
aVHave a look at it
p79293
aVAnd fix the WriteEntry() argument, I'd recommend something like "Startup failure"
p79294
as(dp79295
g9
V17034
p79296
stp79297
a((dp79298
g2
(lp79299
VThe call to LoadLibrary(C:\u005cWindows\u005cMicrosoft
p79300
aVNET\u005cFramework\u005cv4
p79301
ag2512
aV30319\u005csos) failed
p79302
aVIt is loading the wrong version of sos
p79303
aVdll
p79304
aVDo check the PATH, perhaps you use the wrong Visual Studio Command Prompt, using the 32-bit one instead of the 64-bit one
p79305
aVSpecifying the full path name to the sos
p79306
aVdll in the Framework64 subdirectory should work too
p79307
as(dp79308
g9
V17034
p79309
stp79310
a((dp79311
g2
(lp79312
VWell, that's not so easy
p79313
aVScreen savers are explicitly designed to support a preview
p79314
aVThey are not EXEs, they are DLLs
p79315
aVThey run in-process and export 3 functions that Windows calls to get them to do what screen savers normally do
p79316
aVGetting a preview of an EXE window is a completely different problem, much harder to solve
p79317
aVIt is somewhat possible by pinvoking the SetParent() API function, making your window the parent of the EXE window
p79318
aVFor that, you must have the handle of the EXE window, that can be hard to obtain
p79319
aVYour best bet without a lot of nasty pinvoke is Process
p79320
aVMainWindowHandle
p79321
aVGetting a thumbnail view of it is also unlikely to work out well, the EXE controls the painting of the window
p79322
aVYou can make the window smaller by pinvoking MoveWindow, what you get is unpredictable but unlikely to resemble a thumbnail
p79323
aVTry resizing the Visual Studio window to a thumbnail size for example
p79324
aVIf you want to try this anyway, visit pinvoke
p79325
aVnet to get the required declarations
p79326
aVIf this is a 'getting started' kind of project then do consider trying to tackle something less likely to be disappointing
p79327
as(dp79328
g9
V17034
p79329
stp79330
a((dp79331
g2
(lp79332
VTrapping the keystroke isn't enough, the user can also paste using the context menu
p79333
aVThis requires trapping the operation at a lower level, you have to catch the WM_PASTE message and prevent it from reaching the native Windows control
p79334
aVAdd a new class to your project and paste the code shown below
p79335
aVCompile
p79336
aVDrop the new control from the top of the toolbox onto your form
p79337
aVIt does have one flaw, the Paste command isn't disabled on the context menu
p79338
aVNo easy fix for that one, you'd have to replace it with your own
p79339
as(dp79340
g9
V17034
p79341
stp79342
a((dp79343
g2
(lp79344
VDisabling visual styles on all controls is a pretty heavy hammer
p79345
aVNot that surprising that the latest version of the dialogs don't support it
p79346
aVTry to fall back to the legacy shell dialog interface with GetOpenFileName()
p79347
aVNext remove the manifest entry that enables the 6
p79348
aV0 version of the common controls
p79349
aVA bit anathema to the idea of skinning perhaps
p79350
as(dp79351
g9
V17034
p79352
stp79353
a((dp79354
g2
(lp79355
VThis is going to require a bit of pinvoke to send the messages to get the calendar to switch the view
p79356
aVImplement the DateTimePicker's DropDown event handler like this:
p79357
aVThe view switching is animated, it is going to be visible to the user
p79358
aVThis won't work for Windows versions prior to Vista
p79359
aVUse an online translator if necessary to translate this C# code to VB
p79360
aVNET
p79361
as(dp79362
g9
V17034
p79363
stp79364
a((dp79365
g2
(lp79366
VYou can create an incremental clock with much higher resolution by using the Stopwatch class
p79367
aVFor example:
p79368
aVThis is still not likely to work out that well for the code in your snippet, incrementing an integer takes less than half a nanosecond
p79369
aVYou'll actually measure how long it takes to log, that ought to be slow enough to get different output values
p79370
as(dp79371
g9
V17034
p79372
stp79373
a((dp79374
g2
(lp79375
VIt's a bit of a bug in Winforms, Windows actually supports making the owner a window that was created on another thread
p79376
aVThere's a way to disable that check, something you should never do
p79377
aVExcept when you have to I suppose:
p79378
aVI do not know if this is 100% safe, there could be a Winforms interaction that screws things up
p79379
aVYou are in untested waters here, infested with threading sharks
p79380
as(dp79381
g9
V17034
p79382
stp79383
a((dp79384
g2
(lp79385
VIt isn't clear to me how this exception is getting triggered, the desktop should have no use for your control
p79386
aVThe mouse cursor should show the "cannot drop here" shape
p79387
aVNevertheless, first-chance exceptions during D+D are meaningless, they are swallowed and do not otherwise affect the operation
p79388
aVYou only see them because you've got a debugger attached
p79389
aVIf you really want to drill this down then use Debug + Exceptions, tick the Thrown box for Common Language Runtime exceptions
p79390
aVThe debugger will stop when the exception is raised
p79391
aVIt is quite likely that it is raised inside Winforms plumbing code, you won't have source code to look at unless you enable the Reference Source
p79392
aVPost the stack trace in your question if you can't figure it out
p79393
aVBe sure to copy the entire one, scroll it if necessary to get the top activation frame
p79394
aVBut reiterating, this should not be a problem in practice
p79395
aVThe user should see the 'cannot drop' mouse cursor, the exception is swallowed without terminating your program
p79396
as(dp79397
g9
V17034
p79398
stp79399
a((dp79400
g2
(lp79401
VIt is a setting, it could be turned off if you recently played with an add-on that you subsequently uninstalled
p79402
aVFor example
p79403
aVTools + Options, Text Editor, All Languages
p79404
aVEnsure the "Auto list members" checkbox is ticked
p79405
as(dp79406
g9
V17034
p79407
stp79408
a((dp79409
g2
(lp79410
VThe GenerateInMemory property is a parlor trick
p79411
aVThe C# compiler doesn't know how to write to your program's memory
p79412
aVIt is faked, the compiler is asked to actually write the assembly to the TEMP directory
p79413
aVFrom where it is loaded into memory after compilation succeeds with a FileStream into a byte[], then Assembly
p79414
aVLoad(byte[])
p79415
aVHave a look-see with Reflector, Microsoft
p79416
aVCSharp
p79417
aVCSharpCodeGenerator
p79418
aVFromFileBatch() method
p79419
aVSince it creates a file anyway, just not very visible, solve your problem by just letting it create a file and loading it in the AppDomain
p79420
as(dp79421
g9
V17034
p79422
stp79423
a((dp79424
g2
(lp79425
VVery vague
p79426
aVIt never makes sense to start another background worker and have the first one wait for it to complete
p79427
aVYou only get a benefit from multiple threads if you can do stuff at the same time
p79428
aVReading a file then processing it is a sequential operation that cannot be overlapped
p79429
aVMaybe you can do some of the processing concurrently, but that's unguessable from your question
p79430
as(dp79431
g9
V17034
p79432
stp79433
a((dp79434
g2
(lp79435
VThe timestamp is already in milliseconds
p79436
aVDon't divide by 1000
p79437
aVHow you got 3/11/2011 out of that code is rather a mystery
p79438
as(dp79439
g9
V17034
p79440
stp79441
a((dp79442
g2
(lp79443
VThis is not unlikely to happen when you made a bunch of setting changes but didn't also make them for the Release build
p79444
aVEasy to forget, the first time anyway
p79445
aVYou can easily tell which settings were changed from the default, they are displayed in bold type
p79446
aVStep through the setting pages, flip back-and-forth with the Configuration combobox in the upper left corner
p79447
aVAbout 15 minutes of your life, not counting the thinking time you need because the setting should be different for the Release build
p79448
aVStart another instance of Visual Studio with a dummy project to verify that
p79449
as(dp79450
g9
V17034
p79451
stp79452
a((dp79453
g2
(lp79454
VReview the SetWindowsHookEx() documentation in the MSDN Library
p79455
aVThe important hook type here is WH_SHELL
p79456
as(dp79457
g9
V17034
p79458
stp79459
a((dp79460
g2
(lp79461
VThis is by design, the built-in Windows dialogs (like MessageBox) always display text in the system default language
p79462
aVAny user that would be interested in running her machine in a language that's different from the Windows edition language would purchase a license to the Ultimate edition
p79463
aVWhich supports downloadable language packs that can change the language text for all Windows programs and dialogs
p79464
aVThis is otherwise not very common, the vast majority of users just buy the Windows edition that matches their native language
p79465
aVThe only thing you have to do is to ensure that your program is localized for that language
p79466
aVEven for Ultimate there is no need to support switching on demand in your program, the user simply uses Control Panel's Region and Language applet to switch
p79467
aVThis forces a new login which in turn ensures that your program is restarted
p79468
as(dp79469
g9
V17034
p79470
stp79471
a((dp79472
g2
(lp79473
VA spot check on the generated machine code in the Release build shows that the x86 jitter doesn't optimize the cast away
p79474
aVYou have to look at the big picture here though
p79475
aVYou are assigning properties of a control
p79476
aVThey have a ton of side-effects
p79477
aVIn the case of DateTimePicker, the assignment results in a message being sent to the native Windows control
p79478
aVWhich in turn crunches away at the message
p79479
aVThe cost of the cast is negligible to the cost of the side effects
p79480
aVRewriting the assignments is never going to make a noticeable difference in speed, you only made it a fraction of a percent faster
p79481
aVGo ahead and do rewrite the code on a lazy Friday afternoon
p79482
aVBut only because it is a blight to readability
p79483
aVThat poorly readable C# code also produces poorly optimized machine code is not entirely a coincidence
p79484
as(dp79485
g9
V17034
p79486
stp79487
a((dp79488
g2
(lp79489
VYou've got the wrong mental model
p79490
aVJust because the user control isn't visible on the TabControl doesn't mean that the code is invisible as well
p79491
aVJust call the control's method in your code, it needs to be public of course
p79492
aVThen change the tab control's SelectedIndex property to switch the active tab page
p79493
aVThe button should not be part of the 1st user control
p79494
aVActually it is better not to use a button but to just trigger an event when the user selects another store
p79495
as(dp79496
g9
V17034
p79497
stp79498
a((dp79499
g2
(lp79500
VThis quacks loudly like a compiler parser bug
p79501
aVIt gets a bit more interesting if you leave the string array initializer empty
p79502
aVThen you get this description in the Output window:
p79503
aVNote the message "ListViemItem^ is not an array or class"
p79504
aVThis strongly suggests the compiler is applying the initializer to the ListViewItem instead of the string array, that's nonsense
p79505
aVIt implodes from there
p79506
aVThis isn't going to get fixed any time soon, if at all
p79507
aVYou know the fugly workaround
p79508
aVYou can post to connect
p79509
aVmicrosoft
p79510
aVcom for a second opinion
p79511
as(dp79512
g9
V17034
p79513
stp79514
a((dp79515
g2
(lp79516
VIt seems to think the assembly is created by another project in the solution
p79517
aVMaybe that was once the case and you removed the project from the solution
p79518
aVDelete the assembly reference and add it back with the Browse tab
p79519
as(dp79520
g9
V17034
p79521
stp79522
a((dp79523
g2
(lp79524
VThis is the expected behavior, the CComPtr copy constructor will simply copy the interface pointer and add a reference with AddRef()
p79525
aVThere is no mechanism to automatically create a deep copy, neither in COM nor in
p79526
aVNET
p79527
aVThis isn't fundamentally different from C++
p79528
aVThere is a well-known interface defined in
p79529
aVNET, ICloneable
p79530
aVIt barely escaped being deprecated, the interface doesn't have a way to let the caller specify that a deep copy instead of a shallow copy is desired
p79531
aVMaking it next to useless and very rarely implemented
p79532
aVDoesn't help here anyway, COM doesn't have anything similar
p79533
aVNope, you'll have to maintain enough state and write the code to create a new object
p79534
aVDo review your need for this
p79535
aVIf you are making the C++ object copy solely with the intent to create a copy of the COM object (and its underlying
p79536
aVNET object) then you probably shouldn't be making that copy
p79537
as(dp79538
g9
V17034
p79539
stp79540
a((dp79541
g2
(lp79542
VDon't "cut the buffer at the first \u005c0", ReadFile doesn't return a zero-terminated string
p79543
aVIt reads raw bytes
p79544
aVYou have to pay attention to the value returned through the lpNumberOfBytesRead argument
p79545
aVIt will be equal to the nNumberOfBytesToRead value you pass unless you've reached the end of the file
p79546
aVNow you know how many valid bytes are in the buffer
p79547
aVSearch them for the first '\u005cr' or '\u005cn' byte to find the line terminator
p79548
aVCopy the range of bytes to a string buffer supplied by the caller and return
p79549
aVThe next time you read a line, start where you left off previously, past the line terminator
p79550
aVWhen you don't find the line terminator then you have to copy the bytes in the buffer and call ReadFile() again to read more bytes
p79551
aVThat makes the code a bit tricky to get right, excellent exercise otherwise
p79552
as(dp79553
g9
V17034
p79554
stp79555
a((dp79556
g2
(lp79557
VA language like VB
p79558
aVNET offers no escape around its fundamental syntax rule that identifiers are case insensitive
p79559
aVIt is not hard to solve, you can simply write a little static adapter method in a case sensitive language like C# that makes the call
p79560
aVYou can completely shove it under the doormat by making it an extension method, assuming the language supports it
p79561
aVThere will be no actual runtime overhead when the jit optimizer is done with it
p79562
as(dp79563
g9
V17034
p79564
stp79565
a((dp79566
g2
(lp79567
VLeave it up to the SMTP server to distribute the email to the recipients
p79568
aVUse the Bcc property if you don't want the recipient to see the other names
p79569
as(dp79570
g9
V17034
p79571
stp79572
a((dp79573
g2
(lp79574
VThis code doesn't belong in the Designer
p79575
aVcs file, the designer will eat it
p79576
aVIt doesn't belong in the form source code file either, only code relevant to the form class should be written there
p79577
aVProject + Add Class
p79578
aVIt gets automatically added to the toolbox after you compile
p79579
as(dp79580
g9
V17034
p79581
stp79582
a((dp79583
g2
(lp79584
VThat requires code
p79585
aVIn your program
p79586
aVIt isn't hard code, works without the debugger too
p79587
aVWhich tends to be important if you care about time
p79588
aVLook at, say, log4net to get this added automatically
p79589
as(dp79590
g9
V17034
p79591
stp79592
a((dp79593
g2
(lp79594
VThis blog post explains why you have this problem, pointer_default(unique) does not do what you think it does
p79595
aVAttribute the subcategory argument with [unique]
p79596
as(dp79597
g9
V17034
p79598
stp79599
a((dp79600
g2
(lp79601
VUse the Visual Studio Command Prompt, then
p79602
aVOr if you prefer the IDE, then File + New + Project, Visual C++, General node, pick the Makefile Project template
p79603
aVName = libevent-2
p79604
ag2512
aV10-stable, Location = parent directory (\u005cwhere\u005cyou\u005cput)
p79605
aVOK
p79606
aVNext
p79607
aVBuild command = nmake -f makefile
p79608
aVnmake, rest blank
p79609
as(dp79610
g9
V17034
p79611
stp79612
a((dp79613
g2
(lp79614
VNo signals in Windows
p79615
aVIf true killing is intended then use TerminateProcess()
p79616
aVYou need a handle to the process, get that from OpenProcess()
p79617
aVYou'll need to ask for the PROCESS_TERMINATE access right
p79618
aVCloseHandle() to close the handle
p79619
as(dp79620
g9
V17034
p79621
stp79622
a((dp79623
g2
(lp79624
VYou can do this with the Windows Image Acquisition API
p79625
aVGet this started with Project + Add Reference, Browse tab, navigate to c:\u005cwindows\u005csystem32\u005cwiaaut
p79626
aVdll
p79627
aVThat's a COM component, you'll get an interop library for it with interface types in the WIA namespace
p79628
aVFirst thing you want to do is get a reference to the camera, use WIA
p79629
aVShowSelectDevice()
p79630
aVIt returns a Device object if there's only one camera attached, a dialog to let the user select if there are more
p79631
aVLike this:
p79632
aVThat ought to get you started
p79633
aVCheck out the code snippets at this MSDN page for more of the thing you can do with the API
p79634
aVBeware that not all cameras allow you do use them interactively when they are attached to the machine
p79635
aVMy cheapo point-and-shoot doesn't
p79636
as(dp79637
g9
V17034
p79638
stp79639
a((dp79640
g2
(lp79641
VSeveral ways to do this:
p79642
aVUse DateTime
p79643
aVNow
p79644
aVSubtracting produces a TimeSpan
p79645
aVTakes 8 bytes of storage, times up to 8000 years, resolution of 1 millisecond but accurate to 1/64 second on most machines
p79646
aVUse Environment
p79647
aVTickCount
p79648
aVSimilar to time_t but relative from machine boot time
p79649
aVTakes 4 bytes of storage, times up to 24 days (49 with a cast), resolution and accuracy same as DateTime
p79650
aVUse Stopwatch
p79651
aVStored on the heap, resolution is machine dependent but almost always well below a microsecond
p79652
aVAccuracy isn't usually good but repeats decently, assume +/- 5%
p79653
aVBest used to measure small intervals for comparison
p79654
aVUse timeGetTime
p79655
aVThis requires pinvoke to use this multimedia timer
p79656
aVSimilar to Environment
p79657
aVTickCount, you can get 1 msec accuracy by using timeBeginPeriod
p79658
aVThis is not cheap since it has system-wide effects
p79659
aVBest avoided
p79660
aVKeep in mind that process execution is subject to the vagaries of overall operating system load, your program is sharing resources with the other 70-odd processes that are running
p79661
aVEither DateTime or TickCount has plenty of accuracy for that
p79662
as(dp79663
g9
V17034
p79664
stp79665
a((dp79666
g2
(lp79667
VWinforms doesn't let you change the border color of controls, they are fixed by the theme selected by the user
p79668
aVThe easiest way to get what you want that doesn't require writing your own control is to put the picture box inside of a Panel, making it slightly smaller
p79669
aVThen just change the BackColor of the panel
p79670
aVThe designer will fight you a bit since it tries to align controls to a grid, edit the Location and Size properties in the Properties window directly rather than mousing it
p79671
as(dp79672
g9
V17034
p79673
stp79674
a((dp79675
g2
(lp79676
VYou have to create a class that implements the IBindStatusCallback interface
p79677
aVYou can return E_NOTIMPL for most of the methods
p79678
aVUse OnProgress() to show progress
p79679
aVHere's a sample program that gets this done:
p79680
aVOutput:
p79681
as(dp79682
g9
V17034
p79683
stp79684
a((dp79685
g2
(lp79686
VIt is just a method name, its actual name doesn't have any significance
p79687
aVYou'd typically use a method with a name like that to listen for the Load event of the Form class
p79688
aVThe Winforms designer auto-generates it when you use the lightning bolt icon in the Properties window or when you double-click the form in the designer
p79689
aVThe name is more typically Form1_Load
p79690
aVBut do make it a practice to give the form a good Name first
p79691
aVLike MainWindow
p79692
aVThe Load event fires just before the window becomes visible
p79693
aVIt is useful because at that point the real window size and location is accurate, you might want to use it to move or size controls
p79694
aVOr anything else where the window size and location matters
p79695
aVImplementing the Load event for a Form is an anachronism that dates back to the VB6 days
p79696
aVEvents are meant to let code in other classes know what's happening
p79697
aVThe Winforms way is to override the OnLoad() method instead
p79698
aVThe designer favors the VB6 way though
p79699
aVIt isn't terribly wrong when you don't derive from the form
p79700
as(dp79701
g9
V17034
p79702
stp79703
a((dp79704
g2
(lp79705
VThe Scale() method isn't meant to do this
p79706
aVIt is a helper method to implement the AutoScaleMode property
p79707
aVWhen your control is created by the form's InitializeComponent() method, scaling is suspended with SuspendLayout()
p79708
aVWhich is why it has no effect in your constructor
p79709
aVThe AutoScaleMode property value is applied when the form handle is created
p79710
aVWhich cancels any scaling you applied
p79711
aVI think you are looking for e
p79712
aVGraphics
p79713
aVScaleTransform() in your OnPaint method
p79714
aVIt doesn't scale the control, it scales the drawing
p79715
aVIf you really did mean to scale the control then just change its Size property
p79716
as(dp79717
g9
V17034
p79718
stp79719
a((dp79720
g2
(lp79721
VThe bytes are backwards
p79722
aVYou want 0x5d to be the least significant byte, it has to come first
p79723
aVThis is a little-endian chip
p79724
aVIn VS, use Debug + Windows + Registers, right-click + tick SSE to see the register values
p79725
as(dp79726
g9
V17034
p79727
stp79728
a((dp79729
g2
(lp79730
Vmodopt is only used in IL
p79731
aVIt is the job of a
p79732
aVNET language compiler to interpret and generate it
p79733
aVEcma-335, Partition II, chapter 7
p79734
ag2582
aV1 mentions it:
p79735
aVCustom modifiers, defined using modreq
p79736
aV(\u201crequired modifier\u201d) and modopt
p79737
aV(\u201coptional modifier\u201d), are similar to
p79738
aVcustom attributes (21) except that
p79739
aVmodifiers are part of a signature
p79740
aVrather than being attached to a
p79741
aVdeclaration
p79742
aV[Rationale: The distinction between
p79743
aVrequired and optional modifiers is
p79744
aVimportant to tools other than the CLI
p79745
aVthat deal with the metadata, typically
p79746
aVcompilers and program analysers
p79747
ag3471
aVrequired modifier indicates that there
p79748
aVis a special semantics to the modified
p79749
aVitem that should not be ignored, while
p79750
aVan optional modifier can simply be
p79751
aVignored
p79752
aVFor example, the const qualifier in
p79753
aVthe C programming language can be
p79754
aVmodelled with an optional modifier
p79755
aVsince the caller of a method that has
p79756
aVa const-qualified parameter need not
p79757
aVtreat it in any special way
p79758
aVOn the
p79759
aVother hand, a parameter that shall be
p79760
aVcopy-constructed in C++ shall be
p79761
aVmarked with a required custom
p79762
aVattribute since it is the caller who
p79763
aVmakes the copy
p79764
aVend rationale]
p79765
aVIn other words, it allows adding metadata to declarations that do not matter to the CLR but do matter to the language
p79766
aVThe C++/CLI compiler in particular uses it
p79767
aVNecessarily so,
p79768
aVNET has no equivalent for the const keyword for example
p79769
as(dp79770
g9
V17034
p79771
stp79772
a((dp79773
g2
(lp79774
VYes, this code has very good odds to hang in the Release build
p79775
aVThe JIT optimizer doesn't know that the variable might be set to true by code outside of the method
p79776
aVYou need to tell it that, like this:
p79777
aVThe volatile keyword ensures that the jitter won't store the variable value in a CPU register
p79778
aVThat solves your problem, it is still not the right way to do it
p79779
aVYou should use an AutoResetEvent instead
p79780
aVIt ensures that the thread responds to the variable change is quickly as possible
p79781
aVAnd most importantly, it lets the thread block so it doesn't burn any cpu cycles
p79782
aVIn your thread:
p79783
as(dp79784
g9
V17034
p79785
stp79786
a((dp79787
g2
(lp79788
VAvoid using the proposed iteration approaches, you'll get a fairly random collection of controls unless your form is very simple
p79789
aVSimply declare the control array in your code and initialize it in the form constructor
p79790
aVLike this:
p79791
aVYou can now treat OrderNumbers just like you could in VB6
p79792
as(dp79793
g9
V17034
p79794
stp79795
a((dp79796
g2
(lp79797
VYou need to use the Task<> class to get an AggregateException
p79798
aVIt is a substitute for ThreadPool
p79799
aVQueueUserWorkItem()
p79800
as(dp79801
g9
V17034
p79802
stp79803
a((dp79804
g2
(lp79805
VIt is not the operating system that is causing the deadlock
p79806
aVYes, your stack trace will show it blocking on KiFastSystemCallRet() inside ntdll
p79807
aVdll
p79808
aVWith the stack trace pointing to the RET instruction after SYSENTER
p79809
aVBut it merely is doing what you asked it to do
p79810
aVUse the Debug + Windows + Threads window to see what your threads are doing
p79811
aVThe classic deadlock scenario is that one of the threads has acquired the synchronization object and is blocking
p79812
aVThe synchronization object that another thread is trying to acquire
p79813
aVThis is one of the most common threading headaches
p79814
as(dp79815
g9
V17034
p79816
stp79817
a((dp79818
g2
(lp79819
VBeing forced to guess with no repro steps whatsoever, I'd say you used View = Tile and made the TileSize property value too small
p79820
aVIf that's not it, copy and paste the content of InitializeComponent() from the form's Designer
p79821
aVcs file into your post
p79822
as(dp79823
g9
V17034
p79824
stp79825
a((dp79826
g2
(lp79827
VThat's not how you use the return value of GetKeyState()
p79828
aVDo it like this instead:
p79829
as(dp79830
g9
V17034
p79831
stp79832
a((dp79833
g2
(lp79834
VIt is in general better not to do this, there's nothing pretty about a process that constantly starts and immediately crashes again with the user helplessly looking at the carnage
p79835
aVBut I can only hand you the bullets, aiming the gun at your foot is up to you
p79836
aVYou'll need code like this:
p79837
aVBeware that I took a shortcut on the command line arguments
p79838
aVThey should be quoted if they contain a path to a file that contains spaces
p79839
aVDon't take shortcuts on the code you're supposed to put in the ellipsis
p79840
as(dp79841
g9
V17034
p79842
stp79843
a((dp79844
g2
(lp79845
VYes, write it just like that in your setting
p79846
aVThen just substitute ${PROGRAMDATA} at runtime:
p79847
as(dp79848
g9
V17034
p79849
stp79850
a((dp79851
g2
(lp79852
VThe cast is just wrong
p79853
aVThe address of stackinfo is a 64-bit value
p79854
aVYou cannot cast that to an uint without risking OverflowException
p79855
aVThere's no point in subtracting 4096 either, VirtualQuery() will find the base address anyway
p79856
aVFix:
p79857
aVDuffy's code can only work for 32-bit code
p79858
as(dp79859
g9
V17034
p79860
stp79861
a((dp79862
g2
(lp79863
VYou need to read the processor manual to drill this down
p79864
aVIt is triggered by a "trap", best described as an exception in the processor
p79865
aVA trap interrupts code execution and lets an operating system "catch" handler deal with the fault
p79866
aVA very common benign one is a page fault, raised when the processor tries to read data from RAM that isn't mapped yet
p79867
aVThat's how virtual memory is implemented
p79868
aVAn AccessViolation belongs to a group of traps that are hard faults that the operating system doesn't know how to handle
p79869
aVIt is called "General Protection Fault" in the processor manual
p79870
aVIt's a bit of a grab-bag, there are lots of ways to trigger a GPF
p79871
aVBy far the most common one is trying to read memory that isn't mapped, usually caused by heap memory corruption
p79872
aVFollowed by trying to execute a machine code instruction that isn't valid or can only be executed by privileged code, usually caused by stack memory corruption
p79873
aVThese traps are as nasty as they come, the processor simply cannot continue executing the program
p79874
aVThe operating system certainly doesn't know how to handle it, it raises an AccessViolation exception to give the program a shot at jerking the processor back to known-good code
p79875
aVPossible by using the  keywords in your code
p79876
aVNot a good idea btw, other than for custom error reporting, you have no idea how the state of your program got mutated before it died and thus no way to restore it back
p79877
aVWithout such an SEH handler, this ends up in a backstop that Windows provides
p79878
aVWhich puts an end to it by triggering WER, the Windows Error Reporting component
p79879
aVWhich ultimately terminates the process
p79880
as(dp79881
g9
V17034
p79882
stp79883
a((dp79884
g2
(lp79885
VYou have to use Assembly
p79886
aVLoadFile() to accomplish that
p79887
aVYou can't do it with AssemblyResolve, the CLR very carefully avoids re-loading assemblies since that would open the door to mixing different versions of the same class
p79888
aVWith some methods jitted against one version, some against another
p79889
aVWithout any way to guarantee which, hilarity ensues
p79890
aVLoadFile() is however a gun that shoots your foot and blows up in your face in very creative and hard to diagnose ways
p79891
aVOne joy is that the exact same type is incompatible when loaded twice
p79892
aVYou'd better rethink this
p79893
as(dp79894
g9
V17034
p79895
stp79896
a((dp79897
g2
(lp79898
VYou have to change the operating system language
p79899
aVControl Panel + Region and Language applet
p79900
aVRather a good idea since that ensures that you are debugging code the way your customer will be running it
p79901
aVOverriding the culture on your UI thread to be different from the system language is a very fertile source of hard to diagnose bugs
p79902
as(dp79903
g9
V17034
p79904
stp79905
a((dp79906
g2
(lp79907
VSet the DateTimePicker
p79908
aVMaxDate property
p79909
aVYou'll have to reject weekend days by validating the user's selection
p79910
aVUse the DateTime
p79911
aVDayOfWeek property
p79912
as(dp79913
g9
V17034
p79914
stp79915
a((dp79916
g2
(lp79917
VYou have to capture the mouse on the mouse down event
p79918
aVAny mouse moves after that are always routed to your window, even if the cursor is no longer hovering it
p79919
aVUse the Mouse
p79920
aVCapture() method in WPF
p79921
as(dp79922
g9
V17034
p79923
stp79924
a((dp79925
g2
(lp79926
VNo, you cannot specify a path in a type description
p79927
aVThe CLR looks for assemblies in the GAC or the directory that contains the startup EXE
p79928
aVYou can let it look in subdirectories by using the  element in your
p79929
aVconfig file
p79930
aVOther paths that are completely unrelated to the startup EXE directory requires implementing the AppDomain
p79931
aVAssemblyResolve event
p79932
aVDeploying DLLs in the same directory as the EXE is a wise thing to do
p79933
aVIt avoids DLL Hell
p79934
as(dp79935
g9
V17034
p79936
stp79937
a((dp79938
g2
(lp79939
VThat's not how it works
p79940
aVEvery
p79941
aVNET install is the same throughout the world
p79942
aVIt gets localized by satellite assemblies
p79943
aVThere's no need to detect this, your user will figure out what language pack to download when the exception messages look funny
p79944
aVI think it is automatic anyway
p79945
as(dp79946
g9
V17034
p79947
stp79948
a((dp79949
g2
(lp79950
VNuff said
p79951
aVSolve your problem by putting the code in the form constructor:
p79952
aVNote that using a panel is an easy way to make all the controls that are on it invisible
p79953
as(dp79954
g9
V17034
p79955
stp79956
a((dp79957
g2
(lp79958
VLazy<> is the exact opposite, it is a creation detail, not a destruction detail
p79959
aVFurthermore, the client has no decent reason to delay construction when interested in the content
p79960
aVThese are just wrong signals, return a Stream
p79961
as(dp79962
g9
V17034
p79963
stp79964
a((dp79965
g2
(lp79966
VThe Extensible Storage Engine api is quite old
p79967
aVThe docs for it have been retired, it think it was deprecated back in 2001
p79968
aVThe header file is still available in the SDK only to support legacy code
p79969
aVI can get your code built with Visual Studio
p79970
aVIf you really want to pursue this then you'd be wise to use an MSVC compiler and the MSFT version of the Windows SDK
p79971
aVYou can download the C++ Express edition of Visual Studio for free, it should have everything you need to build this
p79972
aVInvesting time into this isn't a very good idea
p79973
as(dp79974
g9
V17034
p79975
stp79976
a((dp79977
g2
(lp79978
VThe one thing that's different when running the Release build without a debugger is that the JIT optimizer is enabled
p79979
aVThe code runs faster
p79980
aVWhich has a strong correlation with your problem, threading problems are timing sensitive
p79981
aVCount yourself lucky (I'm sure you don't) that this goes wrong while your code is still running on your dev machine, the really nasty threading problems are the ones mess up your program once a week on your customer's machines
p79982
aVMaking this problem debuggable is still the most important way to tackle it
p79983
aVOther than Tools + Attach to Process, another way to get the debugger started is by using System
p79984
aVDiagnostics
p79985
aVDebugger
p79986
aVLaunch() in your code
p79987
aVYou'll get a dialog that lets you choose the debugger
p79988
aVAnother way that doesn't require attaching the debugger is to switch VS to the Release build
p79989
aVUse Tools + Options, Debugging, General and untick "Suppress JIT optimization on module load"
p79990
aVPressing F5 now runs your program with the optimizer enabled and the debugger pre-attached
p79991
aVStill not quite a slamdunk since having the debugger attached in itself causes timing differences
p79992
aVAnother common approach to tackle difficult concurrency bugs is to add logging to your code
p79993
aVWrite a line whenever it acquired a lock
p79994
aVWith luck, you'll quickly find the deadlock reason
p79995
aVIf you're not so lucky, the logging alters the thread timing enough to make the deadlock disappear
p79996
aVThere have been plenty of programs shipped with logging left enabled because that was the only way to keep them running
p79997
aVA code review is yet another approach, especially when done by somebody else
p79998
aVAnd last but not least, consider whether threading is really the optimal solution in your app
p79999
aVThe nagging "did I really solve it
p80000
aVfeeling never goes away, proving that threaded code is free of defects is close to impossible
p80001
as(dp80002
g9
V17034
p80003
stp80004
a((dp80005
g2
(lp80006
VThere are a lot more that don't start with WM
p80007
aVYou are trying to learn this from the inside out
p80008
aVLike learning how the file system works by reading the docs for CreateFile
p80009
aVDoesn't work
p80010
aVStarting top-down with Petzold is required
p80011
aVYou only need to learn the first 15%, the rest is automatic because you understand how it is structured and where to find the documentation
p80012
as(dp80013
g9
V17034
p80014
stp80015
a((dp80016
g2
(lp80017
VNot at all
p80018
aVLastWriteTime is updated after writing, not while writing
p80019
aVYou need to rely on whatever program is doing the uploading to put a lock on the file
p80020
aVAny decent one does
p80021
aVSo that trying to open the file with, say, the FileStream constructor with FileShare
p80022
aVRead or FileShare
p80023
aVNone will throw an IOException
p80024
aVThis will almost always work
p80025
as(dp80026
g9
V17034
p80027
stp80028
a((dp80029
g2
(lp80030
VUsing the Load event to initialize a form is an anachronism from the VB6 days
p80031
aVIt was really important back then, that unfortunately carried over in the design of the Winforms designer
p80032
aVIt made Load the default event for a form
p80033
aVThat is however not the
p80034
aVNET way, you initialize a class object with the constructor
p80035
aVThe only time you need to override OnLoad() (another
p80036
aVNET way, events are for code in other classes) is when you care about the size and position of the form
p80037
aVIt won't be the design Size and Location when the user changed the Windows theme or runs the video adapter at a higher DPI setting
p80038
aVSo you might want to use OnLoad to move the window or rearrange the controls
p80039
aVNot actually a very common thing to do
p80040
aVSo, fix your problem first by using the constructor instead
p80041
aVIf you still need OnLoad then just use a bool flag that keeps track of whether or not it already ran
p80042
aVAnd yes, this only works if you use ShowDialog()
p80043
aVA form that's displayed with Show() automatically disposes itself when it is closed
p80044
aVThat doesn't happen with ShowDialog() to avoid problems retrieving the dialog results
p80045
aVRe-creating the dialog instance is the better way, unless you really care about keeping the last entered values
p80046
aVThat's however a really expensive way to do so, form objects take a lot of
p80047
aVNET and Windows resources
p80048
as(dp80049
g9
V17034
p80050
stp80051
a((dp80052
g2
(lp80053
VThis is balloon tip abuse, you should only use them when the user doesn't otherwise have a way to find out that a task completed and she should follow up
p80054
aVIt is most definitely not appropriate to display a "Please wait" message, you should use a progress bar or an hourglass mouse cursor for that
p80055
aVYou can make it fancy on Win7 with the Windows API Code Pack by displaying progress in the task bar button
p80056
aVAnyhoo, you can pop a balloon by displaying another one with a short time-out
p80057
as(dp80058
g9
V17034
p80059
stp80060
a((dp80061
g2
(lp80062
VIn the MSVC compiler, C++ exceptions piggy-back onto the native Windows exception plumbing (SEH, Structured Exception Handling)
p80063
aVThere's a pretty big impedance mismatch though, the concept of an exception filter is doesn't have a good match in C++
p80064
aVBy the time the catch handler catches an exception, the SEH exception is already handled and the stack unwound
p80065
aVThe EXCEPTION_POINTERS info is gonzo
p80066
aVThe exception filters actually exist, that's how it filters for the specific type you want to catch, they are however auto-generated by the compiler
p80067
aVNo reasonable C++ syntax exists to make them useful
p80068
aVYou need to dip into the compiler support for handling SEH exceptions
p80069
aVUse the  keywords ( is optional) and have your filter catch the exception code for a C++ exception, 0xe04d5343 ('MSC')
p80070
aVYou do however lose the ability to catch a specific C++ exception type, that plumbing is buried in the CRT without source
p80071
aVPut a C++ try inside the  to fix that so your  only sees exceptions that the C++ code didn't filter
p80072
aVUsing SetUnhandledExceptionFilter() is another way to do this btw, you really should consider it to act as the ultimate backstop of any unhandled exception, independent of the code location
p80073
aVIt is the best way to create a minidump of a crashing app
p80074
aVLast but not least, creating a minidump of a crashing app inside the process itself isn't the best approach
p80075
aVThere are plenty of odds that this won't work well, the process state can be corrupted pretty badly
p80076
aVOne failure mode is having the process heap locked
p80077
aVNot unlikely considering that heap damage is a very common crash reason
p80078
aVFix that with a "guard process", use a named event to signal it to make a minidump
p80079
aVYour exception filter only needs to set the event, that always works
p80080
as(dp80081
g9
V17034
p80082
stp80083
a((dp80084
g2
(lp80085
VLook in HKLM\u005cSoftware\u005cWow6432Node, the home for registry keys that 32-bit programs can see
p80086
as(dp80087
g9
V17034
p80088
stp80089
a((dp80090
g2
(lp80091
VWrite it like this and build in the Release build:
p80092
as(dp80093
g9
V17034
p80094
stp80095
a((dp80096
g2
(lp80097
VThere are few explanations for this
p80098
aVBut one, you might have a Validating event handler that is canceling the validation
p80099
aVThis will also cancel OnFormClosing
p80100
aVFix:
p80101
aVBtw, there is no point in calling Suspend/ResumeLayout, there is no layout done at form closing time
p80102
aVAnd calling Controls
p80103
aVClear() does not actually dispose the controls
p80104
aVRather nasty behavior that trips up a lot of programmers
p80105
aVBest thing to do is to do nothing, parent controls automatically dispose their children controls
p80106
aVAnd there is no point in unsubscribing events either, the form object and the objC object only reference each other, no other references exist
p80107
aVThe garbage collector knows how to handle that
p80108
as(dp80109
g9
V17034
p80110
stp80111
a((dp80112
g2
(lp80113
VAn assembly reference to PresentationFramework is required
p80114
aVThe namespace is only available  in
p80115
aVNET 4
p80116
aVUse Project + Properties, verify the Target Framework setting
p80117
aVUsing it in a Winforms app is fine, the classes don't require the WPF plumbing to work
p80118
aVThey are wrappers for the Vista API extensions
p80119
as(dp80120
g9
V17034
p80121
stp80122
a((dp80123
g2
(lp80124
VOn your desktop run charmap
p80125
aVexe
p80126
aVTick "Advanced view" and type "box" in the Search box
p80127
aVYou'll get the Unicode codepoints that you can use to draw lines and boxes
p80128
aVCopy and paste them into your code
p80129
aVWhether they actually show up properly on your device depends on the font support
p80130
aVOdds are decent since they've been around since the first IBM PC
p80131
aVYou'll have to try
p80132
as(dp80133
g9
V17034
p80134
stp80135
a((dp80136
g2
(lp80137
VLeaving the
p80138
aVconfig files checked-in has one side-effect, the files stay read-only
p80139
aVWhich has one side-effect, you cannot copy a file over a read-only file and you can't delete it
p80140
aVWhich goes a long way towards explaining why you can't make it work
p80141
as(dp80142
g9
V17034
p80143
stp80144
a((dp80145
g2
(lp80146
VThe CLR uses a COM component to read
p80147
aVpdb files, diasymreader
p80148
aVdll, stored in the framework directory
p80149
aVOnly the programmatic interface for this component is documented (ISymUnmanagedReader)
p80150
aVNothing in the MSDN library about any kind of configuration option
p80151
aVNor does the CLR provide it with any
p80152
aVNot promising
p80153
aVI do however see a registry key in the binary dump of the DLL
p80154
aVLooks like HKLM\u005cSoftware\u005cMicrosoft\u005cVisualStudio\u005cMSPDB with a value named SymbolSearchPath
p80155
aVSounds like a great match, give it a shot by adding this key and value with Regedit
p80156
aVexe
p80157
aVMake it a string, containing the name of the directory with the
p80158
aVpdb files
p80159
as(dp80160
g9
V17034
p80161
stp80162
a((dp80163
g2
(lp80164
VI repro
p80165
aVGo ahead and assume it is a bug-fix
p80166
aVHaving the state going back to Stopped doesn't make much sense
p80167
aVThere's an old feedback report about it here
p80168
aVThey acknowledge that the behavior in
p80169
aVNET 2
p80170
aV0 doesn't match the documented behavior but that it was too late to fix the problem
p80171
aVAlthough closed, I strongly suspect they fixed it for 4
p80172
ag2512
aVIronically, it looks like the documented behavior was updated in the MSDN Library, now again mismatching the actual behavior
p80173
as(dp80174
g9
V17034
p80175
stp80176
a((dp80177
g2
(lp80178
VYou don't have to do anything
p80179
aVNET 1
p80180
aV1 doesn't have any support for running managed code in 64-bit mode
p80181
aVThat didn't become available until
p80182
aVNET 2
p80183
ag2512
aVAny EXE assembly compiled with VS2003 will ask for the 1
p80184
aV1 version of the CLR, it automatically runs managed code in 32-bit mode
p80185
aVSimilarly, you won't have the Corflags
p80186
aVexe utility either
p80187
aVIt originally shipped with the
p80188
aVNET 2
p80189
aV0 SDK, nowadays with the Windows SDK
p80190
aVVisual Studio 2005 and up lets you set the option bit in the cor header that Corflags
p80191
aVexe manipulates by letting you select the "Platform target" in the project options
p80192
aVDo watch out for 64-bit machines that don't have
p80193
aVNET 1
p80194
aV1 installed
p80195
aVThey'll run your app with the version 2 CLR and that is going to run in 64-bit mode
p80196
aVUAC as implemented in Vista and up can also cause trouble, your EXE won't have a manifest and Windows is going to treat it like a legacy program
p80197
aVWhich can be very hard to diagnose when that doesn't work out well
p80198
aVAnd VS2003 is unsupported on operating systems past XP
p80199
aVThere is a defect list, most of them are debugging problems
p80200
aVKeeping your tools updated with your customer's operating system capabilities is rather important btw, 8 years is a long time in dog years and software tools
p80201
as(dp80202
g9
V17034
p80203
stp80204
a((dp80205
g2
(lp80206
VThat's what it says in the About box of my copy of VS2008, just plain "9
p80207
ag2512
aV30729
p80208
aV1 SP"
p80209
aVI know for a fact that I have the service pack installed
p80210
aVAnd there is only one, there is never going to be another
p80211
aVClearly you have it too
p80212
as(dp80213
g9
V17034
p80214
stp80215
a((dp80216
g2
(lp80217
VRTB does not support this well
p80218
aVYou cannot even discover the range of characters within the selection that has the same font style
p80219
aVStart by checking the SelectionFont property first, it will be null if the selection contains a mix of styles
p80220
aVIf that's the case, you'll have to iterate the selection one character at a time by setting the SelectionStart and SelectionLength properties, read the SelectionFont until it changes
p80221
aVApply the changed font to the range you discovered
p80222
aVCheck this answer for a way to keep this reasonably quick and flicker-free
p80223
aVNote that implementing an editor with RTB is a favorite topic at codeproject
p80224
aVcom
p80225
aVBorrowing code, if not the entire project, is a good way to lessen the pain
p80226
as(dp80227
g9
V17034
p80228
stp80229
a((dp80230
g2
(lp80231
VYou are fretting over saving 0
p80232
aV0015% of the memory used by the stack
p80233
aVThis is not even an absolute savings, the memory used by an activation frame is re-used when the method exits
p80234
aVReplacing a local variable by a static one achieves the exact opposite, the memory for static variables is not re-used
p80235
aVIt will occupy memory for the life-time of the program
p80236
aVStatic variables are also a very fertile source of bugs, especially when you use threading
p80237
aVBad Idea, all around
p80238
as(dp80239
g9
V17034
p80240
stp80241
a((dp80242
g2
(lp80243
VIt is a "redistributable", it is only meant to install the required runtime assemblies into the GAC on the target machine
p80244
aVGetting a reference assembly that you can use on your dev machine would require an installer to leave a copy of the assembly in a 'well known location' and/or to write a registry key so that the reference assembly shows up in the Add Reference dialog
p80245
aVI suspect you get such a reference assembly only from installing VS2005
p80246
aVNot sure, I don't have it installed anymore
p80247
aVA reference assembly is just a copy of the one in the GAC
p80248
aVSo one possible workaround is to copy the assembly you need from the GAC to your project directory, allowing you to use the Browse tab of the dialog to add it to your project
p80249
aVThe shell extension that hides the internal structure of the GAC from Explorer makes that a bit of a hassle
p80250
aVUse a non-Explorer based file manager or the command prompt
p80251
aVIt is stored in a subdirectory of c:\u005cwindows\u005cassembly
p80252
as(dp80253
g9
V17034
p80254
stp80255
a((dp80256
g2
(lp80257
VIt is a low-level Windows error, ERROR_INVALID_HANDLE, error 6
p80258
aVGetting invalid handle values when you enumerate large amounts of data suggests that your app is not calling Dispose() when it should
p80259
aVOne possible diagnostic is TaskMgr
p80260
aVexe, Processes tab
p80261
aVView + Select Columns and tick "Handles"
p80262
aVObserve the displayed value for your program while it runs
p80263
aVThe big kaboom happens when it reaches 10,000 on most machines
p80264
aVReview your code for proper use of the using statement or calling Dispose() or Close() explicitly when a class you use implements it
p80265
as(dp80266
g9
V17034
p80267
stp80268
a((dp80269
g2
(lp80270
VNot that clear, let's focus on ShowWindow()
p80271
aVUse the SW_SHOWNOACTIVATE option to prevent the window from getting activated
p80272
as(dp80273
g9
V17034
p80274
stp80275
a((dp80276
g2
(lp80277
VIt is quite explicit in the documentation for the property:
p80278
aVThis property does not associate the
p80279
aVinput gesture with the menu item; it
p80280
aVsimply adds text to the menu item
p80281
aVThe
p80282
aVapplication must handle the user's
p80283
aVinput to carry out the action
p80284
aVFor
p80285
aVinformation on how to associate a
p80286
aVcommand with a menu item, see
p80287
aVCommand
p80288
as(dp80289
g9
V17034
p80290
stp80291
a((dp80292
g2
(lp80293
VYou are missing the kernel32
p80294
aVlib dependency
p80295
aVGetting it from a file named MSVCRTD
p80296
aVlib is very fishy, that's the import library for the CRT
p80297
aVDo make sure that whatever 'framework' you are using isn't trying to replace it
p80298
aVAnd make very sure that you haven't been copying
p80299
aVlib files to try to solve another linker problem
p80300
aVLike copying libcmtd
p80301
aVlib to msvcrtd
p80302
aVlib, that's guaranteed runtime trouble too
p80303
as(dp80304
g9
V17034
p80305
stp80306
a((dp80307
g2
(lp80308
VDon't pass null for the cookie name
p80309
aVAnd do pay attention to the return value, you should get false here because of the invalid name
p80310
aVUse  so an error doesn't go unnoticed
p80311
as(dp80312
g9
V17034
p80313
stp80314
a((dp80315
g2
(lp80316
VIt is frozen because you created it on another thread and that thread didn't call Application
p80317
aVRun()
p80318
aVWhich is required to 'pump the message loop'
p80319
aVMore here
p80320
aVDon't create windows on another thread
p80321
aVUse BackgroundWorker or Control
p80322
aVBeginInvoke or Dispatcher
p80323
aVBeginInvoke to let the UI thread of your program create the window
p80324
as(dp80325
g9
V17034
p80326
stp80327
a((dp80328
g2
(lp80329
VTools + Options, Projects and Solutions, Build and Run
p80330
aVChange the MSBuild project build output verbosity setting to Normal
p80331
aVYou'll get a Time Elapsed measurement at the end of the build
p80332
aVYou can turn this setting to 11 to get a detailed breakdown
p80333
aVBuild log output is automatically saved to the buildlog
p80334
aVhtm file in the project's build directory
p80335
aVThe equivalent command line option is /verbosity:normal (/v:n)
p80336
aVYou can get output logged to a file with redirection or the /fileLogger option (/fl)
p80337
aVType msbuild /
p80338
aVto get a summary of these options, there are a bunch more obscure ways to log
p80339
as(dp80340
g9
V17034
p80341
stp80342
a((dp80343
g2
(lp80344
VDrawing must always be relative from the control's client rectangle
p80345
aVIt is a common bug to make it relative from e
p80346
aVClipRectangle, works for quite a while too on Aero since it doesn't invalidate a window anymore when you drag another window across it
p80347
aVProduces very interesting graphics effects when Aero is turned off though, looks like the graphics equivalent of an echo
p80348
aVYou should only ever use e
p80349
aVClipRectangle to optimize your drawing code, skipping parts of what you draw when it is completely outside of the clipping area
p80350
aVGraphics already does a very good job of automatic clipping, making such a clip test pay off isn't that easy
p80351
aVAnd very hard when not everything is clipped, never optimize that
p80352
aVThere's little point left with Aero enabled
p80353
as(dp80354
g9
V17034
p80355
stp80356
a((dp80357
g2
(lp80358
VThis is not possible
p80359
aVThe TextBox class is a wrapper around a native Windows control that has been around since Windows version 2
p80360
aVIt had to run on some seriously sucky hardware, they had to break a few rules to make this work
p80361
aVOne of which is that it draws parts of itself without using the standard Windows paint cycle
p80362
aVInvalidate() and OnPaint() in Winforms terms
p80363
aVFixing this behavior wasn't possible due to app-compat problems
p80364
aVWay too much code out there that hacked the control in creative but unpredictable ways
p80365
aVAccordingly, it isn't possible to intercept the drawing to prevent it from erasing parts of your background image
p80366
aVThere is no workaround for this, creating your own is a lot of work
p80367
aVConsider WPF
p80368
as(dp80369
g9
V17034
p80370
stp80371
a((dp80372
g2
(lp80373
VYes
p80374
aVMultiple comparers do indeed get created, defaultComparer gets assigned multiple times
p80375
aVNot a problem, they are all the same
p80376
aVThe garbage collector takes care of the extras
p80377
aVAnd the atomic assignment guarantee that the CLR offers for object references ensures that the static cannot be read incorrectly
p80378
as(dp80379
g9
V17034
p80380
stp80381
a((dp80382
g2
(lp80383
VImpossible to guess without seeing code
p80384
aVThe heap might have been corrupted long before anyway
p80385
aVYou should use VariantClear()
p80386
as(dp80387
g9
V17034
p80388
stp80389
a((dp80390
g2
(lp80391
VSeveral syntax mistakes in your code
p80392
aVDon't use square brackets, use (25)
p80393
aVFirst argument is wrong, it must be a reference to a Form1 instance, not an array of forms since bruteforce() is a method of Form1
p80394
aVMaybe you meant form1obj[counter]
p80395
as(dp80396
g9
V17034
p80397
stp80398
a((dp80399
g2
(lp80400
VSurrogate sharing is documented here
p80401
aVSharing only happens if the AppId matches
p80402
aVGive yours a unique one
p80403
as(dp80404
g9
V17034
p80405
stp80406
a((dp80407
g2
(lp80408
VUse AfxGetResourceHandle()
p80409
as(dp80410
g9
V17034
p80411
stp80412
a((dp80413
g2
(lp80414
VYou cannot cast, you don't have the assembly added as a reference in your project
p80415
aVYou need to use Reflection to get the object properties
p80416
aVUse Type
p80417
aVGetProperty and PropertyInfo
p80418
aVGetValue
p80419
aVNote how the C# version 4 dynamic keyword can lessen the syntax pain considerably, recommended
p80420
as(dp80421
g9
V17034
p80422
stp80423
a((dp80424
g2
(lp80425
VYou get an exception when a DLL isn't found
p80426
aVOr more commonly in your case, a COMException as soon as you try to use the interop library in your code
p80427
aVOne drastic mistake you could make is catching such an exception
p80428
aVThat's a very common mistake
p80429
aVBut don't, undiagnosable failure is the result
p80430
aVThere is rarely any point in letting your program continue running when an important chunk of code is just missing
p80431
aVLogging it isn't hard when you use AppDomain
p80432
aVUnhandledException
p80433
aVThis should at the very least provide you with decent diagnostics that help you to fix your code
p80434
aVYou cannot get this started until you get good exception info
p80435
aVPre-emptively fixing rather than waiting for the customer to get back to you with an exception trace usually requires you to recreate possible client configurations and testing your code
p80436
aVHighly advisable btw with 4 versions of IE in common use
p80437
aVYou'll need a virtual machine so you can install the different OS and IE versions and test your code
p80438
aVMaking the OS and IE version a system requirement is not unreasonable, ymmv
p80439
as(dp80440
g9
V17034
p80441
stp80442
a((dp80443
g2
(lp80444
VYour boss can call functions exported by a DLL with the Declare statement
p80445
aVThat doesn't scale well but is fine for a simple API
p80446
aVYour function should be exported with the extern "C" and __declspec(dllexport) declarators, use the __stdcall calling convention and use only simple argument types
p80447
as(dp80448
g9
V17034
p80449
stp80450
a((dp80451
g2
(lp80452
VRightToLeft layout is meant for the Arabic and Hewbrew cultures, they write text right-to-left
p80453
aVIt also affects how text is rendered, you found a side-effect
p80454
aVYou need to use owner-draw to get it the way you want it
p80455
aVAdd a new class to your project and paste the code shown below
p80456
aVCompile
p80457
aVDrop the new control from the top of the toolbox onto your form
p80458
as(dp80459
g9
V17034
p80460
stp80461
a((dp80462
g2
(lp80463
VNo, it is complaining about  missing from the function definition but present on the function declaration
p80464
aVYou ought to take this seriously, it doesn't make sense to declare the function imported from a DLL but also present in your code
p80465
aVYou can't have it both ways
p80466
aVThis is usually caused by a missing #define
p80467
aVYou edited down the macro definitions, I think, but when building the DLL you usually specify a macro in the build command (/D)
p80468
aVSo that the declaration of the function uses dllexport instead of dllimport
p80469
aVWhich ensures that the function gets exported from the DLL
p80470
aVThe client code uses the same
p80471
aVh file but is built without that macro defined
p80472
aVIt sees the function declared as dllimport
p80473
aVTake a closer look at the XMLIMPORT macro definition, __declspec(dllexport) should be close
p80474
aVAnother diagnostic is the exports of the DLL, visible with Dumpbin
p80475
aVexe /exports
p80476
aVThey should be missing if I guessed correctly
p80477
as(dp80478
g9
V17034
p80479
stp80480
a((dp80481
g2
(lp80482
VThis sounds very wrong, test data doesn't belong in a
p80483
aVlib
p80484
aVAnd testing code that's built in another way than it is used on the target machine is not a true test
p80485
aVVS keeps you out of trouble here, this just isn't possible
p80486
aVYou have to use another configuration to change the way the
p80487
aVlib gets built
p80488
aVHave the test app supply the test data to the
p80489
aVlib instead
p80490
aVJust as the real app supplies it with real data after you deployed it
p80491
as(dp80492
g9
V17034
p80493
stp80494
a((dp80495
g2
(lp80496
VOnly the
p80497
aVNET Thread
p80498
aVSuspend() method is deprecated
p80499
aVWhich is not what you want to do here, you are trying to suspend a process that probably isn't even a managed
p80500
aVEither way, you'd pinvoke the Windows SuspendThread() function
p80501
aVThat requires the thread handle, get that from OpenThread()
p80502
aVThat requires the thread ID, you can get that from
p80503
aVNET's ProcessThread
p80504
aVThis is all a rather big hammer, one you should avoid swinging
p80505
aVJust disabling the app's main window (EnableWindow API function) should be sufficient and far less random
p80506
aVNative API skills required either way, visit pinvoke
p80507
aVnet for the declarations you need
p80508
as(dp80509
g9
V17034
p80510
stp80511
a((dp80512
g2
(lp80513
VWhen you attach, there's an option in the dialog that lets you choose the kind of debugger you want
p80514
aVClick the Select button, ensure you have "Native" ticked
p80515
as(dp80516
g9
V17034
p80517
stp80518
a((dp80519
g2
(lp80520
VThis should not happen, an
p80521
aVobj in a
p80522
aVlib is only pulled in when it is needed
p80523
aVTry writing strcpy() in your code for example, no link error even though it is also present in the CRT lib
p80524
aVDo make sure that you don't need some of the functions in the source1
p80525
aVobj that's stored in the
p80526
aVlib
p80527
aVYou diagnose this by using the /verbose linker option
p80528
aVProject + Properties, Linker, Command Line, Additional options box
p80529
aVIt shows you what symbols get pulled from the
p80530
aVlib, search for source1
p80531
aVobj
p80532
aVOnce it gets used, you do get the linker error if there's a name collision
p80533
aVThis is of course error prone and best avoided
p80534
as(dp80535
g9
V17034
p80536
stp80537
a((dp80538
g2
(lp80539
VYou are indeed going to need lib
p80540
aVexe to turn the
p80541
aVdef file into a
p80542
aVlib file that the linker needs
p80543
aVIt is stored in the vc\u005cbin directory of the visual studio directory, C:\u005cProgram Files\u005cMicrosoft Visual Studio 10
p80544
aV0\u005cVC\u005cbin\u005clib
p80545
aVexe by default
p80546
aVThe easiest way is to use the "Visual Studio Command Prompt", you'll find it in the Start menu, Microsoft Visual Studio 2010, Visual Studio Tools
p80547
aVNext, run lib
p80548
aVexe with the /def:foo
p80549
aVdef option to generate the
p80550
aVlib
p80551
aVFollow the vendor's instructions, if provided
p80552
aVAnd don't hesitate to contact them for support
p80553
as(dp80554
g9
V17034
p80555
stp80556
a((dp80557
g2
(lp80558
VYou have to set the DataGridView
p80559
aVEnableHeadersVisualStyle properly to false to make changes to the Style
p80560
aVFore/BackColor property visible
p80561
as(dp80562
g9
V17034
p80563
stp80564
a((dp80565
g2
(lp80566
VWhat the heck kind of compiler are you using
p80567
aVIn general, making constants public is not a good idea
p80568
aVThey behave differently from readonly variables, their literal value gets compiled into the IL
p80569
aVWhich is a problem if the const is declared in another assembly
p80570
aVYou could, say, ship a bug fix for an assembly that modified the const value
p80571
aVThe other assemblies in your product will however continue to use the old value
p80572
aVThe jitter won't complain about the mismatch
p80573
aVNot good
p80574
aVA public const is only okay if it is a 'manifest' constant
p80575
aVLike Math
p80576
aVPI, only running the code in another universe could produce unexpected results
p80577
aVA product or company name is already pretty risky
p80578
as(dp80579
g9
V17034
p80580
stp80581
a((dp80582
g2
(lp80583
VMake argument values like that self-documenting by using a enum type instead
p80584
as(dp80585
g9
V17034
p80586
stp80587
a((dp80588
g2
(lp80589
VStart out by creating the view with FILE_MAP_READ | FILE_MAP_WRITE and protect with PAGE_READONLY
p80590
aVNow you have no trouble making it PAGE_READWRITE later:
p80591
as(dp80592
g9
V17034
p80593
stp80594
a((dp80595
g2
(lp80596
VNo real clue why you are doing this
p80597
aVYou'd normally use the FormClosed event to find out that a form got closed
p80598
aVThe e
p80599
aVCloseReason property tells you why, CloseReason
p80600
aVWindowsShutDown is the exact equivalent to checking for WM_QUERYENDSESSION
p80601
aVIf you want to make this close-down conditional then use the FormClosing event instead
p80602
aVThis works properly too when the user closes the form by means other than clicking the Close button
p80603
aVLike by pressing Alt+F4, using the system menu or the taskbar button thumbnail in Win7
p80604
as(dp80605
g9
V17034
p80606
stp80607
a((dp80608
g2
(lp80609
VIt is because of the way the stack pointer is restored when the method exits
p80610
aVThe standard prologue of a method, shown for the x86 jitter;
p80611
aVAnd the way it ends:
p80612
aVGetting the esp value unbalanced is not a problem here, it gets restored from the ebp register value
p80613
aVHowever, the jitter optimizer not infrequently optimizes this away when it can store local variables in cpu registers
p80614
aVYou'll crash and burn when the RET instruction retrieves the wrong return address from the stack
p80615
aVHopefully anyway, really nasty when it happens to land on a chunk of machine code by accident
p80616
aVThis is liable to happen when you run the release build without a debugger, tough to troubleshoot if you didn't have the MDA to help you
p80617
as(dp80618
g9
V17034
p80619
stp80620
a((dp80621
g2
(lp80622
VThis is pretty accurate
p80623
aVThe core code that makes Windows kernel tick is the same between XP and Windows 2003
p80624
aVThis also happened later, Vista and Windows 2008 share the same core
p80625
aVAnd Win7 and Windows 2008 R2
p80626
as(dp80627
g9
V17034
p80628
stp80629
a((dp80630
g2
(lp80631
VA pretty classic mistake is to use Control::Begin/Invoke() too often
p80632
aVYou'll flood the UI thread with delegate invoke requests
p80633
aVUI updates tend to be expensive, you can easily get into a state where the message loop doesn't get around to doing its low-priority duties
p80634
aVLike painting
p80635
aVThis happens easily, invoking more than a thousand times per second is the danger zone, depending on how much time is spent by the delegate targets
p80636
aVYou solve this by sending updates at a realistic rate, one that takes advantage of the ability of the human eye to distinguish them
p80637
aVAt 25 times per second, the updates turn into a blur, updating it any faster is just a waste of cpu cycles
p80638
aVWhich leaves lots of time for the UI thread to do what it needs to do
p80639
aVThis might still not be sufficiently slow when the updates are expensive
p80640
aVAt which point you'll need to skip updates or throttle the worker thread
p80641
aVNote that Invoke() automatically throttles, BeginInvoke() doesn't
p80642
as(dp80643
g9
V17034
p80644
stp80645
a((dp80646
g2
(lp80647
VCreating a thread instead of using a TP thread is quite expensive, both in system resources and time
p80648
aVPassing data through, say, a thread-safe queue can be performant, provided you haven't maxed out the available cores (which sounds very likely) and the receiving thread is blocking on a synchronization object that you signal
p80649
aVTypical thread context switch cost is between 2000 and 10,000 machine cycles, you are probably on the low end since the thread runs in the same address space
p80650
aVThe real cost is the difficulty of getting so many threads to run correctly without endlessly chasing races and deadlocks
p80651
as(dp80652
g9
V17034
p80653
stp80654
a((dp80655
g2
(lp80656
VThis depends on the jitter your machine uses to run this program
p80657
aVBut since you use only two local variables, it is very likely the correct answer is zero
p80658
aVThe jit optimizer stores the variable values in CPU registers
p80659
aVThat's one of the standard optimizations
p80660
aVYou'll find more about the kind of optimizations that the jitter performs in this answer
p80661
as(dp80662
g9
V17034
p80663
stp80664
a((dp80665
g2
(lp80666
VThere are lots of places where an object's ToString() method automatically gets called
p80667
aVSome of the more obvious ones are debugger watch expression, composite string formatting (String
p80668
aVFormat and Console
p80669
aVWrite), UI controls like ListBox
p80670
aVWhile you can certainly override the way they format and invoke your custom method, it is just easier to override ToString()
p80671
as(dp80672
g9
V17034
p80673
stp80674
a((dp80675
g2
(lp80676
VHow could it get the metadata for the base class if you don't provide it
p80677
aVIt doesn't get copied from the base class to the derived class and stored in the derived class' assembly
p80678
aVYour vendor scenario is just not realistic
p80679
aVNobody designs class hierarchies that are a hundred classes deep, let alone store each of them in a separate assembly
p80680
aVThis tops out at six or seven, at worst
p80681
aVWith one base assembly, sometimes two
p80682
aVAny deeper and nobody can understand how it works anymore
p80683
as(dp80684
g9
V17034
p80685
stp80686
a((dp80687
g2
(lp80688
VThere is no adaptive optimization in currently shipping
p80689
aVNET jitter versions from Microsoft
p80690
aVOnce the machine code is generated it doesn't get altered anymore
p80691
aVNor is there a sub-system that monitors code execution to provide profiling data that a 'hot-spot' optimizer could use
p80692
aVYou'll find an overview of jitter optimizations in this answer
p80693
as(dp80694
g9
V17034
p80695
stp80696
a((dp80697
g2
(lp80698
VThis is quite normal, one of the things that a multi-tasking operating system needs to do
p80699
aVThe directory is in fact marked for deletion but it cannot be removed yet because one or more processes has a handle open on the directory
p80700
aVIn the case of Windows, that is commonly a process that uses the the directory as its default working directory
p80701
aVOr maybe you've got an Explorer window open, looking at how your program is doing its job
p80702
aVExplorer uses ReadDirectoryChangesW() to get notified about changes in the directory so it knows when to refresh the view
p80703
aVThe directory will be physically removed from the drive as soon as the last handle is closed
p80704
aVWhile it exists in this zombified state, any attempt to do anything with the directory will produce an access error (Windows error code 5)
p80705
aVYou'll need to account for this behavior in your program
p80706
aVDefinitely remove the second Directory::Exists() test, when you didn't get an exception from the Delete call you'll need to assume that the directory got deleted
p80707
aVThat will be accurate, eventually
p80708
as(dp80709
g9
V17034
p80710
stp80711
a((dp80712
g2
(lp80713
VYour itty-bitty machine is no match against the hardware and smarts that Google throws at the search problem
p80714
aVUse Google to search, you can use the site: selector to narrow the search to MSDN Library pages
p80715
aVThe Microsoft search page is not entirely unfunctional either but lately tends to show too many unhelpful MSDN forum questions
p80716
aVYou find topics in DE by using the index
p80717
aVWhich is very well done, it does take a bit of time to learn how to use it however
p80718
aVThe Contents tab is only useful when you found a topic and want to see associated topics or introductory material
p80719
aVUse the "Sync with Table of Contents" button on the toolbar
p80720
aVIt doesn't always work for older topics
p80721
as(dp80722
g9
V17034
p80723
stp80724
a((dp80725
g2
(lp80726
VThis is not possible of course
p80727
aVWhatever breadcrumb you leave to record that the program was ran has to be left on the same machine
p80728
aVLeaving any user with sufficient skills or good enough tools (like SysInternals' ProcMon) to find out where you dropped it and remove it again
p80729
aVAssuming they care enough about making the effort
p80730
aVThe simple solution is to intentionally cripple your demo so that an important feature is missing that would make it useful
p80731
aVLike File + Save
p80732
aVNot just disabled, completely missing in the code as well so hacking the demo program doesn't work either
p80733
aVEasy to do with an #if directive in your source code
p80734
as(dp80735
g9
V17034
p80736
stp80737
a((dp80738
g2
(lp80739
VOverride the ProcessCmdKey() method of the form
p80740
aVIt gets called straight from the message loop, before the keyboard message is dispatched to the control with the focus
p80741
aVWhich is why overriding WndProc() doesn't work
p80742
aVTechnically, you can also override the form's OnKeyDown method with KeyPreview = true, but that's an ugly VB6 anachronism
p80743
as(dp80744
g9
V17034
p80745
stp80746
a((dp80747
g2
(lp80748
VYou simply specify the UNC name of the file in your fopen() statement
p80749
aVLike //server/share/filename
p80750
aVThe remote machine must be configured to support file sharing and the user account under which your program runs must have sufficient access rights
p80751
aVIf "remote" means through the Internet then you have to use one of the standard Internet protocols
p80752
aVFTP or HTTP are typical
p80753
as(dp80754
g9
V17034
p80755
stp80756
a((dp80757
g2
(lp80758
VYou can get the kind of transparency you are looking for on the desktop version of
p80759
aVNET by overriding the Windows style flags for a control
p80760
aVYou'd override CreateParams and turn on WS_EX_TRANSPARENT
p80761
aVThat's however not available on CF
p80762
aVThe simple solution is to just override the Paint event of the PictureBox and draw the text with Graphics
p80763
aVDrawText()
p80764
aVWith the added benefit that this is a lot cheaper than a Label control
p80765
as(dp80766
g9
V17034
p80767
stp80768
a((dp80769
g2
(lp80770
VYou are seeing the effect of the stdout output buffer that the program is using
p80771
aVThis is a standard feature of the C runtime library, buffering is enabled when it detects that it is writing to a pipe instead of the console
p80772
aVInstead of automatically flushing after each printf() statement in the program
p80773
aVThe buffer is usually around 2 kilobytes
p80774
aVAnd only gets flushed when it fills up
p80775
aVThis greatly enhances efficiency, flushing every time adds a lot of overhead
p80776
aVImportant in normal redirect scenarios, when output is written to a file or device
p80777
aVYou can see where this is going, the clumps you see are the content of that buffer
p80778
aVThere is no simple fix for this, surgery is required in the program to disable the buffer or flush it where it matters
p80779
aVThat's invariably where the buck stops, you would not be doing this if you could alter the program
p80780
aVYou could drip-feed your console by buffering what you get from OutputDataReceived but that's a bit silly perhaps
p80781
aVYou won't see this effect when the program is sending output faster than you can process it
p80782
aVWhich is pretty common
p80783
aVIt effectively gets throttled, blocking while waiting for the output buffer to empty and quickly filling it back up
p80784
aVThere's one more explanation for this, the rate at which OutputReceived can fire also depends on how many threadpool threads you've got running
p80785
aVIf that's more than the number of cpu cores, the tp thread that calls OutputReceived may be delayed by a multiple of 0
p80786
aV5 seconds
p80787
aVYou would however see the clumping on all programs you redirect
p80788
as(dp80789
g9
V17034
p80790
stp80791
a((dp80792
g2
(lp80793
VYes, no problem
p80794
aVYou will however have to make sure that the user cannot click the button again while the BGW is busy
p80795
aVEasily done by setting the Enabled property, stops the button action and provides excellent visual feedback to the user
p80796
aVTry this for example:
p80797
as(dp80798
g9
V17034
p80799
stp80800
a((dp80801
g2
(lp80802
VThese are the statements that cause your trouble
p80803
aVI'll pick-off the easy one first, don't make the BackColor of the form the same as the caption color
p80804
aVIf you want to pick a theme color then only choose the "Control" color
p80805
aVAlbeit that you'll typically get the old battleship gray
p80806
aVPicking a neutral pastel color is your best bet but honoring the user's preference will never get you into trouble
p80807
aVThe AutoScaleDimensions property is auto-generated, based on the video adapter's DPI setting
p80808
aVWhich is different the XP machine
p80809
aVYou've got 120 dots-per-inch on your dev machine, 96 DPI (the default) on XP
p80810
aVOn Win7, that's set by the widget that looks like a ruler, Control Panel + Display, "Set custom text size (DPI)"
p80811
aVThe AutoScaleMode property is correctly set to Font
p80812
aVThis ensures that all controls are automatically scaled to fit the font size
p80813
aVWhich is larger on your Win7 machine because of the higher DPI setting
p80814
aVAccordingly, the form and its controls shrink on the XP machine
p80815
aVThe problem with the NumericUpDown control is that its a bit buggy (in more than one way), it doesn't scale the up/down glyphs properly
p80816
aVThey are proportionally too large, not leaving enough room for the text portion
p80817
aVSimply making it a bit wider solves the problem
p80818
aVAuto-scaling is fairly ugly, it is rarely 100% perfect
p80819
aVThe best thing to do is to switch your dev machine to 96 dpi
p80820
aVA very common setting, still today
p80821
aVScaling up almost always works better than scaling down
p80822
as(dp80823
g9
V17034
p80824
stp80825
a((dp80826
g2
(lp80827
VThat's not the way it works, you only provide the [DllImport] declaration in your C# code
p80828
aVJust the way you'd find them on pinvoke
p80829
aVnet or a tool like the P/Invoke Interop Assistant
p80830
aVFinding out how to actually use the API function requires studying C or C++ code
p80831
aVAnd in general understanding how the Windows API works
p80832
aVThe best place to get started with that is Petzold's seminal book "Programming Windows"
p80833
aVYou can find source code samples in C/C++ in the Windows SDK documentation and the many samples that are included with the full version of the SDK
p80834
aVAnd the web of course, just by searching for the function name
p80835
aVSomewhat ironically, the number of samples you'd find on the web these days that are written in a managed language start to out-number the C/C++ samples
p80836
aVBeware of VB6 declarations (Declare keyword), also widely available, its types are not compatible with
p80837
aVNET
p80838
aVSites like codeplex
p80839
aVcom and codeproject
p80840
aVcom are a good place to find libraries with managed class wrappers around native API calls
p80841
aVYou'd normally simply use the library
p80842
aVLast but not least, stackoverflow
p80843
aVcom is an excellent resource ;)
p80844
as(dp80845
g9
V17034
p80846
stp80847
a((dp80848
g2
(lp80849
VMSIL is quite powerful, it has no trouble with standard compliant C++03 code
p80850
aVThe only "constructs" I know of that it cannot deal with is the __fastcall calling convention, r-value references as implemented in the C++0x additions in VS2010 and obvious machine specific extensions like the __asm keyword (inline assembly) and intrinsics
p80851
aVMost any native C++ you compile with /clr in effect will use pointers, either explicitly or compiler-generated to implement things like C++ classes and references
p80852
aVMSIL has no trouble with it but that code is not verifiable, any MSIL that uses pointers is rejected by the verifier
p80853
aVThis is not necessarily a problem, lots of code runs in full-trust
p80854
aVYou'll only get in trouble when you try to run it on sandboxed execution environments, like a browser, a phone or a game console
p80855
aVOr when your customer has a nervous system administrator
p80856
aVUsing /clr:pure is otherwise pretty useless
p80857
aVThe point of using C++/CLI is for its great support for interop with native code
p80858
aVCompiling native code to MSIL is largely a waste, the JIT optimizer can't do as effective a job as the native code optimizer
p80859
as(dp80860
g9
V17034
p80861
stp80862
a((dp80863
g2
(lp80864
VThe simple solution is to set the PictureBox::Dock property to Fill and change the form's ClientSize property
p80865
aVWhich helps you get to the more efficient solution, no need to burn up a control when you can simply override the form's OnPaint() method and call e->Graphics->DrawImage()
p80866
aVChanging the form's AutoSize property to True works too
p80867
aVSet AutoSizeMode to GrowAndShrink to allow it to get smaller
p80868
aVAnd a MinimumSize would be advisable
p80869
aVBeware that it is very unusual for programs to automatically change their window sizes
p80870
aVI can't think of a single program I commonly use that does this
p80871
aVThe right way is to leave it up to the user to size and position the windows
p80872
aVSetting the AutoScroll property to True is now the right thing to do
p80873
as(dp80874
g9
V17034
p80875
stp80876
a((dp80877
g2
(lp80878
VWell, so I understand that I cannot
p80879
aVexpect Microsoft (not to mention
p80880
aVsmaller companies) to add
p80881
aVcustomization for each and every one
p80882
aVof menu items
p80883
aVWell, they did
p80884
aVThey as in Microsoft anyway, this is otherwise common in well designed UIs like the one in Visual Studio
p80885
aVYou use Tools + Customize, Commands tab, Context menu radio button, "Other Context Menus | Easy MDI Document Window"
p80886
aVRemove/add what you dis/like
p80887
aVClick around a bit, see what you can do
p80888
aVDon't fear the menu
p80889
aVIf the capability is not present, it may be possible to hack the menu if it is stored as a native resource
p80890
aVFile + Open + File, select the
p80891
aVexe and browse the Menu nodes
p80892
aVIt is not that common to use native menus anymore these days
p80893
aVPlenty of opportunity for trouble as well
p80894
aVHacking the program with a hook set by SetWindowsHookEx() is another long distance shot
p80895
as(dp80896
g9
V17034
p80897
stp80898
a((dp80899
g2
(lp80900
VOnly C++/CLI supports a module initializer
p80901
aVAnd that's only indirectly, it uses them to get the CRT started and to get unmanaged variables and objects initialized
p80902
aVYou have to write on in IL
p80903
aVI tried, it worked just fine on Silverlight 4:
p80904
aVIts a silly example, the module initializer sets a static field of Class1
p80905
aVI then created an instance of Class1 in a sample Silverlight app and verified the value with the debugger
p80906
aVThis exact same code did not work in the Windows Phone emulator
p80907
aVI should have modified the TargetFrameworkAttribute, did not actually try this
p80908
aVI doubt that it is the source of the problem
p80909
as(dp80910
g9
V17034
p80911
stp80912
a((dp80913
g2
(lp80914
VYes, this is baked-in behavior of the native Window edit control
p80915
aVForcing the WS_HSCROLL style bit on makes no difference, it doesn't show the horizontal scrollbar anyway
p80916
aVSomewhat defensible, it would look quite ugly
p80917
aVIt isn't much of a practical problem, the user knows what she just entered in the box
p80918
as(dp80919
g9
V17034
p80920
stp80921
a((dp80922
g2
(lp80923
VYou must be working from an older version of the SDK
p80924
aVVersion 7
p80925
aV0 declares the arguments like this:
p80926
aVNote the __in_opt annotation, it marks the argument as optional, indicating that passing NULL is acceptable
p80927
aVThese are an early version of SAL annotations, an acronym for Source code Annotation Language
p80928
aVThere's an MSDN article for them, it however documents the syntax that's used in the C/C++ library #include files
p80929
aVNot quite sure why the SDK group doesn't use the same, they tend to be a bit slow to catch up
p80930
aVShort from making the declarations more readable, removing the ambiguity of C declarations, the annotations are also useful to tools
p80931
aVGood examples are the Code Analyzer that's built into the higher SKUs for VS2008 and VS2010 (it catches programming bugs)
p80932
aVAnd the P/Invoke Interop Assistant, a tool that generates C# or VB
p80933
aVNET p/invoke declarations using a dbase that was generates from the annotated SDK header files
p80934
aVThe annotations are essential to generate good C# declarations
p80935
aVYou can use these annotations in your own code as well, it will automatically be verified by the Code Analyzer if you do
p80936
aVDo use the modern syntax as documented in the MSDN article
p80937
aVI think the required sal
p80938
aVh header gets pulled in on just about any source file that #includes CRT headers
p80939
as(dp80940
g9
V17034
p80941
stp80942
a((dp80943
g2
(lp80944
VThe Console class allows you to replace the output and error streams
p80945
aVJust what you need here, you can replace them with a TextWriter that also logs what is written
p80946
aVA sample implementation:
p80947
aVUsage:
p80948
as(dp80949
g9
V17034
p80950
stp80951
a((dp80952
g2
(lp80953
VCrummy error code, it doesn't mean anything more than "it didn't work, don't know why"
p80954
aVFocus on getting your machine stable again and reinstall
p80955
aVOr use connect
p80956
aVmicrosoft
p80957
aVcom if it is a specific malfunction related to, say, your project
p80958
aVYou'll need to give them something to repro the error on their own machines
p80959
as(dp80960
g9
V17034
p80961
stp80962
a((dp80963
g2
(lp80964
VThis is an odd glitch in WPF, it is missing the plumbing to activate visual styles
p80965
aVDoubly-odd because this isn't hard to do
p80966
aVThe workaround is modify the manifest that gets embedded in your program
p80967
aVSelect your EXE project, then Project + Add New Item, General, select Application Manifest File
p80968
aVYou get the default manifest that gets embedded, note the  and  elements
p80969
aVPaste this in between:
p80970
aVThe message box will now have the operating system's visual style, the Aero look with the glowing close button by default on Vista and up
p80971
aVIf you do this in Visual Studio 2010 then this manifest entry is already present but is commented out
p80972
aVYou'll find it at the bottom of the file
p80973
aVJust remove the comments, the  before  and the  after
p80974
aVBeware that this manifest is not enabled when you run with the debugger and the Visual Studio hosting process enabled
p80975
aVThat's a different
p80976
aVexe file in your build directory, yourapp
p80977
aVvshost
p80978
aVexe
p80979
aVProject + Properties, Debug tab, scroll down, untick "Enable the Visual Studio hosting process"
p80980
aVThat has a few side effects related to security, there isn't much point in actually doing this since your user will never have this problem
p80981
as(dp80982
g9
V17034
p80983
stp80984
a((dp80985
g2
(lp80986
VUse Graphics
p80987
aVRotateTransform() to get the string rotated the way you want it
p80988
aVYou'll need TranslateTransform() and MeasureText() to get the start-point right
p80989
as(dp80990
g9
V17034
p80991
stp80992
a((dp80993
g2
(lp80994
VYou do not use a [DllImport] directive to call code that's written in managed C++
p80995
aVThat is only intended for native DLLs that export their functions
p80996
aVNeither of which applies to yours, it isn't native and you don't export the function
p80997
aVYou built a managed assembly, you can treat it just like one you'd have written in C#
p80998
aVProject + Add Reference, Browse tab, navigate to the DLL
p80999
aVOr better yet, put both projects in one solution, use the Projects tab to select the reference
p81000
as(dp81001
g9
V17034
p81002
stp81003
a((dp81004
g2
(lp81005
VThis isn't any different then writing past the end of a buffer that's allocated on the heap
p81006
aVThe operating system can only slap your fingers if you write to virtual memory that isn't mapped
p81007
aVMapping is page based, one page is 4096 bytes
p81008
aVYou'll have to write past this page to get the kaboom
p81009
aVChange your for-loop to end at (4096+4)/4 to repro it
p81010
as(dp81011
g9
V17034
p81012
stp81013
a((dp81014
g2
(lp81015
g3471
aVNET char takes two bytes, it stores a Unicode codepoint encoded in utf-16
p81016
aVUse byte instead of char in the declaration
p81017
aVUse Encoding
p81018
aVASCII
p81019
aVGetBytes() to fill the byte[] if you actually need these fields to be strings
p81020
as(dp81021
g9
V17034
p81022
stp81023
a((dp81024
g2
(lp81025
VThere is no configuration for this
p81026
aVThe designer does the Right Thing, it only removes event handlers that have no code
p81027
aVAs soon as you put something in the method body then it preserves what you've written and generates a new method
p81028
aVThis ensures that you don't lose code and ensures that you don't have dead methods littering your code
p81029
aVBeware that adding more than one event handler for a control's event in the same class (form) makes very little sense
p81030
aVYou should just merge the code of the handlers
p81031
aVThis also ensures that you won't have any surprises, the order in which multiple subscribers for the same event runs is fairly unpredictable
p81032
aVThe designer only supports a single event handler, simply because it doesn't have any way to track more than one
p81033
as(dp81034
g9
V17034
p81035
stp81036
a((dp81037
g2
(lp81038
VThey used to, a long time ago, although that was typical only for C compilers
p81039
aVThe first one I used worked that way, a long time ago
p81040
aVNot unusual for ones that generated code for unusual hardware and operating systems, they saved the cost of writing the object file generator and leveraged existing linkers
p81041
aVModern compilers don't bother with the extra step of generating machine code as text and running an assembler afterward, they generate the machine code directly in binary form
p81042
aVThe compile speed advantage is fairly significant, text isn't cheap
p81043
aVThe option to generate it in textual form from binary is pretty simple to implement
p81044
as(dp81045
g9
V17034
p81046
stp81047
a((dp81048
g2
(lp81049
VThe BigRational class didn't make the cut for the
p81050
aVNET 4
p81051
aV0 release
p81052
aVYou can download it here
p81053
as(dp81054
g9
V17034
p81055
stp81056
a((dp81057
g2
(lp81058
VYou can do concurrent programming on a machine that has only a single CPU core
p81059
aVThe operating system provides the illusion that more than one thread is running at the same time, it rapidly switches back-and-forth between them
p81060
aVA machine with multiple cores simply needs to this context switching less often since two threads can run at the same time on two cores
p81061
aVIt is only a bit special because threading bugs can make your life difficult much quicker
p81062
aVThe odds that two threads try to access a shared memory location at the same time is much higher
p81063
as(dp81064
g9
V17034
p81065
stp81066
a((dp81067
g2
(lp81068
VIt is only unsafe to return C++ objects when the DLL and the EXE were not built with the same project configuration, built with /MT instead of /MD or built with different versions of the runtime library
p81069
aVIn many cases this is not a practical problem, ymmv
p81070
aVThe safe way is to avoid requiring the EXE to release memory that was allocated from the heap by the DLL
p81071
aVOr the other way around
p81072
aVYou'll need to change your structure for starters, can't have wchar_t*
p81073
aVYou'd write your exported function to take a VideoInfo* so that the caller can pass a buffer that the function fills in
p81074
aVBut reiterating, as long as there's no danger that the DLL is going to get obsolete then you won't have trouble with std::vector nor std::wstring
p81075
as(dp81076
g9
V17034
p81077
stp81078
a((dp81079
g2
(lp81080
VUse the debugger first
p81081
aVSet a breakpoint on the DoWork event handler
p81082
aVWhen it breaks, use Debug + Windows + Threads and verify that it runs on a worker thread and that you see the Main Thread listed
p81083
aVDouble-click the main thread and look at the call stack, ensure it is idle and is not doing something like waiting for the BGW to complete
p81084
aVThat's a guaranteed deadlock
p81085
aVThe next failure mode is one that's hard to diagnose
p81086
aVYou can freeze the UI thread, even with a background worker, when you call ReportProgress too often
p81087
aVThe UI thread is flooded with invoke requests and doesn't get around to doing its normal duties anymore
p81088
aVLike painting and responding to input
p81089
aVEverything still works like it should, the worker and the UI thread are actually running, you just can't see it
p81090
aVThis happens easily, reporting progress more than about a thousand times per second is the danger zone
p81091
aVIt depends on how much work the UI thread needs to do in the ProgressChanged event handler
p81092
aVThe best way to diagnose if that's your problem is to add System
p81093
aVThreading
p81094
aVThread
p81095
aVSleep(45) after the ReportProgress() call
p81096
aVThis usually slows down the worker enough to give the UI thread a chance to catch up
p81097
aVYou solve it by reporting progress at a rate that's useful to human eyes
p81098
aVWhich at 25 updates per second doesn't see anything but a blur anymore
p81099
aVCollect bgw results in a collection object like List<> so you can update the UI with a single call, something like AddRange()
p81100
aVThis might still not be good enough if the BGW just generates results far faster than the UI can ever consume, you'll have to skip results or slow down the worker artificially
p81101
as(dp81102
g9
V17034
p81103
stp81104
a((dp81105
g2
(lp81106
VConfiguration setting I think, the size is unusual
p81107
aVTools + Options, Device Tools, Form Factors
p81108
aVPick the one you used to get your project started, Properties, untick "Show skin" and change the Screen Width and Screen Height values
p81109
aVOK
p81110
aVClose the form designer window and open it again
p81111
aVBeware that your form won't work well on other devices
p81112
as(dp81113
g9
V17034
p81114
stp81115
a((dp81116
g2
(lp81117
VThat's about it for the VB
p81118
aVNET syntax, it doesn't have anything resembling the null coalescing operator like C#'s
p81119
aVoperator
p81120
aVThe Iif() function can write more compact If statements but they rarely work for null references since both arguments are evaluated
p81121
aVIn general, try to favor null references as a debugging aid
p81122
aVThey throw a nice exception when some other code you didn't write is calling yours but messed up something like initialization
p81123
aVSilently propagating programming bugs leads to hard to diagnose failure
p81124
aVLike a NullReferenceException that's far removed from the cause
p81125
aVOr worse, bad data
p81126
aVYou could perhaps address your scenario with a NotAPlan and a NoSpouse object, objects that solely exists to avoid null reference exceptions and logically mean "no plan assigned, no spouse defined"
p81127
aVA reference that can be null is otherwise nothing more than a reference + a boolean
p81128
aVDon't skip the bool
p81129
as(dp81130
g9
V17034
p81131
stp81132
a((dp81133
g2
(lp81134
VThis is all very much by design
p81135
aVA console app can only ever display 16 distinct colors
p81136
aVThe shortcut properties allows a user to customize those colors, much like the Display applet in Control Panel allows her to change the Windows theme colors for a GUI app
p81137
aVOverriding the user's preference is almost never not a mistake
p81138
aVBut you can on Vista and Win7 by pinvoking the SetConsoleScreenBufferEx() API function
p81139
aVBoilerplate code (in C) is in this thread, visit pinvoke
p81140
aVnet for the declarations you'll need
p81141
as(dp81142
g9
V17034
p81143
stp81144
a((dp81145
g2
(lp81146
VYes, definitely, writing a mis-aligned word that straddles the CPU cache line boundary is not atomic
p81147
as(dp81148
g9
V17034
p81149
stp81150
a((dp81151
g2
(lp81152
VThe jitter goes kaboom when it tries to jit the Main() method
p81153
aVAssemblyResolve isn't registered yet, chicken and egg problem
p81154
aVYou can only use types in Main that are available, so you'll have to stay away from frmrPrincipal
p81155
aVUsing a little helper method can solve that problem, but now you'll have to suppress inlining with [MethodImpl]
p81156
aVYou are also shooting your foot by not allowing ngen
p81157
aVexe to do its job
p81158
as(dp81159
g9
V17034
p81160
stp81161
a((dp81162
g2
(lp81163
VYou'd have to look at the machine code
p81164
aVSet a breakpoint on method call and when it hits, right-click and choose Go To Assembly
p81165
aVIf you don't see the CALL statement then it got inlined
p81166
aVYou'll have to be up to speed a little on reading machine code to be really sure though, you might see a call that was in the inlined method
p81167
aVTo make this accurate, you'll have to use Tools + Options, Debugging, General, untick "Suppress JIT optimization on module load"
p81168
aVWhich ensures the jitter behaves as it does without the debugger, methods won't be inlined when the optimizer is turned off
p81169
as(dp81170
g9
V17034
p81171
stp81172
a((dp81173
g2
(lp81174
VThe term "boxing" is very opaque, but it is easy to visualize what is actually going on by using the debugger
p81175
aVWrite a little console mode application like this:
p81176
aVSet a breakpoint where indicated and press F5
p81177
aVWhen the breakpoint hits, use Debug + Windows + Memory + Memory 1
p81178
aVIn the Address box, type "obj"
p81179
aVYou'll get a hex dump of the memory content of the object
p81180
aVRight-click the window and select "4-byte Integer", the best way to visualize the object in this case
p81181
aVYou'll see something resembling this:
p81182
aVThe interesting parts here are 0x01CBF6BC, that's the address of the object on the garbage collected heap
p81183
aVThe next hex number, 6e1a2d34 is the so-called "type handle", also known as the "method table pointer"
p81184
aVThat a 'cookie' that identifies the type of the object
p81185
aVSystem
p81186
aVInt32 in this case
p81187
aVVery important, it will be used later when the object is unboxed back to an Int32 to verify that the boxed value is actually an integer
p81188
aVThe next value you see, 0000002a, is the value of the boxed object
p81189
aVYou can use Windows calculator in programmer mode to convert back to decimal, it is 42
p81190
aVExperiment with this, using different values and different types to see how it affects the boxed object
p81191
aVYou can modify the hex and see what effect it has on the obj value as displayed by the debugger
p81192
aVThe hex dump I gave you was for a 4 byte boxed value, boxing a double will take 8 bytes
p81193
aVBoxing a struct will take more bytes
p81194
aVThere's also a part of the object header you can't see, the so-called syncblock, located at the address - 4
p81195
aVTry the lock statement to see that changing
p81196
as(dp81197
g9
V17034
p81198
stp81199
a((dp81200
g2
(lp81201
VCOM takes care of the object's threading requirements as published in the registry by the ThreadingModel registry key
p81202
aVYours is obviously "Apartment", which makes COM take care of thread-safety on the object's behalf
p81203
aVThat's very common
p81204
aVAnd yes, if you created it on the UI thread then COM marshals the call from your worker thread back to the UI thread
p81205
aVTo bypass that, you'd have to create a separate STA thread to give the object another thread-safe home
p81206
aVThat requires creating a Thread, calling its SetApartmentState() method to make it STA and calling Application
p81207
aVRun() to run a message loop
p81208
aVThat in itself is hard to deal with because you lose control, you'll want a Form or a Timer or Control
p81209
aVBeginInvoke() to generate events that let you use the object's methods
p81210
aVThis is all pretty unpleasant, an hourglass cursor was popular in the olden days
p81211
as(dp81212
g9
V17034
p81213
stp81214
a((dp81215
g2
(lp81216
VScriptParserInterface must be a namespace name, you'd never make it work if it is a class name
p81217
aVThe function is __cdecl according to the mangled name, you forgot to use the CallingConvention property in your [DllImport] declaration
p81218
aVYou should have gotten a PInvokeStackImbalance MDA warning
p81219
aVSince you didn't, I have to assume you run this as 64-bit code
p81220
aVForgetting CallingConvention in itself could be enough to throw off the stack
p81221
aVStart there
p81222
as(dp81223
g9
V17034
p81224
stp81225
a((dp81226
g2
(lp81227
VEvery object has an object header
p81228
aVThat's 8 bytes on a 32-bit machine, 4 for the sync block and 4 for the type handle
p81229
aVA value type value only derives from System
p81230
aVObject when it is boxed
p81231
aVAn int is 4 bytes when it unboxed, 12 bytes when it is boxed, +8 bytes for the header
p81232
aVCheck this answer to get more insight in what a boxed value type looks like
p81233
as(dp81234
g9
V17034
p81235
stp81236
a((dp81237
g2
(lp81238
VAPI hooking in C# directly isn't possible, manipulating the stack frame requires machine code
p81239
aVThere is however a pretty popular library available that makes it possible from a C# program, EasyHook, download is here
p81240
aVSource code is available, in case you want to find out how it works
p81241
as(dp81242
g9
V17034
p81243
stp81244
a((dp81245
g2
(lp81246
VUse inheritance
p81247
aVAny properties of and controls on a base form are inherited by a derived form
p81248
as(dp81249
g9
V17034
p81250
stp81251
a((dp81252
g2
(lp81253
VThe code in your first snippet performs a 64-bit divide
p81254
aVThe x86 jitter doesn't generate machine code for that inline, there would be too much of it
p81255
aVIt relies on a helper function named JIT_ULDiv
p81256
aVThis is a common strategy for the jitter, or for a C compiler for that matter
p81257
aVYou can see the kind of helper functions the jitter can use in the SSCLI20 source code, clr/src/vm/jithelpers
p81258
aVcpp source code file
p81259
aVThe helper functions for long and ulong arithmetic are at the top of the file
p81260
aVThe second snippet does a 32-bit divide, requiring few enough machine code instructions to be generated in-line
p81261
aVConverting the divide to a shift is a simple optimization
p81262
as(dp81263
g9
V17034
p81264
stp81265
a((dp81266
g2
(lp81267
VI have exception handling
p81268
aVSounds to me that you have too much of it
p81269
aVOnly ever catch specific exception types, never catch Exception
p81270
aVNow you can simply throw any other exception type and your app will bomb with an unhandled exception
p81271
aVWhich brings up the JIT debugger dialog on your dev machine, a merciful end on your customer's machine
p81272
aVUsing System
p81273
aVDiagnostics
p81274
aVDebugger is good too, but wrap it with #ifdef DEBUG
p81275
aVYour customer doesn't have one
p81276
as(dp81277
g9
V17034
p81278
stp81279
a((dp81280
g2
(lp81281
VVery unclear
p81282
aVBut, you cannot hide a dialog
p81283
aVShowDialog() will disable all other windows in your app
p81284
aVWhen you hide the dialog, there is no window left that can get the focus
p81285
aVThe user now won't be able to get back to your app
p81286
aVWinforms protects against this by automatically closing the dialog when you hide it
p81287
aVYou can minimize it
p81288
as(dp81289
g9
V17034
p81290
stp81291
a((dp81292
g2
(lp81293
VYou missed Application
p81294
aVRun()
p81295
aVTick events cannot be dispatched without the dispatcher loop
p81296
aVA secondary issue is that your program immediately terminates before the event ever could be raised
p81297
aVApplication
p81298
aVRun() solves that too, it blocks the Main() method
p81299
as(dp81300
g9
V17034
p81301
stp81302
a((dp81303
g2
(lp81304
VThe only way to do this that doesn't terminate the entire process and prevents catch and finally blocks from executing is by pinvoking TerminateThread()
p81305
aVThat's a problematic function, usable only in testing scenarios
p81306
aVIt leaks the memory allocated for the stack
p81307
aVYou also have a hard time getting the thread handle you'll need
p81308
aVThat requires pinvoking GetCurrentThread(), that must be done from inside the thread itself
p81309
aVThe state of your test program is random after this, much like it would be when you use Thread
p81310
aVAbort()
p81311
aVWell, worse
p81312
as(dp81313
g9
V17034
p81314
stp81315
a((dp81316
g2
(lp81317
VWrite Click event handlers for the label and PB, have them call PerformClick()
p81318
aVMaking controls transparent to the mouse is possible but is ugly to do
p81319
aVYou'd have to override WndProc() to catch WM_NCHITTEST and return HTTRANSPARENT
p81320
aVThe all-around better solution is to not use controls
p81321
aVA Label is just TextRenderer
p81322
aVDrawText() in the button's Paint event
p81323
aVProgressBar isn't hard either, e
p81324
aVGraphics
p81325
aVFillRectangle()
p81326
as(dp81327
g9
V17034
p81328
stp81329
a((dp81330
g2
(lp81331
VYou don't register
p81332
aVNET assemblies with Regsvr32
p81333
aVexe
p81334
aVYou have to use Regasm
p81335
aVexe, you'll find the tool in the framework directory
p81336
aVUse the /codebase option if you don't put the assembly in the GAC
p81337
aVYou shouldn't on a dev machine
p81338
aVThis worked okay before probably because you let Visual Studio do it for you
p81339
as(dp81340
g9
V17034
p81341
stp81342
a((dp81343
g2
(lp81344
VUse a RichTextBox
p81345
aVIt puts rich text on the clipboard that includes formatting
p81346
aVUse its Copy() method
p81347
aVPasting back now also works automatically without any code
p81348
as(dp81349
g9
V17034
p81350
stp81351
a((dp81352
g2
(lp81353
VWhen you have to use the useLegacyV2RuntimeActivationPolicy attribute then you are working with a mixed-mode assembly that was written in C++/CLI and targeting version 2
p81354
ag2512
aV50727 of the CLR
p81355
aVSuch an assembly contains both managed code and native machine code
p81356
aVThat machine code is 32-bit in your case, you can't run it in a 64-bit process
p81357
aVWhich is what the exception means
p81358
aVSetting the Platform target to x86 in your EXE project is required
p81359
as(dp81360
g9
V17034
p81361
stp81362
a((dp81363
g2
(lp81364
VAbsolutely
p81365
aVBoth functions create a new interface pointer, they will have a reference count of 1, the AddRef() function was already called
p81366
aVWhen you're done with it then you have to call Release()
p81367
aVYou'll leak memory if you don't
p81368
aVEvery interface in COM works this way
p81369
as(dp81370
g9
V17034
p81371
stp81372
a((dp81373
g2
(lp81374
VModality like that in a user interface is a pretty bad idea
p81375
aVBut Winforms does make it possible
p81376
aVYou can use the Cursor
p81377
aVClip property to restrict motion
p81378
aVIt can't prevent the user from still accessing, say, the Start menu with a keyboard shortcut, you need to use Capture property to detect that you lost
p81379
as(dp81380
g9
V17034
p81381
stp81382
a((dp81383
g2
(lp81384
VYour example is not a good one, the JIT compiler already generates the code like that
p81385
aVUnder the hood references are pointers too
p81386
aVThis needed to be fast, managed code would never have been competitive
p81387
aVThe garbage collected heap is pretty incompatible with pointers, you have to pin objects to make it possible to create a pointer to them
p81388
aVWithout the pinning, the garbage collector could move the object and your code randomly fails, destroying the heap integrity
p81389
aVPinning has a non-zero cost, both in the operation and the loss of efficiency you'll suffer, well after you unpinned, when a garbage collection happens while an object is pinned
p81390
aVPointers are highly effective when accessing unmanaged memory
p81391
aVThe canonical example is image processing that requires accessing the pixels of a bitmap
p81392
aVAnd it is a way to quickly access pinned arrays with all the safety interlocks removed, array index checking isn't free when you don't iterate them
p81393
as(dp81394
g9
V17034
p81395
stp81396
a((dp81397
g2
(lp81398
VDebug it, set a breakpoint on the event handler
p81399
aVThis is otherwise likely, although I couldn't repro with the web site in your question
p81400
aVDocumentCompleted fires for each frame in the web page, there might be more than one
p81401
aVShort from using a bool field to track that you already subscribed the event, you could also filter out frames like this:
p81402
as(dp81403
g9
V17034
p81404
stp81405
a((dp81406
g2
(lp81407
VYou are using BeginGetResponse()
p81408
aVNothing much can go wrong there, not until the response is actually received
p81409
aVOr an error detected after trying
p81410
aVNot until you call EndGetResponse() do you find out what happened
p81411
aVBut you didn't put it in a try block, so the exception it throws to signal the error is unhandled
p81412
aVFix:
p81413
as(dp81414
g9
V17034
p81415
stp81416
a((dp81417
g2
(lp81418
VThere's no point in using threads here
p81419
aVA thread can only give you one resource: more cpu cycles, provided that you have a CPU with multiple cores
p81420
aVThat is not the resource that you need to speed up your program
p81421
aVYou need a faster Internet connection
p81422
aVIf you have an UI you don't want frozen then the BackgroundWorker tricks will work just fine
p81423
as(dp81424
g9
V17034
p81425
stp81426
a((dp81427
g2
(lp81428
VYes, it is not possible to get that glyph
p81429
aVIt is a simple one but you have to write the code
p81430
aVDrawRectangle and DrawLine
p81431
aVOr use a bitmap
p81432
aVOr make it look like the simple Vista triangles
p81433
aVOr don't enable ownerdraw when visual styles are off
p81434
as(dp81435
g9
V17034
p81436
stp81437
a((dp81438
g2
(lp81439
VExceptionCode: 0xc0000005
p81440
aVThat's a nasty one, AccessViolationException in
p81441
aVNET speak
p81442
aVClearly SQL Compact is crashing, it is probably doing so in a worker thread or your catch clause would have caught it
p81443
aVDiagnosing this is going to be difficult but start by mistrusting the database file content, it might be corrupted
p81444
aVConsider an out-of-memory problem, it is bombing on a null pointer dereference
p81445
aVLook for updates from Microsoft
p81446
as(dp81447
g9
V17034
p81448
stp81449
a((dp81450
g2
(lp81451
VDoubtful
p81452
aVIf they don't use Visual Studio then it is quite unlikely they'd need the Silverlight,
p81453
aVNET 4
p81454
aV0 and Win7 additions in the current version of the library
p81455
aVWhich make this download still relevant
p81456
aVObviously this is not a long-term solution, an MSDN subscription is a pretty essential resource for any professional programmer that works in the MSFT stack
p81457
aVAvoiding spending the money is a death by thousands of needle pricks of wasted seconds
p81458
as(dp81459
g9
V17034
p81460
stp81461
a((dp81462
g2
(lp81463
VUse the Graphics
p81464
aVTranslateTransform and ScaleTransform as well as the Transform property to achieve your goal
p81465
aVThere is an excellent backgrounder available here
p81466
as(dp81467
g9
V17034
p81468
stp81469
a((dp81470
g2
(lp81471
VDon't embed resources that large in an executable
p81472
aVIt won't only bomb the compiler, it bombs your program too
p81473
aVAnything larger than ~500 megabytes is trouble on a 32-bit operating system, there won't be hole in the address space large enough to fit it
p81474
aVYou can get insight in the way it is divvied up between code and data with SysInternals' VMMap utility
p81475
aVSince you're using CodeDom, you can use the /linkresource compiler option to keep the file out of the executable
p81476
aVYou might still have a problem at runtime but that's another problem
p81477
as(dp81478
g9
V17034
p81479
stp81480
a((dp81481
g2
(lp81482
VYou have to rewrite the file
p81483
aVUse StreamWriter to create a temporary file
p81484
aVRead one line at a time and write it to the output file
p81485
aVSkip the write if you don't want the line
p81486
aVClean up by renaming the original, renaming the temporary then deleting the renamed original
p81487
aVUse something better than a text file, like a dbase, if this is too slow
p81488
as(dp81489
g9
V17034
p81490
stp81491
a((dp81492
g2
(lp81493
VYou eliminated the obvious reason to get this error
p81494
aVWhat's left is adding an assembly that was built to run on another target platform
p81495
aVLike Silverlight or Windows Phone
p81496
aVYou can't mix these platforms, they run with a different version of the CLR and mscorlib
p81497
aVNo shortcut for that, you'll have to rebuild the assembly
p81498
as(dp81499
g9
V17034
p81500
stp81501
a((dp81502
g2
(lp81503
VYou found out why the jitter generates no code when you set a local variable to null
p81504
aVThe garbage collector already knows when you stop referencing an object, it doesn't need help like that
p81505
aVThere are many books about
p81506
aVNET that can explain this to you, Richter's "CLR via C#" is widely praised
p81507
as(dp81508
g9
V17034
p81509
stp81510
a((dp81511
g2
(lp81512
VIt is not possible
p81513
aVA delegate's BeginInvoke() method always uses a threadpool thread
p81514
aVAnd TP threads always are MTA, that cannot be changed
p81515
aVTo get an STA thread, you must create a Thread and call its SetApartmentState() method before starting it
p81516
aVThis thread must also pump a message loop, Application
p81517
aVRun()
p81518
aVThe COM object only uses it when its instance was created in that thread
p81519
aVNot sure what you are trying to do, but trying to multi-thread a chunk of code that is not thread-safe just can't work
p81520
aVCOM enforces that
p81521
as(dp81522
g9
V17034
p81523
stp81524
a((dp81525
g2
(lp81526
VThere's no simple explanation for what you observe
p81527
aVA cheap way to test this without having to go through the painful login cycle is to change the form's Font property in the OnLoad method:
p81528
as(dp81529
g9
V17034
p81530
stp81531
a((dp81532
g2
(lp81533
VDon't, threadpool threads were optimized for your current usage
p81534
aVThe worst kind to TP thread is one that blocks a lot or never completes, it prevents other TP threads from getting started in a timely matter
p81535
aVYou should use a regular Thread in this case
p81536
aVAt which point you have to wonder if burning up such an expensive resource just to write a file, plus the required synchronization, is really worth it
p81537
aVThat gets unlikely quickly
p81538
aVBeware that some synchronization is probably still needed, you don't want to have two TP threads writing to the file if the first one is taking a bit longer than normal
p81539
aVAnd consider that you might not need a thread at all
p81540
aVWriting a couple of megabytes to a file is very fast, the file system cache takes care of it
p81541
aVAnd there's FileStream
p81542
aVBeginWrite()
p81543
as(dp81544
g9
V17034
p81545
stp81546
a((dp81547
g2
(lp81548
VWell, looks like the ProgId isn't "MyComNameSpace
p81549
aVMyComClass"
p81550
aVLook in the registry with Regedit
p81551
aVexe, it should be present in HKEY_CLASSES_ROOT
p81552
aVThe key contains a CLSID key with a guid for your class
p81553
aVThat key should be present in
p81554
aVWhich contains keys written by Regasm
p81555
aVexe to get the CLR started and your assembly loaded
p81556
aVYou can see these keys being searched by the COM client program with SysInternals' ProcMon utility, a decent way to diagnose what's missing
p81557
aVYou can use the [ProgId] attribute to pick your own instead of letting the it up to
p81558
aVNET to pick one
p81559
aVJust in case, just because you use late-binding does not mean that you can skip the registration step
p81560
aVBe sure to run Regasm
p81561
aVexe with the /codebase option from an elevated command prompt to get the keys registered
p81562
as(dp81563
g9
V17034
p81564
stp81565
a((dp81566
g2
(lp81567
VNo changes, it is just a library
p81568
aVThe
p81569
aVNET 4
p81570
aV0 CLR wasn't needed, the DLR powered IronPython and IronRuby on the 2
p81571
aV0 version
p81572
aVYou can have a look-see at what makes it tick from that version, you can download the source code from here
p81573
aVThis code was moved into System
p81574
aVCore
p81575
aVdll largely unchanged
p81576
aVBeware that there's rather a lot of it
p81577
aVIt is all straight C#
p81578
aVIt uses existing support in the CLR for dynamic binding through Reflection and COM interop
p81579
aVIts claim to fame is that it can do so by paying for that cost only once
p81580
aVIt caches the results of a bind so that it is available at low cost in subsequent binds
p81581
aVAdding the DLR interface glue to C# version 4 was a considerable effort in itself, embedded in Microsoft
p81582
aVCSharp
p81583
aVdll with lots of work in the compiler
p81584
aVThat source code isn't available but you can sniff it with Reflector
p81585
as(dp81586
g9
V17034
p81587
stp81588
a((dp81589
g2
(lp81590
VHow is the anti-virus program supposed to guess that you are not using GetAsyncKeyState() to spy on the keyboard and log keys
p81591
aVYou tell it of course, make an exclusion
p81592
aVIf you're worried that your future customers are not so easily convinced then go back to using WM_KEYDOWN/UP
p81593
aVUse an array of 256 bools to keep track of the key state
p81594
aVSet it to true on DOWN, regardless of how many you get, false on UP
p81595
aVAlso check if the scanner is happy when you stop calling the API function when your app loses focus
p81596
aVPay attention to WM_ACTIVATEAPP
p81597
as(dp81598
g9
V17034
p81599
stp81600
a((dp81601
g2
(lp81602
VSystemException is the equivalent, it is the base class of all exceptions that can be raised by
p81603
aVNET code
p81604
aVAs opposed to application exceptions
p81605
aVFrom the comments it however sounds like you want to catch this exception
p81606
aVIn which case you should never use SystemException, you'll catch too many
p81607
aVMake your own exception class, derived from Exception
p81608
aVThere are no exception specifications in
p81609
aVNET, in case that's what you're after
p81610
as(dp81611
g9
V17034
p81612
stp81613
a((dp81614
g2
(lp81615
VYou are asking us to predict what a very large company like Microsoft is going to do in the, what, next 10 years
p81616
aVImpossible to answer accurately of course
p81617
aVNevertheless, the scripting runtime is available in the latest version of Windows, got ported to 64-bits, has no obscure or desperately ancient or deprecated dependencies
p81618
aVIt is used in many programs
p81619
aVMicrosoft has a very strong commitment to app-compat
p81620
aVOdds are very good that you are not going to have to worry about it for a long time
p81621
as(dp81622
g9
V17034
p81623
stp81624
a((dp81625
g2
(lp81626
VTools + Options, Projects and Solutions, General
p81627
aV"Track Active Item in Solution Explorer" option
p81628
aVFeature, not a bug
p81629
as(dp81630
g9
V17034
p81631
stp81632
a((dp81633
g2
(lp81634
VThat's automatic in COM, it takes care of apartment requirements and will marshal the call if the interface pointer has STA affinity
p81635
aVYou have to marshal the interface pointer before using it in the thread, ATL has the AtlMarshalPtrInProc() and AtlUnmarshalPtr() helper methods to make that easier
p81636
aVCoMarshalInterThreadInterfaceInStream() or IGlobalInterfaceTable if you want to do it yourself
p81637
as(dp81638
g9
V17034
p81639
stp81640
a((dp81641
g2
(lp81642
VThey didn't want to risk breaking a
p81643
aVNET language that considers both overloads ambiguous
p81644
aVThey very nearly are, WriteLine("foo") could match WriteLine(string) and WriteLine(string, params object[])
p81645
aVC# has a rule for it but that's specific to that language
p81646
as(dp81647
g9
V17034
p81648
stp81649
a((dp81650
g2
(lp81651
VSomething changed but it is a well kept secret, I can find nothing about it
p81652
aVI wouldn't put too much stock into it
p81653
aVThe code sample was hand-tuned to the make the CLR 2 large object heap look as bad as possible
p81654
aVEven a small change in the algorithm, perhaps inspired by the blog post, will have very large effects
p81655
as(dp81656
g9
V17034
p81657
stp81658
a((dp81659
g2
(lp81660
VPress the Enter key twice
p81661
aVI tried to post this answer 3 times before I left the comment
p81662
aVIt wouldn't let me, too short
p81663
aVThat's why I'm typing this otherwise useless verbiage
p81664
as(dp81665
g9
V17034
p81666
stp81667
a((dp81668
g2
(lp81669
VYour assumption that RETURNBUFFER contains structure pointers has to be wrong
p81670
aVThat's the only way that infoA and infoB can take up 16 bytes
p81671
aVThe INFO structure certainly is 16 bytes long, I can't see the type of infoB
p81672
aVThus:
p81673
aVUpdate your question with the C declarations if you still have trouble
p81674
aVIt should be easy to see from them
p81675
as(dp81676
g9
V17034
p81677
stp81678
a((dp81679
g2
(lp81680
VA queue has to stores bytes, a stream doesn't
p81681
aVBig difference
p81682
as(dp81683
g9
V17034
p81684
stp81685
a((dp81686
g2
(lp81687
VReads and writes are atomic when the int is aligned properly
p81688
aVIt cannot straddle the end of a cache line
p81689
aVA cache line is 64 bytes
p81690
aVMost any compiler ensures the alignment is taken care of but it can be overridden with, say, a structure packing pragma
p81691
aVYes, you need a lock to protect the value when threads perform a read-modify-write operation
p81692
aVYou can get a cheap one from InterlockedXxxx, perhaps
p81693
as(dp81694
g9
V17034
p81695
stp81696
a((dp81697
g2
(lp81698
VThe %X format specifier expects a 32-bit argument
p81699
aVYou are passing 64-bits, throwing off the stack
p81700
aVYou can use %llX
p81701
aVThe CRT is the same for C and C++ code
p81702
as(dp81703
g9
V17034
p81704
stp81705
a((dp81706
g2
(lp81707
VOnly the comment in the first constructor is accurate
p81708
aVYou can't design the form without a default constructor
p81709
aVMake it look better like this:
p81710
aVNote the added this() to call the default constructor
p81711
aVYou now only have to add the special constructor code
p81712
as(dp81713
g9
V17034
p81714
stp81715
a((dp81716
g2
(lp81717
VThis is the way a 64-bit process dies on a out-of-memory condition
p81718
aVBe careful at what you look at to diagnose this
p81719
aVIt is never RAM that you run out of, it is virtual memory space
p81720
aVYou have to look at a number like VM-size or Private Bytes, Task Manager focuses too much on RAM
p81721
aVA 64-bit process has an enormous virtual memory space, 16 gigabytes and up, depending on what version of Windows you run on
p81722
aVIt is impossible to completely use it up, the machine dies a swapping death before you can get close
p81723
aVWhich of course the operating system cannot allow to happen, thus ERROR_COMMITMENT_LIMIT
p81724
aVIn practice, a 64-bit process is limited by the amount of space it can reserve in the paging file
p81725
aVUse a tool like SysInternals' Process Explorer to have another look
p81726
aVA memory profiler when you do see virtual memory size growing without bound
p81727
as(dp81728
g9
V17034
p81729
stp81730
a((dp81731
g2
(lp81732
VFor the record, this is in fact possible, MessageBox() expands tabs
p81733
aVFor example:
p81734
aVIt isn't very trustworthy if the word width starts to approach the tab width
p81735
aVYou still should prefer a little helper form with a ListView
p81736
as(dp81737
g9
V17034
p81738
stp81739
a((dp81740
g2
(lp81741
VYour code snippet doesn't match your question very well, there's no sign of you displaying the FolderBrowserDialog
p81742
aVThere is an obvious mistake in the File
p81743
aVCopy() call, you pass sourceFileOpenFileDialog
p81744
aVFileName instead of file
p81745
aVCheck this answer for a way to display path names in a limited amount of space:
p81746
as(dp81747
g9
V17034
p81748
stp81749
a((dp81750
g2
(lp81751
VGiving all labels the same Text doesn't make any sense, let's assume you meant "Font"
p81752
aVYes, this is possible, all three properties are "ambient" properties
p81753
aVWhich means that when you don't explicitly give them a value, either in the designer or in your code, then they'll 'inherit' the property value of their container
p81754
aVAmbient properties were designed to easily give your UI consistent look and feel
p81755
aVJust assign the parent control's property and the label property automatically get the same value
p81756
aVYou can put them in, say, a Panel to isolate them from the other controls in the form if necessary
p81757
aVAnother way in the designer is to select them all by dragging a larger rectangle around them and setting the property
p81758
aVCtrl+Click to add/remove controls from that selection
p81759
aVFavor the ambient property approach though
p81760
as(dp81761
g9
V17034
p81762
stp81763
a((dp81764
g2
(lp81765
VThere's nothing special about a class library
p81766
aVThere certainly isn't any need to not include drawing or UI helper methods
p81767
aVThe only possible speed bump is that the project template doesn't automatically include the assembly references that you'll need
p81768
aVProject + Add Reference, pick at least System
p81769
aVDrawing and System
p81770
aVWindows
p81771
aVForms
p81772
as(dp81773
g9
V17034
p81774
stp81775
a((dp81776
g2
(lp81777
VNo, that's not a bad thing
p81778
aVApartments explicitly exist to help you getting multi-threaded code working
p81779
aVAn STA thread is a safe home for a COM server that's not thread-safe, COM's apartment threading model ensures that it is always used in a thread-safe way
p81780
aVAll you have to do is the marshal the interface pointer you want to use in the worker thread (IGlobalInterfaceTable for example) and you can call the methods without doing anything special
p81781
aVThis doesn't come for free of course, there's overhead involved in marshaling the call
p81782
aVHow much depends on how responsive the STA thread is when it pumps its message loop
p81783
aVIf you intended to create the worker thread explicitly to use that COM server in a multi-threaded way then of course you'll not be ahead, you made it slower
p81784
as(dp81785
g9
V17034
p81786
stp81787
a((dp81788
g2
(lp81789
VYou cannot create a static link library from managed code, there's no support for it in the VS build system
p81790
aVThe unit of storage for managed code is an assembly
p81791
aVThey are not linked at build time, it happens at runtime
p81792
aVBeware that your test program needs to be managed in order to test your wrapper
p81793
as(dp81794
g9
V17034
p81795
stp81796
a((dp81797
g2
(lp81798
VGuids are structures in
p81799
aVNET, they are too large to fit in a simple value type by a factor of two
p81800
aVSounds to me that you need a structure member initialized
p81801
aVThat's going to need an assignment statement in your code
p81802
aVThe const will work just fine for this
p81803
aVThere is otherwise no way to get the compiler to do it automatically
p81804
as(dp81805
g9
V17034
p81806
stp81807
a((dp81808
g2
(lp81809
VThe pascal calling convention is your problem
p81810
aVIt is ancient, the pinvoke marshaller doesn't support it
p81811
aVIt passes arguments left-to-right, the pinvoke marshaller is assuming stdcall so passes them right-to-left
p81812
aVUse __stdcall instead:
p81813
aVNext problem is the string, returning one requires you to use a StringBuilder in the declaration and pass an initialized one in the call:
p81814
aVI took the liberty of adding the messageSize argument, required to safely copy the string into the message buffer without risking destroying the garbage collected heap
p81815
as(dp81816
g9
V17034
p81817
stp81818
a((dp81819
g2
(lp81820
VThat cannot work, you cannot cast a char* to a wide string, a conversion is required
p81821
aVBut not necessary here since this is a string literal
p81822
aVMake it a unicode literal by prefixing an L
p81823
aVSame problem with the MMF
p81824
aVAlso consider that it doesn't make much sense to use an out-of-process communication mechanism to talk to a DLL
p81825
aVJust load it in-process
p81826
aVUse pinvoke or a C++/CLI wrapper
p81827
as(dp81828
g9
V17034
p81829
stp81830
a((dp81831
g2
(lp81832
VThe form has to be the parent
p81833
aVWhich is not so easy to get done in the designer, the tab page will suck it in every opportunity it gets
p81834
aVOne thing you can do is put it to the left of the tab control and move it in place by changing its Location property in the form's constructor, after the InitializeComponent() call
p81835
as(dp81836
g9
V17034
p81837
stp81838
a((dp81839
g2
(lp81840
VThe debugger is probably having trouble finding the
p81841
aVpdb files for the DLLs that you use
p81842
aVFirst thing to do is to check your symbol server settings
p81843
aVTools + Options, Debugging, Symbols
p81844
aVUncheck the Symbol file locations and try again
p81845
as(dp81846
g9
V17034
p81847
stp81848
a((dp81849
g2
(lp81850
VUsing a thread is the cause of the problem
p81851
aVThe login window is entirely separated from the main window, it doesn't get disabled by ShowDialog()
p81852
aVAnd the main thread keeps motoring so all the user has to do is move the login window off to the side to use the main window
p81853
aVJust don't use a thread, call ShowDialog() directly
p81854
as(dp81855
g9
V17034
p81856
stp81857
a((dp81858
g2
(lp81859
VPosition is indeed your problem
p81860
aVHowever, the constructor already initializes the memory stream, you don't have to call Write()
p81861
aVJust delete it and the Position will be okay as well
p81862
as(dp81863
g9
V17034
p81864
stp81865
a((dp81866
g2
(lp81867
VInstalling an assembly requires the path name of the DLL
p81868
aVUninstalling requires the display name of the assembly
p81869
aVThey don't have to resemble each other
p81870
aVReview the Assembly
p81871
aVFullName property
p81872
aVGacutil
p81873
aVexe /l (ell as in list) gets you a list of display names
p81874
as(dp81875
g9
V17034
p81876
stp81877
a((dp81878
g2
(lp81879
VThis import library is included with the Windows SDK
p81880
aVI have to guess that you've got an old version of it on your machine
p81881
aVThe default install location is c:\u005cprogram files\u005cmicrosoft\u005csdks\u005cwindows\u005c
p81882
aV\u005clib where
p81883
aVis the SDK version number (like v7
p81884
aV0)
p81885
aVYou can download the SDK from Microsoft
p81886
aVDo make sure that the version you get is compatible with your version of Visual Studio
p81887
aVDo not attempt if you have an old one, like version 6
p81888
as(dp81889
g9
V17034
p81890
stp81891
a((dp81892
g2
(lp81893
VCreating a task doesn't have anything to do with the sequencing of the tasks as directed by a
p81894
aVtargets file
p81895
aVYou can execute tasks from a C# program as well, use their Execute() method
p81896
aVYou'll probably find this to be largely an exercise in property assigning, tasks normally have a lot of them
p81897
aVAfter a while, you'll wonder why you wouldn't just use a data file
p81898
aVIn xml format
p81899
as(dp81900
g9
V17034
p81901
stp81902
a((dp81903
g2
(lp81904
VYou posted the code that works instead of the code you have a problem with
p81905
aVI'll assume BeginInvoke instead of Invoke
p81906
aVThe partList
p81907
aVClear() method is going to empty the list, before the delegate target can use the list
p81908
aVYou should create a new instance of the list after the BeginInvoke call
p81909
aVThe UI thread can now work with the old list without trouble
p81910
aVRoughly
p81911
as(dp81912
g9
V17034
p81913
stp81914
a((dp81915
g2
(lp81916
VSuch are the hazards of running code on a multi-tasking operating system, there's no guarantee that a file you open or use isn't also in use by another process
p81917
aVThink search indexers, virus scanners, toolbars
p81918
aVOr just plain another process that the user started to look at the file
p81919
aVIncluding another instance of your program
p81920
aVAssuming such programs are uninterested in
p81921
aVbak files, one scenario where deleting the
p81922
aVbak file won't work is on the second time the user saves the file
p81923
aVWhere some other process had a handle open on the original file
p81924
aVRenaming the file to
p81925
aVbak won't be a problem
p81926
aVDeleting it will
p81927
aVAssume failure, catch IOException and tell the user it won't work right now
p81928
aVThe user's IT staff know how to use, say, SysInternals' Handle utility to find out who's got the file locked
p81929
as(dp81930
g9
V17034
p81931
stp81932
a((dp81933
g2
(lp81934
VThe pinvoke declaration is completely wrong, it was copied from VB6 code
p81935
aVThe return type and arguments are not long (the VB6 int32 type), they are int
p81936
aVPinvoke
p81937
aVnet is a decent site to get good declarations
p81938
aVDon't forget to throw Win32Exception when you get a false return so failure isn't silent
p81939
as(dp81940
g9
V17034
p81941
stp81942
a((dp81943
g2
(lp81944
VThat code snippet isn't going to get you very far
p81945
aVCreating a control array is no problem, just initialize it in the form constructor
p81946
aVYou can then expose it as a property, although that's generally a bad idea since you don't want to expose implementation details
p81947
aVSomething like this:
p81948
aVWhich then lets you write:
p81949
aVBut don't, let the form manage its own text boxes
p81950
as(dp81951
g9
V17034
p81952
stp81953
a((dp81954
g2
(lp81955
VAssigning the  property is what makes a dialog close
p81956
aVIt keeps running while it is set to
p81957
aVYou don't need the  call
p81958
aVThe code that calls  gets the  value you assigned as the return value
p81959
aVSo it knows whether the dialog was closed with OK or just canceled
p81960
aVAlso note that the way you wrote the validation event handler, you don't need
p81961
aVYou set  to prevent the user from moving away from the text box
p81962
aVWhich means that she can only get to the OK button when the text box was validated to be okay
p81963
aVYou do however have to make sure that a control that has validation is selected first when the dialog is shown
p81964
aVA friendly dialog is one where the user is free to tab between controls and pick off the 'easy ones'
p81965
aVYou now need two validations, one that checks if the entered value is valid, another one that checks if there are no missing values
p81966
aVYou get this by accepting an empty string in the Validation event handler
p81967
aVBut the latter is not well supported by Winforms, you need code
p81968
as(dp81969
g9
V17034
p81970
stp81971
a((dp81972
g2
(lp81973
VYou'd normally apply __declspec(dllexport) to the class declaration so the whole shebang gets exported
p81974
aVDoing it one member at the time is tiresome and troublesome
p81975
aVNo idea why you'd skip the overload
p81976
aVIf you made it public in the class then why not expose it from the DLL as well
p81977
aVIf you don't then somebody is going to have a very hard to diagnose linker error some day
p81978
as(dp81979
g9
V17034
p81980
stp81981
a((dp81982
g2
(lp81983
VThere's a lot of sugar here that prevents you from seeing what is really happening
p81984
aVWritten out, it resembles this:
p81985
aVWhere add() is the add accessor for the event, the compiler auto-generates one when you don't declare your own explicitly
p81986
aVThe first argument to the delegate constructor is the object instance that you are asking about, the delegate object's Target property
p81987
aVNote that this has side-effects, the event subscription keeps a reference to your  object
p81988
aVWhich prevents it from getting garbage collected, that would be rather bad when the event is invoked
p81989
aVThat can also be a problem, you can unintentionally leak the object reference
p81990
aVThere's no good way in your code to un-subscribe the event handler so the A object is going to live as long as the B object on which you called h()
p81991
as(dp81992
g9
V17034
p81993
stp81994
a((dp81995
g2
(lp81996
VTry not to hammer a square string peg into a round date hole, that just has way too many ways to break your mallet
p81997
aVThe Now function already returns a date:
p81998
aVOption Strict On at the top of the source code file helps you find these kinds of mistakes
p81999
aVIf you get the string from the server (pray you don't) then use ParseExact() to convert the date:
p82000
as(dp82001
g9
V17034
p82002
stp82003
a((dp82004
g2
(lp82005
VOnly projects that don't depend on each other can be built in parallel
p82006
aVClearly that's not your case, can't build the tool until the
p82007
aVlib is available
p82008
aVEDIT: you are not using VS2010
p82009
aVFor VS2008 you should use vcbuild
p82010
aVexe
p82011
aVEnable concurrent builds with /M4
p82012
as(dp82013
g9
V17034
p82014
stp82015
a((dp82016
g2
(lp82017
VThe Save() method only saves settings whose Scope is user, not Application
p82018
aVThose setting values get written to a user
p82019
aVconfig file that's stored in a subdirectory of c:\u005cusers\u005cname\u005cappdata
p82020
aVIt is hard to find, the subdirectory name is a hash based on the application name and version
p82021
aVWhich is the way it has to work, a program doesn't normally have write access to the app
p82022
aVexe
p82023
aVconfig file after it got deployed
p82024
aVUAC prevents a program from writing to files in c:\u005cprogram files
p82025
aVIn other words, your app
p82026
aVexe
p82027
aVconfig is not supposed to change
p82028
aVLook at it with notepad to verify that
p82029
as(dp82030
g9
V17034
p82031
stp82032
a((dp82033
g2
(lp82034
VInteresting failure mode, this is not supposed to happen
p82035
aVYou get the FEEE typically because the garbage collected heap is getting destroyed
p82036
aVThis is normally easily explained by a misbehaving pinvoked native function that does something like overflow a buffer
p82037
aVNo pinvoke here though
p82038
aVThere's however an excellent candidate for this mishap:
p82039
aVThe marshaling for this is designed to marshal a C string, a zero-terminated array of characters
p82040
aVA SizeConst = 1 cannot work properly by design, that only leaves room for the zero terminator, not any character
p82041
aVOn top of which, a
p82042
aVdbf file doesn't contain zero terminated strings, they are fixed-width according to the field declaration
p82043
aVWhether the access violation is actually caused by the marshaller getting this wrong is an open question though, it can just as easily bomb on trying to find the zero terminator
p82044
aVNot find one and blunder into an unmapped memory page
p82045
aVAnyhoo, you're doing it wrong
p82046
aVYou must use a char[] instead of a string in the structure declaration and use ByValArray in the [MarshalAs] attribute
p82047
aVPretty painful coding btw
p82048
as(dp82049
g9
V17034
p82050
stp82051
a((dp82052
g2
(lp82053
VThe problem is that you attached to the console of the command line processor, cmd
p82054
aVexe
p82055
aVNow there are two programs that are interested in input
p82056
aVCmd
p82057
aVexe wins, it doesn't know what the /Exit command is supposed to mean
p82058
aVAnd displays the error message you saw
p82059
aVNo problem when you press Enter first, cmd
p82060
aVexe doesn't mind that
p82061
aVAnd your program gets a turn
p82062
aVCreate your own console, always call AllocConsole()
p82063
as(dp82064
g9
V17034
p82065
stp82066
a((dp82067
g2
(lp82068
VCannot access a disposed object
p82069
aVObject name: 'Form1
p82070
aVYou get this because you don't do anything to stop the thread when the user closes the form
p82071
aVYou'll have to keep the form alive until you know that the thread is dead
p82072
aVPretty hard to do reliable, check this answer for a solution
p82073
aVAs an aside, calling InvokeRequired is an anti-pattern
p82074
aVYou know that you are making the call from a worker thread
p82075
aVIf InvokeRequired would return false then there's something really wrong
p82076
aVDon't bother, call Invoke() directly
p82077
aVObject is currently in use elsewhere
p82078
aVIt is an exception raised by GDI+ (Graphics) when it sees that two threads are trying to access a bitmap at the same time
p82079
aVIt isn't obvious in your snippet but I can't see what GraphingUtility
p82080
aVcreate() does
p82081
aVMake sure it creates a new bitmap, not return an existing one
p82082
aVBecause that will bomb when your thread writes to it again and the picture box repaints itself at the same time
p82083
aVThe bmp constructor you use above it doesn't do anything
p82084
aVYour PictureBox
p82085
aVImage assignment is forgetting to dispose the old one
p82086
as(dp82087
g9
V17034
p82088
stp82089
a((dp82090
g2
(lp82091
VYou are reading a character, not a number
p82092
aVReview the docs for ConsoleKeyInfo
p82093
aVKeyChar
p82094
aVAllow the user to enter real numbers:
p82095
aVFocus on error handling and the switch statement in version 2 of your program
p82096
as(dp82097
g9
V17034
p82098
stp82099
a((dp82100
g2
(lp82101
VThat's a prototype declaration
p82102
aVMaybe you actually meant a function pointer
p82103
as(dp82104
g9
V17034
p82105
stp82106
a((dp82107
g2
(lp82108
VA Form does not want to receive the focus
p82109
aVIt was designed to be a container control, it makes sure that one of its child controls always gets the focus
p82110
aVIt is technically possible to whack it over the head and make it lose that behavior:
p82111
aVThis is however a bad idea
p82112
aVA Form doesn't have any way to indicate that it has the focus, you'll also have to override OnPaint() to do something like draw a focus rectangle
p82113
aVIf you don't then the user completely loses track of where the focus is located
p82114
aVThen there's the considerable inconvenience that nothing interesting can happen when the user uses the keyboard, a form doesn't have a use for it
p82115
aVDon't do this
p82116
aVIf you want to make a control disappear then add a menu item, toolbar button or a normal button to your UI
p82117
aVSomething the user can click on
p82118
as(dp82119
g9
V17034
p82120
stp82121
a((dp82122
g2
(lp82123
VForgot to mention have used the appropriate 64 bit version of sn
p82124
aVexe to skip validations
p82125
aVThat's why it doesn't work
p82126
aVVisual Studio, and thus the designer, is a 32-bit process
p82127
aVIt is only going to see the registry keys that a 32-bit process can see on a 64-bit operating system, subkeys of HKLM\u005cSoftware\u005cWow6432Node
p82128
aVWhich now is a problem when you debug, your program runs as a 64-bit process so doesn't see the delay-sign droppings of the 32-bit version of sn
p82129
aVexe
p82130
aVThe simple solution is to change the Debug configuration setting for Project + Properties, Build tab, Platform target = x86
p82131
aVEdit + Continue will work now too, nice
p82132
aVThis is still inconsistent with your observation that it doesn't work on a 32-bit operating system either
p82133
aVMaybe it actually does
p82134
as(dp82135
g9
V17034
p82136
stp82137
a((dp82138
g2
(lp82139
VNo, this code has a bug
p82140
aVWhich in itself is triggered by a bug in the ControlCollection class
p82141
aVYour foreach loop is modifying the panel's Controls collection
p82142
aVThis normally produces an InvalidOperationException, "Collection was modified, enumeration operation may not execute", but the class forgets to do this
p82143
aVThe Dispose() call on the control removes it from the collection
p82144
aVIn effect, you'll only dispose every other control
p82145
aVThis should have a side-effect, they remain visible on the panel
p82146
aVYmmv
p82147
aVFix:
p82148
aVOr less efficient, although you'd never see the difference:
p82149
aVOtherwise the code is okay, CA2000 tends to produce false warnings
p82150
as(dp82151
g9
V17034
p82152
stp82153
a((dp82154
g2
(lp82155
VThe RCW for a COM component is just a managed class
p82156
aVAny half-decent
p82157
aVNET memory profiler will show you any that staying referenced unintentionally
p82158
aVIf the COM server itself is leaking then you'll need one that can track unmanaged memory
p82159
aVThat invariably requires having the source code for the server so you can figure out exactly what is leaked
p82160
aVAnd to actually do something about it
p82161
aVThere are already a gazillion questions about
p82162
aVNET memory profilers
p82163
aVType "
p82164
aVNET memory profiler" in the search box at the upper right
p82165
as(dp82166
g9
V17034
p82167
stp82168
a((dp82169
g2
(lp82170
VIt is not impossible, but you'll have to learn a lot more about how to exactly build a program from the command line to get the best debugging experience
p82171
aVThere are a bunch of options that are real time savers and greatly improve the odds that you'll discover bugs
p82172
aVWhich is a little beside the point right now, learn C instead of spending time learning a boring tool with way too many options
p82173
aVCreating a new project takes 5 seconds after a wee bit of practice
p82174
aVUse the Win32 Console Application project template
p82175
aVOne small setting you have to change if you want to compile as C instead of C++
p82176
aVRight-click the project, Properties, C/C++, Advanced, Compile As = Compile as C Code
p82177
as(dp82178
g9
V17034
p82179
stp82180
a((dp82181
g2
(lp82182
VThere's no such thing as a 'free thread'
p82183
aVThere's only an unused core
p82184
aVYou can simply count them with Environment
p82185
aVProcessorCount and base you threading strategy on that
p82186
aVNot leveraging the ThreadPool is usually a mistake, it does a good job distributing tp threads across cores
p82187
aVBut it doesn't easily give you what you ask for, ThreadPool
p82188
aVGetAvailableThreads is a constantly changing number
p82189
aVShould be anyway
p82190
as(dp82191
g9
V17034
p82192
stp82193
a((dp82194
g2
(lp82195
VYou are ignoring stride (Jerry's comment) and the pixel format of the bitmap
p82196
aVWhich is 24bpp judging by the file size increase, you are writing it as though it is 32bpp
p82197
aVYour grayscale conversion is wrong, the human eye isn't equally sensitive to red, green and blue
p82198
aVConsider using GDI+, you #include  in your code to use the Bitmap class
p82199
aVIts LockBits() method gives you access to the bitmap bits
p82200
aVThe ColorMatrixEffect class lets you apply a color transformation in a single operation
p82201
aVCheck this answer for the color matrix you need to get a grayscale image
p82202
aVThe MSDN docs start here
p82203
as(dp82204
g9
V17034
p82205
stp82206
a((dp82207
g2
(lp82208
VThis won't produce the same result if len - stopPos < 0
p82209
as(dp82210
g9
V17034
p82211
stp82212
a((dp82213
g2
(lp82214
VImplement the FLP's Scroll event
p82215
aVIterate its controls and find out which one is located at the top:
p82216
aVCast the ctl to your user control type and retrieve the property you want
p82217
aVThen iterate the other FLP to find the matching control, set the FLP's AutoScrollPosition to scroll it into view
p82218
as(dp82219
g9
V17034
p82220
stp82221
a((dp82222
g2
(lp82223
VWell, you'll want a control with these major features:
p82224
aVAutomatic layout of variable sized string snippets
p82225
aVAutomatic mouse hit testing
p82226
aVThose are a bit hard to come by in WF controls
p82227
aVA RichTextBox with ReadOnly = true gives you the automatic layout, but not the hit testing
p82228
aVA ListBox with DrawItem can give you variable sized strings and hit testing, but not a natural layout
p82229
aVI think I would use RTB and make hit testing work with the MouseDown event and GetCharIndexFromPosition(), reading back the tag at the clicked location
p82230
aVYou'll need a bit of logic to find the starting and ending white space around the word
p82231
as(dp82232
g9
V17034
p82233
stp82234
a((dp82235
g2
(lp82236
VIt is by design only limited to available memory or 2^32-1 items
p82237
aVHowever, there's a bug in the Vista implementation of ListBox
p82238
aVScrolling it gets screwy once you go past 65535 + one page worth of items
p82239
aV65565 items when I quickly checked it
p82240
aVThis bug bites also for ComboBox, the dropdown is a ListBox control
p82241
aVThis bug is rarely put to the test, one probable reason it didn't get fixed in Vista SP1
p82242
aVNobody designs a UI that expects the user to be able to pick an item from that many choices
p82243
as(dp82244
g9
V17034
p82245
stp82246
a((dp82247
g2
(lp82248
VThis question was viewed 194 times in the past 2 years, no lack of attention
p82249
aVTake the lack of answers as sufficient proof that this just is not possible
p82250
aVAn unmanaged struct has to be marshaled, the
p82251
aVNET layout rules for structs are fundamentally incompatible with those for a C or C++ compiler
p82252
aVThis answer provides some background info on why
p82253
aVNET works this way
p82254
as(dp82255
g9
V17034
p82256
stp82257
a((dp82258
g2
(lp82259
VThese are attributes that matter a great deal to COM
p82260
aVWhich was the predecessor of
p82261
aVNET and had its heyday in the nineties, before Java stole the show
p82262
aVNET needed to be compatible with COM to have a chance of succeeding
p82263
aVOr in other words, you needed to be able to write a COM server in a
p82264
aVNET language that a large legacy program could use
p82265
aVThe [ComVisible] attribute ensures that a COM client program can see and use the IEnumerable interface
p82266
aVEssential to allow the client program to enumerate
p82267
aVNET collections
p82268
aVThe [Guid] attribute is crucial in COM, it identifies an interface
p82269
aVWhich is done by a guid, not a name, to ensure that it is unique across multiple applications written by different programmers
p82270
aVNET has this too, but however uses a name to make it easier on humans
p82271
aV"System
p82272
aVCollections
p82273
aVIEnumerable, mscorlib, Version=2
p82274
ag2512
ag2512
aV0, Culture=neutral, PublicKeyToken=b77a5c561934e089"
p82275
aVIEnumerable<>, the generic version, doesn't have a [Guid]
p82276
aVGenerics are not compatible with COM
p82277
aVIt doesn't much matter these days, not much visible COM around anymore, most of it has been wrapped by friendly
p82278
aVNET classes
p82279
aVBut still very core in Windows, notably in the brand-new WinRT (aka Metro)
p82280
aVYou don't use that directly either, making COM somewhat like the assembly language of Windows programming
p82281
as(dp82282
g9
V17034
p82283
stp82284
a((dp82285
g2
(lp82286
VIt is important to understand the vulnerability of the System
p82287
aVString type
p82288
aVIt is impossible to make it completely secure, SecureString exists to minimize the risk of exposure
p82289
aVSystem
p82290
aVString is risky because:
p82291
aVTheir content is visible elsewhere, without having to use a debugger
p82292
aVAn attacker can look in the paging file (c:\u005cpagefile
p82293
aVsys), it preserves the content of RAM pages that were swapped out to disk to make room for other programs that need RAM
p82294
aVSystem
p82295
aVString is immutable, you cannot scrub the content of a string after you used it
p82296
aVThe garbage collected heap compacts the heap but does not reset the content of the memory that was freed-up
p82297
aVWhich can leave a copy of the string data in memory, entirely out of reach from your program
p82298
aVThe clear risk here is that the string content can be visible long after the string was used, thus greatly increasing the odds that an attacker can see it
p82299
aVSecureString provides a workaround by storing the string in unmanaged memory, where it is not subject to the garbage collector leaving stray copies of the string content
p82300
aVIt should be clear now how you can create your own version of secure array with the same kind of guarantees that SecureString provides
p82301
aVYou do not have the immutability problem, scrubbing the array after you use it is not a problem
p82302
aVWhich in itself is almost always good enough, implicit in reducing the likelihood of exposure is that you don't keep a reference to the array for very long either
p82303
aVSo the odds of the non-scrubbed copy of the array data surviving after a garbage collection should already be low
p82304
aVYou can reduce that risk as well, present only for arrays less than 85,000 bytes
p82305
aVEither by doing it the way SecureString does it and using Marshal
p82306
aVAllocHGlobal()
p82307
aVOr much easier by pinning the array, GCHandle
p82308
aVAlloc()
p82309
as(dp82310
g9
V17034
p82311
stp82312
a((dp82313
g2
(lp82314
VStrange question
p82315
aVIt was posted a dog-life ago but the concepts of unit testing and test-driven development were already well established back in 2009
p82316
aVWith excellent tooling available, like nunit and testdriven
p82317
aVnet
p82318
aVA debugger is not the right tool to use, that just produces gray hair
p82319
as(dp82320
g9
V17034
p82321
stp82322
a((dp82323
g2
(lp82324
VThere are no snaplines that help you set the spacing between controls
p82325
aVInstead, the designer pays attention to the Margin property of the control
p82326
aVThe default for a Button is (3, 3, 3, 3), it will snap in place creating a 3 pixel gap from the adjacent control
p82327
aVBest to try it yourself
p82328
aVDrop a label and a button, change the button's Margin to (3, 10, 3, 3) and move the Button below label up and down
p82329
aVYou'll see it now snaps in place creating a 10 pixel gap
p82330
as(dp82331
g9
V17034
p82332
stp82333
a((dp82334
g2
(lp82335
VThe mystifying message is caused by a bug in pinvoke code inside the
p82336
aVNET Framework
p82337
aVThe underlying winapi call that fails is the  function
p82338
aVThe pinvoke declaration for it looks like this:
p82339
aVThe  property is wrong
p82340
aVAs you can tell from the MSDN link, the function indicates failure by returning a negative value
p82341
aVAnd is not documented to set the error code that's returned by
p82342
aVThe consequence of this bug is that the framework will call  to obtain the error code and will get a random value since  didn't set it
p82343
aVA value of  is not unlikely,  which produces the "The operation completed successfully" exception message
p82344
aVSo you need to ignore the exception message; it is very unhelpful of course
p82345
aVUnfortunately, this winapi function falls into a category of functions, like most GDI functions do, that only produce an "it didn't work" return code
p82346
aVIt gives no hint where to look for the problem
p82347
aVThere is a half-decent reason for this quirk: Windows itself does very little when you call ; most of the work is done by the printer driver
p82348
aVThere is no set of error codes set-aside for printing in the winapi
p82349
aVAnything is possible: printer drivers are not subtle chunks of code
p82350
aVIt is the job of the printer driver to tell you about problems
p82351
aVThey are supposed to do so by popping up their own window
p82352
aVTheoretically they are anyway; the cut-throat competition in that market segment does not leave a lot of money to pay a good programmer's salary these days
p82353
aVThis of course cannot work when you print from a service
p82354
aVThere isn't any way to see such a popup window, which is the core reason that Microsoft strongly discourages printing from a service
p82355
aVNeither you nor your customer's IT staff stands a chance to diagnose problems
p82356
aVRead this blog post for additional notes about using  from a service
p82357
aVNobody likes to get advice like this, but the writing is on the wall
p82358
aVDon't do it
p82359
as(dp82360
g9
V17034
p82361
stp82362
a((dp82363
g2
(lp82364
VIs it harmful
p82365
aVYes, very much so
p82366
aVA language parser has two important duties
p82367
aVOne is the job that everybody is familiar with, convert text into an executable program
p82368
aVBut very important as well is that it can detect an invalid program and generate a meaningful diagnostic to the programmer so he can fix his code
p82369
aVAt a very fundamental level, a language parser distinguishes between declarations, statements and expressions
p82370
aVThe curly-brace languages do obfuscate that distinction, you can turn any expression into a statement, simply by putting a semi-colon after it
p82371
aVAnd in some cases accept a declaration inside a statement, the for(;;) statement is a good example
p82372
aVMost plainly, this syntax is perfectly acceptable in the C or C++ languages:
p82373
aVThat's not exactly a good thing, it is nonsense code
p82374
aVThe C# language upped the bar on that, it will reject that
p82375
aVBut not:
p82376
aVA special rule added to the language parser to accept this
p82377
aVWhat none of the curly-brace languages will accept is turning a declaration into an expression
p82378
aVThat way lies madness, dragons on the end of the map, ship falls off the edge with no good message left to report
p82379
aVThe comma operator requires the lefthand and righthand operands to be expressions
p82380
aVA declaration is not an expression, end of story
p82381
as(dp82382
g9
V17034
p82383
stp82384
a((dp82385
g2
(lp82386
VJust to confirm that the marked answer is the correct one
p82387
aVRAII wrappers cannot work across COM boundaries
p82388
aVThe posted method implementation is not correct, you cannot assume that the caller is going to supply a valid SAFEARRAY
p82389
aVJust [out] is not a valid attribute in Automation, it must be either [out,retval] or [in,out]
p82390
aVIf it is [out,retval], which is what it looks like, then the method must create a new array from scratch
p82391
aVIf it is [in,out] then the method must destroy the passed-in array if it doesn't match the expected array type and create a new one
p82392
as(dp82393
g9
V17034
p82394
stp82395
a((dp82396
g2
(lp82397
VThe Assembly
p82398
aVLoadFile() method is your problem, it loads the assembly in the wrong context
p82399
aVLoading contexts are a bit hard to grok, Suzanne Cook talks about it in her blog
p82400
aVWhen the serializer needs the type, it will use Assembly
p82401
aVLoadFrom() and load the assembly again
p82402
aVNow it finds a mismatch, types from different assemblies are never the same
p82403
aVLoadFile() is only useful in very limited scenarios, as documented in the Remarks section of the MSDN library article
p82404
aVYou should use Assembly
p82405
aVLoadFrom() or Load() instead
p82406
aVPrefer the latter as it eliminates the possibility that an assembly with the same display name will be loaded from different files
p82407
aVIf that causes trouble because the assembly is not in the program's probing path (it won't be if it is stored in ) then implement the AppDomain
p82408
aVAssemblyResolve event handler to ensure the correct file is found
p82409
as(dp82410
g9
V17034
p82411
stp82412
a((dp82413
g2
(lp82414
VCS0002:
p82415
aVUnable to load message string from resources
p82416
aVProduced by:
p82417
aVMost likely due to damage to the string table resource or a completely missing cscui
p82418
aVdll so it can't display any error messages
p82419
aVReference question is here
p82420
as(dp82421
g9
V17034
p82422
stp82423
a((dp82424
g2
(lp82425
VThe Width property always tracks the current width of a control, whether it is anchored or not
p82426
aVHowever, the TextBox is going to grow when you make the container larger and that will make it overlap the PictureBox
p82427
aVYou have to anchor the PB to the right as well
p82428
as(dp82429
g9
V17034
p82430
stp82431
a((dp82432
g2
(lp82433
VStart debugging, as soon as you've arrived at a breakpoint or used , use
p82434
aVYou'll see a list of all the assemblies that are loaded into the process
p82435
aVLocate the one you want to get debug info for
p82436
aVRight-click it and select Symbol Load Information
p82437
aVYou'll get a dialog that lists all the directories where it looked for the
p82438
aVpdb file for the assembly
p82439
aVVerify that list against the actual
p82440
aVpdb location
p82441
aVMake sure it doesn't find an old one
p82442
aVIn normal projects, the assembly and its
p82443
aVpdb file should always have been copied by the IDE into the same folder as your
p82444
aVexe
p82445
aVThe bin\u005cDebug folder of your project
p82446
aVMake sure you remove one from the GAC if you've been playing with it
p82447
as(dp82448
g9
V17034
p82449
stp82450
a((dp82451
g2
(lp82452
VThis is one of the burden's you'll have to take on when you use UDP
p82453
aVYou'll have to consider Path MTU discovery
p82454
aVThen again, since you are making reliable UDP, you should be able to auto-detect this and dynamically switch to a smaller packet size
p82455
aVThat will solve PMTUD problems as well
p82456
aVHopefully, this doesn't sound too much like: "those whose don't use TCP are doomed to reinvent it
p82457
aVCheck out the RFCs that are linked in that article for ideas
p82458
as(dp82459
g9
V17034
p82460
stp82461
a((dp82462
g2
(lp82463
VNo, there is no sweet spot
p82464
aVMore code takes more time to load and JIT compile
p82465
aVBut it isn't necessarily predictable when that occurs, it happens on demand
p82466
aVThe max is only restricted by available virtual memory space on 32-bit machines, paging file size on x64 machines
p82467
as(dp82468
g9
V17034
p82469
stp82470
a((dp82471
g2
(lp82472
VThere's really only one that I know and follow regularly
p82473
aVRaymond Chen's The Old New Thing
p82474
aVCranky SOB, has been around at MSFT for a long time, before Windows 95
p82475
aVWell past the typical survival years for a Microsoft engineer
p82476
aVDeeply C at heart, with a wink at C++ when necessary
p82477
aVFirmly un-dot-netty, the sub-title of his blog
p82478
aVHe keeps his blog very fresh by drawing in war stories from his experience that are relevant to any programmer, no matter the language
p82479
aVOften Windows related, but that's just a vehicle to tell his stories
p82480
aVVery low threshold for the crap and not shy to expose it
p82481
aVRecommended
p82482
as(dp82483
g9
V17034
p82484
stp82485
a((dp82486
g2
(lp82487
VExplain why you chose "ALIGNMENT" as an identifier
p82488
aVExplain why you picked 16
p82489
aVArgue how your algorithm catches the most common mistakes, like overflowing the end of a heap-allocated block or forgetting to release memory
p82490
as(dp82491
g9
V17034
p82492
stp82493
a((dp82494
g2
(lp82495
VIt is called Compound Files, part of the Structured Storage API
p82496
aVYou start with StgOpenStorageEx()
p82497
aVIt buys you little for a Word
p82498
aVdoc file, the streams themselves have a sophisticated binary format
p82499
aVTo really read the document content you want to use automation, letting Word read the file
p82500
aVThat's rarely done in C++ but that project shows you how
p82501
as(dp82502
g9
V17034
p82503
stp82504
a((dp82505
g2
(lp82506
VComments on a similar question that was closed as subjective & argumentative and subsequently deleted:
p82507
aVDebunk
p82508
aVWhy bother
p82509
aVClueless nonsense written by clueless nitwit
p82510
aV\u2013 Neil Butterworth Jun 10 at 16:17
p82511
ag2582
aVWell, that "nitwit" justifies hit points rather convincingly
p82512
aVCan you justify yours
p82513
aVThis was exactly the point of this question: why do you think it's nonsense
p82514
aVWhat exactly does not make sense about it
p82515
aVI don't see it for myself, therefore, I ask the community to tell me
p82516
aV\u2013 Fyodor Soikin Jun 10 at 16:19
p82517
aV@Fydor Quite simply, I cite the popularity and success of the C++ language
p82518
aVNuff said
p82519
aV\u2013 Neil Butterworth Jun 10 at 16:22
p82520
ag60489
aVThere are serious, real problems with C++, And yes, the FQA touches on many of them
p82521
aVThe problem is that it also exaggerates many issues, makes completely subjective calls flaming features that many consider good and useful, and often uses meaningless argumentations to justify its criticism
p82522
aVThe problem is that if you write a document which attacks everything about the language, then yes, you will end up with some valid criticisms but the document in itself just isn't very useful or reliable because it tries to attack everything, not just the aspects that deserve it
p82523
aV\u2013 jalf Jun 10 at 16:25
p82524
aV@jalf Is "argumentation" really a word
p82525
aVIt keeps on cropping up here, but what is wrong with "argument"
p82526
aV\u2013 Neil Butterworth Jun 10 at 16:30
p82527
aVhehehe, it is
p82528
aVmw4
p82529
aVm-w
p82530
aVcom/dictionary/argumentation \u2013 Noah Roberts Jun 10 at 16:32
p82531
ag2584
aV@Neil, that is hardly a constructive answer
p82532
aVThis way of thinking, I may argue that high-fat fried food is good, because the vast majority of americans like it a lot
p82533
aVSuppose for a minute that I'm a novice considering different tools, and I come to you and say: "here, I heard the argument against C++, can you give me an opinion from the other side
p82534
aV, and your answer would be "You should use C++, because everybody else does it"
p82535
aVDoesn't it look a bit strange to you
p82536
aV\u2013 Fyodor Soikin Jun 10 at 16:35
p82537
aV@jalf: But that was exactly the point of my question
p82538
aVCan you just pick a few points from those you consider "exaggeration" or "subjective claims" and explain to me why you consider them that
p82539
aV\u2013 Fyodor Soikin Jun 10 at 16:37
p82540
ag2584
aV@Fyodor If I had said "You should use C++, because everybody else does it" then you would have a beef
p82541
aVOf course, I said no such thing
p82542
aVComments like this just confirm that your original question is a troll
p82543
aV\u2013 Neil Butterworth Jun 10 at 16:42
p82544
aV@Neil, please do not dismiss my question, it is legitimate even if you prefer not to think that
p82545
aVWhen I asked "what does not make sense about FQA", you answered "I cite the popularity and success of C++"
p82546
aVSince "success" is a subjective term, I only can rely on "popularity" in your answer
p82547
aVTherefore, your answer reads like "The arguments against C++ are nonsense, because C++ is popular" (which is the same as "everybody uses it")
p82548
aVIs that correct, or do I misunderstand you again
p82549
aV\u2013 Fyodor Soikin Jun 10 at 16:49
p82550
aV@Neil: How does the popularity of the language mean that the issues brought up by the FQA are not justified
p82551
aV\u2013 jalf Jun 10 at 16:51
p82552
aV@Neil, page 2: I continue to persist with my questions, because you continue to avoid justifying your point
p82553
aVIf you're absolutely sure that FQA is nonsense, it surely shouldn't be too hard to take just one or two points from it and explain why they are nonsense, shouldn't it
p82554
aVI do understand that you do not want to "bother" debunking some nonsense
p82555
aVBut it is not nonsense that asks you to debunk itself
p82556
aVIt's me
p82557
aVCan't you help your fellow community member to get out of his confusion
p82558
aV\u2013 Fyodor Soikin Jun 10 at 16:51
p82559
ag2582
aV@Fyodor And how do you deduce from my comments "You should use C++"
p82560
aV\u2013 Neil Butterworth Jun 10 at 16:52
p82561
aV@Neil, I did not deduce that from your comment
p82562
aVI did not mean to imply that your comment can be read this way
p82563
aVInstead, I gave you a hypothetical situation of a newbie coming to you and asking
p82564
aV(see my comment)
p82565
aVAnd from what you've said so far, I tried to deduce what your answer to that newbie would be
p82566
aVSince we both agree that your answer surely wouldn't be that, I conclude that you should have some rational reasoning for such a newbie
p82567
aVAnd that reasoning is what I'm begging you to share
p82568
aV\u2013 Fyodor Soikin Jun 10 at 16:55
p82569
ag2584
aV@jalf I have issues with BASIC, Smalltalk, FORTRAN, C++ C, etc
p82570
aVetc
p82571
aVHowever, I don't feel the need to write a gigantic and often mendacious document slagging off these very successful, popular and productive languages, and I think that anyone that does so obviously has issues apart from the language they are slagging
p82572
aVOr they are simply trolling, which Occam's Razor might suggest as the simplest explanation
p82573
aV\u2013 Neil Butterworth Jun 10 at 16:58
p82574
ag2447
aVSection 9
p82575
aV3: it conflates two concepts
p82576
aVFunctions can be inlined by the compiler as an optimization, independently of the inline keyword
p82577
aVToday, the chief purpose of the inline keyword is to disable the one definition rule, which allows multiple translation units to see the same definitions
p82578
aVThe stuff about debugging is just plain wrong
p82579
aVA decent debugger can easily step inside inlined functions and view all local variables
p82580
ag28089
aV5 points out some valid shortcomings of inline functions that are sometimes (rarely) problematic -- and uses this to argue that they are never better than macros \u2013 jalf Jun 10 at 16:59
p82581
ag2584
aVI just clicked into a random page of the FQA, picked two random paragraphs, and commented on those
p82582
aVNot much room in comments for a more detailed analysis of the full FQA :) but it shows that the FQA contains garbage arguments, even if it also happens to be right on some issues
p82583
aV\u2013 jalf Jun 10 at 16:59
p82584
aVThis could have been a very interesting question
p82585
aVI like the FQA but would have loved to see what people disagreed with and their reasoning
p82586
aV\u2013 David Relihan Jun 10 at 17:02
p82587
aV@jalf: Thank you very much, this is what I was hoping for
p82588
aVI agree about the debugger part, but the rest is still confusing
p82589
aVWith inline functions, your reasoning is basically "the inline keyword is actually used for something other than inlining and is not related to the inlining itself at all, and the FQA author doesn't know it", right
p82590
aVBut that's the whole point of the author: why is the keyword named "inline" then, and why does the FAQ say it's used for inlining if it really isn't
p82591
aV\u2013 Fyodor Soikin Jun 10 at 17:14
p82592
aV@jalf: And as for the last part of 9
p82593
aV5, you're just plain wrong
p82594
aVThe last paragraph of that answer specifically says: "Frequently inline functions are better than macros, though, because the problems with macros turn out to be more severe in many cases"
p82595
aVBut thank you for your perspective, although I sense you're not exactly my target audience (so to say) here :-) \u2013 Fyodor Soikin Jun 10 at 17:15
p82596
aV@Fyodor: touch about 9
p82597
ag2447
aV:) I agree that the name "inline" is a bit awkward today, though there are historical reasons for it (it was used for inlining, and the compiler may still treat it as a hint
p82598
aVIt's just not the primary purpose any more because the compiler has gotten cleverer)
p82599
aV\u2013 jalf Jun 10 at 17:22
p82600
aV@jalf: Yes, I understand the "historical reasons" argument, but that doesn't work if I'm trying to decide which tools to use for my project: I don't care what the reasons are, only what the implications for my job would be
p82601
aVFor that reason, I even anticipated this type of argument in the question
p82602
aVThank you again
p82603
aV:-) \u2013 Fyodor Soikin Jun 10 at 17:24
p82604
ag2586
aVIf you're really interested in this topic (rebuttals to common criticisms of C++) and absolutely must have answers from the C++ experts on SO (vs
p82605
aVthe many other sites that address it), then check out the answers and comments on this question: stackoverflow
p82606
aVcom/questions/385297/\u2026
p82607
aVBut keep in mind, SO is not a discussion site - language flame-wars do not belong here
p82608
aVYou're much better off picking a specific issue and asking a specific question (or reading the answers that have already been posted to existing questions on the topic)
p82609
aV\u2013 Shog9 Jun 10 at 17:34
p82610
aV@Shog9:Yes, I have read that question, as well as several others on C++, and I did get some criticism and rebuttals
p82611
aVBut not all FQA's points were addressed, and I couldn't find anything relevant to FQA on SO, and I didn't know where else to find rebuttals to it, so I asked this question
p82612
aVLet me explain myself: I did not intend this to be a flame war, and I tried to phrase my question in a way that would prevent it
p82613
aVI really need someone who is an active proponent of C++ answer constructively, because my own intellect seems to have its limits :-) (or it may be related to lack of experience
p82614
aV\u2013 Fyodor Soikin Jun 10 at 17:56
p82615
aV@Shog9: The part about "other sites" is interesting, though
p82616
aVCould you share some links to those sites
p82617
aVAnd thank you for the general advice
p82618
aVI guess the next step would be to find points of FQA not addressed by other sources (if any) and ask specific questions about them
p82619
aVThank you
p82620
aV\u2013 Fyodor Soikin Jun 10 at 17:58
p82621
ag2584
aV@Fyodor: I'm not saying you're necessarily trying to troll or even spark an argument, but think about what you're asking for: the ideal answer for this question would be a line-by-line rebuttal of the FQA - that's a massive undertaking, and one effectively guaranteed to result in extensive discussion, which - even if civil - would be more than the SO system is designed to handle
p82622
aVWorse, it would be so long and dense as to be worthless for anyone looking for clarification on a single criticism
p82623
aV\u2013 Shog9 Jun 10 at 18:17
p82624
ag2586
aVTo use the inline point as an example, if you're actually interested then asking a question like this or this one would stand a much better chance of netting good, detailed answers from real C++ users rather than bored folk looking for an argument
p82625
aV\u2013 Shog9 Jun 10 at 18:20
p82626
aVOk, that's a very fair point
p82627
aVI see now how my question can be misinterpreted
p82628
aVI guess it was meant to be something like "What are situations/projects that C++ is good for
p82629
aV- something like that
p82630
aVWhat I was trying to get is something that would debunk the FQA's conclusion that C++ shouldn't be used in new projects at all
p82631
aVI will try to work on a clearer phrasing
p82632
aVCan I still have links to those other sites you mentioned
p82633
aV\u2013 Fyodor Soikin Jun 10 at 18:40
p82634
aVSpeaking about the inline example, those two questions do not relate to mine: I do know how the inline word is used and works, and advantages and drawbacks of inline code, and all that stuff
p82635
aVWhat I was looking for, vaguely phrased, would be either a statement like "yes, this is stupid and useless" or "no, the FAQ is wrong here, because
p82636
aV\u2013 Fyodor Soikin Jun 10 at 18:41
p82637
ag2582
aV@Fyodor: google it - the article has sparked numerous discussions, some better than others, but all illustrating my original point: you just can't talk about something like this without it degenerating into a flame-war
p82638
aVHere are a couple of the better discussions: Reddit, Joel Forums
p82639
aVAs for getting an answer to "is inline stupid and useless
p82640
aV- that's fairly subjective
p82641
aVIf you know what it does and how it works, then decide for yourself
p82642
aV\u2013 Shog9 Jun 10 at 18:53
p82643
as(dp82644
g9
V17034
p82645
stp82646
a((dp82647
g2
(lp82648
VAll hotfixes are published through the code
p82649
aVmsdn
p82650
aVmicrosoft
p82651
aVcom site tagged with Visual Studio 2010
p82652
aVClick "Sort by" and select "Resource Page Start Date" to get the latest VS2010 hotfixes pushed towards the top
p82653
aVIf somebody wants to compile an annotated list from this, have at it
p82654
as(dp82655
g9
V17034
p82656
stp82657
a((dp82658
g2
(lp82659
VThis is simply a matter of using the right linker option so it flips a bit in the executable header
p82660
aVThe Microsoft linker options are /NXCOMPAT (DEP) and /DYNAMICBASE (ASLR)
p82661
aVI don't know your tools well enough to know if they have similar options
p82662
aVEditbin
p82663
aVexe supports these options too, you can always run it in a post-build event
p82664
as(dp82665
g9
V17034
p82666
stp82667
a((dp82668
g2
(lp82669
VThis is just a bit of interop nastiness
p82670
aVThe WPF code tries to set the focus back to the main window when the dialog is closing
p82671
aVProblem is, the dialog has disabled the window so it can't receive the focus yet
p82672
aVWPF is too eager to change the focus and doesn't otherwise know anything about the dialog behavior
p82673
aVNothing actually goes wrong
p82674
as(dp82675
g9
V17034
p82676
stp82677
a((dp82678
g2
(lp82679
VWell, I certainly agree, it is pretty horrible that such an implementation detail is exposed
p82680
aVIt is however the exact same kind of detail that's exposed by the lock keyword
p82681
aVWe are still very far removed from that bug generator to be completely removed from our code
p82682
aVThe hardware guys have a lot of work to do
p82683
aVThe volatile keyword matters a lot of CPU cores with a weak memory model
p82684
aVThe marketplace isn't been kind to them, the Alpha and the Itanium haven't done well
p82685
aVNot exactly sure why, but I suspect that the difficulty of writing solid threaded code for these cores has a lot to do with it
p82686
aVGetting it wrong is quite a nightmare to debug
p82687
aVThe verbiage in the MSDN Library documentation for volatile applies to these kind of processors, it otherwise is quite inappropriate for x86/x64 cores and makes it sound that the keyword is doing far more than it really does
p82688
aVVolatile merely prevents variable values from being stored in CPU registers on those cores
p82689
aVUnfortunately, volatile still matters on x86 cores in very select circumstances
p82690
aVI haven't yet found any evidence that it matters on x64 cores
p82691
aVAs far as I can tell, and backed up by the source code in SSCLI20, the Opcodes
p82692
aVVolatile instruction is a no-op for the x64 jitter, changing neither the compiler state nor emitting any machine code
p82693
aVThat's heading the right way
p82694
aVGeneric advice is that wherever you're contemplating volatile, using lock or one of the synchronization classes should be your first consideration
p82695
aVAvoiding them to try to optimize your code is a micro-optimization, defeated by the amount of sleep you'll lose when your program is exhibiting thread race problems
p82696
as(dp82697
g9
V17034
p82698
stp82699
a((dp82700
g2
(lp82701
VDo not edit that code
p82702
aVIt is auto-generated and the designer actually reads the code back to recreate the form in the designer
p82703
aVWhen you make changes like this, it is very likely you'll bomb the designer and your form becomes un-designable
p82704
aVEven if you do manage to avoid crashing it, your changes will simply disappear when you alter the form in the designer
p82705
aVAnything in the region that's marked "Windows Forms Designer generated code" is hands-off
p82706
aVThere is no benefit whatsoever to changes like these
p82707
aVIt generates the exact same code
p82708
as(dp82709
g9
V17034
p82710
stp82711
a((dp82712
g2
(lp82713
VI can repro this crash with a little test form:
p82714
aVClick the window and kaboom:
p82715
aVSo you are trying to update your Toolstrip item after it was disposed
p82716
aVIt isn't otherwise clear how your program got in a state like this
p82717
aVVery high odds for a threading problem, a thread that keeps invoking even after the user closed the window
p82718
aVThe subject of this answer
p82719
aVYou really ought to tackle the core problem but a Q&D; fix that will probably solve your crash is:
p82720
aVAlbeit that it may now well crash elsewhere
p82721
as(dp82722
g9
V17034
p82723
stp82724
a((dp82725
g2
(lp82726
VYes
p82727
aVUse View + Other Windows + Document Outline
p82728
as(dp82729
g9
V17034
p82730
stp82731
a((dp82732
g2
(lp82733
VThis exception occurs when a thread's ExecutionContext property changes
p82734
aVSpecifically when that thread is a threadpool or I/O completion thread that executes a callback and it acquired its ExecutionContext from another thread that made a BeginXxx call to start an asynchronous operation
p82735
aVLike Socket
p82736
aVBeginReceive()
p82737
aVThere's ample of opportunity for this to happen in the posted code since it tinkers with forms in the callback
p82738
aVExecutionContext has a hidden property named SynchronizationContext which keeps track of SynchronizationContext
p82739
aVCurrent
p82740
aVWinforms installs a custom synchronization provider the first time any form is created
p82741
aVRequired to properly marshal calls from a worker thread to the UI thread
p82742
aVIt is a class derived from SynchronizationContext named WindowsFormsSynchronizationContext
p82743
aVThe likely failure mode therefore is that the sock_Receive() method is called before any Winforms forms are created
p82744
aVWith the form creation code installing the synchronization provider and altering the ExecutionContext and thus crashing the code with the exception
p82745
aVSuch a problem needs to be fixed by altering the initialization of the app, ensuring that a main form exists before you allow any asynchronous code to use BeginInvoke()
p82746
as(dp82747
g9
V17034
p82748
stp82749
a((dp82750
g2
(lp82751
VThe reported missing names are correct, this not a compile problem
p82752
aVYou must be linking the wrong
p82753
aVlib
p82754
aVThe name you use sounds wrong, it isn't "lualib", the current version of the import library is named lua5
p82755
ag2582
aVlib (or lua51
p82756
aVlib, not sure what the difference is)
p82757
aVDownload it from here
p82758
as(dp82759
g9
V17034
p82760
stp82761
a((dp82762
g2
(lp82763
VThis is not possible, a hard requirement for Windows is that an EXE is started and loaded from a file on disk
p82764
aVThis is core to the way Windows is designed, associated with memory mapped files
p82765
aVYou will have to ship the unmanaged EXE along with your C# program
p82766
aVDoing something nasty like extracting the EXE from your resources at runtime is not going to be appreciated by either your customer, the virus scanner she uses nor UAC
p82767
aVYou can run it silently by using the ProcessStartInfo
p82768
aVCreateNoWindow property
p82769
as(dp82770
g9
V17034
p82771
stp82772
a.